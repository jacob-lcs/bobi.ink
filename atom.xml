<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Bobi.ink</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://bobi.ink/"/>
  <updated>2019-11-03T02:00:53.043Z</updated>
  <id>https://bobi.ink/</id>
  
  <author>
    <name>Ivan</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>React Concurrent æ¨¡å¼æŠ¢å…ˆé¢„è§ˆä¸‹ç¯‡: useTransition çš„å¹³è¡Œä¸–ç•Œ</title>
    <link href="https://bobi.ink/2019/10/28/concurrent-mode-transition/"/>
    <id>https://bobi.ink/2019/10/28/concurrent-mode-transition/</id>
    <published>2019-10-27T16:00:00.000Z</published>
    <updated>2019-11-03T02:00:53.043Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸Šç¯‡æ–‡ç« ä»‹ç»äº† <a href="https://juejin.im/post/5db65d87518825648f2ef899" target="_blank" rel="noopener"><code>Suspense</code></a>, é‚£ä¹ˆè¿™ç¯‡æ–‡ç« å°±è®²è®²å®ƒçš„å¥½æ­æ¡£ <a href="https://reactjs.org/docs/concurrent-mode-reference.html#usetransition" target="_blank" rel="noopener"><code>useTransition</code></a>ã€‚å¦‚æœä½ æ˜¯ React çš„ç²‰ä¸ï¼Œè¿™ä¸¤ç¯‡æ–‡ç« ä¸€å®šä¸èƒ½é”™è¿‡ã€‚</p><p>æˆ‘ä»¬çŸ¥é“ React å†…éƒ¨åšäº†ç¿»å¤©è¦†åœ°çš„ä¼˜åŒ–ï¼Œå¤–éƒ¨ä¹Ÿæä¾›äº†ä¸€äº›ç´§å‡‘çš„æ–° APIï¼Œ<strong>è¿™äº› API ä¸»è¦ç”¨æ¥ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ</strong>ã€‚React å®˜æ–¹ç”¨ä¸€ç¯‡å¾ˆé•¿çš„æ–‡æ¡£<a href="https://reactjs.org/docs/concurrent-mode-patterns.html" target="_blank" rel="noopener">ã€ŠConcurrent UI Patterns ã€‹</a> ä¸“é—¨æ¥ä»‹ç»è¿™ä¸€æ–¹é¢çš„åŠ¨æœºå’Œåˆ›é€ ï¼Œå…¶ä¸­çš„ä¸»è§’å°±æ˜¯ <code>useTransition</code>ã€‚</p><p><br></p><p><strong>ç›¸å…³æ–‡ç« </strong></p><ul><li><a href="https://juejin.im/post/5dadc6045188255a270a0f85" target="_blank" rel="noopener">è¿™å¯èƒ½æ˜¯æœ€é€šä¿—çš„ React Fiber(æ—¶é—´åˆ†ç‰‡) æ‰“å¼€æ–¹å¼</a> ğŸ”¥å…ˆå…¥ä¸ªé—¨</li><li><a href="https://juejin.im/post/5db65d87518825648f2ef899" target="_blank" rel="noopener">React Concurrent æ¨¡å¼æŠ¢å…ˆé¢„è§ˆä¸Šç¯‡: Suspense the world</a> ä¸Šç¯‡</li></ul><p><br><br><br></p><p><strong>æœ¬æ–‡å¤§çº²</strong></p><!-- TOC --><ul><li><a href="#åº”ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆ">åº”ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿ</a></li><li><a href="#usetransition-ç™»åœº">useTransition ç™»åœº</a></li><li><a href="#usetransition-åŸç†åˆæ¢">useTransition åŸç†åˆæ¢</a><ul><li><a href="#1ï¸âƒ£-åˆ©ç”¨-starttransition-æ¥è¿è¡Œä½ä¼˜å…ˆçº§ä»»åŠ¡"><strong>1ï¸âƒ£ åˆ©ç”¨ startTransition æ¥è¿è¡Œä½ä¼˜å…ˆçº§ä»»åŠ¡</strong></a></li><li><a href="#2ï¸âƒ£-starttransition-æ›´æ–°è§¦å‘-suspense"><strong>2ï¸âƒ£ startTransition æ›´æ–°è§¦å‘ Suspense</strong></a></li><li><a href="#3ï¸âƒ£-å°†-tick-æ›´æ–°æåˆ°-starttransition-ä½œç”¨åŸŸå¤–"><strong>3ï¸âƒ£ å°† tick æ›´æ–°æåˆ° startTransition ä½œç”¨åŸŸå¤–</strong></a></li><li><a href="#4ï¸âƒ£-åµŒå¥—suspense"><strong>4ï¸âƒ£ åµŒå¥—Suspense</strong></a></li><li><a href="#5ï¸âƒ£-å¯ä»¥å’Œ-mobx-å’Œ-redux-é…åˆä½¿ç”¨å—"><strong>5ï¸âƒ£ å¯ä»¥å’Œ Mobx å’Œ Redux é…åˆä½¿ç”¨å—?</strong></a></li></ul></li><li><a href="#é‚£-usedeferedvalue-å‘¢">é‚£ useDeferedValue å‘¢ï¼Ÿ</a></li><li><a href="#æ€»ç»“">æ€»ç»“</a></li><li><a href="#å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</a></li></ul><!-- /TOC --><p><br></p><p>React ç”¨â€™<strong>å¹³è¡Œå®‡å®™</strong>â€˜æ¥æ¯”å–»è¿™ä¸ª useTransition è¿™ä¸ª APIã€‚Whatï¼Ÿ</p><p>ç”¨ Git åˆ†æ”¯æ¥æ¯”å–»ä¼šæ›´å¥½ç†è§£ä¸€ç‚¹, å¦‚ä¸‹å›¾ï¼ŒReact å¯ä»¥ä»å½“å‰è§†å›¾(å¯ä»¥è§†ä½œ <code>Master</code>) åˆ†æ”¯ä¸­ <code>Fork</code> å‡ºæ¥ä¸€ä¸ªæ–°çš„åˆ†æ”¯(å°šä¸”ç§°ä¸º <code>Pending</code>)ï¼Œåœ¨è¿™ä¸ªæ–°åˆ†æ”¯ä¸Šè¿›è¡Œæ›´æ–°ï¼ŒåŒæ—¶ <code>Master</code> ä¿æŒå“åº”å’Œæ›´æ–°ï¼Œè¿™ä¸¤ä¸ªåˆ†æ”¯å°±åƒâ€™å¹³è¡Œå®‡å®™â€™ï¼Œä¸¤è€…äº’ä¸å¹²æ‰°ã€‚å½“ <code>Pending</code> åˆ†æ”¯å‡†å¤‡â€™å¦¥å½“â€™ï¼Œå†åˆå¹¶(æäº¤)åˆ° <code>Master</code>åˆ†æ”¯ã€‚</p><p><img src="/images/concurrent-mode/suspense-branch.png" alt></p><p><br></p><p><code>useTransition</code> å°±åƒä¸€ä¸ªæ—¶å…‰éš§é“, è®©ç»„ä»¶è¿›å…¥ä¸€ä¸ªå¹³è¡Œå®‡å®™ï¼Œåœ¨è¿™ä¸ªå¹³è¡Œå®‡å®™ä¸­ç­‰å¾…<code>å¼‚æ­¥çŠ¶æ€</code>(å¼‚æ­¥è¯·æ±‚ã€å»¶æ—¶ã€whatever)å°±ç»ªã€‚å½“ç„¶ç»„ä»¶ä¹Ÿä¸èƒ½æ— é™æœŸå¾…åœ¨å¹³è¡Œå®‡å®™ï¼Œ<code>useTranstion</code> å¯ä»¥é…ç½®è¶…æ—¶æ—¶é—´ï¼Œå¦‚æœè¶…æ—¶äº†ï¼Œå°±ç®—<code>å¼‚æ­¥çŠ¶æ€</code>æœªå°±ç»ªä¹Ÿä¼šè¢«å¼ºåˆ¶æ‹‰å›ç°å®ä¸–ç•Œã€‚å›åˆ°ç°å®ä¸–ç•Œåï¼ŒReact ä¼šç«‹å³å¯¹ç»„ä»¶ Pengding çš„å˜æ›´è¿›è¡Œåˆå¹¶ï¼Œå‘ˆç°åœ¨ç”¨æˆ·é¢å‰ã€‚</p><p>å› æ­¤ï¼Œä½ å¯ä»¥è®¤ä¸ºåœ¨Concurrent æ¨¡å¼ä¸‹ï¼Œ React ç»„ä»¶æœ‰ä¸‰ç§çŠ¶æ€:</p><p><img src="/images/concurrent-mode/component-state.png" alt></p><p><br></p><ul><li><strong>Normal</strong> - æ­£å¸¸çŠ¶æ€ä¸‹çš„ç»„ä»¶</li><li><strong>Suspense</strong> - å› å¼‚æ­¥çŠ¶æ€è€ŒæŒ‚èµ·çš„ç»„ä»¶</li><li><strong>Pending</strong> - è¿›å…¥å¹³è¡Œå®‡å®™çš„ç»„ä»¶ã€‚å¯¹åº”çš„ä¹Ÿæœ‰ Pending çš„â€™çŠ¶æ€å˜æ›´â€™ï¼Œè¿™äº›å˜æ›´ React ä¸ä¼šç«‹å³æäº¤åˆ°ç”¨æˆ·ç•Œé¢ï¼Œè€Œæ˜¯ç¼“å­˜ç€ï¼Œç­‰å¾… Suspense å°±ç»ªæˆ–è¶…æ—¶ã€‚</li></ul><p>ä½ å¯èƒ½è¿˜ä¸å¤ªèƒ½ç†è§£, æ²¡å…³ç³»ï¼Œç»§ç»­å¾€ä¸‹è¯»ã€‚</p><p><br><br><br></p><h2 id="åº”ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#åº”ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="åº”ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿ"></a>åº”ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>â€˜å¹³è¡Œå®‡å®™â€™æœ‰ä»€ä¹ˆç”¨ï¼Ÿ æˆ‘ä»¬ä¸è®²ä»£ç æˆ–è€…æ¶æ„å±‚æ¬¡çš„ä¸œè¥¿ã€‚å•ä» <code>UI</code> ä¸Šçœ‹ï¼š <strong>åœ¨æŸäº› UI äº¤äº’åœºæ™¯ï¼Œæˆ‘ä»¬å¹¶ä¸æƒ³é©¬ä¸Šå°†å˜æ›´ç«‹å³åº”ç”¨åˆ°é¡µé¢ä¸Š</strong>ã€‚</p><p><strong>ğŸ”´æ¯”å¦‚ä½ ä»ä¸€ä¸ªé¡µé¢åˆ‡æ¢åˆ°å¦ä¸€ä¸ªé¡µé¢ï¼Œæ–°é¡µé¢å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´æ‰èƒ½åŠ è½½å®Œæˆï¼Œå…¶å®æˆ‘ä»¬æ›´ä¹äºç¨å¾®åœç•™åœ¨ä¸Šä¸€ä¸ªé¡µé¢ï¼Œä¿æŒä¸€äº›æ“ä½œå“åº”, æ¯”å¦‚æˆ‘ä»¬å¯ä»¥å–æ¶ˆï¼Œæˆ–è€…è¿›è¡Œå…¶ä»–æ“ä½œï¼Œè€Œç»™æˆ‘çœ‹ä¸€ä¸ªä»€ä¹ˆéƒ½æ²¡æœ‰çš„ç©ºç™½é¡µé¢æˆ–è€…ç©ºè½¬åŠ è½½çŠ¶æ€ç¬¦, æ„Ÿè§‰åœ¨åšæ— è°“çš„ç­‰å¾…</strong>ã€‚</p><p>è¿™ç§äº¤äº’åœºæ™¯å…¶å®éå¸¸å¸¸è§ï¼Œçœ¼å‰çš„ä¾‹å­å°±æ˜¯æµè§ˆå™¨ï¼š</p><p><br></p><p><img src="/images/concurrent-mode/browser.gif" alt><br><i>å‡è£…æˆ‘è¦ä¹°ä¸ª AirPods</i></p><p><br></p><p>è¿˜æœ‰æˆ‘ä»¬å¸¸ç”¨çš„ Github:</p><p><img src="/images/concurrent-mode/github.gif" alt><br><i>å›½å¤–æŸè‘—åäº¤å‹ç½‘ç«™</i></p><p><br></p><p>æ¯”å¦‚æˆ‘æƒ³ç‚¹å‡»ä¹°ä¸ª <code>AirPods</code>ï¼Œæµè§ˆå™¨ä¼šåœç•™åœ¨ä¸Šä¸€ä¸ªé¡µé¢ï¼Œç›´åˆ°ä¸‹ä¸€ä¸ªé¡µé¢çš„è¯·æ±‚è·å¾—å“åº”æˆ–è€…è¶…æ—¶ã€‚å¦å¤–æµè§ˆå™¨ä¼šé€šè¿‡åœ°å€æ çš„åŠ è½½æŒ‡ç¤ºç¬¦æç¤ºè¯·æ±‚æƒ…å†µã€‚è¿™ç§äº¤äº’è®¾è®¡ï¼Œæ¯”ç›´æ¥åˆ‡æ¢è¿‡å»ï¼Œå±•ç¤ºä¸€ä¸ªç©ºç™½çš„é¡µé¢è¦å¥½å¾—å¤š. é¡µé¢å¯ä»¥ä¿æŒç”¨æˆ·å“åº”, ä¹Ÿå¯ä»¥éšæ—¶å–æ¶ˆè¯·æ±‚ï¼Œä¿ç•™åœ¨åŸæ¥çš„é¡µé¢ã€‚</p><blockquote><p>å½“ç„¶, Tab åˆ‡æ¢æ—¶å¦å¤–ä¸€ç§äº¤äº’åœºæ™¯ï¼Œæˆ‘ä»¬å¸Œæœ›å®ƒé©¬ä¸Šåˆ‡æ¢è¿‡å», å¦åˆ™ç”¨æˆ·ä¼šè§‰å¾—ç‚¹å‡»ä¸èµ·ä½œç”¨ã€‚</p></blockquote><p>â€˜å¹³è¡Œå®‡å®™â€™ï¼Œè¿˜æœ‰ä¸€ä¸ªå¥½å¤„: <strong>ğŸ”´æˆ‘ä»¬å‡è®¾å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œæ•°æ®è¯·æ±‚éƒ½æ˜¯éå¸¸å¿«çš„ï¼Œè¿™æ—¶å€™å…¶å®æ²¡æœ‰å¿…è¦å±•ç¤ºåŠ è½½çŠ¶æ€ï¼Œè¿™ä¼šå¯¼è‡´é¡µé¢é—ªçƒå’ŒæŠ–åŠ¨ã€‚å…¶å®é€šè¿‡çŸ­æš‚çš„å»¶æ—¶ï¼Œå¯ä»¥æ¥å‡å°‘åŠ è½½çŠ¶æ€çš„å±•ç¤ºé¢‘ç‡</strong>ã€‚</p><p>å¦å¤–ï¼Œ<strong>ğŸ”´useTransition ä¹Ÿå¯ä»¥ç”¨äºåŒ…è£¹ä½ä¼˜å…ˆçº§æ›´æ–°</strong>ã€‚ ä»ç›®å‰çš„æƒ…å†µçœ‹ï¼ŒReact å¹¶æ²¡æœ‰æ„æ„¿æš´éœ²è¿‡å¤šçš„ Concurrent æ¨¡å¼çš„åº•å±‚ç»†èŠ‚ã€‚å¦‚æœä½ è¦è°ƒåº¦ä½ä¼˜å…ˆçº§çš„æ›´æ–°ï¼Œåªèƒ½ä½¿ç”¨ useTransitionã€‚</p><p><br><br><br></p><h2 id="usetransition-ç™»åœº"><a href="#usetransition-ç™»åœº" class="headerlink" title="useTransition ç™»åœº"></a>useTransition ç™»åœº</h2><p><img src="/images/concurrent-mode/page-state.png" alt></p><p><br></p><p>å¦‚ä¸Šå›¾ï¼Œæˆ‘ä»¬å…ˆæŒ‰ç…§ React å®˜æ–¹æ–‡æ¡£çš„æè¿°æ¥å®šä¹‰é¡µé¢çš„å„ç§çŠ¶æ€ã€‚<strong>å®ƒæåˆ°é¡µé¢åŠ è½½æœ‰ä»¥ä¸‹ä¸‰ä¸ªé˜¶æ®µ</strong>:</p><p><strong>â‘  è¿‡æ¸¡é˜¶æ®µ(Transition)</strong></p><p>æŒ‡çš„æ˜¯é¡µé¢æœªå°±ç»ªï¼Œç­‰å¾…åŠ è½½å…³é”®æ•°æ®çš„é˜¶æ®µã€‚æŒ‰ç…§ä¸åŒçš„å±•ç¤ºç­–ç•¥ï¼Œé¡µé¢å¯ä»¥æœ‰ä»¥ä¸‹ä¸¤ç§çŠ¶æ€ï¼š</p><ul><li><p><strong>âš›ï¸é€€åŒ–(Receded)</strong>ã€‚é©¬ä¸Šå°†é¡µé¢åˆ‡æ¢è¿‡å»ï¼Œå±•ç¤ºä¸€ä¸ªå¤§å¤§çš„åŠ è½½æŒ‡ç¤ºå™¨æˆ–è€…ç©ºç™½é¡µé¢ã€‚â€™é€€åŒ–â€™æ˜¯ä»€ä¹ˆæ„æ€? æŒ‰ç…§ React çš„è¯´æ³•æ˜¯ï¼Œé¡µé¢åŸæœ¬æœ‰å†…å®¹ï¼Œç°åœ¨å˜ä¸ºæ— å†…å®¹çŠ¶æ€ï¼Œè¿™æ˜¯ä¸€ç§é€€åŒ–ï¼Œæˆ–è€…è¯´å†å²çš„â€™é€€æ­¥â€™ã€‚</p></li><li><p><strong>âš›ï¸å¾…å®š(Pending)</strong>ã€‚è¿™æ˜¯ <code>useTransition</code> è¦è¾¾åˆ°çš„çŠ¶æ€ï¼Œå³åœç•™åœ¨å½“å‰é¡µé¢ï¼Œè®©å½“å‰é¡µé¢ä¿æŒå“åº”ã€‚åœ¨<strong>å…³é”®æ•°æ®å‡†å¤‡å°±ç»ª</strong>æ—¶è¿›å…¥ <code>Skeleton</code>(éª¨æ¶å±) çŠ¶æ€ï¼Œ äº¦æˆ–è€…ç­‰å¾…è¶…æ—¶å›é€€åˆ° <code>Receded</code> çŠ¶æ€ã€‚</p></li></ul><p><br></p><p><strong>â‘¡ åŠ è½½é˜¶æ®µ(Loading)</strong></p><p>æŒ‡çš„æ˜¯<code>å…³é”®æ•°æ®</code>å·²ç»å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥å¼€å§‹å±•ç¤ºé¡µé¢çš„éª¨æ¶æˆ–è€…æ¡†æ¶éƒ¨åˆ†ã€‚è¿™ä¸ªé˜¶æ®µæœ‰ä¸€ä¸ªçŠ¶æ€:</p><ul><li><strong>âš›ï¸éª¨æ¶(Skeleton)</strong>ã€‚å…³é”®æ•°æ®å·²ç»åŠ è½½å®Œæ¯•ï¼Œé¡µé¢å±•ç¤ºäº†ä¸»ä½“çš„æ¡†æ¶ã€‚</li></ul><p><br></p><p><strong>â‘¢å°±ç»ªé˜¶æ®µ(Done)</strong>ã€‚</p><p>æŒ‡çš„æ˜¯é¡µé¢å®Œå…¨åŠ è½½å®Œæ¯•ã€‚è¿™ä¸ªé˜¶æ®µæœ‰ä¸€ä¸ªçŠ¶æ€:</p><ul><li><strong>âš›ï¸å®Œæˆ(Complete)</strong> é¡µé¢å®Œå…¨å‘ˆç°</li></ul><p><br><br><br></p><p>ä¼ ç»Ÿçš„ React ä¸­ï¼Œå½“æˆ‘ä»¬å˜æ›´çŠ¶æ€è¿›å…¥ä¸€ä¸ªæ–°å±å¹•æ—¶ï¼Œç»å†çš„æ˜¯ <strong>ğŸ”´<code>Receded</code> -&gt; <code>Skeleton</code> -&gt; <code>Complete</code></strong> è·¯å¾„ã€‚åœ¨æ­¤ä¹‹å‰è¦å®ç° <strong>ğŸ”´<code>Pending</code> -&gt; <code>Skeleton</code> -&gt; <code>Complete</code></strong> è¿™ç§åŠ è½½è·¯å¾„æ¯”è¾ƒå›°éš¾ã€‚ <code>useTransition</code> å¯ä»¥æ”¹å˜è¿™ä¸ªå±€é¢ã€‚</p><p><br></p><p>æ¥ä¸‹æ¥ç®€å•æ¨¡æ‹Ÿä¸€ä¸ªé¡µé¢åˆ‡æ¢ï¼Œå…ˆæ¥çœ‹é»˜è®¤æƒ…å†µä¸‹æ˜¯å¦‚ä½•åŠ è½½çš„:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">A</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"letter"</span>&gt;</span>A<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">B</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// âš›ï¸ å»¶è¿ŸåŠ è½½2sï¼Œæ¨¡æ‹Ÿå¼‚æ­¥æ•°æ®è¯·æ±‚</span></span><br><span class="line">  delay(<span class="string">"B"</span>, <span class="number">2000</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"letter"</span>&gt;</span>B<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">C</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// âš›ï¸ å»¶è¿ŸåŠ è½½4sï¼Œæ¨¡æ‹Ÿå¼‚æ­¥æ•°æ®è¯·æ±‚</span></span><br><span class="line">  delay(<span class="string">"C"</span>, <span class="number">4000</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"letter"</span>&gt;</span>C<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é¡µé¢1</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Page1</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">A</span> /&gt;</span>;</span></span><br><span class="line"><span class="xml">&#125;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">// é¡µé¢2</span></span><br><span class="line"><span class="xml">function Page2() &#123;</span></span><br><span class="line"><span class="xml">  return (</span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">B</span> /&gt;</span></span></span><br><span class="line">      &lt;Suspense fallback=&#123;&lt;div&gt;Loading... C&lt;/div&gt;&#125;&gt;</span><br><span class="line">        &lt;C /&gt;</span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/&gt;</span></span></span><br><span class="line"><span class="xml">  );</span></span><br><span class="line"><span class="xml">&#125;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">function App() &#123;</span></span><br><span class="line"><span class="xml">  const [showPage2, setShowPage2] = useState(false);</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">  // ç‚¹å‡»åˆ‡æ¢åˆ°é¡µé¢2</span></span><br><span class="line"><span class="xml">  const handleClick = () =&gt;  setShowPage2(true)</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">  return (</span></span><br><span class="line">    &lt;div className="App"&gt;</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;button onClick=&#123;handleClick&#125;&gt;åˆ‡æ¢&lt;/button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;div className="page"&gt;</span><br><span class="line">        &lt;Suspense fallback=&#123;&lt;div&gt;Loading ...&lt;/div&gt;&#125;&gt;</span><br><span class="line">          &#123;!showPage2 ? &lt;Page1 /&gt; : &lt;Page2 /&gt;&#125;</span><br><span class="line">        &lt;/Suspense&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">  );</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure><p><br></p><p>çœ‹ä¸€ä¸‹è¿è¡Œæ•ˆæœ:</p><p><img src="/images/concurrent-mode/demo1.gif" alt></p><p>ç‚¹å‡»åˆ‡æ¢åï¼Œæˆ‘ä»¬ä¼šé©¬ä¸Šçœ‹åˆ°ä¸€ä¸ªå¤§å¤§çš„ <code>Loading...</code>ï¼Œæ¥ç€ 2s å B åŠ è½½å®Œæ¯•ï¼Œå†ç­‰å¾… 2s å C åŠ è½½å®Œæ¯•ã€‚è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯ <strong><code>Receded</code> -&gt; <code>Skeleton</code> -&gt; <code>Complete</code></strong></p><p><br></p><p>ç°åœ¨æœ‰è¯· useTransition éš†é‡ç™»åœº ğŸ‰ï¼Œåªéœ€å¯¹ä¸Šé¢çš„ä»£ç è¿›è¡Œçš„ç®€å•æ”¹é€ ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// âš›ï¸ å¯¼å…¥ useTransition</span></span><br><span class="line"><span class="keyword">import</span> React, &#123; Suspense, useState, useTransition &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [showPage2, setShowPage2] = useState(<span class="literal">false</span>);</span><br><span class="line">  <span class="comment">// âš›ï¸ useTransition æ¥æ”¶ä¸€ä¸ªè¶…æ—¶æ—¶é—´ï¼Œè¿”å›ä¸€ä¸ªstartTransition å‡½æ•°ï¼Œä»¥åŠä¸€ä¸ª pending</span></span><br><span class="line">  <span class="keyword">const</span> [startTransition, pending] = useTransition(&#123; <span class="attr">timeoutMs</span>: <span class="number">10000</span> &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> handleClick = <span class="function"><span class="params">()</span> =&gt;</span></span><br><span class="line">    <span class="comment">// âš›ï¸ å°†å¯èƒ½è§¦å‘ Suspense æŒ‚èµ·çš„çŠ¶æ€å˜æ›´åŒ…è£¹åœ¨ startTransition ä¸­</span></span><br><span class="line">    startTransition(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      setShowPage2(<span class="literal">true</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div className=<span class="string">"App"</span>&gt;</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;button onClick=&#123;handleClick&#125;&gt;åˆ‡æ¢&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">        &#123;/</span>* âš›ï¸ pending è¡¨ç¤ºå¤„äºå¾…å®šçŠ¶æ€, ä½ å¯ä»¥è¿›è¡Œä¸€äº›è½»å¾®çš„æç¤º *<span class="regexp">/&#125;</span></span><br><span class="line"><span class="regexp">        &#123;pending &amp;&amp; &lt;span&gt;åˆ‡æ¢ä¸­...&lt;/</span>span&gt;&#125;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">      &lt;div className="page"&gt;</span></span><br><span class="line"><span class="regexp">        &lt;Suspense fallback=&#123;&lt;div&gt;Loading ...&lt;/</span>div&gt;&#125;&gt;</span><br><span class="line">          &#123;!showPage2 ? <span class="xml"><span class="tag">&lt;<span class="name">Page1</span> /&gt;</span> : <span class="tag">&lt;<span class="name">Page2</span> /&gt;</span>&#125;</span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>useTransition Hook çš„APIæ¯”è¾ƒç®€æ´ï¼Œæœ‰4ä¸ªéœ€è¦å…³é”®çš„ç‚¹:</p><ul><li><p><code>timeoutMs</code>, è¡¨ç¤ºåˆ‡æ¢çš„è¶…æ—¶æ—¶é—´(æœ€é•¿åœ¨å¹³è¡Œå®‡å®™å­˜åœ¨çš„æ—¶é—´)ï¼ŒuseTransition ä¼šè®© React ä¿æŒåœ¨å½“å‰é¡µé¢ï¼Œç›´åˆ°è¢«è§¦å‘ Suspense å°±ç»ªæˆ–è€…è¶…æ—¶ã€‚</p></li><li><p><code>startTransition</code>, å°†å¯èƒ½è§¦å‘é¡µé¢åˆ‡æ¢(ä¸¥æ ¼è¯´æ˜¯è§¦å‘ Suspense æŒ‚èµ·)çš„çŠ¶æ€å˜æ›´åŒ…è£¹åœ¨ <code>startTransition</code> ä¸‹ï¼Œå®é™…ä¸Š startTransition æä¾›äº†ä¸€ä¸ªâ€™æ›´æ–°çš„ä¸Šä¸‹æ–‡â€™ã€‚ ä¸‹ä¸€èŠ‚æˆ‘ä»¬ä¼šæ·±å…¥æ¢ç´¢è¿™é‡Œé¢çš„ç»†èŠ‚</p></li><li><p><code>pending</code>, è¡¨ç¤ºæ­£å¤„äºå¾…å®šçŠ¶æ€ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªçŠ¶æ€å€¼ï¼Œé€‚å½“åœ°ç»™ç”¨æˆ·ä¸€ä¸‹æç¤ºã€‚</p></li><li><p><code>Suspense</code>, useTransition å®ç°è¿‡æ¸¡çŠ¶æ€å¿…é¡»å’Œ Suspense é…åˆï¼Œä¹Ÿå°±æ˜¯ <code>startTransition</code> ä¸­çš„æ›´æ–°å¿…é¡»è§¦å‘ä»»æ„ä¸€ä¸ª Suspense æŒ‚èµ·ã€‚</p></li></ul><p><br></p><p>çœ‹ä¸€ä¸‹å®é™…çš„è¿è¡Œæ•ˆæœå§ï¼</p><p><img src="/images/concurrent-mode/demo2.gif" alt></p><p><br></p><p>è¿™ä¸ªæ•ˆæœå®Œå…¨è·Ÿæœ¬èŠ‚å¼€å§‹çš„â€™ç¬¬ä¸€å¼ å›¾â€™ä¸€æ ·: React ä¼šä¿ç•™åœ¨å½“å‰é¡µé¢ï¼Œ<code>pending</code> å˜ä¸ºäº†trueï¼Œæ¥ç€ B å…ˆå°±ç»ªï¼Œç•Œé¢é©¬ä¸Šåˆ‡æ¢è¿‡å»ã€‚æ•´ä¸ªè¿‡ç¨‹ç¬¦åˆ <strong><code>Pending</code> -&gt; <code>Skeleton</code> -&gt; <code>Complete</code></strong> çš„è·¯å¾„ã€‚</p><p><code>startTransition</code> ä¸­çš„<code>å˜æ›´</code>ä¸€æ—¦è§¦å‘ <code>Suspense</code>ï¼ŒReact å°±ä¼šå°†<code>å˜æ›´</code>æ ‡è®°çš„ Pending çŠ¶æ€, Reactä¼šå»¶å â€™æäº¤â€˜ è¿™äº›å˜æ›´ã€‚æ‰€ä»¥<strong>å®é™…ä¸Šå¹¶æ²¡æœ‰å¼€å¤´è¯´çš„å¹³è¡Œå®‡å®™, é‚£ä¹ˆé«˜å¤§ä¸Šå’Œç¥å¥‡ï¼ŒReact åªä¸è¿‡æ˜¯å»¶åäº†è¿™äº›å˜æ›´çš„æäº¤ã€‚æˆ‘ä»¬ç•Œé¢ä¸Šçœ‹åˆ°çš„åªä¸è¿‡æ˜¯æ—§çš„æˆ–è€…æœªè¢« Pending çš„çŠ¶æ€ï¼ŒReact åœ¨åå°è¿›è¡Œäº†é¢„æ¸²æŸ“</strong>ã€‚</p><p>æ³¨æ„ï¼ŒReact åªæ˜¯æš‚æ—¶æ²¡æœ‰æäº¤è¿™äº›å˜æ›´ï¼Œä¸è¯´æ˜ React â€™å¡æ­»äº†â€˜ï¼Œå¤„äºPending çŠ¶æ€çš„ç»„ä»¶è¿˜ä¼šæ¥æ”¶ç”¨æˆ·çš„å“åº”ï¼Œè¿›è¡Œæ–°çš„çŠ¶æ€å˜æ›´ï¼Œæ–°çš„çŠ¶æ€æ›´æ–°ä¹Ÿå¯ä»¥è¦†ç›–æˆ–ç»ˆæ­¢ Pending çŠ¶æ€ã€‚</p><p><br></p><p>æ€»ç»“ä¸€ä¸‹è¿›å…¥å’Œé€€å‡º Pending çŠ¶æ€çš„æ¡ä»¶:</p><ul><li><strong>è¿›å…¥Pending</strong> çŠ¶æ€é¦–å…ˆéœ€è¦å°† <code>çŠ¶æ€å˜æ›´</code> åŒ…è£¹åœ¨ <code>startTransition</code> ä¸‹ï¼Œä¸”è¿™äº›æ›´æ–°ä¼šè§¦å‘ Suspense æŒ‚èµ·</li><li><strong>é€€å‡º Pending</strong> çŠ¶æ€æœ‰ä¸‰ç§æ–¹å¼: â‘  Suspense å°±ç»ªï¼›â‘¡ è¶…æ—¶ï¼›â‘¢ è¢«æ–°çš„çŠ¶æ€æ›´æ–°è¦†ç›–æˆ–è€…ç»ˆæ­¢</li></ul><p><br><br><br></p><h2 id="usetransition-åŸç†åˆæ¢"><a href="#usetransition-åŸç†åˆæ¢" class="headerlink" title="useTransition åŸç†åˆæ¢"></a>useTransition åŸç†åˆæ¢</h2><p>è¿™ä¸€èŠ‚ï¼Œæˆ‘ä»¬æ·±å…¥æ¢ç´¢ä¸€ä¸‹ useTransitionï¼Œä½†æ˜¯æ–¹å¼ä¸æ˜¯å»æŠ˜è…¾æºç ï¼Œè€Œæ˜¯æŠŠå®ƒå½“æˆä¸€ä¸ªé»‘ç›’ï¼Œé€šè¿‡å‡ ä¸ªå®éªŒæ¥åŠ æ·±ä½ å¯¹ useTransition çš„ç†è§£ã€‚</p><p>useTransition çš„å‰èº«æ˜¯ <code>withSuspenseConfig</code>, <a href="https://github.com/sebmarkbage" target="_blank" rel="noopener">Sebmarkbage</a> åœ¨ä»Šå¹´äº”æœˆä»½æçš„ä¸€ä¸ª<a href="https://github.com/facebook/react/pull/15593" target="_blank" rel="noopener">PR</a> ä¸­å¼•è¿›äº†å®ƒã€‚</p><p>ä»å‘½åä¸Šçœ‹ï¼Œå®ƒä¸è¿‡æ˜¯æƒ³é…ç½®ä¸€ä¸‹ Suspenseã€‚ æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡æœ€æ–°çš„æºç éªŒè¯è¿™ä¸€ç‚¹ã€‚ useTransition çš„å·¥ä½œâ€™çœ‹ä¼¼â€™éå¸¸ç®€å•:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateTransition</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  config: SuspenseConfig | void | null,</span></span></span><br><span class="line">): [(() =&gt; void) =&gt; void, boolean] &#123;</span><br><span class="line">  <span class="keyword">const</span> [isPending, setPending] = updateState(<span class="literal">false</span>); <span class="comment">// ç›¸å½“äºuseState</span></span><br><span class="line">  <span class="keyword">const</span> startTransition = updateCallback(             <span class="comment">// ç›¸å½“äºuseCallback</span></span><br><span class="line">    callback =&gt; &#123;</span><br><span class="line">      setPending(<span class="literal">true</span>); <span class="comment">// è®¾ç½® pending ä¸º true</span></span><br><span class="line">      <span class="comment">// ä»¥ä½ä¼˜å…ˆçº§è°ƒåº¦æ‰§è¡Œ</span></span><br><span class="line">      Scheduler.unstable_next(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// âš›ï¸ è®¾ç½®suspenseConfig</span></span><br><span class="line">        <span class="keyword">const</span> previousConfig = ReactCurrentBatchConfig.suspense;</span><br><span class="line">        ReactCurrentBatchConfig.suspense = config === <span class="literal">undefined</span> ? <span class="literal">null</span> : config;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// è¿˜åŸ pending</span></span><br><span class="line">          setPending(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">          <span class="comment">// æ‰§è¡Œä½ çš„å›è°ƒ</span></span><br><span class="line">          callback();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          <span class="comment">// âš›ï¸ è¿˜åŸsuspenseConfig</span></span><br><span class="line">          ReactCurrentBatchConfig.suspense = previousConfig;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">    [config, isPending],</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">return</span> [startTransition, isPending];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>çœ‹ä¼¼å¾ˆæ™®é€šï¼Œè¦ç‚¹åœ¨å“ªï¼ŸSebmarkbage åœ¨ä¸Šè¿°çš„ PR ä¸­ä¹ŸæåŠäº†ä¸€äº›ä¿¡æ¯ã€‚</p><ul><li><p>startTransition ä¸€å¼€å§‹æ‰§è¡Œå°±å°† pending è®¾ç½®ä¸ºtrueã€‚æ¥ç€ä½¿ç”¨ <code>unstable_next</code> æ‰§è¡Œå›è°ƒ, <strong>unstable_next å¯ä»¥é™ä½æ›´æ–°çš„ä¼˜å…ˆçº§</strong>ã€‚ä¹Ÿå°±æ˜¯è¯´ unstable_next å›è°ƒä¸­è§¦å‘çš„â€™å˜æ›´â€˜ä¼˜å…ˆçº§ä¼šæ¯”è¾ƒä½ï¼Œå®ƒä¼šè®©ä½ä¸ºé«˜ä¼˜å…ˆçº§çš„æ›´æ–°ï¼Œæˆ–è€…å½“å‰äº‹åŠ¡ç¹å¿™æ—¶ï¼Œè°ƒåº¦åˆ°ä¸‹ä¸€ç©ºé—²æœŸå†åº”ç”¨ï¼Œä½†ä¹Ÿå¯èƒ½é©¬ä¸Šå°±è¢«åº”ç”¨ã€‚</p></li><li><p>è¦ç‚¹æ˜¯ <code>ReactCurrentBatchConfig.suspense</code> çš„é…ç½®, è¿™é‡Œé¢ä¼šé…ç½® Suspense çš„è¶…æ—¶æ—¶é—´ã€‚<strong>å®ƒè¡¨æ˜è¿™ä¸ªåŒºé—´è§¦å‘çš„å˜æ›´éƒ½è¢«å…³è”è¯¥ <code>suspenseConfig</code></strong>, è¿™äº›å˜æ›´ä¼šæ ¹æ® suspenseConfig æ¥è®¡ç®—è‡ªå·±çš„ <code>expiredTime</code>(å¯ä»¥è§†ä½œâ€˜ä¼˜å…ˆçº§â€™)ã€‚æˆ‘ä»¬æš‚ä¸”å°†è¿™äº›å…³è”äº† suspenseConfig çš„å˜æ›´ç§°ä¸º <code>Pending å˜æ›´</code>.</p></li><li><p><code>Pending å˜æ›´</code> è§¦å‘çš„é‡æ–°æ¸²æŸ“(Render)ä¹Ÿä¼šå…³è”è¯¥ <code>suspenseConfig</code>ã€‚å¦‚æœåœ¨æ¸²æŸ“æœŸé—´è§¦å‘äº† Suspenseï¼Œé‚£ä¹ˆ<code>Pending å˜æ›´</code> å°±ä¼šè¢«å»¶è¿Ÿæäº¤(commit)ï¼Œå®ƒä»¬ä¼šç¼“å­˜åœ¨å†…å­˜ä¸­, ç­‰åˆ° Suspense è¶…æ—¶æˆ–è€…å°±ç»ª, æŠ‘æˆ–è¢«å…¶ä»–æ›´æ–°è¦†ç›–, æ‰å¼ºåˆ¶æäº¤åˆ°ç”¨æˆ·ç•Œé¢ã€‚</p></li><li><p><code>Pending å˜æ›´</code> åªæ˜¯è¢«å»¶è¿Ÿæäº¤äº†ï¼Œä½†æ˜¯ä¸ä¼šå½±å“æœ€ç»ˆæ•°æ®å’Œè§†å›¾çš„ä¸€è‡´æ€§ã€‚React ä¼šåœ¨å†…å­˜ä¸­é‡æ–°æ¸²æŸ“ï¼Œåªæ˜¯ä¸æäº¤åˆ°ç”¨æˆ·ç•Œé¢è€Œå·²ã€‚</p></li></ul><p><br></p><p>React å†…éƒ¨çš„å®ç°å¤ªè¿‡å¤æ‚ï¼Œæˆ‘å‘ç°å»æŒ–å®ƒæˆ–è€…ç”¨æ–‡å­—è¡¨è¾¾å‡ºæ¥æˆæœ¬éƒ½å¾ˆé«˜ã€‚å› æ­¤æ¢ä¸€ç§æ–¹å¼ï¼Œé€šè¿‡å®éªŒ(é»‘ç›’)æ–¹å¼æ¥äº†è§£å®ƒçš„è¡Œä¸ºï¼š</p><blockquote><p>è¿™äº›å®éªŒä»£ç åœ¨è¿™ä¸ª <a href="https://codesandbox.io/s/react-use-transition-tests-kg8rc?fontsize=14" target="_blank" rel="noopener">CodeSandbox</a> ä¸­</p></blockquote><p><br></p><h3 id="1ï¸âƒ£-åˆ©ç”¨-starttransition-æ¥è¿è¡Œä½ä¼˜å…ˆçº§ä»»åŠ¡"><a href="#1ï¸âƒ£-åˆ©ç”¨-starttransition-æ¥è¿è¡Œä½ä¼˜å…ˆçº§ä»»åŠ¡" class="headerlink" title="1ï¸âƒ£ åˆ©ç”¨ startTransition æ¥è¿è¡Œä½ä¼˜å…ˆçº§ä»»åŠ¡"></a><strong>1ï¸âƒ£ åˆ©ç”¨ startTransition æ¥è¿è¡Œä½ä¼˜å…ˆçº§ä»»åŠ¡</strong></h3><p>è¿™ä¸ªå®éªŒä¸»è¦ç”¨äºéªŒè¯ <code>unstable_next</code>, å®ƒä¼šè®©é™ä½æ›´æ–°çš„ä¼˜å…ˆçº§ã€‚é€šè¿‡ä¸‹é¢çš„å®éªŒæˆ‘ä»¬ä¼šè§‚å¯Ÿåˆ°: é€šè¿‡<code>startTransition</code> åŒ…è£¹çš„å˜æ›´åœ¨ä»»åŠ¡ç¹å¿™çš„æƒ…å†µä¼šç¨å¾®å»¶åæ›´æ–°ï¼Œä½†æ˜¯æœ€ç»ˆçŠ¶æ€æ˜¯ä¸€è‡´çš„ã€‚</p><p>å®éªŒä»£ç :</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = useState(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">const</span> [tick, setTick] = useState(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">const</span> [startTransition, pending] = useTransition(&#123; <span class="attr">timeoutMs</span>: <span class="number">10000</span> &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> handleClick = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// âš›ï¸ åŒæ­¥æ›´æ–°</span></span><br><span class="line">    setCount(count + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    startTransition(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// âš›ï¸ ä½ä¼˜å…ˆçº§æ›´æ–° tick</span></span><br><span class="line">      setTick(<span class="function"><span class="params">t</span> =&gt;</span> t + <span class="number">1</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div className=<span class="string">"App"</span>&gt;</span><br><span class="line">      &lt;h1&gt;Hello useTransition&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">      &lt;div&gt;</span></span><br><span class="line"><span class="regexp">        &lt;button onClick=&#123;handleClick&#125;&gt;ADD + 1&lt;/</span>button&gt;</span><br><span class="line">        &#123;pending &amp;&amp; <span class="xml"><span class="tag">&lt;<span class="name">span</span>&gt;</span>pending<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span>&#125;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">      &lt;div&gt;Count: &#123;count&#125;&lt;/</span>div&gt;</span><br><span class="line">      &#123;<span class="comment">/* âš›ï¸ è¿™æ˜¯ä¸€ä¸ªå¤æ‚çš„ç»„ä»¶ï¼Œæ¸²æŸ“éœ€è¦ä¸€ç‚¹æ—¶é—´ï¼Œæ¨¡æ‹Ÿç¹å¿™çš„æƒ…å†µ */</span>&#125;</span><br><span class="line">      &lt;ComplexComponent value=&#123;tick&#125; /&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p><br></p><p>å®éªŒç»“æœå¦‚ä¸‹ï¼š</p><p><img src="/images/concurrent-mode/test1.gif" alt></p><p><br></p><p>åœ¨è¿ç»­ç‚¹å‡»çš„æƒ…å†µä¸‹ï¼Œ<code>ComplexComponent</code> çš„æ›´æ–°ä¼šæ˜æ˜¾æ»åï¼Œè¿™æ˜¯å› ä¸º tick å˜æ›´ä¼šè¢«å»¶åå’Œåˆå¹¶ï¼Œä½†æ˜¯æœ€åå®ƒä»¬çš„ç»“æœæ˜¯ä¸€è‡´çš„.</p><p><br><br><br></p><h3 id="2ï¸âƒ£-starttransition-æ›´æ–°è§¦å‘-suspense"><a href="#2ï¸âƒ£-starttransition-æ›´æ–°è§¦å‘-suspense" class="headerlink" title="2ï¸âƒ£ startTransition æ›´æ–°è§¦å‘ Suspense"></a><strong>2ï¸âƒ£ startTransition æ›´æ–°è§¦å‘ Suspense</strong></h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = useState(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">const</span> [tick, setTick] = useState(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">const</span> [startTransition, pending] = useTransition(&#123; <span class="attr">timeoutMs</span>: <span class="number">10000</span> &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> handleClick = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    startTransition(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      setCount(<span class="function"><span class="params">c</span> =&gt;</span> c + <span class="number">1</span>);</span><br><span class="line">      setTick(<span class="function"><span class="params">c</span> =&gt;</span> c + <span class="number">1</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div className=<span class="string">"App"</span>&gt;</span><br><span class="line">      &lt;h1&gt;Hello useTransition &#123;tick&#125;&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">      &lt;div&gt;</span></span><br><span class="line"><span class="regexp">        &lt;button onClick=&#123;handleClick&#125;&gt;ADD + 1&lt;/</span>button&gt;</span><br><span class="line">        &#123;pending &amp;&amp; <span class="xml"><span class="tag">&lt;<span class="name">span</span> <span class="attr">className</span>=<span class="string">"pending"</span>&gt;</span>pending<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span>&#125;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">      &lt;Tick /</span>&gt;</span><br><span class="line">      &lt;SuspenseBoundary id=&#123;count&#125; /&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">const SuspenseBoundary = (&#123; id &#125;) =&gt; &#123;</span></span><br><span class="line"><span class="regexp">  return (</span></span><br><span class="line"><span class="regexp">    &lt;Suspense fallback="Loading..."&gt;</span></span><br><span class="line"><span class="regexp">      &#123;/</span>* è¿™é‡Œä¼šæŠ›å‡ºä¸€ä¸ª<span class="built_in">Promise</span>å¼‚å¸¸ï¼Œ<span class="number">3</span>s å resolved *<span class="regexp">/&#125;</span></span><br><span class="line"><span class="regexp">      &lt;ComponentThatThrowPromise id=&#123;id&#125; /</span>&gt;</span><br><span class="line">    &lt;<span class="regexp">/Suspense&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ Tick ç»„ä»¶æ¯ç§’é€’å¢ä¸€æ¬¡</span></span><br><span class="line"><span class="regexp">const Tick = (&#123; duration = 1000 &#125;) =&gt; &#123;</span></span><br><span class="line"><span class="regexp">  const [tick, setTick] = useState(0);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  useEffect(() =&gt; &#123;</span></span><br><span class="line"><span class="regexp">    const t = setInterval(() =&gt; &#123;</span></span><br><span class="line"><span class="regexp">      setTick(tick =&gt; tick + 1);</span></span><br><span class="line"><span class="regexp">    &#125;, duration);</span></span><br><span class="line"><span class="regexp">    return () =&gt; clearInterval(t);</span></span><br><span class="line"><span class="regexp">  &#125;, [duration]);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  return &lt;div className="tick"&gt;tick: &#123;tick&#125;&lt;/</span>div&gt;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><img src="/images/concurrent-mode/test2.gif" alt></p><p>å½“æˆ‘ä»¬ç‚¹å‡»æŒ‰é’®æ—¶ä¼šé€’å¢ count å’Œ tick, count ä¼šä¼ é€’ç»™ SuspenseBoundaryï¼Œä»è€Œè§¦å‘ Suspenseã€‚</p><p>é€šè¿‡ä¸Šé¢çš„ç»“æœå¯ä»¥çŸ¥é“ï¼Œåœ¨ startTransition ä¸­è¿›è¡Œäº†å˜æ›´(æºå¸¦suspenseConfig), å¯¹åº”çš„é‡æ–°æ¸²æŸ“è§¦å‘äº† Suspenseï¼Œæ‰€ä»¥è¿›å…¥äº†PendingçŠ¶æ€ï¼Œå®ƒä»¬æ¸²æŸ“ç»“æœä¸ä¼šè¢«ç«‹å³â€˜æäº¤â€™ï¼Œé¡µé¢è¿˜æ˜¯ä¿æŒåœ¨åŸæ¥çš„çŠ¶æ€ã€‚</p><p>å¦å¤–ä½ ä¼šå‘ç° App ç»„ä»¶çš„ tick è·Ÿ SuspenseBoundary ä¸€æ ·ä¹Ÿä¼šè¢«â€˜åœæ­¢â€™(çœ‹Hello Transition åé¢çš„tick)ï¼Œå› ä¸º tick å˜æ›´ä¹Ÿå…³è”äº†suspenseConfigã€‚</p><p>è€Œ Tick ç»„ä»¶åˆ™æ¯ä¸€ç§’é€’å¢ä¸€æ¬¡ï¼Œä¸ä¼šè¢«é˜»å¡ã€‚</p><p>è¿™å°±è¯´æ˜äº†ä¸€æ—¦è§¦å‘äº†Suspenseï¼Œåªè¦å…³è”äº† suspenseConfig çš„å˜æ›´å°±ä¼šè¢«â€˜æš‚åœâ€™æäº¤ã€‚</p><p><br><br><br></p><h3 id="3ï¸âƒ£-å°†-tick-æ›´æ–°æåˆ°-starttransition-ä½œç”¨åŸŸå¤–"><a href="#3ï¸âƒ£-å°†-tick-æ›´æ–°æåˆ°-starttransition-ä½œç”¨åŸŸå¤–" class="headerlink" title="3ï¸âƒ£ å°† tick æ›´æ–°æåˆ° startTransition ä½œç”¨åŸŸå¤–"></a><strong>3ï¸âƒ£ å°† tick æ›´æ–°æåˆ° startTransition ä½œç”¨åŸŸå¤–</strong></h3><p>åœ¨ 2ï¸âƒ£ çš„åŸºç¡€ä¸Šï¼Œå°† setTick æåˆ° startTransition ä½œç”¨åŸŸå¤–:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = useState(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">const</span> [tick, setTick] = useState(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">const</span> [startTransition, pending] = useTransition(&#123; <span class="attr">timeoutMs</span>: <span class="number">10000</span> &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"App rendering with"</span>, count, tick, pending);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> handleClick = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    setTick(<span class="function"><span class="params">c</span> =&gt;</span> c + <span class="number">1</span>);</span><br><span class="line">    startTransition(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      setCount(<span class="function"><span class="params">c</span> =&gt;</span> c + <span class="number">1</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> handleAddTick = <span class="function"><span class="params">()</span> =&gt;</span> setTick(<span class="function"><span class="params">c</span> =&gt;</span> c + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"App committed with"</span>, count, tick, pending);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div className=<span class="string">"App"</span>&gt;</span><br><span class="line">      &lt;h1&gt;Hello useTransition &#123;tick&#125;&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">      &lt;div&gt;</span></span><br><span class="line"><span class="regexp">        &lt;button onClick=&#123;handleClick&#125;&gt;ADD + 1&lt;/</span>button&gt;</span><br><span class="line">        &lt;button onClick=&#123;handleAddTick&#125;&gt;Tick + <span class="number">1</span>&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">        &#123;pending &amp;&amp; &lt;span className="pending"&gt;pending&lt;/</span>span&gt;&#125;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">      &lt;Tick /</span>&gt;</span><br><span class="line">      &lt;SuspenseBoundary id=&#123;count&#125; /&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p><img src="/images/concurrent-mode/test3.gif" alt></p><p><br></p><p>ç°åœ¨ tick ä¼šè¢«ç«‹å³æ›´æ–°ï¼Œè€Œ SuspenseBoundary è¿˜ä¼šæŒ‚åœ¨ pending çŠ¶æ€ã€‚</p><p>æˆ‘ä»¬æ‰“å¼€æ§åˆ¶å°çœ‹ä¸€ä¸‹ï¼Œè¾“å‡ºæƒ…å†µ:</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">App rendering with 1 2 true   # pending è¢«è®¾ç½®ä¸ºtrue, count è¿™æ˜¯æ—¶å€™æ˜¯ 1ï¼Œ è€Œ tick æ˜¯ 2</span><br><span class="line">App rendering with 1 2 true</span><br><span class="line">read  1</span><br><span class="line">App committed with 1 2 true    # è¿›å…¥Pending çŠ¶æ€ä¹‹å‰çš„ä¸€æ¬¡æäº¤ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œå¼€å§‹å±•ç¤º pending æŒ‡ç¤ºç¬¦</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> ä¸‹é¢ Tick æ›´æ–°äº†ä¸‰æ¬¡(3s)</span><br><span class="line"><span class="meta">#</span> æˆ‘ä»¬æ³¨æ„åˆ°ï¼Œæ¯ä¸€æ¬¡ React éƒ½ä¼šé‡æ–°æ¸²æŸ“ä¸€ä¸‹ App ç»„ä»¶ï¼Œå³ 'ping' ä¸€ä¸‹å¤„äº Pending çŠ¶æ€çš„ç»„ä»¶, æ£€æŸ¥ä¸€ä¸‹æ˜¯å¦â€˜å°±ç»ªâ€™(æ²¡æœ‰è§¦å‘Suspense)</span><br><span class="line"><span class="meta">#</span> å¦‚æœè¿˜è§¦å‘ Suspense, è¯´æ˜è¿˜è¦ç»§ç»­ç­‰å¾…ï¼Œè¿™äº›é‡æ–°æ¸²æŸ“çš„ç»“æœä¸ä¼šè¢«æäº¤</span><br><span class="line"></span><br><span class="line">App rendering with 2 2 false # ping, è¿™é‡Œcountå˜æˆäº†2ï¼Œä¸” pending å˜æˆäº† false</span><br><span class="line">App rendering with 2 2 false # ä½†æ˜¯ React åœ¨å†…å­˜ä¸­æ¸²æŸ“å®ƒä»¬ï¼Œæˆ‘ä»¬çœ‹ä¸åˆ°</span><br><span class="line">read  2</span><br><span class="line"></span><br><span class="line">Tick rendering with 76        # Tick é‡æ–°æ¸²æŸ“</span><br><span class="line">Tick rendering with 76</span><br><span class="line">Tick committed with 76        # æäº¤ Tick æ›´æ–°ï¼Œåˆ·æ–°åˆ°ç•Œé¢ä¸Š</span><br><span class="line">App rendering with 2 2 false  # ping è¿˜æ˜¯æ²¡æœ‰å°±ç»ªï¼Œç»§ç»­ pending</span><br><span class="line">App rendering with 2 2 false</span><br><span class="line">read  2</span><br><span class="line"></span><br><span class="line">Tick rendering with 77</span><br><span class="line">Tick rendering with 77</span><br><span class="line">Tick committed with 77</span><br><span class="line">App rendering with 2 2 false # ping</span><br><span class="line">App rendering with 2 2 false</span><br><span class="line">read  2</span><br><span class="line"></span><br><span class="line">Tick rendering with 78</span><br><span class="line">Tick rendering with 78</span><br><span class="line">Tick committed with 78</span><br><span class="line">App rendering with 2 2 false # ping</span><br><span class="line">App rendering with 2 2 false</span><br><span class="line">read  2</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Ok, Promise å·²ç»å°±ç»ªäº†ï¼Œè¿™æ—¶å€™å†ä¸€æ¬¡é‡æ–°æ¸²æŸ“ App</span><br><span class="line"><span class="meta">#</span> è¿™æ¬¡æ²¡æœ‰è§¦å‘ Suspenseï¼ŒReact ä¼šé©¬ä¸Šæäº¤ç”¨æˆ·ç•Œé¢</span><br><span class="line">App rendering with 2 2 false</span><br><span class="line">App rendering with 2 2 false</span><br><span class="line">read  2</span><br><span class="line">App committed with 2 2 false</span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šé¢çš„æ—¥å¿—ï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ™°åœ°ç†è§£ Pending ç»„ä»¶çš„æ›´æ–°è¡Œä¸º</p><p><br><br><br></p><h3 id="4ï¸âƒ£-åµŒå¥—suspense"><a href="#4ï¸âƒ£-åµŒå¥—suspense" class="headerlink" title="4ï¸âƒ£ åµŒå¥—Suspense"></a><strong>4ï¸âƒ£ åµŒå¥—Suspense</strong></h3><p>åœ¨3ï¸âƒ£çš„åŸºç¡€ä¸Šï¼Œå°† SuspenseBoundary æ”¹å†™ä¸º DoubleSuspenseBoundary, è¿™é‡Œä¼šåµŒå¥—ä¸€ä¸ª Suspense åŠ è½½ä¸€ä¸ªæ›´è€—æ—¶çš„èµ„æº:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> DoubleSuspenseBoundary = <span class="function">(<span class="params">&#123; id &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;Suspense fallback=&#123;&lt;div&gt;Loading...&lt;<span class="regexp">/div&gt;&#125;&gt;</span></span><br><span class="line"><span class="regexp">      &#123;/</span>* éœ€è¦åŠ è½½ <span class="number">2</span>s  *<span class="regexp">/&#125;</span></span><br><span class="line"><span class="regexp">      &lt;ComponentThatThrowPromise id=&#123;id&#125; timeout=&#123;2000&#125; /</span>&gt;</span><br><span class="line">      &lt;Suspense fallback=&#123;&lt;div&gt;Loading second...&lt;<span class="regexp">/div&gt;&#125;&gt;</span></span><br><span class="line"><span class="regexp">        &#123;/</span>* éœ€è¦åŠ è½½ <span class="number">4</span>s  *<span class="regexp">/&#125;</span></span><br><span class="line"><span class="regexp">        &lt;ComponentThatThrowPromise id=&#123;id + "second"&#125; timeout=&#123;4000&#125; /</span>&gt;</span><br><span class="line">      &lt;<span class="regexp">/Suspense&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>Suspense&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ä¸€ä¸‹æ•ˆæœï¼š</p><p><img src="/images/concurrent-mode/test4-1.gif" alt></p><p><br></p><p>é¦–å…ˆæ³¨æ„è§‚å¯Ÿé¦–æ¬¡æŒ‚è½½ï¼Œ<strong>Suspense é¦–æ¬¡æŒ‚è½½æ—¶ä¸ä¼šè§¦å‘å»¶è¿Ÿæäº¤</strong>ï¼Œå› æ­¤æˆ‘ä»¬é¦–å…ˆä¼šçœ‹åˆ° <code>Loading...</code>ã€æ¥ç€ç¬¬ä¸€ä¸ª <code>ComponentThatThrowPromise</code> åŠ è½½å®Œæ¯•ï¼Œæ˜¾ç¤º<code>ComponentThatThrowPromise id: 0</code> å’Œ <code>Loading second...</code>, æœ€åå®Œå…¨åŠ è½½å®Œæ¯•ã€‚</p><p>æ¥ç€æˆ‘ä»¬ç‚¹å‡»æŒ‰é’®ï¼Œè¿™æ—¶å€™ DoubleSuspenseBoundary ä¼šä¿æŒä¸åŠ¨ï¼Œç­‰å¾… 5s å(ä¹Ÿå°±æ˜¯ç¬¬äºŒä¸ª<code>ComponentThatThrowPromise</code>åŠ è½½å®Œæ¯•), æ‰æäº¤ã€‚</p><p><br></p><p>ç†æƒ³çš„æ•ˆæœæ˜¯è·Ÿé¦–æ¬¡æŒ‚è½½çš„æ—¶å€™ä¸€æ ·ï¼šåœ¨ç¬¬ä¸€ä¸ª ComponentThatThrowPromise å°±ç»ªæ—¶å°±åˆ‡æ¢è¿‡æ¥ï¼Œä¸ç”¨ç­‰å¾…ç¬¬äºŒä¸ªåŠ è½½å®Œæ¯•ã€‚</p><p>æ„Ÿè§‰æœ‰ç‚¹ä¸å¯¹ï¼Ÿæˆ‘è¿™è¿™é‡Œæƒ³äº†å¾ˆä¹…, å®˜æ–¹æ–‡æ¡£ä¸Š <a href="https://reactjs.org/docs/concurrent-mode-patterns.html#wrap-lazy-features-in-suspense" target="_blank" rel="noopener">Concurrent UI Patterns (Experimental) - Wrap Lazy Features in \&lt;Suspense></a> è¯´äº†ï¼Œç¬¬äºŒä¸ª<code>ComponentThatThrowPromise</code> å·²ç»åµŒå¥—åœ¨ <code>Suspense</code> ä¸­äº†ï¼Œç†è®ºä¸Šåº”è¯¥ä¸ä¼šé˜»å¡æäº¤ã€‚</p><p>å›åˆ°å¼€å¤´çš„ç¬¬ä¸€å¥è¯ï¼šâ€™<strong>Suspense é¦–æ¬¡æŒ‚è½½æ—¶ä¸ä¼šè§¦å‘å»¶è¿Ÿæäº¤</strong>â€˜ã€‚æˆ‘ä»¬å†è¯•ä¸€ä¸‹, ç»™ DoubleSuspenseBoundary è®¾ç½®ä¸€ä¸ªkeyï¼Œå¼ºåˆ¶è®©å®ƒé”€æ¯é‡æ–°åˆ›å»º:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// .....</span></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div className=<span class="string">"App"</span>&gt;</span><br><span class="line">      &lt;h1&gt;Hello useTransition &#123;tick&#125;&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">      &lt;div&gt;</span></span><br><span class="line"><span class="regexp">        &lt;button onClick=&#123;handleClick&#125;&gt;ADD + 1&lt;/</span>button&gt;</span><br><span class="line">        &#123;pending &amp;&amp; <span class="xml"><span class="tag">&lt;<span class="name">span</span> <span class="attr">className</span>=<span class="string">"pending"</span>&gt;</span>pending<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span>&#125;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">      &lt;Tick /</span>&gt;</span><br><span class="line">      &#123;<span class="comment">/* âš›ï¸ è¿™é‡Œæ·»åŠ keyï¼Œå¼ºåˆ¶é‡æ–°é”€æ¯åˆ›å»º */</span>&#125;</span><br><span class="line">      &lt;DoubleSuspenseBoundary id=&#123;count&#125; key=&#123;count&#125; /&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p><br></p><p>è¯•ä¸€ä¸‹æ•ˆæœ:</p><p><img src="/images/concurrent-mode/test4-2.gif" alt></p><p><br></p><p>æˆ‘ä»¬å‘ç°ï¼Œæ¯æ¬¡ç‚¹å‡»éƒ½æ˜¯<code>Loading...</code>, Pending çŠ¶æ€æ²¡æœ‰äº†! å› ä¸ºæ¯æ¬¡ <code>count</code> é€’å¢, <code>DoubleSuspenseBoundary</code> å°±ä¼šé‡æ–°åˆ›å»ºï¼Œä¸ä¼šè§¦å‘å»¶è¿Ÿæäº¤ã€‚</p><p>åŸºäºè¿™ä¸ªåŸç†ï¼Œæˆ‘ä»¬å¯ä»¥å†æ”¹é€ ä¸€ä¸‹ <code>DoubleSuspenseBoundary</code>, è¿™ä¸€æ¬¡ï¼Œæˆ‘ä»¬åªç»™åµŒå¥—çš„ <code>Suspense</code> åŠ ä¸Škeyï¼Œè®©å®ƒä»¬é‡æ–°åˆ›å»ºä¸é˜»å¡ Pending çŠ¶æ€.</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> DoubleSuspenseBoundary = <span class="function">(<span class="params">&#123; id &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;Suspense fallback=&#123;&lt;div&gt;Loading...&lt;<span class="regexp">/div&gt;&#125;&gt;</span></span><br><span class="line"><span class="regexp">      &lt;ComponentThatThrowPromise id=&#123;id&#125; timeout=&#123;2000&#125; /</span>&gt;</span><br><span class="line">      &#123;<span class="comment">/* âš›ï¸ æˆ‘ä»¬ä¸å¸Œæœ›è¿™ä¸ª Suspense é˜»å¡ pending çŠ¶æ€, ç»™å®ƒåŠ ä¸ªkey, è®©å®ƒå¼ºåˆ¶é‡æ–°åˆ›å»º */</span>&#125;</span><br><span class="line">      &lt;Suspense key=&#123;id&#125; fallback=&#123;&lt;div&gt;Loading second...&lt;<span class="regexp">/div&gt;&#125;&gt;</span></span><br><span class="line"><span class="regexp">        &lt;ComponentThatThrowPromise id=&#123;id + "second"&#125; timeout=&#123;4000&#125; /</span>&gt;</span><br><span class="line">      &lt;<span class="regexp">/Suspense&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>Suspense&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><br></p><p>æœ€åçš„æ•ˆæœ</p><p><img src="/images/concurrent-mode/test4-3.gif" alt></p><p>Itâ€™s work! ğŸ»</p><p><br><br><br></p><h3 id="5ï¸âƒ£-å¯ä»¥å’Œ-mobx-å’Œ-redux-é…åˆä½¿ç”¨å—"><a href="#5ï¸âƒ£-å¯ä»¥å’Œ-mobx-å’Œ-redux-é…åˆä½¿ç”¨å—" class="headerlink" title="5ï¸âƒ£ å¯ä»¥å’Œ Mobx å’Œ Redux é…åˆä½¿ç”¨å—?"></a><strong>5ï¸âƒ£ å¯ä»¥å’Œ Mobx å’Œ Redux é…åˆä½¿ç”¨å—?</strong></h3><p>æˆ‘ä¹Ÿä¸çŸ¥é“ï¼Œæµ‹è¯•ä¸€ä¸‹:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">mport React, &#123; useTransition, useEffect &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createStore &#125; <span class="keyword">from</span> <span class="string">"redux"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Provider, useSelector, useDispatch &#125; <span class="keyword">from</span> <span class="string">"react-redux"</span>;</span><br><span class="line"><span class="keyword">import</span> SuspenseBoundary <span class="keyword">from</span> <span class="string">"./SuspenseBoundary"</span>;</span><br><span class="line"><span class="keyword">import</span> Tick <span class="keyword">from</span> <span class="string">"./Tick"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> initialState = &#123; <span class="attr">count</span>: <span class="number">0</span>, <span class="attr">tick</span>: <span class="number">0</span> &#125;;</span><br><span class="line"><span class="keyword">const</span> ADD_TICK = <span class="string">"ADD_TICK"</span>;</span><br><span class="line"><span class="keyword">const</span> ADD_COUNT = <span class="string">"ADD_COUNT"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = createStore(<span class="function">(<span class="params">state = initialState, action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> copy = &#123; ...state &#125;;</span><br><span class="line">  <span class="keyword">if</span> (action.type === ADD_TICK) &#123;</span><br><span class="line">    copy.tick++;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    copy.count++;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> copy</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Page = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; count, tick &#125; = useSelector(<span class="function">(<span class="params">&#123; tick, count &#125;</span>) =&gt;</span> (&#123; tick, count &#125;));</span><br><span class="line">  <span class="keyword">const</span> dispatch = useDispatch();</span><br><span class="line">  <span class="keyword">const</span> [startTransition, pending] = useTransition(&#123; <span class="attr">timeoutMs</span>: <span class="number">10000</span> &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> addTick = <span class="function"><span class="params">()</span> =&gt;</span> dispatch(&#123; <span class="attr">type</span>: ADD_TICK &#125;);</span><br><span class="line">  <span class="keyword">const</span> addCount = <span class="function"><span class="params">()</span> =&gt;</span> dispatch(&#123; <span class="attr">type</span>: ADD_COUNT &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> handleClick = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    addTick();</span><br><span class="line">    startTransition(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"Start transition with count: "</span>, count);</span><br><span class="line">      addCount();</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"End transition"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`App rendering with count(<span class="subst">$&#123;count&#125;</span>) pendig(<span class="subst">$&#123;pending&#125;</span>)`</span>);</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"committed with"</span>, count, tick, pending);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div className=<span class="string">"App"</span>&gt;</span><br><span class="line">      &lt;h1&gt;Hello useTransition &#123;tick&#125;&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">      &lt;div&gt;</span></span><br><span class="line"><span class="regexp">        &lt;button onClick=&#123;handleClick&#125;&gt;ADD + 1&lt;/</span>button&gt;</span><br><span class="line">        &#123;pending &amp;&amp; <span class="xml"><span class="tag">&lt;<span class="name">span</span> <span class="attr">className</span>=<span class="string">"pending"</span>&gt;</span>pending<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span>&#125;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">      &lt;Tick /</span>&gt;</span><br><span class="line">      &lt;SuspenseBoundary id=&#123;count&#125; /&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default () =&gt; &#123;</span></span><br><span class="line"><span class="regexp">  return (</span></span><br><span class="line"><span class="regexp">    &lt;Provider store=&#123;store&#125;&gt;</span></span><br><span class="line"><span class="regexp">      &lt;Page /</span>&gt;</span><br><span class="line">    &lt;<span class="regexp">/Provider&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br></pre></td></tr></table></figure><p><br></p><p>å…ˆçœ‹ä¸€ä¸‹è¿è¡Œæ•ˆæœ:</p><p><img src="/images/concurrent-mode/test5.gif" alt></p><p><br></p><p><img src="/images/concurrent-mode/hyhs.png" alt></p><p><br></p><p>Whatâ€™s the problem? æ•´ä¸ªç•Œé¢éƒ½ <code>Pending</code> äº†, æ•´ä¸ªç•Œé¢ä¸å•å•æŒ‡ <code>App</code> è¿™é¢—å­æ ‘ï¼Œè€Œä¸” Tick ä¹Ÿä¸èµ°äº†ã€‚æ‰“å¼€æ§åˆ¶å°çœ‹åˆ°äº†ä¸€ä¸ªè­¦å‘Š:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Warning: Page triggered a user-blocking update that suspended.</span><br><span class="line"></span><br><span class="line">The fix is to split the update into multiple parts: a user-blocking update to provide immediate feedback, and another update that triggers the bulk of the changes.</span><br><span class="line">Refer to the documentation for useTransition to learn how to implement this pattern.</span><br></pre></td></tr></table></figure><p><br></p><p>å…ˆæ¥çœ‹ä¸€ä¸‹ç›®å‰Rudux å’Œ Mobx çš„Hooks API æ˜¯æ€ä¹ˆæ›´æ–°çš„ï¼Œ<strong>æœ¬è´¨ä¸Šå®ƒä»¬éƒ½é‡‡ç”¨è®¢é˜…æœºåˆ¶ï¼Œåœ¨äº‹ä»¶è§¦å‘åè¿›è¡Œå¼ºåˆ¶æ›´æ–°</strong>, åŸºæœ¬ç»“æ„å¦‚ä¸‹:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useSomeOutsideStore</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// è·å–å¤–éƒ¨ store</span></span><br><span class="line">  <span class="keyword">const</span> store = getOutsideStore()</span><br><span class="line">  <span class="keyword">const</span> [, forceUpdate] = useReducer(<span class="function"><span class="params">s</span> =&gt;</span> s + <span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// âš›ï¸ è®¢é˜…å¤–éƒ¨æ•°æ®æº</span></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> disposer = store.subscribe(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// âš›ï¸ å¼ºåˆ¶æ›´æ–°</span></span><br><span class="line">      forceUpdate()</span><br><span class="line">    ))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> disposer</span><br><span class="line">  &#125;, [store])</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬åœ¨ <code>startTransition</code> ä¸­æ›´æ–° Redux çŠ¶æ€æ—¶ï¼Œä¼šåŒæ­¥æ¥æ”¶åˆ°äº‹ä»¶ï¼Œç„¶åè°ƒç”¨ <code>forceUpdate</code>ã€‚<strong><code>forceUpdate</code> æ‰æ˜¯çœŸæ­£åœ¨ suspenseConfig ä¸Šä¸‹æ–‡ä¸­å˜æ›´çš„çŠ¶æ€</strong>ã€‚</p><p>æˆ‘ä»¬å†çœ‹ä¸€ä¸‹æ§åˆ¶å°æ—¥å¿—:</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Start transition with count 0</span><br><span class="line">End transition</span><br><span class="line">App rendering with count(1) pendig(true)  # è¿™é‡Œå‡ºé—®é¢˜äº† ğŸ”´, ä½ å¯ä»¥å’Œå®éªŒ 3ï¸âƒ£ ä¸­çš„æ—¥å¿—å¯¹æ¯”ä¸€ä¸‹</span><br><span class="line">App rendering with count(1) pendig(true)  # å®éªŒ 3ï¸âƒ£ ä¸­è¿™é‡Œçš„ count æ˜¯ 0ï¼Œè€Œè¿™é‡Œçš„countæ˜¯1ï¼Œè¯´æ˜æ²¡æœ‰ defer!</span><br><span class="line">read  1</span><br><span class="line"></span><br><span class="line">Warning: App triggered a user-blocking update that suspended.</span><br><span class="line">The fix is to split the update into multiple parts: a user-blocking update to provide immediate feedback, and another update that triggers the bulk of the changes.</span><br><span class="line">Refer to the documentation for useTransition to learn how to implement this pattern.</span><br></pre></td></tr></table></figure><p>é€šè¿‡æ—¥å¿—å¯ä»¥åŸºæœ¬ä¸Šèƒ½å¤Ÿå®šä½å‡ºé—®é¢˜ï¼Œcount æ²¡æœ‰è¢«å»¶è¿Ÿæ›´æ–°ï¼Œæ‰€ä»¥å¯¼è‡´â€™åŒæ­¥â€™è§¦å‘äº† Suspenseï¼Œè¿™ä¹Ÿæ˜¯ React è­¦å‘Šçš„åŸå› ã€‚ ç”±äº useTransition ç›®å‰è¿˜å¤„äºå®éªŒé˜¶æ®µï¼Œ<strong>å¦‚æœä¸æ˜¯ startTransition ä¸Šä¸‹æ–‡ä¸­çš„çŠ¶æ€æ›´æ–°å¯¼è‡´çš„Suspenseï¼Œè¡Œä¸ºè¿˜æ˜¯æœªç¡®å®šçš„</strong>ã€‚</p><p>ä½†æ˜¯æœ€ç»ˆçš„è¡Œä¸ºæœ‰ç‚¹ç„å­¦ï¼Œå®ƒä¼šå¯¼è‡´æ•´ä¸ªåº”ç”¨è¢«â€˜Pendingâ€™ï¼Œæ‰€æœ‰çŠ¶æ€æ›´æ–°éƒ½ä¸ä¼šè¢«æäº¤ã€‚è¿™å—æˆ‘ä¹Ÿå¾ˆç–‘æƒ‘ï¼Œæ²¡æœ‰ç²¾åŠ›æ·±ç©¶ä¸‹å»ï¼Œåªèƒ½ç­‰å¾…åç»­å®˜æ–¹çš„æ›´æ–°ï¼Œè¯»è€…ä¹Ÿå¯ä»¥å»ç¢ç£¨ç¢ç£¨ã€‚</p><p>å› æ­¤ï¼Œæš‚æ—¶ä¸æ¨èå°†ä¼šè§¦å‘ Suspense çš„çŠ¶æ€æ”¾ç½®åœ¨ Redux æˆ–è€… Mobx ä¸­ã€‚</p><p><br><br><br></p><p>æœ€åå†é‡ç”³ä¸€ä¸‹ï¼Œ <code>useTransition</code> è¦è¿›å…¥ <code>Pending</code> çŠ¶æ€è¦ç¬¦åˆä»¥ä¸‹å‡ ä¸ªæ¡ä»¶:</p><ul><li>æœ€å¥½ä½¿ç”¨ React æœ¬èº«çš„çŠ¶æ€æœºåˆ¶è¿›è¡Œæ›´æ–°, å¦‚ Hooks æˆ– setState, å½“å‰ä¸è¦ä½¿ç”¨ Mobx å’Œ Redux</li><li>è¿™äº›æ›´æ–°ä¼šè§¦å‘ Suspenseã€‚</li><li>æ›´æ–°å¿…é¡»åœ¨<code>startTransition</code>ä½œç”¨åŸŸä¸‹, è¿™äº›æ›´æ–°ä¼šå…³è” <code>suspenseConfig</code></li><li>è¿™äº›æ›´æ–°è§¦å‘çš„é‡æ–°æ¸²æŸ“ä¸­, å¿…é¡»è§¦å‘è‡³å°‘ä¸€ä¸ª <code>Suspense</code></li><li>è¿™ä¸ª <code>Suspense</code> ä¸æ˜¯é¦–æ¬¡æŒ‚è½½</li></ul><p><br><br><br></p><h2 id="é‚£-usedeferedvalue-å‘¢ï¼Ÿ"><a href="#é‚£-usedeferedvalue-å‘¢ï¼Ÿ" class="headerlink" title="é‚£ useDeferedValue å‘¢ï¼Ÿ"></a>é‚£ useDeferedValue å‘¢ï¼Ÿ</h2><p>å¦‚æœä½ ç†è§£äº†ä¸Šé¢çš„å†…å®¹, é‚£ä¹ˆ <code>useDeferedValue</code> å°±å¥½åŠäº†ï¼Œå®ƒä¸è¿‡æ˜¯ useTransition çš„ç®€å•å°è£…ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useDeferredValue</span>&lt;<span class="title">T</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  value: T,</span></span></span><br><span class="line"><span class="function"><span class="params">  config: TimeoutConfig | void | null,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">T</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [prevValue, setValue] = useState(value);</span><br><span class="line">  <span class="keyword">const</span> [startTransition] = useTransition(config)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// âš›ï¸ useDeferredValue åªä¸è¿‡æ˜¯ç›‘å¬ value çš„å˜åŒ–ï¼Œ</span></span><br><span class="line">  <span class="comment">// ç„¶ååœ¨ startTransition ä¸­æ›´æ–°å®ƒã€‚ä»è€Œå®ç°å»¶è¿Ÿæ›´æ–°çš„æ•ˆæœ</span></span><br><span class="line">  useEffect(</span><br><span class="line">    () =&gt; &#123;</span><br><span class="line">      startTransition(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        setValue(value);</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    [value, config],</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> prevValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p><code>useDeferredValue</code> åªä¸è¿‡æ˜¯ä½¿ç”¨ useEffect ç›‘å¬ <code>value</code> çš„å˜åŒ–ï¼Œ ç„¶ååœ¨ startTransition ä¸­æ›´æ–°å®ƒã€‚ä»è€Œå®ç°å»¶è¿Ÿæ›´æ–°çš„æ•ˆæœã€‚ä¸Šæ–‡å®éªŒ 1ï¸âƒ£ å·²ç»ä»‹ç»è¿‡è¿è¡Œæ•ˆæœï¼ŒReact ä¼šé™ä½ startTransition ä¸­æ›´æ–°çš„ä¼˜å…ˆçº§ï¼Œ è¿™æ„å‘³ç€åœ¨äº‹åŠ¡ç¹å¿™æ—¶å®ƒä»¬ä¼šå»¶åæ‰§è¡Œã€‚</p><p><br><br><br></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æˆ‘ä»¬ä¸€å¼€å§‹ä»‹ç»äº† useTransition çš„åº”ç”¨åœºæ™¯, è®©é¡µé¢å®ç° <strong><code>Pending</code> -&gt; <code>Skeleton</code> -&gt; <code>Complete</code></strong> çš„æ›´æ–°è·¯å¾„, ç”¨æˆ·åœ¨åˆ‡æ¢é¡µé¢æ—¶å¯ä»¥åœç•™åœ¨å½“å‰é¡µé¢ï¼Œè®©é¡µé¢ä¿æŒå“åº”ã€‚ ç›¸æ¯”å±•ç¤ºä¸€ä¸ªæ— ç”¨çš„ç©ºç™½é¡µé¢æˆ–è€…åŠ è½½çŠ¶æ€ï¼Œè¿™ç§ç”¨æˆ·ä½“éªŒæ›´åŠ å‹å¥½ã€‚</p><p>å½“ç„¶ä¸Šè¿°çš„å‡è®¾æ¡ä»¶æ—¶æ•°æ®åŠ è½½å¾ˆæ…¢ï¼Œå¦‚æœæ•°æ®åŠ è½½å¾ˆå¿«ï¼Œåˆ©ç”¨ useTransition æœºåˆ¶ï¼Œæˆ‘ä»¬å®ç°ä¸è®©ç”¨æˆ·çœ‹åˆ°åŠ è½½çŠ¶æ€ï¼Œè¿™æ ·èƒ½é¿å…é¡µé¢é¡µé¢æŠ–åŠ¨å’Œé—ªçƒ, çœ‹èµ·æ¥åƒæ²¡æœ‰åŠ è½½çš„è¿‡ç¨‹ã€‚</p><p>æ¥ç€æˆ‘ä»¬ç®€å•ä»‹ç»äº† useTransition çš„è¿è¡ŒåŸç†å’Œæ¡ä»¶ã€‚ å¦‚æœ startTransition ä¸­çš„çŠ¶æ€æ›´æ–°è§¦å‘äº† Suspenseï¼Œé‚£ä¹ˆå¯¹åº”çš„ç»„ä»¶å°±ä¼šè¿›å…¥ Pending çŠ¶æ€ã€‚åœ¨ Pending çŠ¶æ€æœŸé—´ï¼ŒstartTransitionä¸­è®¾ç½®å˜æ›´éƒ½ä¼šè¢«å»¶è¿Ÿæäº¤ã€‚ Pending çŠ¶æ€ä¼šæŒç»­åˆ° Suspense å°±ç»ªæˆ–è€…è¶…æ—¶ã€‚</p><p>useTransition å¿…é¡»å’Œ Suspense é…åˆä½¿ç”¨æ‰èƒ½æ–½å±•é­”æ³•ã€‚è¿˜æœ‰ä¸€ä¸ªç”¨æˆ·åœºæ™¯æ˜¯æˆ‘ä»¬å¯ä»¥å°†ä½ä¼˜å…ˆçº§çš„æ›´æ–°æ”¾ç½®åˆ° startTransition ä¸­ã€‚æ¯”å¦‚æŸä¸ªæ›´æ–°çš„æˆæœ¬å¾ˆé«˜ï¼Œå°±å¯ä»¥é€‰æ‹©æ”¾åˆ° startTransition ä¸­, è¿™äº›æ›´æ–°ä¼šè®©ä½é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼Œå¦å¤–ä¼š React å»¶è¿Ÿæˆ–åˆå¹¶ä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„æ›´æ–°ï¼Œè®©é¡µé¢ä¿æŒå“åº”ã€‚</p><p><br><br><br></p><p><strong>Okï¼Œå…³äº Concurrent æ¨¡å¼çš„ä»‹ç»å°±å…ˆå‘Šä¸€æ®µè½äº†, è¿™æ˜¯ä¸­æ–‡çš„ç¬¬ä¸€æ‰‹èµ„æ–™ã€‚å†™è¿™äº›æ–‡ç« è€—æ‰äº†æˆ‘å¤§éƒ¨åˆ†çš„ä¸šä½™æ—¶é—´ï¼Œå¦‚æœä½ å–œæ¬¢æˆ‘çš„æ–‡ç« ï¼Œè¯·å¤šç»™æˆ‘ç‚¹èµå’Œåé¦ˆã€‚</strong></p><p><br><br><br></p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li><a href="https://reactjs.org/docs/concurrent-mode-patterns.html" target="_blank" rel="noopener">Concurrent UI Patterns</a></li><li><a href="https://github.com/facebook/react/pull/15593" target="_blank" rel="noopener">Add withSuspenseConfig API</a></li></ul><p><br></p><p><img src="/images/sponsor.jpg" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;ä¸Šç¯‡æ–‡ç« ä»‹ç»äº† &lt;a href=&quot;https://juejin.im/post/5db65d87518825648f2ef899&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;&lt;code&gt;Suspense&lt;/code&gt;&lt;/a&gt;, é‚£ä¹ˆè¿™ç¯‡æ–‡ç« å°±è®²è®²å®ƒçš„å¥½æ­
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://bobi.ink/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>React Concurrent æ¨¡å¼æŠ¢å…ˆé¢„è§ˆä¸Šç¯‡: Suspense the world</title>
    <link href="https://bobi.ink/2019/10/26/concurrent-mode-suspense/"/>
    <id>https://bobi.ink/2019/10/26/concurrent-mode-suspense/</id>
    <published>2019-10-25T16:00:00.000Z</published>
    <updated>2019-10-31T04:46:11.446Z</updated>
    
    <content type="html"><![CDATA[<p><strong>2019.10.24</strong>, åœ¨ <a href="https://www.youtube.com/channel/UCz5vTaEhvh7dOHEyd1efcaQ" target="_blank" rel="noopener">React Conf 2019</a> é¦–æ—¥ï¼Œ React å®˜æ–¹æ­£å¼å‘å¸ƒäº†å…³äº <code>Concurrent</code> æ¨¡å¼çš„ç¬¬ä¸€ä¸ªæ—©æœŸç¤¾åŒº<a href="https://reactjs.org/docs/concurrent-mode-intro.html" target="_blank" rel="noopener">é¢„è§ˆæ–‡æ¡£</a>, æ­£å¼å’Œ React çš„å¤§ä¼—å¼€å‘è€…è§é¢, ä»¤äººå…´å¥‹ã€‚</p><p>è·Ÿå»å¹´çš„ React Hooks ä¸€æ ·, å°½ç®¡ Concurrent è¿˜æ˜¯<a href="https://reactjs.org/blog/2019/10/22/react-release-channels.html#experimental-channel" target="_blank" rel="noopener">å®éªŒæ€§</a>çš„, ç›¸ä¿¡è¿™æ¬¡ä¸ä¼šç­‰å¤ªä¹…â€¦</p><p><br></p><p><strong>è¿™ä¸ªå¤§æ‹›æ†‹äº†å››å¹´å¤š</strong></p><p><img src="/images/concurrent-mode/release.png" alt></p><p><br></p><p><strong>å¦‚æœ React Hooks ç›®çš„æ˜¯æé«˜å¼€å‘ä½“éªŒï¼Œé‚£ä¹ˆ Concurrent æ¨¡å¼åˆ™ä¸“æ³¨äºæå‡ç”¨æˆ·ä½“éªŒ</strong>ï¼Œè¡¨é¢ä¸Šå®ƒå¯¹æˆ‘ä»¬çš„å¼€å‘çš„å¯èƒ½å½±å“ä¸å¤§ï¼ŒReact å†…éƒ¨å·²ç»å˜äº†å¥½å‡ é‡å¤©ã€‚</p><p>è¿™ç³»åˆ—æ–‡ç« ä¸»è¦æ¥æºäºå®˜æ–¹çš„<a href="https://reactjs.org/docs/concurrent-mode-intro.html" target="_blank" rel="noopener">é¢„è§ˆæ–‡æ¡£</a>, ä¸“é—¨ç»™ React å°é²œè€…å‡†å¤‡ã€‚</p><p>è¿™ä¸ªæœˆ Vue 3.0 æºç å‘å¸ƒï¼Œæ˜é‡‘ç›¸å…³æ–‡ç« åƒäº•å–·ä¸€æ ·ï¼Œæ²¡ç†ç”± React è¿™ä¹ˆâ€™å¤§æ–°é—»â€™(å°½ç®¡è¿™ä¸ªæ–°é—»3å¹´å‰å¤§å®¶å°±çŸ¥é“äº†)â€¦ æˆ‘æ¥å¸¦ä¸ªå¤´å§ã€‚</p><p><br></p><p><strong>æ–‡ç« å†…å®¹æ¡†æ¶</strong></p><!-- TOC --><ul><li><a href="#ä»€ä¹ˆæ˜¯-concurrent-æ¨¡å¼">ä»€ä¹ˆæ˜¯ Concurrent æ¨¡å¼?</a></li><li><a href="#å¯ç”¨-concurrent-æ¨¡å¼">å¯ç”¨ Concurrent æ¨¡å¼</a></li><li><a href="#ä»€ä¹ˆæ˜¯-suspense">ä»€ä¹ˆæ˜¯ Suspense?</a></li><li><a href="#suspense-çš„å®ç°åŸç†">Suspense çš„å®ç°åŸç†</a></li><li><a href="#ç¼“å­˜-suspense-çš„å¼‚æ­¥æ“ä½œçŠ¶æ€">ç¼“å­˜ Suspense çš„å¼‚æ­¥æ“ä½œçŠ¶æ€</a><ul><li><a href="#ä½¿ç”¨-context-api">ä½¿ç”¨ Context API</a></li><li><a href="#å°†ç¼“å­˜çŠ¶æ€æå–åˆ°çˆ¶çº§">å°†ç¼“å­˜çŠ¶æ€æå–åˆ°çˆ¶çº§</a></li></ul></li><li><a href="#å¹¶å‘å‘èµ·è¯·æ±‚">å¹¶å‘å‘èµ·è¯·æ±‚</a></li><li><a href="#å¤„ç†ç«æ€">å¤„ç†ç«æ€</a></li><li><a href="#é”™è¯¯å¤„ç†">é”™è¯¯å¤„ç†</a></li><li><a href="#suspense-ç¼–æ’">Suspense ç¼–æ’</a></li><li><a href="#æ€»ç»“">æ€»ç»“</a></li><li><a href="#å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</a></li></ul><!-- /TOC --><p><br><br><br></p><h2 id="ä»€ä¹ˆæ˜¯-concurrent-æ¨¡å¼"><a href="#ä»€ä¹ˆæ˜¯-concurrent-æ¨¡å¼" class="headerlink" title="ä»€ä¹ˆæ˜¯ Concurrent æ¨¡å¼?"></a>ä»€ä¹ˆæ˜¯ Concurrent æ¨¡å¼?</h2><p><img src="/images/concurrent-mode/cpu-vs-io.jpg" alt></p><p><strong>è¿™æ˜¯ä¸€ä¸ªç‰¹æ€§é›†åˆï¼Œå¯ä»¥è®©ä½ çš„React åº”ç”¨ä¿æŒå“åº”ï¼Œå¯ä»¥æ ¹æ®ç”¨æˆ·çš„è®¾å¤‡èƒ½åŠ›å’Œç½‘ç»œæƒ…å†µä¼˜é›…åœ°è°ƒæ•´</strong>ã€‚ è¿™ä¸ªç‰¹æ€§é›†åˆï¼Œå®ƒåŒ…å«<strong>ä¸¤ä¸ªæ–¹å‘</strong>çš„ä¼˜åŒ–:</p><p><strong>1ï¸âƒ£ CPU å¯†é›†å‹(CPU-bound)</strong></p><p>CPU å¯†é›†å‹æŒ‡æ˜¯ Reconcilation(åè°ƒæˆ–è€…Diff) çš„ä¼˜åŒ–. åœ¨Concurrent æ¨¡å¼ä¸‹é¢ï¼ŒReconcilation å¯ä»¥è¢«ä¸­æ–­, è®©ä½ç»™é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼Œè®©åº”ç”¨ä¿æŒå“åº”.</p><p><strong>ä¸Šä¸€å‘¨ï¼Œæˆ‘æŠ¢åœ¨ React Conf 2019 ä¹‹å‰å‘å¸ƒäº†ä¸€ç¯‡æ–‡ç« <a href="https://juejin.im/post/5dadc6045188255a270a0f85" target="_blank" rel="noopener">ã€ŠğŸ”¥è¿™å¯èƒ½æ˜¯æœ€é€šä¿—çš„ React Fiber(æ—¶é—´åˆ†ç‰‡) æ‰“å¼€æ–¹å¼ã€‹</a> ğŸ¤“ï¼Œä½ æƒ³äº†è§£ Concurrent æ¨¡å¼, å¼ºçƒˆå»ºè®®ä»è¿™ç¯‡æ–‡ç« å¼€å§‹ï¼</strong></p><p>CPU å¯†é›†å‹çš„ä¼˜åŒ–å¯¹ç°æœ‰çš„ä»£ç ä¿æŒå…¼å®¹ï¼Œå‡ ä¹æ²¡æœ‰æš´éœ²æ–°çš„APIï¼Œä¸»è¦çš„å½±å“æ˜¯åºŸå¼ƒäº†ä¸€äº›ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œè¿™ä¸ªæ˜¯ä¼—æ‰€å‘¨çŸ¥çš„ã€‚</p><p><br></p><p><strong>2ï¸âƒ£ I/O å¯†é›†å‹(I/O-bound)</strong></p><p>ä¸»è¦ä¼˜åŒ–äº† React å¯¹å¼‚æ­¥çš„å¤„ç†ã€‚ä¸»è¦çš„æ­¦å™¨æ˜¯ <code>Suspense</code> ä»¥åŠ <a href="https://reactjs.org/docs/concurrent-mode-patterns.html" target="_blank" rel="noopener"><code>useTransition</code></a>:</p><ul><li><code>Suspense</code> - æ–°çš„å¼‚æ­¥æ•°æ®å¤„ç†æ–¹å¼ã€‚</li><li><code>useTransition</code> - æä¾›äº†ä¸€ç§é¢„æ¸²æŸ“çš„æœºåˆ¶ï¼ŒReact å¯ä»¥åœ¨â€™å¦ä¸€ä¸ªåˆ†æ”¯â€™ä¸­<strong>é¢„æ¸²æŸ“</strong>ï¼Œç­‰å¾…æ•°æ®åˆ°è¾¾ï¼Œç„¶åä¸€æ¬¡æ€§æ¸²æŸ“å‡ºæ¥ï¼Œå‡å°‘ä¸­é—´çš„åŠ è½½çŠ¶æ€çš„æ˜¾ç¤ºå’Œé¡µé¢æŠ–åŠ¨/é—ªçƒã€‚</li></ul><p><br></p><p>è¿™ç¯‡æ–‡ç« æˆ‘å°±ä¸å†æ·±å…¥è§£é‡Š Concurrent æ¨¡å¼æ˜¯ä»€ä¹ˆäº†ï¼Œ<strong>æœ¬æ–‡ä¼šä»‹ç» Suspenseï¼Œè®¡åˆ’ä¸‹ä¸€ç¯‡æ–‡ç« ä¼šä»‹ç» useTranstion</strong>ï¼Œæ•¬è¯·æœŸå¾…ã€‚</p><p><br><br><br></p><h2 id="å¯ç”¨-concurrent-æ¨¡å¼"><a href="#å¯ç”¨-concurrent-æ¨¡å¼" class="headerlink" title="å¯ç”¨ Concurrent æ¨¡å¼"></a>å¯ç”¨ Concurrent æ¨¡å¼</h2><p>Concurrent æ¨¡å¼ç›®å‰è¿˜æ˜¯å®éªŒæ€§çš„ï¼Œä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ¥å®‰è£…å®éªŒç‰ˆæœ¬:</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">npm install react@experimental react-dom@experimental</span><br><span class="line"><span class="meta">#</span> or</span><br><span class="line">yarn add react@experimental react-dom@experimental</span><br></pre></td></tr></table></figure><p>ä¸Šæ–‡è¯´äº†ï¼Œè¿™æ˜¯ä¸ºå°é²œè€…å‡†å¤‡çš„ï¼Œå°½ç®¡ API åº”è¯¥ä¸ä¼šæœ‰å¤ªå¤§çš„å˜åŠ¨, ä¸è¦ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚</p><p><br></p><p>å¼€å§‹ Concurrent æ¨¡å¼:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span>;</span><br><span class="line"></span><br><span class="line">ReactDOM.createRoot(</span><br><span class="line">  <span class="built_in">document</span>.getElementById(<span class="string">'root'</span>)</span><br><span class="line">).render(<span class="xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span>);</span></span><br></pre></td></tr></table></figure><p><br></p><p>å¦å¤–ä¸€ä¸ªè¦æ³¨æ„çš„æ˜¯ï¼Œå¼€å¯Concurrent æ¨¡å¼åï¼Œä¹‹å‰ deprecated çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•å°±å½»åº•ä¸èƒ½ç”¨äº†ï¼Œç¡®ä¿ä½ çš„ä»£ç å·²ç»è¿ç§»ã€‚</p><p><br><br><br></p><h2 id="ä»€ä¹ˆæ˜¯-suspense"><a href="#ä»€ä¹ˆæ˜¯-suspense" class="headerlink" title="ä»€ä¹ˆæ˜¯ Suspense?"></a>ä»€ä¹ˆæ˜¯ Suspense?</h2><p>Suspense è¿™ä¸ªå¤§å®¶åº”è¯¥éƒ½ä¸é™Œç”Ÿï¼Œåœ¨ v16.5 å°±å·²ç»æœ‰äº†è¿™ä¸ª <code>Suspense</code> è¿™ä¸ªAPI, åªä¸è¿‡é€šå¸¸åˆ©ç”¨å®ƒé…åˆ <code>React.lazy</code> å®ç°ä»£ç åˆ†éš”:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> OtherComponent = React.lazy(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="string">'./OtherComponent'</span>));</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyComponent</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;Suspense fallback=&#123;&lt;div&gt;Loading...&lt;<span class="regexp">/div&gt;&#125;&gt;</span></span><br><span class="line"><span class="regexp">        &lt;OtherComponent /</span>&gt;</span><br><span class="line">      &lt;<span class="regexp">/Suspense&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>React.lazy è¿™æ˜¯ä¸€æ¬¡å°å°çš„å°è¯•, Suspense è¿˜æœ‰å¤§ç”¨ã€‚ </p><p>å¦‚æœå°†Suspense ç¿»è¯‘ä¸ºä¸­æ–‡çš„è¯æ˜¯<code>ç­‰å¾…</code>ã€<code>æ‚¬å‚</code>ã€<code>æ‚¬åœ</code>çš„æ„æ€ã€‚<strong>Reactç»™å‡ºäº†ä¸€ä¸ªæ›´è§„èŒƒçš„å®šä¹‰</strong>ï¼š</p><p><strong>Suspense ä¸æ˜¯ä¸€ä¸ªâ€˜æ•°æ®è·å–åº“â€™, è€Œæ˜¯ä¸€ç§æä¾›ç»™â€˜æ•°æ®è·å–åº“â€™çš„<code>æœºåˆ¶</code>ï¼Œæ•°æ®è·å–åº“é€šè¿‡è¿™ç§æœºåˆ¶å‘Šè¯‰ React æ•°æ®è¿˜æ²¡æœ‰å‡†å¤‡å¥½ï¼Œç„¶å Reactå°±ä¼šç­‰å¾…å®ƒå®Œæˆåï¼Œæ‰ç»§ç»­æ›´æ–° UI</strong>ã€‚ ç®€å•æ€»ç»“ä¸€ä¸‹ Suspense æ˜¯ React æä¾›çš„ä¸€ç§å¼‚æ­¥å¤„ç†çš„æœºåˆ¶, å®ƒä¸æ˜¯ä¸€ä¸ªå…·ä½“çš„æ•°æ®è¯·æ±‚åº“ã€‚<strong>å®ƒæ˜¯React æä¾›çš„åŸç”Ÿçš„ç»„ä»¶å¼‚æ­¥è°ƒç”¨åŸè¯­</strong>ã€‚å®ƒæ˜¯ Concurrent æ¨¡å¼ç‰¹æ€§é›†åˆä¸­çš„é‡è¦è§’è‰²ã€‚</p><p><br></p><p>ç°åœ¨, æˆ‘ä»¬å¯ä»¥æ›´é…·åœ°ä½¿ç”¨ Suspenseï¼Œç›¸ä¿¡æˆ‘ï¼Œé©¬ä¸Šå®ƒå°±ä¼šæˆä¸ºä½ æ‰‹ä¸­çš„åˆ©å‰‘ã€‚ æœ‰äº†å®ƒä½ å¯ä»¥è¿™æ ·è¯·æ±‚è¿œç¨‹æ•°æ®:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Posts</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> posts = useQuery(GET_MY_POSTS)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (<span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"posts"</span>&gt;</span></span></span><br><span class="line">    &#123;posts.map(i =&gt; &lt;Post key=&#123;i.id&#125; value=&#123;i&#125;/&gt;)&#125;</span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span>)</span></span><br><span class="line"><span class="xml">&#125;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">function App() &#123;</span></span><br><span class="line">  return (&lt;div className="app"&gt;</span><br><span class="line">    &lt;Suspense fallback=&#123;&lt;Loader&gt;Posts Loading...&lt;/Loader&gt;&#125;&gt;</span><br><span class="line">      &lt;Posts /&gt;</span><br><span class="line">    &lt;/Suspense&gt;</span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span>)</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure><p><br></p><p>åŠ è½½ä¾èµ–è„šæœ¬:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyMap</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  useImportScripts(<span class="string">'//api.map.baidu.com/api?v=2.0&amp;ak=æ‚¨çš„å¯†é’¥'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (<span class="xml"><span class="tag">&lt;<span class="name">BDMap</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">&#125;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">function App() &#123;</span></span><br><span class="line">  return (&lt;div className="app"&gt;</span><br><span class="line">    &lt;Suspense fallback=&#123;&lt;Loader&gt;åœ°å›¾åŠ è½½ä¸­...&lt;/Loader&gt;&#125;&gt;</span><br><span class="line">      &lt;MyMap /&gt;</span><br><span class="line">    &lt;/Suspense&gt;</span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span>)</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure><p><br></p><p>ä»”ç»†è§‚å¯Ÿä¸Šé¢çš„ä»£ç ï¼Œæœ‰ä¸¤ä¸ªç‰¹ç‚¹ï¼š</p><ul><li>1ï¸âƒ£ æˆ‘ä»¬éœ€è¦ <code>Suspense</code> æ¥åŒ…è£¹è¿™äº›åŒ…å«å¼‚æ­¥æ“ä½œçš„ç»„ä»¶ï¼Œå¹¶ç»™å®ƒä»¬æä¾›<code>å›é€€(fallback)</code>ã€‚åœ¨å¼‚æ­¥è¯·æ±‚æœŸé—´ï¼Œä¼šæ˜¾ç¤ºè¿™ä¸ªå›é€€ã€‚</li><li>2ï¸âƒ£ ä¸Šé¢çš„ä»£ç è·å–å¼‚æ­¥èµ„æºå°±è·ŸåŒæ­¥è°ƒç”¨ä¼¼çš„ã€‚æ²¡é”™ï¼Œæœ‰äº† Suspense,  æˆ‘ä»¬å¯ä»¥å’Œ<code>async/await</code>æˆ–è€…<code>Generator</code> ä¸€æ ·ï¼Œç”¨â€™åŒæ­¥â€˜çš„ä»£ç é£æ ¼æ¥å¤„ç†å¼‚æ­¥è¯·æ±‚</li></ul><p><br></p><p>å¾ˆç¥å¥‡å¯¹ä¸å¯¹ï¼ŸReact æ˜¯æ€ä¹ˆåšåˆ°çš„ï¼Ÿ</p><p><br><br><br></p><h2 id="suspense-çš„å®ç°åŸç†"><a href="#suspense-çš„å®ç°åŸç†" class="headerlink" title="Suspense çš„å®ç°åŸç†"></a>Suspense çš„å®ç°åŸç†</h2><p>æ—©å‰å°±<a href="https://zhuanlan.zhihu.com/p/34210780" target="_blank" rel="noopener">æœ‰äººå‰–æè¿‡ <code>Suspense</code> çš„å®ç°</a>ï¼Œå®ƒåˆ©ç”¨äº† React çš„ <code>ErrorBoundary</code> ç±»ä¼¼çš„æœºåˆ¶æ¥å®ç°, è„‘æ´å¾ˆå¤§ã€‚</p><p>ğŸ¤” å—¯â€¦ å¦‚æœæ˜¯ç”¨ <code>ErrorBoundary</code> çš„è¯ï¼ŒErrorBoundary å¯ä»¥ç”¨æ¥æ•è·ä¸‹çº§ç»„ä»¶çš„å¼‚å¸¸ï¼Œæˆ‘ä»¬åœ¨åšå¼‚æ­¥æ“ä½œæ—¶ï¼Œå¯ä»¥æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œä¸­æ–­æ¸²æŸ“å·¥ä½œï¼Œå½“æˆ‘ä»¬å®Œæˆå¼‚æ­¥æ“ä½œæ—¶ï¼Œå†å‘Šè¯‰Reactï¼Œæˆ‘ä»¬å·²ç»å‡†å¤‡å¥½äº†ï¼Œè¯·ç»§ç»­æ¸²æŸ“â€¦</p><p>ğŸ¤­è¿™å°±èƒ½è§£é‡Šï¼Œä¸ºä»€ä¹ˆæ²¡æœ‰ä½¿ç”¨ async/await å’Œ Generatorï¼Œå´å¯ä»¥ä½¿ç”¨ç”¨åŒæ­¥çš„é£æ ¼æ¥å¤„ç†å¼‚æ­¥æ“ä½œ, throw æ˜¯å¯ä»¥ä¸­æ–­ä»£ç æ‰§è¡Œçš„â€¦</p><p>ğŸ¤” ä¸è¿‡è¿™ä¸ªâ€™å¼‚å¸¸â€˜åº”è¯¥è·Ÿæ™®é€šçš„å¼‚å¸¸åŒºåˆ†å¼€æ¥ï¼ŒåŒæ—¶å®ƒåº”è¯¥å¯ä»¥é€šçŸ¥ ErrorBoundary å¼‚æ­¥æ“ä½œå·²ç»å°±ç»ªäº†ï¼Œè®©å®ƒç»§ç»­æ¸²æŸ“å­èŠ‚ç‚¹â€¦</p><p><br></p><p>æˆ‘æƒ³æµç¨‹åº”è¯¥æ˜¯è¿™æ ·çš„:</p><p><img src="/images/concurrent-mode/suspense.png" alt></p><p><br></p><p>å…¶å®ï¼Œç¬¦åˆè¯¥åœºæ™¯çš„ã€ç°æˆçš„æœ€å¥½çš„â€™å¼‚å¸¸å¯¹è±¡â€™æ˜¯ Promiseã€‚ é‚£å°±æ’¸èµ·è¢–å­ï¼Œå®ç°ä¸€ä¸ª:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> interface SuspenseProps &#123;</span><br><span class="line">  fallback: React.ReactNode</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface SuspenseState &#123;</span><br><span class="line">  pending: boolean</span><br><span class="line">  error?: any</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Suspense</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span>&lt;<span class="title">SuspenseProps</span>, <span class="title">SuspenseState</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">// âš›ï¸ é¦–å…ˆï¼Œè®°å½•æ˜¯å¦å¤„äºæŒ‚è½½çŠ¶æ€ï¼Œå› ä¸ºæˆ‘ä»¬ä¸çŸ¥é“å¼‚æ­¥æ“ä½œä»€ä¹ˆæ—¶å€™å®Œæˆï¼Œå¯èƒ½åœ¨å¸è½½ä¹‹å</span></span><br><span class="line">  <span class="comment">// ç»„ä»¶å¸è½½åå°±ä¸èƒ½è°ƒç”¨ setState äº†</span></span><br><span class="line">  private mounted = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç»„ä»¶çŠ¶æ€</span></span><br><span class="line">  public state: SuspenseState = &#123;</span><br><span class="line">    <span class="comment">// âš›ï¸ è¡¨ç¤ºç°åœ¨æ­£é˜»å¡åœ¨å¼‚æ­¥æ“ä½œä¸Š</span></span><br><span class="line">    pending: <span class="literal">false</span>,</span><br><span class="line">    <span class="comment">// âš›ï¸ è¡¨ç¤ºå¼‚æ­¥æ“ä½œå‡ºç°äº†é—®é¢˜</span></span><br><span class="line">    error: <span class="literal">undefined</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public componentDidMount() &#123;</span><br><span class="line">    <span class="keyword">this</span>.mounted = <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public componentWillUnmount() &#123;</span><br><span class="line">    <span class="keyword">this</span>.mounted = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// âš›ï¸ ä½¿ç”¨ Error Boundary æœºåˆ¶æ•è·ä¸‹çº§å¼‚å¸¸</span></span><br><span class="line">  public componentDidCatch(err: any) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.mounted) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// âš›ï¸ åˆ¤æ–­æ˜¯å¦æ˜¯ Promise, å¦‚æœä¸æ˜¯åˆ™å‘ä¸ŠæŠ›</span></span><br><span class="line">    <span class="keyword">if</span> (isPromise(err)) &#123;</span><br><span class="line">      <span class="comment">// è®¾ç½®ä¸º pending çŠ¶æ€</span></span><br><span class="line">      <span class="keyword">this</span>.setState(&#123; <span class="attr">pending</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">      err.then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// âš›ï¸ å¼‚æ­¥æ‰§è¡ŒæˆåŠŸ, å…³é—­pending çŠ¶æ€, è§¦å‘é‡æ–°æ¸²æŸ“</span></span><br><span class="line">        <span class="keyword">this</span>.setState(&#123; <span class="attr">pending</span>: <span class="literal">false</span> &#125;)</span><br><span class="line">      &#125;).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// âš›ï¸ å¼‚æ­¥æ‰§è¡Œå¤±è´¥, æˆ‘ä»¬éœ€è¦å¦¥å–„å¤„ç†è¯¥å¼‚å¸¸ï¼Œå°†å®ƒæŠ›ç»™ React</span></span><br><span class="line">        <span class="comment">// å› ä¸ºå¤„äºå¼‚æ­¥å›è°ƒä¸­ï¼Œåœ¨è¿™é‡ŒæŠ›å‡ºå¼‚å¸¸æ— æ³•è¢« React æ•è·ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œå…ˆè®°å½•ä¸‹æ¥</span></span><br><span class="line">        <span class="keyword">this</span>.setState(&#123; <span class="attr">error</span>: err || <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Suspense Error'</span>)&#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> err</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// âš›ï¸ åœ¨è¿™é‡Œå°† å¼‚å¸¸ æŠ›ç»™ React</span></span><br><span class="line">  public componentDidUpdate() &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.state.pending &amp;&amp; <span class="keyword">this</span>.state.error) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">this</span>.state.error</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public render() &#123;</span><br><span class="line">    <span class="comment">// âš›ï¸ åœ¨pending çŠ¶æ€æ—¶æ¸²æŸ“ fallback</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.state.pending ? <span class="keyword">this</span>.props.fallback : <span class="keyword">this</span>.props.children</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>å®é™…ä¸Šï¼ŒSuspenseä¸ä¼šå»æ•è·å¼‚æ­¥æ“ä½œçš„å¼‚å¸¸ï¼Œä¹Ÿå°±æ˜¯thenå’Œcatchåªæ˜¯å°†pendingè®¾ç½®ä¸ºfalseã€‚ç”±ä¸‹çº§ç»„ä»¶è‡ªå·±é€‰æ‹©å¦‚ä½•å»å¤„ç†å¼‚å¸¸ã€‚è¿™ä¸è¿‡è¿™é‡Œä¸ºäº†æ–¹ä¾¿è®©å¤§å®¶ç†è§£ Suspense çš„å¤–åœ¨è¡Œä¸ºï¼Œå°†å¼‚å¸¸å¤„ç†æåˆ°äº†è¿™é‡Œã€‚</p></blockquote><p><br></p><p>âš ï¸ æ³¨æ„ï¼Œ<strong>ä»¥ä¸Šä»£ç åªåœ¨<code>v16.6(ä¸åŒ…æ‹¬)</code>ä¹‹å‰æœ‰æ•ˆ</strong>. 16.6æ­£å¼æ¨å‡º Suspense åï¼ŒSuspense å°±å’Œæ™®é€šçš„ ErrorBoundary éš”ç¦»å¼€æ¥äº†ï¼Œæ‰€ä»¥æ— æ³•åœ¨ <code>componentDidCatch</code> ä¸­æ•è·åˆ° Promise. <strong>å½“ç»„ä»¶ä¸­æŠ›å‡º Promise å¼‚å¸¸æ—¶ï¼ŒReact ä¼šå‘ä¸ŠæŸ¥æ‰¾æœ€è¿‘çš„ Suspense æ¥å¤„ç†å®ƒï¼Œå¦‚æœæ‰¾ä¸åˆ°ï¼ŒReact ä¼šæŠ›å‡ºé”™è¯¯</strong>ã€‚</p><p><br></p><p>ä¸Šé¢çš„ä»£ç è¿˜ç®—å¥½ç†è§£ï¼Œå¯¹å§ï¼Ÿ æˆ‘ä»¬å…ˆä¸ç®¡ React çœŸå®çš„å®ç°å¦‚ä½•ï¼Œå…¶å†…éƒ¨æ˜¾ç„¶è¦å¤æ‚å¾—å¤šï¼Œè¿™äº›å¤æ‚æ€§å¹¶ä¸æ˜¯æ‰€æœ‰å¼€å‘è€…éƒ½éœ€è¦å»å…³å¿ƒçš„ã€‚é€šè¿‡ä¸Šé¢ç®€å•çš„ä»£ç ï¼Œè‡³å°‘æˆ‘ä»¬çŸ¥é“ Suspense çš„è¡Œä¸ºæ˜¯æ€æ ·çš„äº†ã€‚ç°åœ¨æ¥æµ‹è¯•ä¸€ä¸‹ï¼š</p><p><br></p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ComponentThatThrowError</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'error from component'</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>throw error<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div className=<span class="string">"App"</span>&gt;</span><br><span class="line">      &lt;ErrorBoundary&gt;</span><br><span class="line">        &lt;Suspense fallback=&#123;<span class="literal">null</span>&#125;&gt; &#123;<span class="comment">/* Suspense ä¸ä¼šæ•è·é™¤Promiseä¹‹å¤–çš„å¼‚å¸¸ï¼Œæ‰€ä»¥è¿™é‡Œä¼šè¢«ErrorBoundaryæ•è· */</span>&#125;</span><br><span class="line">          &lt;ComponentThatThrowError /&gt;</span><br><span class="line">        &lt;<span class="regexp">/Suspense&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>ErrorBoundary&gt;</span><br><span class="line">      &lt;ErrorBoundary&gt;                               &#123;<span class="comment">/* å¦‚æœå¼‚æ­¥æ“ä½œå¤±è´¥ï¼Œè¿™ä¸ªErrorBoundaryå¯ä»¥æ•è·å¼‚æ­¥æ“ä½œçš„å¼‚å¸¸ */</span>&#125;</span><br><span class="line">        &lt;Suspense fallback=&#123;&lt;div&gt;loading...&lt;<span class="regexp">/div&gt;&#125;&gt; &#123;/</span>* è¿™é‡Œå¯ä»¥æ•è·ComponentThatThrowPromise æŠ›å‡ºçš„<span class="built_in">Promise</span>ï¼Œå¹¶æ˜¾ç¤ºloading... *<span class="regexp">/&#125;</span></span><br><span class="line"><span class="regexp">          &lt;ComponentThatThrowPromise /</span>&gt;</span><br><span class="line">        &lt;<span class="regexp">/Suspense&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>ErrorBoundary&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p><br></p><p>ä¸Šè¿°ä»£ç å±•ç¤ºäº† Suspense çš„åŸºæœ¬ç”¨æ³•ä»¥åŠå¼‚å¸¸å¤„ç†ã€‚ ä½ å¯ä»¥é€šè¿‡è¿™ä¸ª <a href="https://codesandbox.io/s/react-custom-suspense-huff4?fontsize=14" target="_blank" rel="noopener">CodeSandbox</a> å®é™…è¿è¡Œä¸€ä¸‹è¿™ä¸ªå®ä¾‹.</p><p><br></p><p>ç°åœ¨æ¥çœ‹ä¸‹ <code>ComponentThatThrowResolvedPromise</code>:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> throwed = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ComponentThatThrowResolvedPromise</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!throwed) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">res, rej</span>) =&gt;</span> &#123;</span><br><span class="line">      setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        throwed = <span class="literal">true</span></span><br><span class="line">        res()</span><br><span class="line">      &#125;, <span class="number">3000</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>throw promise.<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç çš„è¦ç‚¹æ˜¯<code>throwed</code> å’Œ <code>throw new Promise</code>ã€‚åœ¨è¿™ä¸ªç»„ä»¶ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ <code>throw new Promise</code> æ¥ä¸­æ–­ç»„ä»¶æ¸²æŸ“ï¼ŒSuspenseä¼šç­‰å¾…è¿™ä¸ª Promise å°±ç»ªåï¼Œæ¥ç€é‡æ–°æ¸²æŸ“ã€‚</p><p><strong>ä¸ºäº†é¿å…é‡æ–°æ¸²æŸ“æ—¶, åˆæŠ›å‡º Promiseï¼Œå¯¼è‡´â€™æ­»å¾ªç¯â€™ã€‚è¿™é‡Œéœ€è¦ä½¿ç”¨ä¸€ä¸ªâ€™ç¼“å­˜â€™æ¥è¡¨ç¤ºå¼‚æ­¥æ“ä½œå·²ç»å°±ç»ªäº†ï¼Œé¿å…å†æ¬¡æŠ›å‡ºå¼‚å¸¸</strong>ã€‚</p><p><strong>ä¸Šé¢é€šè¿‡ throwed å…¨å±€å˜é‡æ¥ç¼“å­˜å¼‚æ­¥æ“ä½œçš„çŠ¶æ€ã€‚ä½†æ˜¯å¯¹äºç»„ä»¶æ¥è¯´å…¨å±€çŠ¶æ€æ˜¯ Anti-Patternï¼Œå‰¯ä½œç”¨ä¼šå¯¼è‡´ç»„ä»¶æ— æ³•è¢«å¤ç”¨ã€‚å¦å¤–å¦‚æœç¼“å­˜è„±ç¦»äº†ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸï¼Œå®ƒä¼šå˜å¾—éš¾ä»¥æ§åˆ¶, æˆ‘ä»¬æ€ä¹ˆåˆ¤æ–­ç¼“å­˜æ˜¯å¦æœ‰æ•ˆ? è¿™ä¸ªç¼“å­˜çš„ç”Ÿå‘½å‘¨æœŸæ˜¯æ€æ ·æ§åˆ¶ï¼Ÿ</strong>ã€‚</p><p>å½“ç„¶ä½ å¯ä»¥ä½¿ç”¨ Redux æˆ–è€…å…¶ä»–çŠ¶æ€ç®¡ç†å™¨æ¥ç»´æŠ¤è¿™äº›ç¼“å­˜ï¼Œä½†æ˜¯æœ‰æ—¶å€™æˆ‘ä»¬éƒ½ä¸æƒ³ç”¨çŠ¶æ€ç®¡ç†å™¨.</p><p><strong>èƒ½ä¸èƒ½åœ¨ç»„ä»¶å†…éƒ¨ç¼“å­˜è¿™äº›çŠ¶æ€ï¼Ÿç­”æ¡ˆæ˜¯ä¸è¡Œ, è‡³å°‘ç°åœ¨ä¸å¯ä»¥</strong>, ç”±ä¸Šé¢çš„è‡ªå®šä¹‰ Suspense çš„å®ç°å¯ä»¥è§£é‡Š: <strong>å½“ Suspense åˆ‡æ¢åˆ° pending æ—¶ï¼ŒåŸæœ‰çš„ç»„ä»¶æ ‘ä¼šè¢«å¸è½½ï¼Œæ‰€æœ‰çš„ç»„ä»¶çŠ¶æ€éƒ½ä¼šä¸¢å¤±</strong>ã€‚</p><p>å¬èµ·æ¥æŒºæ²®ä¸§ï¼Œçœ‹æ¥å°†å¼‚æ­¥æ“ä½œè¿ç§»åˆ° Suspense è¿˜å¾—èŠ±ç‚¹å¿ƒæ€ã€‚</p><p><br><br><br></p><h2 id="ç¼“å­˜-suspense-çš„å¼‚æ­¥æ“ä½œçŠ¶æ€"><a href="#ç¼“å­˜-suspense-çš„å¼‚æ­¥æ“ä½œçŠ¶æ€" class="headerlink" title="ç¼“å­˜ Suspense çš„å¼‚æ­¥æ“ä½œçŠ¶æ€"></a>ç¼“å­˜ Suspense çš„å¼‚æ­¥æ“ä½œçŠ¶æ€</h2><p>ä¸Šé¢è¯´äº†ï¼Œæˆ‘ä»¬æ— æ³•åœ¨ç»„ä»¶å†…éƒ¨ç¼“å­˜å¼‚æ­¥æ“ä½œçš„çŠ¶æ€ï¼Œé‚£ä¹ˆç°åœ¨åªèƒ½æ”¾åœ¨å¤–éƒ¨äº†ï¼Œå¯ä»¥è€ƒè™‘è¿™äº›æ–¹æ¡ˆ:</p><ul><li>å…¨å±€ç¼“å­˜ã€‚ ä¾‹å¦‚å…¨å±€å˜é‡ã€å…¨å±€çŠ¶æ€ç®¡ç†å™¨(å¦‚Reduxã€Mobx)</li><li>ä½¿ç”¨ Context API</li><li>ç”±çˆ¶çº§ç»„ä»¶æ¥ç¼“å­˜çŠ¶æ€</li></ul><p>ä¸‹é¢ä¼šä»‹ç»åé¢ä¸¤ç§</p><p><br></p><h3 id="ä½¿ç”¨-context-api"><a href="#ä½¿ç”¨-context-api" class="headerlink" title="ä½¿ç”¨ Context API"></a>ä½¿ç”¨ Context API</h3><p>æˆ‘ä»¬å…ˆç”¨ Context API ä½œä¸ºä¾‹å­ï¼Œç®€å•ä»‹ç»å¦‚ä½•ç¼“å­˜ <code>Suspense</code> å¼‚æ­¥æ“ä½œçš„çŠ¶æ€ã€‚</p><p>é¦–å…ˆå®šä¹‰ä¸€ä¸‹å¼‚æ­¥æ“ä½œçš„çŠ¶æ€æœ‰å“ªäº›ï¼š</p><p><img src="/images/concurrent-mode/promise.png" alt><br><i>å…¶å®å°±æ˜¯Promiseçš„çŠ¶æ€</i></p><p><br></p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> enum PromiseState &#123;</span><br><span class="line">  Initial,  <span class="comment">// åˆå§‹åŒ–çŠ¶æ€ï¼Œå³é¦–æ¬¡åˆ›å»º</span></span><br><span class="line">  Pending,  <span class="comment">// Promise å¤„äºpending çŠ¶æ€</span></span><br><span class="line">  Resolved, <span class="comment">// æ­£å¸¸ç»“æŸ</span></span><br><span class="line">  Rejected, <span class="comment">// å¼‚å¸¸</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æˆ‘ä»¬å°†ä¿å­˜åœ¨ Context ä¸­çš„çŠ¶æ€</span></span><br><span class="line"><span class="keyword">export</span> interface PromiseValue &#123;</span><br><span class="line">  state: PromiseState</span><br><span class="line">  value: any</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>ç°åœ¨åˆ›å»ºä¸€ä¸ª <code>React.Context</code> ä¸“é—¨æ¥ç¼“å­˜å¼‚æ­¥çŠ¶æ€, ä¸ºäº†è¡Œæ–‡ç®€æ´ï¼Œæˆ‘ä»¬è¿™ä¸ªContextå¾ˆç®€å•ï¼Œå°±æ˜¯ä¸€ä¸ª <code>key-value</code> å­˜å‚¨ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">interface ContextValues &#123;</span><br><span class="line">  getResult(key: string): PromiseValue</span><br><span class="line">  resetResult(key: string): <span class="keyword">void</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Context = React.createContext&lt;ContextValues&gt;(&#123;&#125; <span class="keyword">as</span> any)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> SimplePromiseCache: FC = <span class="function"><span class="params">props</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> cache = useRef&lt;<span class="built_in">Map</span>&lt;string, PromiseValue&gt; | <span class="literal">undefined</span>&gt;()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ ¹æ®keyè·å–ç¼“å­˜</span></span><br><span class="line">  <span class="keyword">const</span> getResult = useCallback(<span class="function">(<span class="params">key: string</span>) =&gt;</span> &#123;</span><br><span class="line">    cache.current = cache.current || <span class="keyword">new</span> <span class="built_in">Map</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cache.current.has(key)) &#123;</span><br><span class="line">      <span class="keyword">return</span> cache.current.get(key)!</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> result = &#123; <span class="attr">state</span>: PromiseState.Initial, <span class="attr">value</span>: <span class="literal">undefined</span> &#125;</span><br><span class="line"></span><br><span class="line">    cache.current.set(key, result)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ ¹æ®key cé‡ç½®ç¼“å­˜</span></span><br><span class="line">  <span class="keyword">const</span> resetResult = useCallback(<span class="function">(<span class="params">key: string</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (cache.current != <span class="literal">null</span>)  cache.current.delete(key)</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> value = useMemo(<span class="function"><span class="params">()</span> =&gt;</span> (&#123; getResult, resetResult, &#125;), [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">Context.Provider</span> <span class="attr">value</span>=<span class="string">&#123;value&#125;</span>&gt;</span>&#123;props.children&#125;<span class="tag">&lt;/<span class="name">Context.Provider</span>&gt;</span></span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure><p><br></p><p>åé¢æ˜¯é‡å¤´æˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª <code>usePromise</code> Hooksæ¥å°è£…å¼‚æ­¥æ“ä½œ, ç®€åŒ–ç¹ççš„æ­¥éª¤:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @params prom æ¥æ”¶ä¸€ä¸ªPromiseï¼Œè¿›è¡Œå¼‚æ­¥æ“ä½œ</span></span><br><span class="line"><span class="comment"> * @params key ç¼“å­˜é”®</span></span><br><span class="line"><span class="comment"> * @return è¿”å›ä¸€ä¸ªåŒ…å«è¯·æ±‚ç»“æœçš„å¯¹è±¡ï¼Œä»¥åŠä¸€ä¸ªresetæ–¹æ³•, ç”¨äºé‡ç½®ç¼“å­˜ï¼Œå¹¶é‡æ–°è¯·æ±‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">usePromise</span>&lt;<span class="title">R</span>&gt;(<span class="params">prom: Promise&lt;R&gt;, key: string</span>): </span>&#123; data: R; reset: <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">void</span> &#125; &#123;</span><br><span class="line">  <span class="comment">// ç”¨äºå¼ºåˆ¶é‡æ–°æ¸²æŸ“ç»„ä»¶</span></span><br><span class="line">  <span class="keyword">const</span> [, setCount] = useState(<span class="number">0</span>)</span><br><span class="line">  <span class="comment">// è·å–contextå€¼</span></span><br><span class="line">  <span class="keyword">const</span> cache = useContext(Context)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// âš›ï¸ ç›‘å¬keyå˜åŒ–ï¼Œå¹¶é‡æ–°å‘èµ·è¯·æ±‚</span></span><br><span class="line">  useEffect(</span><br><span class="line">    () =&gt; &#123;</span><br><span class="line">      setCount(<span class="function"><span class="params">c</span> =&gt;</span> c + <span class="number">1</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    [key],</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ï¸âš›ï¸ å¼‚æ­¥å¤„ç†</span></span><br><span class="line">  <span class="comment">// ä» Context ä¸­å–å‡ºç¼“å­˜</span></span><br><span class="line">  <span class="keyword">const</span> result = cache.getResult(key)</span><br><span class="line">  <span class="keyword">switch</span> (result.state) &#123;</span><br><span class="line">    <span class="keyword">case</span> PromiseState.Initial:</span><br><span class="line">      <span class="comment">// âš›ï¸åˆå§‹çŠ¶æ€</span></span><br><span class="line">      result.state = PromiseState.Pending</span><br><span class="line">      result.value = prom</span><br><span class="line">      prom.then(</span><br><span class="line">        value =&gt; &#123;</span><br><span class="line">          <span class="keyword">if</span> (result.state === PromiseState.Pending) &#123;</span><br><span class="line">            result.state = PromiseState.Resolved</span><br><span class="line">            result.value = value</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        err =&gt; &#123;</span><br><span class="line">          <span class="keyword">if</span> (result.state === PromiseState.Pending) &#123;</span><br><span class="line">            result.state = PromiseState.Rejected</span><br><span class="line">            result.value = err</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">      )</span><br><span class="line">      <span class="comment">// æŠ›å‡ºpromiseï¼Œå¹¶ä¸­æ–­æ¸²æŸ“</span></span><br><span class="line">      <span class="keyword">throw</span> prom</span><br><span class="line">    <span class="keyword">case</span> PromiseState.Pending:</span><br><span class="line">      <span class="comment">// âš›ï¸ è¿˜å¤„äºè¯·æ±‚çŠ¶æ€ï¼Œä¸€ä¸ªä»»åŠ¡å¯èƒ½æœ‰å¤šä¸ªç»„ä»¶è§¦å‘ï¼Œåé¢çš„æ¸²æŸ“çš„ç»„ä»¶å¯èƒ½ä¼šæ‹¿åˆ°PendingçŠ¶æ€</span></span><br><span class="line">      <span class="keyword">throw</span> result.value</span><br><span class="line">    <span class="keyword">case</span> PromiseState.Resolved:</span><br><span class="line">      <span class="comment">// âš›ï¸ å·²æ­£å¸¸ç»“æŸ</span></span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        data: result.value,</span><br><span class="line">        reset: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">          cache.resetResult(key)</span><br><span class="line">          setCount(<span class="function"><span class="params">c</span> =&gt;</span> c + <span class="number">1</span>)</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">case</span> PromiseState.Rejected:</span><br><span class="line">      <span class="comment">// âš›ï¸ å¼‚å¸¸ç»“æŸï¼ŒæŠ›å‡ºé”™è¯¯</span></span><br><span class="line">      <span class="keyword">throw</span> result.value</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>ä¸Šé¢çš„ä»£ç ä¹Ÿæ²¡æœ‰ç‰¹åˆ«éš¾çš„åœ°æ–¹ï¼Œå°±æ˜¯æ ¹æ®å½“å‰çš„å¼‚å¸¸è¯·æ±‚çš„çŠ¶æ€å†³å®šè¦æŠ›å‡º Promise è¿˜æ˜¯è¿”å›å¼‚æ­¥è¯·æ±‚çš„ç»“æœã€‚</p><p>èµ¶ç´§ç”¨èµ·æ¥, é¦–å…ˆç”¨ <code>SimplePromiseCache</code> åŒ…è£¹ <code>Suspense</code> çš„ä¸Šçº§ç»„ä»¶ï¼Œä»¥ä¾¿ä¸‹çº§ç»„ä»¶å¯ä»¥è·å–åˆ°ç¼“å­˜:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (<span class="xml"><span class="tag">&lt;<span class="name">SimplePromiseCache</span>&gt;</span></span></span><br><span class="line">    &lt;Suspense fallback="loading..."&gt;</span><br><span class="line">      &lt;DelayShow timeout=&#123;3000&#125;/&gt;</span><br><span class="line">    &lt;/Suspense&gt;</span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">SimplePromiseCache</span>&gt;</span>)</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure><p>å°è¯•ç‰›åˆ€:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">DelayShow</span>(<span class="params">&#123;timeout&#125;: &#123;timeout: number&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; data &#125; = usePromise(</span><br><span class="line">    <span class="keyword">new</span> <span class="built_in">Promise</span>&lt;number&gt;(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> res(timeout), timeout)</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="string">'delayShow'</span>, <span class="comment">// ç¼“å­˜é”®</span></span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>DelayShow: &#123;data&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç çš„è¿è¡Œæ•ˆæœå¦‚ä¸‹ï¼š</p><p><img src="/images/concurrent-mode/usePromise.gif" alt></p><p><br></p><p>è¿™ä¸€èŠ‚å±•ç¤ºäº†å¦‚ä½•é€šè¿‡ Context API æ¥å¯¹å¼‚æ­¥æ“ä½œè¿›è¡Œç¼“å­˜ï¼Œè¿™å¯èƒ½æ¯”ä½ æƒ³è±¡çš„è¦å¤æ‚çš„ç‚¹ï¼Œæ‰‹åŠ¨å»ç®¡ç†è¿™äº›ç¼“å­˜ç¡®å®æ˜¯ä¸€ä¸ªæ£˜æ‰‹çš„é—®é¢˜(<strong>ç”¨ä»€ä¹ˆä½œä¸ºç¼“å­˜é”®ï¼Œæ€ä¹ˆåˆ¤æ–­ç¼“å­˜æœ‰æ•ˆï¼Œæ€ä¹ˆå›æ”¶ç¼“å­˜</strong>)ã€‚åŒ…æ‹¬ React å®˜æ–¹ä¹Ÿæ²¡æœ‰ç»™å‡ºä¸€ä¸ªå®Œç¾çš„ç­”æ¡ˆ, è¿™ä¸ªå‘è¿˜æ˜¯ç•™ç»™ç¤¾åŒºå»æ¢ç´¢å§ã€‚</p><p>é™¤éä½ æ˜¯åº“çš„ä½œè€…ï¼Œå¯¹äºæ™®é€š React å¼€å‘è€…æ¥è¯´ä¸å¿…è¿‡æ—©å…³æ³¨è¿™äº›ç»†èŠ‚ï¼Œç›¸ä¿¡å¾ˆå¿«ä¼šæœ‰å¾ˆå¤š React æ•°æ®è¯·æ±‚ç›¸å…³çš„ç¬¬ä¸‰æ–¹åº“ä¼šè·Ÿè¿› Suspenseã€‚</p><blockquote><p>React å®˜æ–¹æœ‰ä¸€ä¸ªå®éªŒæ€§çš„åº“: <a href="https://github.com/facebook/react/tree/master/packages/react-cache" target="_blank" rel="noopener">react-cache</a>, ç›®å‰é‡‡ç”¨çš„æ˜¯ LRU å…¨å±€ç¼“å­˜</p></blockquote><p><br><br><br></p><h3 id="å°†ç¼“å­˜çŠ¶æ€æå–åˆ°çˆ¶çº§"><a href="#å°†ç¼“å­˜çŠ¶æ€æå–åˆ°çˆ¶çº§" class="headerlink" title="å°†ç¼“å­˜çŠ¶æ€æå–åˆ°çˆ¶çº§"></a>å°†ç¼“å­˜çŠ¶æ€æå–åˆ°çˆ¶çº§</h3><p><strong>æ—¢ç„¶æ— æ³•åœ¨ Suspense çš„å­ç»„ä»¶ä¸­ç¼“å­˜å¼‚æ­¥çŠ¶æ€ï¼Œé‚£å°±æåˆ°çˆ¶çº§ç»„ä»¶å‘—ï¼Œè¿™æ ·å¯ä»¥é¿å…å…¨å±€çŠ¶æ€ï¼Œä¸éœ€è¦è€ƒè™‘ç¼“å­˜ç”Ÿå‘½å‘¨æœŸç®¡ç†, æˆ‘ä»¬å¯ä»¥æ›´çµæ´»åœ°ç®¡ç†è¿™äº›çŠ¶æ€ï¼Œå¦å¤–è¿˜å¯ä»¥ç®€åŒ–ä¸‹çº§ç»„ä»¶é€»è¾‘</strong>ã€‚ç›¸æ¯” Context APIï¼Œæˆ‘ä¸ªäººè§‰å¾—è¿™æ˜¯ä¸€ç§æ›´æ™®é€‚çš„æ–¹å¼ã€‚</p><p><br></p><p>Soï¼Œæ€ä¹ˆåšï¼Ÿæˆ‘ä»¬åŸºäº <code>usePromise</code>, å†åˆ›å»ºä¸€ä¸ª <code>createResource</code> å‡½æ•°, å®ƒä¸å†æ˜¯ä¸€ä¸ªHooksï¼Œè€Œæ˜¯åˆ›å»ºä¸€ä¸ª<strong>èµ„æºå¯¹è±¡</strong>, å‡½æ•°ç­¾åå¦‚ä¸‹:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createResource</span>&lt;<span class="title">R</span>&gt;(<span class="params">prom: (</span>) =&gt; <span class="title">Promise</span>&lt;<span class="title">R</span>&gt;): <span class="title">Resource</span>&lt;<span class="title">R</span>&gt;</span></span><br></pre></td></tr></table></figure><p><br></p><p><code>createResource</code> è¿”å›ä¸€ä¸ª <code>Resource</code> å¯¹è±¡:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">interface Resource&lt;R&gt; &#123;</span><br><span class="line">  <span class="comment">// è¯»å–'èµ„æº', åœ¨SuspenseåŒ…è£¹çš„ä¸‹çº§ç»„ä»¶ä¸­è°ƒç”¨, å’Œä¸Šæ–‡çš„usePromiseä¸€æ ·çš„æ•ˆæœ</span></span><br><span class="line">  read(): R</span><br><span class="line">  <span class="comment">// âš›ï¸å¤–åŠ çš„å¥½å¤„ï¼Œé¢„åŠ è½½</span></span><br><span class="line">  preload(): <span class="keyword">void</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p><strong>âš›ï¸Resource å¯¹è±¡åœ¨çˆ¶çº§ç»„ä»¶ä¸­åˆ›å»º, ç„¶åé€šè¿‡Propsä¼ é€’ç»™ä¸‹çº§ç»„ä»¶ï¼Œä¸‹çº§ç»„ä»¶è°ƒç”¨ <code>read()</code> æ–¹æ³•æ¥è¯»å–æ•°æ®ã€‚<code>å¯¹äºä¸‹çº§ç»„ä»¶æ¥è¯´ Resource å’Œæ™®é€šçš„å¯¹è±¡æ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œå®ƒå¯Ÿè§‰ä¸å‡ºæ¥è¿™æ˜¯ä¸€ä¸ªå¼‚æ­¥è¯·æ±‚</code></strong>ã€‚è¿™å°±æ˜¯è¿™ç§ Suspense çš„ç²¾å¦™ä¹‹å¤„!</p><p>å¦å¤–ç”±äº Resource å¯¹è±¡æ˜¯åœ¨çˆ¶çº§ç»„ä»¶åˆ›å»ºçš„ï¼Œè¿™æœ‰ä¸€ä¸ªå¤–åŠ çš„å¥½å¤„: <strong>æˆ‘ä»¬å¯ä»¥åœ¨æ˜¾ç¤ºä¸‹çº§ç»„ä»¶ä¹‹å‰ï¼Œæ‰§è¡Œ <code>preload()</code> é¢„å…ˆæ‰§è¡Œå¼‚æ­¥æ“ä½œ</strong>ã€‚</p><p><br></p><p><code>createResource</code> å®ç°ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">createResource</span>&lt;<span class="title">R</span>&gt;(<span class="params">prom: (</span>) =&gt; <span class="title">Promise</span>&lt;<span class="title">R</span>&gt;): <span class="title">Resource</span>&lt;<span class="title">R</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">// ç¼“å­˜</span></span><br><span class="line">  <span class="keyword">const</span> result: PromiseValue = &#123;</span><br><span class="line">    state: PromiseState.Initial,</span><br><span class="line">    value: prom,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">initial</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (result.state !== PromiseState.Initial) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    result.state = PromiseState.Pending</span><br><span class="line">    <span class="keyword">const</span> p = (result.value = result.value())</span><br><span class="line">    p.then(</span><br><span class="line">      (value: any) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (result.state === PromiseState.Pending) &#123;</span><br><span class="line">          result.state = PromiseState.Resolved</span><br><span class="line">          result.value = value</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      (err: any) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (result.state === PromiseState.Pending) &#123;</span><br><span class="line">          result.state = PromiseState.Rejected</span><br><span class="line">          result.value = err</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> p</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    read() &#123;</span><br><span class="line">      <span class="keyword">switch</span> (result.state) &#123;</span><br><span class="line">        <span class="keyword">case</span> PromiseState.Initial:</span><br><span class="line">          <span class="comment">// âš›ï¸åˆå§‹çŠ¶æ€</span></span><br><span class="line">          <span class="comment">// æŠ›å‡ºpromiseï¼Œå¹¶ä¸­æ–­æ¸²æŸ“</span></span><br><span class="line">          <span class="keyword">throw</span> initial()</span><br><span class="line">        <span class="keyword">case</span> PromiseState.Pending:</span><br><span class="line">          <span class="comment">// âš›ï¸ è¿˜å¤„äºè¯·æ±‚çŠ¶æ€ï¼Œä¸€ä¸ªä»»åŠ¡å¯èƒ½æœ‰å¤šä¸ªç»„ä»¶è§¦å‘ï¼Œåé¢çš„æ¸²æŸ“çš„ç»„ä»¶å¯èƒ½ä¼šæ‹¿åˆ°PendingçŠ¶æ€</span></span><br><span class="line">          <span class="keyword">throw</span> result.value</span><br><span class="line">        <span class="keyword">case</span> PromiseState.Resolved:</span><br><span class="line">          <span class="comment">// âš›ï¸ å·²æ­£å¸¸ç»“æŸ</span></span><br><span class="line">          <span class="keyword">return</span> result.value</span><br><span class="line">        <span class="keyword">case</span> PromiseState.Rejected:</span><br><span class="line">          <span class="comment">// âš›ï¸ å¼‚å¸¸ç»“æŸï¼ŒæŠ›å‡ºé”™è¯¯</span></span><br><span class="line">          <span class="keyword">throw</span> result.value</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// é¢„åŠ è½½</span></span><br><span class="line">    preload: initial,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p><code>createResource</code> çš„ç”¨æ³•ä¹Ÿå¾ˆç®€å•, åœ¨çˆ¶ç»„ä»¶åˆ›å»º Resourceï¼Œæ¥ç€é€šè¿‡ Props ä¼ é€’ç»™å­ç»„ä»¶ã€‚ ä¸‹é¢å±•ç¤ºä¸€ä¸ªTabsç»„ä»¶ï¼Œæ¸²æŸ“ä¸‰ä¸ªå­Tabï¼Œå› ä¸ºåŒæ—¶åªèƒ½æ˜¾ç¤ºä¸€ä¸ªTabï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©é¢„åŠ è½½é‚£äº›æœªæ˜¾ç¤ºçš„Tab, æ¥æå‡å®ƒä»¬çš„æ‰“å¼€é€Ÿåº¦:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> App = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [active, setActive] = useState(<span class="string">'tab1'</span>)</span><br><span class="line">  <span class="comment">// åˆ›å»º Resource</span></span><br><span class="line">  <span class="keyword">const</span> [resources] = useState(<span class="function"><span class="params">()</span> =&gt;</span> (&#123;</span><br><span class="line">    tab1: createResource(<span class="function"><span class="params">()</span> =&gt;</span> fetchPosts()),</span><br><span class="line">    tab2: createResource(<span class="function"><span class="params">()</span> =&gt;</span> fetchOrders()),</span><br><span class="line">    tab3: createResource(<span class="function"><span class="params">()</span> =&gt;</span> fetchUsers()),</span><br><span class="line">  &#125;))</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// é¢„åŠ è½½æœªå±•ç¤ºçš„Tabæ•°æ®</span></span><br><span class="line">    <span class="built_in">Object</span>.keys(resources).forEach(<span class="function"><span class="params">name</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (name !== active) &#123;</span><br><span class="line">        resources[name].preload()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (<span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"app"</span>&gt;</span></span></span><br><span class="line">    &lt;Suspense fallback="loading..."&gt;</span><br><span class="line">      &lt;Tabs active=&#123;active&#125; onChange=&#123;setActive&#125;&gt;</span><br><span class="line">        &lt;Tab key="tab1"&gt;&lt;Posts resource=&#123;resources.tab1&#125;&gt;&lt;/Posts&gt;&lt;/Tab&gt;</span><br><span class="line">        &lt;Tab key="tab2"&gt;&lt;Orders resource=&#123;resources.tab2&#125;&gt;&lt;/Orders&gt;&lt;/Tab&gt;</span><br><span class="line">        &lt;Tab key="tab3"&gt;&lt;Users resource=&#123;resources.tab3&#125;&gt;&lt;/Users&gt;&lt;/Tab&gt;</span><br><span class="line">      &lt;/Tabs&gt;</span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>æˆ‘ä»¬éšä¾¿æŒ‘ä¸€ä¸ªå­ç»„ä»¶, çœ‹ä¸€ä¸‹å®ƒçš„å®ç°ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> Posts: FC&lt;&#123;<span class="attr">resource</span>: Resource&lt;Post[]&gt;&#125;&gt; = <span class="function">(<span class="params">&#123;resource&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> posts = resource.read()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (<span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"posts"</span>&gt;</span></span></span><br><span class="line">    &#123;posts.map(i =&gt; &lt;PostSummary key=&#123;i.id&#125; value=&#123;i&#125; /&gt;)&#125;</span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span>)</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure><p><br></p><p>Ok, è¿™ç§æ–¹å¼ç›¸æ¯” Context API å¥½å¾ˆå¤šäº†ï¼Œæˆ‘ä¸ªäººä¹Ÿåå‘è¿™ç§å½¢å¼ã€‚è¿™ç§æ¨¡å¼ä¸‹ï¼Œå› ä¸º Resource æ˜¯ç”±å¤–éƒ¨ä¼ å…¥çš„ï¼Œæ‰€ä»¥ç»„ä»¶è¡Œä¸ºæ˜¯ç¡®å®šçš„ï¼Œå®¹æ˜“è¢«æµ‹è¯•å’Œå¤ç”¨ã€‚</p><p><br></p><p>ä¸è¿‡ä¸¤ç§å„æœ‰åº”ç”¨åœºæ™¯:</p><ul><li>Context API æ¨¡å¼æ¯”è¾ƒé€‚åˆç¬¬ä¸‰æ–¹æ•°æ®è¯·æ±‚åº“ï¼Œæ¯”å¦‚Apolloã€Relayã€‚è¿™ç§æ¨¡å¼ä¸‹ï¼ŒAPIä¼šæ›´åŠ ç®€æ´ã€ä¼˜é›…ã€‚å‚è€ƒ <a href="https://relay.dev/docs/en/experimental/api-reference#uselazyloadquery" target="_blank" rel="noopener">Relay çš„ API</a></li><li>createResource æ¨¡å¼åˆ™æ›´é€‚åˆæ™®é€šå¼€å‘è€…å°è£…è‡ªå·±çš„å¼‚æ­¥æ“ä½œã€‚</li></ul><p><br><br><br></p><h2 id="å¹¶å‘å‘èµ·è¯·æ±‚"><a href="#å¹¶å‘å‘èµ·è¯·æ±‚" class="headerlink" title="å¹¶å‘å‘èµ·è¯·æ±‚"></a>å¹¶å‘å‘èµ·è¯·æ±‚</h2><p><img src="/images/concurrent-mode/twitter.png" alt></p><p><br></p><p>å¦‚ä¸Šå›¾ï¼Œç°å®é¡¹ç›®ä¸­ç»å¸¸ä¼šæœ‰è¿™ç§åœºæ™¯ï¼Œä¸€ä¸ªå¤æ‚çš„ç•Œé¢æ•°æ®å¯èƒ½æ¥æºäºå¤šä¸ªæ¥å£ï¼Œä¾‹å¦‚:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç”¨æˆ·ä¿¡æ¯é¡µé¢</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ProfilePage</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [user, setUser] = useState(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å…ˆæ‹¿åˆ°ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    fetchUser().then(<span class="function"><span class="params">u</span> =&gt;</span> setUser(u));</span><br><span class="line">  &#125;, []);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (user === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Loading profile...<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;&gt;</span><br><span class="line">      &lt;h1&gt;&#123;user.name&#125;&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">      &lt;ProfileTimeline /</span>&gt;</span><br><span class="line">    &lt;<span class="regexp">/&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">/</span>**</span><br><span class="line"> * ç”¨æˆ·æ—¶é—´çº¿</span><br><span class="line"> *<span class="regexp">/ </span></span><br><span class="line"><span class="regexp">function ProfileTimeline() &#123;</span></span><br><span class="line"><span class="regexp">  const [posts, setPosts] = useState(null);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  useEffect(() =&gt; &#123;</span></span><br><span class="line"><span class="regexp">    fetchPosts().then(p =&gt; setPosts(p));</span></span><br><span class="line"><span class="regexp">  &#125;, []);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  if (posts === null) &#123;</span></span><br><span class="line"><span class="regexp">    return &lt;h2&gt;Loading posts...&lt;/</span>h2&gt;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;ul&gt;</span><br><span class="line">      &#123;posts.map(<span class="function"><span class="params">post</span> =&gt;</span> (</span><br><span class="line">        &lt;li key=&#123;post.id&#125;&gt;&#123;post.text&#125;&lt;<span class="regexp">/li&gt;</span></span><br><span class="line"><span class="regexp">      ))&#125;</span></span><br><span class="line"><span class="regexp">    &lt;/u</span>l&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>ä¸Šé¢çš„ä»£ç ç¤ºä¾‹æ¥æºäºå®˜æ–¹æ–‡æ¡£ã€‚ä¸Šé¢ä»£ç  <code>fetchUser</code> å’Œ <code>fetchPosts</code> æ˜¯ä¸²è¡ŒåŠ è½½çš„ï¼Œæˆ‘ä»¬æƒ³è®©é¡µé¢å°½å¿«çš„åŠ è½½å‡ºæ¥, è§£å†³è¿™ä¸ªé—®é¢˜æœ‰ä¸¤ä¸ªæ–¹æ¡ˆï¼š</p><ul><li>1ï¸âƒ£ å°† fetchPosts æåˆ°ä¸Šçº§, ä½¿ç”¨ <code>Promise.all</code> å¹¶å‘åŠ è½½</li><li>2ï¸âƒ£ å°†ä¸¤è€…æŠ½å–æˆç‹¬ç«‹çš„ç»„ä»¶ï¼Œå˜æˆå…„å¼Ÿå…³ç³»è€Œä¸æ˜¯çˆ¶å­å…³ç³». è¿™æ ·å¯ä»¥è¢«å¹¶å‘æ¸²æŸ“ï¼Œä»è€Œå¹¶å‘å‘èµ·è¯·æ±‚</li></ul><p><br></p><p>é¦–å…ˆæ¥çœ‹ä¸€ä¸‹ 1ï¸âƒ£:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fetchProfileData</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ä½¿ç”¨ promise all å¹¶å‘åŠ è½½</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Promise</span>.all([</span><br><span class="line">    fetchUser(),</span><br><span class="line">    fetchPosts()</span><br><span class="line">  ]).then(<span class="function">(<span class="params">[user, posts]</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;user, posts&#125;;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> promise = fetchProfileData();</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ProfilePage</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [user, setUser] = useState(<span class="literal">null</span>);</span><br><span class="line">  <span class="keyword">const</span> [posts, setPosts] = useState(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    promise.then(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">      setUser(data.user);</span><br><span class="line">      setPosts(data.posts);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;, []);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (user === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Loading profile...<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;&gt;</span><br><span class="line">      &lt;h1&gt;&#123;user.name&#125;&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">      &#123;/</span>* ProfileTimeline å˜æˆäº†çº¯ç»„ä»¶ï¼Œä¸åŒ…å«ä¸šåŠ¡è¯·æ±‚ *<span class="regexp">/&#125;</span></span><br><span class="line"><span class="regexp">      &lt;ProfileTimeline posts=&#123;posts&#125; /</span>&gt;</span><br><span class="line">    &lt;<span class="regexp">/&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p><br></p><p>çœ‹èµ·æ¥ä¸é”™ï¼Œç„¶åè¿™ä¸ªæ–¹å¼ä¹Ÿå­˜åœ¨ç¡¬ä¼¤:</p><ul><li>â‘  å¼‚æ­¥è¯·æ±‚éƒ½è¦ä¸Šæï¼Œç„¶åä½¿ç”¨ <code>Promise.all</code> åŒ…è£¹ï¼Œæˆ‘è§‰å¾—å¥½éº»çƒ¦, å¤æ‚é¡µé¢æ€ä¹ˆåŠï¼Ÿ</li><li>â‘¡ ç°åœ¨åŠ è½½æ—¶é—´å–å†³äº Promise.all ä¸­æ‰§è¡Œæœ€é•¿çš„æ“ä½œï¼Œè¯´å¥½çš„å°½å¿«æ¸²æŸ“å‡ºæ¥å‘¢ï¼ŸfetchPosts å¯èƒ½ä¼šåŠ è½½å¾ˆé•¿ï¼Œè€Œ fetchUser åº”è¯¥å¾ˆå¿«å®Œæˆäº†ï¼Œå¦‚æœ fetchUser å…ˆæ‰§è¡Œå®Œï¼Œè‡³å°‘åº”è¯¥è®©ç”¨æˆ·å…ˆçœ‹åˆ°ç”¨æˆ·ä¿¡æ¯ã€‚</li></ul><p><br></p><p>1ï¸âƒ£æ–¹æ¡ˆä¸æ˜¯ç‰¹åˆ«å¥½ï¼Œæ¥çœ‹ä¸€ä¸‹2ï¸âƒ£æ–¹æ¡ˆ:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ProfilePage</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (<span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"profile-page"</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">ProfileDetails</span> /&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">ProfileTimeline</span> /&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>2ï¸âƒ£æ–¹æ¡ˆæ˜¯æ²¡æœ‰ Suspense ä¹‹å‰æœ€å¥½çš„æ–¹å¼ï¼ŒProfileDetails è´Ÿè´£åŠ è½½ç”¨æˆ·ä¿¡æ¯ï¼ŒProfileTimeline è´Ÿè´£åŠ è½½æ—¶é—´çº¿ï¼Œä¸¤è€…å¹¶å‘æ‰§è¡Œï¼Œäº’ä¸å¹²æ‰°ã€‚</p><p>ä½†æ˜¯å®ƒä¹Ÿæ˜¯æœ‰ç¼ºç‚¹ï¼šé¡µé¢åŠ è½½æ˜¯ä¼šæœ‰ä¸¤ä¸ª<code>åŠ è½½æŒ‡ç¤ºç¬¦</code>, èƒ½ä¸èƒ½åˆå¹¶ï¼Ÿæœ‰å¯èƒ½ ProfileTimeline å…ˆå®Œæˆäº†ï¼Œè¿™æ—¶å€™ ProfileDetails è¿˜åœ¨è½¬åœˆï¼Œé¡µé¢ä¼šå¾ˆæ€ªâ€¦</p><p><br></p><p>ç°åœ¨æœ‰è¯·æ–¹æ¡ˆ 3ï¸âƒ£: <code>Suspense</code> ğŸ‰</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> resource = fetchProfileData();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ProfilePage</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;Suspense fallback=&#123;&lt;h1&gt;Loading profile...&lt;<span class="regexp">/h1&gt;&#125;&gt;</span></span><br><span class="line"><span class="regexp">      &lt;ProfileDetails /</span>&gt;</span><br><span class="line">      &lt;Suspense fallback=&#123;&lt;h1&gt;Loading posts...&lt;<span class="regexp">/h1&gt;&#125;&gt;</span></span><br><span class="line"><span class="regexp">        &lt;ProfileTimeline /</span>&gt;</span><br><span class="line">      &lt;<span class="regexp">/Suspense&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>Suspense&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ProfileDetails</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> user = resource.user.read();</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;user.name&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ProfileTimeline</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> posts = resource.posts.read();</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;ul&gt;</span><br><span class="line">      &#123;posts.map(<span class="function"><span class="params">post</span> =&gt;</span> (</span><br><span class="line">        &lt;li key=&#123;post.id&#125;&gt;&#123;post.text&#125;&lt;<span class="regexp">/li&gt;</span></span><br><span class="line"><span class="regexp">      ))&#125;</span></span><br><span class="line"><span class="regexp">    &lt;/u</span>l&gt;</span><br><span class="line">  );</span><br></pre></td></tr></table></figure><p><br></p><p>å½“ React æ¸²æŸ“ ProfilePage æ—¶, å®ƒä¼šè¿”å› ProfileDetails å’Œ ProfileTimelineã€‚</p><p>é¦–å…ˆæ¸²æŸ“ ProfileDetails è¿™æ—¶å€™èµ„æºæœªåŠ è½½å®Œæ¯•ï¼ŒæŠ›å‡º promise å¼‚å¸¸ï¼Œä¸­æ–­ ProfileDetails çš„æ¸²æŸ“ã€‚</p><p>æ¥ç€ React å°è¯•æ¸²æŸ“ ProfileTimeline, åŒæ ·æŠ›å‡ºpromiseå¼‚å¸¸ã€‚</p><p>æœ€å React æ‰¾åˆ° ProfileDetails æœ€è¿‘çš„Suspenseï¼Œæ˜¾ç¤º Loading Profileâ€¦</p><p>å’Œæ–¹æ¡ˆ2ï¸âƒ£ä¸€æ ·ï¼ŒSuspense æ”¯æŒå¹¶å‘å‘èµ·è¯·æ±‚ï¼Œå¦å¤–å®ƒè§£å†³äº†æ–¹æ¡ˆ 2ï¸âƒ£ çš„ä¸€äº›ç¼ºé™·: åŠ è½½æŒ‡ç¤ºç¬¦åªæœ‰ä¸€ä¸ªï¼Œè€Œä¸”å¦‚æœ ProfileTimeline ç‡å…ˆå®Œæˆï¼Œä¹Ÿä¸ä¼šæ˜¾ç¤ºå‡ºæ¥ã€‚</p><p>ä¸æ­¢äºæ­¤ï¼Œä¸‹æ–‡ä¼šä»‹ç»æ›´ä¸ºçµæ´»çš„ Suspense åŠ è½½çŠ¶æ€çš„æ˜¾ç¤ºç­–ç•¥ã€‚</p><p><br><br><br></p><h2 id="å¤„ç†ç«æ€"><a href="#å¤„ç†ç«æ€" class="headerlink" title="å¤„ç†ç«æ€"></a>å¤„ç†ç«æ€</h2><p><strong>å°±ç®— Javascript æ˜¯å•çº¿ç¨‹çš„, ä¹Ÿå¯èƒ½éœ€è¦å¤„ç†ç«äº‰çŠ¶æ€ï¼Œä¸»è¦æ˜¯å› ä¸ºå¼‚æ­¥æ“ä½œçš„æ—¶åºæ˜¯æ— æ³•è¢«ä¿è¯çš„</strong>ã€‚</p><p>å°‘å–å…³å­ï¼Œè®²ä¸ªå®ä¾‹ã€‚æœ‰è¿™æ ·ä¸€ä¸ªç»„ä»¶ï¼Œå®ƒä¾èµ–å¤–éƒ¨ä¼ é€’è¿›æ¥çš„ id æ¥å¼‚æ­¥è·å–æ•°æ®:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">UserInfo</span>(<span class="params">&#123;id&#125;: &#123;id: string&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [user, setUser] = useState&lt;User|<span class="literal">undefined</span>&gt;()</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * âš›ï¸ ç›‘å¬idå˜åŒ–å¹¶å‘èµ·è¯·æ±‚</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    fetchUserInfo().then(<span class="function"><span class="params">user</span> =&gt;</span> setUser(user))</span><br><span class="line">  &#125;, [id])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> user == <span class="literal">null</span> ? <span class="xml"><span class="tag">&lt;<span class="name">Loading</span> /&gt;</span> : renderUser(user)</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure><p><br></p><p>ä¸Šé¢çš„ä»£ç æœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿå‡è®¾idå˜åŒ–äº†å¤šæ¬¡ï¼Œè¿™é‡Œä¼šå‘èµ·å¤šä¸ªè¯·æ±‚ï¼Œä½†æ˜¯è¿™äº›è¯·æ±‚å®Œæˆçš„é¡ºåºæ²¡åŠæ³•ä¿è¯ï¼Œè¿™å°±ä¼šå¯¼è‡´ç«æ€ï¼Œå…ˆå‘èµ·çš„è¯·æ±‚å¯èƒ½æœ€åæ‰å®Œæˆï¼Œè¿™å°±å¯¼è‡´é¡µé¢å‘ˆç°é”™è¯¯çš„æ•°æ®ã€‚</p><p><br></p><p>æ€ä¹ˆè§£å†³ï¼Ÿä¹Ÿæ¯”è¾ƒå¥½è§£å†³ï¼Œåˆ©ç”¨ç±»ä¼¼<strong>ä¹è§‚é”</strong>çš„æœºåˆ¶ã€‚æˆ‘ä»¬å¯ä»¥ä¿å­˜æœ¬æ¬¡è¯·æ±‚çš„idï¼Œå¦‚æœè¯·æ±‚ç»“æŸæ—¶ id ä¸ä¸€è‡´ï¼Œå°±è¯´æ˜å·²ç»æœ‰æ–°çš„è¯·æ±‚å‘èµ·äº†:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">UserInfo</span>(<span class="params">&#123;id&#125;: &#123;id: string&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [user, setUser] = setState&lt;User|<span class="literal">undefined</span>&gt;()</span><br><span class="line">  <span class="keyword">const</span> currentId = useRef&lt;string&gt;()</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * âš›ï¸ ç›‘å¬idå˜åŒ–å¹¶å‘èµ·è¯·æ±‚</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    currentId.current = id</span><br><span class="line">    fetchUserInfo().then(<span class="function"><span class="params">user</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// id ä¸ä¸€è‡´ï¼Œè¯´æ˜å·²ç»æœ‰æ–°çš„è¯·æ±‚å‘èµ·äº†, æ”¾å¼ƒ</span></span><br><span class="line">      <span class="keyword">if</span> (id !== currentId.current) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      setUser(user)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;, [id])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> user == <span class="literal">null</span> ? <span class="xml"><span class="tag">&lt;<span class="name">Loading</span> /&gt;</span> : renderUser(user)</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure><p><br></p><p>Suspense ä¸‹é¢ä¸å­˜åœ¨ç«æ€é—®é¢˜ï¼Œä¸Šé¢çš„ä»£ç ç”¨ Suspense å®ç°å¦‚ä¸‹:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">UserInfo</span>(<span class="params">&#123;resource&#125;: &#123;resource: Resource&lt;User&gt;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> user = resource.read()</span><br><span class="line">  <span class="keyword">return</span> renderUser(user)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>æˆ‘é , è¿™ä¹ˆç®€æ´ï¼ä¼ é€’ç»™ UserInfo çš„å°±æ˜¯ä¸€ä¸ªç®€å•çš„å¯¹è±¡, æ²¡æœ‰ç«æ€. </p><p>é‚£å®ƒçš„ä¸Šçº§ç»„ä»¶å‘¢?</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createUserResource</span>(<span class="params">id: string</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    info: createResource(<span class="function"><span class="params">()</span> =&gt;</span> fecthUserInfo(id)),</span><br><span class="line">    timeline: createResource(<span class="function"><span class="params">()</span> =&gt;</span> fecthTimeline(id)),</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">UserPage</span>(<span class="params">&#123;id&#125;: &#123;id: string&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [resource, setResource] = useState(<span class="function"><span class="params">()</span> =&gt;</span> createUserResource(id))</span><br><span class="line"></span><br><span class="line">  <span class="comment">// âš›ï¸ å°†idçš„ç›‘å¬è¿ç§»åˆ°äº†è¿™é‡Œ</span></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// é‡æ–°è®¾ç½®resource</span></span><br><span class="line">    setResource(createUserResource(id))</span><br><span class="line">  &#125;, [id])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (<span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"user-page"</span>&gt;</span></span></span><br><span class="line">    &lt;Suspense loading="Loading User..."&gt;</span><br><span class="line">      &lt;UserInfo resource=&#123;resource.info&#125; /&gt;</span><br><span class="line">      &lt;Timeline resource=&#123;resource.timeline&#125; /&gt;</span><br><span class="line">    &lt;/Suspense&gt;</span><br><span class="line">  &lt;/div&gt;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>å¼‚æ­¥è¯·æ±‚è¢«è½¬æ¢æˆäº†â€™èµ„æºå¯¹è±¡â€™ï¼Œåœ¨è¿™é‡Œåªä¸è¿‡æ˜¯ä¸€ä¸ªæ™®é€šçš„å¯¹è±¡, é€šè¿‡ Props ä¼ é€’, å®Œç¾è§£å†³äº†å¼‚æ­¥è¯·æ±‚çš„ç«æ€é—®é¢˜â€¦</p><p><br></p><blockquote><p><strong>å¦å¤– Suspense è¿˜è§£å†³ä¸€ä¸ªé—®é¢˜</strong>ï¼šåœ¨æ‰§è¡Œå®Œå¼‚æ­¥æ“ä½œåï¼Œæˆ‘ä»¬çš„é¡µé¢å¯èƒ½å·²ç»åˆ‡æ¢äº†ï¼Œè¿™æ—¶å€™é€šè¿‡ setState è®¾ç½®ç»„ä»¶çŠ¶æ€ï¼ŒReactå°±ä¼šæŠ›å‡ºå¼‚å¸¸: <code>Can&#39;t perform a React state update on an unmounted component.</code>, ç°åœ¨è¿™ä¸ªé—®é¢˜è‡ªç„¶ä¹Ÿè§£å†³äº†</p></blockquote><p><br><br><br></p><h2 id="é”™è¯¯å¤„ç†"><a href="#é”™è¯¯å¤„ç†" class="headerlink" title="é”™è¯¯å¤„ç†"></a>é”™è¯¯å¤„ç†</h2><p>å¦‚æœå¼‚æ­¥è¯·æ±‚å¼‚å¸¸äº†æ€ä¹ˆè§£å†³ï¼Ÿ æˆ‘ä»¬åœ¨ä¸Šæ–‡ Suspense å®ç°åŸç†ä¸€èŠ‚å·²ç»è¯´äº†ï¼Œå¦‚æœå¼‚æ­¥è¯·æ±‚å¤±è´¥ï¼ŒReact ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ ErrorBoundary æœºåˆ¶å°†å…¶æ•è·ã€‚</p><p>æˆ‘ä»¬å†™ä¸€ä¸ªé«˜é˜¶ç»„ä»¶æ¥ç®€åŒ– Suspense å’Œ å¼‚å¸¸å¤„ç†çš„è¿‡ç¨‹:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">sup</span>&lt;<span class="title">P</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  fallback: NonNullable&lt;React.ReactNode&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  catcher: (err: any</span>) =&gt; <span class="title">NonNullable</span>&lt;<span class="title">React</span>.<span class="title">ReactNode</span>&gt;,</span></span><br><span class="line"><span class="function">) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">Comp: React.ComponentType&lt;P&gt;</span>) =&gt;</span> &#123;</span><br><span class="line">    interface State &#123;</span><br><span class="line">      error?: any</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Sup</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span>&lt;<span class="title">P</span>, <span class="title">State</span>&gt; </span>&#123;</span><br><span class="line">      state: State = &#123;&#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ•è·å¼‚å¸¸</span></span><br><span class="line">      <span class="keyword">static</span> getDerivedStateFromError(error: any) &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123; error &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">          &lt;Suspense fallback=&#123;fallback&#125;&gt;</span><br><span class="line">            &#123;<span class="keyword">this</span>.state.error ? catcher(<span class="keyword">this</span>.state.error) : <span class="xml"><span class="tag">&lt;<span class="name">Comp</span> &#123;<span class="attr">...this.props</span>&#125; /&gt;</span>&#125;</span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Sup</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>ç”¨èµ·æ¥:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// UserInfo.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> UserInfo: FC&lt;UserInfoProps&gt; = <span class="function">(<span class="params">props</span>) =&gt;</span> &#123;<span class="comment">/* ... */</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> sup(</span><br><span class="line">  &lt;Loading text=<span class="string">"ç”¨æˆ·åŠ è½½ä¸­..."</span>/&gt;,</span><br><span class="line">  (err) =&gt; <span class="xml"><span class="tag">&lt;<span class="name">ErrorMessage</span> <span class="attr">error</span>=<span class="string">&#123;err&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="xml">)(UserInfo)</span></span><br></pre></td></tr></table></figure><p><br></p><p>å‡å°‘äº†ä¸€äº›æ ·æ¿ä»£ç ï¼Œè¿˜ç®—æ¯”è¾ƒç®€æ´å§?ã€‚</p><p><br><br><br></p><h2 id="suspense-ç¼–æ’"><a href="#suspense-ç¼–æ’" class="headerlink" title="Suspense ç¼–æ’"></a>Suspense ç¼–æ’</h2><p>å¦‚æœé¡µé¢ä¸Šæœ‰å¾ˆå¤š Suspense, é‚£ä¹ˆå¤šä¸ªåœˆåœ¨è½¬ï¼Œç”¨æˆ·ä½“éªŒå¹¶ä¸å¥½ã€‚</p><p>ä½†æ˜¯æˆ‘ä»¬åˆä¸å¥½ç›´æ¥å°†å®ƒä»¬åˆå¹¶ï¼Œå› ä¸ºæ¯ä¸€å—åŠ è½½ä¼˜å…ˆçº§ã€ç”Ÿå‘½å‘¨æœŸéƒ½ä¸ä¸€æ ·ï¼Œå¼ºè¡Œç»‘åˆ°ä¸€ä¸ª Suspense ä¹Ÿä¸å¥½ã€‚ä¾‹å¦‚:</p><figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">UserPage</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (<span class="xml"><span class="tag">&lt;<span class="name">Suspense</span> <span class="attr">fallback</span>=<span class="string">"loading..."</span>&gt;</span></span></span><br><span class="line">    &lt;UserInfo resource=&#123;infoResource&#125; /&gt;</span><br><span class="line">    &lt;UserPost resource=&#123;postResource&#125; /&gt;</span><br><span class="line">  &lt;/Suspense&gt;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡è®¾ UserPost éœ€è¦è¿›è¡Œåˆ†é¡µï¼Œæ¯æ¬¡ç‚¹å‡»ä¸‹ä¸€é¡µéƒ½ä¼šå¯¼è‡´æ•´ä¸ª <code>UserPage</code> loadingâ€¦ è¿™è‚¯å®šæ— æ³•æ¥å—â€¦</p><p><br></p><p><strong>å› æ­¤ Concurrent æ¨¡å¼å¼•å…¥äº†ä¸€ä¸ªæ–°çš„API <code>SuspenseList</code>, ç”¨æ¥å¯¹å¤šä¸ª Suspense çš„åŠ è½½çŠ¶æ€è¿›è¡Œç¼–æ’ã€‚æˆ‘ä»¬å¯ä»¥æ ¹æ®å®é™…çš„åœºæ™¯é€‰æ‹©åŠ è½½çŠ¶æ€çš„æ˜¾ç¤ºç­–ç•¥</strong>ã€‚ä¾‹å¦‚</p><figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Page</span>(<span class="params">&#123; resource &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;SuspenseList revealOrder=<span class="string">"forwards"</span>&gt;</span><br><span class="line">      &lt;Suspense fallback=&#123;&lt;h2&gt;Loading Foo...&lt;<span class="regexp">/h2&gt;&#125;&gt;</span></span><br><span class="line"><span class="regexp">        &lt;Foo resource=&#123;resource&#125; /</span>&gt;</span><br><span class="line">      &lt;<span class="regexp">/Suspense&gt;</span></span><br><span class="line"><span class="regexp">      &lt;Suspense fallback=&#123;&lt;h2&gt;Loading Bar...&lt;/</span>h2&gt;&#125;&gt;</span><br><span class="line">        &lt;Bar resource=&#123;resource&#125; /&gt;</span><br><span class="line">      &lt;<span class="regexp">/Suspense&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>SuspenseList&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>å‡è®¾ <code>Foo</code> åŠ è½½æ—¶é—´æ˜¯ <code>5s</code>ï¼Œè€Œ <code>Bar</code> åŠ è½½å®Œæˆæ—¶é—´æ˜¯ <code>2s</code>ã€‚SuspenseList çš„å„ç§ç¼–æ’ç»„åˆçš„æ•ˆæœå¦‚ä¸‹:</p><p><img src="/images/concurrent-mode/suspense-list.gif" alt><br><i>å¯ä»¥é€šè¿‡è¿™ä¸ª <a href="https://codesandbox.io/s/react-suspenselist-sk3rj?fontsize=14" target="_blank" rel="noopener">CodeSandbox ç¤ºä¾‹</a> ä½“éªŒ </i></p><p><br></p><p><code>revealOrder</code> è¡¨ç¤ºæ˜¾ç¤ºçš„é¡ºåºï¼Œå®ƒç›®å‰æœ‰ä¸‰ä¸ªå¯é€‰å€¼: <code>forwards</code>, <code>backwards</code>, <code>together</code></p><ul><li><code>forwards</code> - ç”±å‰åˆ°åæ˜¾ç¤ºã€‚ä¹Ÿå°±è¯´å‰é¢çš„æ²¡æœ‰åŠ è½½å®Œæˆï¼Œåé¢çš„ä¹Ÿä¸ä¼šæ˜¾ç¤º. å³ä½¿åé¢çš„ Suspense æå‰å®Œæˆå¼‚æ­¥æ“ä½œï¼Œä¹Ÿéœ€è¦ç­‰å¾…å‰é¢çš„æ‰§è¡Œå®Œæˆ</li><li><code>backwards</code> - å’Œforwardsç›¸å, ç”±ååˆ°å‰ä¾æ¬¡æ˜¾ç¤º.</li><li><code>together</code> - ç­‰æ‰€æœ‰Suspense åŠ è½½å®Œæˆåä¸€èµ·æ˜¾ç¤º</li></ul><p><br></p><p>é™¤æ­¤ä¹‹å¤– <code>SuspenseList</code> è¿˜æœ‰å¦å¤–ä¸€ä¸ªå±æ€§ <code>tail</code>, ç”¨æ¥æ§åˆ¶æ˜¯å¦è¦æŠ˜å è¿™äº› Suspenseï¼Œå®ƒæœ‰ä¸‰ä¸ªå€¼ <code>é»˜è®¤å€¼</code>, <code>collapsed</code>, <code>hidden</code></p><ul><li>é»˜è®¤å€¼ - å…¨éƒ¨æ˜¾ç¤º</li><li><code>collapsed</code> - æŠ˜å ï¼Œåªæ˜¾ç¤ºç¬¬ä¸€ä¸ªæ­£åœ¨åŠ è½½çš„Suspense</li><li><code>hidden</code> - ä¸æ˜¾ç¤ºä»»ä½•åŠ è½½çŠ¶æ€</li></ul><p><br></p><p>å¦å¤– SuspenseList æ˜¯å¯ç»„åˆçš„ï¼ŒSuspenseList ä¸‹çº§å¯ä»¥åŒ…å«å…¶ä»– SuspenseList.</p><p><br><br><br></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ¬æ–‡çš„ä¸»è§’æ˜¯ <code>Suspense</code>, å¦‚æœè¯´ <code>React Hooks</code> æ˜¯Reactæä¾›çš„é€»è¾‘å¤ç”¨åŸè¯­ï¼ŒErrorBoundary æ˜¯å¼‚å¸¸æ•è·åŸè¯­ï¼Œé‚£ä¹ˆ Suspense å°†æ˜¯ React çš„å¼‚æ­¥æ“ä½œåŸè¯­ã€‚é€šè¿‡Suspense + ErrorBoundaryï¼Œç®€åŒ–äº†æ‰‹åŠ¨å»å¤„ç†åŠ è½½çŠ¶æ€å’Œå¼‚å¸¸çŠ¶æ€ã€‚</p><p>Suspense å¯ä»¥ç†è§£ä¸ºä¸­æ–­æ¸²æŸ“ã€æˆ–è€…æš‚åœæ¸²æŸ“çš„æ„æ€ã€‚æˆ‘ä»¬ç®€å•æ¢è®¨äº† Suspense çš„å®ç°åŸç†ï¼Œå®ƒä¸è¿‡æ˜¯åˆ©ç”¨äº† ErrorBoundary çš„å¼‚å¸¸æŠ›å‡ºæœºåˆ¶æ¥ä¸­æ–­æ¸²æŸ“ï¼Œé…åˆ Suspense ç»„ä»¶åœ¨å¼‚æ­¥æ“ä½œå®Œç»“åæ¢å¤ç»„ä»¶çš„æ¸²æŸ“ã€‚</p><p>ä¸è¿‡ç»„ä»¶åœ¨é‡æ–°æ¸²æŸ“(é‡å…¥)æ—¶ï¼Œæ‰€æœ‰çŠ¶æ€éƒ½ä¸¢å¤±äº†ï¼Œæ— æ³•åœ¨ç»„ä»¶æœ¬åœ°ä¿å­˜å¼‚æ­¥å¤„ç†çš„çŠ¶æ€ï¼Œæ‰€ä»¥å¾—å‘å¤–æ±‚ï¼Œå°†å¼‚æ­¥å¤„ç†çš„çŠ¶æ€ç¼“å­˜åœ¨å…¨å±€æˆ–è€…ä¸Šçº§ç»„ä»¶ã€‚</p><p>æœ‰äººä¼šè¯´ React å·²ç»ä¸çº¯äº†ã€ä¸å¤Ÿå‡½æ•°å¼äº†ã€‚æˆ‘ä¸æ•¢æ“…ä½œè¯„è®ºï¼Œæˆ‘ä¸æ˜¯è™”è¯šçš„å‡½æ•°å¼ç¼–ç¨‹çˆ±å¥½è€…ï¼Œæˆ‘è§‰å¾—åªè¦èƒ½æ›´å¥½çš„è§£å†³é—®é¢˜ï¼Œå“ªç§ç¼–ç¨‹èŒƒå¼æ— æ‰€è°“ã€‚è‡ªä» React Hooks å‡ºæ¥åï¼Œå°±æ²¡æœ‰æ‰€è°“çš„çº¯å‡½æ•°å¼ç»„ä»¶äº†ã€‚å¯¹äº Suspense æ¥è¯´ï¼ŒcreateResource æ¨¡å¼ä¹Ÿå¯ä»¥è®©ä¸€ä¸ªç»„ä»¶çš„è¡Œä¸ºå˜å¾—å¯è¢«é¢„æµ‹å’Œæµ‹è¯•ã€‚å…³äºå…¶ä»–çš„ç—›ç‚¹ï¼Œè¿˜æ˜¯è¦è¿›ä¸€æ­¥å®è·µå’ŒéªŒè¯ã€‚</p><p>Suspense è®©äººéå¸¸å…´å¥‹ï¼Œå®ƒä¸ä»…è§£å†³äº†ä¸€äº›ä»¥å¾€å¼‚æ­¥å¤„ç†çš„é—®é¢˜ï¼Œè¿˜å¸¦æ¥äº†æ–°çš„å¼€å‘æ–¹å¼ã€‚å¿ƒæ€¥çš„åŒå­¦å¯ä»¥åœ¨è‡ªå·±çš„å®éªŒé¡¹ç›®ä¸­å°è¯•å®ƒã€‚</p><p><br><br><br></p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li><a href="https://reactjs.org/docs/concurrent-mode-suspense.html" target="_blank" rel="noopener">Suspense for Data Fetching (Experimental)</a></li><li><a href="https://www.youtube.com/watch?v=ByBPyMBTzM0" target="_blank" rel="noopener">Concurrent Rendering in React - Andrew Clark and Brian Vaughn - React Conf 2018</a></li><li><a href="https://zhuanlan.zhihu.com/p/34210780" target="_blank" rel="noopener">Reactï¼šSuspenseçš„å®ç°ä¸æ¢è®¨</a></li><li><a href="https://github.com/facebook/react/blob/master/packages/react-cache/src/ReactCache.js" target="_blank" rel="noopener">react-cache</a></li></ul><p><br></p><p><img src="/images/sponsor.jpg" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;2019.10.24&lt;/strong&gt;, åœ¨ &lt;a href=&quot;https://www.youtube.com/channel/UCz5vTaEhvh7dOHEyd1efcaQ&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;React Co
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://bobi.ink/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>è¿™å¯èƒ½æ˜¯æœ€é€šä¿—çš„ React Fiber æ‰“å¼€æ–¹å¼</title>
    <link href="https://bobi.ink/2019/10/18/react-fiber/"/>
    <id>https://bobi.ink/2019/10/18/react-fiber/</id>
    <published>2019-10-17T16:00:00.000Z</published>
    <updated>2019-10-31T04:47:29.368Z</updated>
    
    <content type="html"><![CDATA[<p>å†™ä¸€ç¯‡å…³äº React Fiber çš„æ–‡ç« ï¼Œ è¿™ä¸ª Flag ç«‹äº†å¾ˆä¹…ï¼Œè¿™ä¹Ÿæ˜¯ä»Šå¹´çš„ç›®æ ‡ä¹‹ä¸€. æœ€è¿‘çš„åœ¨æ˜é‡‘çš„æ–‡ç« è·å¾—å¾ˆå¤šå…³æ³¨å’Œé¼“åŠ±ï¼Œç»™äº†æˆ‘å¾ˆå¤šåŠ¨åŠ›ï¼Œæ‰€ä»¥ä¸‹å®šå†³å¿ƒå¥½å¥½æŠŠå®ƒå†™å‡ºæ¥ã€‚ æˆ‘ä¼šä»¥æœ€é€šä¿—çš„æ–¹å¼å°†å®ƒè®²é€, å› æ­¤è¿™ç®—æ˜¯ä¸€ç¯‡ç§‘æ™®å¼çš„æ–‡ç« ã€‚ä¸ç®¡ä½ æ˜¯ä½¿ç”¨Reactã€è¿˜æ˜¯Vueï¼Œè¿™é‡Œé¢çš„æ€æƒ³å€¼å¾—å­¦ä¹ å­¦ä¹ !</p><p><br></p><p><img src="/images/react-fiber/react-conf.png" alt></p><p><br></p><p>ä¸€å¹´ä¸€åº¦çš„ React æ˜¥æ™š: <a href="https://conf.reactjs.org/schedule.html" target="_blank" rel="noopener">React Conf</a> å³å°†åˆ°æ¥ï¼Œä¸çŸ¥é“ä»Šå¹´ä¼šä¸ä¼šæœ‰ä»€ä¹ˆæƒŠå–œï¼Œå»å¹´æ˜¯ React Hooksï¼Œå‰å¹´æ˜¯ React Fiberâ€¦<br>æˆ‘å¾—èµ¶åœ¨ React Conf ä¹‹å‰å‘å¸ƒè¿™ç¯‡æ–‡ç« :</p><ul><li><p>ğŸ˜² <strong>React Fiber å·²ç»å‡ºæ¥è¿™ä¹ˆä¹…äº†ï¼Œ è¿™æ–‡ç« æ˜¯è€é…’è£…æ–°ç“¶å§</strong>? <em>å¯¹äºæˆ‘æ¥è¯´ï¼Œé€šè¿‡è¿™ç¯‡æ–‡ç« æˆ‘é‡æ–°è®¤è¯†äº† React Fiberï¼Œå®ƒä¸æ˜¯ä¸€ä¸ªæ–°ä¸œè¥¿, å®ƒä¹Ÿæ˜¯è€é…’è£…æ–°ç“¶ï¼Œä¸ä¿¡ä½ å°±çœ‹å§â€¦</em></p></li><li><p>ğŸ†• <strong>React Fiber ä¸æ˜¯ä¸€ä¸ªæ–°çš„ä¸œè¥¿ï¼Œä½†åœ¨å‰ç«¯é¢†åŸŸæ˜¯ç¬¬ä¸€æ¬¡å¹¿ä¸ºè®¤çŸ¥çš„åº”ç”¨</strong>ã€‚</p></li><li><p>ğŸ˜¦ <strong>äº†è§£å®ƒæœ‰å•¥ç”¨</strong>? <em>React Fiber ä»£ç å¾ˆå¤æ‚ï¼Œé—¨æ§›å¾ˆé«˜ï¼Œä½ ä¸äº†è§£å®ƒï¼Œåé¢ React æ–°å‡ºçš„ Killer Feature ä½ å¯èƒ½å°±æ›´ä¸èƒ½ç†è§£äº†</em></p></li><li><p>ğŸ¤¥ <strong>æˆ‘ä¸æ˜¯å‡åˆ°React v16äº†å—? æ²¡ä»€ä¹ˆå‡ºå¥‡çš„å•Š</strong>? <em>çœŸæ­£è¦ä½“ä¼šåˆ° React Fiber é‡æ„æ•ˆæœï¼Œå¯èƒ½ä¸‹ä¸ªæœˆã€å¯èƒ½è¦ç­‰åˆ° v17ã€‚v16 åªæ˜¯ä¸€ä¸ªè¿‡æ¸¡ç‰ˆæœ¬ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç°åœ¨çš„React è¿˜æ˜¯åŒæ­¥æ¸²æŸ“çš„ï¼Œä¸€ç›´åœ¨è·³ç¥¨ã€ä¸æ˜¯è¯´ä»Šå¹´ç¬¬äºŒå­£åº¦å°±å‡ºæ¥äº†å—</em>ï¼Ÿ</p></li><li><p>ğŸ˜ <strong>ä¸å¥½æ„æ€ï¼Œä¸€ä¸å°å¿ƒåˆå†™å¾—æœ‰ç‚¹é•¿ï¼Œä½ å°±å½“å°è¯´çœ‹å§, ä»£ç éƒ½æ˜¯ä¼ªä»£ç </strong></p></li></ul><p><br></p><p><strong>ä»¥ä¸‹æ–‡ç« å¤§çº²</strong></p><ul><li><a href="#å•å¤„ç†è¿›ç¨‹è°ƒåº¦-fiber-ä¸æ˜¯ä¸€ä¸ªæ–°çš„ä¸œè¥¿">å•å¤„ç†è¿›ç¨‹è°ƒåº¦: Fiber ä¸æ˜¯ä¸€ä¸ªæ–°çš„ä¸œè¥¿</a></li><li><a href="#ç±»æ¯”æµè§ˆå™¨javascriptæ‰§è¡Œç¯å¢ƒ">ç±»æ¯”æµè§ˆå™¨JavaScriptæ‰§è¡Œç¯å¢ƒ</a></li><li><a href="#ä½•ä¸º-fiber">ä½•ä¸º Fiber</a><ul><li><a href="#1-ä¸€ç§æµç¨‹æ§åˆ¶åŸè¯­">1. ä¸€ç§æµç¨‹æ§åˆ¶åŸè¯­</a></li><li><a href="#2-ä¸€ä¸ªæ‰§è¡Œå•å…ƒ">2. ä¸€ä¸ªæ‰§è¡Œå•å…ƒ</a></li></ul></li><li><a href="#react-çš„fiberæ”¹é€ ">React çš„Fiberæ”¹é€ </a><ul><li><a href="#1-æ•°æ®ç»“æ„çš„è°ƒæ•´">1. æ•°æ®ç»“æ„çš„è°ƒæ•´</a></li><li><a href="#2-ä¸¤ä¸ªé˜¶æ®µçš„æ‹†åˆ†">2. ä¸¤ä¸ªé˜¶æ®µçš„æ‹†åˆ†</a></li><li><a href="#3-reconcilation">3. Reconcilation</a></li><li><a href="#4-åŒç¼“å†²">4. åŒç¼“å†²</a></li><li><a href="#5-å‰¯ä½œç”¨çš„æ”¶é›†å’Œæäº¤">5. å‰¯ä½œç”¨çš„æ”¶é›†å’Œæäº¤</a></li></ul></li><li><a href="#âš ï¸-æœªå±•å¼€éƒ¨åˆ†-ğŸš§----ä¸­æ–­å’Œæ¢å¤">âš ï¸ æœªå±•å¼€éƒ¨åˆ† ğŸš§ â€“ ä¸­æ–­å’Œæ¢å¤</a></li><li><a href="#å‡Œæ³¢å¾®æ­¥">å‡Œæ³¢å¾®æ­¥</a></li><li><a href="#ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Š">ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Š</a></li></ul><p><br><br><br></p><h2 id="å•å¤„ç†è¿›ç¨‹è°ƒåº¦-fiber-ä¸æ˜¯ä¸€ä¸ªæ–°çš„ä¸œè¥¿"><a href="#å•å¤„ç†è¿›ç¨‹è°ƒåº¦-fiber-ä¸æ˜¯ä¸€ä¸ªæ–°çš„ä¸œè¥¿" class="headerlink" title="å•å¤„ç†è¿›ç¨‹è°ƒåº¦: Fiber ä¸æ˜¯ä¸€ä¸ªæ–°çš„ä¸œè¥¿"></a>å•å¤„ç†è¿›ç¨‹è°ƒåº¦: Fiber ä¸æ˜¯ä¸€ä¸ªæ–°çš„ä¸œè¥¿</h2><p><br></p><p><img src="/images/react-fiber/dos.jpg" alt><br><i>è¿™ä¸ªé»‘ä¹ä¹çš„ç•Œé¢åº”è¯¥å°±æ˜¯å¾®è½¯çš„ <code>DOS</code> æ“ä½œç³»ç»Ÿ</i></p><p><br></p><p>å¾®è½¯ <a href="https://zh.wikipedia.org/zh-cn/DOS" target="_blank" rel="noopener"><code>DOS</code></a> æ˜¯ä¸€ä¸ª<code>å•ä»»åŠ¡æ“ä½œç³»ç»Ÿ</code>, ä¹Ÿç§°ä¸ºâ€™å•å·¥æ“ä½œç³»ç»Ÿâ€˜. è¿™ç§æ“ä½œç³»ç»ŸåŒä¸€ä¸ªæ—¶é—´åªå…è®¸è¿è¡Œä¸€ä¸ªç¨‹åº. <a href="https://www.zhihu.com/people/s.invalid" target="_blank" rel="noopener">invalid s</a>åœ¨<a href="https://www.zhihu.com/question/319595914/answer/683541635" target="_blank" rel="noopener">ã€Šåœ¨æ²¡æœ‰GUIçš„æ—¶ä»£(åªæœ‰ä¸€ä¸ªæ–‡æœ¬ç•Œé¢ï¼‰ï¼Œäººä»¬æ˜¯æ€ä¹ˆè¿è¡Œå¤šä¸ªç¨‹åºçš„ï¼Ÿã€‹</a> çš„å›ç­”ä¸­å°†å…¶ç§°ä¸º: â€˜<strong>ä¸€ç§å‹æ ¹æ²¡æœ‰ä»»åŠ¡è°ƒåº¦çš„â€œæ®‹ç–¾â€æ“ä½œç³»ç»Ÿ</strong>â€˜.</p><p>åœ¨è¿™ç§ç³»ç»Ÿä¸­ï¼Œä½ æƒ³æ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼Œåªèƒ½ç­‰å¾…å‰ä¸€ä¸ªè¿›ç¨‹é€€å‡ºï¼Œç„¶åå†è½½å…¥ä¸€ä¸ªæ–°çš„è¿›ç¨‹ã€‚</p><p>ç›´åˆ° Windows 3.xï¼Œå®ƒæ‰æœ‰äº†çœŸæ­£æ„ä¹‰çš„è¿›ç¨‹è°ƒåº¦å™¨ï¼Œå®ç°äº†å¤šè¿›ç¨‹å¹¶å‘æ‰§è¡Œã€‚</p><blockquote><p>æ³¨æ„å¹¶å‘å’Œå¹¶è¡Œä¸æ˜¯åŒä¸€ä¸ªæ¦‚å¿µã€‚</p></blockquote><p><br></p><p>ç°ä»£æ“ä½œç³»ç»Ÿéƒ½æ˜¯<strong>å¤šä»»åŠ¡æ“ä½œç³»ç»Ÿ</strong>. è¿›ç¨‹çš„è°ƒåº¦ç­–ç•¥å¦‚æœæŒ‰ç…§CPUæ ¸å¿ƒæ•°æ¥åˆ’åˆ†ï¼Œå¯ä»¥åˆ†ä¸º<strong>å•å¤„ç†å™¨è°ƒåº¦</strong>å’Œ<strong>å¤šå¤„ç†å™¨è°ƒåº¦</strong>ã€‚æœ¬æ–‡åªå…³æ³¨çš„æ˜¯å•å¤„ç†å™¨è°ƒåº¦ï¼Œå› ä¸ºå®ƒå¯ä»¥ç±»æ¯”JavaScriptçš„è¿è¡Œæœºåˆ¶ã€‚</p><p><strong>ğŸ”´è¯´ç™½äº†ï¼Œä¸ºäº†å®ç°è¿›ç¨‹çš„å¹¶å‘ï¼Œæ“ä½œç³»ç»Ÿä¼šæŒ‰ç…§ä¸€å®šçš„è°ƒåº¦ç­–ç•¥ï¼Œå°†CPUçš„æ‰§è¡Œæƒåˆ†é…ç»™å¤šä¸ªè¿›ç¨‹ï¼Œå¤šä¸ªè¿›ç¨‹éƒ½æœ‰è¢«æ‰§è¡Œçš„æœºä¼šï¼Œè®©å®ƒä»¬äº¤æ›¿æ‰§è¡Œï¼Œå½¢æˆä¸€ç§â€œåŒæ—¶åœ¨è¿è¡Œâ€å‡è±¡, å› ä¸ºCPUé€Ÿåº¦å¤ªå¿«ï¼Œäººç±»æ ¹æœ¬æ„Ÿè§‰ä¸åˆ°ã€‚å®é™…ä¸Šåœ¨å•æ ¸çš„ç‰©ç†ç¯å¢ƒä¸‹åŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªç¨‹åºåœ¨è¿è¡Œ</strong>ã€‚</p><brk><p><img src="/images/react-fiber/longzhu.jpg" alt></p><p><br></p><p>è¿™è®©æˆ‘æƒ³èµ·äº†â€œé¾™ç â€ä¸­çš„åˆ†èº«æœ¯(å°æ—¶å€™çœ‹è¿‡ï¼Œè¯´é”™äº†åˆ«å–·)ï¼Œå®è´¨ä¸Šæ˜¯ä¸€ä¸ªäººï¼Œåªä¸è¿‡æ˜¯ä»–è¿åŠ¨é€Ÿåº¦å¤ªå¿«ï¼Œçœ‹èµ·æ¥å°±åƒåˆ†èº«äº†. è¿™å°±æ˜¯æ‰€è°“çš„<strong>å¹¶å‘(Concurrent)</strong>(å•å¤„ç†å™¨)ã€‚</p><p><br></p><p><img src="/images/react-fiber/naruto.jpg" alt></p><p><br></p><p>ç›¸æ¯”è€Œè¨€, ç«å½±å¿è€…ä¸­çš„åˆ†èº«æœ¯ï¼Œæ˜¯ç‰©ç†å­˜åœ¨çš„ï¼Œä»–ä»¬å¯ä»¥çœŸæ­£å®ç°åŒæ—¶å¤„ç†å¤šä¸ªä»»åŠ¡ï¼Œè¿™å°±æ˜¯<strong>å¹¶è¡Œ</strong>(ä¸¥æ ¼åœ°è®²è¿™æ˜¯<code>Master-Slave</code>æ¶æ„ï¼Œåˆ†èº«è™½ç„¶ç‰©ç†å­˜åœ¨ï¼Œä½†åº”è¯¥æ²¡æœ‰ç‹¬ç«‹çš„æ„å¿—)ã€‚</p><p>æ‰€ä»¥è¯´<strong>ğŸ”´å¹¶è¡Œå¯ä»¥æ˜¯å¹¶å‘ï¼Œè€Œå¹¶å‘ä¸ä¸€å®šæ˜¯å¹¶è¡Œï¼Œä¸¤ç§ä¸èƒ½åˆ’ç­‰å·, å¹¶è¡Œä¸€èˆ¬éœ€è¦ç‰©ç†å±‚é¢çš„æ”¯æŒ</strong>ã€‚ å…³äºå¹¶å‘å’Œå¹¶è¡Œï¼ŒGo ä¹‹çˆ¶ Rob Pike æœ‰ä¸€ä¸ªéå¸¸è‘—åçš„æ¼”è®²<a href="https://blog.golang.org/concurrency-is-not-parallelism" target="_blank" rel="noopener">Concurrency is not parallelism</a></p><p><br></p><p>æ‰¯è¿œäº†ï¼Œæ¥ä¸‹æ¥è¿›ç¨‹æ€ä¹ˆè°ƒåº¦å°±æ˜¯æ•™ç§‘ä¹¦çš„å†…å®¹äº†ã€‚å¦‚æœè¯»è€…åœ¨å¤§å­¦è®¤çœŸå­¦è¿‡<strong>æ“ä½œç³»ç»ŸåŸç†</strong>, ä½ å¯ä»¥å¾ˆå¿«ç†è§£ä»¥ä¸‹å‡ ç§å•å¤„ç†å™¨è¿›ç¨‹<strong>è°ƒåº¦ç­–ç•¥</strong>(æˆ‘å°±éšä¾¿ç§‘æ™®ä¸€ä¸‹ï¼Œç®—é€çš„, å¦‚æœä½ å¾ˆç†Ÿæ‚‰è¿™å—ï¼Œå¯ä»¥è·³è¿‡)ï¼š</p><p><br></p><p><strong>0ï¸âƒ£ å…ˆåˆ°å…ˆå¾—(First-Come-First-Served, FCFS)</strong></p><p>è¿™æ˜¯æœ€ç®€å•çš„è°ƒåº¦ç­–ç•¥, ç®€å•è¯´å°±æ˜¯<strong>æ²¡æœ‰è°ƒåº¦</strong>ã€‚è°å…ˆæ¥è°å°±å…ˆæ‰§è¡Œï¼Œæ‰§è¡Œå®Œæ¯•åå°±æ‰§è¡Œä¸‹ä¸€ä¸ªã€‚ä¸è¿‡å¦‚æœä¸­é—´æŸäº›è¿›ç¨‹å› ä¸ºI/Oé˜»å¡äº†ï¼Œè¿™äº›è¿›ç¨‹ä¼šæŒ‚èµ·ç§»å›å°±ç»ªé˜Ÿåˆ—(è¯´ç™½äº†å°±æ˜¯é‡æ–°æ’é˜Ÿ).</p><p><code>FCFS</code> ä¸Šé¢ <code>DOS</code> çš„å•ä»»åŠ¡æ“ä½œç³»ç»Ÿæ²¡æœ‰å¤ªå¤§çš„åŒºåˆ«ã€‚æ‰€ä»¥éå¸¸å¥½ç†è§£ï¼Œå› ä¸ºç”Ÿæ´»ä¸­åˆ°å¤„æ˜¯è¿™æ ·çš„ä¾‹å­:ã€‚</p><ul><li><p><strong>FCFS å¯¹<code>çŸ­è¿›ç¨‹</code>ä¸åˆ©</strong>ã€‚ çŸ­è¿›ç¨‹å³æ‰§è¡Œæ—¶é—´éå¸¸çŸ­çš„è¿›ç¨‹ï¼Œå¯ä»¥ç”¨é¥­å ‚æ’é˜Ÿæ¥æ¯”å–»: <em>åœ¨é¥­å ‚æ’é˜Ÿæ‰“é¥­çš„æ—¶å€™ï¼Œæœ€çƒ¦é‚£äº›ä¸€ä¸ªäººæ‰“åŒ…å¥½å¥½å‡ ä»½çš„äººï¼Œè¿™äº›äººå°±åƒ<code>é•¿è¿›ç¨‹</code>ä¸€æ ·ï¼Œéœ¸å ç€CPUèµ„æºï¼Œåé¢æ’é˜Ÿåªæ‰“ä¸€ä»½çš„äººä¼šè§‰å¾—å¾ˆåƒäºï¼Œæ‰“ä¸€ä»½çš„äººä¼šè§‰å¾—ä»–ä»¬ä¼˜å…ˆçº§åº”è¯¥æ›´é«˜ï¼Œæ¯•ç«Ÿä»–ä»¬èŠ±çš„æ—¶é—´å¾ˆçŸ­ï¼Œåæ­£ä½ æ‰“åŒ…é‚£ä¹ˆå¤šä»½å†ç­‰ä¸€ä¼šä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œä½•å¿…è®©åé¢é‚£ä¹ˆå¤šäººç­‰è¿™ä¹ˆä¹…â€¦</em></p></li><li><p><strong>FCFS å¯¹<code>I/Oå¯†é›†</code>ä¸åˆ©</strong>ã€‚I/Oå¯†é›†å‹è¿›ç¨‹(è¿™é‡Œç‰¹æŒ‡åŒæ­¥I/O)åœ¨è¿›è¡ŒI/Oæ“ä½œæ—¶ï¼Œä¼šé˜»å¡ä¼‘çœ ï¼Œè¿™ä¼šå¯¼è‡´è¿›ç¨‹é‡æ–°è¢«æ”¾å…¥å°±ç»ªé˜Ÿåˆ—ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡è¢«å® å¹¸ã€‚ å¯ä»¥ç±»æ¯”ZFéƒ¨é—¨åŠä¸šåŠ¡: <em>å‡è®¾ CPU ä¸€ä¸ªçª—å£ã€I/O ä¸€ä¸ªçª—å£ã€‚åœ¨CPUçª—å£å¥½ä¸å®¹æ˜“æ’åˆ°ä½ äº†ï¼Œè¿™æ—¶å€™å‘ç°ä¸€ä¸ªä¸ç¬¦åˆæ¡ä»¶æˆ–è€…æ¼åŠäº†, éœ€è¦å»I/Oæä¸€ä¸‹ï¼ŒOk å» I/Oçª—å£æ’é˜Ÿï¼ŒI/Oæ‰§è¡Œå®Œäº†ï¼Œåˆ°CPUçª—å£åˆå¾—é‡æ–°æ’é˜Ÿã€‚å¯¹äºè¿™äº›ä¸¢ä¸‰è½å››çš„äººå¾ˆä¸å…¬å¹³â€¦</em></p></li></ul><p>æ‰€ä»¥ FCFS è¿™ç§åŸå§‹çš„ç­–ç•¥åœ¨å•å¤„ç†å™¨è¿›ç¨‹è°ƒåº¦ä¸­å¹¶ä¸å—æ¬¢è¿ã€‚</p><p><br></p><p><strong>1ï¸âƒ£ è½®è½¬</strong></p><p>è¿™æ˜¯ä¸€ç§åŸºäºæ—¶é’Ÿçš„<strong>æŠ¢å ç­–ç•¥</strong>ï¼Œè¿™ä¹Ÿæ˜¯æŠ¢å ç­–ç•¥ä¸­æœ€ç®€å•çš„ä¸€ç§: <strong>å…¬å¹³åœ°ç»™æ¯ä¸€ä¸ªè¿›ç¨‹ä¸€å®šçš„æ‰§è¡Œæ—¶é—´ï¼Œå½“æ—¶é—´æ¶ˆè€—å®Œæ¯•æˆ–é˜»å¡ï¼Œæ“ä½œç³»ç»Ÿå°±ä¼šè°ƒåº¦å…¶ä»–è¿›ç¨‹ï¼Œå°†æ‰§è¡ŒæƒæŠ¢å è¿‡æ¥</strong>ã€‚</p><blockquote><p><strong>å†³ç­–æ¨¡å¼</strong>: <code>æŠ¢å ç­–ç•¥</code>ç›¸å¯¹åº”çš„æœ‰<code>éæŠ¢å ç­–ç•¥</code>ï¼ŒéæŠ¢å ç­–ç•¥æŒ‡çš„æ˜¯è®©è¿›ç¨‹è¿è¡Œç›´åˆ°ç»“æŸã€é˜»å¡(å¦‚I/Oæˆ–ç¡çœ )ã€æˆ–è€…ä¸»åŠ¨è®©å‡ºæ§åˆ¶æƒï¼›æŠ¢å ç­–ç•¥æ”¯æŒä¸­æ–­æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ï¼Œå°†ä¸»åŠ¨æƒæŒæ¡åœ¨æ“ä½œç³»ç»Ÿè¿™é‡Œï¼Œä¸è¿‡é€šå¸¸å¼€é”€ä¼šæ¯”è¾ƒå¤§ã€‚</p></blockquote><p>è¿™ç§è°ƒåº¦ç­–ç•¥çš„è¦ç‚¹æ˜¯<strong>ç¡®å®šåˆé€‚çš„æ—¶é—´ç‰‡é•¿åº¦</strong>: å¤ªé•¿äº†ï¼Œé•¿è¿›ç¨‹éœ¸å å¤ªä¹…èµ„æºï¼Œå…¶ä»–è¿›ç¨‹ä¼šå¾—ä¸åˆ°å“åº”(ç­‰å¾…æ‰§è¡Œæ—¶é—´è¿‡é•¿)ï¼Œè¿™æ—¶å€™å°±è·Ÿä¸Šè¿°çš„ <code>FCFS</code> æ²¡ä»€ä¹ˆåŒºåˆ«äº†;  å¤ªçŸ­äº†ä¹Ÿä¸å¥½ï¼Œå› ä¸ºè¿›ç¨‹æŠ¢å å’Œåˆ‡æ¢éƒ½æ˜¯éœ€è¦æˆæœ¬çš„, è€Œä¸”æˆæœ¬ä¸ä½ï¼Œæ—¶é—´ç‰‡å¤ªçŸ­ï¼Œæ—¶é—´å¯èƒ½éƒ½æµªè´¹åœ¨ä¸Šä¸‹æ–‡åˆ‡æ¢ä¸Šäº†ï¼Œå¯¼è‡´è¿›ç¨‹å¹²ä¸äº†ä»€ä¹ˆå®äº‹ã€‚</p><p>å› æ­¤<strong>æ—¶é—´ç‰‡çš„é•¿åº¦æœ€å¥½ç¬¦åˆå¤§éƒ¨åˆ†è¿›ç¨‹å®Œæˆä¸€æ¬¡å…¸å‹äº¤äº’æ‰€éœ€çš„æ—¶é—´</strong>.</p><p>è½®è½¬ç­–ç•¥éå¸¸å®¹æ˜“ç†è§£ï¼Œåªä¸è¿‡ç¡®å®šæ—¶é—´ç‰‡é•¿åº¦éœ€è¦ä¼¤ç‚¹è„‘ç­‹ï¼›å¦å¤–å’Œ<code>FCFS</code>ä¸€æ ·ï¼Œè½®è½¬ç­–ç•¥å¯¹I/Oè¿›ç¨‹è¿˜æ˜¯ä¸å…¬å¹³ã€‚</p><p><br></p><p><strong>2ï¸âƒ£ æœ€çŸ­è¿›ç¨‹ä¼˜å…ˆ(Shortest Process Next, SPN)</strong></p><p>ä¸Šé¢è¯´äº†<code>å…ˆåˆ°å…ˆå¾—</code>ç­–ç•¥å¯¹<code>çŸ­è¿›ç¨‹</code>ä¸å…¬å¹³ï¼Œ<code>æœ€çŸ­è¿›ç¨‹ä¼˜å…ˆ</code>ç´¢æ€§å°±è®©â€™æœ€çŸ­â€™çš„è¿›ç¨‹ä¼˜å…ˆæ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´: <strong>æŒ‰ç…§è¿›ç¨‹çš„é¢„ä¼°æ‰§è¡Œæ—¶é—´å¯¹è¿›ç¨‹è¿›è¡Œä¼˜å…ˆçº§æ’åºï¼Œå…ˆæ‰§è¡Œå®ŒçŸ­è¿›ç¨‹ï¼Œåæ‰§è¡Œé•¿è¿›ç¨‹ã€‚è¿™æ˜¯ä¸€ç§éæŠ¢å ç­–ç•¥</strong>ã€‚</p><p>è¿™æ ·å¯ä»¥è®©çŸ­è¿›ç¨‹èƒ½å¾—åˆ°è¾ƒå¿«çš„å“åº”ã€‚ä½†æ˜¯æ€ä¹ˆè·å–æˆ–è€…<strong>è¯„ä¼°è¿›ç¨‹æ‰§è¡Œæ—¶é—´</strong>å‘¢ï¼Ÿä¸€æ˜¯è®©ç¨‹åºçš„æä¾›è€…æä¾›ï¼Œè¿™ä¸å¤ªé è°±ï¼›äºŒæ˜¯ç”±æ“ä½œç³»ç»Ÿæ¥æ”¶é›†è¿›ç¨‹è¿è¡Œæ•°æ®ï¼Œå¹¶å¯¹å®ƒä»¬è¿›ç¨‹ç»Ÿè®¡åˆ†æã€‚ä¾‹å¦‚æœ€ç®€å•çš„æ˜¯è®¡ç®—å®ƒä»¬çš„å¹³å‡è¿è¡Œæ—¶é—´ã€‚ä¸ç®¡æ€ä¹ˆè¯´éƒ½æ¯”ä¸Šé¢ä¸¤ç§ç­–ç•¥è¦å¤æ‚ä¸€ç‚¹ã€‚</p><p><code>SPN</code> çš„ç¼ºé™·æ˜¯: å¦‚æœç³»ç»Ÿæœ‰å¤§é‡çš„çŸ­è¿›ç¨‹ï¼Œé‚£ä¹ˆé•¿è¿›ç¨‹å¯èƒ½ä¼šé¥¥é¥¿å¾—ä¸åˆ°å“åº”ã€‚</p><p>å¦å¤–å› ä¸ºå®ƒä¸æ˜¯æŠ¢å æ€§ç­–ç•¥, å°½ç®¡ç°åœ¨çŸ­è¿›ç¨‹å¯ä»¥å¾—åˆ°æ›´å¤šçš„æ‰§è¡Œæœºä¼šï¼Œä½†æ˜¯è¿˜æ˜¯æ²¡æœ‰è§£å†³ <code>FCFS</code> çš„é—®é¢˜: ä¸€æ—¦é•¿è¿›ç¨‹å¾—åˆ°CPUèµ„æºï¼Œå¾—ç­‰å®ƒæ‰§è¡Œå®Œï¼Œå¯¼è‡´åé¢çš„è¿›ç¨‹å¾—ä¸åˆ°å“åº”ã€‚</p><p><br></p><p><strong>3ï¸âƒ£ æœ€çŸ­å‰©ä½™æ—¶é—´(Shortest Remaining Time, SRT)</strong></p><p><strong>SRT è¿›ä¸€æ­¥ä¼˜åŒ–äº†SPNï¼Œå¢åŠ äº†æŠ¢å æœºåˆ¶</strong>ã€‚åœ¨ SPN çš„åŸºç¡€ä¸Šï¼Œå½“ä¸€ä¸ªè¿›ç¨‹æ·»åŠ åˆ°å°±ç»ªé˜Ÿåˆ—æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šæ¯”è¾ƒ<em>åˆšæ·»åŠ çš„æ–°è¿›ç¨‹</em>å’Œ<em>å½“å‰æ­£åœ¨æ‰§è¡Œçš„è€è¿›ç¨‹</em>çš„â€˜å‰©ä½™æ—¶é—´â€™ï¼Œå¦‚æœæ–°è¿›ç¨‹å‰©ä½™æ—¶é—´æ›´çŸ­ï¼Œæ–°è¿›ç¨‹å°±ä¼šæŠ¢å è€è¿›ç¨‹ã€‚</p><p>ç›¸æ¯”è½®è½¬çš„æŠ¢å ï¼ŒSRT æ²¡æœ‰ä¸­æ–­å¤„ç†çš„å¼€é”€ã€‚ä½†æ˜¯åœ¨ SPN çš„åŸºç¡€ä¸Šï¼Œæ“ä½œç³»ç»Ÿéœ€è¦è®°å½•è¿›ç¨‹çš„å†å²æ‰§è¡Œæ—¶é—´ï¼Œè¿™æ˜¯æ–°å¢çš„å¼€é”€ã€‚<strong>å¦å¤–é•¿è¿›ç¨‹é¥¥é¥¿é—®é¢˜è¿˜æ˜¯æ²¡æœ‰è§£å†³</strong>ã€‚</p><p><br></p><p><strong>4ï¸âƒ£ æœ€é«˜å“åº”æ¯”ä¼˜å…ˆ(HRRN)</strong></p><p><strong>ä¸ºäº†è§£å†³é•¿è¿›ç¨‹é¥¥é¥¿é—®é¢˜ï¼ŒåŒæ—¶æé«˜è¿›ç¨‹çš„å“åº”é€Ÿç‡</strong>ã€‚è¿˜æœ‰ä¸€ç§<code>æœ€é«˜å“åº”æ¯”ä¼˜å…ˆçš„</code>ç­–ç•¥ï¼Œé¦–å…ˆäº†è§£ä»€ä¹ˆæ˜¯å“åº”æ¯”:</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">å“åº”æ¯” = ï¼ˆç­‰å¾…æ‰§è¡Œæ—¶é—´ + è¿›ç¨‹æ‰§è¡Œæ—¶é—´ï¼‰ / è¿›ç¨‹æ‰§è¡Œæ—¶é—´</span><br></pre></td></tr></table></figure><p><strong>è¿™ç§ç­–ç•¥ä¼šé€‰æ‹©å“åº”æ¯”æœ€é«˜çš„è¿›ç¨‹ä¼˜å…ˆæ‰§è¡Œ</strong>ï¼š</p><ul><li>å¯¹äºçŸ­è¿›ç¨‹æ¥è¯´ï¼Œå› ä¸ºæ‰§è¡Œæ—¶é—´å¾ˆçŸ­ï¼Œåˆ†æ¯å¾ˆå°ï¼Œæ‰€ä»¥å“åº”æ¯”æ¯”è¾ƒé«˜ï¼Œä¼šè¢«ä¼˜å…ˆæ‰§è¡Œ</li><li>å¯¹äºé•¿è¿›ç¨‹æ¥è¯´ï¼Œæ‰§è¡Œæ—¶é—´é•¿ï¼Œä¸€å¼€å§‹å“åº”æ¯”å°ï¼Œä½†æ˜¯éšç€ç­‰å¾…æ—¶é—´å¢é•¿ï¼Œå®ƒçš„ä¼˜å…ˆçº§ä¼šè¶Šæ¥è¶Šé«˜ï¼Œæœ€ç»ˆå¯ä»¥è¢«æ‰§è¡Œ</li></ul><p><br></p><p><strong>5ï¸âƒ£ åé¦ˆæ³•</strong></p><p>SPNã€SRTã€HRRNéƒ½éœ€è¦å¯¹è¿›ç¨‹æ—¶é—´è¿›è¡Œè¯„ä¼°å’Œç»Ÿè®¡ï¼Œå®ç°æ¯”è¾ƒå¤æ‚ä¸”éœ€è¦ä¸€å®šå¼€é”€ã€‚è€Œåé¦ˆæ³•é‡‡å–çš„æ˜¯<strong>äº‹ååé¦ˆ</strong>çš„æ–¹å¼ã€‚è¿™ç§ç­–ç•¥ä¸‹: <strong>æ¯ä¸ªè¿›ç¨‹ä¸€å¼€å§‹éƒ½æœ‰ç›¸åŒçš„ä¼˜å…ˆçº§ï¼Œæ¯æ¬¡è¢«æŠ¢å (éœ€è¦é…åˆå…¶ä»–æŠ¢å ç­–ç•¥ä½¿ç”¨ï¼Œå¦‚è½®è½¬)ï¼Œä¼˜å…ˆçº§å°±ä¼šé™ä½ä¸€çº§ã€‚å› æ­¤é€šå¸¸å®ƒä¼šæ ¹æ®ä¼˜å…ˆçº§åˆ’åˆ†å¤šä¸ªé˜Ÿåˆ—</strong>ã€‚</p><p>ä¸¾ä¸ªä¾‹å­: </p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">é˜Ÿåˆ—1</span><br><span class="line">é˜Ÿåˆ—2</span><br><span class="line">...</span><br><span class="line">é˜Ÿåˆ—N</span><br></pre></td></tr></table></figure><p>æ–°å¢çš„ä»»åŠ¡ä¼šæ¨å…¥<code>é˜Ÿåˆ—1</code>ï¼Œ<code>é˜Ÿåˆ—1</code>ä¼šæŒ‰ç…§<code>è½®è½¬ç­–ç•¥</code>ä»¥ä¸€ä¸ªæ—¶é—´ç‰‡ä¸ºå•ä½è¿›è¡Œè°ƒåº¦ã€‚çŸ­è¿›ç¨‹å¯ä»¥å¾ˆå¿«å¾—åˆ°å“åº”ï¼Œè€Œå¯¹äºé•¿è¿›ç¨‹å¯èƒ½ä¸€ä¸ªæ—¶é—´ç‰‡å¤„ç†ä¸å®Œï¼Œå°±ä¼šè¢«æŠ¢å ï¼Œæ”¾å…¥<code>é˜Ÿåˆ—2</code>ã€‚</p><p><code>é˜Ÿåˆ—2</code>ä¼šåœ¨<code>é˜Ÿåˆ—1</code>ä»»åŠ¡æ¸…ç©ºåè¢«æ‰§è¡Œï¼Œæœ‰æ—¶å€™ä½ä¼˜å…ˆçº§é˜Ÿåˆ—å¯èƒ½ä¼šç­‰å¾…å¾ˆä¹…æ‰è¢«æ‰§è¡Œï¼Œæ‰€ä»¥ä¸€èˆ¬ä¼šç»™äºˆä¸€å®šçš„è¡¥å¿ï¼Œä¾‹å¦‚å¢åŠ æ‰§è¡Œæ—¶é—´ï¼Œæ‰€ä»¥<code>é˜Ÿåˆ—2</code>çš„è½®è½¬æ—¶é—´ç‰‡é•¿åº¦æ˜¯2ã€‚</p><p>åé¦ˆæ³•ä»ç„¶å¯èƒ½å¯¼è‡´é•¿è¿›ç¨‹é¥¥é¥¿ï¼Œæ‰€ä»¥æ“ä½œç³»ç»Ÿå¯ä»¥ç»Ÿè®¡é•¿è¿›ç¨‹çš„ç­‰å¾…æ—¶é—´ï¼Œå½“ç­‰å¾…æ—¶é—´è¶…è¿‡ä¸€å®šçš„é˜ˆå€¼ï¼Œå¯ä»¥é€‰æ‹©æé«˜å®ƒä»¬çš„ä¼˜å…ˆçº§ã€‚</p><p><br><br><br></p><p><img src="/images/react-fiber/process-schedule.png" alt></p><p>æ²¡æœ‰ä¸€ç§è°ƒåº¦ç­–ç•¥æ˜¯ä¸‡èƒ½çš„, å®ƒéœ€è¦è€ƒè™‘å¾ˆå¤šå› ç´ :</p><ul><li>å“åº”é€Ÿç‡ã€‚è¿›ç¨‹ç­‰å¾…è¢«æ‰§è¡Œçš„æ—¶é—´</li><li>å…¬å¹³æ€§ã€‚å…¼é¡¾çŸ­è¿›ç¨‹ã€é•¿è¿›ç¨‹ã€I/Oè¿›ç¨‹</li></ul><p>è¿™ä¸¤è€…åœ¨æŸäº›æƒ…å†µä¸‹æ˜¯å¯¹ç«‹çš„ï¼Œæé«˜äº†å“åº”ï¼Œå¯èƒ½ä¼šå‡ä½å…¬å¹³æ€§ï¼Œå¯¼è‡´é¥¥é¥¿ã€‚çŸ­è¿›ç¨‹ã€é•¿è¿›ç¨‹ã€I/Oè¿›ç¨‹ä¹‹é—´è¦å–å¾—å¹³è¡¡ä¹Ÿéå¸¸éš¾ã€‚</p><p>ä¸Šé¢è¿™äº›çŸ¥è¯†å¯¹æœ¬æ–‡æ¥è¯´å·²ç»è¶³å¤Ÿäº†ï¼Œç°å®ä¸–ç•Œæ“ä½œç³»ç»Ÿçš„è¿›ç¨‹è°ƒåº¦ç®—æ³•æ¯”æ•™ç§‘ä¹¦ä¸Šè¯´çš„è¦å¤æ‚çš„å¤šï¼Œæœ‰å…´è¶£è¯»è€…å¯ä»¥å»ç ”ç©¶ä¸€ä¸‹ <code>Linux</code> ç›¸å…³çš„è¿›ç¨‹è°ƒåº¦ç®—æ³•ï¼Œè¿™æ–¹é¢çš„èµ„æ–™ä¹Ÿéå¸¸å¤š, ä¾‹å¦‚<a href="https://blog.csdn.net/gatieme/article/details/51456569" target="_blank" rel="noopener">ã€ŠLinuxè¿›ç¨‹è°ƒåº¦ç­–ç•¥çš„å‘å±•å’Œæ¼”å˜ã€‹</a>ã€‚</p><p><br><br><br></p><h2 id="ç±»æ¯”æµè§ˆå™¨javascriptæ‰§è¡Œç¯å¢ƒ"><a href="#ç±»æ¯”æµè§ˆå™¨javascriptæ‰§è¡Œç¯å¢ƒ" class="headerlink" title="ç±»æ¯”æµè§ˆå™¨JavaScriptæ‰§è¡Œç¯å¢ƒ"></a>ç±»æ¯”æµè§ˆå™¨JavaScriptæ‰§è¡Œç¯å¢ƒ</h2><p><br></p><p><img src="/images/react-fiber/singleroad.jpg" alt><br><i>JavaScript å°±åƒå•è¡Œé“</i></p><p><br></p><p>JavaScript æ˜¯<a href="https://juejin.im/post/5a6547d0f265da3e283a1df7" target="_blank" rel="noopener">å•çº¿ç¨‹è¿è¡Œ</a>çš„ï¼Œè€Œä¸”åœ¨æµè§ˆå™¨ç¯å¢ƒå±äº‹éå¸¸å¤šï¼Œå®ƒè¦è´Ÿè´£é¡µé¢çš„JSè§£æå’Œæ‰§è¡Œã€ç»˜åˆ¶ã€äº‹ä»¶å¤„ç†ã€é™æ€èµ„æºåŠ è½½å’Œå¤„ç†, è¿™äº›ä»»åŠ¡å¯ä»¥ç±»æ¯”ä¸Šé¢â€™è¿›ç¨‹â€˜ã€‚</p><blockquote><p>è¿™é‡Œç‰¹æŒ‡Javascript å¼•æ“æ˜¯å•çº¿ç¨‹è¿è¡Œçš„ã€‚ ä¸¥æ ¼æ¥è¯´ï¼ŒJavascript å¼•æ“å’Œé¡µé¢æ¸²æŸ“å¼•æ“åœ¨åŒä¸€ä¸ªæ¸²æŸ“çº¿ç¨‹ï¼ŒGUI æ¸²æŸ“å’Œ Javascriptæ‰§è¡Œ ä¸¤è€…æ˜¯äº’æ–¥çš„. å¦å¤–å¼‚æ­¥ I/O æ“ä½œåº•å±‚å®é™…ä¸Šå¯èƒ½æ˜¯å¤šçº¿ç¨‹çš„åœ¨é©±åŠ¨ã€‚</p></blockquote><p><img src="/images/react-fiber/frame-full.jpg" alt><br><i>å›¾ç‰‡æ¥æº: <a href="https://developers.google.com/web/fundamentals/performance/rendering" target="_blank" rel="noopener">Rendering Performance</a></i></p><p><strong>å®ƒåªæ˜¯ä¸€ä¸ªâ€™JavaScriptâ€™ï¼ŒåŒæ—¶åªèƒ½åšä¸€ä»¶äº‹æƒ…ï¼Œè¿™ä¸ªå’Œ <code>DOS</code> çš„å•ä»»åŠ¡æ“ä½œç³»ç»Ÿä¸€æ ·çš„ï¼Œäº‹æƒ…åªèƒ½ä¸€ä»¶ä¸€ä»¶çš„å¹²ã€‚è¦æ˜¯å‰é¢æœ‰ä¸€ä¸ªå‚»å‰ä»»åŠ¡é•¿æœŸéœ¸å CPUï¼Œåé¢ä»€ä¹ˆäº‹æƒ…éƒ½å¹²ä¸äº†ï¼Œæµè§ˆå™¨ä¼šå‘ˆç°å¡æ­»çš„çŠ¶æ€ï¼Œè¿™æ ·çš„ç”¨æˆ·ä½“éªŒå°±ä¼šéå¸¸å·®</strong>ã€‚</p><p><br></p><p><strong>å¯¹äºâ€™å‰ç«¯æ¡†æ¶â€˜æ¥è¯´ï¼Œè§£å†³è¿™ç§é—®é¢˜æœ‰ä¸‰ä¸ªæ–¹å‘</strong>:</p><ul><li>1ï¸âƒ£ ä¼˜åŒ–æ¯ä¸ªä»»åŠ¡ï¼Œè®©å®ƒæœ‰å¤šå¿«å°±å¤šå¿«ã€‚æŒ¤å‹CPUè¿ç®—é‡</li><li>2ï¸âƒ£ å¿«é€Ÿå“åº”ç”¨æˆ·ï¼Œè®©ç”¨æˆ·è§‰å¾—å¤Ÿå¿«ï¼Œä¸èƒ½é˜»å¡ç”¨æˆ·çš„äº¤äº’</li><li>3ï¸âƒ£ å°è¯• Worker å¤šçº¿ç¨‹</li></ul><p>Vue é€‰æ‹©çš„æ˜¯ç¬¬1ï¸âƒ£, å› ä¸ºå¯¹äºVueæ¥è¯´ï¼Œä½¿ç”¨<code>æ¨¡æ¿</code>è®©å®ƒæœ‰äº†å¾ˆå¤šä¼˜åŒ–çš„ç©ºé—´ï¼Œé…åˆå“åº”å¼æœºåˆ¶å¯ä»¥è®©Vueå¯ä»¥ç²¾ç¡®åœ°è¿›è¡ŒèŠ‚ç‚¹æ›´æ–°, è¯»è€…å¯ä»¥å»çœ‹ä¸€ä¸‹<a href="https://www.yuque.com/vueconf/2019/gwn1z0" target="_blank" rel="noopener">ä»Šå¹´Vue Conf å°¤é›¨æºªçš„æ¼”è®²</a>ï¼Œéå¸¸æ£’!ï¼›è€Œ React é€‰æ‹©äº†2ï¸âƒ£ ã€‚å¯¹äºWorker å¤šçº¿ç¨‹æ¸²æŸ“æ–¹æ¡ˆä¹Ÿæœ‰äººå°è¯•ï¼Œè¦ä¿è¯çŠ¶æ€å’Œè§†å›¾çš„ä¸€è‡´æ€§ç›¸å½“éº»çƒ¦ã€‚</p><p><br></p><p>React ä¸ºä»€ä¹ˆè¦å¼•å…¥ Fiber æ¶æ„ï¼Ÿ çœ‹çœ‹ä¸‹é¢çš„ç«ç„°å›¾ï¼Œè¿™æ˜¯React V15 ä¸‹é¢çš„ä¸€ä¸ªåˆ—è¡¨æ¸²æŸ“èµ„æºæ¶ˆè€—æƒ…å†µã€‚æ•´ä¸ªæ¸²æŸ“èŠ±è´¹äº†130ms, <strong>ğŸ”´åœ¨è¿™é‡Œé¢ React ä¼šé€’å½’æ¯”å¯¹VirtualDOMæ ‘ï¼Œæ‰¾å‡ºéœ€è¦å˜åŠ¨çš„èŠ‚ç‚¹ï¼Œç„¶ååŒæ­¥æ›´æ–°å®ƒä»¬, ä¸€æ°”å‘µæˆã€‚è¿™ä¸ªè¿‡ç¨‹ React ç§°ä¸º <code>Reconcilation</code>(ä¸­æ–‡å¯ä»¥è¯‘ä¸º<code>åè°ƒ</code>)</strong>.</p><p><br></p><p><img src="/images/react-fiber/perf.png" alt></p><p><br></p><p>åœ¨ Reconcilation æœŸé—´ï¼ŒReact ä¼šéœ¸å ç€æµè§ˆå™¨èµ„æºï¼Œä¸€åˆ™ä¼šå¯¼è‡´ç”¨æˆ·è§¦å‘çš„äº‹ä»¶å¾—ä¸åˆ°å“åº”, äºŒåˆ™ä¼šå¯¼è‡´æ‰å¸§ï¼Œç”¨æˆ·å¯ä»¥æ„ŸçŸ¥åˆ°è¿™äº›å¡é¡¿ã€‚</p><p>è¿™æ ·è¯´ï¼Œä½ å¯èƒ½æ²¡åŠæ³•ä½“ä¼šåˆ°ï¼Œé€šè¿‡ä¸‹é¢ä¸¤ä¸ªå›¾ç‰‡æ¥ä½“ä¼šä¸€ä¸‹(<em>å›¾ç‰‡æ¥æºäºï¼š<a href="https://twitter.com/dan_abramov" target="_blank" rel="noopener">Dan Abramov</a> çš„ <a href="https://reactjs.org/blog/2018/03/01/sneak-peek-beyond-react-16.html" target="_blank" rel="noopener">Beyond React 16</a> æ¼”è®², æ¨èçœ‹ä¸€ä¸‹ğŸ‘. å¦å¤–éå¸¸æ„Ÿè°¢<a href="https://www.zhihu.com/people/BlackGanglion/activities" target="_blank" rel="noopener">æ·¡è‹</a> å°†ä¸€ä¸ª<a href="https://codesandbox.io/s/koyz664q35" target="_blank" rel="noopener">ç±»ä¼¼çš„DEMO åˆ†äº«åœ¨äº† CodeSandbox</a>ä¸ŠğŸ‰ï¼Œå¤§å®¶è‡ªè¡Œä½“éªŒ</em>):</p><p><br></p><p>åŒæ­¥æ¨¡å¼ä¸‹çš„ React:</p><p><img src="/images/react-fiber/sync-mode.gif" alt></p><p><br></p><p>ä¼˜åŒ–åçš„ <code>Concurrent</code> æ¨¡å¼ä¸‹çš„ React:</p><p><img src="/images/react-fiber/concurrent-mode.gif" alt></p><p><br></p><p>React çš„ Reconcilation æ˜¯CPUå¯†é›†å‹çš„æ“ä½œ, å®ƒå°±ç›¸å½“äºæˆ‘ä»¬ä¸Šé¢è¯´çš„â€™é•¿è¿›ç¨‹â€˜ã€‚æ‰€ä»¥åˆè¡·å’Œè¿›ç¨‹è°ƒåº¦ä¸€æ ·ï¼Œæˆ‘ä»¬è¦è®©é«˜ä¼˜å…ˆçº§çš„è¿›ç¨‹æˆ–è€…çŸ­è¿›ç¨‹ä¼˜å…ˆè¿è¡Œï¼Œä¸èƒ½è®©é•¿è¿›ç¨‹é•¿æœŸéœ¸å èµ„æºã€‚</p><p>æ‰€ä»¥React æ˜¯æ€ä¹ˆä¼˜åŒ–çš„ï¼Ÿ åˆ’é‡ç‚¹ï¼Œ <strong>ğŸ”´ä¸ºäº†ç»™ç”¨æˆ·åˆ¶é€ ä¸€ç§åº”ç”¨å¾ˆå¿«çš„â€™å‡è±¡â€™ï¼Œæˆ‘ä»¬ä¸èƒ½è®©ä¸€ä¸ªç¨‹åºé•¿æœŸéœ¸å ç€èµ„æº. ä½ å¯ä»¥å°†æµè§ˆå™¨çš„æ¸²æŸ“ã€å¸ƒå±€ã€ç»˜åˆ¶ã€èµ„æºåŠ è½½(ä¾‹å¦‚HTMLè§£æ)ã€äº‹ä»¶å“åº”ã€è„šæœ¬æ‰§è¡Œè§†ä½œæ“ä½œç³»ç»Ÿçš„â€™è¿›ç¨‹â€™ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡æŸäº›è°ƒåº¦ç­–ç•¥åˆç†åœ°åˆ†é…CPUèµ„æºï¼Œä»è€Œæé«˜æµè§ˆå™¨çš„ç”¨æˆ·å“åº”é€Ÿç‡, åŒæ—¶å…¼é¡¾ä»»åŠ¡æ‰§è¡Œæ•ˆç‡</strong>ã€‚</p><p><br></p><p><strong>ğŸ”´æ‰€ä»¥ React é€šè¿‡Fiber æ¶æ„ï¼Œè®©è‡ªå·±çš„Reconcilation è¿‡ç¨‹å˜æˆå¯è¢«ä¸­æ–­ã€‚ â€˜é€‚æ—¶â€™åœ°è®©å‡ºCPUæ‰§è¡Œæƒï¼Œé™¤äº†å¯ä»¥è®©æµè§ˆå™¨åŠæ—¶åœ°å“åº”ç”¨æˆ·çš„äº¤äº’ï¼Œè¿˜æœ‰å…¶ä»–å¥½å¤„</strong>:</p><ul><li>ä¸å…¶ä¸€æ¬¡æ€§æ“ä½œå¤§é‡ DOM èŠ‚ç‚¹ç›¸æ¯”, åˆ†æ‰¹å»¶æ—¶å¯¹DOMè¿›è¡Œæ“ä½œï¼Œå¯ä»¥å¾—åˆ°æ›´å¥½çš„ç”¨æˆ·ä½“éªŒã€‚è¿™ä¸ªåœ¨<a href="https://juejin.im/post/5d76f469f265da039a28aff7#heading-1" target="_blank" rel="noopener">ã€Šã€Œå‰ç«¯è¿›é˜¶ã€é«˜æ€§èƒ½æ¸²æŸ“åä¸‡æ¡æ•°æ®(æ—¶é—´åˆ†ç‰‡)ã€‹</a> ä»¥åŠå¸å¾’æ­£ç¾çš„<a href="https://zhuanlan.zhihu.com/p/37095662" target="_blank" rel="noopener">ã€ŠReact Fiberæ¶æ„ã€‹</a> éƒ½åšäº†ç›¸å…³å®éªŒ</li><li>å¸å¾’æ­£ç¾åœ¨<a href="https://zhuanlan.zhihu.com/p/37095662" target="_blank" rel="noopener">ã€ŠReact Fiberæ¶æ„ã€‹</a> ä¹Ÿæåˆ°ï¼š<strong>ğŸ”´ç»™æµè§ˆå™¨ä¸€ç‚¹å–˜æ¯çš„æœºä¼šï¼Œä»–ä¼šå¯¹ä»£ç è¿›è¡Œç¼–è¯‘ä¼˜åŒ–ï¼ˆJITï¼‰åŠè¿›è¡Œçƒ­ä»£ç ä¼˜åŒ–ï¼Œæˆ–è€…å¯¹reflowè¿›è¡Œä¿®æ­£</strong>.</li></ul><p><br></p><p>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆReact éœ€è¦ Fiber ğŸ˜ã€‚</p><p><br></p><h2 id="ä½•ä¸º-fiber"><a href="#ä½•ä¸º-fiber" class="headerlink" title="ä½•ä¸º Fiber"></a>ä½•ä¸º Fiber</h2><p>å¯¹äº React æ¥è¯´ï¼ŒFiber å¯ä»¥ä»ä¸¤ä¸ªè§’åº¦ç†è§£:</p><p><br></p><h3 id="1-ä¸€ç§æµç¨‹æ§åˆ¶åŸè¯­"><a href="#1-ä¸€ç§æµç¨‹æ§åˆ¶åŸè¯­" class="headerlink" title="1. ä¸€ç§æµç¨‹æ§åˆ¶åŸè¯­"></a>1. ä¸€ç§æµç¨‹æ§åˆ¶åŸè¯­</h3><p>Fiber ä¹Ÿç§°<a href="https://www.liaoxuefeng.com/wiki/897692888725344/923057403198272" target="_blank" rel="noopener">åç¨‹</a>ã€æˆ–è€…çº¤ç¨‹ã€‚ ç¬”è€…ç¬¬ä¸€æ¬¡æ¥è§¦è¿™ä¸ªæ¦‚å¿µæ˜¯åœ¨å­¦ä¹  Ruby çš„æ—¶å€™ï¼ŒRubyå°±å°†åç¨‹ç§°ä¸º Fiberã€‚åæ¥å‘ç°å¾ˆå¤šè¯­è¨€éƒ½æœ‰ç±»ä¼¼çš„æœºåˆ¶ï¼Œä¾‹å¦‚Lua çš„<code>Coroutine</code>, è¿˜æœ‰å‰ç«¯å¼€å‘è€…æ¯”è¾ƒç†Ÿæ‚‰çš„ <code>ES6</code> æ–°å¢çš„<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Generator" target="_blank" rel="noopener"><code>Generator</code></a>ã€‚</p><blockquote><p>æœ¬æ–‡ä¸çº ç»“ <a href="https://stackoverflow.com/questions/3324643/processes-threads-green-threads-protothreads-fibers-coroutines-whats-the/16375591#16375591" target="_blank" rel="noopener">Processes, threads, green threads, protothreads, fibers, coroutines: whatâ€™s the difference?</a></p></blockquote><p><strong>ğŸ”´ å…¶å®åç¨‹å’Œçº¿ç¨‹å¹¶ä¸ä¸€æ ·ï¼Œåç¨‹æœ¬èº«æ˜¯æ²¡æœ‰å¹¶å‘æˆ–è€…å¹¶è¡Œèƒ½åŠ›çš„ï¼ˆéœ€è¦é…åˆçº¿ç¨‹ï¼‰ï¼Œå®ƒåªæ˜¯ä¸€ç§æ§åˆ¶æµç¨‹çš„è®©å‡ºæœºåˆ¶</strong>ã€‚è¦ç†è§£åç¨‹ï¼Œä½ å¾—å’Œæ™®é€šå‡½æ•°ä¸€èµ·æ¥çœ‹, ä»¥Generatorä¸ºä¾‹:</p><p>æ™®é€šå‡½æ•°æ‰§è¡Œçš„è¿‡ç¨‹ä¸­æ— æ³•<strong>è¢«ä¸­æ–­å’Œæ¢å¤</strong>ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> tasks = []</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> task</span><br><span class="line">  <span class="keyword">while</span> (task = tasks.shift()) &#123;</span><br><span class="line">    execute(task)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>è€Œ <code>Generator</code> å¯ä»¥:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> tasks = []</span><br><span class="line"><span class="function"><span class="keyword">function</span> * <span class="title">run</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> task</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (task = tasks.shift()) &#123;</span><br><span class="line">    <span class="comment">// ğŸ”´ åˆ¤æ–­æ˜¯å¦æœ‰é«˜ä¼˜å…ˆçº§äº‹ä»¶éœ€è¦å¤„ç†, æœ‰çš„è¯è®©å‡ºæ§åˆ¶æƒ</span></span><br><span class="line">    <span class="keyword">if</span> (hasHighPriorityEvent()) &#123;</span><br><span class="line">      <span class="keyword">yield</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤„ç†å®Œé«˜ä¼˜å…ˆçº§äº‹ä»¶åï¼Œæ¢å¤å‡½æ•°è°ƒç”¨æ ˆï¼Œç»§ç»­æ‰§è¡Œ...</span></span><br><span class="line">    execute(task)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>React Fiber çš„æ€æƒ³å’Œåç¨‹çš„æ¦‚å¿µæ˜¯å¥‘åˆçš„: <strong>ğŸ”´React æ¸²æŸ“çš„è¿‡ç¨‹å¯ä»¥è¢«ä¸­æ–­ï¼Œå¯ä»¥å°†æ§åˆ¶æƒäº¤å›æµè§ˆå™¨ï¼Œè®©ä½ç»™é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼Œæµè§ˆå™¨ç©ºé—²åå†æ¢å¤æ¸²æŸ“</strong>ã€‚</p><p><br></p><p>é‚£ä¹ˆç°åœ¨ä½ åº”è¯¥æœ‰ä»¥ä¸‹ç–‘é—®:</p><ul><li>1ï¸âƒ£ æµè§ˆå™¨æ²¡æœ‰æŠ¢å çš„æ¡ä»¶, æ‰€ä»¥Reactåªèƒ½ç”¨è®©å‡ºæœºåˆ¶?</li><li>2ï¸âƒ£ æ€ä¹ˆç¡®å®šæœ‰é«˜ä¼˜å…ˆä»»åŠ¡è¦å¤„ç†ï¼Œå³ä»€ä¹ˆæ—¶å€™è®©å‡ºï¼Ÿ</li><li>3ï¸âƒ£ React é‚£ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ Generatorï¼Ÿ</li></ul><p><br><br><br></p><p><strong>ç­”1ï¸âƒ£: æ²¡é”™, ä¸»åŠ¨è®©å‡ºæœºåˆ¶</strong></p><p>ä¸€æ˜¯æµè§ˆå™¨ä¸­æ²¡æœ‰ç±»ä¼¼è¿›ç¨‹çš„æ¦‚å¿µï¼Œâ€™ä»»åŠ¡â€˜ä¹‹é—´çš„ç•Œé™å¾ˆæ¨¡ç³Šï¼Œæ²¡æœ‰ä¸Šä¸‹æ–‡ï¼Œæ‰€ä»¥ä¸å…·å¤‡ä¸­æ–­/æ¢å¤çš„æ¡ä»¶ã€‚äºŒæ˜¯æ²¡æœ‰æŠ¢å çš„æœºåˆ¶ï¼Œæˆ‘ä»¬æ— æ³•ä¸­æ–­ä¸€ä¸ªæ­£åœ¨æ‰§è¡Œçš„ç¨‹åºã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬åªèƒ½é‡‡ç”¨ç±»ä¼¼åç¨‹è¿™æ ·æ§åˆ¶æƒè®©å‡ºæœºåˆ¶ã€‚è¿™ä¸ªå’Œä¸Šæ–‡æåˆ°çš„è¿›ç¨‹è°ƒåº¦ç­–ç•¥éƒ½ä¸åŒï¼Œå®ƒæœ‰æ›´ä¸€ä¸ªä¸“ä¸šçš„åè¯ï¼š<a href="https://juejin.im/post/5d12c907f265da1b6d4033c5#heading-7" target="_blank" rel="noopener"><strong>åˆä½œå¼è°ƒåº¦(Cooperative Scheduling)</strong></a>, ç›¸å¯¹åº”çš„æœ‰<strong>æŠ¢å å¼è°ƒåº¦(Preemptive Scheduling)</strong></p><p><strong>è¿™æ˜¯ä¸€ç§â€™å¥‘çº¦â€˜è°ƒåº¦ï¼Œè¦æ±‚æˆ‘ä»¬çš„ç¨‹åºå’Œæµè§ˆå™¨ç´§å¯†ç»“åˆï¼Œäº’ç›¸ä¿¡ä»»</strong>ã€‚æ¯”å¦‚å¯ä»¥ç”±æµè§ˆå™¨ç»™æˆ‘ä»¬åˆ†é…æ‰§è¡Œæ—¶é—´ç‰‡(é€šè¿‡<code>requestIdleCallback</code>å®ç°, ä¸‹æ–‡ä¼šä»‹ç»)ï¼Œæˆ‘ä»¬è¦æŒ‰ç…§çº¦å®šåœ¨è¿™ä¸ªæ—¶é—´å†…æ‰§è¡Œå®Œæ¯•ï¼Œå¹¶å°†æ§åˆ¶æƒè¿˜ç»™æµè§ˆå™¨ã€‚</p><p><img src="/images/react-fiber/cs.png" alt></p><p><br></p><p>è¿™ç§è°ƒåº¦æ–¹å¼å¾ˆæœ‰è¶£ï¼Œä½ ä¼šå‘ç°<strong>è¿™æ˜¯ä¸€ç§èº«ä»½çš„å¯¹è°ƒ</strong>ï¼Œä»¥å‰æˆ‘ä»¬æ˜¯è€å­ï¼Œæƒ³æ€ä¹ˆæ‰§è¡Œå°±æ€ä¹ˆæ‰§è¡Œï¼Œæ‰§è¡Œå¤šä¹…å°±æ‰§è¡Œå¤šä¹…; ç°åœ¨ä¸ºäº†æˆ‘ä»¬å…±åŒçš„ç”¨æˆ·ä½“éªŒç»Ÿä¸€äº†æˆ˜çº¿, ä¸€åˆ‡å¬ç”±æµè§ˆå™¨æŒ‡æŒ¥è°ƒåº¦ï¼Œæµè§ˆå™¨æ˜¯è€å­ï¼Œæˆ‘ä»¬è¦è·Ÿæµè§ˆå™¨ç”³è¯·æ‰§è¡Œæƒï¼Œè€Œä¸”è¿™ä¸ªæ‰§è¡Œæƒæœ‰æœŸé™ï¼Œå€Ÿäº†åè¦æŒ‰ç…§çº¦å®šå½’è¿˜ç»™æµè§ˆå™¨ã€‚</p><p>å½“ç„¶ä½ è¶…æ—¶ä¸è¿˜æµè§ˆå™¨ä¹Ÿæ‹¿ä½ æ²¡åŠæ³• ğŸ¤·â€â€¦ åˆä½œå¼è°ƒåº¦çš„ç¼ºç‚¹å°±åœ¨äºæ­¤ï¼Œå…¨å‡­è‡ªå¾‹ï¼Œç”¨æˆ·è¦æŒ–å¤§å‘ï¼Œè°éƒ½æ‹¦ä¸ä½ã€‚</p><p><br></p><hr><p><br></p><p><strong>ç­”2ï¸âƒ£: requestIdleCallback API</strong></p><p>ä¸Šé¢ä»£ç ç¤ºä¾‹ä¸­çš„ <code>hasHighPriorityEvent()</code> åœ¨ç›®å‰æµè§ˆå™¨ä¸­æ˜¯æ— æ³•å®ç°çš„ï¼Œæˆ‘ä»¬æ²¡åŠæ³•åˆ¤æ–­å½“å‰æ˜¯å¦æœ‰æ›´é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ç­‰å¾…è¢«æ‰§è¡Œã€‚</p><p>åªèƒ½æ¢ä¸€ç§æ€è·¯ï¼Œé€šè¿‡<strong>è¶…æ—¶æ£€æŸ¥çš„æœºåˆ¶æ¥è®©å‡ºæ§åˆ¶æƒ</strong>ã€‚è§£å†³åŠæ³•æ˜¯: <em>ç¡®å®šä¸€ä¸ªåˆç†çš„è¿è¡Œæ—¶é•¿ï¼Œç„¶ååœ¨åˆé€‚çš„æ£€æŸ¥ç‚¹æ£€æµ‹æ˜¯å¦è¶…æ—¶(æ¯”å¦‚æ¯æ‰§è¡Œä¸€ä¸ªå°ä»»åŠ¡)ï¼Œå¦‚æœè¶…æ—¶å°±åœæ­¢æ‰§è¡Œï¼Œå°†æ§åˆ¶æƒäº¤æ¢ç»™æµè§ˆå™¨</em>ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œä¸ºäº†è®©è§†å›¾æµç•…åœ°è¿è¡Œï¼Œå¯ä»¥æŒ‰ç…§äººç±»èƒ½æ„ŸçŸ¥åˆ°æœ€ä½é™åº¦æ¯ç§’60å¸§çš„é¢‘ç‡åˆ’åˆ†æ—¶é—´ç‰‡ï¼Œè¿™æ ·æ¯ä¸ªæ—¶é—´ç‰‡å°±æ˜¯ 16msã€‚</p><p>å…¶å®æµè§ˆå™¨æä¾›äº†ç›¸å…³çš„æ¥å£ â€”â€” <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestIdleCallback" target="_blank" rel="noopener"><code>requestIdleCallback</code></a> APIï¼š</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="built_in">window</span>.requestIdleCallback(</span><br><span class="line">  callback: <span class="function">(<span class="params">dealine: IdleDeadline</span>) =&gt;</span> <span class="built_in">void</span>,</span><br><span class="line">  option?: &#123;timeout: <span class="built_in">number</span>&#125;</span><br><span class="line">  )</span><br></pre></td></tr></table></figure><p><br></p><p><code>IdleDeadline</code>çš„æ¥å£å¦‚ä¸‹ï¼š</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">interface</span> IdleDealine &#123;</span><br><span class="line">  didTimeout: <span class="built_in">boolean</span> <span class="comment">// è¡¨ç¤ºä»»åŠ¡æ‰§è¡Œæ˜¯å¦è¶…è¿‡çº¦å®šæ—¶é—´</span></span><br><span class="line">  timeRemaining(): DOMHighResTimeStamp <span class="comment">// ä»»åŠ¡å¯ä¾›æ‰§è¡Œçš„å‰©ä½™æ—¶é—´</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å•ä»åå­—ä¸Šç†è§£çš„è¯, <code>requestIdleCallback</code>çš„æ„æ€æ˜¯<strong>è®©æµè§ˆå™¨åœ¨â€™æœ‰ç©ºâ€™çš„æ—¶å€™å°±æ‰§è¡Œæˆ‘ä»¬çš„å›è°ƒï¼Œè¿™ä¸ªå›è°ƒä¼šä¼ å…¥ä¸€ä¸ªæœŸé™ï¼Œè¡¨ç¤ºæµè§ˆå™¨æœ‰å¤šå°‘æ—¶é—´ä¾›æˆ‘ä»¬æ‰§è¡Œ, ä¸ºäº†ä¸è€½è¯¯äº‹ï¼Œæˆ‘ä»¬æœ€å¥½åœ¨è¿™ä¸ªæ—¶é—´èŒƒå›´å†…æ‰§è¡Œå®Œæ¯•</strong>ã€‚</p><p><br></p><p><strong>é‚£æµè§ˆå™¨ä»€ä¹ˆæ—¶å€™æœ‰ç©ºï¼Ÿ</strong></p><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹æµè§ˆå™¨åœ¨ä¸€å¸§(Frameï¼Œå¯ä»¥è®¤ä¸ºäº‹ä»¶å¾ªç¯çš„ä¸€æ¬¡å¾ªç¯)å†…å¯èƒ½ä¼šåšä»€ä¹ˆäº‹æƒ…:</p><p><img src="/images/react-fiber/frame.png" alt><br><i>ä½ å¯ä»¥æ‰“å¼€ Chrome å¼€å‘è€…å·¥å…·çš„Performanceæ ‡ç­¾ï¼Œè¿™é‡Œå¯ä»¥è¯¦ç»†çœ‹åˆ°Javascriptçš„æ¯ä¸€å¸§éƒ½æ‰§è¡Œäº†ä»€ä¹ˆä»»åŠ¡(Task), èŠ±è´¹äº†å¤šå°‘æ—¶é—´ã€‚</i></p><p><br></p><p><img src="/images/react-fiber/frame-life.png" alt><br><i>å›¾ç‰‡æ¥æº: <a href="https://juejin.im/post/5ad71f39f265da239f07e862" target="_blank" rel="noopener">ä½ åº”è¯¥çŸ¥é“çš„requestIdleCallback</a></i></p><p>æµè§ˆå™¨åœ¨ä¸€å¸§å†…å¯èƒ½ä¼šåšæ‰§è¡Œä¸‹åˆ—ä»»åŠ¡ï¼Œè€Œä¸”å®ƒä»¬çš„æ‰§è¡Œé¡ºåºåŸºæœ¬æ˜¯å›ºå®šçš„:</p><ul><li>å¤„ç†ç”¨æˆ·è¾“å…¥äº‹ä»¶</li><li>Javascriptæ‰§è¡Œ</li><li>requestAnimation è°ƒç”¨</li><li>å¸ƒå±€ Layout</li><li>ç»˜åˆ¶ Paint</li></ul><p><br></p><p>ä¸Šé¢è¯´ç†æƒ³çš„ä¸€å¸§æ—¶é—´æ˜¯ <code>16ms</code> (1000ms / 60)ï¼Œå¦‚æœæµè§ˆå™¨å¤„ç†å®Œä¸Šè¿°çš„ä»»åŠ¡(å¸ƒå±€å’Œç»˜åˆ¶ä¹‹å)ï¼Œè¿˜æœ‰ç›ˆä½™æ—¶é—´ï¼Œæµè§ˆå™¨å°±ä¼šè°ƒç”¨ <code>requestIdleCallback</code> çš„å›è°ƒã€‚ä¾‹å¦‚</p><p><br></p><p><img src="/images/react-fiber/ric.png" alt></p><p><br></p><p><strong>ä½†æ˜¯åœ¨æµè§ˆå™¨ç¹å¿™çš„æ—¶å€™ï¼Œå¯èƒ½ä¸ä¼šæœ‰ç›ˆä½™æ—¶é—´ï¼Œè¿™æ—¶å€™<code>requestIdleCallback</code>å›è°ƒå¯èƒ½å°±ä¸ä¼šè¢«æ‰§è¡Œã€‚ ä¸ºäº†é¿å…é¥¿æ­»ï¼Œå¯ä»¥é€šè¿‡requestIdleCallbackçš„ç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šä¸€ä¸ªè¶…æ—¶æ—¶é—´</strong>ã€‚</p><blockquote><p>å¦å¤–ä¸å»ºè®®åœ¨<code>requestIdleCallback</code>ä¸­è¿›è¡Œ<code>DOM</code>æ“ä½œï¼Œå› ä¸ºè¿™å¯èƒ½å¯¼è‡´æ ·å¼é‡æ–°è®¡ç®—æˆ–é‡æ–°å¸ƒå±€(æ¯”å¦‚æ“ä½œDOMåé©¬ä¸Šè°ƒç”¨ <code>getBoundingClientRect</code>)ï¼Œè¿™äº›æ—¶é—´å¾ˆéš¾é¢„ä¼°çš„ï¼Œå¾ˆæœ‰å¯èƒ½å¯¼è‡´å›è°ƒæ‰§è¡Œè¶…æ—¶ï¼Œä»è€Œæ‰å¸§ã€‚</p></blockquote><p><br></p><p>ç›®å‰ <code>requestIdleCallback</code> ç›®å‰åªæœ‰Chromeæ”¯æŒã€‚æ‰€ä»¥ç›®å‰ React <a href="https://github.com/facebook/react/blob/master/packages/scheduler/src/forks/SchedulerHostConfig.default.js" target="_blank" rel="noopener">è‡ªå·±å®ç°äº†ä¸€ä¸ª</a>ã€‚å®ƒåˆ©ç”¨<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/MessageChannel" target="_blank" rel="noopener"><code>MessageChannel</code></a> æ¨¡æ‹Ÿå°†å›è°ƒå»¶è¿Ÿåˆ°â€™ç»˜åˆ¶æ“ä½œâ€™ä¹‹åæ‰§è¡Œ:</p><p><br></p><p><img src="/images/react-fiber/mc.png" alt></p><p><br></p><details><br><summary>ç®€å•çœ‹ä¸€ä¸‹ä»£ç </summary><br><br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> el = <span class="built_in">document</span>.getElementById(<span class="string">'root'</span>)</span><br><span class="line"><span class="keyword">const</span> btn = <span class="built_in">document</span>.getElementById(<span class="string">'btn'</span>)</span><br><span class="line"><span class="keyword">const</span> ch = <span class="keyword">new</span> MessageChannel()</span><br><span class="line"><span class="keyword">let</span> pendingCallback</span><br><span class="line"><span class="keyword">let</span> startTime</span><br><span class="line"><span class="keyword">let</span> timeout</span><br><span class="line"></span><br><span class="line">ch.port2.onmessage = <span class="function"><span class="keyword">function</span> <span class="title">work</span>(<span class="params"></span>)  </span>&#123;</span><br><span class="line">  <span class="comment">// åœ¨ç»˜åˆ¶ä¹‹åè¢«æ‰§è¡Œ</span></span><br><span class="line">  <span class="keyword">if</span> (pendingCallback) &#123;</span><br><span class="line">    <span class="keyword">const</span> now = performance.now()</span><br><span class="line">    <span class="comment">// é€šè¿‡now - startTimeå¯ä»¥è®¡ç®—å‡ºrequestAnimationFrameåˆ°ç»˜åˆ¶ç»“æŸçš„æ‰§è¡Œæ—¶é—´</span></span><br><span class="line">    <span class="comment">// é€šè¿‡è¿™äº›æ•°æ®æ¥è®¡ç®—å‰©ä½™æ—¶é—´</span></span><br><span class="line">    <span class="comment">// å¦å¤–è¿˜è¦å¤„ç†è¶…æ—¶(timeout)ï¼Œé¿å…ä»»åŠ¡è¢«é¥¿æ­»</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (hasRemain &amp;&amp; noTimeout) &#123;</span><br><span class="line">      pendingCallback(deadline)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">simpleRequestIdleCallback</span>(<span class="params">callback, timeout</span>) </span>&#123;</span><br><span class="line">  requestAnimationFrame(<span class="function"><span class="keyword">function</span> <span class="title">animation</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// åœ¨ç»˜åˆ¶ä¹‹å‰è¢«æ‰§è¡Œ</span></span><br><span class="line">    <span class="comment">// è®°å½•å¼€å§‹æ—¶é—´</span></span><br><span class="line">    startTime = performance.now()</span><br><span class="line">    timeout = timeout</span><br><span class="line">    dosomething()</span><br><span class="line">    <span class="comment">// è°ƒåº¦å›è°ƒåˆ°ç»˜åˆ¶ç»“æŸåæ‰§è¡Œ</span></span><br><span class="line">    pendingCallback = callback</span><br><span class="line">    ch.port1.postMessage(<span class="string">'hello'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><br></details><p><br></p><p><strong>ä»»åŠ¡ä¼˜å…ˆçº§</strong></p><p>ä¸Šé¢è¯´äº†ï¼Œä¸ºäº†é¿å…ä»»åŠ¡è¢«é¥¿æ­»ï¼Œå¯ä»¥è®¾ç½®ä¸€ä¸ªè¶…æ—¶æ—¶é—´. <strong>è¿™ä¸ªè¶…æ—¶æ—¶é—´ä¸æ˜¯æ­»çš„ï¼Œä½ä¼˜å…ˆçº§çš„å¯ä»¥æ…¢æ…¢ç­‰å¾…, é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡åº”è¯¥ç‡å…ˆè¢«æ‰§è¡Œ</strong>. ç›®å‰ React é¢„å®šä¹‰äº† 5 ä¸ªä¼˜å…ˆçº§, è¿™ä¸ªæˆ‘åœ¨[ã€Šè°ˆè°ˆReactäº‹ä»¶æœºåˆ¶å’Œæœªæ¥(react-events)ã€‹]ä¸­ä¹Ÿä»‹ç»è¿‡:</p><ul><li><code>Immediate</code>(-1) - è¿™ä¸ªä¼˜å…ˆçº§çš„ä»»åŠ¡ä¼šåŒæ­¥æ‰§è¡Œ, æˆ–è€…è¯´è¦é©¬ä¸Šæ‰§è¡Œä¸”ä¸èƒ½ä¸­æ–­</li><li><code>UserBlocking</code>(250ms) è¿™äº›ä»»åŠ¡ä¸€èˆ¬æ˜¯ç”¨æˆ·äº¤äº’çš„ç»“æœ, éœ€è¦å³æ—¶å¾—åˆ°åé¦ˆ</li><li><code>Normal</code> (5s) åº”å¯¹å“ªäº›ä¸éœ€è¦ç«‹å³æ„Ÿå—åˆ°çš„ä»»åŠ¡ï¼Œä¾‹å¦‚ç½‘ç»œè¯·æ±‚</li><li><code>Low</code> (10s) è¿™äº›ä»»åŠ¡å¯ä»¥æ”¾åï¼Œä½†æ˜¯æœ€ç»ˆåº”è¯¥å¾—åˆ°æ‰§è¡Œ. ä¾‹å¦‚åˆ†æé€šçŸ¥</li><li><code>Idle</code> (æ²¡æœ‰è¶…æ—¶æ—¶é—´) ä¸€äº›æ²¡æœ‰å¿…è¦åšçš„ä»»åŠ¡ (e.g. æ¯”å¦‚éšè—çš„å†…å®¹), å¯èƒ½ä¼šè¢«é¥¿æ­»</li></ul><p><br></p><hr><p><br></p><p><strong>ç­”3ï¸âƒ£: å¤ªéº»çƒ¦</strong></p><p>å®˜æ–¹åœ¨<a href="https://github.com/facebook/react/issues/7942" target="_blank" rel="noopener">ã€ŠFiber Principles: Contributing To Fiberã€‹</a> ä¹Ÿä½œå‡ºäº†è§£ç­”ã€‚ä¸»è¦æœ‰ä¸¤ä¸ªåŸå› ï¼š</p><ol><li>Generator ä¸èƒ½åœ¨æ ˆä¸­é—´è®©å‡ºã€‚æ¯”å¦‚ä½ æƒ³åœ¨åµŒå¥—çš„å‡½æ•°è°ƒç”¨ä¸­é—´è®©å‡º, é¦–å…ˆä½ éœ€è¦å°†è¿™äº›å‡½æ•°éƒ½åŒ…è£…æˆGeneratorï¼Œå¦å¤–è¿™ç§æ ˆä¸­é—´çš„è®©å‡ºå¤„ç†èµ·æ¥ä¹Ÿæ¯”è¾ƒéº»çƒ¦ï¼Œéš¾ä»¥ç†è§£ã€‚é™¤äº†è¯­æ³•å¼€é”€ï¼Œç°æœ‰çš„ç”Ÿæˆå™¨å®ç°å¼€é”€æ¯”è¾ƒå¤§ï¼Œæ‰€ä»¥ä¸å¦‚ä¸ç”¨ã€‚</li><li>Generator æ˜¯æœ‰çŠ¶æ€çš„, å¾ˆéš¾åœ¨ä¸­é—´æ¢å¤è¿™äº›çŠ¶æ€ã€‚</li></ol><blockquote><p>ä¸Šé¢ç†è§£å¯èƒ½æœ‰å‡ºå…¥ï¼Œå»ºè®®çœ‹ä¸€ä¸‹åŸæ–‡</p></blockquote><p>å¯èƒ½éƒ½æ²¡çœ‹æ‡‚ï¼Œç®€å•å°±æ˜¯ React å°è¯•è¿‡ç”¨ Generator å®ç°ï¼Œåæ¥å‘ç°å¾ˆéº»çƒ¦ï¼Œå°±æ”¾å¼ƒäº†ã€‚</p><p><br><br><br></p><h3 id="2-ä¸€ä¸ªæ‰§è¡Œå•å…ƒ"><a href="#2-ä¸€ä¸ªæ‰§è¡Œå•å…ƒ" class="headerlink" title="2. ä¸€ä¸ªæ‰§è¡Œå•å…ƒ"></a>2. ä¸€ä¸ªæ‰§è¡Œå•å…ƒ</h3><p>Fiberçš„å¦å¤–ä¸€ç§è§£è¯»æ˜¯â€™çº¤ç»´â€˜: <strong>è¿™æ˜¯ä¸€ç§æ•°æ®ç»“æ„æˆ–è€…è¯´æ‰§è¡Œå•å…ƒ</strong>ã€‚æˆ‘ä»¬æš‚ä¸”ä¸ç®¡è¿™ä¸ªæ•°æ®ç»“æ„é•¿ä»€ä¹ˆæ ·ï¼Œ<strong>ğŸ”´å°†å®ƒè§†ä½œä¸€ä¸ªæ‰§è¡Œå•å…ƒï¼Œæ¯æ¬¡æ‰§è¡Œå®Œä¸€ä¸ªâ€™æ‰§è¡Œå•å…ƒâ€™,  React å°±ä¼šæ£€æŸ¥ç°åœ¨è¿˜å‰©å¤šå°‘æ—¶é—´ï¼Œå¦‚æœæ²¡æœ‰æ—¶é—´å°±å°†æ§åˆ¶æƒè®©å‡ºå»</strong>.</p><p><br></p><p>ä¸Šæ–‡è¯´äº†ï¼ŒReact æ²¡æœ‰ä½¿ç”¨ Generator è¿™äº›è¯­è¨€/è¯­æ³•å±‚é¢çš„è®©å‡ºæœºåˆ¶ï¼Œè€Œæ˜¯å®ç°äº†è‡ªå·±çš„è°ƒåº¦è®©å‡ºæœºåˆ¶ã€‚è¿™ä¸ªæœºåˆ¶å°±æ˜¯åŸºäºâ€™Fiberâ€˜è¿™ä¸ªæ‰§è¡Œå•å…ƒçš„ï¼Œå®ƒçš„è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><p>å‡è®¾ç”¨æˆ·è°ƒç”¨ <code>setState</code> æ›´æ–°ç»„ä»¶, è¿™ä¸ªå¾…æ›´æ–°çš„ä»»åŠ¡ä¼šå…ˆæ”¾å…¥é˜Ÿåˆ—ä¸­, ç„¶åé€šè¿‡ <code>requestIdleCallback</code> è¯·æ±‚æµè§ˆå™¨è°ƒåº¦ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">updateQueue.push(updateTask);</span><br><span class="line">requestIdleCallback(performWork, &#123;timeout&#125;);</span><br></pre></td></tr></table></figure><p><br></p><p>ç°åœ¨æµè§ˆå™¨æœ‰ç©ºé—²æˆ–è€…è¶…æ—¶äº†å°±ä¼šè°ƒç”¨<code>performWork</code>æ¥æ‰§è¡Œä»»åŠ¡ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 1ï¸âƒ£ performWork ä¼šæ‹¿åˆ°ä¸€ä¸ªDeadlineï¼Œè¡¨ç¤ºå‰©ä½™æ—¶é—´</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">performWork</span>(<span class="params">deadline</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2ï¸âƒ£ å¾ªç¯å–å‡ºupdateQueueä¸­çš„ä»»åŠ¡</span></span><br><span class="line">  <span class="keyword">while</span> (updateQueue.length &gt; <span class="number">0</span> &amp;&amp; deadline.timeRemaining() &gt; ENOUGH_TIME) &#123;</span><br><span class="line">    workLoop(deadline);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3ï¸âƒ£ å¦‚æœåœ¨æœ¬æ¬¡æ‰§è¡Œä¸­ï¼Œæœªèƒ½å°†æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œé‚£å°±å†è¯·æ±‚æµè§ˆå™¨è°ƒåº¦</span></span><br><span class="line">  <span class="keyword">if</span> (updateQueue.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    requestIdleCallback(performWork);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p><strong><code>workLoop</code> çš„å·¥ä½œå¤§æ¦‚çŒœåˆ°äº†ï¼Œå®ƒä¼šä»æ›´æ–°é˜Ÿåˆ—(updateQueue)ä¸­å¼¹å‡ºæ›´æ–°ä»»åŠ¡æ¥æ‰§è¡Œï¼Œæ¯æ‰§è¡Œå®Œä¸€ä¸ªâ€˜<code>æ‰§è¡Œå•å…ƒ</code>â€˜ï¼Œå°±æ£€æŸ¥ä¸€ä¸‹å‰©ä½™æ—¶é—´æ˜¯å¦å……è¶³ï¼Œå¦‚æœå……è¶³å°±è¿›è¡Œæ‰§è¡Œä¸‹ä¸€ä¸ª<code>æ‰§è¡Œå•å…ƒ</code>ï¼Œåä¹‹åˆ™åœæ­¢æ‰§è¡Œï¼Œä¿å­˜ç°åœºï¼Œç­‰ä¸‹ä¸€æ¬¡æœ‰æ‰§è¡Œæƒæ—¶æ¢å¤</strong>:</p><p><br></p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä¿å­˜å½“å‰çš„å¤„ç†ç°åœº</span></span><br><span class="line"><span class="keyword">let</span> nextUnitOfWork: Fiber | <span class="literal">undefined</span> <span class="comment">// ä¿å­˜ä¸‹ä¸€ä¸ªéœ€è¦å¤„ç†çš„å·¥ä½œå•å…ƒ</span></span><br><span class="line"><span class="keyword">let</span> topWork: Fiber | <span class="literal">undefined</span>        <span class="comment">// ä¿å­˜ç¬¬ä¸€ä¸ªå·¥ä½œå•å…ƒ</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">workLoop</span>(<span class="params">deadline: IdleDeadline</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// updateQueueä¸­è·å–ä¸‹ä¸€ä¸ªæˆ–è€…æ¢å¤ä¸Šä¸€æ¬¡ä¸­æ–­çš„æ‰§è¡Œå•å…ƒ</span></span><br><span class="line">  <span class="keyword">if</span> (nextUnitOfWork == <span class="literal">null</span>) &#123;</span><br><span class="line">    nextUnitOfWork = topWork = getNextUnitOfWork();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ğŸ”´ æ¯æ‰§è¡Œå®Œä¸€ä¸ªæ‰§è¡Œå•å…ƒï¼Œæ£€æŸ¥ä¸€æ¬¡å‰©ä½™æ—¶é—´</span></span><br><span class="line">  <span class="comment">// å¦‚æœè¢«ä¸­æ–­ï¼Œä¸‹ä¸€æ¬¡æ‰§è¡Œè¿˜æ˜¯ä» nextUnitOfWork å¼€å§‹å¤„ç†</span></span><br><span class="line">  <span class="keyword">while</span> (nextUnitOfWork &amp;&amp; deadline.timeRemaining() &gt; ENOUGH_TIME) &#123;</span><br><span class="line">    <span class="comment">// ä¸‹æ–‡æˆ‘ä»¬å†çœ‹performUnitOfWork</span></span><br><span class="line">    nextUnitOfWork = performUnitOfWork(nextUnitOfWork, topWork);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æäº¤å·¥ä½œï¼Œä¸‹æ–‡ä¼šä»‹ç»</span></span><br><span class="line">  <span class="keyword">if</span> (pendingCommit) &#123;</span><br><span class="line">    commitAllWork(pendingCommit);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”»ä¸ªæµç¨‹å›¾å§ï¼</p><p><br></p><p><img src="/images/react-fiber/workloop.png" alt></p><p><br><br><br></p><h2 id="react-çš„fiberæ”¹é€ "><a href="#react-çš„fiberæ”¹é€ " class="headerlink" title="React çš„Fiberæ”¹é€ "></a>React çš„Fiberæ”¹é€ </h2><p>Fiber çš„æ ¸å¿ƒå†…å®¹å·²ç»ä»‹ç»å®Œäº†ï¼Œç°åœ¨æ¥è¿›ä¸€æ­¥çœ‹çœ‹React ä¸º Fiber æ¶æ„åšäº†å“ªäº›æ”¹é€ , å¦‚æœä½ å¯¹è¿™éƒ¨åˆ†å†…å®¹ä¸æ„Ÿå…´è¶£å¯ä»¥è·³è¿‡ã€‚</p><p><br></p><h3 id="1-æ•°æ®ç»“æ„çš„è°ƒæ•´"><a href="#1-æ•°æ®ç»“æ„çš„è°ƒæ•´" class="headerlink" title="1. æ•°æ®ç»“æ„çš„è°ƒæ•´"></a>1. æ•°æ®ç»“æ„çš„è°ƒæ•´</h3><p><img src="/images/react-fiber/diff.png" alt><br><i>å·¦ä¾§æ˜¯Virtual DOMï¼Œå³ä¾§å¯ä»¥çœ‹ä½œdiffçš„é€’å½’è°ƒç”¨æ ˆ</i></p><p><br></p><p>ä¸Šæ–‡ä¸­æåˆ° React 16 ä¹‹å‰ï¼ŒReconcilation æ˜¯åŒæ­¥çš„ã€é€’å½’æ‰§è¡Œçš„ã€‚ä¹Ÿå°±æ˜¯è¯´è¿™æ˜¯åŸºäºå‡½æ•°â€™è°ƒç”¨æ ˆâ€˜çš„Reconcilationç®—æ³•ï¼Œå› æ­¤é€šå¸¸ä¹Ÿç§°å®ƒä¸º<code>Stack Reconcilation</code>. ä½ å¯ä»¥é€šè¿‡è¿™ç¯‡æ–‡ç« <a href="https://juejin.im/post/5cfa29e151882539c33e4f5e" target="_blank" rel="noopener">ã€Šä»Preactä¸­äº†è§£Reactç»„ä»¶å’ŒhooksåŸºæœ¬åŸç†ã€‹</a> æ¥å›é¡¾ä¸€ä¸‹å†å²ã€‚</p><p><br></p><p>æ ˆæŒºå¥½çš„ï¼Œä»£ç é‡å°‘ï¼Œé€’å½’å®¹æ˜“ç†è§£, è‡³å°‘æ¯”ç°åœ¨çš„ React Fiberæ¶æ„å¥½ç†è§£ğŸ˜‚, é€’å½’éå¸¸é€‚åˆæ ‘è¿™ç§åµŒå¥—æ•°æ®ç»“æ„çš„å¤„ç†ã€‚</p><p>åªä¸è¿‡è¿™ç§ä¾èµ–äºè°ƒç”¨æ ˆçš„æ–¹å¼ä¸èƒ½éšæ„ä¸­æ–­ã€ä¹Ÿå¾ˆéš¾è¢«æ¢å¤, ä¸åˆ©äºå¼‚æ­¥å¤„ç†ã€‚ è¿™ç§è°ƒç”¨æ ˆï¼Œä¸æ˜¯ç¨‹åºæ‰€èƒ½æ§åˆ¶çš„ï¼Œ å¦‚æœä½ è¦æ¢å¤é€’å½’ç°åœºï¼Œå¯èƒ½éœ€è¦ä»å¤´å¼€å§‹, æ¢å¤åˆ°ä¹‹å‰çš„è°ƒç”¨æ ˆã€‚</p><p>å› æ­¤<strong>é¦–å…ˆæˆ‘ä»¬éœ€è¦å¯¹Reactç°æœ‰çš„æ•°æ®ç»“æ„è¿›è¡Œè°ƒæ•´ï¼Œ<a href="https://zhuanlan.zhihu.com/p/36425839" target="_blank" rel="noopener"><code>æ¨¡æ‹Ÿå‡½æ•°è°ƒç”¨æ ˆ</code></a>, å°†ä¹‹å‰éœ€è¦é€’å½’è¿›è¡Œå¤„ç†çš„äº‹æƒ…åˆ†è§£æˆå¢é‡çš„æ‰§è¡Œå•å…ƒï¼Œå°†é€’å½’è½¬æ¢æˆè¿­ä»£</strong>.</p><p><br></p><p>React ç›®å‰çš„åšæ³•æ˜¯ä½¿ç”¨<code>é“¾è¡¨</code>, æ¯ä¸ª VirtualDOM èŠ‚ç‚¹å†…éƒ¨ç°åœ¨ä½¿ç”¨ <code>Fiber</code>è¡¨ç¤º, å®ƒçš„ç»“æ„å¤§æ¦‚å¦‚ä¸‹:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> type Fiber = &#123;</span><br><span class="line">  <span class="comment">// Fiber ç±»å‹ä¿¡æ¯</span></span><br><span class="line">  type: any,</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// âš›ï¸ é“¾è¡¨ç»“æ„</span></span><br><span class="line">  <span class="comment">// æŒ‡å‘çˆ¶èŠ‚ç‚¹ï¼Œæˆ–è€…renderè¯¥èŠ‚ç‚¹çš„ç»„ä»¶</span></span><br><span class="line">  <span class="keyword">return</span>: Fiber | <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// æŒ‡å‘ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹</span></span><br><span class="line">  child: Fiber | <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// æŒ‡å‘ä¸‹ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹</span></span><br><span class="line">  sibling: Fiber | <span class="literal">null</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>ç”¨å›¾ç‰‡æ¥å±•ç¤ºè¿™ç§å…³ç³»ä¼šæ›´ç›´è§‚ä¸€äº›ï¼š</p><p><img src="/images/react-fiber/fiber-node.png" alt></p><p><br></p><p><strong>ä½¿ç”¨é“¾è¡¨ç»“æ„åªæ˜¯ä¸€ä¸ªç»“æœï¼Œè€Œä¸æ˜¯ç›®çš„ï¼ŒReact å¼€å‘è€…ä¸€å¼€å§‹çš„ç›®çš„æ˜¯å†²ç€æ¨¡æ‹Ÿè°ƒç”¨æ ˆå»çš„</strong>ã€‚è¿™ä¸ªå¾ˆå¤šå…³äºFiber çš„æ–‡ç« éƒ½æœ‰æåŠ, å…³äºè°ƒç”¨æ ˆçš„è¯¦ç»†å®šä¹‰å‚è§<a href="https://en.wikipedia.org/wiki/Call_stack" target="_blank" rel="noopener">Wiki</a>ï¼š</p><p><img src="/images/react-fiber/callstack.png" alt></p><blockquote><p>è°ƒç”¨æ ˆæœ€ç»å¸¸è¢«ç”¨äºå­˜æ”¾å­ç¨‹åºçš„<strong>è¿”å›åœ°å€</strong>ã€‚åœ¨è°ƒç”¨ä»»ä½•å­ç¨‹åºæ—¶ï¼Œä¸»ç¨‹åºéƒ½å¿…é¡»æš‚å­˜å­ç¨‹åºè¿è¡Œå®Œæ¯•ååº”è¯¥è¿”å›åˆ°çš„åœ°å€ã€‚å› æ­¤ï¼Œå¦‚æœè¢«è°ƒç”¨çš„å­ç¨‹åºè¿˜è¦è°ƒç”¨å…¶ä»–çš„å­ç¨‹åºï¼Œå…¶è‡ªèº«çš„è¿”å›åœ°å€å°±å¿…é¡»å­˜å…¥è°ƒç”¨æ ˆï¼Œåœ¨å…¶è‡ªèº«è¿è¡Œå®Œæ¯•åå†è¡Œå–å›ã€‚é™¤äº†è¿”å›åœ°å€ï¼Œè¿˜ä¼šä¿å­˜<code>æœ¬åœ°å˜é‡</code>ã€<code>å‡½æ•°å‚æ•°</code>ã€<code>ç¯å¢ƒä¼ é€’</code>(Scope?)</p></blockquote><p><br></p><p>React Fiber ä¹Ÿè¢«ç§°ä¸ºè™šæ‹Ÿæ ˆå¸§(Virtual Stack Frame), ä½ å¯ä»¥æ‹¿å®ƒå’Œå‡½æ•°è°ƒç”¨æ ˆç±»æ¯”ä¸€ä¸‹, ä¸¤è€…ç»“æ„éå¸¸åƒ:</p><table><thead><tr><th></th><th>å‡½æ•°è°ƒç”¨æ ˆ</th><th>Fiber</th></tr></thead><tbody><tr><td>åŸºæœ¬å•ä½</td><td>å‡½æ•°</td><td>Virtual DOM èŠ‚ç‚¹</td></tr><tr><td>è¾“å…¥</td><td>å‡½æ•°å‚æ•°</td><td>Props</td></tr><tr><td>æœ¬åœ°çŠ¶æ€</td><td>æœ¬åœ°å˜é‡</td><td>State</td></tr><tr><td>è¾“å‡º</td><td>å‡½æ•°è¿”å›å€¼</td><td>React Element</td></tr><tr><td>ä¸‹çº§</td><td>åµŒå¥—å‡½æ•°è°ƒç”¨</td><td>å­èŠ‚ç‚¹(child)</td></tr><tr><td>ä¸Šçº§å¼•ç”¨</td><td>è¿”å›åœ°å€</td><td>çˆ¶èŠ‚ç‚¹(return)</td></tr></tbody></table><p><br></p><p>Fiber å’Œè°ƒç”¨æ ˆå¸§ä¸€æ ·, ä¿å­˜äº†èŠ‚ç‚¹å¤„ç†çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå› ä¸ºæ˜¯æ‰‹åŠ¨å®ç°çš„ï¼Œæ‰€ä»¥æ›´ä¸ºå¯æ§ï¼Œæˆ‘ä»¬å¯ä»¥ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œéšæ—¶ä¸­æ–­å’Œæ¢å¤ã€‚</p><p><br></p><p>æœ‰äº†è¿™ä¸ªæ•°æ®ç»“æ„è°ƒæ•´ï¼Œç°åœ¨å¯ä»¥ä»¥è¿­ä»£çš„æ–¹å¼æ¥å¤„ç†è¿™äº›èŠ‚ç‚¹äº†ã€‚æ¥çœ‹çœ‹ <code>performUnitOfWork</code> çš„å®ç°, å®ƒå…¶å®å°±æ˜¯ä¸€ä¸ªæ·±åº¦ä¼˜å…ˆçš„éå†ï¼š</p><p><br></p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @params fiber å½“å‰éœ€è¦å¤„ç†çš„èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"> * @params topWork æœ¬æ¬¡æ›´æ–°çš„æ ¹èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">performUnitOfWork</span>(<span class="params">fiber: Fiber, topWork: Fiber</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// å¯¹è¯¥èŠ‚ç‚¹è¿›è¡Œå¤„ç†</span></span><br><span class="line">  beginWork(fiber);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœå­˜åœ¨å­èŠ‚ç‚¹ï¼Œé‚£ä¹ˆä¸‹ä¸€ä¸ªå¾…å¤„ç†çš„å°±æ˜¯å­èŠ‚ç‚¹</span></span><br><span class="line">  <span class="keyword">if</span> (fiber.child) &#123;</span><br><span class="line">    <span class="keyword">return</span> fiber.child;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ²¡æœ‰å­èŠ‚ç‚¹äº†ï¼Œä¸Šæº¯æŸ¥æ‰¾å…„å¼ŸèŠ‚ç‚¹</span></span><br><span class="line">  <span class="keyword">let</span> temp = fiber;</span><br><span class="line">  <span class="keyword">while</span> (temp) &#123;</span><br><span class="line">    completeWork(temp);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ°é¡¶å±‚èŠ‚ç‚¹äº†, é€€å‡º</span></span><br><span class="line">    <span class="keyword">if</span> (temp === topWork) &#123;</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰¾åˆ°ï¼Œä¸‹ä¸€ä¸ªè¦å¤„ç†çš„å°±æ˜¯å…„å¼ŸèŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (temp.sibling) &#123;</span><br><span class="line">      <span class="keyword">return</span> temp.sibling;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ²¡æœ‰, ç»§ç»­ä¸Šæº¯</span></span><br><span class="line">    temp = temp.return;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>ä½ å¯ä»¥é…åˆä¸Šæ–‡çš„ <code>workLoop</code> ä¸€èµ·çœ‹ï¼Œ<strong>Fiber å°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„å·¥ä½œå•å…ƒï¼Œ<code>performUnitOfWork</code> è´Ÿè´£å¯¹ <code>Fiber</code> è¿›è¡Œæ“ä½œï¼Œå¹¶æŒ‰ç…§æ·±åº¦éå†çš„é¡ºåºè¿”å›ä¸‹ä¸€ä¸ª Fiber</strong>ã€‚</p><p><strong>å› ä¸ºä½¿ç”¨äº†é“¾è¡¨ç»“æ„ï¼Œå³ä½¿å¤„ç†æµç¨‹è¢«ä¸­æ–­äº†ï¼Œæˆ‘ä»¬éšæ—¶å¯ä»¥ä»ä¸Šæ¬¡æœªå¤„ç†å®Œçš„<code>Fiber</code>ç»§ç»­éå†ä¸‹å»</strong>ã€‚</p><p>æ•´ä¸ªè¿­ä»£é¡ºåºå’Œä¹‹å‰é€’å½’çš„ä¸€æ ·, ä¸‹å›¾å‡è®¾åœ¨ <code>div.app</code> è¿›è¡Œäº†æ›´æ–°ï¼š</p><p><br></p><p><img src="/images/react-fiber/work-order.png" alt><br><i>æ¯”å¦‚ä½ åœ¨<code>text(hello)</code>ä¸­æ–­äº†ï¼Œé‚£ä¹ˆä¸‹ä¸€æ¬¡å°±ä¼šä» <code>p</code> èŠ‚ç‚¹å¼€å§‹å¤„ç†</i></p><p><br></p><p>è¿™ä¸ªæ•°æ®ç»“æ„è°ƒæ•´è¿˜æœ‰ä¸€ä¸ªå¥½å¤„ï¼Œå°±æ˜¯æŸäº›èŠ‚ç‚¹å¼‚å¸¸æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æ‰“å°å‡ºå®Œæ•´çš„â€™èŠ‚ç‚¹æ ˆâ€˜ï¼Œåªéœ€è¦æ²¿ç€èŠ‚ç‚¹çš„<code>return</code>å›æº¯å³å¯ã€‚</p><p><br><br><br></p><h3 id="2-ä¸¤ä¸ªé˜¶æ®µçš„æ‹†åˆ†"><a href="#2-ä¸¤ä¸ªé˜¶æ®µçš„æ‹†åˆ†" class="headerlink" title="2. ä¸¤ä¸ªé˜¶æ®µçš„æ‹†åˆ†"></a>2. ä¸¤ä¸ªé˜¶æ®µçš„æ‹†åˆ†</h3><p><br></p><p><img src="/images/react-fiber/fiber-reconciler.png" alt></p><p><br></p><p>å¦‚æœä½ ç°åœ¨ä½¿ç”¨æœ€æ–°çš„ React ç‰ˆæœ¬(v16), ä½¿ç”¨ Chrome çš„ Performance å·¥å…·ï¼Œå¯ä»¥å¾ˆæ¸…æ™°åœ°çœ‹åˆ°æ¯æ¬¡æ¸²æŸ“æœ‰ä¸¤ä¸ªé˜¶æ®µï¼š<code>Reconciliation</code>(åè°ƒé˜¶æ®µ) å’Œ <code>Commit</code>(æäº¤é˜¶æ®µ).</p><blockquote><p>æˆ‘åœ¨ä¹‹å‰çš„å¤šç¯‡æ–‡ç« ä¸­éƒ½æœ‰æåŠ: <a href="https://juejin.im/post/5d8395646fb9a06ad16faa57" target="_blank" rel="noopener">ã€Šè‡ªå·±å†™ä¸ªReactæ¸²æŸ“å™¨: ä»¥ Remax ä¸ºä¾‹(ç”¨Reactå†™å°ç¨‹åº)ã€‹</a></p></blockquote><p>é™¤äº†Fiber å·¥ä½œå•å…ƒçš„æ‹†åˆ†ï¼Œä¸¤é˜¶æ®µçš„æ‹†åˆ†ä¹Ÿæ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ”¹é€ ï¼Œåœ¨æ­¤ä¹‹å‰éƒ½æ˜¯ä¸€è¾¹Diffä¸€è¾¹æäº¤çš„ã€‚å…ˆæ¥çœ‹çœ‹è¿™ä¸¤è€…çš„åŒºåˆ«:</p><ul><li><p><strong>âš›ï¸ åè°ƒé˜¶æ®µ</strong>: å¯ä»¥è®¤ä¸ºæ˜¯ Diff é˜¶æ®µ, <strong>è¿™ä¸ªé˜¶æ®µå¯ä»¥è¢«ä¸­æ–­</strong>, è¿™ä¸ªé˜¶æ®µä¼šæ‰¾å‡ºæ‰€æœ‰èŠ‚ç‚¹å˜æ›´ï¼Œä¾‹å¦‚èŠ‚ç‚¹æ–°å¢ã€åˆ é™¤ã€å±æ€§å˜æ›´ç­‰ç­‰, è¿™äº›å˜æ›´React ç§°ä¹‹ä¸ºâ€™<code>å‰¯ä½œç”¨</code>(Effect)â€™ . ä»¥ä¸‹ç”Ÿå‘½å‘¨æœŸé’©å­ä¼šåœ¨åè°ƒé˜¶æ®µè¢«è°ƒç”¨ï¼š</p><ul><li>constructor</li><li>componentWillMount åºŸå¼ƒ</li><li>componentWillReceiveProps åºŸå¼ƒ</li><li>static getDerivedStateFromProps</li><li>shouldComponentUpdate</li><li>componentWillUpdate åºŸå¼ƒ</li><li>render</li><li>getSnapshotBeforeUpdate()</li></ul></li><li><p><strong>âš›ï¸ æäº¤é˜¶æ®µ</strong>: å°†ä¸Šä¸€ä¸ªé˜¶æ®µè®¡ç®—å‡ºæ¥çš„éœ€è¦å¤„ç†çš„<strong>å‰¯ä½œç”¨(Effects)</strong>ä¸€æ¬¡æ€§æ‰§è¡Œäº†ã€‚<strong>è¿™ä¸ªé˜¶æ®µå¿…é¡»åŒæ­¥æ‰§è¡Œï¼Œä¸èƒ½è¢«æ‰“æ–­</strong>. è¿™äº›ç”Ÿå‘½å‘¨æœŸé’©å­åœ¨æäº¤é˜¶æ®µè¢«æ‰§è¡Œ:</p><ul><li>componentDidMount</li><li>componentDidUpdate</li><li>componentWillUnmount</li></ul></li></ul><p><br></p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨åè°ƒé˜¶æ®µå¦‚æœæ—¶é—´ç‰‡ç”¨å®Œï¼ŒReactå°±ä¼šé€‰æ‹©è®©å‡ºæ§åˆ¶æƒã€‚å› ä¸ºåè°ƒé˜¶æ®µæ‰§è¡Œçš„å·¥ä½œä¸ä¼šå¯¼è‡´ä»»ä½•ç”¨æˆ·å¯è§çš„å˜æ›´ï¼Œæ‰€ä»¥åœ¨è¿™ä¸ªé˜¶æ®µè®©å‡ºæ§åˆ¶æƒä¸ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼šå› ä¸ºåè°ƒé˜¶æ®µå¯èƒ½è¢«ä¸­æ–­ã€æ¢å¤ï¼Œç”šè‡³é‡åšï¼Œ<strong>âš ï¸React åè°ƒé˜¶æ®µçš„ç”Ÿå‘½å‘¨æœŸé’©å­å¯èƒ½ä¼šè¢«è°ƒç”¨å¤šæ¬¡!</strong>, ä¾‹å¦‚ <code>componentWillMount</code> å¯èƒ½ä¼šè¢«è°ƒç”¨ä¸¤æ¬¡ã€‚ </p><p>å› æ­¤å»ºè®® <strong>åè°ƒé˜¶æ®µçš„ç”Ÿå‘½å‘¨æœŸé’©å­ä¸è¦åŒ…å«å‰¯ä½œç”¨</strong>. ç´¢æ€§ React å°±åºŸå¼ƒäº†è¿™éƒ¨åˆ†å¯èƒ½åŒ…å«å‰¯ä½œç”¨çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œä¾‹å¦‚<code>componentWillMount</code>ã€<code>componentWillUpdate</code>. v17åæˆ‘ä»¬å°±ä¸èƒ½å†ç”¨å®ƒä»¬äº†, æ‰€ä»¥ç°æœ‰çš„åº”ç”¨åº”è¯¥å°½å¿«è¿ç§».</p><p><br></p><p>ç°åœ¨ä½ åº”è¯¥çŸ¥é“ä¸ºä»€ä¹ˆâ€™æäº¤é˜¶æ®µâ€™å¿…é¡»åŒæ­¥æ‰§è¡Œï¼Œä¸èƒ½ä¸­æ–­çš„å§ï¼Ÿ å› ä¸ºæˆ‘ä»¬è¦æ­£ç¡®åœ°å¤„ç†å„ç§å‰¯ä½œç”¨ï¼ŒåŒ…æ‹¬DOMå˜æ›´ã€è¿˜æœ‰ä½ åœ¨<code>componentDidMount</code>ä¸­å‘èµ·çš„å¼‚æ­¥è¯·æ±‚ã€useEffect ä¸­å®šä¹‰çš„å‰¯ä½œç”¨â€¦ å› ä¸ºæœ‰å‰¯ä½œç”¨ï¼Œæ‰€ä»¥å¿…é¡»ä¿è¯æŒ‰ç…§æ¬¡åºåªè°ƒç”¨ä¸€æ¬¡ï¼Œå†µä¸”ä¼šæœ‰ç”¨æˆ·å¯ä»¥å¯Ÿè§‰åˆ°çš„å˜æ›´, ä¸å®¹å·®æ± ã€‚</p><p>å…³äºä¸ºä»€ä¹ˆè¦æ‹†åˆ†ä¸¤ä¸ªé˜¶æ®µï¼Œ<a href="https://github.com/facebook/react/issues/13186#issuecomment-403959161" target="_blank" rel="noopener">è¿™é‡Œ</a>æœ‰æ›´è¯¦ç»†çš„è§£é‡Šã€‚</p><p><br><br><br></p><h3 id="3-reconcilation"><a href="#3-reconcilation" class="headerlink" title="3. Reconcilation"></a>3. Reconcilation</h3><p>æ¥ä¸‹æ¥å°±æ˜¯å°±æ˜¯æˆ‘ä»¬ç†ŸçŸ¥çš„<code>Reconcilation</code>(ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œæœ¬æ–‡ä¸åŒºåˆ†Diffå’ŒReconcilation, ä¸¤è€…æ˜¯åŒä¸€ä¸ªä¸œè¥¿)é˜¶æ®µäº†. <strong>æ€è·¯å’Œ Fiber é‡æ„ä¹‹å‰å·®åˆ«ä¸å¤§, åªä¸è¿‡è¿™é‡Œä¸ä¼šå†é€’å½’å»æ¯”å¯¹ã€è€Œä¸”ä¸ä¼šé©¬ä¸Šæäº¤å˜æ›´</strong>ã€‚</p><p>é¦–å…ˆå†è¿›ä¸€æ­¥çœ‹ä¸€ä¸‹<code>Fiber</code>çš„ç»“æ„:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">interface</span> Fiber &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * âš›ï¸ èŠ‚ç‚¹çš„ç±»å‹ä¿¡æ¯</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="comment">// æ ‡è®° Fiber ç±»å‹, ä¾‹å¦‚å‡½æ•°ç»„ä»¶ã€ç±»ç»„ä»¶ã€å®¿ä¸»ç»„ä»¶</span></span><br><span class="line">  tag: WorkTag,</span><br><span class="line">  <span class="comment">// èŠ‚ç‚¹å…ƒç´ ç±»å‹, æ˜¯å…·ä½“çš„ç±»ç»„ä»¶ã€å‡½æ•°ç»„ä»¶ã€å®¿ä¸»ç»„ä»¶(å­—ç¬¦ä¸²)</span></span><br><span class="line">  <span class="keyword">type</span>: <span class="built_in">any</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * âš›ï¸ ç»“æ„ä¿¡æ¯</span></span><br><span class="line"><span class="comment">   */</span> </span><br><span class="line">  <span class="keyword">return</span>: Fiber | <span class="literal">null</span>,</span><br><span class="line">  child: Fiber | <span class="literal">null</span>,</span><br><span class="line">  sibling: Fiber | <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// å­èŠ‚ç‚¹çš„å”¯ä¸€é”®, å³æˆ‘ä»¬æ¸²æŸ“åˆ—è¡¨ä¼ å…¥çš„keyå±æ€§</span></span><br><span class="line">  key: <span class="literal">null</span> | <span class="built_in">string</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * âš›ï¸ èŠ‚ç‚¹çš„çŠ¶æ€</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="comment">// èŠ‚ç‚¹å®ä¾‹(çŠ¶æ€)ï¼š</span></span><br><span class="line">  <span class="comment">//        å¯¹äºå®¿ä¸»ç»„ä»¶ï¼Œè¿™é‡Œä¿å­˜å®¿ä¸»ç»„ä»¶çš„å®ä¾‹, ä¾‹å¦‚DOMèŠ‚ç‚¹ã€‚</span></span><br><span class="line">  <span class="comment">//        å¯¹äºç±»ç»„ä»¶æ¥è¯´ï¼Œè¿™é‡Œä¿å­˜ç±»ç»„ä»¶çš„å®ä¾‹</span></span><br><span class="line">  <span class="comment">//        å¯¹äºå‡½æ•°ç»„ä»¶è¯´ï¼Œè¿™é‡Œä¸ºç©ºï¼Œå› ä¸ºå‡½æ•°ç»„ä»¶æ²¡æœ‰å®ä¾‹</span></span><br><span class="line">  stateNode: <span class="built_in">any</span>,</span><br><span class="line">  <span class="comment">// æ–°çš„ã€å¾…å¤„ç†çš„props</span></span><br><span class="line">  pendingProps: <span class="built_in">any</span>,</span><br><span class="line">  <span class="comment">// ä¸Šä¸€æ¬¡æ¸²æŸ“çš„props</span></span><br><span class="line">  memoizedProps: <span class="built_in">any</span>, <span class="comment">// The props used to create the output.</span></span><br><span class="line">  <span class="comment">// ä¸Šä¸€æ¬¡æ¸²æŸ“çš„ç»„ä»¶çŠ¶æ€</span></span><br><span class="line">  memoizedState: <span class="built_in">any</span>,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * âš›ï¸ å‰¯ä½œç”¨</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="comment">// å½“å‰èŠ‚ç‚¹çš„å‰¯ä½œç”¨ç±»å‹ï¼Œä¾‹å¦‚èŠ‚ç‚¹æ›´æ–°ã€åˆ é™¤ã€ç§»åŠ¨</span></span><br><span class="line">  effectTag: SideEffectTag,</span><br><span class="line">  <span class="comment">// å’ŒèŠ‚ç‚¹å…³ç³»ä¸€æ ·ï¼ŒReact åŒæ ·ä½¿ç”¨é“¾è¡¨æ¥å°†æ‰€æœ‰æœ‰å‰¯ä½œç”¨çš„Fiberè¿æ¥èµ·æ¥</span></span><br><span class="line">  nextEffect: Fiber | <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * âš›ï¸ æ›¿èº«</span></span><br><span class="line"><span class="comment">   * æŒ‡å‘æ—§æ ‘ä¸­çš„èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  alternate: Fiber | <span class="literal">null</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>Fiber åŒ…å«çš„å±æ€§å¯ä»¥åˆ’åˆ†ä¸º 5 ä¸ªéƒ¨åˆ†:</p><ul><li><strong>ğŸ†• ç»“æ„ä¿¡æ¯</strong> - è¿™ä¸ªä¸Šæ–‡æˆ‘ä»¬å·²ç»è§è¿‡äº†ï¼ŒFiber ä½¿ç”¨é“¾è¡¨çš„å½¢å¼æ¥è¡¨ç¤ºèŠ‚ç‚¹åœ¨æ ‘ä¸­çš„å®šä½</li><li><strong>èŠ‚ç‚¹ç±»å‹ä¿¡æ¯</strong> - è¿™ä¸ªä¹Ÿå®¹æ˜“ç†è§£ï¼Œtagè¡¨ç¤ºèŠ‚ç‚¹çš„åˆ†ç±»ã€type ä¿å­˜å…·ä½“çš„ç±»å‹å€¼ï¼Œå¦‚divã€MyComp</li><li><strong>èŠ‚ç‚¹çš„çŠ¶æ€</strong> - èŠ‚ç‚¹çš„ç»„ä»¶å®ä¾‹ã€propsã€stateç­‰ï¼Œå®ƒä»¬å°†å½±å“ç»„ä»¶çš„è¾“å‡º</li><li><p><strong>ğŸ†• å‰¯ä½œç”¨</strong> - è¿™ä¸ªä¹Ÿæ˜¯æ–°ä¸œè¥¿. åœ¨ Reconciliation è¿‡ç¨‹ä¸­å‘ç°çš„â€™å‰¯ä½œç”¨â€™(å˜æ›´éœ€æ±‚)å°±ä¿å­˜åœ¨èŠ‚ç‚¹çš„<code>effectTag</code> ä¸­(æƒ³è±¡ä¸ºæ‰“ä¸Šä¸€ä¸ªæ ‡è®°).<br>é‚£ä¹ˆæ€ä¹ˆå°†æœ¬æ¬¡æ¸²æŸ“çš„æ‰€æœ‰èŠ‚ç‚¹å‰¯ä½œç”¨éƒ½æ”¶é›†èµ·æ¥å‘¢ï¼Ÿ è¿™é‡Œä¹Ÿä½¿ç”¨äº†é“¾è¡¨ç»“æ„ï¼Œåœ¨éå†è¿‡ç¨‹ä¸­Reactä¼šå°†æ‰€æœ‰æœ‰â€˜å‰¯ä½œç”¨â€™çš„èŠ‚ç‚¹éƒ½é€šè¿‡<code>nextEffect</code>è¿æ¥èµ·æ¥</p></li><li><p><strong>ğŸ†• æ›¿èº«</strong> - React åœ¨ Reconciliation è¿‡ç¨‹ä¸­ä¼šæ„å»ºä¸€é¢—æ–°çš„æ ‘(å®˜æ–¹ç§°ä¸ºworkInProgress treeï¼Œ<strong>WIPæ ‘</strong>)ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ä¸€é¢—è¡¨ç¤ºå½“å‰å·¥ä½œè¿›åº¦çš„æ ‘ã€‚è¿˜æœ‰ä¸€é¢—è¡¨ç¤ºå·²æ¸²æŸ“ç•Œé¢çš„<strong>æ—§æ ‘</strong>ï¼ŒReactå°±æ˜¯ä¸€è¾¹å’Œæ—§æ ‘æ¯”å¯¹ï¼Œä¸€è¾¹æ„å»ºWIPæ ‘çš„ã€‚ alternate æŒ‡å‘æ—§æ ‘çš„åŒç­‰èŠ‚ç‚¹ã€‚</p></li></ul><p><br></p><p>ç°åœ¨å¯ä»¥æ”¾å¤§çœ‹çœ‹<code>beginWork</code>  æ˜¯å¦‚ä½•å¯¹ Fiber è¿›è¡Œæ¯”å¯¹çš„:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">beginWork</span>(<span class="params">fiber: Fiber</span>): <span class="title">Fiber</span> | <span class="title">undefined</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (fiber.tag === WorkTag.HostComponent) &#123;</span><br><span class="line">    <span class="comment">// å®¿ä¸»èŠ‚ç‚¹diff</span></span><br><span class="line">    diffHostComponent(fiber)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fiber.tag === WorkTag.ClassComponent) &#123;</span><br><span class="line">    <span class="comment">// ç±»ç»„ä»¶èŠ‚ç‚¹diff</span></span><br><span class="line">    diffClassComponent(fiber)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fiber.tag === WorkTag.FunctionComponent) &#123;</span><br><span class="line">    <span class="comment">// å‡½æ•°ç»„ä»¶èŠ‚ç‚¹diff</span></span><br><span class="line">    diffFunctionalComponent(fiber)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// ... å…¶ä»–ç±»å‹èŠ‚ç‚¹ï¼Œçœç•¥</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>å®¿ä¸»èŠ‚ç‚¹æ¯”å¯¹:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">diffHostComponent</span>(<span class="params">fiber: Fiber</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// æ–°å¢èŠ‚ç‚¹</span></span><br><span class="line">  <span class="keyword">if</span> (fiber.stateNode == <span class="literal">null</span>) &#123;</span><br><span class="line">    fiber.stateNode = createHostComponent(fiber)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    updateHostComponent(fiber)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> newChildren = fiber.pendingProps.children;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ¯”å¯¹å­èŠ‚ç‚¹</span></span><br><span class="line">  diffChildren(fiber, newChildren);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>ç±»ç»„ä»¶èŠ‚ç‚¹æ¯”å¯¹ä¹Ÿå·®ä¸å¤š:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">diffClassComponent</span>(<span class="params">fiber: Fiber</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// åˆ›å»ºç»„ä»¶å®ä¾‹</span></span><br><span class="line">  <span class="keyword">if</span> (fiber.stateNode == <span class="literal">null</span>) &#123;</span><br><span class="line">    fiber.stateNode = createInstance(fiber);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fiber.hasMounted) &#123;</span><br><span class="line">    <span class="comment">// è°ƒç”¨æ›´æ–°å‰ç”Ÿå‘½å‘¨æœŸé’©å­</span></span><br><span class="line">    applybeforeUpdateHooks(fiber)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// è°ƒç”¨æŒ‚è½½å‰ç”Ÿå‘½å‘¨æœŸé’©å­</span></span><br><span class="line">    applybeforeMountHooks(fiber)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ¸²æŸ“æ–°èŠ‚ç‚¹</span></span><br><span class="line">  <span class="keyword">const</span> newChildren = fiber.stateNode.render();</span><br><span class="line">  <span class="comment">// æ¯”å¯¹å­èŠ‚ç‚¹</span></span><br><span class="line">  diffChildren(fiber, newChildren);</span><br><span class="line"></span><br><span class="line">  fiber.memoizedState = fiber.stateNode.state</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>å­èŠ‚ç‚¹æ¯”å¯¹:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">diffChildren</span>(<span class="params">fiber: Fiber, newChildren: React.ReactNode</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> oldFiber = fiber.alternate ? fiber.alternate.child : <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">// å…¨æ–°èŠ‚ç‚¹ï¼Œç›´æ¥æŒ‚è½½</span></span><br><span class="line">  <span class="keyword">if</span> (oldFiber == <span class="literal">null</span>) &#123;</span><br><span class="line">    mountChildFibers(fiber, newChildren)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> index = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">let</span> newFiber = <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">// æ–°å­èŠ‚ç‚¹</span></span><br><span class="line">  <span class="keyword">const</span> elements = extraElements(newChildren)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ¯”å¯¹å­å…ƒç´ </span></span><br><span class="line">  <span class="keyword">while</span> (index &lt; elements.length || oldFiber != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> prevFiber = newFiber;</span><br><span class="line">    <span class="keyword">const</span> element = elements[index]</span><br><span class="line">    <span class="keyword">const</span> sameType = isSameType(element, oldFiber)</span><br><span class="line">    <span class="keyword">if</span> (sameType) &#123;</span><br><span class="line">      newFiber = cloneFiber(oldFiber, element)</span><br><span class="line">      <span class="comment">// æ›´æ–°å…³ç³»</span></span><br><span class="line">      newFiber.alternate = oldFiber</span><br><span class="line">      <span class="comment">// æ‰“ä¸ŠTag</span></span><br><span class="line">      newFiber.effectTag = UPDATE</span><br><span class="line">      newFiber.return = fiber</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–°èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (element &amp;&amp; !sameType) &#123;</span><br><span class="line">      newFiber = createFiber(element)</span><br><span class="line">      newFiber.effectTag = PLACEMENT</span><br><span class="line">      newFiber.return = fiber</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ é™¤æ—§èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (oldFiber &amp;&amp; !sameType) &#123;</span><br><span class="line">      oldFiber.effectTag = DELETION;</span><br><span class="line">      oldFiber.nextEffect = fiber.nextEffect</span><br><span class="line">      fiber.nextEffect = oldFiber</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (oldFiber) &#123;</span><br><span class="line">      oldFiber = oldFiber.sibling;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (index == <span class="number">0</span>) &#123;</span><br><span class="line">      fiber.child = newFiber;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (prevFiber &amp;&amp; element) &#123;</span><br><span class="line">      prevFiber.sibling = newFiber;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    index++</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>ä¸Šé¢çš„ä»£ç å¾ˆç²—ç³™åœ°è¿˜åŸäº† Reconciliation çš„è¿‡ç¨‹, ä½†æ˜¯å¯¹äºæˆ‘ä»¬ç†è§£Reactçš„åŸºæœ¬åŸç†å·²ç»è¶³å¤Ÿäº†.</p><p><br></p><p>è¿™é‡Œå¼•ç”¨ä¸€ä¸‹<a href="https://www.youtube.com/watch?v=ZCuYPiUIONs" target="_blank" rel="noopener">Youtube: Lin Clark presentation in ReactConf 2017</a> çš„Slideï¼Œæ¥è¿˜åŸ Reconciliation çš„è¿‡ç¨‹. Lin Clark è¿™ä¸ªæ¼”è®²å¤ªç»å…¸äº†ï¼Œå‡ ä¹æ‰€æœ‰ä»‹ç» React Fiber çš„æ–‡ç« éƒ½ä¼šå¼•ç”¨å®ƒçš„Slide. å·ä¸ªæ‡’ï¼Œæˆ‘ä¹Ÿç”¨ä¸‹:</p><blockquote><p>è¿™ç¯‡æ–‡ç« <a href="https://juejin.im/post/5ab7b3a2f265da2378403e57" target="_blank" rel="noopener">ã€ŠReact Fiberã€‹</a> ç”¨æ–‡å­—ç‰ˆè§£é‡Šäº†Link Clark Slide.</p></blockquote><p><img src="/images/react-fiber/effect-tag.png" alt></p><p><br></p><p>ä¸Šå›¾æ˜¯ Reconciliation å®Œæˆåçš„çŠ¶æ€ï¼Œå·¦è¾¹æ˜¯æ—§æ ‘ï¼Œå³è¾¹æ˜¯WIPæ ‘ã€‚å¯¹äºéœ€è¦å˜æ›´çš„èŠ‚ç‚¹ï¼Œéƒ½æ‰“ä¸Šäº†â€™æ ‡ç­¾â€™ã€‚ åœ¨æäº¤é˜¶æ®µï¼ŒReact å°±ä¼šå°†è¿™äº›æ‰“ä¸Šæ ‡ç­¾çš„èŠ‚ç‚¹åº”ç”¨å˜æ›´ã€‚</p><p><br><br><br></p><h3 id="4-åŒç¼“å†²"><a href="#4-åŒç¼“å†²" class="headerlink" title="4. åŒç¼“å†²"></a>4. åŒç¼“å†²</h3><p><code>WIP æ ‘</code>æ„å»ºè¿™ç§æŠ€æœ¯ç±»ä¼¼äºå›¾å½¢åŒ–é¢†åŸŸçš„â€™<strong>åŒç¼“å­˜(Double Buffering)</strong>â€˜æŠ€æœ¯, å›¾å½¢ç»˜åˆ¶å¼•æ“ä¸€èˆ¬ä¼šä½¿ç”¨åŒç¼“å†²æŠ€æœ¯ï¼Œå…ˆå°†å›¾ç‰‡ç»˜åˆ¶åˆ°ä¸€ä¸ªç¼“å†²åŒºï¼Œå†ä¸€æ¬¡æ€§ä¼ é€’ç»™å±å¹•è¿›è¡Œæ˜¾ç¤ºï¼Œè¿™æ ·å¯ä»¥é˜²æ­¢å±å¹•æŠ–åŠ¨ï¼Œä¼˜åŒ–æ¸²æŸ“æ€§èƒ½ã€‚</p><p>æ”¾åˆ°React ä¸­ï¼ŒWIPæ ‘å°±æ˜¯ä¸€ä¸ªç¼“å†²ï¼Œå®ƒåœ¨Reconciliation å®Œæ¯•åä¸€æ¬¡æ€§æäº¤ç»™æµè§ˆå™¨è¿›è¡Œæ¸²æŸ“ã€‚å®ƒå¯ä»¥å‡å°‘å†…å­˜åˆ†é…å’Œåƒåœ¾å›æ”¶ï¼ŒWIP çš„èŠ‚ç‚¹ä¸å®Œå…¨æ˜¯æ–°çš„ï¼Œæ¯”å¦‚æŸé¢—å­æ ‘ä¸éœ€è¦å˜åŠ¨ï¼ŒReactä¼šå…‹éš†å¤ç”¨æ—§æ ‘ä¸­çš„å­æ ‘ã€‚</p><p>åŒç¼“å­˜æŠ€æœ¯è¿˜æœ‰å¦å¤–ä¸€ä¸ªé‡è¦çš„åœºæ™¯å°±æ˜¯å¼‚å¸¸çš„å¤„ç†ï¼Œæ¯”å¦‚å½“ä¸€ä¸ªèŠ‚ç‚¹æŠ›å‡ºå¼‚å¸¸ï¼Œä»ç„¶å¯ä»¥ç»§ç»­æ²¿ç”¨æ—§æ ‘çš„èŠ‚ç‚¹ï¼Œé¿å…æ•´æ£µæ ‘æŒ‚æ‰ã€‚</p><p>Dan åœ¨ <a href="https://reactjs.org/blog/2018/03/01/sneak-peek-beyond-react-16.html" target="_blank" rel="noopener">Beyond React 16</a> æ¼”è®²ä¸­ç”¨äº†ä¸€ä¸ªéå¸¸æ°å½“çš„æ¯”å–»ï¼Œé‚£å°±æ˜¯Git åŠŸèƒ½åˆ†æ”¯ï¼Œ<strong>ä½ å¯ä»¥å°† WIP æ ‘æƒ³è±¡æˆä»æ—§æ ‘ä¸­ Fork å‡ºæ¥çš„åŠŸèƒ½åˆ†æ”¯ï¼Œä½ åœ¨è¿™æ–°åˆ†æ”¯ä¸­æ·»åŠ æˆ–ç§»é™¤ç‰¹æ€§ï¼Œå³ä½¿æ˜¯æ“ä½œå¤±è¯¯ä¹Ÿä¸ä¼šå½±å“æ—§çš„åˆ†æ”¯ã€‚å½“ä½ è¿™ä¸ªåˆ†æ”¯ç»è¿‡äº†æµ‹è¯•å’Œå®Œå–„ï¼Œå°±å¯ä»¥åˆå¹¶åˆ°æ—§åˆ†æ”¯ï¼Œå°†å…¶æ›¿æ¢æ‰. è¿™æˆ–è®¸å°±æ˜¯â€™æäº¤(commit)é˜¶æ®µâ€˜çš„æäº¤ä¸€è¯çš„æ¥æºå§ï¼Ÿ</strong>:</p><p><br></p><p><img src="/images/react-fiber/gitbranch.png" alt></p><p><br><br><br></p><h3 id="5-å‰¯ä½œç”¨çš„æ”¶é›†å’Œæäº¤"><a href="#5-å‰¯ä½œç”¨çš„æ”¶é›†å’Œæäº¤" class="headerlink" title="5. å‰¯ä½œç”¨çš„æ”¶é›†å’Œæäº¤"></a>5. å‰¯ä½œç”¨çš„æ”¶é›†å’Œæäº¤</h3><p>æ¥ä¸‹æ¥å°±æ˜¯å°†æ‰€æœ‰æ‰“äº† Effect æ ‡è®°çš„èŠ‚ç‚¹ä¸²è”èµ·æ¥ï¼Œè¿™ä¸ªå¯ä»¥åœ¨<code>completeWork</code>ä¸­åš, ä¾‹å¦‚:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">completeWork</span>(<span class="params">fiber</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> parent = fiber.return</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ°è¾¾é¡¶ç«¯</span></span><br><span class="line">  <span class="keyword">if</span> (parent == <span class="literal">null</span> || fiber === topWork) &#123;</span><br><span class="line">    pendingCommit = fiber</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fiber.effectTag != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (parent.nextEffect) &#123;</span><br><span class="line">      parent.nextEffect.nextEffect = fiber</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      parent.nextEffect = fiber</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fiber.nextEffect) &#123;</span><br><span class="line">    parent.nextEffect = fiber.nextEffect</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>æœ€åäº†ï¼Œå°†æ‰€æœ‰å‰¯ä½œç”¨æäº¤äº†:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitAllWork</span>(<span class="params">fiber</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> next = fiber</span><br><span class="line">  <span class="keyword">while</span>(next) &#123;</span><br><span class="line">    <span class="keyword">if</span> (fiber.effectTag) &#123;</span><br><span class="line">      <span class="comment">// æäº¤ï¼Œå·ä¸€ä¸‹æ‡’ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†</span></span><br><span class="line">      commitWork(fiber)</span><br><span class="line">    &#125;</span><br><span class="line">    next = fiber.nextEffect</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ¸…ç†ç°åœº</span></span><br><span class="line">  pendingCommit = nextUnitOfWork = topWork = <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br><br><br></p><h2 id="âš ï¸-æœªå±•å¼€éƒ¨åˆ†-ğŸš§-â€“-ä¸­æ–­å’Œæ¢å¤"><a href="#âš ï¸-æœªå±•å¼€éƒ¨åˆ†-ğŸš§-â€“-ä¸­æ–­å’Œæ¢å¤" class="headerlink" title="âš ï¸ æœªå±•å¼€éƒ¨åˆ† ğŸš§ â€“ ä¸­æ–­å’Œæ¢å¤"></a>âš ï¸ æœªå±•å¼€éƒ¨åˆ† ğŸš§ â€“ ä¸­æ–­å’Œæ¢å¤</h2><p>ä¸Šæ–‡åªæ˜¯ä»‹ç»äº†ç®€å•çš„ä¸­æ–­å’Œæ¢å¤æœºåˆ¶ï¼Œæˆ‘ä»¬ä»å“ªé‡Œè·Œå€’å°±ä»å“ªé‡Œç«™èµ·æ¥ï¼Œåœ¨å“ªä¸ªèŠ‚ç‚¹ä¸­æ–­å°±ä»å“ªä¸ªèŠ‚ç‚¹ç»§ç»­å¤„ç†ä¸‹å»ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œåˆ°ç›®å‰ä¸ºæ­¢ï¼š<strong>âš ï¸æ›´æ–°ä»»åŠ¡è¿˜æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ï¼Œæˆ‘ä»¬åªæ˜¯å°†æ•´ä¸ªè¿‡ç¨‹ç¢ç‰‡åŒ–äº†. å¯¹äºé‚£äº›éœ€è¦ä¼˜å…ˆå¤„ç†çš„æ›´æ–°ä»»åŠ¡è¿˜æ˜¯ä¼šè¢«é˜»å¡</strong>ã€‚æˆ‘ä¸ªäººè§‰å¾—è¿™æ‰æ˜¯ React Fiber ä¸­æœ€éš¾å¤„ç†çš„ä¸€éƒ¨åˆ†ã€‚</p><p><strong>å®é™…æƒ…å†µæ˜¯ï¼Œåœ¨ React å¾—åˆ°æ§åˆ¶æƒåï¼Œåº”è¯¥ä¼˜å…ˆå¤„ç†é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡</strong>ã€‚ä¹Ÿå°±æ˜¯è¯´ä¸­æ–­æ—¶æ­£åœ¨å¤„ç†çš„ä»»åŠ¡ï¼Œåœ¨æ¢å¤æ—¶ä¼šè®©ä½ç»™é«˜ä¼˜å…ˆçº§ä»»åŠ¡ï¼ŒåŸæœ¬ä¸­æ–­çš„ä»»åŠ¡å¯èƒ½ä¼šè¢«æ”¾å¼ƒæˆ–è€…é‡åšã€‚</p><p><strong>ä½†æ˜¯å¦‚æœä¸æŒ‰é¡ºåºæ‰§è¡Œä»»åŠ¡ï¼Œå¯èƒ½ä¼šå¯¼è‡´å‰åçš„çŠ¶æ€ä¸ä¸€è‡´</strong>ã€‚ æ¯”å¦‚ä½ä¼˜å…ˆçº§ä»»åŠ¡å°† <code>a</code> è®¾ç½®ä¸º0ï¼Œè€Œé«˜ä¼˜å…ˆçº§ä»»åŠ¡å°† <code>a</code> é€’å¢1, ä¸¤ä¸ªä»»åŠ¡çš„æ‰§è¡Œé¡ºåºä¼šå½±å“æœ€ç»ˆçš„æ¸²æŸ“ç»“æœã€‚å› æ­¤<strong>è¦è®©é«˜ä¼˜å…ˆçº§ä»»åŠ¡æ’é˜Ÿ, é¦–å…ˆè¦ä¿è¯çŠ¶æ€æ›´æ–°çš„æ—¶åº</strong>ã€‚</p><p><br></p><p>è§£å†³åŠæ³•æ˜¯: <strong>æ‰€æœ‰æ›´æ–°ä»»åŠ¡æŒ‰ç…§é¡ºåºæ’å…¥ä¸€ä¸ªé˜Ÿåˆ—, çŠ¶æ€å¿…é¡»æŒ‰ç…§æ’å…¥é¡ºåºè¿›è¡Œè®¡ç®—ï¼Œä½†ä»»åŠ¡å¯ä»¥æŒ‰ä¼˜å…ˆçº§é¡ºåºæ‰§è¡Œ</strong>, ä¾‹å¦‚ï¼š</p><p><br></p><p><img src="/images/react-fiber/resume-1.png" alt></p><p><br></p><p>çº¢è‰²è¡¨ç¤ºé«˜ä¼˜å…ˆçº§ä»»åŠ¡ã€‚è¦è®¡ç®—å®ƒçš„çŠ¶æ€å¿…é¡»åŸºäºå‰åºä»»åŠ¡è®¡ç®—å‡ºæ¥çš„çŠ¶æ€, ä»è€Œä¿è¯<strong>çŠ¶æ€çš„æœ€ç»ˆä¸€è‡´æ€§</strong>ï¼š</p><p><br></p><p><img src="/images/react-fiber/resume-2.png" alt></p><p>æœ€ç»ˆçº¢è‰²çš„é«˜ä¼˜å…ˆçº§ä»»åŠ¡ <code>C</code> æ‰§è¡Œæ—¶çš„çŠ¶æ€å€¼æ˜¯<code>a=5,b=3</code>. åœ¨æ¢å¤æ§åˆ¶æƒæ—¶ï¼Œä¼šæŒ‰ç…§ä¼˜å…ˆçº§å…ˆæ‰§è¡Œ <code>C</code>, å‰é¢çš„<code>A</code>ã€ <code>B</code>æš‚æ—¶è·³è¿‡</p><p><br></p><p><img src="/images/react-fiber/resume-3.png" alt></p><p><br></p><p>ä¸Šé¢è¢«è·³è¿‡ä»»åŠ¡ä¸ä¼šè¢«ç§»é™¤ï¼Œåœ¨æ‰§è¡Œå®Œé«˜ä¼˜å…ˆçº§ä»»åŠ¡åå®ƒä»¬è¿˜æ˜¯ä¼šè¢«æ‰§è¡Œçš„ã€‚å› ä¸ºä¸åŒçš„æ›´æ–°ä»»åŠ¡å½±å“çš„èŠ‚ç‚¹æ ‘èŒƒå›´å¯èƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œä¸¾ä¸ªä¾‹å­ <code>a</code>ã€<code>b</code> å¯èƒ½ä¼šå½±å“ <code>Foo</code> ç»„ä»¶æ ‘ï¼Œè€Œ <code>c</code> ä¼šå½±å“ <code>Bar</code> ç»„ä»¶æ ‘ã€‚æ‰€ä»¥ä¸ºäº†ä¿è¯<strong>è§†å›¾çš„æœ€ç»ˆä¸€è‡´æ€§</strong>, æ‰€æœ‰æ›´æ–°ä»»åŠ¡éƒ½è¦è¢«æ‰§è¡Œã€‚</p><p><br></p><p><img src="/images/react-fiber/resume-4.png" alt></p><p>é¦–å…ˆ <code>C</code> å…ˆè¢«æ‰§è¡Œï¼Œå®ƒæ›´æ–°äº† <code>Foo</code> ç»„ä»¶</p><p>æ¥ç€æ‰§è¡Œ <code>A</code> ä»»åŠ¡ï¼Œå®ƒæ›´æ–°äº†<code>Foo</code> å’Œ <code>Bar</code> ç»„ä»¶ï¼Œç”±äº <code>C</code> å·²ç»ä»¥æœ€ç»ˆçŠ¶æ€<code>a=5, b=3</code>æ›´æ–°äº†<code>Foo</code>ç»„ä»¶ï¼Œè¿™é‡Œå¯ä»¥åšä¸€ä¸‹æ€§èƒ½ä¼˜åŒ–ï¼Œç›´æ¥å¤ç”¨Cçš„æ›´æ–°ç»“æœï¼Œ ä¸å¿…è§¦å‘é‡æ–°æ¸²æŸ“ã€‚å› æ­¤ <code>A</code> ä»…éœ€æ›´æ–° <code>Bar</code> ç»„ä»¶å³å¯ã€‚</p><p>æ¥ç€æ‰§è¡Œ <code>B</code>ï¼ŒåŒç†å¯ä»¥å¤ç”¨ Foo æ›´æ–°ç»“æœã€‚</p><p><br></p><p>é“ç†è®²èµ·æ¥éƒ½å¾ˆç®€å•ï¼ŒReact Fiber å®é™…ä¸Šéå¸¸å¤æ‚ï¼Œä¸ç®¡æ‰§è¡Œçš„è¿‡ç¨‹æ€æ ·æ‹†åˆ†ã€ä»¥ä»€ä¹ˆé¡ºåºæ‰§è¡Œï¼Œæœ€é‡è¦çš„æ˜¯ä¿è¯<strong>çŠ¶æ€çš„ä¸€è‡´æ€§</strong>å’Œ<strong>è§†å›¾çš„ä¸€è‡´æ€§</strong>ï¼Œè¿™ç»™äº† React å›¢é˜Ÿå¾ˆå¤§çš„è€ƒéªŒï¼Œä»¥è‡´äºç°åœ¨éƒ½æ²¡æœ‰æ­£å¼releaseå‡ºæ¥ã€‚</p><p><br><br><br></p><h2 id="å‡Œæ³¢å¾®æ­¥"><a href="#å‡Œæ³¢å¾®æ­¥" class="headerlink" title="å‡Œæ³¢å¾®æ­¥"></a>å‡Œæ³¢å¾®æ­¥</h2><p><img src="/images/react-fiber/new-frame.jpg" alt><br><i>åŒæ ·æ¥è‡ªLink Clark çš„ Slider</i></p><p>å‰é¢è¯´äº†ä¸€å¤§å †ï¼Œä»æ“ä½œç³»ç»Ÿè¿›ç¨‹è°ƒåº¦ã€åˆ°æµè§ˆå™¨åŸç†ã€å†åˆ°åˆä½œå¼è°ƒåº¦ã€æœ€åè°ˆäº†Reactçš„åŸºæœ¬æ”¹é€ å·¥ä½œ, åœ°è€å¤©è’â€¦ å°±æ˜¯ä¸ºäº†ä¸Šé¢çš„å°äººå¯ä»¥åœ¨ç»ƒå°±å‡Œæ³¢å¾®æ­¥, å®ƒè„šä¸‹çš„å‘æ˜¯æµè§ˆå™¨çš„è°ƒç”¨æ ˆã€‚</p><p>React å¼€å¯ <code>Concurrent Mode</code> ä¹‹åå°±ä¸ä¼šæŒ–å¤§å‘äº†ï¼Œè€Œæ˜¯ä¸€å°å‘ä¸€å‘çš„æŒ–ï¼ŒæŒ–ä¸€ä¸‹ä¼‘æ¯ä¸€ä¸‹ï¼Œæœ‰ç´§æ€¥ä»»åŠ¡å°±ä¼˜å…ˆå»åšã€‚</p><p><br></p><p><img src="/images/react-fiber/benifit.png" alt><br><i>æ¥æºï¼š<a href="https://www.youtube.com/watch?v=V1Ly-8Z1wQA&t=207s" target="_blank" rel="noopener">Flarnie Marchan - Ready for Concurrent Mode?</a></i></p><p><br></p><p>å¼€å¯ <code>Concurrent Mode</code> åï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä»¥ä¸‹å¥½å¤„(è¯¦è§<a href="https://www.youtube.com/watch?v=ByBPyMBTzM0" target="_blank" rel="noopener">Concurrent Rendering in React</a>):</p><ul><li>å¿«é€Ÿå“åº”ç”¨æˆ·æ“ä½œå’Œè¾“å…¥ï¼Œæå‡ç”¨æˆ·äº¤äº’ä½“éªŒ</li><li>è®©åŠ¨ç”»æ›´åŠ æµç•…ï¼Œé€šè¿‡è°ƒåº¦ï¼Œå¯ä»¥è®©åº”ç”¨ä¿æŒé«˜å¸§ç‡</li><li>åˆ©ç”¨å¥½I/O æ“ä½œç©ºé—²æœŸæˆ–è€…CPUç©ºé—²æœŸï¼Œè¿›è¡Œä¸€äº›é¢„æ¸²æŸ“ã€‚ æ¯”å¦‚ç¦»å±(offscreen)ä¸å¯è§çš„å†…å®¹ï¼Œä¼˜å…ˆçº§æœ€ä½ï¼Œå¯ä»¥è®© React ç­‰åˆ°CPUç©ºé—²æ—¶æ‰å»æ¸²æŸ“è¿™éƒ¨åˆ†å†…å®¹ã€‚è¿™å’Œæµè§ˆå™¨çš„preloadç­‰é¢„åŠ è½½æŠ€æœ¯å·®ä¸å¤šã€‚</li><li>ç”¨<code>Suspense</code> é™ä½åŠ è½½çŠ¶æ€(load state)çš„ä¼˜å…ˆçº§ï¼Œå‡å°‘é—ªå±ã€‚ æ¯”å¦‚æ•°æ®å¾ˆå¿«è¿”å›æ—¶ï¼Œå¯ä»¥ä¸å¿…æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼Œè€Œæ˜¯ç›´æ¥æ˜¾ç¤ºå‡ºæ¥ï¼Œé¿å…é—ªå±ï¼›å¦‚æœè¶…æ—¶æ²¡æœ‰è¿”å›æ‰æ˜¾å¼åŠ è½½çŠ¶æ€ã€‚</li></ul><p><br></p><p>ä½†æ˜¯å®ƒè‚¯å®šä¸æ˜¯å®Œç¾çš„ï¼Œå› ä¸ºæµè§ˆå™¨æ— æ³•å®ç°æŠ¢å å¼è°ƒåº¦ï¼Œæ— æ³•é˜»æ­¢å¼€å‘è€…åšå‚»äº‹çš„ï¼Œå¼€å‘è€…å¯ä»¥éšå¿ƒæ‰€æ¬²ï¼Œæƒ³æŒ–å¤šå¤§çš„å‘ï¼Œå°±æŒ–å¤šå¤§çš„å‘ã€‚</p><p>ä¸ºäº†å…±åŒåˆ›é€ ç¾å¥½çš„ä¸–ç•Œï¼Œæˆ‘ä»¬è¦ä¸¥å¾‹äºå·±ï¼Œè¯¥åšçš„ä¼˜åŒ–è¿˜éœ€è¦åš: çº¯ç»„ä»¶ã€è™šè¡¨ã€ç®€åŒ–ç»„ä»¶ã€ç¼“å­˜â€¦</p><p>å°¤é›¨æºªåœ¨ä»Šå¹´çš„<a href="https://www.yuque.com/vueconf/2019" target="_blank" rel="noopener">Vue Conf</a>ä¸€ä¸ªè§‚ç‚¹è®©æˆ‘å°è±¡æ·±åˆ»ï¼š<strong>å¦‚æœæˆ‘ä»¬å¯ä»¥æŠŠæ›´æ–°åšå¾—è¶³å¤Ÿå¿«çš„è¯ï¼Œç†è®ºä¸Šå°±ä¸éœ€è¦æ—¶é—´åˆ†ç‰‡äº†</strong>ã€‚</p><p><strong>æ—¶é—´åˆ†ç‰‡å¹¶æ²¡æœ‰é™ä½æ•´ä½“çš„å·¥ä½œé‡ï¼Œè¯¥åšçš„è¿˜æ˜¯è¦åš</strong>, å› æ­¤React ä¹Ÿåœ¨è€ƒè™‘åˆ©ç”¨CPUç©ºé—²æˆ–è€…I/Oç©ºé—²æœŸé—´åšä¸€äº›é¢„æ¸²æŸ“ã€‚æ‰€ä»¥è·Ÿå°¤é›¨æºªè¯´çš„ä¸€æ ·ï¼šReact Fiber æœ¬è´¨ä¸Šæ˜¯ä¸ºäº†è§£å†³ React æ›´æ–°ä½æ•ˆç‡çš„é—®é¢˜ï¼Œ<strong>ä¸è¦æœŸæœ› Fiber èƒ½ç»™ä½ ç°æœ‰åº”ç”¨å¸¦æ¥è´¨çš„æå‡, å¦‚æœæ€§èƒ½é—®é¢˜æ˜¯è‡ªå·±é€ æˆçš„ï¼Œè‡ªå·±çš„é”…è¿˜æ˜¯å¾—è‡ªå·±èƒŒ</strong>.</p><p><br><br><br></p><h2 id="ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Š"><a href="#ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Š" class="headerlink" title="ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Š"></a>ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Š</h2><p><br></p><p>æœ¬æ–‡ä¹‹æ‰€ä»¥èƒ½æˆæ–‡ï¼Œç¦»ä¸å¼€ç¤¾åŒºä¸Šä¼˜è´¨çš„å¼€æºé¡¹ç›®å’Œèµ„æ–™ã€‚</p><p><strong>è¿·ä½  Fiber å®ç°</strong>:</p><p>React ç°åœ¨çš„ä»£ç åº“å¤ªå¤æ‚äº†! è€Œä¸”ä¸€ç›´åœ¨å˜åŠ¨å’Œæ¨ç¿»è‡ªå·±ï¼Œ<a href="https://www.zhihu.com/people/he-shi-jun" target="_blank" rel="noopener">Hax</a> åœ¨ <a href="https://www.zhihu.com/question/270428598/answer/354017709" target="_blank" rel="noopener">ã€Šä¸ºä»€ä¹ˆç¤¾åŒºé‡Œé‚£äº›ç±» React åº“è‡³ä»Šæ²¡æœ‰é€‰æ‹©å®ç° Fiber æ¶æ„ï¼Ÿã€‹ </a> å°±å¼€ç©ç¬‘è¯´: Fiber æ€§ä»·æ¯”ç•¥ä½â€¦ åˆ°äº†è¿™ä¸ªé˜¶æ®µï¼Œç«å“å¤ªå¤šï¼Œfacebook å°±æä¸€ä¸ª fiber æ¥ä½œä¸ºæŠ¤åŸæ²³â€¦â€¦</p><p>è¿™ç§å·¥ç¨‹é‡ä¸æ˜¯ä¸€èˆ¬å›¢é˜Ÿèƒ½Holdä½çš„ï¼Œ å¦‚æœä½ åªæ˜¯æƒ³äº†è§£ Fiberï¼Œå»è¯» React çš„æºç æ€§ä»·æ¯”ä¹Ÿå¾ˆä½ï¼Œä¸å¦¨çœ‹çœ‹è¿™äº› Mini ç‰ˆå®ç°, æ„Ÿå—å…¶ç²¾é«“ï¼Œä¸æ±‚ç”šè§£:</p><ul><li><a href="https://github.com/RubyLouvre/anu" target="_blank" rel="noopener">anu</a> <a href="https://github.com/RubyLouvre" target="_blank" rel="noopener">å¸å¾’æ­£ç¾</a> å¼€å‘çš„ç±»Reactæ¡†æ¶</li><li><a href="https://github.com/132yse/fre" target="_blank" rel="noopener">Fre</a> <a href="https://www.zhihu.com/people/132yse" target="_blank" rel="noopener">ä¼Šæ’’å°”</a> å¼€å‘çš„ç±»Reactæ¡†æ¶ï¼Œä»£ç å¾ˆç²¾ç®€â‰ï¸</li><li><a href="https://github.com/Foveluy/Luy" target="_blank" rel="noopener">Luy</a></li><li><a href="https://github.com/pomber/didact" target="_blank" rel="noopener">didact</a></li></ul><p><br></p><p><strong>ä¼˜ç§€çš„æ–‡ç«  &amp; æ¼”è®²</strong></p><p>æœ¬æ–‡åªæ˜¯å¯¹React Fiberè¿›è¡Œäº†ç®€å•çš„ç§‘æ™®ï¼Œå®é™…ä¸ŠReact çš„å®ç°æ¯”æœ¬æ–‡å¤æ‚çš„å¤šï¼Œå¦‚æœä½ æƒ³æ·±å…¥ç†è§£React Fiberçš„ï¼Œä¸‹é¢è¿™äº›æ–‡ç« ä¸å®¹é”™è¿‡:</p><ul><li><a href="https://www.youtube.com/watch?v=ZCuYPiUIONs" target="_blank" rel="noopener">Lin Clark - A Cartoon Intro to Fiber - React Conf 2017 ğŸ‘ğŸ¦</a> React Fiber å¯è’™ï¼ŒYouTube</li><li><a href="https://reactjs.org/blog/2018/03/01/sneak-peek-beyond-react-16.html" target="_blank" rel="noopener">Beyond React 16 - Dan Abramov ğŸ‘ğŸ¦</a></li><li><a href="https://www.youtube.com/watch?v=ByBPyMBTzM0&amp;t=151s" target="_blank" rel="noopener">Concurrent Rendering in React - Andrew Clark and Brian Vaughn ğŸ‘ğŸ¦</a></li><li><a href="https://zhuanlan.zhihu.com/p/37095662" target="_blank" rel="noopener">å¸å¾’æ­£ç¾: React Fiberæ¶æ„ ğŸ‘</a> çœ‹ä¸å¦‚å†™</li><li><a href="https://www.zhihu.com/people/NE_SmallTown/posts" target="_blank" rel="noopener">å±•æœ› React 17ï¼Œå›é¡¾ React å¾€äº‹ ğŸ‘</a> çœ‹å®Œ <a href="https://www.zhihu.com/people/NE_SmallTown" target="_blank" rel="noopener">Heaven</a> çš„ç›¸å…³æ–‡ç« ï¼Œä¼šè§‰å¾—ä½ äº†è§£çš„React çŸ¥è¯†çœŸçš„åªæ˜¯<a href="https://zhuanlan.zhihu.com/jheaven" target="_blank" rel="noopener">å†°å±±ä¸€è§’</a>ï¼Œæˆ‘ä»¬éƒ½æ²¡èµ„æ ¼è¯´æˆ‘ä»¬æ‡‚ Reactã€‚</li><li><a href="https://zhuanlan.zhihu.com/p/36425839" target="_blank" rel="noopener">æµ…å…¥ React16/fiber ç³»åˆ— ğŸ‘</a> åŒæ ·æ¥è‡ª Heaven</li><li><a href="https://www.zhihu.com/search?type=content&amp;q=requestIdleCallback" target="_blank" rel="noopener">æ·¡è‹ï¼šæ·±å…¥å‰–æ React Concurrent ğŸ‘</a></li><li><a href="https://engineering.hexacta.com/didact-fiber-incremental-reconciliation-b2fe028dcaec" target="_blank" rel="noopener">Didact Fiber: Incremental reconciliation  ğŸ‘</a> å®ç°äº†ç®€å•çš„ React Fiber</li><li><a href="https://zhuanlan.zhihu.com/p/26027085" target="_blank" rel="noopener">ç¨‹å¢¨: React Fiberæ˜¯ä»€ä¹ˆ</a></li><li><a href="https://zhuanlan.zhihu.com/p/57346388" target="_blank" rel="noopener">è¯‘ æ·±å…¥React fiberæ¶æ„åŠæºç </a></li><li><a href="http://www.ayqy.net/blog/dive-into-react-fiber/" target="_blank" rel="noopener">é»¯ç¾½è½»æ‰¬: å®Œå…¨ç†è§£React Fiber</a></li><li><a href="https://github.com/facebook/react/issues/7942" target="_blank" rel="noopener">Fiber Principles: Contributing To Fiber</a></li><li><a href="https://philippspiess.com/scheduling-in-react/" target="_blank" rel="noopener">Scheduling in React</a></li><li><a href="https://juejin.im/post/5d12c907f265da1b6d4033c5" target="_blank" rel="noopener">æ¡ƒç¿: Deep In React ä¹‹æµ…è°ˆ React Fiber æ¶æ„ï¼ˆä¸€ï¼‰</a></li><li><a href="https://juejin.im/post/5b028db26fb9a07ac162ba68#heading-12" target="_blank" rel="noopener">ä¸º Luy å®ç° React Fiber æ¶æ„</a></li><li><a href="https://juejin.im/post/5ab7b3a2f265da2378403e57" target="_blank" rel="noopener">å¦–åƒ§é£æœˆ: React Fiber</a></li><li><a href="https://www.youtube.com/watch?v=V1Ly-8Z1wQA&amp;t=207s" target="_blank" rel="noopener">Flarnie Marchan - Ready for Concurrent Mode? ğŸ¦</a></li><li><a href="https://developers.google.com/web/fundamentals/performance/rendering" target="_blank" rel="noopener">Web Fundamentals &gt; Performance</a></li><li><a href="https://juejin.im/post/5ad71f39f265da239f07e862" target="_blank" rel="noopener">ä½ åº”è¯¥çŸ¥é“çš„requestIdleCallback</a></li><li><a href="https://www.404forest.com/2017/07/18/how-javascript-actually-works-eventloop-and-uirendering/" target="_blank" rel="noopener">æ·±å…¥æ¢ç©¶ eventloop ä¸æµè§ˆå™¨æ¸²æŸ“çš„æ—¶åºé—®é¢˜</a></li><li><a href="https://nolanlawson.com/2018/09/25/accurately-measuring-layout-on-the-web/" target="_blank" rel="noopener">Accurately measuring layout on the web</a></li></ul><p><br></p><p><strong>è‡ªèReact ç›¸å…³æ–‡ç« </strong></p><p>å›é¡¾ä¸€ä¸‹ä»Šå¹´å†™çš„å…³äº React çš„ç›¸å…³æ–‡ç« </p><p>Concurrentæ¨¡å¼é¢„è§ˆï¼ˆæ¨èï¼‰:</p><ul><li><a href="https://juejin.im/post/5db65d87518825648f2ef899#comment" target="_blank" rel="noopener">React Concurrent æ¨¡å¼æŠ¢å…ˆé¢„è§ˆ: Suspense ç¯‡</a></li></ul><p><br></p><p>å¾€æœŸæ–‡ç« :</p><ul><li><a href="https://juejin.im/post/5cd7f2c4e51d453a7d63b715" target="_blank" rel="noopener">Reactç»„ä»¶è®¾è®¡å®è·µæ€»ç»“ ç³»åˆ— å…±5ç¯‡</a></li><li><a href="https://juejin.im/post/5d8395646fb9a06ad16faa57" target="_blank" rel="noopener">è‡ªå·±å†™ä¸ªReactæ¸²æŸ“å™¨: ä»¥ Remax ä¸ºä¾‹(ç”¨Reactå†™å°ç¨‹åº)</a></li><li><a href="https://juejin.im/post/5d44e3745188255d5861d654" target="_blank" rel="noopener">è°ˆè°ˆReactäº‹ä»¶æœºåˆ¶å’Œæœªæ¥(react-events)</a></li><li><a href="https://juejin.im/post/5d594ea5518825041301bbcb" target="_blank" rel="noopener">2019å¹´äº†ï¼Œæ•´ç†äº†Nä¸ªå®ç”¨æ¡ˆä¾‹å¸®ä½ å¿«é€Ÿè¿ç§»åˆ°React Hooks</a></li><li><a href="https://juejin.im/post/5d045350f265da1b695d5bf2" target="_blank" rel="noopener">æµ…è°ˆReactæ€§èƒ½ä¼˜åŒ–çš„æ–¹å‘</a></li><li><a href="https://juejin.im/post/5cfa29e151882539c33e4f5e" target="_blank" rel="noopener">ä»Preactä¸­äº†è§£Reactç»„ä»¶å’ŒhooksåŸºæœ¬åŸç†</a></li><li><a href="https://juejin.im/post/5d06bf0a51882528194a9736" target="_blank" rel="noopener">Reactæ€§èƒ½æµ‹é‡å’Œåˆ†æ</a></li></ul><p><br></p><p>æœ¬æ–‡è®²äº† React å¦‚ä½•ä¼˜åŒ– CPU é—®é¢˜ï¼ŒReact é‡å¿ƒè¿œä¸åœ¨äºæ­¤, I/O æ–¹å‘çš„ä¼˜åŒ–ä¹Ÿåœ¨å®è·µï¼Œä¾‹å¦‚ Suspendâ€¦  è¿˜æœ‰å¾ˆå¤šæ²¡è®²å®Œï¼Œåé¢çš„æ–‡ç« è§ï¼</p><p><br></p><p>é—®å·è°ƒæŸ¥ï¼Œä½ è§‰å¾—è¿™ç§æ–‡ç« é£æ ¼æ€æ ·ï¼Ÿ</p><ul><li>A. äº‹æ— å·¨ç»†ï¼Œå¤ªå•°å—¦äº†</li><li>B. å¨“å¨“é“æ¥ï¼Œæ·±å…¥æµ…å‡ºæˆ‘å–œæ¬¢</li><li>C. å†…å®¹ä¸å¤Ÿæ·±å…¥</li><li>D. æ–‡ç« ç¯‡å¹…å¤ªé•¿ï¼Œå¯ä»¥æ‹†åˆ†</li></ul><p>å¤šé€‰ï¼Œä¸‹æ–¹è¯„è®ºï¼ŒğŸ‘ç‚¹èµèµ°èµ·</p><blockquote><p><strong>æ”¹äº†ä¸€ä¸ªæ­£ç»ä¸€ç‚¹çš„ç½‘åï¼š_sx_(å‚»å‰) -&gt; è’å±± â›°</strong></p></blockquote><p><br></p><p><img src="/images/sponsor.jpg" alt></p><p><br></p></brk>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;å†™ä¸€ç¯‡å…³äº React Fiber çš„æ–‡ç« ï¼Œ è¿™ä¸ª Flag ç«‹äº†å¾ˆä¹…ï¼Œè¿™ä¹Ÿæ˜¯ä»Šå¹´çš„ç›®æ ‡ä¹‹ä¸€. æœ€è¿‘çš„åœ¨æ˜é‡‘çš„æ–‡ç« è·å¾—å¾ˆå¤šå…³æ³¨å’Œé¼“åŠ±ï¼Œç»™äº†æˆ‘å¾ˆå¤šåŠ¨åŠ›ï¼Œæ‰€ä»¥ä¸‹å®šå†³å¿ƒå¥½å¥½æŠŠå®ƒå†™å‡ºæ¥ã€‚ æˆ‘ä¼šä»¥æœ€é€šä¿—çš„æ–¹å¼å°†å®ƒè®²é€, å› æ­¤è¿™ç®—æ˜¯ä¸€ç¯‡ç§‘æ™®å¼çš„æ–‡ç« ã€‚ä¸ç®¡ä½ æ˜¯ä½¿ç”¨Reactã€è¿˜æ˜¯Vueï¼Œ
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://bobi.ink/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>æ·±å…¥æµ…å‡º Babel ä¸‹ç¯‡ï¼šæ—¢ç”Ÿ Plugin ä½•ç”Ÿ Macros</title>
    <link href="https://bobi.ink/2019/10/10/babel-macro/"/>
    <id>https://bobi.ink/2019/10/10/babel-macro/</id>
    <published>2019-10-09T16:00:00.000Z</published>
    <updated>2019-10-18T14:10:34.400Z</updated>
    
    <content type="html"><![CDATA[<p>æ¥ç€ä¸Šç¯‡æ–‡ç« : <a href="https://juejin.im/post/5d94bfbf5188256db95589be" target="_blank" rel="noopener">ã€Šæ·±å…¥æµ…å‡º Babel ä¸Šç¯‡ï¼šæ¶æ„å’ŒåŸç† + å®æˆ˜ ğŸ”¥ã€‹</a></p><p><br></p><p><strong>è¿™ç¯‡æ–‡ç« å¹²è´§ä¸å°‘äºä¸Šç¯‡æ–‡ç« ï¼Œè¿™ç¯‡æˆ‘ä»¬æ·±å…¥è®¨è®ºä¸€ä¸‹å®è¿™ä¸ªç©æ„</strong> â€”â€” <em>æˆ‘æƒ³æˆ‘ä»¬å¯¹å®å¹¶ä¸é™Œç”Ÿï¼Œå› ä¸ºå¾ˆå¤šç¨‹åºå‘˜ç¬¬ä¸€é—¨è¯­è¨€å°±æ˜¯ <code>C/C++</code>; ä¸€äº› <code>Lisp</code> æ–¹è¨€ä¹Ÿæ”¯æŒå®(å¦‚ <code>Clojure</code>ã€<code>Scheme</code>), å¬è¯´å®ƒä»¬çš„å®å†™èµ·æ¥å¾ˆä¼˜é›…ï¼›ä¸€äº›ç°ä»£çš„ç¼–ç¨‹è¯­è¨€å¯¹å®ä¹Ÿæœ‰ä¸€å®šçš„æ”¯æŒï¼Œå¦‚ <code>Rust</code>ã€<code>Nim</code>ã€<code>Julia</code>ã€<code>Elixir</code>ï¼Œå®ƒä»¬æ˜¯å¦‚ä½•è§£å†³æŠ€æœ¯é—®é¢˜, å®ç°ç±»Lispçš„å®ç³»ç»Ÿçš„ï¼Ÿå®åœ¨è¿™äº›è¯­è¨€ä¸­æ‰®æ¼”è¿™ä»€ä¹ˆè§’è‰²â€¦</em></p><blockquote><p>å¦‚æœæ²¡è¯»è¿‡ä¸Šç¯‡æ–‡ç« ï¼Œè¯·å…ˆé˜…è¯»ä¸€ä¸‹ï¼Œé¿å…å½±å“å¯¹æœ¬ç¯‡æ–‡ç« å†…å®¹çš„ç†è§£ã€‚</p></blockquote><p><br></p><p><strong>æ–‡ç« å¤§çº²</strong></p><!-- TOC --><ul><li><a href="#å…³äºå®">å…³äºå®</a><ul><li><a href="#æ–‡æœ¬æ›¿æ¢å¼">æ–‡æœ¬æ›¿æ¢å¼</a></li><li><a href="#è¯­æ³•æ‰©å±•å¼">è¯­æ³•æ‰©å±•å¼</a></li><li><a href="#sweetjs">Sweet.js</a></li><li><a href="#å°ç»“">å°ç»“</a></li></ul></li><li><a href="#æ—¢ç”Ÿ-plugin-ä½•ç”Ÿ-macro">æ—¢ç”Ÿ Plugin ä½•ç”Ÿ Macro</a></li><li><a href="#å¦‚ä½•å†™ä¸€ä¸ª-babel-macro">å¦‚ä½•å†™ä¸€ä¸ª Babel Macro</a><ul><li><a href="#å®æˆ˜">å®æˆ˜</a></li></ul></li><li><a href="#æ‰©å±•èµ„æ–™">æ‰©å±•èµ„æ–™</a></li></ul><!-- /TOC --><p><br></p><h2 id="å…³äºå®"><a href="#å…³äºå®" class="headerlink" title="å…³äºå®"></a>å…³äºå®</h2><p><a href="https://zh.wikipedia.org/wiki/å·¨é›†" target="_blank" rel="noopener"><code>Wiki</code></a> ä¸Šé¢å¯¹â€˜å®â€™çš„å®šä¹‰æ˜¯ï¼š<strong>å®(Macro), æ˜¯ä¸€ç§æ‰¹å¤„ç†çš„ç§°è°“ï¼Œå®ƒæ ¹æ®ä¸€ç³»åˆ—çš„é¢„å®šä¹‰è§„åˆ™è½¬æ¢ä¸€å®šçš„æ–‡æœ¬æ¨¡å¼ã€‚<code>è§£é‡Šå™¨</code>æˆ–<code>ç¼–è¯‘å™¨</code>åœ¨é‡åˆ°å®æ—¶ä¼šè‡ªåŠ¨è¿›è¡Œè¿™ä¸€æ¨¡å¼è½¬æ¢ï¼Œè¿™ä¸ªè½¬æ¢è¿‡ç¨‹è¢«ç§°ä¸ºâ€œå®å±•å¼€(Macro Expansion)â€ã€‚å¯¹äºç¼–è¯‘è¯­è¨€ï¼Œå®å±•å¼€åœ¨ç¼–è¯‘æ—¶å‘ç”Ÿï¼Œè¿›è¡Œå®å±•å¼€çš„å·¥å…·å¸¸è¢«ç§°ä¸ºå®å±•å¼€å™¨ã€‚</strong></p><p>ä½ å¯ä»¥è®¤ä¸ºï¼Œ<strong>å®å°±æ˜¯ç”¨æ¥ç”Ÿæˆä»£ç çš„ä»£ç ï¼Œå®ƒæœ‰èƒ½åŠ›è¿›è¡Œä¸€äº›å¥æ³•è§£æå’Œä»£ç è½¬æ¢</strong>ã€‚å®å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸¤ç§: <strong>æ–‡æœ¬æ›¿æ¢</strong>å’Œ<strong>è¯­æ³•æ‰©å±•</strong></p><p><br></p><h3 id="æ–‡æœ¬æ›¿æ¢å¼"><a href="#æ–‡æœ¬æ›¿æ¢å¼" class="headerlink" title="æ–‡æœ¬æ›¿æ¢å¼"></a>æ–‡æœ¬æ›¿æ¢å¼</h3><p>å¤§å®¶æˆ–å¤šæˆ–å°‘æœ‰æ¥è§¦è¿‡å®ï¼Œå¾ˆå¤šç¨‹åºå‘˜ç¬¬ä¸€é—¨è¯­è¨€æ˜¯<code>C/C++</code>(åŒ…æ‹¬Cçš„è¡ç”Ÿè¯­è¨€<code>Objective-C</code>),  åœ¨<code>C</code>ä¸­å°±æœ‰å®çš„æ¦‚å¿µã€‚ä½¿ç”¨<code>#define</code>æŒ‡ä»¤å®šä¹‰ä¸€ä¸ªå®:</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MIN(X, Y) ((X) &lt; (Y) ? (X) : (Y))</span></span><br></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬çš„ç¨‹åºä½¿ç”¨äº†è¿™ä¸ªå®ï¼Œå°±ä¼šåœ¨ç¼–è¯‘é˜¶æ®µè¢«å±•å¼€ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">MIN(a + b, c + d)</span><br></pre></td></tr></table></figure><p>ä¼šè¢«å±•å¼€ä¸º:</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">((a + b) &lt; (c + d) ? (a + b) : (c + d))</span><br></pre></td></tr></table></figure><p><br></p><p>é™¤äº†<code>å‡½æ•°å®</code>, <code>C</code> ä¸­è¿˜æœ‰<code>å¯¹è±¡å®</code>, æˆ‘ä»¬é€šå¸¸ä½¿ç”¨å®ƒæ¥å£°æ˜â€™å¸¸é‡â€™:</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PI 3.1214</span></span><br></pre></td></tr></table></figure><p><br></p><p><img src="/images/babel/c-compile.gif" alt></p><p>å¦‚ä¸Šå›¾ï¼Œ<strong>å®æœ¬è´¨ä¸Šä¸æ˜¯<code>C</code>è¯­è¨€çš„ä¸€éƒ¨åˆ†</strong>, å®ƒç”±<code>Cé¢„å¤„ç†å™¨</code>æä¾›ï¼Œé¢„å¤„ç†å™¨åœ¨ç¼–è¯‘ä¹‹å‰å¯¹æºä»£ç è¿›è¡Œ<strong>æ–‡æœ¬æ›¿æ¢</strong>ï¼Œç”Ÿæˆâ€˜çœŸæ­£â€™çš„ <code>C</code> ä»£ç ï¼Œå†ä¼ é€’ç»™ç¼–è¯‘å™¨ã€‚</p><blockquote><p>å½“ç„¶ C é¢„å¤„ç†å™¨ä¸ä»…ä»…ä¼šå¤„ç†å®ï¼Œå®ƒè¿˜åŒ…å«äº†å¤´æ–‡ä»¶å¼•å…¥ã€æ¡ä»¶ç¼–è¯‘ã€è¡Œæ§åˆ¶ç­‰æ“ä½œ</p></blockquote><p>é™¤æ­¤ä¹‹å¤–ï¼Œ<a href="https://segmentfault.com/a/1190000004104696" target="_blank" rel="noopener"><code>GNU m4</code></a>æ˜¯ä¸€ä¸ªæ›´ä¸“ä¸š/æ›´å¼ºå¤§/æ›´é€šç”¨çš„é¢„å¤„ç†å™¨(å®å±•å¼€å™¨)ã€‚è¿™æ˜¯ä¸€ä¸ªé€šç”¨çš„å®å±•å¼€å™¨ï¼Œä¸ä»…å¯ä»¥ç”¨äº Cï¼Œä¹Ÿå¯ä»¥ç”¨äºå…¶ä»–è¯­è¨€å’Œæ–‡æœ¬æ–‡ä»¶çš„å¤„ç†(<em>å‚è€ƒè¿™ç¯‡æœ‰è¶£çš„æ–‡ç« ï¼š<a href="https://segmentfault.com/a/1190000004342956" target="_blank" rel="noopener">ã€Šä½¿ç”¨ GNU m4 ä¸º Markdown æ·»åŠ ç›®å½•æ”¯æŒã€‹</a></em>)ï¼Œ å…³äº<code>m4</code>å¯ä»¥çœ‹<a href="https://segmentfault.com/a/1190000004104696" target="_blank" rel="noopener">è®©è¿™ä¸–ç•Œå†å¤šä¸€ä»½ GNU m4 æ•™ç¨‹</a> ç³»åˆ—æ–‡ç« .</p><p>æ–‡æœ¬æ›¿æ¢å¼å®å¾ˆå®¹æ˜“ç†è§£ã€å®ç°ä¹Ÿç®€å•ï¼Œå› ä¸ºå®ƒä»¬åªæ˜¯çº¯æ–‡æœ¬æ›¿æ¢, æ¢å¥è¯è¯´å®ƒå°±åƒâ€˜æ–‡æœ¬ç¼–è¾‘å™¨â€™ã€‚æ‰€ä»¥ç›¸å¯¹è€Œè¨€ï¼Œ<strong>è¿™ç§å½¢å¼çš„å®èƒ½åŠ›æœ‰é™ï¼Œæ¯”å¦‚å®ƒä¸ä¼šæ£€éªŒè¯­æ³•æ˜¯å¦åˆæ³•, ä½¿ç”¨å®ƒç»å¸¸ä¼šå‡ºç°é—®é¢˜</strong>ã€‚</p><p>æ‰€ä»¥<strong>éšç€ç°ä»£ç¼–ç¨‹è¯­è¨€è¡¨è¾¾èƒ½åŠ›è¶Šæ¥è¶Šå¼ºï¼Œå¾ˆå¤šè¯­è¨€éƒ½ä¸å†æ¨èä½¿ç”¨å®/ä¸æä¾›å®ï¼Œè€Œæ˜¯ä½¿ç”¨è¯­è¨€æœ¬èº«çš„æœºåˆ¶(ä¾‹å¦‚å‡½æ•°)æ¥è§£å†³é—®é¢˜ï¼Œè¿™æ ·æ›´å®‰å…¨ã€æ›´å®¹æ˜“ç†è§£å’Œè°ƒè¯•ã€‚æ²¡ç”¨å®æœºåˆ¶ï¼Œç°ä»£è¯­è¨€å¯ä»¥é€šè¿‡æä¾›å¼ºå¤§çš„åå°„æœºåˆ¶æˆ–è€…åŠ¨æ€ç¼–ç¨‹ç‰¹æ€§(å¦‚Javascriptçš„Proxyã€Pythonçš„è£…é¥°å™¨)æ¥å¼¥è¡¥ç¼ºå¤±å®å¯¼è‡´çš„å…ƒç¼–ç¨‹çŸ­æ¿ã€‚ æ‰€ä»¥åè¿‡æ¥æ¨å¯¼ï¼Œä¹‹æ‰€ä»¥<code>C</code>è¯­è¨€éœ€è¦å®ï¼Œæ­£æ˜¯å› ä¸º<code>C</code>è¯­è¨€çš„è¡¨è¾¾èƒ½åŠ›å¤ªå¼±äº†</strong>ã€‚</p><p><br><br><br></p><h3 id="è¯­æ³•æ‰©å±•å¼"><a href="#è¯­æ³•æ‰©å±•å¼" class="headerlink" title="è¯­æ³•æ‰©å±•å¼"></a>è¯­æ³•æ‰©å±•å¼</h3><p>â€˜çœŸæ­£â€™çš„å®èµ·æºäº<a href="https://zh.wikipedia.org/wiki/LISP" target="_blank" rel="noopener"><code>Lisp</code></a>. è¿™ä¸ªå¾—ç›ŠäºLispè¯­è¨€æœ¬èº«çš„ä¸€äº›ç‰¹æ€§ï¼š</p><p><img src="/images/babel/lisp.png" alt></p><p><br></p><ul><li><strong>å®ƒçš„è¯­æ³•éå¸¸ç®€å•</strong>ã€‚åªæœ‰<a href="https://zh.wikipedia.org/wiki/S-è¡¨è¾¾å¼" target="_blank" rel="noopener">S-è¡¨è¾¾å¼(s-expression)</a>(<em>ç‰¹å¾ä¸ºæ‹¬å·åŒ–çš„å‰ç¼€è¡¨ç¤ºæ³•, å¯ä»¥è®¤ä¸ºS-è¡¨è¾¾å¼å°±æ˜¯è¿‘ä¼¼çš„ Lisp çš„æŠ½è±¡è¯­æ³•æ ‘(AST)</em>)</li><li><strong>æ•°æ®å³ä»£ç </strong>ã€‚S-è¡¨è¾¾å¼æœ¬èº«å°±æ˜¯æ ‘å½¢æ•°æ®ç»“æ„ã€‚å¦å¤– Lisp æ”¯æŒæ•°æ®å’Œä»£ç ä¹‹é—´çš„è½¬æ¢</li></ul><p><br></p><p>ç”±äº Lisp è¿™ç§ç®€å•çš„è¯­æ³•ç»“æ„ï¼Œä½¿å¾—æ•°æ®å’Œç¨‹åºä¹‹é—´åªæœ‰ä¸€çº¿ä¹‹éš”(<strong>quoteä¿®é¥°å°±æ˜¯æ•°æ®ï¼Œ æ²¡æœ‰quoteå°±æ˜¯ç¨‹åº</strong>), æ¢å¥è¯è¯´å°±æ˜¯ç¨‹åºå’Œæ•°æ®ä¹‹é—´å¯ä»¥çµæ´»åœ°è½¬æ¢ã€‚è¿™ç§<code>æ•°æ®å³ç¨‹åºã€ç¨‹åºå³æ•°æ®</code>çš„æ¦‚å¿µï¼Œä½¿å¾—Lispå¯ä»¥è½»æ¾åœ°è‡ªå®šä¹‰å®. ä¸å¦¨æ¥çœ‹ä¸€ä¸‹Lispå®šä¹‰å®çš„ç¤ºä¾‹ï¼š</p><figure class="highlight clj"><table><tr><td class="code"><pre><span class="line"><span class="comment">; ä½¿ç”¨defmacroå®šä¹‰ä¸€ä¸ªnonsenseå®, æ¥æ”¶ä¸€ä¸ªfunction-nameå‚æ•°. å®éœ€è¦è¿”å›ä¸€ä¸ªquoted</span></span><br><span class="line"><span class="comment">; ` è¿™æ˜¯quoteå‡½æ•°çš„ç®€å†™ï¼Œè¡¨ç¤ºquoteï¼Œå³è¿™æ®µâ€˜ç¨‹åºâ€™æ˜¯ä¸€æ®µâ€˜æ•°æ®â€™, æˆ–è€…è¯´å°†â€˜ç¨‹åºâ€™è½¬æ¢ä¸ºâ€˜æ•°æ®â€™. quoteä¸ä¼šè¢«â€˜æ±‚å€¼â€™</span></span><br><span class="line"><span class="comment">; defun å®šä¹‰ä¸€ä¸ªå‡½æ•°</span></span><br><span class="line"><span class="comment">; , è¿™æ˜¯unquoteå‡½æ•°çš„ç®€å†™ï¼Œ è¡¨ç¤ºunquoteï¼Œå³å°†â€˜æ•°æ®â€™è½¬æ¢ä¸ºâ€˜ç¨‹åºâ€™. unquoteä¼šè¿›è¡Œæ±‚å€¼</span></span><br><span class="line"><span class="comment">; intern å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºsymbolï¼Œå³æ ‡è¯†ç¬¦</span></span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">defmacro</span></span> nonsense (<span class="name">function-name</span>)</span><br><span class="line">  `(<span class="name">defun</span> ,(<span class="name"><span class="builtin-name">intern</span></span> (<span class="name"><span class="builtin-name">concat</span></span> <span class="string">"nonsense-"</span> function-name)) (<span class="name">input</span>) <span class="comment">; å®šä¹‰ä¸€ä¸ªnonsense-$&#123;function-name&#125; æ–¹æ³•</span></span><br><span class="line">     (<span class="name">print</span> (<span class="name"><span class="builtin-name">concat</span></span> ,function-name input))))                   <span class="comment">; è¾“å…¥`$&#123;function-name&#125;$&#123;input&#125;`</span></span><br></pre></td></tr></table></figure><details><br>  <summary>å¦‚æœä½ ä¸ç†è§£ä¸Šé¢ç¨‹åºçš„å«ä¹‰ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªJavascriptçš„å®ç°</summary><br><br>  æ³¨æ„ï¼šâ€˜å®â€™ä¸€èˆ¬åœ¨ç¼–è¯‘é˜¶æ®µè¢«å±•å¼€, ä¸‹é¢ä»£ç åªæ˜¯ä¸ºäº†åä½œä½ ç†è§£ä¸Šè¿°çš„Lispä»£ç <br>  <figure class="highlight js"><table><tr><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">nonsense</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">   <span class="keyword">let</span> rtn</span><br><span class="line">   <span class="built_in">eval</span>(<span class="string">`rtn = function nonsense<span class="subst">$&#123;name&#125;</span>(input) &#123;</span></span><br><span class="line"><span class="string">     console.log('<span class="subst">$&#123;name&#125;</span>', input)</span></span><br><span class="line"><span class="string">   &#125;`</span>)</span><br><span class="line">   <span class="keyword">return</span> rtn</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><br></details><p><br></p><p>åº”ç”¨å®å±•å¼€ï¼š</p><figure class="highlight clj"><table><tr><td class="code"><pre><span class="line">(<span class="name">nonsense</span> <span class="string">"apple"</span>)           <span class="comment">; å±•å¼€å®ï¼Œè¿™é‡Œä¼šåˆ›å»ºä¸€ä¸ªnonsense-appleå‡½æ•°</span></span><br><span class="line">(<span class="name">nonsense-apple</span> <span class="string">" is good"</span>)  <span class="comment">; è°ƒç”¨åˆšåˆšåˆ›å»ºçš„å®</span></span><br><span class="line">                             <span class="comment">; =&gt; "apple is good"</span></span><br></pre></td></tr></table></figure><p><br></p><p><strong>å¯¹äºLispè€Œè¨€ï¼Œå®æœ‰ç‚¹åƒä¸€ä¸ªå‡½æ•°, åªä¸è¿‡è¿™ä¸ªå‡½æ•°å¿…é¡»è¿”å›ä¸€ä¸ª<code>quotedæ•°æ®</code>; å½“è°ƒç”¨è¿™ä¸ªå®æ—¶ï¼ŒLispä¼šä½¿ç”¨<code>unquote</code>å‡½æ•°å°†å®è¿”å›çš„<code>quotedæ•°æ®</code>è½¬æ¢ä¸º<code>ç¨‹åº</code></strong>ã€‚</p><p><img src="/images/babel/lisp-macro.png" alt></p><p><br></p><p>é€šè¿‡ä¸Šé¢çš„ç¤ºä¾‹ï¼Œä½ ä¼šæ„Ÿå¹Lispçš„å®å®ç°ç«Ÿç„¶å¦‚æ­¤æ¸…å¥‡ï¼Œå¦‚æ­¤ç®€å•ã€‚ æå¾—æˆ‘æƒ³è·Ÿç€<a href="http://tiye.me" target="_blank" rel="noopener">é¢˜å¶</a>å­¦ä¸€æ³¢<a href="https://clojure.org" target="_blank" rel="noopener">Clojure</a>ï¼Œä½†æ˜¯åæ¥æˆ‘å­¦äº†<a href="https://elixir-lang.org" target="_blank" rel="noopener">Elixir</a> ğŸ˜‚.</p><p><img src="/images/babel/sicp.png" alt></p><p><br></p><p>Lispå®çš„çµæ´»æ€§å¾—ç›Šäºç®€å•çš„è¯­æ³•(S-è¡¨è¾¾å¼å¯ä»¥ç­‰ä»·äºå®ƒçš„AST)ï¼Œå¯¹äºå¤æ‚è¯­æ³•çš„è¯­è¨€(ä¾‹å¦‚Javascript)ï¼Œè¦å®ç°ç±»ä¼¼Lispçš„å®å°±éš¾å¾—å¤š. å› æ­¤å¾ˆå°‘æœ‰ç°ä»£è¯­è¨€æä¾›å®æœºåˆ¶å¯èƒ½ä¹Ÿæ˜¯è¿™ä¸ªåŸå› ã€‚</p><p>å°½ç®¡å¦‚æ­¤ï¼Œç°åœ¨å¾ˆå¤šæŠ€æœ¯éš¾ç‚¹æ…¢æ…¢è¢«è§£å†³ï¼Œå¾ˆå¤šç°ä»£è¯­è¨€ä¹Ÿå¼•å…¥â€™ç±»â€™ Lispçš„å®æœºåˆ¶ï¼Œå¦‚<a href="https://doc.rust-lang.org/book/ch19-06-macros.html" target="_blank" rel="noopener">Rust</a>ã€<a href="https://julialang.org" target="_blank" rel="noopener">Julia</a>, è¿˜æœ‰Javascriptçš„ <a href="https://www.sweetjs.org/doc/tutorial" target="_blank" rel="noopener">Sweet.js</a></p><p><br><br><br></p><h3 id="sweet-js"><a href="#sweet-js" class="headerlink" title="Sweet.js"></a>Sweet.js</h3><p>Sweet.js å’Œ Rust å¸ˆå‡ºåŒé—¨ï¼Œæ‰€ä»¥ä¸¤ä¸ªçš„å®è¯­æ³•å’Œéå¸¸æ¥è¿‘(åˆæœŸ)ã€‚ ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯: <strong>å®˜æ–¹è®¤ä¸º Sweet.js ç›®å‰ä»å¤„äºå®éªŒé˜¶æ®µ</strong>ï¼Œè€Œä¸”Githubæœ€åæäº¤æ—¶é—´åœç•™åœ¨2å¹´å‰ï¼Œç¤¾åŒºä¸Šä¹Ÿæœªè§å¤§è§„æ¨¡çš„ä½¿ç”¨ã€‚æ‰€ä»¥ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨å®ƒï¼Œä½†æ˜¯ä¸å¦¨ç¢æˆ‘ä»¬å»å­¦ä¹ ä¸€ä¸ªç°ä»£ç¼–ç¨‹è¯­è¨€çš„å®æœºåˆ¶ã€‚</p><p>æˆ‘ä»¬å…ˆä½¿ç”¨ <code>Sweet.js</code> æ¥å®ç°ä¸Šé¢æˆ‘ä»¬é€šè¿‡ <code>Lisp</code> å®ç°çš„<code>nosense</code>å®, å¯¹æ¯”èµ·æ¥æ›´å®¹æ˜“ç†è§£:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; unwrap, fromIdentifier, fromStringLiteral &#125; <span class="keyword">from</span> <span class="string">'@sweet-js/helpers'</span> <span class="keyword">for</span> syntax;</span><br><span class="line"></span><br><span class="line">syntax nosense = <span class="function"><span class="keyword">function</span> (<span class="params">ctx</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> name = ctx.next().value;</span><br><span class="line">  <span class="keyword">let</span> funcName = <span class="string">'nonsense'</span> + unwrap(name).value</span><br><span class="line"></span><br><span class="line">  return #`function $&#123;fromIdentifier(name, funcName)&#125; () &#123;</span><br><span class="line">    <span class="built_in">console</span>.log($&#123;fromStringLiteral(name, unwrap(name).value)&#125; + input)</span><br><span class="line">  &#125;<span class="string">`;</span></span><br><span class="line"><span class="string">&#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">nosense Apple</span></span><br><span class="line"><span class="string">nosenseApple(" is Good") // Apple is Good</span></span><br></pre></td></tr></table></figure><p><br></p><p>é¦–å…ˆï¼ŒSweet.jsä½¿ç”¨<code>syntax</code>å…³é”®å­—æ¥å®šä¹‰ä¸€ä¸ªå®ï¼Œå…¶è¯­æ³•ç±»ä¼¼äº<code>const</code>æˆ–è€…<code>let</code>ã€‚</p><p><strong>æœ¬è´¨ä¸Šä¸€ä¸ªå®å°±æ˜¯ä¸€ä¸ªå‡½æ•°, åªä¸è¿‡åœ¨ç¼–è¯‘é˜¶æ®µè¢«æ‰§è¡Œ</strong>. è¿™ä¸ªå‡½æ•°æ¥æ”¶ä¸€ä¸ª <a href="https://www.sweetjs.org/doc/reference#syntax-transformer" target="_blank" rel="noopener"><code>TransformerContext</code></a> å¯¹è±¡ï¼Œä½ ä¹Ÿé€šè¿‡è¿™ä¸ªå¯¹è±¡è·å–å®åº”ç”¨ä¼ å…¥çš„<strong>è¯­æ³•å¯¹è±¡(Syntax Object)æ•°ç»„</strong>ï¼Œæœ€ç»ˆè¿™ä¸ªå®ä¹Ÿè¦è¿”å›<strong>è¯­æ³•å¯¹è±¡æ•°ç»„</strong>ã€‚</p><p>ä»€ä¹ˆæ˜¯è¯­æ³•å¯¹è±¡ï¼Ÿè¯­æ³•å¯¹è±¡æ˜¯ Sweet.js å…³äºè¯­æ³•çš„å†…éƒ¨è¡¨ç¤º, ä½ å¯ä»¥ç±»æ¯”ä¸Šæ–‡Lispçš„ quoted æ•°æ®ã€‚<strong>åœ¨å¤æ‚è¯­æ³•çš„è¯­è¨€ä¸­ï¼Œæ²¡åŠæ³•ä½¿ç”¨ quoted è¿™ä¹ˆç®€å•çš„åºåˆ—æ¥è¡¨ç¤ºè¯­æ³•ï¼Œè€Œä½¿ç”¨ AST åˆ™æ›´å¤æ‚ï¼Œå¼€å‘è€…æ›´éš¾ä»¥é©¾é©­ã€‚æ‰€ä»¥å¤§éƒ¨åˆ†å®å®ç°ä¼šå‚è€ƒ Lisp çš„<code>S-è¡¨è¾¾å¼</code>ï¼Œå–æŠ˜ä¸­æ–¹æ¡ˆï¼Œå°†ä¼ å…¥çš„ç¨‹åºè½¬æ¢ä¸ºTokensï¼Œå†ç»„è£…æˆç±»ä¼¼quotedçš„æ•°æ®ç»“æ„</strong>ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼ŒSweet.js ä¼šå°† <code>foo,bar(&#39;baz&#39;, 1)</code>è½¬æ¢æˆè¿™æ ·çš„æ•°æ®ç»“æ„:</p><p><img src="/images/babel/syntaxobject.png" alt></p><p>ä»ä¸Šå›¾å¯çŸ¥ï¼ŒSweet.js ä¼šå°†ä¼ å…¥çš„ç¨‹åºè§£ææˆ<strong>åµŒå¥—çš„Tokenåºåˆ—</strong>ï¼Œè¿™ä¸ªç»“æ„å’ŒLispçš„<code>S-è¡¨è¾¾å¼</code>éå¸¸ç›¸ä¼¼ã€‚ä¹Ÿå°±æ˜¯, è¯´å¯¹äºé—­åˆçš„è¯æ³•å•å…ƒä¼šè¢«åµŒå¥—å­˜å‚¨ï¼Œä¾‹å¦‚ä¸Šä¾‹çš„<code>(&#39;baz&#39;, 1)</code>.</p><blockquote><p>Elixir ä¹Ÿé‡‡ç”¨äº†<a href="https://elixir-lang.org/getting-started/meta/quote-and-unquote.html" target="_blank" rel="noopener">ç±»ä¼¼çš„quote/unquoteæœºåˆ¶</a>ï¼Œå¯ä»¥ç»“åˆç€ä¸€èµ·ç†è§£</p></blockquote><p><br></p><p><code>TransformerContext</code>å®ç°äº†è¿­ä»£å™¨æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬é€šè¿‡è°ƒç”¨å®ƒçš„<code>next()</code>æ¥éå†è·å–è¯­æ³•å¯¹è±¡ã€‚æœ€åå®å¿…é¡»è¿”å›ä¸€ä¸ªè¯­æ³•å¯¹è±¡æ•°ç»„ï¼ŒSweet.js ä½¿ç”¨äº†ç±»ä¼¼<code>å­—ç¬¦ä¸²æ¨¡æ¿</code>çš„<a href="https://www.sweetjs.org/doc/reference#syntax-templates" target="_blank" rel="noopener">è¯­æ³•</a>(ç§°ä¸º<code>è¯­æ³•æ¨¡æ¿</code>)æ¥ç®€åŒ–å¼€å‘ï¼Œè¿™ä¸ªæ¨¡æ¿æœ€ç»ˆè½¬æ¢ä¸ºè¯­æ³•å¯¹è±¡æ•°ç»„ã€‚</p><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯<code>è¯­æ³•æ¨¡æ¿</code>çš„å†…åµŒå€¼åªèƒ½æ˜¯è¯­æ³•å¯¹è±¡ã€è¯­æ³•å¯¹è±¡åºåˆ—æˆ–è€…TransformerContext.</p></blockquote><details><br><summary>æ—§ç‰ˆæœ¬ä½¿ç”¨äº†<a href="https://jlongster.com/Stop-Writing-JavaScript-Compilers--Make-Macros-Instead" target="_blank" rel="noopener">æ¨¡å¼åŒ¹é…</a>ï¼Œå’ŒRustè¯­æ³•ç±»ä¼¼ï¼Œæˆ‘ä¸ªäººæ›´å–œæ¬¢è¿™ä¸ªï¼Œä¸çŸ¥ä¸ºä½•åºŸå¼ƒäº†</summary><br><br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">macro define &#123;</span><br><span class="line">    rule &#123; $x &#125; =&gt; &#123;</span><br><span class="line">        <span class="keyword">var</span> $x</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    rule &#123; $x = $expr &#125; =&gt; &#123;</span><br><span class="line">        <span class="keyword">var</span> $x = $expr</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">define y;</span><br><span class="line">define y = <span class="number">5</span>;</span><br></pre></td></tr></table></figure><br><br></details><p><br></p><p>è¯´äº†è¿™ä¹ˆå¤šï¼Œç±»ä¼¼Sweet.js <code>è¯­æ³•å¯¹è±¡</code> çš„è®¾è®¡æ˜¯ç°ä»£ç¼–ç¨‹è¯­è¨€ä¸ºäº†è´´è¿‘ Lisp å®çš„ä¸€ä¸ªå…³é”®æŠ€æœ¯ç‚¹ã€‚æˆ‘å‘ç°<code>Elixir</code>ã€<code>Rust</code>ç­‰è¯­è¨€ä¹Ÿä½¿ç”¨äº†ç±»ä¼¼çš„è®¾è®¡ã€‚ é™¤äº†æ•°æ®ç»“æ„çš„è®¾è®¡ï¼Œç°ä»£ç¼–ç¨‹è¯­è¨€çš„å®æœºåˆ¶è¿˜åŒ…å«ä»¥ä¸‹ç‰¹æ€§ï¼š</p><p><br></p><p><strong>1ï¸âƒ£ å«ç”Ÿå®(Hygiene)</strong></p><p>å«ç”Ÿå®æŒ‡çš„æ˜¯åœ¨å®å†…ç”Ÿæˆçš„å˜é‡ä¸ä¼šæ±¡æŸ“å¤–éƒ¨ä½œç”¨åŸŸï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨å®å±•å¼€æ—¶ï¼ŒSweet.js ä¼šé¿å…å®å†…å®šä¹‰çš„å˜é‡å’Œå¤–éƒ¨å†²çª.</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªswapå®ï¼Œäº¤æ¢å˜é‡çš„å€¼:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">syntax swap = <span class="function">(<span class="params">ctx</span>) =&gt;</span> &#123;</span><br><span class="line"> <span class="keyword">const</span> a = ctx.next().value</span><br><span class="line"> ctx.next() <span class="comment">// åƒæ‰','</span></span><br><span class="line"> <span class="keyword">const</span> b = ctx.next().value</span><br><span class="line"> return #`</span><br><span class="line"> <span class="keyword">let</span> temp = $&#123;a&#125;</span><br><span class="line"> $&#123;a&#125; = $&#123;b&#125;</span><br><span class="line"> $&#123;b&#125; = temp</span><br><span class="line"> <span class="string">`;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">swap foo,bar</span></span><br></pre></td></tr></table></figure><p>å±•å¼€ä¼šè¾“å‡ºä¸º</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> temp_10 = foo; <span class="comment">// tempå˜é‡è¢«é‡å‘½åä¸ºtemp_10</span></span><br><span class="line">foo = bar;</span><br><span class="line">bar = temp_10;</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ æƒ³å¼•ç”¨å¤–éƒ¨çš„å˜é‡ï¼Œä¹Ÿå¯ä»¥ã€‚ä¸è¿‡ä¸å»ºè®®è¿™ä¹ˆåšï¼Œ<strong>å®ä¸åº”è¯¥å‡å®šå…¶è¢«å±•å¼€çš„ä¸Šä¸‹æ–‡</strong>:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">syntax swap = <span class="function">(<span class="params">ctx</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  return #`</span><br><span class="line">  temp = $&#123;a&#125; <span class="comment">// ä¸ä½¿ç”¨ let å£°æ˜</span></span><br><span class="line">  $&#123;a&#125; = $&#123;b&#125;</span><br><span class="line">  $&#123;b&#125; = temp</span><br><span class="line">  <span class="string">`;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><p><br></p><p><strong>2ï¸âƒ£ æ¨¡å—åŒ–</strong></p><p>Sweet.js çš„å®æ˜¯æ¨¡å—åŒ–çš„ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="string">'lang sweet.js'</span>;</span><br><span class="line"><span class="comment">// å¯¼å‡ºå®</span></span><br><span class="line"><span class="keyword">export</span> syntax <span class="class"><span class="keyword">class</span> </span>= <span class="function"><span class="keyword">function</span> (<span class="params">ctx</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¯¼å…¥ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="class"><span class="keyword">class</span> &#125; <span class="title">from</span> './<span class="title">es2015</span>-<span class="title">macros</span>'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Droid</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(name, color) &#123;</span><br><span class="line">    <span class="keyword">this</span>.name = name;</span><br><span class="line">    <span class="keyword">this</span>.color = color;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  rollWithIt(it) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.name + <span class="string">" is rolling with "</span> + it;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p><strong>ç›¸å¯¹Babel(ç¼–è¯‘å™¨)æ¥è¯´ï¼ŒSweet.jsçš„å®æ˜¯æ¨¡å—åŒ–/æ˜¾å¼çš„ã€‚Babelä½ éœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®å„ç§æ’ä»¶å’Œé€‰é¡¹ï¼Œå°¤å…¶æ˜¯å›¢é˜Ÿé¡¹ç›®æ„å»ºæœ‰ç»Ÿä¸€è§„èŒƒå’Œç¯å¢ƒæ—¶ï¼Œé¡¹ç›®æ„å»ºè„šæœ¬ä¿®æ”¹å¯èƒ½æœ‰é™åˆ¶ã€‚è€Œæ¨¡å—åŒ–çš„å®æ˜¯æºä»£ç çš„ä¸€éƒ¨åˆ†ï¼Œè€Œä¸æ˜¯æ„å»ºè„šæœ¬çš„ä¸€éƒ¨åˆ†ï¼Œè¿™ä½¿å¾—å®ƒä»¬å¯ä»¥è¢«çµæ´»åœ°ä½¿ç”¨ã€é‡æ„ä»¥åŠåºŸå¼ƒ</strong>ã€‚</p><p>ä¸‹æ–‡ä»‹ç»çš„ <code>babel-plugin-macros</code> æœ€å¤§çš„ä¼˜åŠ¿å°±åœ¨è¿™é‡Œ, é€šå¸¸<strong>æˆ‘ä»¬å¸Œæœ›æ„å»ºç¯å¢ƒæ˜¯ç»Ÿä¸€çš„ã€ç¨³å®šçš„ã€å¼€å‘äººå‘˜åº”è¯¥ä¸“æ³¨äºä»£ç çš„å¼€å‘ï¼Œè€Œä¸æ˜¯å¦‚ä½•å»æ„å»ºç¨‹åºï¼Œæ­£æ˜¯å› ä¸ºä»£ç å¤šå˜æ€§ï¼Œæ‰å‚¬ç”Ÿå‡ºäº†è¿™äº›æ–¹æ¡ˆ</strong>ã€‚</p><p><br></p><p>éœ€è¦æ³¨æ„çš„æ˜¯<strong>å®æ˜¯åœ¨ç¼–è¯‘é˜¶æ®µå±•å¼€</strong>çš„ï¼Œæ‰€ä»¥æ— æ³•è¿è¡Œç”¨æˆ·ä»£ç ï¼Œä¾‹å¦‚:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> log = <span class="function"><span class="params">msg</span> =&gt;</span> <span class="built_in">console</span>.log(msg); <span class="comment">// ç”¨æˆ·ä»£ç , è¿è¡Œæ—¶è¢«æ±‚å€¼ï¼Œæ‰€ä»¥æ— æ³•è¢«è®¿é—®</span></span><br><span class="line"></span><br><span class="line">syntax m = <span class="function"><span class="params">ctx</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// å®å‡½æ•°åœ¨ç¼–è¯‘é˜¶æ®µè¢«æ‰§è¡Œ</span></span><br><span class="line">  log(<span class="string">'doing some Sweet things'</span>); <span class="comment">// ERROR: æœªæ‰¾åˆ°å˜é‡log</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><br></p><p>Sweet.js å’Œå…¶ä»–è¯­è¨€çš„å®ä¸€æ ·ï¼Œæœ‰äº†å®ƒä½ å¯ä»¥:</p><ul><li>æ–°å¢è¯­æ³•ç³–(å’ŒSweet.js ä¸€æ ·ç”œ), å®ç°å¤åˆè‡ªå·±å£å‘³çš„è¯­æ³•æˆ–è€…æŸäº›å®éªŒæ€§çš„è¯­è¨€ç‰¹æ€§</li><li>è‡ªå®šä¹‰<a href="https://www.sweetjs.org/doc/tutorial#sweet-operators" target="_blank" rel="noopener">æ“ä½œç¬¦</a>, å¾ˆå¼ºå¤§</li><li>æ¶ˆç­é‡å¤çš„ä»£ç ï¼Œæå‡è¯­è¨€çš„è¡¨è¾¾èƒ½åŠ›ã€‚</li><li>â€¦</li><li>åˆ«ç‚«æŠ€</li></ul><p><br></p><p>ğŸ¤•å¾ˆé—æ†¾ï¼Sweet.js åŸºæœ¬æ­»äº†ã€‚æ‰€ä»¥ç°åœ¨å½“ä¸ªç©å…·ç©ç©å°šå¯ï¼Œåˆ‡å‹¿ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚å³ä½¿æ²¡æœ‰æ­»ï¼ŒSweet.js è¿™ç§éæ ‡å‡†çš„è¯­æ³•, å’Œç°æœ‰çš„Javascriptå·¥å…·é“¾ç”Ÿæ€æ ¼æ ¼ä¸å…¥ï¼Œå¼€å‘å’Œè°ƒè¯•éƒ½ä¼šæ¯”è¾ƒéº»çƒ¦(æ¯”å¦‚Typescript).</p><p>å½’æ ¹åˆ°åº•ï¼ŒSweet.js çš„å¤±è´¥ï¼Œæ˜¯ç¤¾åŒºæŠ›å¼ƒäº†å®ƒã€‚Javascriptè¯­è¨€è¡¨è¾¾èƒ½åŠ›è¶Šæ¥è¶Šå¼ºï¼Œç‰ˆæœ¬è¿­ä»£å¿«é€Ÿï¼ŒåŠ ä¸Šæœ‰äº†Babelå’ŒTypescriptè¿™äº›è§£å†³æ–¹æ¡ˆï¼Œå®åœ¨æ‹¿ä¸å‡ºä»€ä¹ˆç†ç”±æ¥ä½¿ç”¨ Sweet.js</p><blockquote><p>Sweet.js ç›¸å…³è®ºæ–‡å¯ä»¥çœ‹<a href="https://github.com/sweet-js/sweet-core/wiki/Macro-resources" target="_blank" rel="noopener">è¿™é‡Œ</a></p></blockquote><p><br></p><h3 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><p>è¿™ä¸€èŠ‚æ‰¯å¾—æœ‰ç‚¹å¤šï¼Œå°†å®çš„å†å²å’Œåˆ†ç±»è®²äº†ä¸ªéã€‚ æœ€åçš„æ€»ç»“æ˜¯Elixirå®˜æ–¹æ•™ç¨‹é‡Œé¢çš„ä¸€å¥è¯ï¼š<strong>æ˜¾å¼å¥½äºéšå¼ï¼Œæ¸…æ™°çš„ä»£ç ä¼˜äºç®€æ´çš„ä»£ç (Clear code is better than concise code)</strong></p><p>èƒ½åŠ›è¶Šå¤§ã€è´£ä»»è¶Šå¤§ã€‚å®å¼ºå¤§ï¼Œæ¯”æ­£å¸¸ç¨‹åºè¦æ›´éš¾ä»¥é©¾é©­ï¼Œä½ å¯èƒ½éœ€è¦ä¸€å®šçš„æˆæœ¬å»å­¦ä¹ å’Œç†è§£å®ƒ, æ‰€ä»¥èƒ½ä¸ç”¨å®å°±ä¸ç”¨å®ï¼Œ<strong>å®æ˜¯åº”è¯¥æœ€åçš„æ³•å®</strong>.</p><p><br><br><br></p><h2 id="æ—¢ç”Ÿ-plugin-ä½•ç”Ÿ-macro"><a href="#æ—¢ç”Ÿ-plugin-ä½•ç”Ÿ-macro" class="headerlink" title="æ—¢ç”Ÿ Plugin ä½•ç”Ÿ Macro"></a>æ—¢ç”Ÿ Plugin ä½•ç”Ÿ Macro</h2><p>ğŸ¤“è¿˜æ²¡å®Œï¼Œ ä¸€ä¸‹å­æ‰¯äº†å¥½è¿œï¼Œæ°å›æ­£é¢˜ã€‚æ—¢ç„¶ Babel æœ‰äº† Plugin ä¸ºä»€ä¹ˆåˆå†’å‡ºäº†ä¸ª <a href="https://github.com/kentcdodds/babel-plugin-macros" target="_blank" rel="noopener"><code>babel-plugin-macros</code></a>?</p><blockquote><p>å¦‚æœä½ å°šä¸äº†è§£Babel Macroï¼Œå¯ä»¥å…ˆè¯»ä¸€ä¸‹<a href="https://github.com/kentcdodds/babel-plugin-macros" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a>, å¦å¤–<a href="https://create-react-app.dev" target="_blank" rel="noopener">Creact-React-APP</a> å·²ç»å†…ç½®</p></blockquote><p>è¿™ä¸ªå¾—ä» <a href="https://github.com/facebook/create-react-app" target="_blank" rel="noopener">Create-React-App(CRA)</a> è¯´èµ·ï¼ŒCRA å°†æ‰€æœ‰çš„é¡¹ç›®æ„å»ºé€»è¾‘éƒ½å°è£…åœ¨<a href="https://github.com/facebook/create-react-app/tree/master/packages/react-scripts" target="_blank" rel="noopener"><code>react-scripts</code></a> æœåŠ¡ä¸­ã€‚<strong>è¿™æ ·çš„å¥½å¤„æ˜¯ï¼Œå¼€å‘è€…ä¸éœ€è¦å†å…³å¿ƒæ„å»ºçš„ç»†èŠ‚, å¦å¤–æ„å»ºå·¥å…·çš„å‡çº§ä¹Ÿå˜å¾—éå¸¸æ–¹ä¾¿, ç›´æ¥å‡çº§ <code>react-scripts</code>å³å¯</strong>ã€‚</p><p>å¦‚æœè‡ªå·±ç»´æŠ¤æ„å»ºè„šæœ¬çš„è¯ï¼Œå‡ä¸€æ¬¡çº§ä½ éœ€è¦å‡çº§ä¸€å¤§å †çš„ä¾èµ–ï¼Œå¦‚æœä½ è¦ç»´æŠ¤è·¨é¡¹ç›®çš„æ„å»ºè„šæœ¬ï¼Œé‚£å°±æ›´è›‹ç–¼äº†ã€‚</p><blockquote><p>æˆ‘åœ¨<a href="https://juejin.im/post/5d2fcaacf265da1b95708f63" target="_blank" rel="noopener">ã€Šä¸ºä»€ä¹ˆè¦ç”¨vue-cli3?ã€‹</a> é‡Œé˜è¿°äº† CRA ä»¥åŠ Vue-cliè¿™ç±»çš„å·¥å…·å¯¹å›¢é˜Ÿé¡¹ç›®ç»´æŠ¤çš„é‡è¦æ€§ã€‚</p></blockquote><p>CRA æ˜¯<strong>å¼ºçº¦å®š</strong>çš„ï¼Œå®ƒæ˜¯æŒ‰ç…§Reactç¤¾åŒºçš„æœ€ä½³å®è·µç»™ä½ å‡†å¤‡çš„ï¼Œä¸ºäº†ä¿æŠ¤å°è£…å¸¦æ¥çš„çº¢åˆ©ï¼Œå®ƒä¸æ¨èä½ å»æ‰‹åŠ¨é…ç½®Webpackã€Babelâ€¦ æ‰€ä»¥æ‰å‚¬ç”Ÿé™¤äº† babel-plugin-macros, å¤§å®¶å¯ä»¥çœ‹è¿™ä¸ª <a href="https://github.com/facebook/create-react-app/issues/2730" target="_blank" rel="noopener">Issue: RFC - babel-macros</a></p><p><strong>æ‰€ä»¥ä¸º Babel å¯»æ±‚ä¸€ä¸ªâ€™é›¶é…ç½®â€™çš„æœºåˆ¶æ˜¯ <code>babel-plugin-macros</code> è¯ç”Ÿçš„ä¸»è¦åŠ¨æœº</strong>ã€‚</p><p>è¿™ç¯‡æ–‡ç« æ­£å¥½è¯å®äº†è¿™ä¸ªåŠ¨æœºï¼š<a href="https://babeljs.io/blog/2017/09/11/zero-config-with-babel-macros" target="_blank" rel="noopener">ã€ŠZero-config code transformation with babel-plugin-macrosã€‹</a>, è¿™ç¯‡æ–‡ç« å¼•è¿°äº†ä¸€ä¸ªé‡è¦çš„è§‚ç‚¹ï¼šâ€<strong>Compilers are the New Frameworks</strong>â€œ</p><p>çš„ç¡®ï¼Œ<strong>Babel åœ¨ç°ä»£çš„å‰ç«¯å¼€å‘ä¸­æ‰®æ¼”ç€ä¸€ä¸ªå¾ˆé‡è¦çš„è§’è‰²ï¼Œè¶Šæ¥è¶Šå¤šçš„æ¡†æ¶æˆ–åº“ä¼šåˆ›å»ºè‡ªå·±çš„ Babel æ’ä»¶ï¼Œå®ƒä»¬ä¼šåœ¨ç¼–è¯‘é˜¶æ®µåšä¸€äº›ä¼˜åŒ–ï¼Œæ¥æé«˜ç”¨æˆ·ä½“éªŒã€å¼€å‘ä½“éªŒä»¥åŠè¿è¡Œæ—¶çš„æ€§èƒ½</strong>ã€‚æ¯”å¦‚:</p><ul><li><a href="https://github.com/lodash/babel-plugin-lodash" target="_blank" rel="noopener">babel-plugin-lodash</a> å°†lodashå¯¼å…¥è½¬æ¢ä¸ºæŒ‰éœ€å¯¼å…¥</li><li><a href="https://github.com/ant-design/babel-plugin-import" target="_blank" rel="noopener">babel-plugin-import</a> ä¸Šç¯‡æ–‡ç« æè¿‡çš„è¿™ä¸ªæ’ä»¶ï¼Œä¹Ÿæ˜¯å®ç°æŒ‰éœ€å¯¼å…¥</li><li><a href="https://github.com/jamiebuilds/babel-react-optimize" target="_blank" rel="noopener">babel-react-optimize</a> é™æ€åˆ†æReactä»£ç ï¼Œåˆ©ç”¨ä¸€å®šçš„æªæ–½ä¼˜åŒ–è¿è¡Œæ•ˆç‡ã€‚æ¯”å¦‚å°†é™æ€çš„propsæˆ–ç»„ä»¶æŠ½ç¦»ä¸ºå¸¸é‡</li><li><a href="https://github.com/entwicklerstube/babel-plugin-root-import" target="_blank" rel="noopener">root-import</a> å°†åŸºäºæ ¹ç›®å½•çš„å¯¼å…¥è·¯å¾„é‡å†™ä¸ºç›¸å¯¹è·¯å¾„</li><li><a href="https://www.styled-components.com/docs/tooling#babel-macro" target="_blank" rel="noopener">styled-components</a> å…¸å‹çš„CSS-in-jsæ–¹æ¡ˆï¼Œåˆ©ç”¨Babel æ’ä»¶æ¥æ”¯æŒæœåŠ¡ç«¯æ¸²æŸ“ã€é¢„ç¼–è¯‘æ¨¡æ¿ã€æ ·å¼å‹ç¼©ã€æ¸…é™¤æ­»ä»£ç ã€æå‡è°ƒè¯•ä½“éªŒã€‚</li><li><a href="https://github.com/kentcdodds/babel-plugin-preval" target="_blank" rel="noopener">preval</a> åœ¨ç¼–è¯‘æ—¶é¢„æ‰§è¡Œä»£ç </li><li><a href="https://www.apollographql.com/docs/react/v2.5/recipes/babel/#using-babel-plugin-graphql-tag" target="_blank" rel="noopener">babel-plugin-graphql-tag</a> é¢„ç¼–è¯‘GraphQLæŸ¥è¯¢</li><li>â€¦</li></ul><p><br></p><p>ä¸Šé¢åˆ—ä¸¾çš„æ’ä»¶åœºæ™¯ä¸­ï¼Œ<strong>å¹¶ä¸æ˜¯æ‰€æœ‰æ’ä»¶éƒ½æ˜¯é€šç”¨çš„ï¼Œå®ƒä»¬è¦ä¹ˆæ˜¯è·ŸæŸä¸€ç‰¹å®šçš„æ¡†æ¶ç»‘å®šã€è¦ä¹ˆç”¨äºå¤„ç†ç‰¹å®šçš„æ–‡ä»¶ç±»å‹æˆ–æ•°æ®ã€‚è¿™äº›éé€šç”¨çš„æ’ä»¶æ˜¯æœ€é€‚åˆä½¿ç”¨macroå–ä»£çš„</strong>ã€‚</p><p>ç”¨ <code>preval</code> ä¸¾ä¸ªä¾‹å­. ä½¿ç”¨æ’ä»¶å½¢å¼, ä½ é¦–å…ˆè¦é…ç½®æ’ä»¶:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"plugins"</span>: [<span class="string">"preval"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä¼ é€’ç»™prevalçš„å­—ç¬¦ä¸²ä¼šåœ¨ç¼–è¯‘é˜¶æ®µè¢«æ‰§è¡Œ</span></span><br><span class="line"><span class="comment">// prevalæ’ä»¶ä¼šæŸ¥æ‰¾prevalæ ‡è¯†ç¬¦ï¼Œå°†å­—ç¬¦ä¸²æå–å‡ºæ¥æ‰§è¡Œï¼Œåœ¨å°†æ‰§è¡Œçš„ç»“æœèµ‹å€¼ç»™greeting</span></span><br><span class="line"><span class="keyword">const</span> greeting = preval<span class="string">`</span></span><br><span class="line"><span class="string">  const fs = require('fs')</span></span><br><span class="line"><span class="string">  module.exports = fs.readFileSync(require.resolve('./greeting.txt'), 'utf8')</span></span><br><span class="line"><span class="string">`</span></span><br></pre></td></tr></table></figure><p><br></p><p>ä½¿ç”¨Macroæ–¹å¼:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// é¦–å…ˆä½ è¦æ˜¾å¼å¯¼å…¥</span></span><br><span class="line"><span class="keyword">import</span> preval <span class="keyword">from</span> <span class="string">'preval.macro'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å’Œä¸Šé¢ä¸€æ ·</span></span><br><span class="line"><span class="keyword">const</span> greeting = preval<span class="string">`</span></span><br><span class="line"><span class="string">  const fs = require('fs')</span></span><br><span class="line"><span class="string">  module.exports = fs.readFileSync(require.resolve('./greeting.txt'), 'utf8')</span></span><br><span class="line"><span class="string">`</span></span><br></pre></td></tr></table></figure><p><br></p><p>è¿™ä¸¤è€…è¾¾åˆ°çš„æ•ˆæœæ˜¯ä¸€æ ·çš„ï¼Œä½†æ„ä¹‰å´ä¸å¤ªä¸€æ ·ã€‚æœ‰å“ªäº›åŒºåˆ«ï¼Ÿ</p><ul><li><p>1ï¸âƒ£ <strong>å¾ˆæ˜¾ç„¶ï¼ŒMacroä¸éœ€è¦é…ç½®<code>.babelrc</code></strong>(<em>å½“ç„¶babel-plugin-macrosè¿™ä¸ªåŸºåº§éœ€è¦è£…å¥½</em>). è¿™ä¸ªå¯¹äºCRAè¿™ç§ä¸æ¨èé…ç½®æ„å»ºè„šæœ¬çš„å·¥å…·æ¥è¯´å¾ˆæœ‰å¸®åŠ©</p></li><li><p>2ï¸âƒ£ <strong>ç”±éšå¼è½¬æ¢ä¸ºäº†æ˜¾å¼</strong>ã€‚ä¸Šä¸€èŠ‚å°±è¯´äº†â€œæ˜¾å¼å¥½äºéšå¼â€ã€‚ä½ å¿…é¡»åœ¨æºä»£ç ä¸­é€šè¿‡<code>å¯¼å…¥è¯­å¥</code>å£°æ˜ä½ ä½¿ç”¨äº† Macroï¼› è€ŒåŸºäºæ’ä»¶çš„æ–¹å¼ï¼Œä½ å¯èƒ½ä¸çŸ¥é“<code>preval</code>è¿™ä¸ªæ ‡è¯†ç¬¦å“ªé‡Œæ¥çš„? å¦‚ä½•è¢«åº”ç”¨ï¼Ÿä½•æ—¶è¢«åº”ç”¨ï¼Ÿè€Œä¸”é€šå¸¸ä½ è¿˜éœ€è¦å’Œå…¶ä»–å·¥å…·é“¾çš„é…åˆï¼Œä¾‹å¦‚ESlintã€Typescriptå£°æ˜ç­‰ç­‰ã€‚</p><p>  Macro ç”±ä»£ç æ˜¾å¼åœ°åº”ç”¨ï¼Œæˆ‘ä»¬æ›´æ˜ç¡®å®ƒè¢«åº”ç”¨çš„ç›®çš„å’Œæ—¶æœºï¼Œå¯¹æºä»£ç çš„ä¾µå…¥æ€§æœ€å°ã€‚å› ä¸ºä¸­é—´å¤šäº† <code>babel-plugin-macro</code> è¿™ä¸€å±‚ï¼Œæˆ‘ä»¬é™ä½äº†å¯¹æ„å»ºç¯å¢ƒçš„è€¦åˆï¼Œè®©æˆ‘ä»¬çš„ä»£ç æ›´æ–¹ä¾¿è¢«è¿ç§»ã€‚</p></li><li><p>3ï¸âƒ£ <strong>Macroç›¸æ¯”Plugin æ›´å®¹æ˜“è¢«å®ç°</strong>ã€‚å› ä¸ºå®ƒä¸“æ³¨äºå…·ä½“çš„ AST èŠ‚ç‚¹ï¼Œè§ä¸‹æ–‡</p></li><li><p>4ï¸âƒ£ å¦å¤–ï¼Œå½“é…ç½®å‡ºé”™æ—¶ï¼ŒMacroå¯ä»¥å¾—åˆ°æ›´å¥½çš„é”™è¯¯æç¤º</p></li></ul><p>æœ‰åˆ©æœ‰å¼Šï¼ŒBabel Macro è‚¯å®šä¹Ÿæœ‰äº›ç¼ºé™·ï¼Œä¾‹å¦‚ç›¸å¯¹äºæ’ä»¶æ¥è¯´åªèƒ½<em>æ˜¾å¼è½¬æ¢</em>ï¼Œè¿™æ ·ä»£ç å¯èƒ½ä¼šæ¯”è¾ƒå•°å—¦ï¼Œä¸è¿‡ä¸ªäººè§‰å¾—åœ¨æŸäº›åœºæ™¯åˆ©å¤§äºå¼Š, èƒ½æ˜¾å¼çš„å°±æ˜¾å¼ã€‚</p><p><br></p><p>é‚£ä¹ˆBabel Macroä¹Ÿæ˜¯å®ï¼Ÿ<strong>ç›¸å¯¹äº Sweet.js è¿™äº›â€™æ­£ç»Ÿâ€™çš„å®æœºåˆ¶æœ‰å“ªäº›ä¸è¶³</strong>ï¼Ÿ</p><ul><li><p><strong>é¦–å…ˆ Babel Macro å¿…é¡»æ˜¯åˆæ³•çš„ Javascript è¯­æ³•</strong>ã€‚ä¸æ”¯æŒè‡ªå®šä¹‰è¯­æ³•ï¼Œä¹Ÿè¦åˆ†ä¸¤é¢è®¨è®ºï¼Œåˆæ³•çš„Javascriptè¯­æ³•ä¸è‡³äºæ‰“ç ´ç°æœ‰çš„å·¥å…·åä½œé“¾ï¼Œå¦‚æœå…è®¸ç”¨æˆ·æ¯«æ— é™åˆ¶åœ°åˆ›å»ºæ–°çš„è¯­æ³•ï¼Œå°†æ¥æŒ‡ä¸å®šä¼šå’Œæ ‡å‡†çš„è¯­æ³•å‘ç”Ÿæ­§ä¹‰ã€‚ åè¿‡æ¥ä¸èƒ½è‡ªå®šä¹‰è¯­æ³•çš„â€˜å®â€™ï¼Œæ˜¯å¦æ˜¾å¾—ä¸å¤ªåœ°é“ï¼Œä¸å¤Ÿâ€™å¼ºå¤§â€™?</p></li><li><p><strong>å› ä¸ºå¿…é¡»æ˜¯åˆæ³•çš„Javascriptè¯­æ³•ï¼ŒBabel Macro å®ç°DSL(Domain-specific languages)èƒ½åŠ›å°±å¼±åŒ–äº†</strong></p></li><li><p><strong>å†è€…ï¼ŒBabel Macro å’Œ Babel Pluginæ²¡æœ‰æœ¬è´¨çš„åŒºåˆ«</strong>ï¼Œç›¸æ¯”Sweet.jsæä¾›äº†æ˜¾å¼å®šä¹‰å’Œåº”ç”¨å®çš„è¯­æ³•ï¼ŒBabel Macroç›´æ¥æ“ä½œ AST åˆ™è¦å¤æ‚å¾—å¤šï¼Œä½ è¿˜æ˜¯éœ€è¦äº†è§£ä¸€äº›ç¼–è¯‘åŸç†ï¼Œè¿™æŠŠä¸€èˆ¬çš„å¼€å‘è€…æŒ¡åœ¨äº†é—¨å¤–ã€‚</p></li></ul><blockquote><p>Babel å¯ä»¥å®ç°è‡ªå®šä¹‰è¯­æ³•ï¼Œåªä¸è¿‡ä½ éœ€è¦Fork <code>@babel/parser</code>, å¯¹å®ƒè¿›è¡Œæ”¹é€ (å¯ä»¥çœ‹è¿™ç¯‡æ–‡ç« <a href="https://juejin.im/post/5d9be731f265da5bbc3e879b" target="_blank" rel="noopener">ã€Šç²¾è¯»ã€Šç”¨ Babel åˆ›é€ è‡ªå®šä¹‰ JS è¯­æ³•ã€‹ã€‹</a>)ã€‚è¿™ä¸ªæœ‰ç‚¹æŠ˜è…¾ï¼Œä¸å¤ªæ¨è</p></blockquote><p><br></p><p><strong>æ€»ä¹‹ï¼ŒBabel Macro æœ¬è´¨ä¸Šå’ŒBabel Pluginæ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œå®ƒåªæ˜¯åœ¨Plugin ä¹‹ä¸Šå°è£…äº†ä¸€å±‚(<a href="https://juejin.im/post/5d7ffad551882545ff173083" target="_blank" rel="noopener">åˆ†å±‚æ¶æ„æ¨¡å¼çš„å¼ºå¤§</a>)ï¼Œåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„å¹³å°ï¼Œè®©å¼€å‘è€…å¯ä»¥åœ¨æºä»£ç å±‚é¢æ˜¾å¼åœ°åº”ç”¨ä»£ç è½¬æ¢</strong>ã€‚æ‰€ä»¥ï¼Œ<strong>ä»»ä½•é€‚åˆæ˜¾å¼å»è½¬æ¢çš„åœºæ™¯éƒ½é€‚åˆç”¨Babel Macroæ¥åš</strong>ï¼š</p><ul><li>ç‰¹å®šæ¡†æ¶ã€åº“çš„ä»£ç è½¬æ¢ã€‚å¦‚ <code>styled-components</code></li><li>åŠ¨æ€ç”Ÿæˆä»£ç ã€‚<code>preval</code></li><li>ç‰¹å®šæ–‡ä»¶ã€è¯­è¨€çš„å¤„ç†ã€‚ä¾‹å¦‚<code>graphql-tag.macro</code>ã€<code>yaml.macro</code>ã€<code>svgr.macro</code></li><li>â€¦ (æŸ¥çœ‹<a href="https://github.com/jgierer12/awesome-babel-macros#graphql" target="_blank" rel="noopener">awesome-babel-macros</a>)</li></ul><p><br><br><br></p><h2 id="å¦‚ä½•å†™ä¸€ä¸ª-babel-macro"><a href="#å¦‚ä½•å†™ä¸€ä¸ª-babel-macro" class="headerlink" title="å¦‚ä½•å†™ä¸€ä¸ª Babel Macro"></a>å¦‚ä½•å†™ä¸€ä¸ª Babel Macro</h2><p>æ‰€ä»¥ï¼ŒBabel Macroæ˜¯å¦‚ä½•è¿ä½œçš„å‘¢ï¼Ÿ <code>babel-plugin-macros</code> è¦æ±‚å¼€å‘è€…å¿…é¡»æ˜¾å¼åœ°å¯¼å…¥ Macroï¼Œå®ƒä¼šéå†åŒ¹é…æ‰€æœ‰å¯¼å…¥è¯­å¥ï¼Œ<strong>å¦‚æœå¯¼å…¥æºåŒ¹é…<code>/[./]macro(\.js)?$/</code>æ­£åˆ™ï¼Œå°±ä¼šè®¤ä¸ºä½ åœ¨å¯ç”¨Macro</strong>ã€‚ä¾‹å¦‚ä¸‹é¢è¿™äº›å¯¼å…¥è¯­å¥éƒ½åŒ¹é…æ­£åˆ™ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> foo <span class="keyword">from</span> <span class="string">'my.macro'</span></span><br><span class="line"><span class="keyword">import</span> &#123; bar &#125; <span class="keyword">from</span> <span class="string">'./bar/macro'</span></span><br><span class="line"><span class="keyword">import</span> &#123; baz <span class="keyword">as</span> _baz&#125; <span class="keyword">from</span> <span class="string">'baz/macro.js'</span></span><br><span class="line"><span class="comment">// ä¸æ”¯æŒå‘½åç©ºé—´å¯¼å…¥</span></span><br></pre></td></tr></table></figure><p><br></p><p>Ok, å½“åŒ¹é…åˆ°å¯¼å…¥è¯­å¥åï¼Œ<code>babel-plugin-macros</code>å°±ä¼šå»å¯¼å…¥ä½ æŒ‡å®šçš„ <code>macro</code> <strong>æ¨¡å—æˆ–è€…npmåŒ…</strong>(Macro å³å¯ä»¥æ˜¯æœ¬åœ°æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æ˜¯å…¬å¼€çš„ npm åŒ…ï¼Œ æˆ–è€…æ˜¯npmåŒ…ä¸­çš„å­è·¯å¾„)ã€‚</p><p>é‚£ä¹ˆ <code>macro</code> æ–‡ä»¶é‡Œé¢è¦åŒ…å«ä»€ä¹ˆå†…å®¹å‘¢ï¼Ÿå¦‚ä¸‹:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; createMacro &#125; = <span class="built_in">require</span>(<span class="string">'babel-plugin-macros'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = createMacro(<span class="function">(<span class="params">&#123;references, state, babel&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// ... macro é€»è¾‘</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><br></p><p><code>macro</code> æ–‡ä»¶å¿…é¡»é»˜è®¤å¯¼å‡ºä¸€ä¸ªç”± <code>ceateMacro</code> åˆ›å»ºçš„å®ä¾‹, åœ¨å…¶å›è°ƒä¸­å¯ä»¥è·å–åˆ°ä¸€äº›å…³é”®å¯¹è±¡ï¼š</p><ul><li><code>babel</code> å’Œæ™®é€šçš„Babelæ’ä»¶ä¸€æ ·ï¼ŒMacro å¯ä»¥è·å–åˆ°ä¸€ä¸ª <code>babel-core</code> å¯¹è±¡</li><li><code>state</code> è¿™ä¸ªæˆ‘ä»¬ä¹Ÿæ¯”è¾ƒç†Ÿæ‚‰ï¼ŒBabel æ’ä»¶çš„ visitor æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯å®ƒ, æˆ‘ä»¬å¯ä»¥é€šè¿‡å®ƒè·å–ä¸€äº›é…ç½®ä¿¡æ¯ä»¥åŠä¿å­˜ä¸€äº›è‡ªå®šä¹‰çŠ¶æ€</li><li><code>references</code> è·å– Macro å¯¼å‡ºæ ‡è¯†ç¬¦çš„æ‰€æœ‰å¼•ç”¨ã€‚ä¸Šä¸€ç¯‡æ–‡ç« ä»‹ç»äº†ä½œç”¨åŸŸï¼Œä½ åº”è¯¥è¿˜æ²¡å¿˜è®°ç»‘å®šå’Œå¼•ç”¨çš„æ¦‚å¿µã€‚å¦‚ä¸‹</li></ul><p>å‡è®¾ç”¨æˆ·è¿™æ ·å­ä½¿ç”¨ä½ çš„ Macro:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> foo, &#123;bar, baz <span class="keyword">as</span> Baz&#125; <span class="keyword">from</span> <span class="string">'./my.macro'</span> <span class="comment">// åˆ›å»ºä¸‰ä¸ªç»‘å®š</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸‹é¢å¼€å§‹å¼•ç”¨è¿™äº›ç»‘å®š</span></span><br><span class="line">foo(<span class="number">1</span>)</span><br><span class="line">foo(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">bar<span class="string">`by tagged Template`</span></span><br><span class="line">;<span class="xml"><span class="tag">&lt;<span class="name">Baz</span>&gt;</span>by JSX<span class="tag">&lt;/<span class="name">Baz</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆä½ å°†æ‹¿åˆ°<code>references</code>ç»“æ„æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="comment">// key ä¸º'ç»‘å®š', value ä¸º'å¼•ç”¨æ•°ç»„'</span></span><br><span class="line">  <span class="keyword">default</span>: [NodePath<span class="comment">/*Identifier(foo)*/</span>, NodePath<span class="comment">/*Identifier(foo)*/</span>], <span class="comment">// é»˜è®¤å¯¼å‡ºï¼Œå³foo</span></span><br><span class="line">  bar: [NodePath<span class="comment">/*Identifier(bar)*/</span>],</span><br><span class="line">  baz: [NodePath<span class="comment">/*JSXIdentifier(Baz)*/</span>], <span class="comment">// æ³¨æ„keyä¸ºbazï¼Œä¸æ˜¯Baz</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æŸ¥çœ‹<a href="https://github.com/kentcdodds/babel-plugin-macros/blob/master/other/docs/author.md" target="_blank" rel="noopener">è¯¦ç»†å¼€å‘æŒ‡å—</a> <br><br><a href="https://astexplorer.net" target="_blank" rel="noopener">AST Explorer</a> ä¹Ÿæ”¯æŒ babel-plugin-macrosï¼Œå¯ä»¥ç©ä¸€ä¸‹. ä¸‹é¢çš„å®æˆ˜å®ä¾‹ï¼Œä¹Ÿå»ºè®®åœ¨è¿™é‡Œæ¢ç´¢ä¸€ä¸‹</p></blockquote><p>æ¥ä¸‹æ¥ä½ å°±å¯ä»¥éå†<code>references</code>, å¯¹è¿™äº›èŠ‚ç‚¹è¿›è¡Œè½¬æ¢ï¼Œå®ç°ä½ æƒ³è¦çš„å®åŠŸèƒ½ã€‚å¼€å§‹å®æˆ˜!</p><p><br><br><br></p><h3 id="å®æˆ˜"><a href="#å®æˆ˜" class="headerlink" title="å®æˆ˜"></a>å®æˆ˜</h3><p>è¿™ä¸€æ¬¡æˆ‘ä»¬æ¨¡èŒƒ<a href="https://github.com/kentcdodds/babel-plugin-preval/blob/master/src/object-to-ast.js" target="_blank" rel="noopener"><code>preval</code></a> åˆ›å»ºä¸€ä¸ª<code>eval.macro</code> Macro, åˆ©ç”¨å®ƒåœ¨ç¼–è¯‘é˜¶æ®µæ‰§è¡Œ(eval)ä¸€äº›ä»£ç ã€‚ä¾‹å¦‚:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> evalm <span class="keyword">from</span> <span class="string">'eval.macro'</span></span><br><span class="line"><span class="keyword">const</span> x = evalm<span class="string">`</span></span><br><span class="line"><span class="string">function fib(n) &#123;</span></span><br><span class="line"><span class="string">  const SQRT_FIVE = Math.sqrt(5);</span></span><br><span class="line"><span class="string">  return Math.round(1/SQRT_FIVE * (Math.pow(0.5 + SQRT_FIVE/2, n) - Math.pow(0.5 - SQRT_FIVE/2, n)));</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">fib(20)</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//      â†“ â†“ â†“ â†“ â†“ â†“</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> x = <span class="number">6765</span></span><br></pre></td></tr></table></figure><p><br></p><p>åˆ›å»º Macro æ–‡ä»¶. æŒ‰ç…§ä¸Šä¸€èŠ‚çš„ä»‹ç»ï¼Œâ‘  æˆ‘ä»¬ä½¿ç”¨<code>createMacro</code>æ¥åˆ›å»ºä¸€ä¸ª <code>Macro</code>å®ä¾‹, â‘¡ å¹¶ä»<code>references</code> ä¸­æ‹¿å‡ºæ‰€æœ‰<code>å¯¼å‡ºæ ‡è¯†ç¬¦</code>çš„å¼•ç”¨è·¯å¾„, â‘¢æ¥ç€å°±æ˜¯å¯¹è¿™äº›å¼•ç”¨è·¯å¾„è¿›è¡ŒASTè½¬æ¢:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; createMacro, MacroError &#125; = <span class="built_in">require</span>(<span class="string">'babel-plugin-macros'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myMacro</span>(<span class="params">&#123; references, state, babel &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// è·å–é»˜è®¤å¯¼å‡ºçš„æ‰€æœ‰å¼•ç”¨</span></span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="attr">default</span>: defaultImport = [] &#125; = references;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// éå†å¼•ç”¨å¹¶è¿›è¡Œæ±‚å€¼</span></span><br><span class="line">  defaultImport.forEach(<span class="function"><span class="params">referencePath</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (referencePath.parentPath.type === <span class="string">"TaggedTemplateExpression"</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> val = referencePath.parentPath.get(<span class="string">"quasi"</span>).evaluate().value</span><br><span class="line">      <span class="keyword">const</span> res = <span class="built_in">eval</span>(val)</span><br><span class="line">      <span class="keyword">const</span> ast = objToAst(res)</span><br><span class="line">      referencePath.parentPath.replaceWith(ast)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// è¾“å‡ºå‹å¥½çš„æŠ¥é”™ä¿¡æ¯</span></span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> MacroError(<span class="string">'åªæ”¯æŒæ ‡ç­¾æ¨¡æ¿å­—ç¬¦ä¸², ä¾‹å¦‚ï¼ševalm`1`'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = createMacro(myMacro);</span><br></pre></td></tr></table></figure><p><br></p><p>ä¸ºäº†è¡Œæ–‡ç®€æ´ï¼Œæœ¬æ¡ˆä¾‹ä¸­åªæ”¯æŒ<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/template_strings" target="_blank" rel="noopener"><code>æ ‡ç­¾æ¨¡æ¿å­—ç¬¦ä¸²</code></a> å½¢å¼è°ƒç”¨ï¼Œä½†æ˜¯æ ‡ç­¾æ¨¡æ¿å­—ç¬¦ä¸²ä¸­å¯èƒ½åŒ…å«å†…æ’çš„å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">hello<span class="string">`</span></span><br><span class="line"><span class="string">hello world <span class="subst">$&#123;foo&#125;</span> + <span class="subst">$&#123;bar + baz&#125;</span></span></span><br><span class="line"><span class="string">`</span></span><br></pre></td></tr></table></figure><p>å…¶ AST ç»“æ„å¦‚ä¸‹:</p><p><img src="/images/babel/tag-template.png" alt></p><p><br></p><p>æˆ‘ä»¬éœ€è¦å°† <code>TaggedTemplateExpression</code> èŠ‚ç‚¹è½¬æ¢ä¸ºå­—ç¬¦ä¸²ã€‚æ‰‹åŠ¨å»æ‹¼æ¥ä¼šå¾ˆéº»çƒ¦ï¼Œå¥½åœ¨æ¯ä¸ª AST èŠ‚ç‚¹çš„ Path å¯¹è±¡éƒ½æœ‰ä¸€ä¸ª<code>evaluate</code> æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å¯ä»¥å¯¹èŠ‚ç‚¹è¿›è¡Œâ€˜é™æ€æ±‚å€¼â€™ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">t.evaluate(parse(<span class="string">"5 + 5"</span>)) <span class="comment">// &#123; confident: true, value: 10 &#125;</span></span><br><span class="line">t.evaluate(parse(<span class="string">"!true"</span>)) <span class="comment">// &#123; confident: true, value: false &#125;</span></span><br><span class="line"><span class="comment">// âŒä¸¤ä¸ªå˜é‡ç›¸åŠ æ— æ³•æ±‚å€¼ï¼Œå› ä¸ºå˜é‡å€¼åœ¨è¿è¡Œæ—¶æ‰å­˜åœ¨ï¼Œè¿™é‡Œconfidentä¸ºfalseï¼š  </span></span><br><span class="line">t.evaluate(parse(<span class="string">"foo + foo"</span>)) <span class="comment">// &#123; confident: false, value: undefined &#125;</span></span><br></pre></td></tr></table></figure><p>å› æ­¤è¿™æ ·å­çš„æ ‡ç­¾æ¨¡æ¿å­—ç¬¦ä¸²æ˜¯æ— æ³•æ±‚å€¼çš„:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">evalm<span class="string">`1 + <span class="subst">$&#123;foo&#125;</span>`</span> <span class="comment">// åŒ…å«å˜é‡</span></span><br><span class="line">evalm<span class="string">`1 + <span class="subst">$&#123;bar(<span class="number">1</span>)&#125;</span>`</span> <span class="comment">// åŒ…å«å‡½æ•°è°ƒç”¨</span></span><br></pre></td></tr></table></figure><p><strong>è¿™ä¸ªå’Œ <code>Typescript</code> çš„ <a href="https://www.typescriptlang.org/docs/handbook/enums.html" target="_blank" rel="noopener"><code>enum</code></a>ï¼Œ è¿˜æœ‰ä¸€äº›ç¼–è¯‘è¯­è¨€çš„å¸¸é‡æ˜¯ä¸€æ ·çš„ï¼Œå®ƒä»¬åœ¨ç¼–è¯‘é˜¶æ®µè¢«æ±‚å€¼ï¼Œåªæœ‰ä¸€äº›åŸå§‹å€¼ä»¥åŠä¸€äº›åŸå§‹å€¼çš„è¡¨è¾¾å¼æ‰æ”¯æŒåœ¨ç¼–è¯‘é˜¶æ®µè¢«æ±‚å€¼</strong>.</p><p><br></p><p>Soï¼Œä¸Šé¢çš„ä»£ç è¿˜ä¸å¤Ÿå¥å£®ï¼Œæˆ‘ä»¬å†ä¼˜åŒ–ä¸€ä¸‹ï¼Œåœ¨æ±‚å€¼å¤±è´¥æ—¶ç»™ç”¨æˆ·æ›´å¥½çš„æç¤º:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">defaultImport.forEach(<span class="function"><span class="params">referencePath</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (referencePath.parentPath.type === <span class="string">"TaggedTemplateExpression"</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> evaluated = referencePath.parentPath.get(<span class="string">"quasi"</span>).evaluate();</span><br><span class="line">    <span class="comment">// è½¬æ¢æ ‡ç­¾æ¨¡æ¿å­—ç¬¦ä¸²å¤±è´¥</span></span><br><span class="line">    <span class="keyword">if</span> (!evaluated.confident) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> MacroError(<span class="string">"æ ‡ç­¾æ¨¡æ¿å­—ç¬¦ä¸²å†…æ’å€¼åªæ”¯æŒåŸå§‹å€¼å’ŒåŸå§‹å€¼è¡¨è¾¾å¼"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> res = <span class="built_in">eval</span>(evaluated.value);</span><br><span class="line">      <span class="keyword">const</span> ast = objToAst(res);</span><br><span class="line">      <span class="comment">// æ›¿æ¢æ‰è°ƒç”¨èŠ‚ç‚¹</span></span><br><span class="line">      referencePath.parentPath.replaceWith(ast);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> MacroError(<span class="string">`æ±‚å€¼å¤±è´¥: <span class="subst">$&#123;err.message&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> MacroError(<span class="string">"åªæ”¯æŒæ ‡ç­¾æ¨¡æ¿å­—ç¬¦ä¸², ä¾‹å¦‚ï¼ševalm`1 + 1`"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><br></p><p>æ¥ä¸‹æ¥å°†æ‰§è¡Œåçš„å€¼è½¬æ¢ä¸º ASTï¼Œç„¶åæ›¿æ¢æ‰<code>TaggedTemplateExpression</code>:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">objToAst</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> str = <span class="built_in">JSON</span>.stringify(res);</span><br><span class="line">  <span class="keyword">if</span> (str == <span class="literal">null</span>) &#123;</span><br><span class="line">    str = <span class="string">"undefined"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> variableDeclarationNode = babel.template(<span class="string">`var x = <span class="subst">$&#123;str&#125;</span>`</span>, &#123;&#125;)();</span><br><span class="line">  <span class="comment">// å–å‡ºåˆå§‹åŒ–è¡¨è¾¾å¼çš„ AST</span></span><br><span class="line">  <span class="keyword">return</span> variableDeclarationNode.declarations[<span class="number">0</span>].init;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œ<code>@babel/template</code> å°±æ´¾ä¸Šç”¨åœºäº†ï¼Œå®ƒå¯ä»¥å°†å­—ç¬¦ä¸²ä»£ç è§£ææˆ ASTï¼Œå½“ç„¶ç›´æ¥ä½¿ç”¨<code>parse</code>æ–¹æ³•è§£æä¹Ÿæ˜¯å¯ä»¥çš„ã€‚</p><p><br></p><p>Ok, æ–‡ç« åˆ°è¿™é‡ŒåŸºæœ¬ç»“æŸäº†ã€‚æœ¬æ–‡å¯¹â€˜å®â€™è¿›è¡Œäº†æ·±å…¥çš„è®¨è®ºï¼Œä» <code>C</code> è¯­è¨€çš„æ–‡æœ¬æ›¿æ¢å®åˆ°æ¿’æ­»çš„<code>Sweet.js</code>, æœ€åä»‹ç»äº†<code>babel-plugin-macros</code>.</p><p>Babel Macro æœ¬è´¨ä¸Šè¿˜æ˜¯Babel æ’ä»¶ï¼Œåªä¸è¿‡å®ƒæ˜¯æ¨¡å—åŒ–çš„ï¼Œä½ è¦ä½¿ç”¨å®ƒå¿…é¡»æ˜¾å¼åœ°å¯¼å…¥ã€‚å’Œâ€˜æ­£ç»Ÿâ€™å®ç›¸æ¯”ï¼Œ Babel Macro ç›´æ¥æ“ä½œ ASTï¼Œéœ€è¦ä½ æŒæ¡ç¼–è¯‘åŸç†ï¼Œ â€˜æ­£ç»Ÿâ€™å®å¯ä»¥å®ç°çš„ä¸œè¥¿, Babel Macroä¹Ÿå¯ä»¥å®ç°(ä¾‹å¦‚å«ç”Ÿå®). è™½ç„¶ç›¸æ¯”Babelæ’ä»¶ç•¥æœ‰ç®€åŒ–ï¼Œè¿˜æ˜¯æ¯”è¾ƒå•°å—¦ã€‚å¦å¤–Babel Macro ä¸èƒ½åˆ›å»ºæ–°çš„è¯­æ³•ï¼Œè¿™ä½¿å¾—å®ƒå¯ä»¥å’Œç°æœ‰çš„å·¥å…·ç”Ÿæ€ä¿æŒå…¼å®¹ã€‚</p><p>æœ€åï¼æ‰“å¼€è„‘æ´ ğŸ§ ï¼ŒBabel Macro å¯ä»¥åšå¾ˆå¤šæœ‰æ„æ€çš„ä¸œè¥¿ï¼ŒæŸ¥çœ‹<a href="https://github.com/jgierer12/awesome-babel-macros" target="_blank" rel="noopener">ã€ŠAwesome babel macrosã€‹</a>ã€‚ä¸è¿‡è¦<strong>è°¨è®°ï¼šâ€˜æ˜¾å¼å¥½äºéšå¼ï¼Œæ¸…æ™°çš„ä»£ç ä¼˜äºç®€æ´çš„ä»£ç â€™</strong></p><p><br></p><p><strong>æˆªæ­¢ 2019.10.10 æ˜é‡‘ç²‰ä¸æ•°å·²ç»çªç ´ âœ¨2000âœ¨ï¼Œç»§ç»­å…³æ³¨æˆ‘ï¼Œç‚¹èµç»™æˆ‘æ”¯æŒ</strong>ã€‚</p><p><br></p><p><img src="/images/sponsor.jpg" alt></p><p><br></p><h2 id="æ‰©å±•èµ„æ–™"><a href="#æ‰©å±•èµ„æ–™" class="headerlink" title="æ‰©å±•èµ„æ–™"></a>æ‰©å±•èµ„æ–™</h2><ul><li><a href="https://babeljs.io/blog/2017/09/11/zero-config-with-babel-macros" target="_blank" rel="noopener">Zero-config code transformation with babel-plugin-macros</a></li><li><a href="https://github.com/facebook/create-react-app/issues/2730" target="_blank" rel="noopener">RFC - babel-macros</a></li><li><a href="https://jlongster.com/Stop-Writing-JavaScript-Compilers--Make-Macros-Instead" target="_blank" rel="noopener">STOP WRITING JAVASCRIPT COMPILERS! MAKE MACROS INSTEAD</a></li><li><a href="https://blog.oyanglul.us/javascript/clojure-essence-in-javascript-macro" target="_blank" rel="noopener">JavaScriptç©è½¬Clojureå¤§æ³•ä¹‹ - Macro (1)</a></li><li><a href="https://elixir-lang.org/getting-started/meta/macros.html" target="_blank" rel="noopener">Elixir Macro</a></li><li><a href="https://kaisery.gitbooks.io/rust-book-chinese/content/content/Macros%20å®.html" target="_blank" rel="noopener">Rust çš„å®</a></li><li><a href="https://juejin.im/post/5cebce946fb9a07ece67aec4" target="_blank" rel="noopener">iOSæ·±æ€ç¯‡ | å®å®šä¹‰</a></li><li><a href="https://medium.com/@fxn/how-does-elixir-compile-execute-code-c1b36c9ec8cf" target="_blank" rel="noopener">How does Elixir compile/execute code?</a></li><li><a href="https://segmentfault.com/a/1190000004104696" target="_blank" rel="noopener">è®©è¿™ä¸–ç•Œå†å¤šä¸€ä»½ GNU m4 æ•™ç¨‹ (1)</a></li><li><a href="https://segmentfault.com/a/1190000004050807" target="_blank" rel="noopener">å®è¯­è¨€ä¸ºä½•ä¸å—æ¬¢è¿</a></li><li><a href="https://github.com/babel/awesome-babel" target="_blank" rel="noopener">awesome-babel</a></li><li><a href="https://www.zhihu.com/question/19875500" target="_blank" rel="noopener">å„ç¼–ç¨‹è¯­è¨€å¯¹ã€Œå®ã€çš„æ”¯æŒæ˜¯æ€æ ·çš„ï¼Ÿ</a></li><li><a href="https://github.com/sweet-js/sweet-core/wiki/Macro-resources" target="_blank" rel="noopener">Sweetjs ç›¸å…³è®ºæ–‡</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ¥ç€ä¸Šç¯‡æ–‡ç« : &lt;a href=&quot;https://juejin.im/post/5d94bfbf5188256db95589be&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;ã€Šæ·±å…¥æµ…å‡º Babel ä¸Šç¯‡ï¼šæ¶æ„å’ŒåŸç† + å®æˆ˜ ğŸ”¥ã€‹&lt;/a&gt;&lt;/p&gt;
&lt;p
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://bobi.ink/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>æ·±å…¥æµ…å‡º Babel ä¸Šç¯‡ï¼šæ¶æ„å’ŒåŸç† + å®æˆ˜</title>
    <link href="https://bobi.ink/2019/10/01/babel/"/>
    <id>https://bobi.ink/2019/10/01/babel/</id>
    <published>2019-09-30T16:00:00.000Z</published>
    <updated>2019-10-21T09:32:14.278Z</updated>
    
    <content type="html"><![CDATA[<p>å›½åº†æ”¾å‡äº†ï¼Œæˆ‘è¿˜åœ¨åˆ©ç”¨ç¢ç‰‡æ—¶é—´åœ¨å†™æ–‡ç« ï¼Œä¸çŸ¥é“é•¿å‡è¿˜æœ‰æ²¡æœ‰äººçœ‹ï¼Œè¯•è¯•æ°´å§ï¼</p><p>è¿™ä¸ªæ–‡ç« ç³»åˆ—å°†å¸¦å¤§å®¶æ·±å…¥æµ…å‡º <a href="https://babeljs.io" target="_blank" rel="noopener"><code>Babel</code></a>, è¿™ä¸ªç³»åˆ—å°†åˆ†ä¸ºä¸Šä¸‹ä¸¤ç¯‡ï¼šä¸Šç¯‡ä¸»è¦ä»‹ç» Babel çš„æ¶æ„å’ŒåŸç†ï¼Œé¡ºä¾¿å®è·µä¸€ä¸‹æ’ä»¶å¼€å‘çš„ï¼›ä¸‹ç¯‡ä¼šä»‹ç» <a href="https://github.com/kentcdodds/babel-plugin-macros" target="_blank" rel="noopener">`babel-plugin-macros </a>, åˆ©ç”¨å®ƒæ¥å†™å±äº Javascript çš„â€™å®â€˜ï¼Œ</p><p>âœ¨æ»¡æ»¡çš„å¹²è´§ï¼Œä¸å®¹é”™è¿‡å“¦. å†™æ–‡ä¸æ˜“ï¼Œç‚¹èµæ˜¯æœ€å¤§çš„é¼“åŠ±ã€‚</p><blockquote><p>æ³¨æ„: æœ¬æ–‡ä¸æ˜¯ Babel çš„åŸºç¡€ä½¿ç”¨æ•™ç¨‹ï¼å¦‚æœä½ å¯¹ Babel å°šä¸äº†è§£ï¼Œè¯·æŸ¥çœ‹<a href="https://babeljs.io" target="_blank" rel="noopener">å®˜æ–¹ç½‘ç«™</a>, æˆ–è€…è¿™ä¸ª<a href="https://github.com/jamiebuilds/babel-handbook/blob/master/translations/zh-Hans/user-handbook.md" target="_blank" rel="noopener">ç”¨æˆ·æ‰‹å†Œ</a></p></blockquote><p><br></p><p><strong>æ–‡ç« å¤§çº²</strong></p><!-- TOC --><ul><li><a href="#babel-çš„å¤„ç†æµç¨‹">Babel çš„å¤„ç†æµç¨‹</a></li><li><a href="#babel-çš„æ¶æ„">Babel çš„æ¶æ„</a></li><li><a href="#è®¿é—®è€…æ¨¡å¼">è®¿é—®è€…æ¨¡å¼</a><ul><li><a href="#èŠ‚ç‚¹çš„éå†">èŠ‚ç‚¹çš„éå†</a></li><li><a href="#èŠ‚ç‚¹çš„ä¸Šä¸‹æ–‡">èŠ‚ç‚¹çš„ä¸Šä¸‹æ–‡</a></li><li><a href="#å‰¯ä½œç”¨çš„å¤„ç†">å‰¯ä½œç”¨çš„å¤„ç†</a></li><li><a href="#ä½œç”¨åŸŸçš„å¤„ç†">ä½œç”¨åŸŸçš„å¤„ç†</a></li></ul></li><li><a href="#æä¸€ä¸ªæ’ä»¶å‘—">æä¸€ä¸ªæ’ä»¶å‘—</a></li><li><a href="#æœ€å">æœ€å</a></li><li><a href="#æ‰©å±•">æ‰©å±•</a></li></ul><!-- /TOC --><p><br></p><h2 id="babel-çš„å¤„ç†æµç¨‹"><a href="#babel-çš„å¤„ç†æµç¨‹" class="headerlink" title="Babel çš„å¤„ç†æµç¨‹"></a>Babel çš„å¤„ç†æµç¨‹</h2><p><img src="/images/babel/process.png" alt><br><i>Babel çš„å¤„ç†æµç¨‹</i></p><p><br></p><p>ä¸Šå›¾æ˜¯ Babel çš„å¤„ç†æµç¨‹, å¦‚æœè¯»è€…å­¦ä¹ è¿‡<code>ç¼–è¯‘å™¨åŸç†</code>ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±ç›¸å½“äº²åˆ‡äº†.</p><p>é¦–å…ˆä»æºç  <code>è§£æ(Parsing)</code> å¼€å§‹ï¼Œè§£æåŒ…å«äº†ä¸¤ä¸ªæ­¥éª¤:</p><p><strong>1ï¸âƒ£è¯æ³•è§£æ(Lexical Analysis)</strong>ï¼š <code>è¯æ³•è§£æå™¨(Tokenizer)</code>åœ¨è¿™ä¸ªé˜¶æ®µå°†å­—ç¬¦ä¸²å½¢å¼çš„ä»£ç è½¬æ¢ä¸º<code>Tokens(ä»¤ç‰Œ)</code>. Tokens å¯ä»¥è§†ä½œæ˜¯ä¸€äº›è¯­æ³•ç‰‡æ®µç»„æˆçš„æ•°ç»„. ä¾‹å¦‚<code>for (const item of items) {}</code> è¯æ³•è§£æåçš„ç»“æœå¦‚ä¸‹:</p><p><img src="/images/babel/tokens.png" alt></p><p>ä»ä¸Šå›¾å¯ä»¥çœ‹ï¼Œæ¯ä¸ª Token ä¸­åŒ…å«äº†è¯­æ³•ç‰‡æ®µã€ä½ç½®ä¿¡æ¯ã€ä»¥åŠä¸€äº›ç±»å‹ä¿¡æ¯. è¿™äº›ä¿¡æ¯æœ‰åŠ©äºåç»­çš„è¯­æ³•åˆ†æã€‚</p><p><br></p><p><strong>2ï¸âƒ£è¯­æ³•è§£æ(Syntactic Analysis)</strong>ï¼šè¿™ä¸ªé˜¶æ®µè¯­æ³•<code>è§£æå™¨(Parser)</code>ä¼šæŠŠ<code>Tokens</code>è½¬æ¢ä¸º<code>æŠ½è±¡è¯­æ³•æ ‘(Abstract Syntax Treeï¼ŒAST)</code></p><p><strong>ä»€ä¹ˆæ˜¯AST</strong>?</p><p>å®ƒå°±æ˜¯ä¸€æ£µâ€™å¯¹è±¡æ ‘â€™ï¼Œç”¨æ¥è¡¨ç¤ºä»£ç çš„è¯­æ³•ç»“æ„ï¼Œä¾‹å¦‚<code>console.log(&#39;hello world&#39;)</code>ä¼šè§£ææˆä¸º:</p><p><img src="/images/babel/ast.png" alt></p><p><code>Program</code>ã€<code>CallExpression</code>ã€<code>Identifier</code> <strong>è¿™äº›éƒ½æ˜¯èŠ‚ç‚¹çš„ç±»å‹ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¸€ä¸ªæœ‰æ„ä¹‰çš„è¯­æ³•å•å…ƒ</strong>ã€‚ è¿™äº›èŠ‚ç‚¹ç±»å‹å®šä¹‰äº†ä¸€äº›å±æ€§æ¥æè¿°èŠ‚ç‚¹çš„ä¿¡æ¯ã€‚</p><p>JavaScriptçš„è¯­æ³•è¶Šæ¥è¶Šå¤æ‚ï¼Œè€Œä¸” Babel é™¤äº†æ”¯æŒæœ€æ–°çš„JavaScriptè§„èŒƒè¯­æ³•, è¿˜æ”¯æŒ <code>JSX</code>ã€<code>Flow</code>ã€ç°åœ¨è¿˜æœ‰<code>Typescript</code>ã€‚æƒ³è±¡ä¸€ä¸‹ AST çš„èŠ‚ç‚¹ç±»å‹æœ‰å¤šå°‘ï¼Œå…¶å®æˆ‘ä»¬ä¸éœ€è¦å»è®°ä½è¿™ä¹ˆå¤šç±»å‹ã€ä¹Ÿè®°ä¸ä½. <strong>æ’ä»¶å¼€å‘è€…ä¼šåˆ©ç”¨ <a href="https://astexplorer.net" target="_blank" rel="noopener"><code>ASTExplorer</code></a> æ¥å®¡æŸ¥è§£æåçš„ASTæ ‘</strong>, éå¸¸å¼ºå¤§ğŸ‘ã€‚</p><p><strong>AST æ˜¯ Babel è½¬è¯‘çš„æ ¸å¿ƒæ•°æ®ç»“æ„ï¼Œåç»­çš„æ“ä½œéƒ½ä¾èµ–äº AST</strong>ã€‚</p><p><br></p><p>æ¥ç€å°±æ˜¯<strong>è½¬æ¢(Transform)</strong>äº†ï¼Œè½¬æ¢é˜¶æ®µä¼šå¯¹ AST è¿›è¡Œéå†ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å¯¹èŠ‚ç‚¹è¿›è¡Œå¢åˆ æŸ¥æ”¹ã€‚Babel æ‰€æœ‰æ’ä»¶éƒ½æ˜¯åœ¨è¿™ä¸ªé˜¶æ®µå·¥ä½œ, æ¯”å¦‚è¯­æ³•è½¬æ¢ã€ä»£ç å‹ç¼©ã€‚</p><p><br></p><p><strong>Javascript In Javascript Out</strong>, æœ€åé˜¶æ®µè¿˜æ˜¯è¦æŠŠ AST è½¬æ¢å›å­—ç¬¦ä¸²å½¢å¼çš„Javascriptï¼ŒåŒæ—¶è¿™ä¸ªé˜¶æ®µè¿˜ä¼šç”ŸæˆSource Mapã€‚</p><p><br><br><br></p><h2 id="babel-çš„æ¶æ„"><a href="#babel-çš„æ¶æ„" class="headerlink" title="Babel çš„æ¶æ„"></a>Babel çš„æ¶æ„</h2><p>æˆ‘åœ¨<a href="https://juejin.im/post/5d7ffad551882545ff173083" target="_blank" rel="noopener">ã€Šé€è¿‡ç°è±¡çœ‹æœ¬è´¨: å¸¸è§çš„å‰ç«¯æ¶æ„é£æ ¼å’Œæ¡ˆä¾‹ğŸ”¥ã€‹</a> æåŠ <code>Babel</code> å’Œ <code>Webpack</code> ä¸ºäº†é€‚åº”å¤æ‚çš„å®šåˆ¶éœ€æ±‚å’Œé¢‘ç¹çš„åŠŸèƒ½å˜åŒ–ï¼Œéƒ½ä½¿ç”¨äº†<a href="https://juejin.im/post/5d7ffad551882545ff173083#heading-10" target="_blank" rel="noopener">å¾®å†…æ ¸</a> çš„æ¶æ„é£æ ¼ã€‚<strong>ä¹Ÿå°±æ˜¯è¯´å®ƒä»¬çš„æ ¸å¿ƒéå¸¸å°ï¼Œå¤§éƒ¨åˆ†åŠŸèƒ½éƒ½æ˜¯é€šè¿‡æ’ä»¶æ‰©å±•å®ç°çš„</strong>ã€‚</p><p><br></p><p>æ‰€ä»¥ç®€å•åœ°äº†è§£ä¸€ä¸‹ Babel çš„æ¶æ„å’Œä¸€äº›åŸºæœ¬æ¦‚å¿µï¼Œå¯¹åç»­æ–‡ç« å†…å®¹çš„ç†è§£, ä»¥åŠBabelçš„ä½¿ç”¨è¿˜æ˜¯æœ‰å¸®åŠ©çš„ã€‚</p><p><strong>ä¸€å›¾èƒœåƒè¨€</strong>ã€‚ä»”ç»†è¯»è¿‡æˆ‘æ–‡ç« çš„æœ‹å‹ä¼šå‘ç°ï¼Œæˆ‘çš„é£æ ¼å°±æ˜¯èƒ½ç”¨å›¾ç‰‡è¯´æ˜çš„å°±ä¸ç”¨æ–‡å­—ã€èƒ½ç”¨æ–‡å­—çš„å°±ä¸ç”¨ä»£ç ã€‚<strong>è™½ç„¶æˆ‘çš„åŸåˆ›æ–‡ç« ç¯‡å¹…éƒ½å¾ˆé•¿ï¼Œå›¾ç‰‡è¿˜æ˜¯å€¼å¾—çœ‹çœ‹çš„</strong>ã€‚</p><p><img src="/images/babel/arch.png" alt></p><p><br></p><p>Babel æ˜¯ä¸€ä¸ª <a href="https://github.com/lerna/lerna" target="_blank" rel="noopener"><code>MonoRepo</code></a> é¡¹ç›®ï¼Œ ä¸è¿‡ç»„ç»‡éå¸¸æ¸…æ™°ï¼Œä¸‹é¢å°±æºç ä¸Šæˆ‘ä»¬èƒ½çœ‹åˆ°çš„æ¨¡å—è¿›è¡Œä¸€ä¸‹åˆ†ç±»ï¼Œ é…åˆä¸Šé¢çš„æ¶æ„å›¾è®©ä½ å¯¹Babelæœ‰ä¸ªå¤§æ¦‚çš„è®¤è¯†:</p><p><br></p><p><strong>1ï¸âƒ£ æ ¸å¿ƒ</strong>:</p><p><code>@babel/core</code> è¿™ä¹Ÿæ˜¯ä¸Šé¢è¯´çš„â€˜å¾®å†…æ ¸â€™æ¶æ„ä¸­çš„â€˜å†…æ ¸â€™ã€‚å¯¹äºBabelæ¥è¯´ï¼Œè¿™ä¸ªå†…æ ¸ä¸»è¦å¹²è¿™äº›äº‹æƒ…ï¼š</p><ul><li>åŠ è½½å’Œå¤„ç†é…ç½®(config)</li><li>åŠ è½½æ’ä»¶</li><li>è°ƒç”¨ <code>Parser</code> è¿›è¡Œè¯­æ³•è§£æï¼Œç”Ÿæˆ <code>AST</code></li><li>è°ƒç”¨ <code>Traverser</code> éå†ASTï¼Œå¹¶ä½¿ç”¨<code>è®¿é—®è€…æ¨¡å¼</code>åº”ç”¨â€™æ’ä»¶â€™å¯¹ AST è¿›è¡Œè½¬æ¢</li><li>ç”Ÿæˆä»£ç ï¼ŒåŒ…æ‹¬SourceMapè½¬æ¢å’Œæºä»£ç ç”Ÿæˆ</li></ul><p><br></p><p><strong>2ï¸âƒ£ æ ¸å¿ƒå‘¨è¾¹æ”¯æ’‘</strong></p><ul><li><p><strong>Parser(<code>@babel/parser</code>)</strong>ï¼š å°†æºä»£ç è§£æä¸º AST å°±é å®ƒäº†ã€‚ å®ƒå·²ç»å†…ç½®æ”¯æŒå¾ˆå¤šè¯­æ³•. ä¾‹å¦‚ JSXã€Typescriptã€Flowã€ä»¥åŠæœ€æ–°çš„ECMAScriptè§„èŒƒã€‚ç›®å‰ä¸ºäº†æ‰§è¡Œæ•ˆç‡ï¼Œparseræ˜¯<a href="https://babeljs.io/docs/en/babel-parser#faq" target="_blank" rel="noopener">ä¸æ”¯æŒæ‰©å±•çš„</a>ï¼Œç”±å®˜æ–¹è¿›è¡Œç»´æŠ¤ã€‚å¦‚æœä½ è¦æ”¯æŒè‡ªå®šä¹‰è¯­æ³•ï¼Œå¯ä»¥ fork å®ƒï¼Œä¸è¿‡è¿™ç§åœºæ™¯éå¸¸å°‘ã€‚</p></li><li><p><strong>Traverser(<code>@babel/traverse</code>)</strong>ï¼š  å®ç°äº†<code>è®¿é—®è€…æ¨¡å¼</code>ï¼Œå¯¹ AST è¿›è¡Œéå†ï¼Œ<code>è½¬æ¢æ’ä»¶</code>ä¼šé€šè¿‡å®ƒè·å–æ„Ÿå…´è¶£çš„ASTèŠ‚ç‚¹ï¼Œå¯¹èŠ‚ç‚¹ç»§ç»­æ“ä½œ, ä¸‹æ–‡ä¼šè¯¦ç»†ä»‹ç»<code>è®¿é—®å™¨æ¨¡å¼</code>ã€‚</p></li><li><p><strong>Generator(<code>@babel/generator</code>)</strong>ï¼š å°† AST è½¬æ¢ä¸ºæºä»£ç ï¼Œæ”¯æŒ SourceMap</p></li></ul><p><br></p><p><strong>3ï¸âƒ£ æ’ä»¶</strong></p><p>æ‰“å¼€ Babel çš„æºä»£ç ï¼Œä¼šå‘ç°æœ‰å¥½å‡ ç§ç±»å‹çš„â€˜æ’ä»¶â€™ã€‚</p><ul><li><p><strong>è¯­æ³•æ’ä»¶(<code>@babel/plugin-syntax-*</code>)</strong>ï¼šä¸Šé¢è¯´äº† <code>@babel/parser</code> å·²ç»æ”¯æŒäº†å¾ˆå¤š JavaScript è¯­æ³•ç‰¹æ€§ï¼ŒParserä¹Ÿä¸æ”¯æŒæ‰©å±•. <strong>å› æ­¤<code>plugin-syntax-*</code>å®é™…ä¸Šåªæ˜¯ç”¨äºå¼€å¯æˆ–è€…é…ç½®Parserçš„æŸä¸ªåŠŸèƒ½ç‰¹æ€§</strong>ã€‚</p><p>ä¸€èˆ¬ç”¨æˆ·ä¸éœ€è¦å…³å¿ƒè¿™ä¸ªï¼ŒTransform æ’ä»¶é‡Œé¢å·²ç»åŒ…å«äº†ç›¸å…³çš„<code>plugin-syntax-*</code>æ’ä»¶äº†ã€‚ç”¨æˆ·ä¹Ÿå¯ä»¥é€šè¿‡<a href="https://babeljs.io/docs/en/options#parseropts" target="_blank" rel="noopener"><code>parserOpts</code></a>é…ç½®é¡¹æ¥ç›´æ¥é…ç½® Parser</p></li><li><p><strong>è½¬æ¢æ’ä»¶</strong>ï¼š ç”¨äºå¯¹ AST è¿›è¡Œè½¬æ¢, å®ç°è½¬æ¢ä¸ºES5ä»£ç ã€å‹ç¼©ã€åŠŸèƒ½å¢å¼ºç­‰ç›®çš„. Babelä»“åº“å°†è½¬æ¢æ’ä»¶åˆ’åˆ†ä¸ºä¸¤ç§(åªæ˜¯å‘½åä¸Šçš„åŒºåˆ«)ï¼š</p><ul><li><code>@babel/plugin-transform-*</code>ï¼š æ™®é€šçš„è½¬æ¢æ’ä»¶</li><li><code>@babel/plugin-proposal-*</code>ï¼š è¿˜åœ¨â€™æè®®é˜¶æ®µâ€™(éæ­£å¼)çš„è¯­è¨€ç‰¹æ€§, ç›®å‰æœ‰<a href="https://babeljs.io/docs/en/next/plugins#experimental" target="_blank" rel="noopener">è¿™äº›</a></li></ul></li><li><p><strong>é¢„å®šä¹‰é›†åˆ(<code>@babel/presets-*</code>)</strong>ï¼š æ’ä»¶é›†åˆæˆ–è€…åˆ†ç»„ï¼Œä¸»è¦æ–¹ä¾¿ç”¨æˆ·å¯¹æ’ä»¶è¿›è¡Œç®¡ç†å’Œä½¿ç”¨ã€‚æ¯”å¦‚<code>preset-env</code>å«æ‹¬æ‰€æœ‰çš„æ ‡å‡†çš„æœ€æ–°ç‰¹æ€§; å†æ¯”å¦‚<code>preset-react</code>å«æ‹¬æ‰€æœ‰reactç›¸å…³çš„æ’ä»¶.</p></li></ul><p><br></p><p><strong>4ï¸âƒ£ æ’ä»¶å¼€å‘è¾…åŠ©</strong></p><ul><li><p><code>@babel/template</code>ï¼š æŸäº›åœºæ™¯ç›´æ¥æ“ä½œASTå¤ªéº»çƒ¦ï¼Œå°±æ¯”å¦‚æˆ‘ä»¬ç›´æ¥æ“ä½œDOMä¸€æ ·ï¼Œæ‰€ä»¥Babelå®ç°äº†è¿™ä¹ˆä¸€ä¸ªç®€å•çš„æ¨¡æ¿å¼•æ“ï¼Œå¯ä»¥å°†å­—ç¬¦ä¸²ä»£ç è½¬æ¢ä¸ºASTã€‚æ¯”å¦‚åœ¨ç”Ÿæˆä¸€äº›è¾…åŠ©ä»£ç (helper)æ—¶ä¼šç”¨åˆ°è¿™ä¸ªåº“</p></li><li><p><code>@babel/types</code>ï¼š AST èŠ‚ç‚¹æ„é€ å™¨å’Œæ–­è¨€. æ’ä»¶å¼€å‘æ—¶ä½¿ç”¨å¾ˆé¢‘ç¹</p></li><li><p><code>@babel/helper-*</code>ï¼š ä¸€äº›è¾…åŠ©å™¨ï¼Œç”¨äºè¾…åŠ©æ’ä»¶å¼€å‘ï¼Œä¾‹å¦‚ç®€åŒ–ASTæ“ä½œ</p></li><li><p><code>@babel/helper</code>ï¼š è¾…åŠ©ä»£ç ï¼Œå•çº¯çš„è¯­æ³•è½¬æ¢å¯èƒ½æ— æ³•è®©ä»£ç è¿è¡Œèµ·æ¥ï¼Œæ¯”å¦‚ä½ç‰ˆæœ¬æµè§ˆå™¨æ— æ³•è¯†åˆ«classå…³é”®å­—ï¼Œè¿™æ—¶å€™éœ€è¦æ·»åŠ è¾…åŠ©ä»£ç ï¼Œå¯¹classè¿›è¡Œæ¨¡æ‹Ÿã€‚</p></li></ul><p><br></p><p><strong>5ï¸âƒ£ å·¥å…·</strong></p><ul><li><p><code>@babel/node</code>ï¼š Node.js CLI, é€šè¿‡å®ƒç›´æ¥è¿è¡Œéœ€è¦ Babel å¤„ç†çš„JavaScriptæ–‡ä»¶</p></li><li><p><code>@babel/register</code>ï¼š Patch NodeJs çš„requireæ–¹æ³•ï¼Œæ”¯æŒå¯¼å…¥éœ€è¦Babelå¤„ç†çš„JavaScriptæ¨¡å—</p></li><li><p><code>@babel/cli</code>ï¼š CLIå·¥å…·</p></li></ul><p><br><br><br></p><h2 id="è®¿é—®è€…æ¨¡å¼"><a href="#è®¿é—®è€…æ¨¡å¼" class="headerlink" title="è®¿é—®è€…æ¨¡å¼"></a>è®¿é—®è€…æ¨¡å¼</h2><p>è½¬æ¢å™¨ä¼šéå† AST æ ‘ï¼Œæ‰¾å‡ºè‡ªå·±æ„Ÿå…´è¶£çš„èŠ‚ç‚¹ç±»å‹, å†è¿›è¡Œè½¬æ¢æ“ä½œ. è¿™ä¸ªè¿‡ç¨‹å’Œæˆ‘ä»¬æ“ä½œ<code>DOM</code>æ ‘å·®ä¸å¤šï¼Œåªä¸è¿‡ç›®çš„ä¸å¤ªä¸€æ ·ã€‚AST éå†å’Œè½¬æ¢ä¸€èˆ¬ä¼šä½¿ç”¨<a href="https://www.jianshu.com/p/1f1049d0a0f4" target="_blank" rel="noopener"><code>è®¿é—®è€…æ¨¡å¼</code></a>ã€‚</p><p>æƒ³è±¡ä¸€ä¸‹ï¼ŒBabel æœ‰é‚£ä¹ˆå¤šæ’ä»¶ï¼Œå¦‚æœæ¯ä¸ªæ’ä»¶è‡ªå·±å»éå†ASTï¼Œå¯¹ä¸åŒçš„èŠ‚ç‚¹è¿›è¡Œä¸åŒçš„æ“ä½œï¼Œç»´æŠ¤è‡ªå·±çš„çŠ¶æ€ã€‚è¿™æ ·å­ä¸ä»…ä½æ•ˆï¼Œå®ƒä»¬çš„é€»è¾‘åˆ†æ•£åœ¨å„å¤„ï¼Œä¼šè®©æ•´ä¸ªç³»ç»Ÿå˜å¾—éš¾ä»¥ç†è§£å’Œè°ƒè¯•ï¼Œ æœ€åæ’ä»¶ä¹‹é—´å…³ç³»å°±çº ç¼ ä¸æ¸…ï¼Œä¹±æˆä¸€é”…ç²¥ã€‚</p><p><strong>æ‰€ä»¥è½¬æ¢å™¨æ“ä½œ AST ä¸€èˆ¬éƒ½æ˜¯ä½¿ç”¨<code>è®¿é—®å™¨æ¨¡å¼</code>ï¼Œç”±è¿™ä¸ª<code>è®¿é—®è€…(Visitor)</code>æ¥ â‘  è¿›è¡Œç»Ÿä¸€çš„éå†æ“ä½œï¼Œâ‘¡ æä¾›èŠ‚ç‚¹çš„æ“ä½œæ–¹æ³•ï¼Œâ‘¢ å“åº”å¼ç»´æŠ¤èŠ‚ç‚¹ä¹‹é—´çš„å…³ç³»ï¼›è€Œæ’ä»¶(è®¾è®¡æ¨¡å¼ä¸­ç§°ä¸ºâ€˜å…·ä½“è®¿é—®è€…â€™)åªéœ€è¦å®šä¹‰è‡ªå·±æ„Ÿå…´è¶£çš„èŠ‚ç‚¹ç±»å‹ï¼Œå½“è®¿é—®è€…è®¿é—®åˆ°å¯¹åº”èŠ‚ç‚¹æ—¶ï¼Œå°±è°ƒç”¨æ’ä»¶çš„è®¿é—®(visit)æ–¹æ³•</strong>ã€‚</p><p><br></p><h3 id="èŠ‚ç‚¹çš„éå†"><a href="#èŠ‚ç‚¹çš„éå†" class="headerlink" title="èŠ‚ç‚¹çš„éå†"></a>èŠ‚ç‚¹çš„éå†</h3><p>å‡è®¾æˆ‘ä»¬çš„ä»£ç å¦‚ä¸‹:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hello</span>(<span class="params">v</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'hello'</span> + v + <span class="string">'!'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>è§£æåçš„ AST ç»“æ„å¦‚ä¸‹:</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">File</span><br><span class="line">  Program (program)</span><br><span class="line">    FunctionDeclaration (body)</span><br><span class="line">      Identifier (id)  #hello</span><br><span class="line">      Identifier (params[0]) #v</span><br><span class="line">      BlockStatement (body)</span><br><span class="line">        ExpressionStatement ([0])</span><br><span class="line">          CallExpression (expression)</span><br><span class="line">            MemberExpression (callee)  #console.log</span><br><span class="line">              Identifier (object)  #console</span><br><span class="line">              Identifier (property)  #log</span><br><span class="line">            BinaryExpression (arguments[0])</span><br><span class="line">              BinaryExpression (left)</span><br><span class="line">                StringLiteral (left)  #'hello'</span><br><span class="line">                Identifier (right)  #v</span><br><span class="line">              StringLiteral (right)  #'!'</span><br></pre></td></tr></table></figure><p><br></p><p>è®¿é—®è€…ä¼šä»¥<code>æ·±åº¦ä¼˜å…ˆ</code>çš„é¡ºåº, æˆ–è€…è¯´é€’å½’åœ°å¯¹ AST è¿›è¡Œéå†ï¼Œå…¶è°ƒç”¨é¡ºåºå¦‚ä¸‹å›¾æ‰€ç¤º:</p><p><img src="/images/babel/traveser.png" alt></p><p><br></p><p>ä¸Šå›¾ä¸­<code>ç»¿çº¿</code>è¡¨ç¤ºè¿›å…¥è¯¥èŠ‚ç‚¹ï¼Œ<code>çº¢çº¿</code>è¡¨ç¤ºç¦»å¼€è¯¥èŠ‚ç‚¹ã€‚ä¸‹é¢å†™ä¸€ä¸ªè¶…ç®€å•çš„â€™å…·ä½“è®¿é—®è€…â€™æ¥è¿˜åŸä¸Šé¢çš„éå†è¿‡ç¨‹:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> babel = <span class="built_in">require</span>(<span class="string">'@babel/core'</span>)</span><br><span class="line"><span class="keyword">const</span> traverse = <span class="built_in">require</span>(<span class="string">'@babel/traverse'</span>).default</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ast = babel.parseSync(code)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> depth = <span class="number">0</span></span><br><span class="line">traverse(ast, &#123;</span><br><span class="line">  enter(path) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`enter <span class="subst">$&#123;path.type&#125;</span>(<span class="subst">$&#123;path.key&#125;</span>)`</span>)</span><br><span class="line">    depth++</span><br><span class="line">  &#125;,</span><br><span class="line">  exit(path) &#123;</span><br><span class="line">    depth--</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`  exit <span class="subst">$&#123;path.type&#125;</span>(<span class="subst">$&#123;path.key&#125;</span>)`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><details><br><summary> æŸ¥çœ‹ä»£ç æ‰§è¡Œç»“æœ </summary><br><br><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">enter Program(program)</span><br><span class="line">  enter FunctionDeclaration(0)</span><br><span class="line">    enter Identifier(id)</span><br><span class="line">    exit Identifier(id)</span><br><span class="line">    enter Identifier(0)</span><br><span class="line">    exit Identifier(0)</span><br><span class="line">    enter BlockStatement(body)</span><br><span class="line">      enter ExpressionStatement(0)</span><br><span class="line">        enter CallExpression(expression)</span><br><span class="line">          enter MemberExpression(callee)</span><br><span class="line">            enter Identifier(object)</span><br><span class="line">            exit Identifier(object)</span><br><span class="line">            enter Identifier(property)</span><br><span class="line">            exit Identifier(property)</span><br><span class="line">          exit MemberExpression(callee)</span><br><span class="line">          enter BinaryExpression(0)</span><br><span class="line">            enter BinaryExpression(left)</span><br><span class="line">              enter StringLiteral(left)</span><br><span class="line">              exit StringLiteral(left)</span><br><span class="line">              enter Identifier(right)</span><br><span class="line">              exit Identifier(right)</span><br><span class="line">            exit BinaryExpression(left)</span><br><span class="line">            enter StringLiteral(right)</span><br><span class="line">            exit StringLiteral(right)</span><br><span class="line">          exit BinaryExpression(0)</span><br><span class="line">        exit CallExpression(expression)</span><br><span class="line">      exit ExpressionStatement(0)</span><br><span class="line">    exit BlockStatement(body)</span><br><span class="line">  exit FunctionDeclaration(0)</span><br><span class="line">exit Program(program)</span><br></pre></td></tr></table></figure><br><br></details><p><br></p><p>å½“è®¿é—®è€…è¿›å…¥ä¸€ä¸ªèŠ‚ç‚¹æ—¶å°±ä¼šè°ƒç”¨ <code>enter(è¿›å…¥)</code> æ–¹æ³•ï¼Œåä¹‹ç¦»å¼€è¯¥èŠ‚ç‚¹æ—¶ä¼šè°ƒç”¨ <code>exit(ç¦»å¼€)</code> æ–¹æ³•ã€‚ ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ’ä»¶ä¸ä¼šç›´æ¥ä½¿ç”¨<code>enter</code>æ–¹æ³•ï¼Œåªä¼šå…³æ³¨å°‘æ•°å‡ ä¸ªèŠ‚ç‚¹ç±»å‹ï¼Œæ‰€ä»¥å…·ä½“è®¿é—®è€…ä¹Ÿå¯ä»¥è¿™æ ·å£°æ˜è®¿é—®æ–¹æ³•:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">traverse(ast, &#123;</span><br><span class="line">  <span class="comment">// è®¿é—®æ ‡è¯†ç¬¦</span></span><br><span class="line">  Identifier(path) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`enter Identifier`</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// è®¿é—®è°ƒç”¨è¡¨è¾¾å¼</span></span><br><span class="line">  CallExpression(path) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`enter CallExpression`</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// ä¸Šé¢æ˜¯enterçš„ç®€å†™ï¼Œå¦‚æœè¦å¤„ç†exitï¼Œä¹Ÿå¯ä»¥è¿™æ ·</span></span><br><span class="line">  <span class="comment">// äºŒå…ƒæ“ä½œç¬¦</span></span><br><span class="line">  BinaryExpression: &#123;</span><br><span class="line">    enter(path) &#123;&#125;,</span><br><span class="line">    exit(path) &#123;&#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// æ›´é«˜çº§çš„, ä½¿ç”¨åŒä¸€ä¸ªæ–¹æ³•è®¿é—®å¤šç§ç±»å‹çš„èŠ‚ç‚¹</span></span><br><span class="line">  <span class="string">"ExportNamedDeclaration|Flow"</span>(path) &#123;&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><br></p><p><strong>é‚£ä¹ˆ Babel æ’ä»¶æ˜¯æ€ä¹ˆè¢«åº”ç”¨çš„å‘¢ï¼Ÿ</strong></p><p>Babel ä¼šæŒ‰ç…§æ’ä»¶å®šä¹‰çš„é¡ºåºæ¥åº”ç”¨è®¿é—®æ–¹æ³•ï¼Œæ¯”å¦‚ä½ æ³¨å†Œäº†å¤šä¸ªæ’ä»¶ï¼Œbabel-core æœ€åä¼ é€’ç»™è®¿é—®å™¨çš„æ•°æ®ç»“æ„å¤§æ¦‚é•¿è¿™æ ·ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  Identifier: &#123;</span><br><span class="line">    enter: [plugin-xx, plugin-yy,] <span class="comment">// æ•°ç»„å½¢å¼</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>å½“è¿›å…¥ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼Œè¿™äº›æ’ä»¶ä¼šæŒ‰ç…§æ³¨å†Œçš„é¡ºåºè¢«æ‰§è¡Œã€‚å¤§éƒ¨åˆ†æ’ä»¶æ˜¯ä¸éœ€è¦å¼€å‘è€…å…³å¿ƒå®šä¹‰çš„é¡ºåºçš„ï¼Œæœ‰å°‘æ•°çš„æƒ…å†µéœ€è¦ç¨å¾®æ³¨æ„ä»¥ä¸‹ï¼Œä¾‹å¦‚<code>plugin-proposal-decorators</code>:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"plugins"</span>: [</span><br><span class="line">    <span class="string">"@babel/plugin-proposal-decorators"</span>,     <span class="comment">// å¿…é¡»åœ¨plugin-proposal-class-propertiesä¹‹å‰</span></span><br><span class="line">    <span class="string">"@babel/plugin-proposal-class-properties"</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>æ‰€æœ‰æ’ä»¶å®šä¹‰çš„é¡ºåºï¼ŒæŒ‰ç…§æƒ¯ä¾‹ï¼Œåº”è¯¥æ˜¯æ–°çš„æˆ–è€…è¯´å®éªŒæ€§çš„æ’ä»¶åœ¨å‰é¢ï¼Œè€çš„æ’ä»¶å®šä¹‰åœ¨åé¢ã€‚å› ä¸ºå¯èƒ½éœ€è¦æ–°çš„æ’ä»¶å°† AST è½¬æ¢åï¼Œè€çš„æ’ä»¶æ‰èƒ½è¯†åˆ«è¯­æ³•ï¼ˆå‘åå…¼å®¹ï¼‰ã€‚ä¸‹é¢æ˜¯å®˜æ–¹é…ç½®ä¾‹å­, ä¸ºäº†ç¡®ä¿å…ˆåå…¼å®¹ï¼Œ<code>stage-*</code>é˜¶æ®µçš„æ’ä»¶å…ˆæ‰§è¡Œ:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"presets"</span>: [<span class="string">"es2015"</span>, <span class="string">"react"</span>, <span class="string">"stage-2"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æ³¨æ„Presetçš„æ‰§è¡Œé¡ºåºç›¸åï¼Œè¯¦è§å®˜æ–¹<a href="https://babeljs.io/docs/en/next/plugins#plugin-ordering" target="_blank" rel="noopener">æ–‡æ¡£</a></p></blockquote><p><br></p><h3 id="èŠ‚ç‚¹çš„ä¸Šä¸‹æ–‡"><a href="#èŠ‚ç‚¹çš„ä¸Šä¸‹æ–‡" class="headerlink" title="èŠ‚ç‚¹çš„ä¸Šä¸‹æ–‡"></a>èŠ‚ç‚¹çš„ä¸Šä¸‹æ–‡</h3><p>è®¿é—®è€…åœ¨è®¿é—®ä¸€ä¸ªèŠ‚ç‚¹æ—¶, ä¼šæ— å·®åˆ«åœ°è°ƒç”¨ <code>enter</code> æ–¹æ³•ï¼Œæˆ‘ä»¬æ€ä¹ˆçŸ¥é“è¿™ä¸ªèŠ‚ç‚¹åœ¨ä»€ä¹ˆä½ç½®ä»¥åŠå’Œå…¶ä»–èŠ‚ç‚¹çš„å…³è”å…³ç³»å‘¢ï¼Ÿ</p><p>é€šè¿‡ä¸Šé¢çš„ä»£ç ï¼Œè¯»è€…åº”è¯¥å¯ä»¥çŒœå‡ºå‡ åˆ†ï¼Œæ¯ä¸ª<code>visit</code>æ–¹æ³•éƒ½æ¥æ”¶ä¸€ä¸ª <code>Path</code> å¯¹è±¡, ä½ å¯ä»¥å°†å®ƒå½“åšä¸€ä¸ªâ€˜ä¸Šä¸‹æ–‡â€™å¯¹è±¡ï¼Œç±»ä¼¼äº<code>JQuery</code>çš„ <code>JQuery</code>(<code>const $el = $(&#39;.el&#39;)</code>) å¯¹è±¡ï¼Œè¿™é‡Œé¢åŒ…å«äº†å¾ˆå¤šä¿¡æ¯ï¼š</p><ul><li>å½“å‰èŠ‚ç‚¹ä¿¡æ¯</li><li>èŠ‚ç‚¹çš„å…³è”ä¿¡æ¯ã€‚çˆ¶èŠ‚ç‚¹ã€å­èŠ‚ç‚¹ã€å…„å¼ŸèŠ‚ç‚¹ç­‰ç­‰</li><li>ä½œç”¨åŸŸä¿¡æ¯</li><li>ä¸Šä¸‹æ–‡ä¿¡æ¯</li><li>èŠ‚ç‚¹æ“ä½œæ–¹æ³•ã€‚èŠ‚ç‚¹å¢åˆ æŸ¥æ”¹</li><li>æ–­è¨€æ–¹æ³•ã€‚isXXX, assertXXX</li></ul><p>ä¸‹é¢æ˜¯å®ƒçš„ä¸»è¦ç»“æ„:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">NodePath</span>&lt;<span class="title">T</span> </span>= Node&gt; &#123;</span><br><span class="line">    <span class="keyword">constructor</span>(hub: Hub, parent: Node);</span><br><span class="line">    parent: Node;</span><br><span class="line">    hub: Hub;</span><br><span class="line">    contexts: TraversalContext[];</span><br><span class="line">    data: object;</span><br><span class="line">    shouldSkip: boolean;</span><br><span class="line">    shouldStop: boolean;</span><br><span class="line">    removed: boolean;</span><br><span class="line">    state: any;</span><br><span class="line">    opts: object;</span><br><span class="line">    skipKeys: object;</span><br><span class="line">    parentPath: NodePath;</span><br><span class="line">    context: TraversalContext;</span><br><span class="line">    container: object | object[];</span><br><span class="line">    listKey: string; // å¦‚æœèŠ‚ç‚¹åœ¨ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œè¿™ä¸ªå°±æ˜¯èŠ‚ç‚¹æ•°ç»„çš„é”®</span><br><span class="line">    inList: boolean;</span><br><span class="line">    parentKey: string;</span><br><span class="line">    key: string | number; // èŠ‚ç‚¹æ‰€åœ¨çš„é”®æˆ–ç´¢å¼•</span><br><span class="line">    node: T;  // ğŸ”´ å½“å‰èŠ‚ç‚¹</span><br><span class="line">    scope: Scope; // ğŸ”´å½“å‰èŠ‚ç‚¹æ‰€åœ¨çš„ä½œç”¨åŸŸ</span><br><span class="line">    type: T extends undefined | null ? string | null : string; // ğŸ”´èŠ‚ç‚¹ç±»å‹</span><br><span class="line">    typeAnnotation: object;</span><br><span class="line">    // ... è¿˜æœ‰å¾ˆå¤šæ–¹æ³•ï¼Œå®ç°å¢åˆ æŸ¥æ”¹</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½ å¯ä»¥é€šè¿‡è¿™ä¸ª<a href="https://github.com/jamiebuilds/babel-handbook/blob/master/translations/zh-Hans/plugin-handbook.md#toc-visitors" target="_blank" rel="noopener">æ‰‹å†Œ</a>æ¥å­¦ä¹ æ€ä¹ˆé€šè¿‡ Path æ¥è½¬æ¢ AST. åé¢ä¹Ÿä¼šæœ‰ä»£ç ç¤ºä¾‹ï¼Œè¿™é‡Œå°±ä¸å±•å¼€ç»†èŠ‚äº†</p><p><br></p><h3 id="å‰¯ä½œç”¨çš„å¤„ç†"><a href="#å‰¯ä½œç”¨çš„å¤„ç†" class="headerlink" title="å‰¯ä½œç”¨çš„å¤„ç†"></a>å‰¯ä½œç”¨çš„å¤„ç†</h3><p>å®é™…ä¸Šè®¿é—®è€…çš„å·¥ä½œæ¯”æˆ‘ä»¬æƒ³è±¡çš„è¦å¤æ‚çš„å¤šï¼Œä¸Šé¢ç¤ºèŒƒçš„æ˜¯é™æ€ AST çš„éå†è¿‡ç¨‹ã€‚è€Œ AST è½¬æ¢æœ¬èº«æ˜¯æœ‰å‰¯ä½œç”¨çš„ï¼Œæ¯”å¦‚æ’ä»¶å°†æ—§çš„èŠ‚ç‚¹æ›¿æ¢äº†ï¼Œé‚£ä¹ˆè®¿é—®è€…å°±æ²¡æœ‰å¿…è¦å†å‘ä¸‹è®¿é—®æ—§èŠ‚ç‚¹äº†ï¼Œè€Œæ˜¯ç»§ç»­è®¿é—®æ–°çš„èŠ‚ç‚¹, ä»£ç å¦‚ä¸‹ã€‚</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">traverse(ast, &#123;</span><br><span class="line">  ExpressionStatement(path) &#123;</span><br><span class="line">    <span class="comment">// å°† `console.log('hello' + v + '!')` æ›¿æ¢ä¸º `return â€˜helloâ€™ + v`</span></span><br><span class="line">    <span class="keyword">const</span> rtn = t.returnStatement(t.binaryExpression(<span class="string">'+'</span>, t.stringLiteral(<span class="string">'hello'</span>), t.identifier(<span class="string">'v'</span>)))</span><br><span class="line">    path.replaceWith(rtn)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>ä¸Šé¢çš„ä»£ç , å°†<code>console.log(&#39;hello&#39; + v + &#39;!&#39;)</code>è¯­å¥æ›¿æ¢ä¸º<code>return &quot;hello&quot; + v;</code>, ä¸‹å›¾æ˜¯éå†çš„è¿‡ç¨‹ï¼š</p><p><img src="/images/babel/replace.png" alt></p><p><br></p><p>æˆ‘ä»¬å¯ä»¥å¯¹ AST è¿›è¡Œä»»æ„çš„æ“ä½œï¼Œæ¯”å¦‚åˆ é™¤çˆ¶èŠ‚ç‚¹çš„å…„å¼ŸèŠ‚ç‚¹ã€åˆ é™¤ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹ã€æ–°å¢å…„å¼ŸèŠ‚ç‚¹â€¦ <strong>å½“è¿™äº›æ“ä½œâ€™æ±¡æŸ“â€™äº† AST æ ‘åï¼Œè®¿é—®è€…éœ€è¦è®°å½•è¿™äº›çŠ¶æ€ï¼Œå“åº”å¼(Reactive)æ›´æ–° Path å¯¹è±¡çš„å…³è”å…³ç³», ä¿è¯æ­£ç¡®çš„éå†é¡ºåºï¼Œä»è€Œè·å¾—æ­£ç¡®çš„è½¬è¯‘ç»“æœ</strong>ã€‚</p><p><br></p><h3 id="ä½œç”¨åŸŸçš„å¤„ç†"><a href="#ä½œç”¨åŸŸçš„å¤„ç†" class="headerlink" title="ä½œç”¨åŸŸçš„å¤„ç†"></a>ä½œç”¨åŸŸçš„å¤„ç†</h3><p>è®¿é—®è€…å¯ä»¥ç¡®ä¿æ­£ç¡®åœ°éå†å’Œä¿®æ”¹èŠ‚ç‚¹ï¼Œä½†æ˜¯å¯¹äºè½¬æ¢å™¨æ¥è¯´ï¼Œå¦ä¸€ä¸ªæ¯”è¾ƒæ£˜æ‰‹çš„æ˜¯å¯¹ä½œç”¨åŸŸçš„å¤„ç†ï¼Œè¿™ä¸ªè´£ä»»è½åœ¨äº†æ’ä»¶å¼€å‘è€…çš„å¤´ä¸Šã€‚æ’ä»¶å¼€å‘è€…å¿…é¡»éå¸¸è°¨æ…åœ°å¤„ç†ä½œç”¨åŸŸï¼Œä¸èƒ½ç ´åç°æœ‰ä»£ç çš„æ‰§è¡Œé€»è¾‘ã€‚</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="number">1</span>, b = <span class="number">2</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">foo, bar</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(a, b)</span><br><span class="line">  <span class="keyword">return</span> foo + bar</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚ä½ è¦å°† <code>add</code> å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•° <code>foo</code> æ ‡è¯†ç¬¦ä¿®æ”¹ä¸º<code>a</code>, ä½ å°±éœ€è¦<strong>é€’å½’</strong>éå†å­æ ‘ï¼ŒæŸ¥å‡º<code>foo</code>æ ‡è¯†ç¬¦çš„æ‰€æœ‰<code>å¼•ç”¨</code>, ç„¶åæ›¿æ¢å®ƒ:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">traverse(ast, &#123;</span><br><span class="line">  <span class="comment">// å°†ç¬¬ä¸€ä¸ªå‚æ•°åè½¬æ¢ä¸ºa</span></span><br><span class="line">  FunctionDeclaration(path) &#123;</span><br><span class="line">    <span class="keyword">const</span> firstParams = path.get(<span class="string">'params.0'</span>)</span><br><span class="line">    <span class="keyword">if</span> (firstParams == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> name = firstParams.node.name</span><br><span class="line">    <span class="comment">// é€’å½’éå†ï¼Œè¿™æ˜¯æ’ä»¶å¸¸ç”¨çš„æ¨¡å¼ã€‚è¿™æ ·å¯ä»¥é¿å…å½±å“åˆ°å¤–éƒ¨ä½œç”¨åŸŸ</span></span><br><span class="line">    path.traverse(&#123;</span><br><span class="line">      Identifier(path) &#123;</span><br><span class="line">        <span class="keyword">if</span> (path.node.name === name) &#123;</span><br><span class="line">          path.replaceWith(t.identifier(<span class="string">'a'</span>))</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(generate(ast).code)</span><br><span class="line"><span class="comment">// function add(a, bar) &#123;</span></span><br><span class="line"><span class="comment">//   console.log(a, b);</span></span><br><span class="line"><span class="comment">//   return a + bar;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br></pre></td></tr></table></figure><p><br></p><p>ğŸ¤¯æ…¢ç€ï¼Œå¥½åƒæ²¡é‚£ä¹ˆç®€å•ï¼Œæ›¿æ¢æˆ <code>a</code> ä¹‹å, <code>console.log(a, b)</code> çš„è¡Œä¸ºå°±è¢«ç ´åäº†ã€‚æ‰€ä»¥è¿™é‡Œä¸èƒ½ç”¨ <code>a</code>ï¼Œå¾—æ¢ä¸ªæ ‡è¯†ç¬¦, è­¬å¦‚<code>c</code>.</p><p><br></p><p>è¿™å°±æ˜¯è½¬æ¢å™¨éœ€è¦è€ƒè™‘çš„ä½œç”¨åŸŸé—®é¢˜ï¼Œ<strong>AST è½¬æ¢çš„å‰ææ˜¯ä¿è¯ç¨‹åºçš„æ­£ç¡®æ€§</strong>ã€‚ æˆ‘ä»¬åœ¨æ·»åŠ å’Œä¿®æ”¹<code>å¼•ç”¨</code>æ—¶ï¼Œéœ€è¦ç¡®ä¿ä¸ç°æœ‰çš„æ‰€æœ‰å¼•ç”¨ä¸å†²çªã€‚Babelæœ¬èº«ä¸èƒ½æ£€æµ‹è¿™ç±»å¼‚å¸¸ï¼Œåªèƒ½ä¾é æ’ä»¶å¼€å‘è€…è°¨æ…å¤„ç†ã€‚</p><p><br></p><p>Javascripté‡‡ç”¨çš„æ˜¯è¯æ³•ä½œç”¨åŸŸ, ä¹Ÿå°±æ˜¯æ ¹æ®æºä»£ç çš„è¯æ³•ç»“æ„æ¥ç¡®å®šä½œç”¨åŸŸï¼š</p><p><img src="/images/babel/scope.png" alt></p><p>åœ¨<strong>è¯æ³•åŒºå—(block)</strong>ä¸­ï¼Œç”±äºæ–°å»ºå˜é‡ã€å‡½æ•°ã€ç±»ã€å‡½æ•°å‚æ•°ç­‰åˆ›å»ºçš„æ ‡è¯†ç¬¦ï¼Œéƒ½å±äºè¿™ä¸ªåŒºå—ä½œç”¨åŸŸ. è¿™äº›æ ‡è¯†ç¬¦ä¹Ÿç§°ä¸º<strong>ç»‘å®š(Binding)</strong>ï¼Œè€Œå¯¹è¿™äº›ç»‘å®šçš„ä½¿ç”¨ç§°ä¸º<strong>å¼•ç”¨(Reference)</strong></p><p>åœ¨Babelä¸­ï¼Œä½¿ç”¨<code>Scope</code>å¯¹è±¡æ¥è¡¨ç¤ºä½œç”¨åŸŸã€‚ æˆ‘ä»¬å¯ä»¥é€šè¿‡Pathå¯¹è±¡çš„<code>scope</code>å­—æ®µæ¥è·å–å½“å‰èŠ‚ç‚¹çš„<code>Scope</code>å¯¹è±¡ã€‚å®ƒçš„ç»“æ„å¦‚ä¸‹:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  path: NodePath;</span><br><span class="line">  block: Node;         <span class="comment">// æ‰€å±çš„è¯æ³•åŒºå—èŠ‚ç‚¹, ä¾‹å¦‚å‡½æ•°èŠ‚ç‚¹ã€æ¡ä»¶è¯­å¥èŠ‚ç‚¹</span></span><br><span class="line">  parentBlock: Node;   <span class="comment">// æ‰€å±çš„çˆ¶çº§è¯æ³•åŒºå—èŠ‚ç‚¹</span></span><br><span class="line">  parent: Scope;       <span class="comment">// âš›ï¸æŒ‡å‘çˆ¶ä½œç”¨åŸŸ</span></span><br><span class="line">  bindings: &#123; [name: string]: Binding; &#125;; <span class="comment">// âš›ï¸ è¯¥ä½œç”¨åŸŸä¸‹é¢çš„æ‰€æœ‰ç»‘å®š(å³è¯¥ä½œç”¨åŸŸåˆ›å»ºçš„æ ‡è¯†ç¬¦)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p><code>Scope</code> å¯¹è±¡å’Œ <code>Path</code> å¯¹è±¡å·®ä¸å¤šï¼Œ<strong>å®ƒåŒ…å«äº†ä½œç”¨åŸŸä¹‹é—´çš„å…³è”å…³ç³»(é€šè¿‡parentæŒ‡å‘çˆ¶ä½œç”¨åŸŸ)ï¼Œæ”¶é›†äº†ä½œç”¨åŸŸä¸‹é¢çš„æ‰€æœ‰ç»‘å®š(bindings), å¦å¤–è¿˜æä¾›äº†ä¸°å¯Œçš„æ–¹æ³•æ¥å¯¹ä½œç”¨åŸŸä»…é™æ“ä½œ</strong>ã€‚</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>bindings</code>å±æ€§è·å–å½“å‰ä½œç”¨åŸŸä¸‹çš„æ‰€æœ‰ç»‘å®š(å³æ ‡è¯†ç¬¦)ï¼Œæ¯ä¸ªç»‘å®šç”±<code>Binding</code>ç±»æ¥è¡¨ç¤ºï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Binding</span> </span>&#123;</span><br><span class="line">  identifier: t.Identifier;</span><br><span class="line">  scope: Scope;</span><br><span class="line">  path: NodePath;</span><br><span class="line">  kind: <span class="string">"var"</span> | <span class="string">"let"</span> | <span class="string">"const"</span> | <span class="string">"module"</span>;</span><br><span class="line">  referenced: boolean;</span><br><span class="line">  references: number;              <span class="comment">// è¢«å¼•ç”¨çš„æ•°é‡</span></span><br><span class="line">  referencePaths: NodePath[];      <span class="comment">// âš›ï¸è·å–æ‰€æœ‰åº”ç”¨è¯¥æ ‡è¯†ç¬¦çš„èŠ‚ç‚¹è·¯å¾„</span></span><br><span class="line">  constant: boolean;               <span class="comment">// æ˜¯å¦æ˜¯å¸¸é‡</span></span><br><span class="line">  constantViolations: NodePath[];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>é€šè¿‡<code>Binding</code>å¯¹è±¡æˆ‘ä»¬å¯ä»¥ç¡®å®šæ ‡è¯†ç¬¦è¢«å¼•ç”¨çš„æƒ…å†µ</strong>ã€‚</p><p>Okï¼Œæœ‰äº† <code>Scope</code> å’Œ <code>Binding</code>, ç°åœ¨æœ‰èƒ½åŠ›å®ç°å®‰å…¨çš„å˜é‡é‡å‘½åè½¬æ¢äº†ã€‚ ä¸ºäº†æ›´å¥½åœ°å±•ç¤ºä½œç”¨åŸŸäº¤äº’ï¼Œåœ¨ä¸Šé¢ä»£ç çš„åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬å†å¢åŠ ä¸€ä¸‹éš¾åº¦ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="number">1</span>, b = <span class="number">2</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">foo, bar</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(a, b)</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> a = <span class="string">'1'</span> <span class="comment">// æ–°å¢äº†ä¸€ä¸ªå˜é‡å£°æ˜</span></span><br><span class="line">    <span class="keyword">return</span> a + (foo + bar)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç°åœ¨ä½ è¦é‡å‘½åå‡½æ•°å‚æ•° <code>foo</code>, ä¸ä»…è¦è€ƒè™‘<code>å¤–éƒ¨çš„ä½œç”¨åŸŸ</code>, ä¹Ÿè¦è€ƒè™‘<code>ä¸‹çº§ä½œç”¨åŸŸ</code>çš„ç»‘å®šæƒ…å†µï¼Œç¡®ä¿è¿™ä¸¤è€…éƒ½ä¸å†²çªã€‚</p><p>ä¸Šé¢çš„ä»£ç ä½œç”¨åŸŸå’Œæ ‡è¯†ç¬¦å¼•ç”¨æƒ…å†µå¦‚ä¸‹å›¾æ‰€ç¤º:</p><p><img src="/images/babel/scope2.png" alt></p><p><br></p><p>æ¥å§ï¼Œæ¥å—æŒ‘æˆ˜ï¼Œè¯•ç€å°†å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°é‡æ–°å‘½åä¸ºæ›´çŸ­çš„æ ‡è¯†ç¬¦:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ç”¨äºè·å–å”¯ä¸€çš„æ ‡è¯†ç¬¦</span></span><br><span class="line"><span class="keyword">const</span> getUid = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> uid = <span class="number">0</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> <span class="string">`_<span class="subst">$&#123;(uid++) || <span class="string">''</span>&#125;</span>`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ast = babel.parseSync(code)</span><br><span class="line">traverse(ast, &#123;</span><br><span class="line">  FunctionDeclaration(path) &#123;</span><br><span class="line">    <span class="comment">// è·å–ç¬¬ä¸€ä¸ªå‚æ•°</span></span><br><span class="line">    <span class="keyword">const</span> firstParam = path.get(<span class="string">'params.0'</span>)</span><br><span class="line">    <span class="keyword">if</span> (firstParam == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> currentName = firstParam.node.name</span><br><span class="line">    <span class="keyword">const</span> currentBinding = path.scope.getBinding(currentName)</span><br><span class="line">    <span class="keyword">const</span> gid = getUid()</span><br><span class="line">    <span class="keyword">let</span> sname</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¾ªç¯æ‰¾å‡ºæ²¡æœ‰è¢«å ç”¨çš„å˜é‡å</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">      sname = gid()</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 1ï¸âƒ£é¦–å…ˆçœ‹ä¸€ä¸‹çˆ¶ä½œç”¨åŸŸæ˜¯å¦å·²å®šä¹‰äº†è¯¥å˜é‡</span></span><br><span class="line">      <span class="keyword">if</span> (path.scope.parentHasBinding(sname)) &#123;</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 2ï¸âƒ£ æ£€æŸ¥å½“å‰ä½œç”¨åŸŸæ˜¯å¦å®šä¹‰äº†å˜é‡</span></span><br><span class="line">      <span class="keyword">if</span> (path.scope.hasOwnBinding(sname)) &#123;</span><br><span class="line">        <span class="comment">// å·²å ç”¨</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//  å†æ£€æŸ¥ç¬¬ä¸€ä¸ªå‚æ•°çš„å½“å‰çš„å¼•ç”¨æƒ…å†µ,</span></span><br><span class="line">      <span class="comment">// å¦‚æœå®ƒæ‰€åœ¨çš„ä½œç”¨åŸŸå®šä¹‰äº†åŒåçš„å˜é‡ï¼Œæˆ‘ä»¬ä¹Ÿå¾—æ”¾å¼ƒ</span></span><br><span class="line">      <span class="keyword">if</span> (currentBinding.references &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> findIt = <span class="literal">false</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> refNode <span class="keyword">of</span> currentBinding.referencePaths) &#123;</span><br><span class="line">          <span class="keyword">if</span> (refNode.scope !== path.scope &amp;&amp; refNode.scope.hasBinding(sname)) &#123;</span><br><span class="line">            findIt = <span class="literal">true</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (findIt) &#123;</span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¼€å§‹æ›¿æ¢æ‰</span></span><br><span class="line">    <span class="keyword">const</span> i = t.identifier(sname)</span><br><span class="line">    currentBinding.referencePaths.forEach(<span class="function"><span class="params">p</span> =&gt;</span> p.replaceWith(i))</span><br><span class="line">    firstParam.replaceWith(i)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(generate(ast).code)</span><br><span class="line"><span class="comment">// const a = 1,</span></span><br><span class="line"><span class="comment">//       b = 2;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// function add(_, bar) &#123;</span></span><br><span class="line"><span class="comment">//   console.log(a, b);</span></span><br><span class="line"><span class="comment">//   return () =&gt; &#123;</span></span><br><span class="line"><span class="comment">//     const a = '1'; // æ–°å¢äº†ä¸€ä¸ªå˜é‡å£°æ˜</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//     return a + (_ + bar);</span></span><br><span class="line"><span class="comment">//   &#125;;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br></pre></td></tr></table></figure><p><br></p><p>ä¸Šé¢çš„ä¾‹å­è™½ç„¶æ²¡æœ‰ä»€ä¹ˆå®ç”¨æ€§ï¼Œè€Œä¸”è¿˜æœ‰Bug(æ²¡è€ƒè™‘<code>label</code>)ï¼Œä½†æ˜¯æ­£å¥½å¯ä»¥æ­ç¤ºäº†ä½œç”¨åŸŸå¤„ç†çš„å¤æ‚æ€§ã€‚</p><p><br></p><p>Babelçš„ <code>Scope</code> å¯¹è±¡å…¶å®æä¾›äº†ä¸€ä¸ª<code>generateUid</code>æ–¹æ³•æ¥ç”Ÿæˆå”¯ä¸€çš„ã€ä¸å†²çªçš„æ ‡è¯†ç¬¦ã€‚æˆ‘ä»¬åˆ©ç”¨è¿™ä¸ªæ–¹æ³•å†ç®€åŒ–ä¸€ä¸‹æˆ‘ä»¬çš„ä»£ç :</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">traverse(ast, &#123;</span><br><span class="line">  FunctionDeclaration(path) &#123;</span><br><span class="line">    <span class="keyword">const</span> firstParam = path.get(<span class="string">'params.0'</span>)</span><br><span class="line">    <span class="keyword">if</span> (firstParam == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> i = path.scope.generateUidIdentifier(<span class="string">'_'</span>) <span class="comment">// ä¹Ÿå¯ä»¥ä½¿ç”¨generateUid</span></span><br><span class="line">    <span class="keyword">const</span> currentBinding = path.scope.getBinding(firstParam.node.name)</span><br><span class="line">    currentBinding.referencePaths.forEach(<span class="function"><span class="params">p</span> =&gt;</span> p.replaceWith(i))</span><br><span class="line">    firstParam.replaceWith(i)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><br></p><p>èƒ½ä¸èƒ½å†çŸ­ç‚¹!</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">traverse(ast, &#123;</span><br><span class="line">  FunctionDeclaration(path) &#123;</span><br><span class="line">    <span class="keyword">const</span> firstParam = path.get(<span class="string">'params.0'</span>)</span><br><span class="line">    <span class="keyword">if</span> (firstParam == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> i = path.scope.generateUid(<span class="string">'_'</span>) <span class="comment">// ä¹Ÿå¯ä»¥ä½¿ç”¨generateUid</span></span><br><span class="line">    path.scope.rename(firstParam.node.name, i)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><br></p><details><br><summary>æŸ¥çœ‹generateUidçš„å®ç°ä»£ç </summary><br><br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">generateUid(name: string = <span class="string">"temp"</span>) &#123;</span><br><span class="line">  name = t</span><br><span class="line">    .toIdentifier(name)</span><br><span class="line">    .replace(<span class="regexp">/^_+/</span>, <span class="string">""</span>)</span><br><span class="line">    .replace(<span class="regexp">/[0-9]+$/g</span>, <span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> uid;</span><br><span class="line">  <span class="keyword">let</span> i = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    uid = <span class="keyword">this</span>._generateUid(name, i);</span><br><span class="line">    i++;</span><br><span class="line">  &#125; <span class="keyword">while</span> (</span><br><span class="line">    <span class="keyword">this</span>.hasLabel(uid) ||</span><br><span class="line">    <span class="keyword">this</span>.hasBinding(uid) ||</span><br><span class="line">    <span class="keyword">this</span>.hasGlobal(uid) ||</span><br><span class="line">    <span class="keyword">this</span>.hasReference(uid)</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> program = <span class="keyword">this</span>.getProgramParent();</span><br><span class="line">  program.references[uid] = <span class="literal">true</span>;</span><br><span class="line">  program.uids[uid] = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> uid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><br></details><p>éå¸¸ç®€æ´å“ˆï¼Ÿä½œç”¨åŸŸæ“ä½œæœ€å…¸å‹çš„åœºæ™¯æ˜¯ä»£ç å‹ç¼©ï¼Œä»£ç å‹ç¼©ä¼šå¯¹å˜é‡åã€å‡½æ•°åç­‰è¿›è¡Œå‹ç¼©â€¦ ç„¶è€Œå®é™…ä¸Šå¾ˆå°‘çš„æ’ä»¶åœºæ™¯éœ€è¦è·Ÿä½œç”¨åŸŸè¿›è¡Œå¤æ‚çš„äº¤äº’ï¼Œæ‰€ä»¥å…³äºä½œç”¨åŸŸè¿™ä¸€å—å°±å…ˆè®²åˆ°è¿™é‡Œã€‚</p><p><br></p><h2 id="æä¸€ä¸ªæ’ä»¶å‘—"><a href="#æä¸€ä¸ªæ’ä»¶å‘—" class="headerlink" title="æä¸€ä¸ªæ’ä»¶å‘—"></a>æä¸€ä¸ªæ’ä»¶å‘—</h2><p>ç­‰ç­‰åˆ«èµ°ï¼Œè¿˜æ²¡å®Œå‘¢ï¼Œè¿™æ‰åˆ°2/3ã€‚å­¦äº†ä¸Šé¢å¾—äº†çŸ¥è¯†ï¼Œæ€»å¾—å†™ä¸€ä¸ªç©å…·æ’ä»¶è¯•è¯•æ°´å§?</p><p>ç°åœ¨æ‰“ç®—æ¨¡ä»¿<a href="https://github.com/ant-design/babel-plugin-import" target="_blank" rel="noopener">babel-plugin-import</a>, å†™ä¸€ä¸ªæç®€ç‰ˆæ’ä»¶ï¼Œæ¥å®ç°æ¨¡å—çš„æŒ‰éœ€å¯¼å…¥. åœ¨è¿™ä¸ªæ’ä»¶ä¸­ï¼Œæˆ‘ä»¬ä¼šå°†ç±»ä¼¼è¿™æ ·çš„å¯¼å…¥è¯­å¥:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;A, B, C <span class="keyword">as</span> D&#125; <span class="keyword">from</span> <span class="string">'foo'</span></span><br></pre></td></tr></table></figure><p>è½¬æ¢ä¸º:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> A <span class="keyword">from</span> <span class="string">'foo/A'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'foo/A/style.css'</span></span><br><span class="line"><span class="keyword">import</span> B <span class="keyword">from</span> <span class="string">'foo/B'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'foo/B/style.css'</span></span><br><span class="line"><span class="keyword">import</span> D <span class="keyword">from</span> <span class="string">'foo/C'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'foo/C/style.css'</span></span><br></pre></td></tr></table></figure><p>é¦–å…ˆé€šè¿‡ <a href="https://astexplorer.net" target="_blank" rel="noopener">AST Explorer</a> çœ‹ä¸€ä¸‹å¯¼å…¥è¯­å¥çš„ AST èŠ‚ç‚¹ç»“æ„:</p><p><img src="/images/babel/import.png" alt></p><p><br></p><p>é€šè¿‡ä¸Šé¢å±•ç¤ºçš„ç»“æœï¼Œæˆ‘ä»¬éœ€è¦å¤„ç† <code>ImportDeclaration</code> èŠ‚ç‚¹ç±»å‹ï¼Œå°†å®ƒçš„<code>specifiers</code>æ‹¿å‡ºæ¥éå†å¤„ç†ä¸€ä¸‹ã€‚å¦å¤–å¦‚æœç”¨æˆ·ä½¿ç”¨äº†<code>é»˜è®¤å¯¼å…¥</code>è¯­å¥ï¼Œæˆ‘ä»¬å°†æŠ›å‡ºé”™è¯¯ï¼Œæé†’ç”¨æˆ·ä¸èƒ½ä½¿ç”¨é»˜è®¤å¯¼å…¥. </p><p>åŸºæœ¬å®ç°å¦‚ä¸‹:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è¦è¯†åˆ«çš„æ¨¡å—</span></span><br><span class="line"><span class="keyword">const</span> MODULE = <span class="string">'foo'</span></span><br><span class="line">traverse(ast, &#123;</span><br><span class="line">  <span class="comment">// è®¿é—®å¯¼å…¥è¯­å¥</span></span><br><span class="line">  ImportDeclaration(path) &#123;</span><br><span class="line">    <span class="keyword">if</span> (path.node.source.value !== MODULE) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯ç©ºå¯¼å…¥åˆ™ç›´æ¥åˆ é™¤æ‰</span></span><br><span class="line">    <span class="keyword">const</span> specs = path.node.specifiers</span><br><span class="line">    <span class="keyword">if</span> (specs.length === <span class="number">0</span>) &#123;</span><br><span class="line">      path.remove()</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦åŒ…å«äº†é»˜è®¤å¯¼å…¥å’Œå‘½åç©ºé—´å¯¼å…¥</span></span><br><span class="line">    <span class="keyword">if</span> (specs.some(<span class="function"><span class="params">i</span> =&gt;</span> t.isImportDefaultSpecifier(i) || t.isImportNamespaceSpecifier(i))) &#123;</span><br><span class="line">      <span class="comment">// æŠ›å‡ºé”™è¯¯ï¼ŒBabelä¼šå±•ç¤ºå‡ºé”™çš„ä»£ç å¸§</span></span><br><span class="line">      <span class="keyword">throw</span> path.buildCodeFrameError(<span class="string">"ä¸èƒ½ä½¿ç”¨é»˜è®¤å¯¼å…¥æˆ–å‘½åç©ºé—´å¯¼å…¥"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è½¬æ¢å‘½åå¯¼å…¥</span></span><br><span class="line">    <span class="keyword">const</span> imports = []</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> spec <span class="keyword">of</span> specs) &#123;</span><br><span class="line">      <span class="keyword">const</span> named = MODULE + <span class="string">'/'</span> + spec.imported.name</span><br><span class="line">      <span class="keyword">const</span> local = spec.local</span><br><span class="line">      imports.push(t.importDeclaration([t.importDefaultSpecifier(local)], t.stringLiteral(named)))</span><br><span class="line">      imports.push(t.importDeclaration([], t.stringLiteral(<span class="string">`<span class="subst">$&#123;named&#125;</span>/style.css`</span>)))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ›¿æ¢åŸæœ‰çš„å¯¼å…¥è¯­å¥</span></span><br><span class="line">    path.replaceWithMultiple(imports)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><br></p><p>é€»è¾‘è¿˜ç®—ç®€å•ï¼Œ<code>babel-plugin-import</code>å¯æ¯”è¿™å¤æ‚å¾—å¤šã€‚</p><p><br></p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†å®ƒå°è£…æˆæ ‡å‡†çš„ Babel æ’ä»¶ã€‚ æŒ‰ç…§è§„èŒƒï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª<code>babel-plugin-*</code>å‰ç¼€çš„åŒ…åï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">mkdir babel-plugin-toy-<span class="keyword">import</span></span><br><span class="line">cd babel-plugin-toy-<span class="keyword">import</span></span><br><span class="line">yarn init -y</span><br><span class="line">touch index.js</span><br></pre></td></tr></table></figure><p><br></p><blockquote><p>ä½ ä¹Ÿå¯ä»¥é€šè¿‡ <a href="https://github.com/babel/generator-babel-plugin/tree/master/generators/app/templates" target="_blank" rel="noopener">generator-babel-plugin</a> æ¥ç”Ÿæˆé¡¹ç›®æ¨¡æ¿.</p></blockquote><p><br></p><p>åœ¨ <code>index.js</code> æ–‡ä»¶ä¸­å¡«å…¥æˆ‘ä»¬çš„ä»£ç ã€‚<code>index.js</code>é»˜è®¤å¯¼å‡ºä¸€ä¸ªå‡½æ•°ï¼Œå‡½æ•°ç»“æ„å¦‚ä¸‹:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ¥å—ä¸€ä¸ª babel-core å¯¹è±¡</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span>(<span class="params">babel</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;<span class="attr">types</span>: t&#125; = babel</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    pre(state) &#123;</span><br><span class="line">      <span class="comment">// å‰ç½®æ“ä½œï¼Œå¯é€‰ï¼Œå¯ä»¥ç”¨äºå‡†å¤‡ä¸€äº›èµ„æº</span></span><br><span class="line">    &#125;,</span><br><span class="line">    visitor: &#123;</span><br><span class="line">      <span class="comment">// æˆ‘ä»¬çš„è®¿é—®è€…ä»£ç å°†æ”¾åœ¨è¿™é‡Œ</span></span><br><span class="line">      ImportDeclaration(path, state) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    post(state) &#123;</span><br><span class="line">      <span class="comment">// åç½®æ“ä½œï¼Œå¯é€‰</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p><strong>æˆ‘ä»¬å¯ä»¥ä»è®¿é—®å™¨æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°<code>state</code>ä¸­è·å–ç”¨æˆ·ä¼ å…¥çš„å‚æ•°</strong>ã€‚å‡è®¾ç”¨æˆ·é…ç½®ä¸º:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  plugins: [[<span class="string">'toy-plugin'</span>, &#123;<span class="attr">name</span>: <span class="string">'foo'</span>&#125;]]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥è¿™æ ·è·å–ç”¨æˆ·ä¼ å…¥çš„å‚æ•°:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span>(<span class="params">babel</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;<span class="attr">types</span>: t&#125; = babel</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    visitor: &#123;</span><br><span class="line">      ImportDeclaration(path, state) &#123;</span><br><span class="line">        <span class="keyword">const</span> mod = state.opts &amp;&amp; state.opts.name</span><br><span class="line">        <span class="keyword">if</span> (mod == <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰“å®Œæ”¶å·¥ ğŸ™ï¼Œå‘å¸ƒ!</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yarn publish # good luck</span><br></pre></td></tr></table></figure><p><br><br><br></p><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><blockquote><p>æ–°ä¸–ç•Œçš„å¤§é—¨å·²ç»æ‰“å¼€: â›©</p></blockquote><p>æœ¬æ–‡ä¸»è¦ä»‹ç»äº† Babel çš„æ¶æ„å’ŒåŸç†ï¼Œè¿˜å®è·µäº†ä¸€ä¸‹ Babel æ’ä»¶å¼€å‘ï¼Œè¯»åˆ°è¿™é‡Œï¼Œä½ ç®—æ˜¯å…¥äº† Babel çš„é—¨äº†.</p><p>æ¥ä¸‹æ¥ä½ å¯ä»¥å»ç†Ÿè¯»<a href="https://github.com/jamiebuilds/babel-handbook" target="_blank" rel="noopener">Babelæ‰‹å†Œ</a>, è¿™æ˜¯ç›®å‰æœ€å¥½çš„æ•™ç¨‹,<br><a href="https://astexplorer.net/#/KJ8AjD6maa" target="_blank" rel="noopener">ASTExplorer</a>æ˜¯æœ€å¥½çš„æ¼”ç»ƒåœºï¼Œå¤šå†™ä»£ç å¤šæ€è€ƒã€‚<br>ä½ ä¹Ÿå¯ä»¥å»çœ‹<a href="https://github.com/babel/babel/tree/master/packages" target="_blank" rel="noopener">Babelçš„å®˜æ–¹æ’ä»¶å®ç°</a>, è¿ˆå‘æ›´é«˜çš„å°é˜¶ã€‚</p><p>æœ¬æ–‡è¿˜æœ‰ä¸‹ç¯‡ï¼Œæˆ‘å°†åœ¨ä¸‹ç¯‡æ–‡ç« ä¸­ä»‹ç»<a href="https://github.com/kentcdodds/babel-plugin-macros" target="_blank" rel="noopener">babel-plugin-macros</a>, æ•¬è¯·æœŸå¾…ï¼</p><p>ç‚¹èµæ˜¯å¯¹æˆ‘æœ€å¥½é¼“åŠ±ã€‚</p><p><br></p><p><img src="/images/sponsor.jpg" alt></p><p><br></p><h2 id="æ‰©å±•"><a href="#æ‰©å±•" class="headerlink" title="æ‰©å±•"></a>æ‰©å±•</h2><ul><li><a href="https://astexplorer.net/#/KJ8AjD6maa" target="_blank" rel="noopener">ASTExplorer</a></li><li><a href="https://github.com/jamiebuilds/babel-handbook" target="_blank" rel="noopener">babel-handbook</a></li><li><a href="https://github.com/babel/generator-babel-plugin" target="_blank" rel="noopener">generator-babel-plugin</a></li><li><a href="https://the-super-tiny-compiler.glitch.me" target="_blank" rel="noopener">the-super-tiny-compiler</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;å›½åº†æ”¾å‡äº†ï¼Œæˆ‘è¿˜åœ¨åˆ©ç”¨ç¢ç‰‡æ—¶é—´åœ¨å†™æ–‡ç« ï¼Œä¸çŸ¥é“é•¿å‡è¿˜æœ‰æ²¡æœ‰äººçœ‹ï¼Œè¯•è¯•æ°´å§ï¼&lt;/p&gt;
&lt;p&gt;è¿™ä¸ªæ–‡ç« ç³»åˆ—å°†å¸¦å¤§å®¶æ·±å…¥æµ…å‡º &lt;a href=&quot;https://babeljs.io&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;&lt;code&gt;Babel&lt;/code
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://bobi.ink/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>if æˆ‘æ˜¯å‰ç«¯å›¢é˜Ÿ Leaderï¼Œæ€ä¹ˆç”¨å¥½çœ‹æ¿è¿›è¡Œä»»åŠ¡ç®¡ç†</title>
    <link href="https://bobi.ink/2019/09/23/kanban/"/>
    <id>https://bobi.ink/2019/09/23/kanban/</id>
    <published>2019-09-22T16:00:00.000Z</published>
    <updated>2019-09-26T23:22:16.651Z</updated>
    
    <content type="html"><![CDATA[<p><code>çœ‹æ¿</code>æ˜¯ä¸€ç§éå¸¸å¸¸è§çš„ä»»åŠ¡ç®¡ç†æœºåˆ¶ã€‚æˆ‘ä»¬ä½¿ç”¨åˆ°çš„å¤§éƒ¨åˆ†å›¢é˜Ÿåä½œå·¥å…·ä¸­éƒ½æœ‰çœ‹æ¿çš„èº«å½±ï¼Œä¾‹å¦‚ <a href="http://tower.im" target="_blank" rel="noopener"><code>Tower</code></a>ã€<a href="http://teambition.com" target="_blank" rel="noopener"><code>Teambition</code></a>ã€<code>Trello</code>ã€<code>Github</code>ã€<code>Gitlab</code>â€¦ </p><p>çœ‹æ¿ä¸ä»…å¯ä»¥ç”¨äºå›¢é˜Ÿåä½œï¼Œä¹Ÿå¯ä»¥ç”¨äºå¯¹ä¸ªäººæ—¶é—´è¿›è¡Œç®¡ç†å’Œä¼˜åŒ–ã€‚ <strong>å¯æ˜¯ä½ çœŸçš„ä¼šç”¨çœ‹æ¿å—</strong>ï¼Ÿ</p><p><br></p><p><code>Wiki</code> ä¸Šé¢çš„è§£é‡Šæ˜¯ï¼š <code>çœ‹æ¿æ˜¯ä¸°ç”°ç”Ÿäº§æ¨¡å¼ä¸­çš„é‡è¦æ¦‚å¿µï¼ŒæŒ‡ä¸ºäº†è¾¾åˆ°åŠæ—¶ç”Ÿäº§ï¼ˆJITï¼‰æ–¹å¼æ§åˆ¶ç°åœºç”Ÿäº§æµç¨‹çš„å·¥å…·ã€‚åŠæ—¶ç”Ÿäº§æ–¹å¼ä¸­çš„æ‹‰å¼ç”Ÿäº§ç³»ç»Ÿå¯ä»¥ä½¿ä¿¡æ¯çš„æµç¨‹ç¼©çŸ­ï¼Œå¹¶é…åˆå®šé‡ã€å›ºå®šè£…è´§å®¹å™¨ç­‰æ–¹å¼ï¼Œè€Œä½¿ç”Ÿäº§è¿‡ç¨‹ä¸­çš„ç‰©æ–™æµåŠ¨é¡ºç•…</code>.</p><p>ä»ä¸Šé¢çš„å®šä¹‰ä¸­éœ€è¦æ³¨æ„ä»¥ä¸‹è¦ç‚¹:</p><ul><li><strong>åŠæ—¶ç”Ÿäº§</strong> - è¿™æ˜¯ä¸€ç§é€šè¿‡å‡å°‘ç”Ÿäº§è¿‡ç¨‹ä¸­çš„åº“å­˜å’Œç›¸å…³çš„é¡ºå¸¦æˆæœ¬ï¼Œæ”¹å–„å•†ä¸šæŠ•èµ„å›æŠ¥çš„ç®¡ç†æˆ˜ç•¥ã€‚</li><li><strong>æ§åˆ¶ç°åœº</strong> - çœ‹æ¿æ˜¯ä¸€ç§<code>ç°åœºè¿˜åŸ</code>å’Œ<code>ç°åœºæ§åˆ¶</code>æ–¹æ³•</li><li><strong>æ‹‰å¼ç”Ÿäº§ç³»ç»Ÿ</strong> - ä¼ ç»Ÿçš„è½¯ä»¶å¼€å‘éƒ½æ˜¯ä½¿ç”¨<code>æ¨(Push)æ¨¡å¼</code>ï¼Œå³è§„å®šæŸä¸ªä»»åŠ¡ç”±æŒ‡å®šäººåœ¨æŒ‡å®šæ—¶é—´å†…å®Œæˆã€‚è€Œæ‹‰å¼ç”Ÿäº§ç³»ç»Ÿï¼Œæ›´åƒç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ï¼Œçœ‹æ¿å°±æ˜¯ä¸€ä¸ªä¿¡å·ç­‰ï¼Œå½“ä¸Šæ¸¸æœ‰å·²å®Œæˆçš„ä»»åŠ¡ï¼Œé€šçŸ¥ä¸‹æ¸¸å¼€å§‹å¤„ç†è¿™äº›ä»»åŠ¡</li><li><strong>å®šé‡</strong> - æµç¨‹ä¸Šçš„æ¯ä¸ªç¯èŠ‚æ˜¯æœ‰å›ºå®šå¸¦å®½çš„ï¼Œè¿™æœ‰åŠ©äºæš´éœ²æµç¨‹ä¸Šçš„ç“¶é¢ˆ</li></ul><p><br></p><p><a href="https://www.infoq.cn/article/kanban-development-method" target="_blank" rel="noopener">ã€Šè§£æç²¾ç›Šäº§å“å¼€å‘ï¼ˆä¸€ï¼‰â€”â€” çœ‹æ¿å¼€å‘æ–¹æ³•ã€‹</a> å¯¹çœ‹æ¿æ€»ç»“å¾—éå¸¸å¥½, <strong>çœ‹æ¿å·¥å…·çš„å®è´¨æ˜¯</strong>ï¼šåé“å·¥åºåœ¨éœ€è¦æ—¶ï¼Œé€šè¿‡çœ‹æ¿å‘å‰é“å·¥åºå‘å‡ºä¿¡å·â€”â€”è¯·ç»™æˆ‘éœ€è¦æ•°é‡çš„è¾“å…¥ï¼Œå‰é“å·¥åºåªæœ‰å¾—åˆ°çœ‹æ¿åï¼Œæ‰æŒ‰éœ€ç”Ÿäº§ã€‚çœ‹æ¿ä¿¡å·ç”±ä¸‹æ¸¸å‘ä¸Šæ¸¸ä¼ é€’ï¼Œæ‹‰åŠ¨ä¸Šæ¸¸çš„ç”Ÿäº§æ´»åŠ¨ï¼Œä½¿äº§å“å‘ä¸‹æ¸¸æµåŠ¨ã€‚æ‹‰åŠ¨çš„æºå¤´æ˜¯æœ€ä¸Šæ¸¸çš„å®¢æˆ·ä»·å€¼ï¼Œä¹Ÿå°±æ˜¯å®¢æˆ·è®¢å•æˆ–éœ€æ±‚ã€‚</p><p>ä¸‹é¢ä¼šå¾ªåºæ¸è¿›ï¼Œä»‹ç»çœ‹æ¿åº”ç”¨çš„å‡ ä¸ªé˜¶æ®µã€‚å¦‚æœä½ çš„å›¢é˜Ÿè¿˜åœç•™åœ¨ç¬¬ä¸€ä¸ªé˜¶æ®µï¼Œä¸å¦¨è¯•è¯•ç»§ç»­æ·±å…¥å®è·µã€‚</p><p><br></p><p><strong>æ–‡ç« å¤§çº²</strong></p><!-- TOC --><ul><li><a href="#ç¬¬ä¸€é˜¶-ä»æ—¢æœ‰çš„æµç¨‹å¼€å§‹-æµç¨‹å¯è§†åŒ–">ç¬¬ä¸€é˜¶ï¼š ä»æ—¢æœ‰çš„æµç¨‹å¼€å§‹ï¼Œ æµç¨‹å¯è§†åŒ–</a><ul><li><a href="#æµç¨‹çš„æŠ½è±¡">æµç¨‹çš„æŠ½è±¡</a></li><li><a href="#ä¸æ–­æ”¹è¿›çš„æµç¨‹">ä¸æ–­æ”¹è¿›çš„æµç¨‹</a></li><li><a href="#çœ‹æ¿çš„èŒƒå›´">çœ‹æ¿çš„èŒƒå›´</a></li><li><a href="#ä¼˜å…ˆçº§åˆ’åˆ†">ä¼˜å…ˆçº§åˆ’åˆ†</a></li><li><a href="#æ¨æ¨¡å‹pushä¸æ‹‰æ¨¡å‹pull">æ¨æ¨¡å‹(Push)ä¸æ‹‰æ¨¡å‹(Pull)</a></li><li><a href="#æš´éœ²ç“¶é¢ˆ">æš´éœ²ç“¶é¢ˆ</a></li><li><a href="#æ€»ç»“">æ€»ç»“</a></li></ul></li><li><a href="#ç¬¬äºŒé˜¶åœ¨åˆ¶å“é™åˆ¶">ç¬¬äºŒé˜¶ï¼šåœ¨åˆ¶å“é™åˆ¶</a><ul><li><a href="#ä»€ä¹ˆæ˜¯åœ¨åˆ¶å“">ä»€ä¹ˆæ˜¯åœ¨åˆ¶å“</a></li><li><a href="#ä¸ºä»€ä¹ˆé™åˆ¶åœ¨åˆ¶å“">ä¸ºä»€ä¹ˆé™åˆ¶åœ¨åˆ¶å“?</a></li><li><a href="#wipè¦é™åˆ¶å¤šå°‘">WIPè¦é™åˆ¶å¤šå°‘?</a></li></ul></li><li><a href="#ç¬¬ä¸‰é˜¶-ç»“åˆscrum">ç¬¬ä¸‰é˜¶: ç»“åˆScrum</a><ul><li><a href="#ç®€å•ä»‹ç»ä¸€ä¸‹scrum">ç®€å•ä»‹ç»ä¸€ä¸‹Scrum</a></li><li><a href="#èåˆåˆ°çœ‹æ¿ä¸­">èåˆåˆ°çœ‹æ¿ä¸­</a><ul><li><a href="#è®¾å®šå¼€å‘å‘¨æœŸ">è®¾å®šå¼€å‘å‘¨æœŸ</a></li><li><a href="#æ¯æ—¥å›é¡¾">æ¯æ—¥å›é¡¾</a></li><li><a href="#æµç¨‹ç›‘æ§">æµç¨‹ç›‘æ§</a></li></ul></li></ul></li><li><a href="#çœ‹æ¿ä¸€æ—¥æ¸¸">çœ‹æ¿ä¸€æ—¥æ¸¸</a><ul><li><a href="#è®¾è®¡çœ‹æ¿">è®¾è®¡çœ‹æ¿</a></li><li><a href="#åˆ›å»ºä»»åŠ¡">åˆ›å»ºä»»åŠ¡</a></li><li><a href="#å¼€å§‹å§">å¼€å§‹å§</a></li></ul></li><li><a href="#æ‰©å±•èµ„æ–™">æ‰©å±•èµ„æ–™</a></li></ul><!-- /TOC --><p><br></p><p><strong>ç³»åˆ—æ–‡ç« </strong></p><ul><li><a href="https://juejin.im/post/5d3a7134f265da1b5d57f1ed" target="_blank" rel="noopener">if æˆ‘æ˜¯å‰ç«¯å›¢é˜Ÿ Leaderï¼Œæ€ä¹ˆåˆ¶å®šå‰ç«¯åä½œè§„èŒƒ? ğŸ”¥</a></li><li><a href="https://juejin.im/post/5d71cec6e51d4561b674c4d0" target="_blank" rel="noopener">if æˆ‘æ˜¯å‰ç«¯å›¢é˜Ÿ Leaderï¼Œæ€ä¹ˆåšå¥½æ¦‚è¦è®¾è®¡</a></li><li><a href="https://juejin.im/post/5d8d4557e51d4577fe41b62d" target="_blank" rel="noopener">if æˆ‘æ˜¯å‰ç«¯å›¢é˜Ÿ Leaderï¼Œæ€ä¹ˆç”¨å¥½çœ‹æ¿è¿›è¡Œä»»åŠ¡ç®¡ç†?</a></li></ul><p><br></p><h2 id="ç¬¬ä¸€é˜¶ï¼š-ä»æ—¢æœ‰çš„æµç¨‹å¼€å§‹ï¼Œ-æµç¨‹å¯è§†åŒ–"><a href="#ç¬¬ä¸€é˜¶ï¼š-ä»æ—¢æœ‰çš„æµç¨‹å¼€å§‹ï¼Œ-æµç¨‹å¯è§†åŒ–" class="headerlink" title="ç¬¬ä¸€é˜¶ï¼š ä»æ—¢æœ‰çš„æµç¨‹å¼€å§‹ï¼Œ æµç¨‹å¯è§†åŒ–"></a>ç¬¬ä¸€é˜¶ï¼š ä»æ—¢æœ‰çš„æµç¨‹å¼€å§‹ï¼Œ æµç¨‹å¯è§†åŒ–</h2><p><img src="/images/kanban/sample.png" alt></p><p><strong>å°†å¼€å‘æµç¨‹å¯è§†åŒ–æ˜¯çœ‹æ¿çš„æœ€åŸºæœ¬çš„ç”¨æ³•</strong>. ä¸Šé¢æ˜¯ä¸€ä¸ªå…¸å‹çš„çœ‹æ¿å®ä¾‹ï¼Œå®ƒç›´è§‚åœ°æè¿°äº†ä¸€ä¸ª<code>åŠŸèƒ½é¡¹</code>çš„<strong>ç”Ÿå‘½å‘¨æœŸ</strong>ä»¥åŠè¯¥å›¢é˜Ÿçš„<strong>å¼€å‘æµç¨‹</strong>ã€‚å®ƒç»™æˆ‘ä»¬å±•ç¤ºäº†è¿™æ ·ä¸€ä¸ªæµç¨‹:</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">éœ€æ±‚åˆ†æ -&gt; äº§å“è®¾è®¡ -&gt; å¼€å‘ -&gt; æµ‹è¯• -&gt; éƒ¨ç½²</span><br></pre></td></tr></table></figure><p><br></p><h3 id="æµç¨‹çš„æŠ½è±¡"><a href="#æµç¨‹çš„æŠ½è±¡" class="headerlink" title="æµç¨‹çš„æŠ½è±¡"></a>æµç¨‹çš„æŠ½è±¡</h3><p>æ¯ä¸ªäººã€æ¯ä¸ªå›¢é˜Ÿå·¥ä½œæµç¨‹éƒ½ä¸ä¸€æ ·ã€‚åœ¨è®¾è®¡çœ‹æ¿ä¹‹å‰æˆ‘ä»¬éœ€è¦æ¢³ç†ä¸€ä¸‹è‡ªå·±çš„å·¥ä½œæµç¨‹.</p><p>æ¯”å¦‚â€™ä¸ªäººâ€˜çš„æµç¨‹å°±éå¸¸ç®€å•äº†ï¼Œå°±åªæœ‰ä¸€ä¸ªåŠ¨ä½œï¼šâ€™åšä¸ä¸åšâ€™. æ‰€ä»¥ä¸ªäººçœ‹æ¿é€šå¸¸æ˜¯è¿™æ ·çš„</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">todo -&gt; doing -&gt; done</span><br></pre></td></tr></table></figure><p>ä½ ä¼šå‘ç°ï¼Œå³ä½¿å¾ˆç®€å•çš„æµç¨‹ï¼Œ<strong>æµç¨‹çš„æ¯ä¸ªç¯èŠ‚éƒ½ä¼šæœ‰ä¸‰ä¸ªå­æ¨¡å—ï¼š<code>æœªåš</code>/<code>æ­£åœ¨åš</code>/<code>å·²å®Œæˆ</code></strong>. å¯¹äºä¸ªäººçœ‹æ¿è€Œè¨€ï¼Œåˆ’åˆ†è¿™ä¸‰ä¸ªæ¨¡å—ï¼Œä¸»è¦æ˜¯ä¸ºäº†<strong>è¿˜åŸå½“å‰çš„ç°åœº</strong>ã€‚å¯¹äºå›¢é˜Ÿè€Œè¨€ï¼Œè¿™ä¸€ç‚¹æ›´ä¸ºé‡è¦ï¼Œä½ å¯ä»¥é€šè¿‡çœ‹æ¿ç›´è§‚åœ°è·Ÿè¸ªä»»åŠ¡å¼€å‘çš„è¿›åº¦</p><p><br></p><p>æˆ‘ä»¬å›¢é˜Ÿç›®å‰çš„å¼€å‘æµç¨‹ä¹Ÿå¾ˆç®€å•æ˜¯ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">è®¾è®¡ -&gt; å¼€å‘ -&gt; ...</span><br></pre></td></tr></table></figure><ul><li><strong>è®¾è®¡</strong>: åº”ç”¨è®¾è®¡ï¼Œå¯é€‰ï¼Œä¸€èˆ¬åœ¨å¼€å¯ä¸€ä¸ªé¡¹ç›®æˆ–è€…é‡è¦çš„åŠŸèƒ½å¼€å‘æ—¶ä¼šè¿›è¡Œ<a href="https://juejin.im/post/5d71cec6e51d4561b674c4d0" target="_blank" rel="noopener"><code>æ¦‚è¦è®¾è®¡</code></a></li><li><strong>å¼€å‘</strong>: æ­£å¸¸çš„å¼€å‘æµç¨‹</li></ul><p>å½“ç„¶è¿™ä»…ä»…æ˜¯å‰ç«¯å›¢é˜Ÿçš„â€™å±€éƒ¨â€˜æµç¨‹ï¼Œå®Œæ•´çš„è½¯ä»¶å¼€å‘æµç¨‹å¦‚ç¬¬ä¸€ä¸ªçœ‹æ¿å®ä¾‹æ‰€ç¤ºã€‚å› ä¸ºæˆ‘ä»¬ä¸æ˜¯ä¸€ä¸ªâ€™æ•æ·â€˜å›¢é˜Ÿï¼Œåªè¦è´Ÿè´£<code>å‰ç«¯å¼€å‘</code>è¿™ä¸ªç¯èŠ‚å³å¯. å¤§å±€ä¸Šçœ‹<code>éœ€æ±‚åˆ†æ</code>ã€<code>äº§å“è®¾è®¡</code>ã€<code>æµ‹è¯•</code>ä»¥åŠ<code>éƒ¨ç½²</code>ä¸åœ¨æˆ‘ä»¬çš„æ§åˆ¶èŒƒå›´ä¹‹å†…ã€‚æ‰€ä»¥ä¸åº”å½’çº³åˆ°æˆ‘ä»¬çš„å¼€å‘æµç¨‹ä¸­ã€‚</p><p><br></p><h3 id="ä¸æ–­æ”¹è¿›çš„æµç¨‹"><a href="#ä¸æ–­æ”¹è¿›çš„æµç¨‹" class="headerlink" title="ä¸æ–­æ”¹è¿›çš„æµç¨‹"></a>ä¸æ–­æ”¹è¿›çš„æµç¨‹</h3><p>æµç¨‹ä¸æ˜¯ä¸€æˆä¸å˜çš„ï¼Œå®ƒä¼šéšç€å®è·µçš„æ·±å…¥ä¸æ–­æ¼”åŒ–ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå› ä¸ºæˆ‘ä»¬å›¢é˜Ÿæˆå‘˜èƒ½åŠ›å’Œç»éªŒä¸å‡åŒ€ï¼Œæ¯”å¦‚æ–°æ‰‹ä»£ç ç»å¸¸å‡º Bugï¼Œç»†èŠ‚ä¹Ÿæ²¡æœ‰åšå¥½ã€‚æ€ä¹ˆè§£å†³ï¼Ÿ</p><p><strong>é¦–å…ˆæƒ³ä¸€ä¸‹èƒ½å¦åœ¨æµç¨‹ä¸Šåšä¸€ä¸‹æ”¹è¿›</strong>, æ¥å‡ç¼“æˆ–æœç»è¿™ç§æƒ…å†µï¼Œæé«˜ä»£ç è´¨é‡?</p><p>åå¤æ€è€ƒå’Œè®¨è®ºåï¼Œæˆ‘ä»¬å†³å®šåœ¨ <code>å¼€å‘</code> ç¯èŠ‚ä¹‹åæ·»åŠ äº†ä¸€ä¸ª <code>äº¤å‰æµ‹è¯•/Review/ç”¨æˆ·ä½“éªŒæµ‹è¯•</code> ç¯èŠ‚ã€‚è¿™ä¸ªåŒ…å«ä¸‰å±‚å«ä¹‰, <code>äº¤å‰æµ‹è¯•</code>æ˜¯æŒ‡å®šå…¶ä»–äººæ¥æµ‹è¯•ã€<code>Review</code>æŒ‡çš„æ˜¯ä»£ç å±‚æ¬¡çš„å®¡æŸ¥(ç™½ç›’)ï¼Œ<code>ç”¨æˆ·ä½“éªŒæµ‹è¯•</code>åˆ™æ˜¯ä»ç”¨æˆ·è§’åº¦è§¦å‘è¿›è¡ŒéªŒæ”¶æµ‹è¯•(é»‘ç›’)ã€‚</p><p><br></p><p>ä¸‹é¢æ˜¯æ”¹è¿›åçš„çœ‹æ¿(<code>è®¾è®¡ -&gt; å¼€å‘ -&gt; äº¤å‰æµ‹è¯•</code>):</p><p><img src="/images/kanban/ourkanban.png" alt></p><p><br></p><h3 id="çœ‹æ¿çš„èŒƒå›´"><a href="#çœ‹æ¿çš„èŒƒå›´" class="headerlink" title="çœ‹æ¿çš„èŒƒå›´"></a>çœ‹æ¿çš„èŒƒå›´</h3><p><img src="/images/kanban/person.png" alt><br><i>é¢œå€¼å¾ˆé«˜çš„ä¸ªäººçœ‹æ¿</i></p><p><br></p><p>ä¸Šé¢çœ‹åˆ°äº†â€™ä¸ªäººçœ‹æ¿â€˜ã€â€™å›¢é˜Ÿçœ‹æ¿â€˜ï¼Œä»¥åŠâ€™ä¸€ä¸ªæ¶µç›–å®Œæ•´è½¯ä»¶å¼€å‘æµç¨‹çš„çœ‹æ¿â€˜ã€‚<strong>ä½ ä¼šå‘ç°çœ‹æ¿åº”ç”¨å¾—éå¸¸å¹¿ï¼Œå¯ä»¥åº”ç”¨äºä¸åŒçš„å±‚æ¬¡ï¼Œè¡¨ç¤ºä»»åŠ¡çš„ç²’åº¦ä¹Ÿä¸ä¸€æ ·</strong>ã€‚</p><p>æˆ‘ä»¬å‰ç«¯å›¢é˜Ÿå†…éƒ¨å°±æœ‰ä¸¤ä¸ªçœ‹æ¿ï¼Œä¸€ä¸ªæ˜¯<code>å‘¨è®¡åˆ’çœ‹æ¿</code>ï¼Œä¸€ä¸ªæ˜¯<code>ä»»åŠ¡çœ‹æ¿</code>ã€‚</p><p><code>å‘¨è®¡åˆ’çœ‹æ¿</code>ä»»åŠ¡ç²’åº¦æ˜¯â€™é¡¹ç›®â€™æˆ–è€…â€™é‡å¤§åŠŸèƒ½â€™ï¼Œç”¨äºè§„åˆ’å’Œè·Ÿè¸ªæ¯å‘¨çš„å¤§æ¦‚ä»»åŠ¡ï¼› è€Œ<code>ä»»åŠ¡çœ‹æ¿</code>åˆ™æ˜¯å„ç§ç»†åŒ–çš„ä»»åŠ¡, ä¾‹å¦‚å°çš„åŠŸèƒ½ã€Bugä¿®å¤ã€ç»†èŠ‚ä¼˜åŒ–. ç²’åº¦å¹³å‡åœ¨1<code>äºº/å¤©</code>ä»¥ä¸‹ï¼Œå¯ä»¥æœ€å¤§ç¨‹åº¦è¿˜åŸæ¯ä¸ªå¼€å‘æˆå‘˜çš„å¼€å‘ç°åœºã€‚</p><p><br></p><p>åœ¨å›¢é˜Ÿåä½œå±‚é¢, æˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ª<code>ç ”å‘çœ‹æ¿</code>ï¼Œè¿™ä¸ªå’Œç¬¬ä¸€ä¸ªçœ‹æ¿ä¾‹å­ç›¸ä¼¼ï¼Œè¿˜åŸä¸€ä¸ªåº”ç”¨å®Œæ•´çš„ç ”å‘æµç¨‹ï¼Œæ¯ä¸ªå›¢é˜Ÿå ç”¨çœ‹æ¿ä¸Šé¢çš„ä¸€æ ï¼Œå±•ç¤ºå’Œè·Ÿè¸ªå›¢é˜Ÿä¹‹é—´çš„ä¿¡æ¯æµåŠ¨:</p><p><img src="/images/kanban/team.png" alt><br><i>ç ”å‘çœ‹æ¿</i></p><p><br></p><h3 id="ä¼˜å…ˆçº§åˆ’åˆ†"><a href="#ä¼˜å…ˆçº§åˆ’åˆ†" class="headerlink" title="ä¼˜å…ˆçº§åˆ’åˆ†"></a>ä¼˜å…ˆçº§åˆ’åˆ†</h3><p>ä¸Šé¢æˆ‘ä»¬<code>å›¢é˜Ÿçœ‹æ¿</code>ä¸­ï¼Œæœ‰å‡ ä¸ªæ¯”è¾ƒç‰¹æ®Šçš„æ : <code>è®¡åˆ’</code>/<code>æœ¬å‘¨å¾…åŠ</code>/<code>ç¼“å†²åŒº</code>ã€‚ä¸»è¦æ ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†ç»™ä»»åŠ¡åˆ’åˆ†ä¼˜å…ˆçº§ï¼Œè®©å›¢é˜Ÿä¸“æ³¨äºç›®å‰åº”è¯¥ä¼˜å…ˆå¤„ç†çš„ä»»åŠ¡ã€‚</p><p>çœ‹æ¿ä¸­ä¼˜å…ˆçº§å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼æ¥å¤„ç†:</p><p><strong>1. æ‹†åˆ†çœ‹æ¿</strong>:</p><p>ä¾‹å¦‚ä¼˜å…ˆçº§æ’åº <code>ç¼“å†²åŒº</code> &gt; <code>æœ¬å‘¨å¾…åŠ</code> &gt; <code>è®¡åˆ’</code></p><ul><li><strong>è®¡åˆ’</strong> - è¿‘æœŸéœ€è¦è¿›è¡Œçš„ä»»åŠ¡ï¼Œæœ‰äº›ä»»åŠ¡ä¼˜å…ˆçº§å¾ˆä½ï¼Œå¯èƒ½ä¸€å¹´åŠè½½éƒ½ä¸ä¼šå¤„ç†ã€‚è¿™ä¸€æ æœ‰ç‚¹åƒå¤‡å¿˜å½•</li><li><strong>å‘¨è®¡åˆ’</strong> - ä»è®¡åˆ’æ ä¸­ç­›é€‰éƒ¨åˆ†ä»»åŠ¡ï¼Œä½œä¸ºæœ¬å‘¨çš„â€™å¼€å‘ç›®æ ‡â€˜ã€‚è¡¨ç¤ºæœ¬å‘¨è®¡åˆ’è¦å®Œæˆçš„äº‹æƒ…</li><li><strong>ç¼“å†²åŒº</strong> - ä»å‘¨è®¡åˆ’ä¸­ç­›é€‰ä¼˜å…ˆçº§æœ€é«˜çš„ä»»åŠ¡ï¼Œéœ€è¦ä¼˜å…ˆè¢«å¤„ç†</li><li><strong>å·²å®Œæˆ(å‘¨ç»“æŸæ—¶é—´)</strong> æ”¾ç½®æ¯å‘¨å·²å®Œæˆçš„ä»»åŠ¡, è¿™ä¸ªå’Œå‘¨è®¡åˆ’ç›¸å¯¹åº”ï¼Œå¯ä»¥åé¦ˆâ€™å‘¨è®¡åˆ’â€˜å®Œæˆçš„è¿›åº¦ã€‚</li></ul><p>æˆ‘ä»¬é€šå¸¸ä¼šæ¯å‘¨â€™å½’æ¡£â€˜ä¸€æ¬¡<code>å·²å®Œæˆ</code>æ ã€‚å¦‚æœä½¿ç”¨<code>Tower</code>ï¼Œå¯ä»¥é€šè¿‡â€™æŸ¥çœ‹å½’æ¡£â€˜ï¼Œè·å–æ‰€æœ‰çš„ä»¥å‘¨ä¸ºå•ä½çš„å†å²è®°å½•</p><p><img src="/images/kanban/arch.png" alt></p><p><br></p><p><strong>2. è®¾ç½®ä»»åŠ¡ä¼˜å…ˆçº§</strong></p><p>åœ¨ä»»åŠ¡å±‚çº§ä¹Ÿå¯ä»¥è®¾å®šç‰¹æ®Šçš„æ ‡ç­¾ï¼Œæ¥æ ‡è®°ä»»åŠ¡çš„ä¼˜å…ˆçº§ã€‚å¦å¤–ä¹Ÿå¯ä»¥å°†é«˜ä¼˜å…ˆçº§ä»»åŠ¡æ’åœ¨é˜Ÿåˆ—å‰é¢, è¡¨ç¤ºä»»åŠ¡çš„ä¼˜å…ˆçº§</p><p>ä¸‹å›¾ä½¿ç”¨ <code>Tower</code> å¯ä»¥ä¸ºä»»åŠ¡è®¾ç½®ä¼˜å…ˆçº§ï¼Œå®ƒä¼šä½¿ç”¨ä¸åŒçš„é¢œè‰²æ¥æ ‡æ³¨å®ƒ:</p><p><img src="/images/kanban/create-task.png" alt></p><p><br></p><h3 id="æ¨æ¨¡å‹-push-ä¸æ‹‰æ¨¡å‹-pull"><a href="#æ¨æ¨¡å‹-push-ä¸æ‹‰æ¨¡å‹-pull" class="headerlink" title="æ¨æ¨¡å‹(Push)ä¸æ‹‰æ¨¡å‹(Pull)"></a>æ¨æ¨¡å‹(Push)ä¸æ‹‰æ¨¡å‹(Pull)</h3><p>è¿˜æ˜¯<a href="https://coolshell.cn" target="_blank" rel="noopener">å·¦è€³æœµè€—å­</a>, ä»–åœ¨æŸæœŸèŠ‚ç›®æåˆ°çš„â€™x å‹äººæ‰å’Œy å‹äººæ‰è®ºâ€˜ï¼Œè®©æˆ‘å°è±¡æ·±åˆ», ä»–æŒ‡å‡ºäººæ‰å¯ä»¥åˆ†ä¸ºä¸¤ç§:</p><ul><li>x å‹äººæ‰: ç»™ä»»åŠ¡å°±åšï¼Œä¸ç»™ä»»åŠ¡å°±ä¸çŸ¥é“åšä»€ä¹ˆ</li><li>y å‹äººæ‰: è‡ªé©±åŠ¨ã€æ‹¥æœ‰è‡ªä¸»æ€§å’Œä¸»åŠ¨æ€§ï¼Œå¯¹ä¼ä¸šæœ‰å½’å®¿æ„Ÿã€‚è¿™ç§äººé€‚åˆåšç®¡ç†è€…</li></ul><p>å¤§éƒ¨åˆ†äººéƒ½æ˜¯xå‹äººæ‰ï¼Œæ‰€ä»¥ä¼ä¸šéœ€è¦èŠ±é«˜ä¸€ç‚¹çš„è–ªé…¬é›‡ä½£yå‹äººæ‰æ¥ç®¡ç†å’Œé©±åŠ¨xå‹äººæ‰ã€‚ ä½†æˆ‘è®¤ä¸ºè¿™ä¸æ˜¯å¤©ç”Ÿçš„ï¼Œåœ¨åå¤©ç»™äºˆä¸€å®šçš„è´£ä»»å’Œé¼“åŠ±ï¼Œæˆ–è€…åœ¨æŸäº›ç®¡ç†æœºåˆ¶ä¸‹ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æˆä¸º y å‹äººæ‰ï¼Œç”šè‡³æˆä¸º y å‹å›¢é˜Ÿã€‚å¾ˆå¤šæ•æ·ç†è®ºå°±æ¨å´‡â€™å›¢é˜Ÿè‡ªæ²»â€˜ã€å¸Œæœ›å›¢é˜Ÿä»¥åŠæˆå‘˜å¯ä»¥<strong>è‡ªæˆ‘é©±åŠ¨</strong>ï¼Œæ¨åŠ¨ä¸šåŠ¡çš„å‘å±•ã€‚<code>æ‹‰æ¨¡å¼</code>ä¹Ÿèƒ½ä½“ç°è¿™ç§æ€æƒ³.</p><p>ä¼ ç»Ÿå›¢é˜Ÿéƒ½ä½¿ç”¨æ¨æ¨¡å¼ï¼Œç”±Leaderå°†ä»»åŠ¡åˆ†é…ç»™å›¢é˜Ÿæˆå‘˜, æŒ‡å®šå®Œæˆçš„æ—¶é—´å’Œå„ç§æŒ‡æ ‡ã€‚è¿™ç§æ–¹å¼ä¹Ÿç§°ä¸º<code>æ¨åŠ¨ç³»ç»Ÿ(Push System)</code>,  å®ƒä¸€èˆ¬ä¾èµ–äºæ—¶é—´çš„æ’å®šï¼Œæ—¶é—´åˆ°äº†å°±è¢«â€™è¢«åŠ¨åœ°â€˜æ¨åŠ¨å»åšæŸäº›äº‹æƒ….</p><p>è€Œçœ‹æ¿éå¸¸é€‚åˆæ‹‰æ¨¡å¼ã€‚æ‰€ä»¥çœ‹æ¿ä¹Ÿè¢«ç§°ä¸º<code>ä¿¡å·æ¿(Signal)</code>, ä½ å¯ä»¥å°†ä»»åŠ¡å½“åšä¸€ä¸ªâ€™äº‹ä»¶â€˜ï¼Œç”±äº‹ä»¶æ¥é©±åŠ¨å·¥ä½œ(ç±»ä¼¼ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼)ã€‚è¿™è¿˜æ˜¯æœ‰ç‚¹åƒå·¥å‚çš„æµæ°´çº¿ï¼Œä¸Šæ¸¸çš„äº§å‡ºå°±æ˜¯ä¸€ç§â€™äº‹ä»¶â€˜ï¼Œä¸‹æ¸¸ä¸»åŠ¨å»æ‹‰å–ä¸Šæ¸¸çš„ç‰©ä»¶è¿›è¡Œå¤„ç†.</p><p>è¿™ç§æ¨¡å¼çš„å¥½å¤„æ˜¯ï¼ŒLeaderä¸éœ€è¦å†å»å…³å¿ƒç»†å¾®çš„å·¥ä½œåˆ†é…å’Œå†³ç­–ï¼Œè®©å›¢é˜Ÿæˆå‘˜è‡ªå·±æœ‰æ•ˆåœ°å®‰æ’äº‹ä»¶ã€‚å¦å¤–è¿™ä¹Ÿå¯ä»¥é¿å…å‡ºç°è¿™æ ·ä¸€ç§æƒ…å†µï¼šå›¢é˜Ÿæˆå‘˜åªç†Ÿæ‚‰å…¶ä¸­æŸäº›é¡¹ç›®ï¼Œæˆ–è€…åªä¼šåšã€åªè´Ÿè´£ä¸€ç±»äº‹æƒ…ã€‚è¿™ä½¿å¾—æˆå‘˜ç¦»å²—æ—¶ï¼Œå›¢é˜Ÿä¼šå˜å¾—æ¯”è¾ƒè¢«åŠ¨ï¼Œå› ä¸ºå…¶ä»–æˆå‘˜å¯¹ç¦»å²—æˆå‘˜çš„å·¥ä½œæƒ…å†µä¸ç†Ÿæ‚‰ã€‚å› æ­¤æ‹‰åŠ¨æ¨¡å¼ï¼Œä¹Ÿå¯ä»¥è®©å›¢é˜Ÿæˆå‘˜ç¦»å¼€è‡ªå·±çš„èˆ’é€‚åŒºï¼Œå‚ä¸å’Œç†Ÿæ‚‰å„ç§é¡¹ç›®</p><p>æˆ‘ä»¬ç›®å‰ä½¿ç”¨çš„æ˜¯<strong>æ··åˆå‹</strong>, æœ‰äº›ä»»åŠ¡æ˜¯æå‰æŒ‡æ´¾åˆé€‚çš„äººå»åšçš„ï¼Œè€Œå¦‚æœçœ‹æ¿ä¸­æ²¡æœ‰æŒ‡å®šè´Ÿè´£äººï¼Œè¿™ä¸ªä»»åŠ¡å°±å¯ä»¥ç”±ä»»ä½•äººæ¥è´Ÿè´£ï¼Œæ¨æ‹‰ç»“åˆã€‚</p><p><br></p><h3 id="æš´éœ²ç“¶é¢ˆ"><a href="#æš´éœ²ç“¶é¢ˆ" class="headerlink" title="æš´éœ²ç“¶é¢ˆ"></a>æš´éœ²ç“¶é¢ˆ</h3><p>æµç¨‹ä¸Šçš„å¤šä¸ªç¯èŠ‚ä¼šåƒç®¡é“(pipe)ä¸€æ ·ï¼Œé€šè¿‡è¾“å…¥è¾“å‡ºè¿æ¥åœ¨ä¸€èµ·:</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tasks -&gt; (æµç¨‹1) -&gt; (æµç¨‹2) -&gt; Done</span><br></pre></td></tr></table></figure><p>ä¸Šä¸€ä¸ªæµç¨‹çš„è¾“å‡º(Done)ï¼Œå°±æ˜¯ä¸‹ä¸€ä¸ªæµç¨‹çš„è¾“å…¥(Todo). æŒ‰ç…§ç†æƒ³çš„çŠ¶æ€ï¼Œä¿¡æ¯æµåº”è¯¥æ˜¯æµç•…ã€å¹³ç¨³åœ°åœ¨ç®¡é“ä¸Šæµæ·Œçš„ã€‚å¦‚æœæŸä¸ªç¯èŠ‚å‡ºç°ç“¶é¢ˆï¼Œé‚£ä¹ˆå¯èƒ½ä¼šå¯¼è‡´å¿™çš„å¿™æ­»ï¼Œé—²çš„é—²æ­»ã€‚</p><p>å¦‚æœä½ æœ‰ç»†å¿ƒæ€è€ƒï¼Œçœ‹æ¿çš„æµç¨‹ç®¡ç†æ–¹å¼æœ‰ç‚¹åƒâ€™å·¥å‚çš„æµæ°´çº¿ä½œä¸šâ€˜ï¼Œå¦‚æœæŸä¸ªç¯èŠ‚é˜»å¡ï¼Œè¿™ä¸ªç¯èŠ‚å°±ä¼šå †ç§¯å¾ˆå¤šå…ƒä»¶ï¼Œè€Œä¸‹æ¸¸åˆ™ä¼šå‡ºç°ç©ºé—²ç­‰å¾…æƒ…å†µ, è€Œè¯¥ç¯èŠ‚çš„ä¸Šæ¸¸ä¹Ÿä¼šè¢«é˜»å¡ã€‚</p><p><br></p><p><strong>é€šè¿‡çœ‹æ¿çš„ç°åœºè¿˜åŸï¼Œæˆ‘ä»¬å¯ä»¥å®¹æ˜“åœ°å‘ç°è¿™ç§æµç¨‹ä¸Šçš„ç“¶é¢ˆ. æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜</strong>ï¼Ÿ</p><p>è¿™ä¸ªå¯ä»¥ç±»æ¯”ç¨‹åºï¼Œå½“æˆ‘ä»¬å‘ç°ç¨‹åºä¸Šçš„ä¸€ä¸ªæ€§èƒ½é—®é¢˜æ—¶ï¼Œé€šå¸¸æœ‰ä¸¤ä¸ªè§£å†³çš„æ–¹å‘:</p><ul><li>æ˜¯å¦æ˜¯ç®—æ³•é—®é¢˜? èƒ½å¦ä½¿ç”¨æ›´å¥½çš„ç®—æ³•æˆ–è€…è§£å†³æ–¹æ¡ˆï¼Ÿå¯¹åº”åˆ°å¼€å‘ä»»åŠ¡ä¸­ï¼Œè¦è€ƒè™‘ä¸€ä¸‹æ˜¯å¦å®ç°çš„æ–¹æ³•ä¸å¯¹ï¼Ÿ</li><li>å¦‚æœæ˜¯ç¡¬ä»¶çš„ç“¶é¢ˆï¼Œèƒ½å¦æ‰©å±•ç¡¬ä»¶èµ„æºï¼Œå‡çº§å¥½ç‚¹çš„ç¡¬ä»¶ï¼Ÿå¯¹åº”åˆ°å¼€å‘ä»»åŠ¡ä¸­ï¼Œè¦è€ƒè™‘ä¸€ä¸‹æ˜¯å¦è¦å¤šåŠ äº›äººæ‰‹ï¼Ÿ</li></ul><p>ä¸‹ä¸€èŠ‚ä¼šä»‹ç»ï¼Œæˆ‘ä¼šä»‹ç»é€šè¿‡è®¾ç½®<code>åœ¨åˆ¶å“</code>æ•°é‡(å¸¦å®½)ï¼Œè®©çœ‹æ¿æ›´å®¹æ˜“åœ°æš´éœ²ç“¶é¢ˆ.</p><p><br></p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>é€šè¿‡çœ‹æ¿æˆ‘ä»¬å¯ä»¥å¾—åˆ°è¿™äº›å¥½å¤„:</p><ul><li><strong>æµç¨‹å¯è§†åŒ–</strong>: é€šè¿‡çœ‹æ¿å¯ä»¥çœ‹åˆ°ä»»åŠ¡ä¼šç»è¿‡å“ªäº›ç¯èŠ‚ï¼Œå½“å‰åœ¨å“ªä¸ªç¯èŠ‚</li><li><strong>è¿˜åŸå¼€å‘ç°åœº</strong>:<ul><li>ç›´è§‚åœ°è·Ÿè¸ªå¼€å‘çš„è¿›åº¦</li><li>æš´éœ²æµç¨‹ç“¶é¢ˆ</li><li>è´¡çŒ®çœ‹å¾—è§</li></ul></li><li><strong>æ‹‰æ¨¡å¼</strong>: è‡ªæˆ‘é©±åŠ¨</li></ul><p><br><br><br></p><h2 id="ç¬¬äºŒé˜¶ï¼šåœ¨åˆ¶å“é™åˆ¶"><a href="#ç¬¬äºŒé˜¶ï¼šåœ¨åˆ¶å“é™åˆ¶" class="headerlink" title="ç¬¬äºŒé˜¶ï¼šåœ¨åˆ¶å“é™åˆ¶"></a>ç¬¬äºŒé˜¶ï¼šåœ¨åˆ¶å“é™åˆ¶</h2><p>å¤§éƒ¨åˆ†å›¢é˜Ÿå¯¹çœ‹æ¿çš„åº”ç”¨åªåœç•™åœ¨ç¬¬ä¸€é˜¶ï¼Œå³æµç¨‹å¯è§†åŒ–ã€‚çœ‹æ¿çš„é­…åŠ›è¿œä¸æ­¢äºæ­¤ã€‚ç¬¬äºŒä¸ªé˜¶æ®µï¼Œæˆ‘ä»¬è¦å¼€å§‹é™åˆ¶åœ¨åˆ¶å“çš„æ•°é‡ã€‚</p><p><br></p><h3 id="ä»€ä¹ˆæ˜¯åœ¨åˆ¶å“"><a href="#ä»€ä¹ˆæ˜¯åœ¨åˆ¶å“" class="headerlink" title="ä»€ä¹ˆæ˜¯åœ¨åˆ¶å“"></a>ä»€ä¹ˆæ˜¯åœ¨åˆ¶å“</h3><p>åœ¨åˆ¶å“(Work-In-Process WIP), ä¹Ÿç§°ä¸ºåŠæˆå“ã€‚é¡¾åæ€ä¹‰å°±æ˜¯éƒ¨åˆ†æœªå®Œæˆçš„ä»»åŠ¡ã€‚</p><p><img src="/images/kanban/wip.jpg" alt></p><p>åœ¨çœ‹æ¿ä¸­, ä¸€äº›æ ä¼šæœ‰åœ¨åˆ¶å“é™åˆ¶ï¼Œç”¨äº<strong>é™åˆ¶è¯¥ç¯èŠ‚â€™åŒæ—¶â€˜å¯ä»¥å¤„ç†çš„äº‹æƒ…</strong>ã€‚æ¢å¥è¯è¯´å°±æ˜¯é™åˆ¶æŸä¸ªç¯èŠ‚çš„â€™æµé‡å¸¦å®½â€˜ï¼Œæˆ–è€…è¯´èŠ‚æµ.</p><p><br></p><h3 id="ä¸ºä»€ä¹ˆé™åˆ¶åœ¨åˆ¶å“"><a href="#ä¸ºä»€ä¹ˆé™åˆ¶åœ¨åˆ¶å“" class="headerlink" title="ä¸ºä»€ä¹ˆé™åˆ¶åœ¨åˆ¶å“?"></a>ä¸ºä»€ä¹ˆé™åˆ¶åœ¨åˆ¶å“?</h3><p><strong>1. æ›´å¿«æš´éœ²ç“¶é¢ˆ</strong></p><p>å°½ç®¡åœ¨â€™ç¬¬ä¸€é˜¶â€™æ—¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è¯†åˆ«å‡ºæµç¨‹çš„ç“¶é¢ˆï¼Œä½†å¹¶ä¸æ˜¯ç‰¹åˆ«ç›´è§‚ï¼Œè‡³å°‘ä»çœ‹æ¿ä¸Šè¾ƒéš¾å¯Ÿè§‰ã€‚ä½ å¯èƒ½è¦è¯¦ç»†è·Ÿè¸ªè¯¢é—®ï¼Œæ‰èƒ½äº†è§£å“ªä¸ªæµç¨‹å¡ä½äº†ã€‚</p><p>é™åˆ¶äº†WIPåï¼Œæ¯ä¸ªç¯èŠ‚çš„å¸¦å®½æ˜¯å›ºå®šçš„ï¼Œæ¯”å¦‚â€™æµ‹è¯•â€˜ç¯èŠ‚çš„WIPé™åˆ¶æ˜¯6ï¼Œå¦‚æœâ€™æµ‹è¯•â€˜ç¯èŠ‚åˆ°è¾¾é™åˆ¶ï¼Œä¸Šæ¸¸å°±æ²¡åŠæ³•ç»™å®ƒå¡å…¶ä»–ä»»åŠ¡äº†ã€‚è¿™å°±æš´éœ²äº†â€™æµ‹è¯•â€™ç¯èŠ‚çš„ç“¶é¢ˆ</p><p><strong>æ€ä¹ˆè®¾å®šWIPçš„é™åˆ¶é¢ä¹Ÿæ˜¯æ¯”è¾ƒé‡è¦çš„ï¼Œè®¾ç½®å¤ªå°ï¼Œä¼šå¯¼è‡´å¹¶å‘å¤„ç†çš„ä»»åŠ¡é‡å˜å°ï¼Œèµ„æºå¯èƒ½å¾—ä¸åˆ°åˆ©ç”¨ï¼Œå¤ªå¤§åˆä¸å®¹æ˜“æš´éœ²ç“¶é¢ˆ</strong>ã€‚ä¸‹èŠ‚ä¼šä»‹ç»å¦‚ä½•è®¾ç½®WIP.</p><p><br></p><p><strong>2. é¿å…ä¸­æ–­ï¼Œé¿å…ä¸Šä¸‹æ–‡åˆ‡æ¢</strong></p><p>é™åˆ¶WIPçš„å¦ä¸€ä¸ªå¥½å¤„ï¼Œæ˜¯å‡å°‘æˆå‘˜å¹¶å‘å¤„ç†å¤šä¸ªä»»åŠ¡çš„æ•°é‡ã€‚</p><p>å’Œè®¡ç®—æœºçš„è¿›ç¨‹ä¸€æ ·ï¼Œè¿›ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ä»£ä»·æ˜¯æ¯”è¾ƒå¤§çš„ã€‚å¯¹äºå¼€å‘è€…æ¥è¯´ï¼Œä»»åŠ¡ä¸­æ–­ã€ä»»åŠ¡è°ƒæ¢ä¹Ÿä¼šæµªè´¹åˆ‡æ¢çš„æ—¶é—´ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦è°ƒæ•´/å›é¡¾æ€è·¯æ¥æŠ•å…¥æ–°çš„ä»»åŠ¡æµç¨‹ã€‚</p><p>æ‰€ä»¥è¯´é€šè¿‡é™åˆ¶WIPï¼Œå¯ä»¥è®©æˆå‘˜ä¸“æ³¨äºæ­£åœ¨å¤„ç†çš„ä»»åŠ¡ï¼Œåšå®Œè¿™ä¸ªä»»åŠ¡å†å»æ‹‰å–æ–°çš„ä»»åŠ¡ã€‚</p><p><br></p><p><strong>3. ç›ˆä½™æ—¶é—´</strong></p><p>å½“ä¸‹æ¸¸å‡ºç°é˜»å¡ï¼Œä¸Šæ¸¸æˆ–ä¸‹æ¸¸å¯èƒ½å°±ä¼šå‡ºç°<code>ç›ˆä½™æ—¶é—´</code>ã€‚è¿™äº›ç›ˆä½™æ—¶é—´çœ‹èµ·æ¥åƒæµªè´¹ï¼Œå…¶å®å¯¹äºå¼€å‘è€…æˆ–å›¢é˜Ÿæ¥è¯´ï¼Œå¯ä»¥åšå¾ˆå¤šäº‹æƒ…ã€‚æ¯”å¦‚:</p><ul><li><strong>ä¼‘æ¯/å­¦ä¹ </strong>:<br>å¯ä»¥åˆ©ç”¨è¿™æ®µæ—¶é—´æ¥å­¦ä¹ ã€‚å¯¹äºå‰ç«¯æ¥è¯´ï¼Œå¿…é¡»ä¸æ–­çš„å­¦ä¹ ï¼Œæé«˜è‡ªå·±çš„æ°´å¹³å’Œç«äº‰åŠ›ï¼Œè¿™å¯¹é¡¹ç›®å¼€å‘ä¹Ÿæ˜¯æœ‰ç›Šå¤„çš„. åœ¨996è¿™ç§ç¯å¢ƒä¸‹ï¼Œä¼ä¸šå®¶é€æ¸å‰¥å¤ºäº†æˆ‘ä»¬ç”Ÿäº§ç”Ÿäº§åŠ›çš„èƒ½åŠ›ã€‚</li><li><strong>å¸®åŠ©è§£å†³ç“¶é¢ˆ</strong>:<br>ä¸‹æ¸¸å‡ºç°ç“¶é¢ˆäº†ï¼Œæˆ‘ä»¬å¯ä»¥åœä¸‹æ¥ï¼Œå¸®åŠ©ä»–ä»¬è§£å†³é—®é¢˜ã€‚ä¾‹å¦‚å…¶ä»–åŒäº‹å› ä¸ºæŸäº›é—®é¢˜å¡ä½ï¼Œæˆ‘ä»¬å¯ä»¥å¸®åŠ©ä»–ä¸€èµ·è§£å†³é—®é¢˜ï¼›å†æ¯”å¦‚ä¸‹æ¸¸æµ‹è¯•ç¯èŠ‚å‡ºé—®é¢˜äº†ï¼Œæˆ‘ä»¬å¯ä»¥ä¸€èµ·è¿›è¡Œæµ‹è¯•ã€‚ä½œä¸ºä¸€ä¸ªå›¢é˜Ÿé½æ­¥å‘å‰ï¼Œå˜ç›¸æé«˜å›¢é˜Ÿå‡èšåŠ›å’Œè´£ä»»å¿ƒ</li><li><strong>ä¼˜åŒ–</strong>:<br>åæ€æµç¨‹é—®é¢˜ï¼Œè€ƒè™‘å¦‚æœæé«˜äº§èƒ½</li><li><strong>å…¶ä»–äº‹æƒ…</strong>:<br>æ¯”å¦‚å¯ä»¥è¿›è¡Œäº¤å‰æµ‹è¯•å’Œå†™æ–‡æ¡£ï¼Œä¼˜åŒ–å¼€å‘å·¥å…·</li></ul><p><br></p><h3 id="wipè¦é™åˆ¶å¤šå°‘"><a href="#wipè¦é™åˆ¶å¤šå°‘" class="headerlink" title="WIPè¦é™åˆ¶å¤šå°‘?"></a>WIPè¦é™åˆ¶å¤šå°‘?</h3><p>åœ¨åˆ¶å“é™åˆ¶å€¼ä¸æ˜¯å…·ä½“å¯è®¡ç®—çš„ï¼Œéœ€è¦é•¿æœŸç»éªŒç§¯ç´¯å’Œç£¨åˆæ‰èƒ½å®šä¸‹ä¸€ä¸ªåˆé€‚çš„å€¼. å€¼è¶Šå°ï¼Œæˆå‘˜å¯ä»¥æ›´ä¸“æ³¨äºå½“å‰çš„äº‹æƒ…ï¼Œå¢å¼ºæˆå‘˜ä¹‹é—´çš„åä½œã€‚å€¼è¶Šå¤§ï¼Œå¯ä»¥å¤„ç†çš„äº‹æƒ…æ›´å¤šï¼Œä»»åŠ¡è°ƒåº¦ä¼šæ›´ä¸ºçµæ´»ã€‚</p><p>ä¸€ä¸ªåŸºäºç»éªŒçš„ã€æŠ˜ä¸­çš„å…¬å¼æ˜¯ï¼š <code>åœ¨åˆ¶å“ä¸Šé™ = å›¢é˜Ÿè§„æ¨¡ * 2 -1</code>ã€‚</p><p><br><br><br></p><h2 id="ç¬¬ä¸‰é˜¶-ç»“åˆscrum"><a href="#ç¬¬ä¸‰é˜¶-ç»“åˆscrum" class="headerlink" title="ç¬¬ä¸‰é˜¶: ç»“åˆScrum"></a>ç¬¬ä¸‰é˜¶: ç»“åˆScrum</h2><p><a href="https://zh.wikipedia.org/zh-hans/Scrum" target="_blank" rel="noopener"><code>Scrum</code></a> ä¹Ÿæ˜¯ä¸€ä¸ªæ•æ·æ¡†æ¶. å®ƒçš„è§„åˆ™éå¸¸ç®€å•ï¼Œä½†æ˜¯è¦ç²¾é€šéå¸¸éš¾ã€‚æ‰€ä»¥ç¬¬ä¸‰é˜¶æ®µï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•å°† <code>Scrum</code> çš„æŸäº›è§„åˆ™èåˆåˆ°çœ‹æ¿çš„ç®¡ç†æµç¨‹ä¸­</p><p><br></p><h3 id="ç®€å•ä»‹ç»ä¸€ä¸‹scrum"><a href="#ç®€å•ä»‹ç»ä¸€ä¸‹scrum" class="headerlink" title="ç®€å•ä»‹ç»ä¸€ä¸‹Scrum"></a>ç®€å•ä»‹ç»ä¸€ä¸‹Scrum</h3><p><img src="/images/kanban/scrum.png" alt></p><p>ä¸Šå›¾ä¸€ä¸ªå…¸å‹çš„ <code>Scrum</code> æµç¨‹.</p><p>ç®€è€Œè¨€ä¹‹ï¼Œ<code>Scrum</code> é¦–å…ˆä¼šå°†åº”ç”¨å¼€å‘è¿‡ç¨‹æ‹†åˆ†ä¸ºå¤šä¸ªè¿­ä»£å‘¨æœŸï¼Œè¿™ä¸ªè¿­ä»£å‘¨æœŸç§°ä¸º <code>Sprint</code> (ä¸€ä¸ªå†²åˆº)ï¼Œå‘¨æœŸä¸€èˆ¬ä¸º1-4å‘¨ã€‚</p><p><br></p><p><img src="/images/kanban/backlog.png" alt></p><p>åœ¨æ¯æ¬¡å¼€å§‹ä¸€ä¸ªå†²åˆºæ—¶ï¼Œä¼šä»<code>åŠŸèƒ½åˆ—è¡¨</code>(Product Backlog)ä¸­ï¼ŒæŒ‰ç…§ä¼˜å…ˆçº§å’Œæ—¶é—´è¯„ä¼°ç­›é€‰å‡ºè¿™ä¸ªå†²åˆºå¯ä»¥å®Œæˆçš„ä»»åŠ¡åˆ—è¡¨ï¼Œç§°ä¸º<code>å†²åˆºåˆ—è¡¨</code>(Sprint Backlog); æ¥ç€å°±åœ¨è¿™ä¸ªè¿­ä»£å‘¨æœŸé‡Œä¸“å¿ƒå®Œæˆè¿™äº›ä»»åŠ¡</p><p>å¦å¤– <code>Scrum</code> è¿˜å®šä¹‰äº†å„ç§<code>æ´»åŠ¨</code>, æ¥è¿›è¡ŒæŒç»­çš„åé¦ˆå’Œè°ƒæ•´ï¼Œ ä¾‹å¦‚:</p><ul><li><strong>Sprintè®¡åˆ’ä¼šè®®</strong> - åœ¨å¼€å§‹ä¸€ä¸ªå†²åˆºå‰ï¼Œè®¡åˆ’ä¸€ä¸ªå‘¨æœŸå†…éœ€è¦åšå“ªäº›ä»»åŠ¡ï¼Œå¯¹ä»»åŠ¡è¿›è¡Œæ—¶é—´è¯„ä¼°</li><li><strong>æ¯æ—¥ç«‹ä¼š</strong> - åŒæ­¥å¼€å‘è¿›åº¦ã€å‘ç°å¼€å‘ä¸­çš„éšœç¢ã€å¢åŠ äº¤æµå’Œæ²Ÿé€š</li><li><strong>è¯„å®¡ä¼šè®®</strong> - åœ¨å†²åˆºç»“æŸæ—¶ä¸¾è¡Œï¼Œç”¨äºæ£€æŸ¥è®¡åˆ’ä¸­çš„å·¥ä½œï¼Œå“ªäº›å®Œæˆäº†ï¼Œå“ªäº›æ²¡æœ‰å®Œæˆã€‚æœ‰äº›å›¢é˜Ÿä¼šè®©åŠŸèƒ½çš„è´Ÿè´£äººæ¼”ç¤ºè‡ªå·±æ‰€åšçš„åŠŸèƒ½ï¼Œç„¶å PM ä¼šçœ‹è¿™ä¸ªåŠŸèƒ½æ˜¯å¦è¾¾åˆ°äº†è¦æ±‚</li><li><strong>å›é¡¾ä¼šè®®</strong> - åœ¨å†²åˆºç»“æŸæ—¶ä¸¾è¡Œï¼Œå›é¡¾å’Œåçœæœ¬æ¬¡è¿­ä»£é‡åˆ°çš„é—®é¢˜ã€ä»¥åŠå¦‚ä½•æ”¹è¿›</li></ul><p>å¦å¤–ï¼Œ<code>Scrum</code>è¿˜å®šä¹‰äº†å„ç§è§’è‰²å’Œä»·å€¼è§‚ã€‚è¿™äº›ä¸åœ¨æœ¬æ–‡çš„èŒƒå›´ä¹‹å†…ï¼Œæˆ‘ä»¬ä¹Ÿä¸ä¼šå…¨éƒ¨ç…§æ¬. æœ‰å…´è¶£çš„è¯»è€…å¯ä»¥æŸ¥çœ‹å‚è€ƒæ–‡çŒ®</p><p><br></p><h3 id="èåˆåˆ°çœ‹æ¿ä¸­"><a href="#èåˆåˆ°çœ‹æ¿ä¸­" class="headerlink" title="èåˆåˆ°çœ‹æ¿ä¸­"></a>èåˆåˆ°çœ‹æ¿ä¸­</h3><h4 id="è®¾å®šå¼€å‘å‘¨æœŸ"><a href="#è®¾å®šå¼€å‘å‘¨æœŸ" class="headerlink" title="è®¾å®šå¼€å‘å‘¨æœŸ"></a>è®¾å®šå¼€å‘å‘¨æœŸ</h4><p>ç€‘å¸ƒå¼å’Œæ•æ·çš„æ˜æ˜¾åŒºåˆ«å°±æ˜¯å¼€å‘æµç¨‹åˆ†å‰²æˆå¤šä¸ªè¿­ä»£è¿‡ç¨‹ã€‚æŒ‰<code>Scrum</code>çš„å®šä¹‰å°±æ˜¯ä¸€ä¸ªâ€™å†²åˆºâ€˜.</p><p>åœ¨æˆ‘ä»¬å®é™…çš„å¼€å‘ä¸­ï¼Œä¼šä»¥ä¸€ä¸ªæ˜ŸæœŸä½œä¸ºä¸€ä¸ªå¼€å‘å‘¨æœŸã€‚æˆ‘è§‰çš„ä¸€å‘¨çš„æ—¶é—´åˆšåˆšå¥½ï¼Œæ—¶é—´å¤ªé•¿å¾ˆéš¾å¯¹ä»»åŠ¡æ—¶é—´è¿›è¡Œè¯„ä¼°ï¼Œè€Œä¸”æœªçŸ¥å› ç´ ä¹Ÿä¼šæ›´å¤š.</p><p><img src="/images/kanban/sprint.png" alt></p><p>åœ¨ä¸€ä¸ªæ˜ŸæœŸå¼€å§‹å‰ï¼Œä»â€™è®¡åˆ’â€˜æ ä¸­ç­›é€‰æœ¬å‘¨è¦è¿›è¡Œä»»åŠ¡ï¼Œæ‹–è¿›â€™æœ¬å‘¨å¾…åŠâ€™æ ã€‚è¿™ä¸ªè¿‡ç¨‹å°±æœ‰ç‚¹åƒ <code>Scrum</code> çš„<code>è®¡åˆ’ä¼šè®®</code></p><p><br></p><h4 id="æ¯æ—¥å›é¡¾"><a href="#æ¯æ—¥å›é¡¾" class="headerlink" title="æ¯æ—¥å›é¡¾"></a>æ¯æ—¥å›é¡¾</h4><p>ç¬”è€…æ¯å¤©å¼€å§‹å·¥ä½œæ—¶ï¼Œå°±ä¼šå°†å›¢é˜Ÿæˆå‘˜èšé›†åœ¨ä¸€èµ·ï¼Œå¯¹ç€çœ‹æ¿ç®€å•è¯¢é—®ä»»åŠ¡å¼€å‘çš„è¿›åº¦ï¼Œå›é¡¾æ˜¨æ—¥çš„å·¥ä½œï¼Œçœ‹æ˜¯å¦å‡ºç°éšœç¢ã€‚å¦‚æœæœ‰éšœç¢åˆ™åŠæ—¶å¤„ç†éšœç¢ï¼Œå¦‚æœä»»åŠ¡è¶…å‡ºé¢„æœŸï¼Œåˆ™è€ƒè™‘æ˜¯å¦åº”è¯¥é‡æ–°è°ƒæ•´è®¡åˆ’ã€‚</p><p>æ€»ä¹‹å°±æ˜¯å°½æ—©æš´éœ²é—®é¢˜ï¼Œä¿è¯æµç¨‹çš„é¡ºç•…ã€‚åœ¨è¿™é‡Œ<strong>çœ‹æ¿å°±æ˜¯ä¸€ç§é‡è¦çš„æ²Ÿé€šå·¥å…·</strong>ã€‚æ¯æ—¥è¯¢é—®çš„æ—¶é—´éƒ½å¾ˆçŸ­ï¼Œä¸€èˆ¬éƒ½ä¸è¶…è¿‡10åˆ†é’Ÿï¼Œè¿™ä¸ªè¿‡ç¨‹æœ‰ç‚¹åƒ <code>Scrum</code> çš„æ¯æ—¥ç«‹ä¼š</p><p>åœ¨<code>Tower</code>ä¸­ï¼Œå®Œæˆä»»åŠ¡åæˆ‘ä»¬ä¸ä¼šç›´æ¥å°†å¡ç‰‡æ‹–å…¥å·²å®Œæˆåˆ—è¡¨ï¼Œè€Œæ˜¯åœ¨æœ€åä¸€ä¸ªç¯èŠ‚ç‚¹å‡»â€™å·²å®Œæˆâ€˜ï¼Œè¿™æ ·æ–¹ä¾¿æ¬¡æ—¥å¯¹å·²å®Œæˆçš„ä»»åŠ¡è¿›è¡Œå›é¡¾ï¼Œå›é¡¾å®Œæˆåå†ç»Ÿä¸€æ‹–å…¥â€™å·²å®Œæˆâ€˜æ </p><p><br></p><h4 id="æµç¨‹ç›‘æ§"><a href="#æµç¨‹ç›‘æ§" class="headerlink" title="æµç¨‹ç›‘æ§"></a>æµç¨‹ç›‘æ§</h4><p><strong>ç‡ƒå°½å›¾</strong></p><p>ç‡ƒå°½å›¾æ˜¯å¸¸è§çš„Scrumè¿›åº¦è·Ÿè¸ªå·¥å…·ã€‚å®ƒçš„å¤–å½¢å¦‚ä¸‹:</p><p><img src="/images/kanban/burndown.png" alt></p><p>æ¨ªè½´ä¸ºå¼€å‘å‘¨æœŸï¼Œçºµè½´ä¸ºä»»åŠ¡é‡. ç†æƒ³çŠ¶æ€ä¸‹ï¼Œä»»åŠ¡é‡åœ¨å‘¨æœŸç»“æŸæ—¶åº”è¯¥å˜ä¸º0ï¼Œä¹Ÿå°±æ˜¯è¯´ç†æƒ³çš„çº¿æ®µæ˜¯ä¸€æ¡å¯¹è§’çº¿(è“çº¿), è¿™ä¹Ÿæ˜¯ä¸€æ¡å‚è€ƒçº¿ã€‚å¦‚æœåœ¨æŸä¸ªæŒ‡å®šæ—¶é—´ç‚¹ï¼Œçº¢çº¿é«˜äºè“çº¿ï¼Œåˆ™è¯´æ˜è¿›åº¦æœ‰äº›å»¶è¿Ÿï¼Œåä¹‹å°±æ˜¯è¶…å‰</p><p>ä½¿ç”¨ç‡ƒå°½å›¾ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šé€šå¸¸ä¼šåœ¨æ¯æ—¥å›é¡¾æ—¶åœ¨ç‡ƒå°½å›¾ä¸Šç»˜åˆ¶ä¸€ä¸ªç‚¹ï¼Œè¡¨ç¤ºæˆªæ­¢åˆ°æ­¤åˆ»æœªå®Œæˆçš„ä»»åŠ¡é‡</p><p><br></p><p><strong>ç´¯è®¡æµé‡å›¾</strong></p><p>ç´¯è®¡æµé‡å›¾ç»Ÿè®¡æ¯ä¸€å¤©æ¯ä¸€æ çš„åœ¨åˆ¶å“æ•°é‡ã€‚ä»è€Œå¯ä»¥åæ˜ ä¸åŒç¯èŠ‚ä»»åŠ¡å¤„ç†é€Ÿç‡ï¼Œä»¥åŠæš´éœ²ç¯èŠ‚ä¹‹é—´çš„ç“¶é¢ˆ:</p><p><img src="/images/kanban/cumulative-flow.png" alt></p><p><br><br><br></p><h2 id="çœ‹æ¿ä¸€æ—¥æ¸¸"><a href="#çœ‹æ¿ä¸€æ—¥æ¸¸" class="headerlink" title="çœ‹æ¿ä¸€æ—¥æ¸¸"></a>çœ‹æ¿ä¸€æ—¥æ¸¸</h2><p>ä¸‹é¢æ¨¡ä»¿ç»å…¸çš„æ–‡ç« <a href="https://blog.crisp.se/2009/06/26/henrikkniberg/1246053060000" target="_blank" rel="noopener">ã€Šçœ‹æ¿ä¸€æ—¥æ¸¸ã€‹</a> å®è·µä¸€ä¸‹æœ¬æ–‡è®²è¿°çš„çœ‹æ¿ä½¿ç”¨æµç¨‹ã€‚æˆ‘ä»¬ä½¿ç”¨çš„å·¥å…·æ˜¯ <code>Tower</code>ï¼Œè¿™ä¸ªä¹Ÿæ˜¯æˆ‘ä»¬å›¢é˜Ÿç›®å‰åœ¨ä½¿ç”¨çš„ï¼ŒåŠŸèƒ½åŸºæœ¬å¤Ÿç”¨ã€‚</p><p><br></p><h3 id="è®¾è®¡çœ‹æ¿"><a href="#è®¾è®¡çœ‹æ¿" class="headerlink" title="è®¾è®¡çœ‹æ¿"></a>è®¾è®¡çœ‹æ¿</h3><p>å‡è®¾æˆ‘ä»¬çš„å‰ç«¯å›¢é˜Ÿæœ‰3ä¸ªäººï¼Œå¼€å‘æµç¨‹æ˜¯è¿™æ ·çš„: <code>å¼€å‘ -&gt; äº¤å‰æµ‹è¯• -&gt; éƒ¨ç½²</code>ã€‚æŒ‰ç…§ä¸Šé¢å­¦åˆ°çš„çŸ¥è¯†ï¼Œæˆ‘ä»¬è®¾è®¡äº†è¿™æ ·çš„çœ‹æ¿å¸ƒå±€:</p><p><img src="/images/kanban/oneday1-1.png" alt></p><p><br></p><h3 id="åˆ›å»ºä»»åŠ¡"><a href="#åˆ›å»ºä»»åŠ¡" class="headerlink" title="åˆ›å»ºä»»åŠ¡"></a>åˆ›å»ºä»»åŠ¡</h3><p>ç°åœ¨ç‚¹å¼€Towerä»»åŠ¡åˆ›å»ºçª—å£. <code>Tower</code> çš„ä»»åŠ¡åŠŸèƒ½å·²ç»éå¸¸ä¸°å¯Œäº†ã€‚ä¸ºäº†æ›´æ–¹é¢å…¶ä»–äººå¤„ç†ä»»åŠ¡ï¼Œæˆ‘ä»¬å¯¹ä»»åŠ¡è¿›è¡Œäº†ä¸€äº›è§„èŒƒ</p><p><img src="/images/kanban/oneday2.png" alt></p><p><br></p><ul><li>â‘  æ ‡é¢˜: <code>ä»¥ [scope] æ¦‚è¿° (æ—¶é—´è¯„ä¼°)</code>. <ul><li><code>scope</code> æ˜¯æŒ‡ä»»åŠ¡çš„èŒƒå›´ï¼Œä¾‹å¦‚é¡¹ç›®Aï¼Œé¡¹ç›®B</li><li><code>æ—¶é—´è¯„ä¼°</code> è¦æ±‚å¯¹è€—æ—¶è¾ƒä¹…çš„ä»»åŠ¡è¿›è¡Œè¯„ä¼°ã€‚æˆ‘ä»¬ä¸€èˆ¬æ¨èä»»åŠ¡çš„ç²’åº¦åœ¨3h åˆ° 2dä¹‹é—´ï¼Œå°äº3hè€ƒè™‘å°†ä»»åŠ¡è¿›è¡Œåˆå¹¶ï¼Œå¤§äº2dåˆ™è€ƒè™‘ç»§ç»­æ‹†åˆ†ä»»åŠ¡</li></ul></li><li>â‘¡ æŒ‡æ´¾è´Ÿè´£äºº: å¯é€‰ï¼Œä¸æŒ‡æ´¾åˆ™è¯´æ˜é‡‡ç”¨æ‹‰æ¨¡å¼</li><li>â‘¢ ä»»åŠ¡çš„Deadline</li><li>â‘£ è®¾ç½®ä»»åŠ¡ä¼˜å…ˆçº§</li><li>â‘¤ è¯¦ç»†è¯´æ˜</li><li>â‘¥ ç»†åŒ–ä»»åŠ¡</li><li>â‘¦ ä¾èµ–ä»»åŠ¡</li><li>â‘§ ä»»åŠ¡æ ‡ç­¾: å¯ä»¥æŒ‡å®šä»»åŠ¡çš„ç±»å‹ï¼Œä¾‹å¦‚åŠŸèƒ½ã€Bugã€ä¼˜åŒ–ã€é‡æ„</li></ul><p><br></p><h3 id="å¼€å§‹å§"><a href="#å¼€å§‹å§" class="headerlink" title="å¼€å§‹å§"></a>å¼€å§‹å§</h3><p><strong>é¦–é€‰è®¡åˆ’ä¸€ä¸‹è¿™å‘¨éœ€è¦è¿™äº›ä»€ä¹ˆ</strong>:</p><p><img src="/images/kanban/oneday3.png" alt></p><p><br></p><p><strong>å¼€å§‹å·¥ä½œï¼ŒæŒ‰ç…§ä¼˜å…ˆçº§æ’åº ï¼Œæ”¾å…¥ç¼“å†²åŒº:</strong></p><p><img src="/images/kanban/oneday4.png" alt></p><p><br></p><p><strong>è®¤é¢†è‡ªå·±çš„ä»»åŠ¡</strong></p><p><img src="/images/kanban/oneday5-1.png" alt></p><p><br></p><p><strong>okï¼Œå®Œæˆäº†ï¼Œæ”¾å…¥ä¸‹ä¸€ä¸ªæ </strong></p><p><img src="/images/kanban/oneday6-1.png" alt></p><p><br></p><p><img src="/images/kanban/oneday7-1.png" alt></p><p><br></p><p><strong>ä¸‹æ¸¸è¾¾åˆ°åœ¨åˆ¶å“é™åˆ¶äº†ï¼Œä¸è¡Œ, å¾—æ¸…ä¸€ä¸‹ï¼Œåœä¸‹æ‰‹åŠ¨çš„å·¥ä½œï¼Œåšä¸€ä¸‹äº¤å‰æµ‹è¯•å§</strong></p><p><img src="/images/kanban/oneday8-1.png" alt></p><p><br></p><p><img src="/images/kanban/oneday9-1.png" alt></p><p><br></p><p><img src="/images/kanban/oneday10-1.png" alt></p><p><strong>æ¬¡æ—¥é—®è¯¢å›é¡¾ï¼Œä»»åŠ¡å®Œæˆçš„è¿˜ä¸é”™ï¼Œæœ‰é‡åˆ°ä»€ä¹ˆé—®é¢˜å—ï¼Ÿå®Œæˆå›é¡¾åå°†ä»»åŠ¡æ­£å¼æ‹–å…¥å·²å®Œæˆ</strong></p><p><img src="/images/kanban/oneday11-1.png" alt></p><p><br></p><p>ğŸ˜«å¥½ç´¯ï¼Œä¸å†™æ€»ç»“äº†ï¼Œå°±è¿™æ ·å§ï¼Œ</p><p>æœ¬æ–‡å®Œï¼</p><p><br></p><h2 id="æ‰©å±•èµ„æ–™"><a href="#æ‰©å±•èµ„æ–™" class="headerlink" title="æ‰©å±•èµ„æ–™"></a>æ‰©å±•èµ„æ–™</h2><ul><li><a href="https://www.zhihu.com/question/30270633" target="_blank" rel="noopener">æ±‚æ¨èåœ¨çº¿çœ‹æ¿å·¥å…·è½¯ä»¶ï¼Ÿ</a> ç”µå­çœ‹æ¿æ¨è</li><li><a href="https://github.com" target="_blank" rel="noopener">çœ‹æ¿ç³»ç»Ÿå®æ–½ç»†åˆ™</a></li><li><a href="https://book.douban.com/subject/26764497/" target="_blank" rel="noopener">ã€Šç²¾ç›Šå¼€å‘ä¸çœ‹æ¿æ–¹æ³•ã€‹</a></li><li><a href="https://www.infoq.cn/article/kanban-development-method" target="_blank" rel="noopener">è§£æç²¾ç›Šäº§å“å¼€å‘ï¼ˆä¸€ï¼‰â€”â€” çœ‹æ¿å¼€å‘æ–¹æ³•</a></li><li><a href="https://www.jianshu.com/p/e44b1038c9cf" target="_blank" rel="noopener">Scrum vs. çœ‹æ¿ï¼Œè¿˜æ˜¯Scrum + çœ‹æ¿ï¼Ÿ</a></li><li><a href="https://ruddyblog.wordpress.com/tag/çœ‹æ¿ä¸€æ—¥éŠ/" target="_blank" rel="noopener">one day in kanban land ä¸­æ–‡ç‰ˆ</a></li></ul><p><img src="/images/sponsor.jpg" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;code&gt;çœ‹æ¿&lt;/code&gt;æ˜¯ä¸€ç§éå¸¸å¸¸è§çš„ä»»åŠ¡ç®¡ç†æœºåˆ¶ã€‚æˆ‘ä»¬ä½¿ç”¨åˆ°çš„å¤§éƒ¨åˆ†å›¢é˜Ÿåä½œå·¥å…·ä¸­éƒ½æœ‰çœ‹æ¿çš„èº«å½±ï¼Œä¾‹å¦‚ &lt;a href=&quot;http://tower.im&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;&lt;code&gt;Tower&lt;/code&gt;&lt;/a&gt;ã€
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://bobi.ink/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>è‡ªå·±å†™ä¸ªReactæ¸²æŸ“å™¨: ä»¥ Remax ä¸ºä¾‹(ç”¨Reactå†™å°ç¨‹åº)</title>
    <link href="https://bobi.ink/2019/09/15/remax/"/>
    <id>https://bobi.ink/2019/09/15/remax/</id>
    <published>2019-09-14T16:00:00.000Z</published>
    <updated>2019-09-20T05:34:23.384Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸Šä¸ªæœˆèš‚èšé‡‘æœå‰ç«¯å‘å¸ƒäº†ä¸€ä¸ªæ–°çš„æ¡†æ¶ <a href="https://github.com/remaxjs" target="_blank" rel="noopener"><code>Remax</code></a>, å£å·æ˜¯<strong>ä½¿ç”¨çœŸæ­£çš„ã€å®Œæ•´çš„ React æ¥å¼€å‘å°ç¨‹åº</strong>.</p><p>å¯¹äºåŸæœ¬çš„ React å¼€å‘è€…æ¥è¯´ â€˜Learn once, write anywhereâ€™ , å’Œ ReactNative å¼€å‘ä½“éªŒå·®ä¸å¤šï¼Œ<strong>è€Œå¯¹äºå°ç¨‹åºæ¥è¯´åˆ™æ˜¯å…¨æ–°çš„å¼€å‘ä½“éªŒ</strong>ã€‚</p><p><a href="https://github.com/NervJS/taro" target="_blank" rel="noopener"><code>Taro</code></a>å·ç§°æ˜¯â€˜ç±»Reactâ€™çš„å¼€å‘æ–¹æ¡ˆï¼Œä½†æ˜¯å®ƒæ˜¯ä½¿ç”¨é™æ€ç¼–è¯‘çš„æ–¹å¼å®ç°ï¼Œ<a href="https://www.zhihu.com/people/meck" target="_blank" rel="noopener">è¾¹æŸ³</a> åœ¨å®ƒçš„ <a href="https://zhuanlan.zhihu.com/p/79788488" target="_blank" rel="noopener">ã€ŠRemax - ä½¿ç”¨çœŸæ­£çš„ React æ„å»ºå°ç¨‹åºã€‹</a>æ–‡ç« ä¸­ä¹Ÿæåˆ°äº†è¿™ä¸€ç‚¹:</p><p><code>æ‰€è°“é™æ€ç¼–è¯‘ï¼Œå°±æ˜¯ä½¿ç”¨å·¥å…·æŠŠä»£ç è¯­æ³•åˆ†æä¸€éï¼ŒæŠŠå…¶ä¸­çš„ JSX éƒ¨åˆ†å’Œé€»è¾‘éƒ¨åˆ†æŠ½å–å‡ºæ¥ï¼Œåˆ†åˆ«ç”Ÿæˆå°ç¨‹åºçš„æ¨¡æ¿å’Œ Page å®šä¹‰ã€‚</code></p><p>è¿™ç§æ–¹æ¡ˆå®ç°èµ·æ¥æ¯”è¾ƒå¤æ‚ï¼Œä¸”è¿è¡Œæ—¶å¹¶æ²¡æœ‰ React å­˜åœ¨ã€‚</p><p><br></p><p>ç›¸æ¯”è€Œè¨€ï¼Œ<a href="https://github.com/remaxjs" target="_blank" rel="noopener"><code>Remax</code></a> çš„è§£å†³æ–¹æ¡ˆå°±ç®€å•å¾ˆå¤šï¼Œ<strong>å®ƒä¸è¿‡å°±æ˜¯æ–°çš„Reactæ¸²æŸ“å™¨</strong>.</p><p><img src="/images/remax/01.png" alt></p><p><br></p><blockquote><p>å› ä¸º <a href="https://github.com/remaxjs" target="_blank" rel="noopener"><code>Remax</code></a> åˆšå‘å¸ƒä¸ä¹…ï¼Œæ ¸å¿ƒä»£ç æ¯”è¾ƒç®€å•ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥å» <a href="https://github.com/remaxjs/remax" target="_blank" rel="noopener">github</a> è§‚æ‘©è´¡çŒ® <br><br>å¯ä»¥é€šè¿‡ CodeSandbox æ¸¸ä¹åœºè¯•ç©è‡ªå®šä¹‰Renderer: <a href="https://codesandbox.io/s/react-custom-renderer-mm9kl?fontsize=14" target="_blank" rel="noopener">Edit react-custom-renderer</a> <br><br>æ–‡ç« çœ‹èµ·æ¥æ¯”è¾ƒé•¿ï¼Œå¥½æˆåœ¨åå¤´ï¼Œä¸€æ­¥ä¸€æ­¥æ¥ ğŸ¦–</p></blockquote><p><br></p><p><strong>æ–‡ç« å¤§çº²</strong></p><!-- TOC --><ul><li><a href="#å…³äºreactçš„ä¸€äº›åŸºæœ¬æ¦‚å¿µ">å…³äºReactçš„ä¸€äº›åŸºæœ¬æ¦‚å¿µ</a></li><li><a href="#è‡ªå®šä¹‰reactæ¸²æŸ“å™¨">è‡ªå®šä¹‰Reactæ¸²æŸ“å™¨</a></li><li><a href="#hostconfig-æ¸²æŸ“å™¨é€‚é…">HostConfig æ¸²æŸ“å™¨é€‚é…</a></li><li><a href="#å®¿ä¸»ç»„ä»¶">å®¿ä¸»ç»„ä»¶</a></li><li><a href="#é•œåƒæ ‘çš„æ„å»ºå’Œæ“ä½œ">é•œåƒæ ‘çš„æ„å»ºå’Œæ“ä½œ</a></li><li><a href="#èŠ‚ç‚¹æ›´æ–°">èŠ‚ç‚¹æ›´æ–°</a></li><li><a href="#å‰¯ä½œç”¨æäº¤">å‰¯ä½œç”¨æäº¤</a></li><li><a href="#hostconfigæ‰§è¡Œæµç¨‹æ€»ç»“">HostConfigæ‰§è¡Œæµç¨‹æ€»ç»“</a></li><li><a href="#åŒæ­¥åˆ°æ¸²æŸ“è¿›ç¨‹">åŒæ­¥åˆ°æ¸²æŸ“è¿›ç¨‹</a></li><li><a href="#æ€»ç»“">æ€»ç»“</a></li><li><a href="#æ‰©å±•é˜…è¯»">æ‰©å±•é˜…è¯»</a></li></ul><!-- /TOC --><p><br></p><h2 id="å…³äºreactçš„ä¸€äº›åŸºæœ¬æ¦‚å¿µ"><a href="#å…³äºreactçš„ä¸€äº›åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="å…³äºReactçš„ä¸€äº›åŸºæœ¬æ¦‚å¿µ"></a>å…³äºReactçš„ä¸€äº›åŸºæœ¬æ¦‚å¿µ</h2><p>åˆ›å»ºä¸€ä¸ª React è‡ªå®šä¹‰æ¸²æŸ“å™¨ï¼Œä½ éœ€è¦å¯¹Reactæ¸²æŸ“çš„åŸºæœ¬åŸç†æœ‰ä¸€å®šçš„äº†è§£ã€‚æ‰€ä»¥åœ¨æ·±å…¥é˜…è¯»æœ¬æ–‡ä¹‹å‰ï¼Œå…ˆè¦ç¡®ä¿ä½ èƒ½å¤Ÿç†è§£ä»¥ä¸‹å‡ ä¸ªåŸºæœ¬æ¦‚å¿µ:</p><p><strong>1. Element</strong></p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>JSX</code> æˆ–è€… <code>React.createElement</code> æ¥åˆ›å»º Elementï¼Œç”¨æ¥æè¿°æˆ‘ä»¬è¦åˆ›å»ºçš„è§†å›¾èŠ‚ç‚¹ã€‚æ¯”å¦‚:</p><figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line">&lt;button <span class="class"><span class="keyword">class</span></span>=<span class="string">'button button-blue'</span>&gt;</span><br><span class="line">  &lt;b&gt;</span><br><span class="line">    OK!</span><br><span class="line">  &lt;<span class="regexp">/b&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>button&gt;</span><br></pre></td></tr></table></figure><p><code>JSX</code> ä¼šè¢«è½¬ä¹‰è¯‘ä¸º:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">React.createElement(</span><br><span class="line">  <span class="string">"button"</span>,</span><br><span class="line">  &#123; <span class="attr">class</span>: <span class="string">'button button-blue'</span> &#125;,</span><br><span class="line">  React.createElement(<span class="string">"b"</span>, <span class="literal">null</span>, <span class="string">"OK!"</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p><code>React.createElement</code> æœ€ç»ˆæ„å»ºå‡ºç±»ä¼¼è¿™æ ·çš„å¯¹è±¡:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  type: <span class="string">'button'</span>,</span><br><span class="line">  props: &#123;</span><br><span class="line">    className: <span class="string">'button button-blue'</span>,</span><br><span class="line">    children: &#123;</span><br><span class="line">      type: <span class="string">'b'</span>,</span><br><span class="line">      props: &#123;</span><br><span class="line">        children: <span class="string">'OK!'</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´ <strong>Element å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„å¯¹è±¡ï¼Œæè¿°ç”¨æˆ·åˆ›å»ºçš„èŠ‚ç‚¹ç±»å‹ã€props ä»¥åŠ children</strong>ã€‚è¿™äº› Elements ç»„åˆæˆæ ‘ï¼Œæè¿°ç”¨æˆ·è§†å›¾</p><p><br></p><p><strong>2. Component</strong></p><p>å¯ä»¥è®¤ä¸ºæ˜¯ Element çš„ç±»å‹ï¼Œå®ƒæœ‰ä¸¤ç§ç±»å‹ï¼š</p><ul><li><p><strong>Host Component</strong>: å®¿ä¸»ç»„ä»¶ï¼Œè¿™æ˜¯ç”±æ¸²æŸ“çš„å¹³å°æä¾›çš„â€˜å†…ç½®â€™ç»„ä»¶ï¼Œä¾‹å¦‚<code>ReactDOM</code> å¹³å°ä¸‹é¢çš„ <code>DOM</code> èŠ‚ç‚¹ï¼Œå¦‚ <code>div</code>ã€<code>span</code>â€¦ è¿™äº›ç»„ä»¶ç±»å‹ä¸ºå­—ç¬¦ä¸²</p></li><li><p><strong>Composite Component</strong>: å¤åˆç»„ä»¶ï¼Œè¿™æ˜¯ä¸€ç§ç”¨æˆ·è‡ªå®šä¹‰çš„ç»„ä»¶å°è£…å•ä½ã€‚é€šå¸¸åŒ…å«è‡ªå®šä¹‰çš„é€»è¾‘ã€çŠ¶æ€ä»¥åŠè¾“å‡º Element æ ‘ã€‚å¤åˆç±»å‹å¯ä»¥ä¸ºç±»æˆ–å‡½æ•°</p></li></ul><figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> DeleteAccount = <span class="function"><span class="params">()</span> =&gt;</span> (</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;p&gt;Are you sure?<span class="xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line">    &lt;DangerButton&gt;Yep&lt;<span class="regexp">/DangerButton&gt;</span></span><br><span class="line"><span class="regexp">    &lt;Button color='blue'&gt;Cancel&lt;/</span>Button&gt;</span><br><span class="line">  &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">);</span></span><br></pre></td></tr></table></figure><p><br></p><p><strong>3. Instance</strong></p><p>å½“ React å¼€å§‹æ¸²æŸ“ä¸€ä¸ª Element æ—¶ï¼Œä¼šæ ¹æ®ç»„ä»¶ç±»å‹ä¸ºå®ƒåˆ›å»ºä¸€ä¸ªâ€˜å®ä¾‹â€™ï¼Œä¾‹å¦‚ç±»ç»„ä»¶ï¼Œä¼šè°ƒç”¨<code>new</code>æ“ä½œç¬¦å®ä¾‹åŒ–ã€‚è¿™ä¸ªå®ä¾‹ä¼šä¸€ç›´å¼•ç”¨ï¼Œç›´åˆ° Element ä» Element Tree ä¸­è¢«ç§»é™¤ã€‚</p><p><code>é¦–æ¬¡æ¸²æŸ“</code>: React ä¼šå®ä¾‹åŒ–ä¸€ä¸ª <code>MyButton</code> å®ä¾‹ï¼Œè°ƒç”¨æŒ‚è½½ç›¸å…³çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œå¹¶æ‰§è¡Œ <code>render</code> æ–¹æ³•ï¼Œé€’å½’æ¸²æŸ“ä¸‹çº§</p><figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line">render(<span class="xml"><span class="tag">&lt;<span class="name">MyButton</span>&gt;</span>foo<span class="tag">&lt;/<span class="name">MyButton</span>&gt;</span></span>, container)</span><br></pre></td></tr></table></figure><p><br></p><p><code>æ›´æ–°</code>: å› ä¸ºç»„ä»¶ç±»å‹æ²¡æœ‰å˜åŒ–ï¼ŒReact ä¸ä¼šå†å®ä¾‹åŒ–ï¼Œè¿™ä¸ªå±äºâ€˜èŠ‚ç‚¹æ›´æ–°â€™ï¼ŒReact ä¼šæ‰§è¡Œæ›´æ–°ç›¸å…³çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œå¦‚<code>shouldComponentUpdate</code>ã€‚å¦‚æœéœ€è¦æ›´æ–°åˆ™å†æ¬¡æ‰§è¡Œ<code>render</code>æ–¹æ³•</p><figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line">render(<span class="xml"><span class="tag">&lt;<span class="name">MyButton</span>&gt;</span>bar<span class="tag">&lt;/<span class="name">MyButton</span>&gt;</span></span>, container)</span><br></pre></td></tr></table></figure><p><br></p><p><code>å¸è½½</code>: ç»„ä»¶ç±»å‹ä¸ä¸€æ ·äº†, åŸæœ‰çš„ MyButton è¢«æ›¿æ¢. MyButton çš„å®ä¾‹å°†è¦è¢«é”€æ¯ï¼ŒReact ä¼šæ‰§è¡Œå¸è½½ç›¸å…³çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œå¦‚<code>componentWillUnmount</code></p><figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line">render(<span class="xml"><span class="tag">&lt;<span class="name">button</span>&gt;</span>bar<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span>, container)</span><br></pre></td></tr></table></figure><p><br></p><p><strong>4. Reconciler</strong> &amp; <strong>Renderer</strong></p><p><code>Reconciler</code> å’Œ <code>Renderer</code> çš„å…³ç³»å¯ä»¥é€šè¿‡ä¸‹å›¾ç¼•æ¸…æ¥š.</p><p><strong>Reconciler çš„èŒè´£æ˜¯ç»´æŠ¤ VirtualDOM æ ‘ï¼Œå†…éƒ¨å®ç°äº† Diff/Fiber ç®—æ³•ï¼Œå†³å®šä»€ä¹ˆæ—¶å€™æ›´æ–°ã€ä»¥åŠè¦æ›´æ–°ä»€ä¹ˆ</strong></p><p>è€Œ <strong>Renderer è´Ÿè´£å…·ä½“å¹³å°çš„æ¸²æŸ“å·¥ä½œï¼Œå®ƒä¼šæä¾›å®¿ä¸»ç»„ä»¶ã€å¤„ç†äº‹ä»¶ç­‰ç­‰</strong>ã€‚ä¾‹å¦‚ReactDOMå°±æ˜¯ä¸€ä¸ªæ¸²æŸ“å™¨ï¼Œè´Ÿè´£DOMèŠ‚ç‚¹çš„æ¸²æŸ“å’ŒDOMäº‹ä»¶å¤„ç†ã€‚</p><p><br></p><p><img src="/images/remax/02.png" alt></p><p><br></p><p><strong>5. Fiber çš„ä¸¤ä¸ªé˜¶æ®µ</strong><br>React ä½¿ç”¨äº† Fiber æ¶æ„ä¹‹åï¼Œæ›´æ–°è¿‡ç¨‹è¢«åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µ(Phase)</p><ul><li><strong>åè°ƒé˜¶æ®µ(Reconciliation Phase)</strong> è¿™ä¸ªé˜¶æ®µ React ä¼šæ‰¾å‡ºéœ€è¦æ›´æ–°çš„èŠ‚ç‚¹ã€‚è¿™ä¸ªé˜¶æ®µæ˜¯å¯ä»¥è¢«æ‰“æ–­çš„ï¼Œæ¯”å¦‚æœ‰ä¼˜å…ˆçº§æ›´é«˜çš„äº‹ä»¶è¦å¤„ç†æ—¶ã€‚</li><li><strong>æäº¤é˜¶æ®µ(Commit Phase)</strong> å°†ä¸Šä¸€ä¸ªé˜¶æ®µè®¡ç®—å‡ºæ¥çš„éœ€è¦å¤„ç†çš„<strong>å‰¯ä½œç”¨(Effects)</strong>ä¸€æ¬¡æ€§æ‰§è¡Œäº†ã€‚è¿™ä¸ªé˜¶æ®µå¿…é¡»åŒæ­¥æ‰§è¡Œï¼Œä¸èƒ½è¢«æ‰“æ–­</li></ul><p><br></p><p>å¦‚æœæŒ‰ç…§<code>render</code>ä¸ºç•Œï¼Œå¯ä»¥å°†ç”Ÿå‘½å‘¨æœŸå‡½æ•°æŒ‰ç…§ä¸¤ä¸ªé˜¶æ®µè¿›è¡Œåˆ’åˆ†ï¼š</p><ul><li><strong>åè°ƒé˜¶æ®µ</strong><ul><li><code>constructor</code></li><li><code>componentWillMount</code> åºŸå¼ƒ</li><li><code>componentWillReceiveProps</code> åºŸå¼ƒ</li><li><code>static getDerivedStateFromProps</code></li><li><code>shouldComponentUpdate</code></li><li><code>componentWillUpdate</code> åºŸå¼ƒ</li><li><code>render</code></li><li><code>getSnapshotBeforeUpdate()</code></li></ul></li><li><strong>æäº¤é˜¶æ®µ</strong><ul><li><code>componentDidMount</code></li><li><code>componentDidUpdate</code></li><li><code>componentWillUnmount</code></li></ul></li></ul><p><br></p><blockquote><p>æ²¡ç†è§£ï¼Ÿé‚£ä¹ˆä¸‹æ–‡è¯»èµ·æ¥å¯¹ä½ å¯èƒ½æ¯”è¾ƒåƒåŠ›ï¼Œå»ºè®®é˜…è¯»ä¸€äº›å…³äºReactåŸºæœ¬åŸç†çš„ç›¸å…³æ–‡ç« ã€‚</p></blockquote><p><br></p><p>å°±ç›®å‰è€Œè¨€ï¼ŒReact å¤§éƒ¨åˆ†æ ¸å¿ƒçš„å·¥ä½œå·²ç»åœ¨ Reconciler ä¸­å®Œæˆï¼Œå¥½åœ¨ React çš„æ¶æ„å’Œæ¨¡å—åˆ’åˆ†è¿˜æ¯”è¾ƒæ¸…æ™°ï¼ŒReactå®˜æ–¹ä¹Ÿæš´éœ²äº†ä¸€äº›åº“ï¼Œè¿™æå¤§ç®€åŒ–äº†æˆ‘ä»¬å¼€å‘ Renderer çš„éš¾åº¦ã€‚å¼€å§‹å§ï¼</p><p><br></p><h2 id="è‡ªå®šä¹‰reactæ¸²æŸ“å™¨"><a href="#è‡ªå®šä¹‰reactæ¸²æŸ“å™¨" class="headerlink" title="è‡ªå®šä¹‰Reactæ¸²æŸ“å™¨"></a>è‡ªå®šä¹‰Reactæ¸²æŸ“å™¨</h2><p>Reactå®˜æ–¹æš´éœ²äº†ä¸€äº›åº“ä¾›å¼€å‘è€…æ¥æ‰©å±•è‡ªå®šä¹‰æ¸²æŸ“å™¨ï¼š</p><ul><li><a href="https://github.com/facebook/react/tree/master/packages/react-reconciler" target="_blank" rel="noopener">react-reconciler</a> - è¿™å°±æ˜¯ React çš„åè°ƒå™¨, React çš„æ ¸å¿ƒæ‰€åœ¨ã€‚æˆ‘ä»¬ä¸»è¦é€šè¿‡å®ƒæ¥å¼€å‘æ¸²æŸ“å™¨ã€‚</li><li><a href="https://github.com/facebook/react/tree/master/packages/scheduler" target="_blank" rel="noopener">scheduler</a> - åˆä½œè°ƒåº¦å™¨çš„ä¸€äº› API ã€‚æœ¬æ–‡ä¸ä¼šç”¨åˆ°</li></ul><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<strong>è¿™äº›åŒ…è¿˜æ˜¯å®éªŒæ€§çš„</strong>ï¼ŒAPIå¯èƒ½ä¸å¤ªç¨³å®šã€‚å¦å¤–ï¼Œæ²¡æœ‰è¯¦ç»†çš„æ–‡æ¡£ï¼Œä½ éœ€è¦æŸ¥çœ‹æºä»£ç æˆ–è€…å…¶ä»–æ¸²æŸ“å™¨å®ç°ï¼›æœ¬æ–‡ä»¥åŠæ‰©å±•é˜…è¯»ä¸­çš„æ–‡ç« ä¹Ÿæ˜¯å¾ˆå¥½çš„å­¦ä¹ èµ„æ–™ã€‚</p></blockquote><p><br></p><p>åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰æ¸²æŸ“å™¨åªéœ€ä¸¤æ­¥:</p><p><img src="/images/remax/04.png" alt></p><p>ç¬¬ä¸€æ­¥: <strong>å®ç°å®¿ä¸»é…ç½®</strong>ï¼Œè¿™æ˜¯<code>react-reconciler</code>è¦æ±‚å®¿ä¸»æä¾›çš„ä¸€äº›é€‚é…å™¨æ–¹æ³•å’Œé…ç½®é¡¹ã€‚è¿™äº›é…ç½®é¡¹å®šä¹‰äº†å¦‚ä½•åˆ›å»ºèŠ‚ç‚¹å®ä¾‹ã€æ„å»ºèŠ‚ç‚¹æ ‘ã€æäº¤å’Œæ›´æ–°ç­‰æ“ä½œã€‚ä¸‹æ–‡ä¼šè¯¦ç»†ä»‹ç»è¿™äº›é…ç½®é¡¹</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> Reconciler = <span class="built_in">require</span>(<span class="string">'react-reconciler'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> HostConfig = &#123;</span><br><span class="line">  <span class="comment">// ... å®ç°é€‚é…å™¨æ–¹æ³•å’Œé…ç½®é¡¹</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><br></p><p>ç¬¬äºŒæ­¥ï¼š<strong>å®ç°æ¸²æŸ“å‡½æ•°</strong>ï¼Œç±»ä¼¼äº<a href="https://reactjs.org/docs/react-dom.html#render" target="_blank" rel="noopener"><code>ReactDOM.render()</code></a> æ–¹æ³•</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºReconcilerå®ä¾‹, å¹¶å°†HostConfigä¼ é€’ç»™Reconciler</span></span><br><span class="line"><span class="keyword">const</span> MyRenderer = Reconciler(HostConfig);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å‡è®¾å’ŒReactDOMä¸€æ ·ï¼Œæ¥æ”¶ä¸‰ä¸ªå‚æ•°</span></span><br><span class="line"><span class="comment"> * render(&lt;MyComponent /&gt;, container, () =&gt; console.log('rendered'))</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">element, container, callback</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// åˆ›å»ºæ ¹å®¹å™¨</span></span><br><span class="line">  <span class="keyword">if</span> (!container._rootContainer) &#123;</span><br><span class="line">    container._rootContainer = ReactReconcilerInst.createContainer(container, <span class="literal">false</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ›´æ–°æ ¹å®¹å™¨</span></span><br><span class="line">  <span class="keyword">return</span> ReactReconcilerInst.updateContainer(element, container._rootContainer, <span class="literal">null</span>, callback);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®¹å™¨æ—¢æ˜¯ React ç»„ä»¶æ ‘æŒ‚è½½çš„<code>ç›®æ ‡</code>(ä¾‹å¦‚ ReactDOM æˆ‘ä»¬é€šå¸¸ä¼šæŒ‚è½½åˆ° <code>#root</code> å…ƒç´ ï¼Œ<code>#root</code> å°±æ˜¯ä¸€ä¸ªå®¹å™¨)ã€ä¹Ÿæ˜¯ç»„ä»¶æ ‘çš„ <code>æ ¹FiberèŠ‚ç‚¹(FiberRoot)</code>ã€‚æ ¹èŠ‚ç‚¹æ˜¯æ•´ä¸ªç»„ä»¶æ ‘çš„å…¥å£ï¼Œå®ƒå°†ä¼šè¢« Reconciler ç”¨æ¥ä¿å­˜ä¸€äº›ä¿¡æ¯ï¼Œä»¥åŠç®¡ç†æ‰€æœ‰èŠ‚ç‚¹çš„æ›´æ–°å’Œæ¸²æŸ“ã€‚</p><p>å…³äº Fiber æ¶æ„çš„ä¸€äº›ç»†èŠ‚å¯ä»¥çœ‹è¿™äº›æ–‡ç« :</p><ul><li><a href="https://zhuanlan.zhihu.com/p/57346388" target="_blank" rel="noopener">ã€Šè¯‘ æ·±å…¥React fiberæ¶æ„åŠæºç ã€‹</a></li><li><a href="https://juejin.im/post/5ab7b3a2f265da2378403e57" target="_blank" rel="noopener">ã€ŠReact Fiberã€‹</a> æœ‰èƒ½åŠ›çš„åŒå­¦ï¼Œå¯ä»¥ç›´æ¥çœ‹<a href="https://www.youtube.com/watch?v=ZCuYPiUIONs" target="_blank" rel="noopener">Lin Clark</a>çš„æ¼”è®²</li></ul><p><br></p><h2 id="hostconfig-æ¸²æŸ“å™¨é€‚é…"><a href="#hostconfig-æ¸²æŸ“å™¨é€‚é…" class="headerlink" title="HostConfig æ¸²æŸ“å™¨é€‚é…"></a>HostConfig æ¸²æŸ“å™¨é€‚é…</h2><p><code>HostConfig</code> æ”¯æŒéå¸¸å¤šçš„å‚æ•°ï¼Œå®Œæ•´åˆ—è¡¨å¯ä»¥çœ‹<a href="https://github.com/facebook/react/blob/master/packages/react-reconciler/src/forks/ReactFiberHostConfig.custom.js" target="_blank" rel="noopener">è¿™é‡Œ</a>. ä¸‹é¢æ˜¯ä¸€äº›è‡ªå®šä¹‰æ¸²æŸ“å™¨<strong>å¿…é¡»</strong>æä¾›çš„å‚æ•°ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">interface HostConfig &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * ç”¨äºåˆ†äº«ä¸€äº›ä¸Šä¸‹æ–‡ä¿¡æ¯</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="comment">// è·å–æ ¹å®¹å™¨çš„ä¸Šä¸‹æ–‡ä¿¡æ¯, åªåœ¨æ ¹èŠ‚ç‚¹è°ƒç”¨ä¸€æ¬¡</span></span><br><span class="line">  getRootHostContext(rootContainerInstance: Container): HostContext;</span><br><span class="line">  <span class="comment">// è·å–å­èŠ‚ç‚¹çš„ä¸Šä¸‹æ–‡ä¿¡æ¯, æ¯éå†ä¸€ä¸ªèŠ‚ç‚¹éƒ½ä¼šè°ƒç”¨ä¸€æ¬¡</span></span><br><span class="line">  getChildHostContext(parentHostContext: HostContext, <span class="attr">type</span>: Type, <span class="attr">rootContainerInstance</span>: Container): HostContext;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * èŠ‚ç‚¹å®ä¾‹çš„åˆ›å»º</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="comment">// æ™®é€šèŠ‚ç‚¹å®ä¾‹åˆ›å»ºï¼Œä¾‹å¦‚DOMçš„Elementç±»å‹</span></span><br><span class="line">  createInstance(type: Type, <span class="attr">props</span>: Props, <span class="attr">rootContainerInstance</span>: Container, <span class="attr">hostContext</span>: HostContext, <span class="attr">internalInstanceHandle</span>: OpaqueHandle,): Instance;</span><br><span class="line">  <span class="comment">// æ–‡æœ¬èŠ‚ç‚¹çš„åˆ›å»ºï¼Œä¾‹å¦‚DOMçš„Textç±»å‹</span></span><br><span class="line">  createTextInstance(text: string, <span class="attr">rootContainerInstance</span>: Container, <span class="attr">hostContext</span>: HostContext, <span class="attr">internalInstanceHandle</span>: OpaqueHandle): TextInstance;</span><br><span class="line">  <span class="comment">// å†³å®šæ˜¯å¦è¦å¤„ç†å­èŠ‚ç‚¹/å­æ–‡æœ¬èŠ‚ç‚¹. å¦‚æœä¸æƒ³åˆ›å»ºåˆ™è¿”å›true. ä¾‹å¦‚ReactDOMä¸­ä½¿ç”¨dangerouslySetInnerHTML, è¿™æ—¶å€™å­èŠ‚ç‚¹ä¼šè¢«å¿½ç•¥</span></span><br><span class="line">  shouldSetTextContent(type: Type, <span class="attr">props</span>: Props): boolean;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * èŠ‚ç‚¹æ ‘æ„å»º</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="comment">// å¦‚æœèŠ‚ç‚¹åœ¨*æœªæŒ‚è½½*çŠ¶æ€ä¸‹ï¼Œä¼šè°ƒç”¨è¿™ä¸ªæ¥æ·»åŠ å­èŠ‚ç‚¹</span></span><br><span class="line">  appendInitialChild(parentInstance: Instance, <span class="attr">child</span>: Instance | TextInstance): <span class="keyword">void</span>;</span><br><span class="line">  <span class="comment">// **ä¸‹é¢éƒ½æ˜¯å‰¯ä½œç”¨(Effect)ï¼Œåœ¨â€™æäº¤â€˜é˜¶æ®µè¢«æ‰§è¡Œ**</span></span><br><span class="line">  <span class="comment">// æ·»åŠ å­èŠ‚ç‚¹</span></span><br><span class="line">  appendChild?(parentInstance: Instance, <span class="attr">child</span>: Instance | TextInstance): <span class="keyword">void</span>;</span><br><span class="line">  <span class="comment">// æ·»åŠ å­èŠ‚ç‚¹åˆ°å®¹å™¨èŠ‚ç‚¹(æ ¹èŠ‚ç‚¹)</span></span><br><span class="line">  appendChildToContainer?(container: Container, <span class="attr">child</span>: Instance | TextInstance): <span class="keyword">void</span>;</span><br><span class="line">  <span class="comment">// æ’å…¥å­èŠ‚ç‚¹</span></span><br><span class="line">  insertBefore?(parentInstance: Instance, <span class="attr">child</span>: Instance | TextInstance, <span class="attr">beforeChild</span>: Instance | TextInstance): <span class="keyword">void</span>;</span><br><span class="line">  <span class="comment">// æ’å…¥å­èŠ‚ç‚¹åˆ°å®¹å™¨èŠ‚ç‚¹(æ ¹èŠ‚ç‚¹)</span></span><br><span class="line">  insertInContainerBefore?(container: Container, <span class="attr">child</span>: Instance | TextInstance, <span class="attr">beforeChild</span>: Instance | TextInstance,): <span class="keyword">void</span>;</span><br><span class="line">  <span class="comment">// åˆ é™¤å­èŠ‚ç‚¹</span></span><br><span class="line">  removeChild?(parentInstance: Instance, <span class="attr">child</span>: Instance | TextInstance): <span class="keyword">void</span>;</span><br><span class="line">  <span class="comment">// ä»å®¹å™¨èŠ‚ç‚¹(æ ¹èŠ‚ç‚¹)ä¸­ç§»é™¤å­èŠ‚ç‚¹</span></span><br><span class="line">  removeChildFromContainer?(container: Container, <span class="attr">child</span>: Instance | TextInstance): <span class="keyword">void</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * èŠ‚ç‚¹æŒ‚è½½</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="comment">// åœ¨å®Œæˆæ‰€æœ‰å­èŠ‚ç‚¹åˆå§‹åŒ–æ—¶(æ‰€æœ‰å­èŠ‚ç‚¹éƒ½appendInitialChildå®Œæ¯•)æ—¶è¢«è°ƒç”¨, å¦‚æœè¿”å›trueï¼Œåˆ™commitMountå°†ä¼šè¢«è§¦å‘</span></span><br><span class="line">  <span class="comment">// ReactDOMé€šè¿‡è¿™ä¸ªå±æ€§å’ŒcommitMounté…ç½®å®ç°è¡¨å•å…ƒç´ çš„autofocusåŠŸèƒ½</span></span><br><span class="line">  finalizeInitialChildren(parentInstance: Instance, <span class="attr">type</span>: Type, <span class="attr">props</span>: Props, <span class="attr">rootContainerInstance</span>: Container, <span class="attr">hostContext</span>: HostContext): boolean;</span><br><span class="line">  <span class="comment">// å’ŒfinalizeInitialChildrené…åˆä½¿ç”¨ï¼ŒcommitRootä¼šåœ¨â€™æäº¤â€˜å®Œæˆå(resetAfterCommit)æ‰§è¡Œ, ä¹Ÿå°±æ˜¯è¯´ç»„ä»¶æ ‘æ¸²æŸ“å®Œæ¯•åæ‰§è¡Œ</span></span><br><span class="line">  commitMount?(instance: Instance, <span class="attr">type</span>: Type, <span class="attr">newProps</span>: Props, <span class="attr">internalInstanceHandle</span>: OpaqueHandle): <span class="keyword">void</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * èŠ‚ç‚¹æ›´æ–°</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="comment">// å‡†å¤‡èŠ‚ç‚¹æ›´æ–°. å¦‚æœè¿”å›ç©ºåˆ™è¡¨ç¤ºä¸æ›´æ–°ï¼Œè¿™æ—¶å€™commitUpdateåˆ™ä¸ä¼šè¢«è°ƒç”¨</span></span><br><span class="line">  prepareUpdate(instance: Instance, <span class="attr">type</span>: Type, <span class="attr">oldProps</span>: Props, <span class="attr">newProps</span>: Props, <span class="attr">rootContainerInstance</span>: Container, <span class="attr">hostContext</span>: HostContext,): <span class="literal">null</span> | UpdatePayload;</span><br><span class="line">  <span class="comment">// **ä¸‹é¢éƒ½æ˜¯å‰¯ä½œç”¨(Effect)ï¼Œåœ¨â€™æäº¤â€˜é˜¶æ®µè¢«æ‰§è¡Œ**</span></span><br><span class="line">  <span class="comment">// æ–‡æœ¬èŠ‚ç‚¹æäº¤</span></span><br><span class="line">  commitTextUpdate?(textInstance: TextInstance, <span class="attr">oldText</span>: string, <span class="attr">newText</span>: string): <span class="keyword">void</span>;</span><br><span class="line">  <span class="comment">// æ™®é€šèŠ‚ç‚¹æäº¤</span></span><br><span class="line">  commitUpdate?(instance: Instance, <span class="attr">updatePayload</span>: UpdatePayload, <span class="attr">type</span>: Type, <span class="attr">oldProps</span>: Props, <span class="attr">newProps</span>: Props, <span class="attr">internalInstanceHandle</span>: OpaqueHandle): <span class="keyword">void</span>;</span><br><span class="line">  <span class="comment">// é‡ç½®æ™®é€šèŠ‚ç‚¹æ–‡æœ¬å†…å®¹, è¿™ä¸ªéœ€è¦å’ŒshouldSetTextContent(è¿”å›trueæ—¶)é…åˆä½¿ç”¨ï¼Œ</span></span><br><span class="line">  resetTextContent?(instance: Instance): <span class="keyword">void</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * æäº¤</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="comment">// å¼€å§‹â€™æäº¤â€˜ä¹‹å‰è¢«è°ƒç”¨ï¼Œæ¯”å¦‚è¿™é‡Œå¯ä»¥ä¿å­˜ä¸€äº›çŠ¶æ€ï¼Œåœ¨â€™æäº¤â€˜å®Œæˆåæ¢å¤çŠ¶æ€ã€‚æ¯”å¦‚ReactDOMä¼šä¿å­˜å½“å‰å…ƒç´ çš„ç„¦ç‚¹çŠ¶æ€ï¼Œåœ¨æäº¤åæ¢å¤</span></span><br><span class="line">  <span class="comment">// æ‰§è¡Œå®ŒprepareForCommitï¼Œå°±ä¼šå¼€å§‹æ‰§è¡ŒEffects(èŠ‚ç‚¹æ›´æ–°)</span></span><br><span class="line">  prepareForCommit(containerInfo: Container): <span class="keyword">void</span>;</span><br><span class="line">  <span class="comment">// å’ŒprepareForCommitå¯¹åº”ï¼Œåœ¨æäº¤å®Œæˆåè¢«æ‰§è¡Œ</span></span><br><span class="line">  resetAfterCommit(containerInfo: Container): <span class="keyword">void</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * è°ƒåº¦</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="comment">// è¿™ä¸ªå‡½æ•°å°†è¢«Reconcilerç”¨æ¥è®¡ç®—å½“å‰æ—¶é—´, æ¯”å¦‚è®¡ç®—ä»»åŠ¡å‰©ä½™æ—¶é—´ </span></span><br><span class="line">  <span class="comment">// ReactDOMä¸­ä¼šä¼˜å…ˆä½¿ç”¨Performance.now, æ™®é€šåœºæ™¯ç”¨Date.nowå³å¯</span></span><br><span class="line">  now(): number;</span><br><span class="line">  <span class="comment">// è‡ªå®šä¹‰è®¡æ—¶å™¨</span></span><br><span class="line">  setTimeout(handler: <span class="function">(<span class="params">...args: any[]</span>) =&gt;</span> <span class="keyword">void</span>, <span class="attr">timeout</span>: number): TimeoutHandle | NoTimeout;</span><br><span class="line">  <span class="comment">// å–æ¶ˆè®¡æ—¶å™¨</span></span><br><span class="line">  clearTimeout(handle: TimeoutHandle | NoTimeout): <span class="keyword">void</span>;</span><br><span class="line">  <span class="comment">// è¡¨ç¤ºä¸€ä¸ªç©ºçš„è®¡æ—¶å™¨ï¼Œè§ğŸ‘†clearTimeoutçš„ç­¾å</span></span><br><span class="line">  noTimeout: NoTimeout;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ? åŠŸèƒ½æœªçŸ¥</span></span><br><span class="line">  shouldDeprioritizeSubtree(type: Type, <span class="attr">props</span>: Props): boolean;</span><br><span class="line">  <span class="comment">// åºŸå¼ƒ</span></span><br><span class="line">  scheduleDeferredCallback(callback: <span class="function"><span class="params">()</span> =&gt;</span> any, options?: &#123; <span class="attr">timeout</span>: number &#125;): any;</span><br><span class="line">  <span class="comment">// åºŸå¼ƒ</span></span><br><span class="line">  cancelDeferredCallback(callbackID: any): <span class="keyword">void</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * åŠŸèƒ½å¼€å¯</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="comment">// å¼€å¯èŠ‚ç‚¹ä¿®æ”¹ï¼Œä¸€èˆ¬æ¸²æŸ“å™¨éƒ½ä¼šå¼€å¯ï¼Œä¸ç„¶æ— æ³•æ›´æ–°èŠ‚ç‚¹</span></span><br><span class="line">  supportsMutation: boolean;</span><br><span class="line">  <span class="comment">// å¼€å¯æŒä¹…åŒ– ?</span></span><br><span class="line">  supportsPersistence: boolean;</span><br><span class="line">  <span class="comment">// å¼€å¯hydrateï¼Œä¸€èˆ¬ç”¨äºæœåŠ¡ç«¯æ¸²æŸ“</span></span><br><span class="line">  supportsHydration: boolean;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * æ‚é¡¹</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="comment">// è·å–å¯å…¬å¼€çš„èŠ‚ç‚¹å®ä¾‹ï¼Œå³ä½ æ„¿æ„æš´éœ²ç»™ç”¨æˆ·çš„èŠ‚ç‚¹ä¿¡æ¯ï¼Œç”¨æˆ·é€šè¿‡refå¯ä»¥è·å–åˆ°è¿™ä¸ªå¯¹è±¡ã€‚ä¸€èˆ¬è‡ªå®šä¹‰æ¸²æŸ“å™¨åŸæ ·è¿”å›å³å¯, é™¤éä½ æƒ³æœ‰é€‰æ‹©åœ°ç»™ç”¨æˆ·æš´éœ²ä¿¡æ¯</span></span><br><span class="line">  getPublicInstance(instance: Instance | TextInstance): PublicInstance;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ... è¿˜æœ‰å¾ˆå¤šå‚æ•°ï¼Œç”±äºä¸€èˆ¬æ¸²æŸ“å™¨ä¸ä¼šç”¨åˆ°ï¼Œæš‚æ—¶ä¸è®²äº†</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>å¦‚æœæŒ‰ç…§<code>Fiberçš„ä¸¤ä¸ªé˜¶æ®µ</code>æ¥åˆ’åˆ†çš„è¯ï¼Œæ¥å£åˆ†ç±»æ˜¯è¿™æ ·çš„:</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">| åè°ƒé˜¶æ®µ                 | å¼€å§‹æäº¤         | æäº¤é˜¶æ®µ                  | æäº¤å®Œæˆ         |</span><br><span class="line">|-------------------------|----------------|--------------------------|-----------------|</span><br><span class="line">| createInstance          | prepareCommit  | appendChild              | resetAfterCommit|</span><br><span class="line">| createTextInstance      |                | appendChildToContainer   | commitMount     |</span><br><span class="line">| shouldSetTextContent    |                | insertBefore             |                 |</span><br><span class="line">| appendInitialChild      |                | insertInContainerBefore  |                 |</span><br><span class="line">| finalizeInitialChildren  |                | removeChild              |                 |</span><br><span class="line">| prepareUpdate           |                | removeChildFromContainer |                 |</span><br><span class="line">|                         |                | commitTextUpdate         |                 |</span><br><span class="line">|                         |                | commitUpdate             |                 |</span><br><span class="line">|                         |                | resetTextContent         |                 |</span><br></pre></td></tr></table></figure><p><br></p><p>é€šè¿‡ä¸Šé¢æ¥å£å®šä¹‰å¯ä»¥çŸ¥é“ <code>HostConfig</code> é…ç½®æ¯”è¾ƒä¸°å¯Œï¼Œæ¶‰åŠèŠ‚ç‚¹æ“ä½œã€æŒ‚è½½ã€æ›´æ–°ã€è°ƒåº¦ã€ä»¥åŠå„ç§ç”Ÿå‘½å‘¨æœŸé’©å­, å¯ä»¥æ§åˆ¶æ¸²æŸ“å™¨çš„å„ç§è¡Œä¸º.</p><p>çœ‹å¾—æœ‰ç‚¹è’™åœˆï¼Ÿæ²¡å…³ç³», ä½ æš‚æ—¶æ²¡æœ‰å¿…è¦äº†è§£æ‰€æœ‰çš„å‚æ•°ï¼Œä¸‹é¢ä¼šä¸€ç‚¹ä¸€ç‚¹å±•å¼€è§£é‡Šè¿™äº›åŠŸèƒ½ã€‚ä½ å¯ä»¥æœ€åå†å›æ¥çœ‹è¿™é‡Œã€‚</p><p><br></p><h2 id="å®¿ä¸»ç»„ä»¶"><a href="#å®¿ä¸»ç»„ä»¶" class="headerlink" title="å®¿ä¸»ç»„ä»¶"></a>å®¿ä¸»ç»„ä»¶</h2><p>Reactä¸­æœ‰ä¸¤ç§ç»„ä»¶ç±»å‹ï¼Œä¸€ç§æ˜¯<code>å®¿ä¸»ç»„ä»¶(Host Component)</code>, å¦ä¸€ç§æ˜¯<code>å¤åˆç»„ä»¶(CompositeComponent)</code>. <code>å®¿ä¸»ç»„ä»¶</code>æ˜¯å¹³å°æä¾›çš„ï¼Œä¾‹å¦‚ <code>ReactDOM</code> å¹³å°æä¾›äº† <code>div</code>ã€<code>span</code>ã€<code>h1</code>â€¦ ç­‰ç»„ä»¶. è¿™äº›ç»„ä»¶é€šå¸¸æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œç›´æ¥æ¸²æŸ“ä¸ºå¹³å°ä¸‹é¢çš„è§†å›¾èŠ‚ç‚¹ã€‚</p><p>è€Œ<code>å¤åˆç»„ä»¶</code>ï¼Œä¹Ÿç§°ä¸º<code>è‡ªå®šä¹‰ç»„ä»¶</code>ï¼Œç”¨äºç»„åˆå…¶ä»–<code>å¤åˆç»„ä»¶</code>å’Œ<code>å®¿ä¸»ç»„ä»¶</code>ï¼Œé€šå¸¸æ˜¯ç±»æˆ–å‡½æ•°ã€‚</p><p>æ¸²æŸ“å™¨ä¸éœ€è¦å…³å¿ƒ<code>å¤åˆç»„ä»¶</code>çš„å¤„ç†, Reconciler äº¤ç»™æ¸²æŸ“å™¨çš„æ˜¯ä¸€é¢—<code>å®¿ä¸»ç»„ä»¶æ ‘</code>ã€‚</p><p>å½“ç„¶åœ¨ <a href="https://github.com/remaxjs" target="_blank" rel="noopener"><code>Remax</code></a> ä¸­ï¼Œä¹Ÿå®šä¹‰äº†å¾ˆå¤šå°ç¨‹åºç‰¹å®šçš„<code>å®¿ä¸»ç»„ä»¶</code>ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥è¿™æ ·å­ä½¿ç”¨å®ƒä»¬:</p><figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyComp</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">view</span>&gt;</span><span class="tag">&lt;<span class="name">text</span>&gt;</span>hello world<span class="tag">&lt;/<span class="name">text</span>&gt;</span><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p><code>Reconciler</code> ä¼šè°ƒç”¨ <code>HostConfig</code> çš„ <code>createInstance</code> å’Œ<code>createTextInstance</code> æ¥åˆ›å»º<code>å®¿ä¸»ç»„ä»¶</code>çš„å®ä¾‹ï¼Œæ‰€ä»¥è‡ªå®šä¹‰æ¸²æŸ“å™¨å¿…é¡»å®ç°è¿™ä¸¤ä¸ªæ–¹æ³•. çœ‹çœ‹ <code>Remax</code> æ˜¯æ€ä¹ˆåšçš„ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> HostConfig = &#123;</span><br><span class="line">  <span class="comment">// åˆ›å»ºå®¿ä¸»ç»„ä»¶å®ä¾‹</span></span><br><span class="line">  createInstance(type: string, <span class="attr">newProps</span>: any, <span class="attr">container</span>: Container) &#123;</span><br><span class="line">    <span class="keyword">const</span> id = generate();</span><br><span class="line">    <span class="comment">// é¢„å¤„ç†props, remaxä¼šå¯¹äº‹ä»¶ç±»å‹Propsè¿›è¡Œä¸€äº›ç‰¹æ®Šå¤„ç†</span></span><br><span class="line">    <span class="keyword">const</span> props = processProps(newProps, container, id);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> VNode(&#123;</span><br><span class="line">      id,</span><br><span class="line">      type,</span><br><span class="line">      props,</span><br><span class="line">      container,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ›å»ºå®¿ä¸»ç»„ä»¶æ–‡æœ¬èŠ‚ç‚¹å®ä¾‹</span></span><br><span class="line">  createTextInstance(text: string, <span class="attr">container</span>: Container) &#123;</span><br><span class="line">    <span class="keyword">const</span> id = generate();</span><br><span class="line">    <span class="keyword">const</span> node = <span class="keyword">new</span> VNode(&#123;</span><br><span class="line">      id,</span><br><span class="line">      type: TYPE_TEXT,</span><br><span class="line">      props: <span class="literal">null</span>,</span><br><span class="line">      container,</span><br><span class="line">    &#125;);</span><br><span class="line">    node.text = text;</span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ¤æ–­æ˜¯å¦éœ€è¦å¤„ç†å­èŠ‚ç‚¹ã€‚å¦‚æœè¿”å›trueåˆ™ä¸åˆ›å»ºï¼Œæ•´ä¸ªä¸‹çº§ç»„ä»¶æ ‘éƒ½ä¼šè¢«å¿½ç•¥ã€‚</span></span><br><span class="line">  <span class="comment">// æœ‰ä¸€äº›åœºæ™¯æ˜¯ä¸éœ€è¦åˆ›å»ºæ–‡æœ¬èŠ‚ç‚¹çš„ï¼Œè€Œæ˜¯ç”±çˆ¶èŠ‚ç‚¹å†…éƒ¨æ¶ˆåŒ–ã€‚</span></span><br><span class="line">  <span class="comment">// ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨ReactDOMä¸­ï¼Œå¦‚æœæŸä¸ªèŠ‚ç‚¹è®¾ç½®äº†dangerouslySetInnerHTMLï¼Œé‚£ä¹ˆå®ƒçš„childrenåº”è¯¥è¢«å¿½ç•¥ï¼Œ</span></span><br><span class="line">  <span class="comment">// è¿™æ—¶å€™ shouldSetTextContentåˆ™åº”è¯¥è¿”å›true</span></span><br><span class="line">  shouldSetTextContent(type, nextProps) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ ReactDOM ä¸­ä¸Šé¢ä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«ä¼šé€šè¿‡ <code>document.createElement</code> å’Œ <code>document.createTextNode</code> æ¥åˆ›å»º<code>å®¿ä¸»ç»„ä»¶</code>(å³<code>DOMèŠ‚ç‚¹</code>)ã€‚</p><p><br></p><p><img src="/images/remax/wxm.png" alt></p><p>ä¸Šé¢æ˜¯å¾®ä¿¡å°ç¨‹åºçš„æ¶æ„å›¾(å›¾ç‰‡æ¥æº: <a href="https://mp.weixin.qq.com/s/3QE3g0NmaBAi91lbrihhVw" target="_blank" rel="noopener">ä¸€èµ·è„±å»å°ç¨‹åºçš„å¤–å¥— - å¾®ä¿¡å°ç¨‹åºæ¶æ„è§£æ</a>)ã€‚</p><p><strong>å› ä¸ºå°ç¨‹åºéš”ç¦»äº†<code>æ¸²æŸ“è¿›ç¨‹</code>å’Œ<code>é€»è¾‘è¿›ç¨‹</code>ã€‚<a href="https://github.com/remaxjs" target="_blank" rel="noopener"><code>Remax</code></a> æ˜¯è·‘åœ¨<code>é€»è¾‘è¿›ç¨‹</code>ä¸Šçš„ï¼Œåœ¨<code>é€»è¾‘è¿›ç¨‹</code>ä¸­æ— æ³•è¿›è¡Œå®é™…çš„æ¸²æŸ“, åªèƒ½é€šè¿‡<code>setData</code>æ–¹å¼å°†æ›´æ–°æŒ‡ä»¤ä¼ é€’ç»™<code>æ¸²æŸ“è¿›ç¨‹</code>åï¼Œå†è¿›è¡Œè§£ææ¸²æŸ“</strong>ã€‚</p><p>æ‰€ä»¥<a href="https://github.com/remaxjs" target="_blank" rel="noopener"><code>Remax</code></a>é€‰æ‹©åœ¨<code>é€»è¾‘è¿›ç¨‹</code>ä¸­å…ˆæ„æˆä¸€é¢—<code>é•œåƒæ ‘</code>(Mirror Tree), ç„¶åå†åŒæ­¥åˆ°<code>æ¸²æŸ“è¿›ç¨‹</code>ä¸­ï¼Œå¦‚ä¸‹å›¾:</p><p><img src="/images/remax/03.png" alt></p><p><br></p><p><strong>ä¸Šé¢çš„ <code>VNode</code> å°±æ˜¯é•œåƒæ ‘ä¸­çš„<code>è™šæ‹ŸèŠ‚ç‚¹</code>ï¼Œä¸»è¦ç”¨äºä¿å­˜ä¸€äº›èŠ‚ç‚¹ä¿¡æ¯ï¼Œä¸åšä»»ä½•ç‰¹æ®Šå¤„ç†</strong>, å®ƒçš„ç»“æ„å¦‚ä¸‹:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">VNode</span> </span>&#123;</span><br><span class="line">  id: number;                  <span class="comment">// å”¯ä¸€çš„èŠ‚ç‚¹id</span></span><br><span class="line">  container: Container;</span><br><span class="line">  children: VNode[];           <span class="comment">// å­èŠ‚ç‚¹</span></span><br><span class="line">  mounted = <span class="literal">false</span>;             <span class="comment">// èŠ‚ç‚¹æ˜¯å¦å·²ç»æŒ‚è½½</span></span><br><span class="line">  type: string | symbol;       <span class="comment">// èŠ‚ç‚¹çš„ç±»å‹</span></span><br><span class="line">  props?: any;                 <span class="comment">// èŠ‚ç‚¹çš„props</span></span><br><span class="line">  parent: VNode | <span class="literal">null</span> = <span class="literal">null</span>; <span class="comment">// çˆ¶èŠ‚ç‚¹å¼•ç”¨</span></span><br><span class="line">  text?: string;               <span class="comment">// å¦‚æœæ˜¯æ–‡æœ¬èŠ‚ç‚¹ï¼Œè¿™é‡Œä¿å­˜æ–‡æœ¬å†…å®¹</span></span><br><span class="line">  path(): Path                 <span class="comment">// èŠ‚ç‚¹çš„è·¯å¾„. åŒæ­¥åˆ°æ¸²æŸ“è¿›ç¨‹åï¼Œé€šè¿‡pathæ¢å¤åˆ°æ ‘ä¸­</span></span><br><span class="line">  <span class="comment">// å­èŠ‚ç‚¹æ“ä½œ</span></span><br><span class="line">  appendChild(node: VNode, <span class="attr">immediately</span>: boolean)</span><br><span class="line">  removeChild(node: VNode, <span class="attr">immediately</span>: boolean)</span><br><span class="line">  insertBefore(newNode: VNode, <span class="attr">referenceNode</span>: VNode, <span class="attr">immediately</span>: boolean)</span><br><span class="line"></span><br><span class="line">  update()                     <span class="comment">// è§¦å‘åŒæ­¥åˆ°æ¸²æŸ“è¿›ç¨‹</span></span><br><span class="line">  toJSON(): string</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>VNode çš„å®Œæ•´ä»£ç å¯ä»¥çœ‹<a href="https://github.com/remaxjs/remax/blob/master/packages/remax/src/VNode.ts" target="_blank" rel="noopener">è¿™é‡Œ</a></p><p><br></p><h2 id="é•œåƒæ ‘çš„æ„å»ºå’Œæ“ä½œ"><a href="#é•œåƒæ ‘çš„æ„å»ºå’Œæ“ä½œ" class="headerlink" title="é•œåƒæ ‘çš„æ„å»ºå’Œæ“ä½œ"></a>é•œåƒæ ‘çš„æ„å»ºå’Œæ“ä½œ</h2><p>è¦æ„å»ºå‡ºå®Œæ•´çš„èŠ‚ç‚¹æ ‘éœ€è¦å®ç°<code>HostConfig</code> çš„ <code>appendChild</code>ã€<code>insertBefore</code>ã€<code>removeChild</code> ç­‰æ–¹æ³•, å¦‚ä¸‹ï¼Œ è¿™äº›æ–¹æ³•éƒ½æ¯”è¾ƒå®¹æ˜“ç†è§£ï¼Œæ‰€ä»¥ä¸éœ€è¦è¿‡å¤šè§£é‡Šã€‚</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> HostConfig = &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ”¯æŒèŠ‚ç‚¹ä¿®æ”¹</span></span><br><span class="line">  <span class="comment">// æœ‰äº›é™æ€æ¸²æŸ“çš„åœºæ™¯ï¼Œä¾‹å¦‚æ¸²æŸ“ä¸ºpdfæ–‡æ¡£ï¼Œè¿™æ—¶å€™å¯ä»¥å…³é—­</span></span><br><span class="line">  <span class="comment">// å½“å…³é—­æ—¶ï¼Œåªéœ€è¦å®ç°appendInitiaChild</span></span><br><span class="line">  supportsMutation: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç”¨äºåˆå§‹åŒ–(é¦–æ¬¡)æ—¶æ·»åŠ å­èŠ‚ç‚¹</span></span><br><span class="line">  appendInitialChild: <span class="function">(<span class="params">parent: VNode, child: VNode</span>) =&gt;</span> &#123;</span><br><span class="line">    parent.appendChild(child, <span class="literal">false</span>);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ·»åŠ å­èŠ‚ç‚¹</span></span><br><span class="line">  appendChild(parent: VNode, <span class="attr">child</span>: VNode) &#123;</span><br><span class="line">    parent.appendChild(child, <span class="literal">false</span>);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ’å…¥å­èŠ‚ç‚¹</span></span><br><span class="line">  insertBefore(parent: VNode, <span class="attr">child</span>: VNode, <span class="attr">beforeChild</span>: VNode) &#123;</span><br><span class="line">    parent.insertBefore(child, beforeChild, <span class="literal">false</span>);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ é™¤èŠ‚ç‚¹</span></span><br><span class="line">  removeChild(parent: VNode, <span class="attr">child</span>: VNode) &#123;</span><br><span class="line">    parent.removeChild(child, <span class="literal">false</span>);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ·»åŠ èŠ‚ç‚¹åˆ°å®¹å™¨èŠ‚ç‚¹ï¼Œä¸€èˆ¬æƒ…å†µæˆ‘ä»¬ä¸éœ€è¦å’ŒappendChildç‰¹æ®ŠåŒºåˆ†</span></span><br><span class="line">  appendChildToContainer(container: any, <span class="attr">child</span>: VNode) &#123;</span><br><span class="line">    container.appendChild(child);</span><br><span class="line">    child.mounted = <span class="literal">true</span>;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ’å…¥èŠ‚ç‚¹åˆ°å®¹å™¨èŠ‚ç‚¹</span></span><br><span class="line">  insertInContainerBefore(container: any, <span class="attr">child</span>: VNode, <span class="attr">beforeChild</span>: VNode) &#123;</span><br><span class="line">    container.insertBefore(child, beforeChild);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä»å®¹å™¨èŠ‚ç‚¹ç§»é™¤èŠ‚ç‚¹</span></span><br><span class="line">  removeChildFromContainer(container: any, <span class="attr">child</span>: VNode) &#123;</span><br><span class="line">    container.removeChild(child);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><h2 id="èŠ‚ç‚¹æ›´æ–°"><a href="#èŠ‚ç‚¹æ›´æ–°" class="headerlink" title="èŠ‚ç‚¹æ›´æ–°"></a>èŠ‚ç‚¹æ›´æ–°</h2><p>ä¸Šä¸€èŠ‚è®²çš„æ˜¯æ ‘ç»“æ„å±‚é¢çš„æ›´æ–°ï¼Œå½“èŠ‚ç‚¹å±æ€§å˜åŠ¨æˆ–è€…æ–‡æœ¬å†…å®¹å˜åŠ¨æ—¶ï¼Œä¹Ÿéœ€è¦è¿›è¡Œæ›´æ–°ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹åˆ— <code>HostConfig</code> é…ç½®æ¥å¤„ç†è¿™ç±»æ›´æ–°:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> HostConfig = &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * æ›´æ–°ç›¸å…³</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="comment">// å¯ä»¥åœ¨è¿™é‡Œæ¯”å¯¹propsï¼Œå¦‚æœpropsæ²¡æœ‰å˜åŒ–åˆ™ä¸è¿›è¡Œæ›´æ–°ï¼Œè¿™å’ŒReactç»„ä»¶çš„shouldComponentUpdateå·®ä¸å¤š</span></span><br><span class="line">  <span class="comment">// **è¿”å›â€™ç©ºâ€˜åˆ™è¡¨ç¤ºä¸æ›´æ–°è¯¥èŠ‚ç‚¹, è¿™æ—¶å€™commitUpdateåˆ™ä¸ä¼šè¢«è°ƒç”¨**</span></span><br><span class="line">  prepareUpdate(node: VNode, <span class="attr">type</span>: string, <span class="attr">oldProps</span>: any, <span class="attr">newProps</span>: any) &#123;</span><br><span class="line">    oldProps = processProps(oldProps, node.container, node.id);</span><br><span class="line">    newProps = processProps(newProps, node.container, node.id);</span><br><span class="line">    <span class="keyword">if</span> (!shallowequal(newProps, oldProps)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¿›è¡ŒèŠ‚ç‚¹æ›´æ–°</span></span><br><span class="line">  commitUpdate(</span><br><span class="line">    node: VNode,</span><br><span class="line">    updatePayload: any,</span><br><span class="line">    type: string,</span><br><span class="line">    oldProps: any,</span><br><span class="line">    newProps: any</span><br><span class="line">  ) &#123;</span><br><span class="line">    node.props = processProps(newProps, node.container, node.id);</span><br><span class="line">    node.update();</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¿›è¡Œæ–‡æœ¬èŠ‚ç‚¹æ›´æ–°</span></span><br><span class="line">  commitTextUpdate(node: VNode, <span class="attr">oldText</span>: string, <span class="attr">newText</span>: string) &#123;</span><br><span class="line">    <span class="keyword">if</span> (oldText !== newText) &#123;</span><br><span class="line">      node.text = newText;</span><br><span class="line">      <span class="comment">// æ›´æ–°èŠ‚ç‚¹</span></span><br><span class="line">      node.update();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Ok, è¿™ä¸ªä¹Ÿæ¯”è¾ƒå¥½ç†è§£ã€‚<br>å¯¹äºæ™®é€šèŠ‚ç‚¹æ›´æ–°ï¼Œ<code>Reconciler</code> ä¼šå…ˆè°ƒç”¨ <code>prepareUpdate</code>, ç¡®å®šæ˜¯å¦è¦æ›´æ–°ï¼Œå¦‚æœè¿”å›éç©ºæ•°æ®ï¼Œ<code>Reconciler</code> å°±ä¼šå°†èŠ‚ç‚¹æ”¾å…¥ <code>Effects</code> é“¾ä¸­ï¼Œåœ¨<code>æäº¤</code>é˜¶æ®µè°ƒç”¨ <code>commitUpdate</code> æ¥æ‰§è¡Œæ›´æ–°ã€‚<br>æ–‡æœ¬èŠ‚ç‚¹æ›´æ–°åˆ™ç›´æ¥è°ƒç”¨ <code>commitTextUpdate</code>ï¼Œä¸åœ¨è¯ä¸‹.</p><p><br></p><h2 id="å‰¯ä½œç”¨æäº¤"><a href="#å‰¯ä½œç”¨æäº¤" class="headerlink" title="å‰¯ä½œç”¨æäº¤"></a>å‰¯ä½œç”¨æäº¤</h2><p>React çš„<code>æ›´æ–°çš„ä¸¤ä¸ªé˜¶æ®µ</code>è¿™ä¸ªæ¦‚å¿µéå¸¸é‡è¦ï¼Œè¿™ä¸ªä¹Ÿä½“ç°åœ¨HostConfigä¸Š:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> HostConfig = &#123;</span><br><span class="line">  <span class="comment">// Reconcilerè¯´ï¼Œæˆ‘è¦å¼€å§‹æäº¤äº†ï¼Œä½ æäº¤å‰è¦åšä»€ä¹ˆï¼Œå°±åœ¨è¿™åšå§</span></span><br><span class="line">  <span class="comment">// æ¯”å¦‚ReactDOMä¼šåœ¨è¿™é‡Œä¿å­˜å½“å‰DOMæ–‡æ¡£çš„é€‰ä¸­çŠ¶æ€å’Œç„¦ç‚¹çŠ¶æ€, ä»¥åŠç¦ç”¨äº‹ä»¶å¤„ç†ã€‚å› ä¸ºDOMæ›´æ–°å¯èƒ½ä¼šç ´åè¿™äº›çŠ¶æ€</span></span><br><span class="line">  prepareForCommit: <span class="function"><span class="params">()</span> =&gt;</span> &#123;&#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Reconcilerè¯´ï¼Œæˆ‘å·²ç»æäº¤å®Œäº†</span></span><br><span class="line">  <span class="comment">// ReactDOMä¼šåœ¨è¿™é‡Œæ¢å¤æäº¤å‰çš„DOMæ–‡æ¡£çš„é€‰ä¸­çŠ¶æ€å’Œç„¦ç‚¹çŠ¶æ€</span></span><br><span class="line">  resetAfterCommit: <span class="function"><span class="params">()</span> =&gt;</span> &#123;&#125;,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">// åœ¨åè°ƒé˜¶æ®µï¼Œå½“ä¸€ä¸ªèŠ‚ç‚¹å®Œæˆ'åˆ›å»º'åè°ƒç”¨ã€‚å¦‚æœæœ‰å­èŠ‚ç‚¹ï¼Œåˆ™åœ¨æ‰€æœ‰å­èŠ‚ç‚¹appendInitialChildå®Œæˆåè°ƒç”¨</span></span><br><span class="line">  <span class="comment">// è¿”å›ä¸€ä¸ªbooleanå€¼è¡¨ç¤ºâ€™å®Œæˆæäº¤â€˜åæ˜¯å¦è¦è°ƒç”¨commitMount. é€šä¿—è®²å°±æ˜¯å‘Šè¯‰Reconcilerï¼Œå½“å‰èŠ‚ç‚¹å®Œæˆâ€™æŒ‚è½½â€˜åè¦æ‰§è¡ŒæŸäº›ä¸œè¥¿</span></span><br><span class="line">  <span class="comment">// ReactDOMä¼šä½¿ç”¨è¿™ä¸ªé’©å­æ¥å¤„ç†å¸¦æœ‰autofoucså±æ€§çš„èŠ‚ç‚¹ï¼Œåœ¨commitMountä¸­å®ç°è‡ªåŠ¨è·å–ç„¦ç‚¹</span></span><br><span class="line">  finalizeInitialChildren: <span class="function"><span class="params">()</span> =&gt;</span> <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å’ŒfinalizeInitialChildrené…åˆä½¿ç”¨ï¼Œå¦‚æœå‰è€…è¿”å›trueï¼Œåœ¨Reconcilerå®Œæˆæäº¤åï¼Œå¯¹åº”èŠ‚ç‚¹çš„commitMountä¼šè¢«æ‰§è¡Œ</span></span><br><span class="line">  commitMount: <span class="function"><span class="params">()</span> =&gt;</span> &#123;&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>å°†ä¸Šæ–‡è®²åˆ°çš„æ‰€æœ‰é’©å­éƒ½èšåˆèµ·æ¥ï¼ŒæŒ‰ç…§æ›´æ–°çš„é˜¶æ®µå’Œåº”ç”¨çš„ç›®æ ‡(target)è¿›è¡Œåˆ’åˆ†ï¼Œå®ƒä»¬çš„åˆ†å¸ƒæ˜¯è¿™æ ·çš„ï¼š</p><p><img src="/images/remax/overview.png" alt></p><p><br></p><p>é‚£ä¹ˆå¯¹äº <a href="https://github.com/remaxjs" target="_blank" rel="noopener"><code>Remax</code></a> æ¥è¯´, ä»€ä¹ˆæ—¶å€™åº”è¯¥å°†â€™æ›´æ–°â€™æäº¤åˆ°<code>æ¸²æŸ“è¿›ç¨‹</code>å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ä¸Šå›¾æ‰€æœ‰åœ¨<code>æäº¤é˜¶æ®µ</code>çš„æ–¹æ³•è¢«è°ƒç”¨æ—¶ã€‚</p><p><code>æäº¤é˜¶æ®µ</code>åŸæ„å°±æ˜¯ç”¨äºæ‰§è¡Œå„ç§å‰¯ä½œç”¨çš„ï¼Œä¾‹å¦‚è§†å›¾æ›´æ–°ã€è¿œç¨‹æ–¹æ³•è¯·æ±‚ã€è®¢é˜…â€¦ æ‰€ä»¥ <a href="https://github.com/remaxjs" target="_blank" rel="noopener"><code>Remax</code></a> ä¹Ÿä¼šåœ¨è¿™ä¸ªé˜¶æ®µæ”¶é›†<code>æ›´æ–°æŒ‡ä»¤</code>ï¼Œåœ¨ä¸‹ä¸€ä¸ªå¾ªç¯æ¨é€ç»™æ¸²æŸ“è¿›ç¨‹ã€‚</p><p><br></p><h2 id="hostconfigæ‰§è¡Œæµç¨‹æ€»ç»“"><a href="#hostconfigæ‰§è¡Œæµç¨‹æ€»ç»“" class="headerlink" title="HostConfigæ‰§è¡Œæµç¨‹æ€»ç»“"></a>HostConfigæ‰§è¡Œæµç¨‹æ€»ç»“</h2><p>å›é¡¾ä¸€ä¸‹è‡ªå®šä¹‰æ¸²æŸ“å™¨å„ç§æ–¹æ³•è°ƒç”¨çš„æµç¨‹, é¦–å…ˆçœ‹ä¸€ä¸‹<strong>æŒ‚è½½</strong>çš„æµç¨‹:</p><p>å‡è®¾æˆ‘ä»¬çš„ç»„ä»¶ç»“æ„å¦‚ä¸‹:</p><figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> container = <span class="keyword">new</span> Container()</span><br><span class="line"><span class="keyword">const</span> MyComp = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;span&gt;hello world&lt;<span class="regexp">/span&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">render(</span><br><span class="line">  &lt;div className=<span class="string">"root"</span>&gt;</span><br><span class="line">    &lt;MyComp /&gt;</span><br><span class="line">    &lt;span&gt;--custom renderer&lt;<span class="regexp">/span&gt;</span></span><br><span class="line"><span class="regexp">  &lt;/</span>div&gt;,</span><br><span class="line">  container,</span><br><span class="line">  () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"rendered"</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>React ç»„ä»¶æ ‘çš„ç»“æ„å¦‚ä¸‹(å·¦å›¾)ï¼Œä½†å¯¹äºæ¸²æŸ“å™¨æ¥è¯´ï¼Œæ ‘ç»“æ„æ˜¯å³å›¾ã€‚<br>è‡ªå®šä¹‰ç»„ä»¶æ˜¯React å±‚çº§çš„ä¸œè¥¿ï¼Œæ¸²æŸ“å™¨åªéœ€è¦å…³å¿ƒæœ€ç»ˆéœ€è¦æ¸²æŸ“çš„è§†å›¾ç»“æ„, æ¢å¥è¯è¯´æ¸²æŸ“å™¨åªå…³å¿ƒ<code>å®¿ä¸»ç»„ä»¶</code>:</p><p><img src="/images/remax/tree-compare.png" alt></p><p><br></p><p>æŒ‚è½½ä¼šç»å†ä»¥ä¸‹æµç¨‹:</p><p><img src="/images/remax/mount.png" alt></p><p>é€šè¿‡ä¸Šé¢çš„æµç¨‹å›¾ï¼Œå¯ä»¥å¾ˆæ¸…æ™°çœ‹åˆ°æ¯ä¸ªé’©å­çš„è°ƒç”¨æ—¶æœºã€‚</p><p><br></p><p>åŒç†ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹èŠ‚ç‚¹<strong>æ›´æ–°</strong>æ—¶çš„æµç¨‹. æˆ‘ä»¬ç¨å¾®æ”¹é€ ä¸€ä¸‹ä¸Šé¢çš„ç¨‹åºï¼Œè®©å®ƒå®šæ—¶è§¦å‘æ›´æ–°:</p><figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> MyComp = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = useState(<span class="number">1</span>)</span><br><span class="line">  <span class="keyword">const</span> isEven = count % <span class="number">2</span> === <span class="number">0</span></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> timer = setInterval(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// é€’å¢è®¡æ•°å™¨</span></span><br><span class="line">      setCount(<span class="function"><span class="params">c</span> =&gt;</span> c + <span class="number">1</span>)</span><br><span class="line">    &#125;, <span class="number">10000</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> clearInterval(timer)</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div className=<span class="string">"mycomp"</span> style=&#123;&#123; <span class="attr">color</span>: isEven ? <span class="string">"red"</span> : <span class="string">"blue"</span> &#125;&#125;&gt;</span><br><span class="line">      &#123;isEven ? <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>even<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span> : <span class="literal">null</span>&#125;</span><br><span class="line">      &lt;span className=<span class="string">"foo"</span>&gt;hello world &#123;count&#125;&lt;<span class="regexp">/span&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>ä¸‹é¢æ˜¯æ›´æ–°çš„æµç¨‹:</p><p><img src="/images/remax/update.png" alt></p><p><br></p><p>å½“<code>MyComp</code>çš„ <code>count</code> ç”±1å˜ä¸º2æ—¶ï¼Œ<code>MyComp</code> ä¼šè¢«é‡æ–°æ¸²æŸ“ï¼Œè¿™æ—¶å€™æ–°å¢äº†ä¸€ä¸ª<code>div</code> èŠ‚ç‚¹(çº¢è‰²è™šæ¡†), å¦å¤– <code>hello world 1</code> ä¹Ÿå˜æˆäº† <code>hello world 2</code>ã€‚</p><p>æ–°å¢çš„ <code>div</code> èŠ‚ç‚¹åˆ›å»ºæµç¨‹å’ŒæŒ‚è½½æ—¶ä¸€æ ·ï¼Œåªä¸è¿‡å®ƒä¸ä¼šç«‹å³æ’å…¥åˆ°çˆ¶èŠ‚ç‚¹ä¸­ï¼Œè€Œæ˜¯å…ˆæ”¾åˆ°<code>Effect</code>é“¾è¡¨ä¸­ï¼Œåœ¨<code>æäº¤é˜¶æ®µ</code>ç»Ÿä¸€æ‰§è¡Œã€‚</p><p>åŒç†<code>hello world {count}</code>æ–‡æœ¬èŠ‚ç‚¹çš„æ›´æ–°ã€ä»¥åŠå…¶ä»–èŠ‚ç‚¹çš„ Props æ›´æ–°éƒ½æ˜¯æ”¾åˆ°Effecté“¾è¡¨ä¸­ï¼Œæœ€åæ—¶åˆ»æ‰æ›´æ–°æäº¤. å¦‚ä¸Šå›¾çš„ <code>insertBefore</code>ã€<code>commitTextUpdate</code>ã€<code>commitUpdate</code>.</p><p>å¦å¤–ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„æ˜¯ <code>prepareUpdate</code> é’©å­ï¼Œä½ å¯ä»¥åœ¨è¿™é‡Œå‘Šè¯‰ Reconcilerï¼ŒèŠ‚ç‚¹æ˜¯å¦éœ€è¦æ›´æ–°ï¼Œå¦‚æœéœ€è¦æ›´æ–°åˆ™è¿”å›éç©ºå€¼ï¼Œè¿™æ · <code>commitUpdate</code> æ‰ä¼šè¢«è§¦å‘ã€‚</p><p><br></p><h2 id="åŒæ­¥åˆ°æ¸²æŸ“è¿›ç¨‹"><a href="#åŒæ­¥åˆ°æ¸²æŸ“è¿›ç¨‹" class="headerlink" title="åŒæ­¥åˆ°æ¸²æŸ“è¿›ç¨‹"></a>åŒæ­¥åˆ°æ¸²æŸ“è¿›ç¨‹</h2><p>React è‡ªå®šä¹‰æ¸²æŸ“å™¨å·®ä¸å¤šå°±è¿™æ ·äº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å¹³å°ç›¸å…³çš„äº‹æƒ…äº†ã€‚<br><a href="https://github.com/remaxjs" target="_blank" rel="noopener"><code>Remax</code></a> ç›®å‰çš„åšæ³•æ˜¯åœ¨è§¦å‘æ›´æ–°åï¼Œé€šè¿‡å°ç¨‹åº <code>Page</code> å¯¹è±¡çš„ <code>setData</code> æ–¹æ³•å°†<code>æ›´æ–°æŒ‡ä»¤</code>ä¼ é€’ç»™æ¸²æŸ“è¿›ç¨‹;<br><code>æ¸²æŸ“è¿›ç¨‹</code>ä¾§å†é€šè¿‡ <a href="https://developers.weixin.qq.com/miniprogram/dev/framework/view/wxs/" target="_blank" rel="noopener"><code>WXS</code></a> æœºåˆ¶ï¼Œå°†<code>æ›´æ–°æŒ‡ä»¤</code>æ¢å¤åˆ°æ ‘ä¸­ï¼› æœ€åå†é€šè¿‡<code>æ¨¡æ¿</code>æœºåˆ¶ï¼Œå°†æ ‘é€’å½’æ¸²æŸ“å‡ºæ¥ã€‚</p><p>æ•´ä½“çš„æ¶æ„å¦‚ä¸‹:</p><p><img src="/images/remax/07.png" alt></p><p><br></p><p>å…ˆæ¥çœ‹çœ‹<code>é€»è¾‘è¿›ç¨‹</code>ä¾§æ˜¯å¦‚ä½•æ¨é€æ›´æ–°æŒ‡ä»¤çš„ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åœ¨æ ¹å®¹å™¨ä¸Šç®¡ç†æ›´æ–°</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Container</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// è§¦å‘æ›´æ–°</span></span><br><span class="line">  requestUpdate(</span><br><span class="line">    path: Path,</span><br><span class="line">    start: number,</span><br><span class="line">    deleteCount: number,</span><br><span class="line">    immediately: boolean,</span><br><span class="line">    ...items: RawNode[]</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">const</span> update: SpliceUpdate = &#123;</span><br><span class="line">      path, <span class="comment">// æ›´æ–°èŠ‚ç‚¹çš„æ ‘è·¯å¾„</span></span><br><span class="line">      start, <span class="comment">// æ›´æ–°èŠ‚ç‚¹åœ¨childrenä¸­çš„ç´¢å¼•</span></span><br><span class="line">      deleteCount,</span><br><span class="line">      items, <span class="comment">// å½“å‰èŠ‚ç‚¹çš„ä¿¡æ¯</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> (immediately) &#123;</span><br><span class="line">      <span class="keyword">this</span>.updateQueue.push(update);</span><br><span class="line">      <span class="keyword">this</span>.applyUpdate();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// æ”¾å…¥æ›´æ–°é˜Ÿåˆ—ï¼Œå»¶æ—¶æ”¶é›†æ›´æ–°æŒ‡ä»¤</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.updateQueue.length === <span class="number">0</span>) &#123;</span><br><span class="line">        setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">this</span>.applyUpdate());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">this</span>.updateQueue.push(update);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  applyUpdate() &#123;</span><br><span class="line">    <span class="keyword">const</span> action = &#123;</span><br><span class="line">      type: <span class="string">'splice'</span>,</span><br><span class="line">      payload: <span class="keyword">this</span>.updateQueue.map(<span class="function"><span class="params">update</span> =&gt;</span> (&#123;</span><br><span class="line">        path: stringPath(update.path),</span><br><span class="line">        start: update.start,</span><br><span class="line">        deleteCount: update.deleteCount,</span><br><span class="line">        item: update.items[<span class="number">0</span>],</span><br><span class="line">      &#125;)),</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€šè¿‡setDataé€šçŸ¥æ¸²æŸ“è¿›ç¨‹</span></span><br><span class="line">    <span class="keyword">this</span>.context.setData(&#123; action &#125;);</span><br><span class="line">    <span class="keyword">this</span>.updateQueue = [];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>é€»è¾‘è¿˜æ˜¯æ¯”è¾ƒæ¸…æ¥šçš„ï¼Œå³å°†éœ€è¦æ›´æ–°çš„èŠ‚ç‚¹(åŒ…å«èŠ‚ç‚¹è·¯å¾„ã€èŠ‚ç‚¹ä¿¡æ¯)æ¨å…¥æ›´æ–°é˜Ÿåˆ—ï¼Œç„¶åè§¦å‘ <code>setData</code> é€šçŸ¥åˆ°<code>æ¸²æŸ“è¿›ç¨‹</code>ã€‚</p><p><br></p><p><code>æ¸²æŸ“è¿›ç¨‹</code>ä¾§ï¼Œåˆ™éœ€è¦é€šè¿‡ <code>WXS</code> æœºåˆ¶ï¼Œç›¸å¯¹åº”åœ°å°†<code>æ›´æ–°æŒ‡ä»¤</code>æ¢å¤åˆ°<code>æ¸²æŸ“æ ‘</code>ä¸­ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ¸²æŸ“æ ‘</span></span><br><span class="line"><span class="keyword">var</span> tree = &#123;</span><br><span class="line">  root: &#123;</span><br><span class="line">    children: [],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†æŒ‡ä»¤åº”ç”¨åˆ°æ¸²æŸ“æ ‘</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reduce</span>(<span class="params">action</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'splice'</span>:</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; action.payload.length; i += <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> value = <span class="keyword">get</span>(tree, action.payload[i].path);</span><br><span class="line">        if (action.payload[i].item) &#123;</span><br><span class="line">          value.splice(</span><br><span class="line">            action.payload[i].start,</span><br><span class="line">            action.payload[i].deleteCount,</span><br><span class="line">            action.payload[i].item</span><br><span class="line">          );</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          value.splice(action.payload[i].start, action.payload[i].deleteCount);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span>(tree, action.payload[i].path, value);</span><br><span class="line">      &#125;</span><br><span class="line">      return tree;</span><br><span class="line">    default:</span><br><span class="line">      return tree;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>OK, æ¥ç€å¼€å§‹æ¸²æŸ“, <a href="https://github.com/remaxjs" target="_blank" rel="noopener"><code>Remax</code></a> é‡‡ç”¨äº†<code>æ¨¡æ¿</code>çš„å½¢å¼è¿›è¡Œæ¸²æŸ“:</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">wxs</span> <span class="attr">src</span>=<span class="string">"../../helper.wxs"</span> <span class="attr">module</span>=<span class="string">"helper"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">import</span> <span class="attr">src</span>=<span class="string">"../../base.wxml"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">template</span> <span class="attr">is</span>=<span class="string">"REMAX_TPL"</span> <span class="attr">data</span>=<span class="string">"&#123;&#123;tree: helper.reduce(action)&#125;&#125;"</span> /&gt;</span></span><br></pre></td></tr></table></figure><p><a href="https://github.com/remaxjs" target="_blank" rel="noopener"><code>Remax</code></a> ä¸ºæ¯ä¸ªç»„ä»¶ç±»å‹éƒ½ç”Ÿæˆäº†ä¸€ä¸ª<code>template</code>ï¼ŒåŠ¨æ€â€™é€’å½’â€™æ¸²æŸ“æ•´é¢—æ ‘:</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span> <span class="attr">name</span>=<span class="string">"REMAX_TPL"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">block</span> <span class="attr">wx:for</span>=<span class="string">"&#123;&#123;tree.root.children&#125;&#125;"</span> <span class="attr">wx:key</span>=<span class="string">"&#123;&#123;id&#125;&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">template</span> <span class="attr">is</span>=<span class="string">"REMAX_TPL_1_CONTAINER"</span> <span class="attr">data</span>=<span class="string">"&#123;&#123;i: item&#125;&#125;"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">wxs</span> <span class="attr">module</span>=<span class="string">"_h"</span>&gt;</span></span><br><span class="line">  module.exports = &#123;</span><br><span class="line">  v: function(value) &#123;</span><br><span class="line">  return value !== undefined ? value : '';</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"><span class="tag">&lt;/<span class="name">wxs</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- æŒ‰ç…§å±‚çº§ç”Ÿæˆæ¨¡æ¿ --&gt;</span></span><br><span class="line">&lt;% for (var i = 1; i &lt;= depth; i++) &#123; %&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">%var</span> <span class="attr">id</span> = <span class="string">i;</span> %&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- ç”Ÿæˆç»„ä»¶æ¨¡æ¿ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">%</span> <span class="attr">for</span> (<span class="attr">let</span> <span class="attr">component</span> <span class="attr">of</span> <span class="attr">components</span>) &#123; %&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">%-</span> <span class="attr">include</span>('<span class="attr">.</span>/<span class="attr">component.ejs</span>', &#123;</span></span><br><span class="line"><span class="tag">        <span class="attr">props:</span> <span class="attr">component.props</span>,</span></span><br><span class="line"><span class="tag">        <span class="attr">id:</span> <span class="attr">component.id</span>,</span></span><br><span class="line"><span class="tag">        <span class="attr">templateId:</span> <span class="attr">id</span>,</span></span><br><span class="line"><span class="tag">      &#125;) %&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">%</span> &#125; %&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">template</span> <span class="attr">name</span>=<span class="string">"REMAX_TPL_&lt;%=id%&gt;_plain-text"</span> <span class="attr">data</span>=<span class="string">"&#123;&#123;i: i&#125;&#125;"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">block</span>&gt;</span>&#123;&#123;i.text&#125;&#125;<span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--  æŠŠåŠ¨æ€é€‰æ‹©æ¨¡æ¿çš„é€»è¾‘æ”¾å…¥ä¸€ä¸ªæ¨¡æ¿å†…ï¼Œå¯ä»¥æå‡æ€§èƒ½é—®é¢˜ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">template</span> <span class="attr">name</span>=<span class="string">"REMAX_TPL_&lt;%=id%&gt;_CONTAINER"</span> <span class="attr">data</span>=<span class="string">"&#123;&#123;i: i&#125;&#125;"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">template</span> <span class="attr">is</span>=<span class="string">"&#123;&#123;'REMAX_TPL_&lt;%=id%&gt;_' + i.type&#125;&#125;"</span> <span class="attr">data</span>=<span class="string">"&#123;&#123;i: i&#125;&#125;"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">%</span> &#125; %&gt;</span></span><br></pre></td></tr></table></figure><p><br></p><p>é™äºå°ç¨‹åºçš„æ¸²æŸ“æœºåˆ¶ï¼Œä»¥ä¸‹å› ç´ å¯èƒ½ä¼šå½±å“æ¸²æŸ“çš„æ€§èƒ½:</p><ul><li>è¿›ç¨‹IPCã€‚æ›´æ–°æŒ‡ä»¤é€šè¿‡IPCé€šçŸ¥åˆ°æ¸²æŸ“è¿›ç¨‹ï¼Œé¢‘ç¹æ›´æ–°å¯èƒ½ä¼šå½±å“æ€§èƒ½.  ReactNative ä¸­æ¶‰åŠåˆ° Native å’Œ JSå¼•æ“ä¹‹é—´çš„é€šä¿¡ï¼Œä¹Ÿæ˜¯å­˜åœ¨è¿™ä¸ªé—®é¢˜çš„ã€‚<br>æ‰€ä»¥å°ç¨‹åºæ‰æœ‰äº† <code>WXS</code> è¿™ç±»æ–¹æ¡ˆï¼Œç”¨æ¥å¤„ç†å¤æ‚çš„è§†å›¾äº¤äº’é—®é¢˜ï¼Œæ¯”å¦‚åŠ¨ç”»ã€‚æœªæ¥ <a href="https://github.com/remaxjs" target="_blank" rel="noopener"><code>Remax</code></a> ä¹Ÿéœ€è¦è€ƒè™‘è¿™ä¸ªé—®é¢˜</li><li><code>Reconciler</code>è¿™ä¸€å±‚å·²ç»è¿›è¡Œäº† Diffï¼Œåˆ°<code>æ¸²æŸ“è¿›ç¨‹</code>å¯èƒ½éœ€è¦é‡å¤å†åšä¸€éï¼Ÿ</li><li>åŸºäºæ¨¡æ¿çš„æ–¹æ¡ˆï¼Œå±€éƒ¨æ›´æ–°æ˜¯å¦ä¼šå¯¼è‡´é¡µé¢çº§åˆ«é‡æ–°æ¸²æŸ“ï¼Ÿå’Œå°ç¨‹åºåŸç”Ÿçš„è‡ªå®šä¹‰ç»„ä»¶ç›¸æ¯”æ€§èƒ½å¦‚ä½•ï¼Ÿ</li></ul><p><br></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ¬æ–‡ä»¥ <a href="https://github.com/remaxjs" target="_blank" rel="noopener"><code>Remax</code></a> ä¸ºä¾‹ï¼Œç§‘æ™®ä¸€ä¸ª React è‡ªå®šä¹‰æ¸²æŸ“å™¨æ˜¯å¦‚ä½•è¿ä½œçš„ã€‚å¯¹äº <a href="https://github.com/remaxjs" target="_blank" rel="noopener"><code>Remax</code></a>ï¼Œç›®å‰è¿˜å¤„äºå¼€å‘é˜¶æ®µï¼Œå¾ˆå¤šåŠŸèƒ½è¿˜ä¸å®Œå–„ã€‚è‡³äº<a href="https://github.com/remaxjs/remax/issues/156" target="_blank" rel="noopener">æ€§èƒ½å¦‚ä½•</a>ï¼Œç¬”è€…è¿˜ä¸å¥½åšè¯„è®ºï¼Œå¯ä»¥çœ‹å®˜æ–¹ç»™å‡ºçš„åˆæ­¥<a href="https://github.com/remaxjs/benchmark" target="_blank" rel="noopener">åŸºå‡†æµ‹è¯•</a>ã€‚æœ‰èƒ½åŠ›çš„åŒå­¦ï¼Œå¯ä»¥å‚ä¸ä»£ç è´¡çŒ®æˆ–è€… Issue è®¨è®ºã€‚</p><p>æœ€åè°¢è°¢<a href="https://www.zhihu.com/people/meck" target="_blank" rel="noopener">è¾¹æŸ³</a>å¯¹æœ¬æ–‡å®¡æ ¡å’Œå»ºè®®ã€‚</p><p><br></p><h2 id="æ‰©å±•é˜…è¯»"><a href="#æ‰©å±•é˜…è¯»" class="headerlink" title="æ‰©å±•é˜…è¯»"></a>æ‰©å±•é˜…è¯»</h2><ul><li><a href="https://zhuanlan.zhihu.com/p/79788488" target="_blank" rel="noopener">Remax - ä½¿ç”¨çœŸæ­£çš„ React æ„å»ºå°ç¨‹åº</a></li><li><a href="https://zhuanlan.zhihu.com/p/26027085" target="_blank" rel="noopener">React Fiberæ˜¯ä»€ä¹ˆ</a></li><li><a href="https://zhuanlan.zhihu.com/p/57346388" target="_blank" rel="noopener">æ·±å…¥React fiberæ¶æ„åŠæºç </a></li><li><a href="https://medium.com/@agent_hunt/hello-world-custom-react-renderer-9a95b7cd04bc" target="_blank" rel="noopener">Hello World Custom React Renderer - Shailesh - Medium</a></li><li><a href="https://blog.atulr.com/react-custom-renderer-1/" target="_blank" rel="noopener">âš›ï¸ğŸ‘† Part 1/3 - Beginners guide to Custom React Renderers. How to build your own renderer from scratch?</a> è¿™ç³»åˆ—æ–‡ç« å¾ˆæ£’</li><li><a href="https://zhuanlan.zhihu.com/p/82741561" target="_blank" rel="noopener">è°œä¹‹wxsï¼Œuni-appå¦‚ä½•ç”¨å®ƒå¤§å¹…æå‡æ€§èƒ½</a></li><li><a href="https://zhuanlan.zhihu.com/p/59787245" target="_blank" rel="noopener">å…¨æ–°é‡æ„ï¼Œuni-appå®ç°å¾®ä¿¡ç«¯æ€§èƒ½ç¿»å€</a></li><li><a href="https://www.zhihu.com/search?type=content&amp;q=å°ç¨‹åºåŸç†" target="_blank" rel="noopener">æµ…è°ˆå°ç¨‹åºè¿è¡Œæœºåˆ¶</a></li></ul><p><br></p><p><img src="/images/sponsor.jpg" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;ä¸Šä¸ªæœˆèš‚èšé‡‘æœå‰ç«¯å‘å¸ƒäº†ä¸€ä¸ªæ–°çš„æ¡†æ¶ &lt;a href=&quot;https://github.com/remaxjs&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;&lt;code&gt;Remax&lt;/code&gt;&lt;/a&gt;, å£å·æ˜¯&lt;strong&gt;ä½¿ç”¨çœŸæ­£çš„ã€å®Œæ•´çš„ React
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://bobi.ink/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>é€è¿‡ç°è±¡çœ‹æœ¬è´¨: å¸¸è§çš„å‰ç«¯æ¶æ„é£æ ¼å’Œæ¡ˆä¾‹</title>
    <link href="https://bobi.ink/2019/09/11/arch-pattern/"/>
    <id>https://bobi.ink/2019/09/11/arch-pattern/</id>
    <published>2019-09-10T16:00:00.000Z</published>
    <updated>2019-09-16T21:24:24.973Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>æ‰€è°“è½¯ä»¶æ¶æ„é£æ ¼ï¼Œæ˜¯æŒ‡æè¿°æŸä¸ªç‰¹å®šåº”ç”¨é¢†åŸŸä¸­ç³»ç»Ÿç»„ç»‡æ–¹å¼çš„æƒ¯ç”¨æ¨¡å¼ã€‚æ¶æ„é£æ ¼å®šä¹‰ä¸€ä¸ªè¯æ±‡è¡¨å’Œä¸€ç»„çº¦æŸï¼Œè¯æ±‡è¡¨ä¸­åŒ…å«ä¸€äº›ç»„ä»¶åŠè¿æ¥å™¨ï¼Œçº¦æŸåˆ™æŒ‡å‡ºç³»ç»Ÿå¦‚ä½•å°†æ„å»ºå’Œè¿æ¥å™¨ç»„åˆèµ·æ¥ã€‚è½¯ä»¶æ¶æ„é£æ ¼åæ˜ äº†é¢†åŸŸä¸­ä¼—å¤šç³»ç»Ÿæ‰€å…±æœ‰çš„ç»“æ„å’Œè¯­ä¹‰ç‰¹æ€§ï¼Œå¹¶æŒ‡å¯¼å¦‚ä½•å°†ç³»ç»Ÿä¸­çš„å„ä¸ªæ¨¡å—å’Œå­ç³»ç»Ÿæœ‰æœºçš„ç»“åˆä¸ºä¸€ä¸ªå®Œæ•´çš„ç³»ç»Ÿ</p></blockquote><p>æ²¡å¤šå°‘äººèƒ½è®°ä½ä¸Šé¢çš„å®šä¹‰ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯æœ¬æ–‡ä¸æ˜¯ä¸“ä¸šè®¨è®ºç³»ç»Ÿæ¶æ„çš„æ–‡ç« ï¼Œç¬”è€…ä¹Ÿè¿˜æ²¡åˆ°é‚£ä¸ªæ°´å¹³. æ‰€ä»¥æš‚æ—¶æ²¡å¿…è¦çº ç»“äºä»€ä¹ˆæ˜¯æ¶æ„æ¨¡å¼ã€ä»€ä¹ˆæ˜¯æ¶æ„é£æ ¼ã€‚åœ¨è¿™é‡Œ<strong>å°šä¸”æŠŠå®ƒä»¬éƒ½å½“æˆä¸€ä¸ªç³»ç»Ÿæ¶æ„ä¸Šçš„å¥—è·¯, æ‰€è°“çš„å¥—è·¯å°±æ˜¯ä¸€äº›é€šç”¨çš„ã€å¯å¤ç”¨çš„ï¼Œç”¨äºåº”å¯¹æŸç±»é—®é¢˜çš„æ–¹å¼æ–¹æ³•. å¯ä»¥ç†è§£ä¸ºç±»ä¼¼â€œè®¾è®¡æ¨¡å¼â€çš„ä¸œè¥¿ï¼Œåªæ˜¯è§£å†³é—®é¢˜çš„å±‚æ¬¡ä¸ä¸€æ ·</strong>ã€‚</p><p>é€è¿‡ç°è±¡çœ‹æœ¬è´¨ï¼Œæœ¬æ–‡å°†å¸¦ä½ é¢†ç•¥å‰ç«¯é¢†åŸŸä¸€äº›æµè¡ŒæŠ€æœ¯æ ˆèƒŒåçš„æ¶æ„æ€æƒ³ã€‚ç›´æ¥è¿›å…¥æ­£é¢˜å§</p><p><strong>æ–‡ç« å¤§çº²</strong></p><!-- TOC --><ul><li><a href="#åˆ†å±‚é£æ ¼">åˆ†å±‚é£æ ¼</a><ul><li><a href="#virtual-dom">Virtual DOM</a></li><li><a href="#taro">Taro</a></li></ul></li><li><a href="#ç®¡é“å’Œè¿‡æ»¤å™¨">ç®¡é“å’Œè¿‡æ»¤å™¨</a><ul><li><a href="#ä¸­é—´ä»¶middleware">ä¸­é—´ä»¶(Middleware)</a></li></ul></li><li><a href="#äº‹ä»¶é©±åŠ¨">äº‹ä»¶é©±åŠ¨</a></li><li><a href="#mv">MV*</a><ul><li><a href="#å®¶å–»æˆ·æ™“çš„mvc">å®¶å–»æˆ·æ™“çš„MVC</a></li><li><a href="#redux">Redux</a></li></ul></li><li><a href="#å¤åˆ¶é£æ ¼">å¤åˆ¶é£æ ¼</a></li><li><a href="#å¾®å†…æ ¸æ¶æ„">å¾®å†…æ ¸æ¶æ„</a></li><li><a href="#å¾®å‰ç«¯">å¾®å‰ç«¯</a></li><li><a href="#ç»„ä»¶åŒ–æ¶æ„">ç»„ä»¶åŒ–æ¶æ„</a></li><li><a href="#å…¶ä»–">å…¶ä»–</a></li><li><a href="#æ‰©å±•é˜…è¯»">æ‰©å±•é˜…è¯»</a></li></ul><!-- /TOC --><p><br></p><h2 id="åˆ†å±‚é£æ ¼"><a href="#åˆ†å±‚é£æ ¼" class="headerlink" title="åˆ†å±‚é£æ ¼"></a>åˆ†å±‚é£æ ¼</h2><blockquote><p>æ²¡æœ‰ä»€ä¹ˆé—®é¢˜æ˜¯åˆ†å±‚è§£å†³ä¸äº†ï¼Œå¦‚æœè§£å†³ä¸äº†, å°±å†åŠ ä¸€å±‚ â€”â€” é²è¿… <br><br>ä¸ä¸ï¼ŒåŸè¯æ˜¯: <code>Any problem  in computer science can be solved by anther layer of indirection.</code></p></blockquote><p>åˆ†å±‚æ¶æ„æ˜¯æœ€å¸¸è§çš„è½¯ä»¶æ¶æ„ï¼Œä½ è¦ä¸çŸ¥é“ç”¨ä»€ä¹ˆæ¶æ„ï¼Œæˆ–è€…ä¸çŸ¥é“æ€ä¹ˆè§£å†³é—®é¢˜ï¼Œé‚£å°±å°è¯•åŠ å¤šä¸€å±‚ã€‚</p><p>ä¸€ä¸ªåˆ†å±‚ç³»ç»Ÿæ˜¯æŒ‰ç…§å±‚æ¬¡æ¥ç»„ç»‡çš„ï¼Œæ¯ä¸€å±‚ä¸ºåœ¨å…¶ä¹‹ä¸Šçš„å±‚æä¾›æœåŠ¡ï¼Œå¹¶ä¸”ä½¿ç”¨åœ¨å…¶ä¹‹ä¸‹çš„å±‚æ‰€æä¾›çš„æœåŠ¡. <strong>åˆ†å±‚é€šå¸¸å¯ä»¥è§£å†³ä»€ä¹ˆé—®é¢˜</strong>ï¼Ÿ</p><ul><li><p><strong>æ˜¯éš”ç¦»ä¸šåŠ¡å¤æ‚åº¦ä¸æŠ€æœ¯å¤æ‚åº¦çš„åˆ©å™¨</strong>. å…¸å‹çš„ä¾‹å­æ˜¯ç½‘ç»œåè®®, è¶Šé«˜å±‚è¶Šé¢å‘äººç±»ï¼Œè¶Šåº•å±‚è¶Šé¢å‘æœºå™¨ã€‚ä¸€å±‚ä¸€å±‚å¾€ä¸Šï¼Œå¾ˆå¤šæŠ€æœ¯çš„ç»†èŠ‚éƒ½è¢«éšè—äº†ï¼Œæ¯”å¦‚æˆ‘ä»¬ä½¿ç”¨<code>HTTP</code>æ—¶ï¼Œä¸éœ€è¦è€ƒè™‘<code>TCP</code>å±‚çš„æ¡æ‰‹å’ŒåŒ…ä¼ è¾“ç»†èŠ‚ï¼Œ<code>TCP</code>å±‚ä¸éœ€è¦å…³å¿ƒ<code>IP</code>å±‚çš„å¯»å€å’Œè·¯ç”±ã€‚</p><p><img src="/images/arch-pattern/tcp-ip-model.png" alt></p><p><br></p></li><li><p><strong>åˆ†ç¦»å…³æ³¨ç‚¹å’Œå¤ç”¨</strong>ã€‚å‡å°‘è·¨è¶Šå¤šå±‚çš„è€¦åˆ, å½“ä¸€å±‚å˜åŠ¨æ—¶ä¸ä¼šå½±å“åˆ°å…¶ä»–å±‚ã€‚ä¾‹å¦‚æˆ‘ä»¬å‰ç«¯é¡¹ç›®å»ºè®®æ‹†åˆ†é€»è¾‘å±‚å’Œè§†å›¾å±‚ï¼Œä¸€æ–¹é¢å¯ä»¥é™ä½é€»è¾‘å’Œè§†å›¾ä¹‹é—´çš„è€¦åˆï¼Œå½“è§†å›¾å±‚å…ƒç´ å˜åŠ¨æ—¶å¯ä»¥å°½é‡å‡å°‘å¯¹é€»è¾‘å±‚çš„å½±å“ï¼›å¦å¤–ä¸€ä¸ªå¥½å¤„æ˜¯, å½“é€»è¾‘æŠ½å–å‡ºå»åï¼Œå¯ä»¥è¢«ä¸åŒå¹³å°çš„è§†å›¾å¤ç”¨ã€‚</p></li></ul><p><br></p><p>å…³æ³¨ç‚¹åˆ†ç¦»ä¹‹åï¼Œè½¯ä»¶çš„ç»“æ„ä¼šå˜å¾—å®¹æ˜“ç†è§£å’Œå¼€å‘, æ¯ä¸€å±‚å¯ä»¥è¢«å¤ç”¨, å®¹æ˜“è¢«æµ‹è¯•, å…¶ä»–å±‚çš„æ¥å£é€šè¿‡æ¨¡æ‹Ÿè§£å†³. ä½†æ˜¯åˆ†å±‚æ¶æ„ï¼Œä¹Ÿä¸æ˜¯å…¨æ˜¯ä¼˜ç‚¹ï¼Œ<strong>åˆ†å±‚çš„æŠ½è±¡å¯èƒ½ä¼šä¸¢å¤±éƒ¨åˆ†æ•ˆç‡å’Œçµæ´»æ€§</strong>, æ¯”å¦‚ç¼–ç¨‹è¯­è¨€å°±æœ‰â€™å±‚æ¬¡â€™(æ­¤ä¾‹å¯èƒ½ä¸å¤ªä¸¥è°¨)ï¼Œè¯­è¨€æŠ½è±¡çš„å±‚æ¬¡è¶Šé«˜ï¼Œä¸€èˆ¬è¿è¡Œæ•ˆç‡å¯èƒ½ä¼šæœ‰æ‰€è¡°å‡:</p><p><img src="/images/arch-pattern/lang.png" alt></p><p>åˆ†å±‚æ¶æ„åœ¨è½¯ä»¶é¢†åŸŸçš„æ¡ˆä¾‹å®åœ¨å¤ªå¤šå¤ªå¤šäº†ï¼Œå’±è®²è®²å‰ç«¯çš„ä¸€äº›â€™åˆ†å±‚â€™æ¡ˆä¾‹ï¼š</p><p><br></p><h3 id="virtual-dom"><a href="#virtual-dom" class="headerlink" title="Virtual DOM"></a>Virtual DOM</h3><p>å‰ç«¯çŸ³å™¨æ—¶ä»£ï¼Œæˆ‘ä»¬é¡µé¢äº¤äº’å’Œæ¸²æŸ“ï¼Œæ˜¯é€šè¿‡æœåŠ¡ç«¯æ¸²æŸ“æˆ–è€…ç›´æ¥æ“ä½œDOMå®ç°çš„, æœ‰ç‚¹åƒC/C++è¿™ç±»ç³»ç»Ÿç¼–ç¨‹è¯­è¨€æ‰‹åŠ¨æ“çºµå†…å­˜. é‚£æ—¶å€™<code>JQuery</code>å¾ˆç«:</p><p><img src="/images/arch-pattern/jquery.png" alt></p><p>åæ¥éšç€è½¯ç¡¬ä»¶æ€§èƒ½è¶Šæ¥è¶Šå¥½ã€Webåº”ç”¨ä¹Ÿè¶Šæ¥è¶Šå¤æ‚ï¼Œå‰ç«¯å¼€å‘è€…çš„ç”Ÿäº§åŠ›ä¹Ÿè¦è·Ÿä¸Šï¼Œç±»ä¼¼JQueryè¿™ç§å‘½ä»¤å¼çš„ç¼–ç¨‹æ–¹å¼æ— ç–‘æ˜¯æ¯”è¾ƒä½æ•ˆçš„. å°½ç®¡æ‰‹åŠ¨æ“ä½œ DOM å¯èƒ½å¯ä»¥è¾¾åˆ°æ›´é«˜çš„æ€§èƒ½å’Œçµæ´»æ€§ï¼Œä½†æ˜¯è¿™æ ·å¯¹å¤§éƒ¨åˆ†å¼€å‘è€…æ¥è¯´å¤ªä½æ•ˆäº†ï¼Œæˆ‘ä»¬æ˜¯å¯ä»¥æ¥å—ç‰ºç‰²ä¸€ç‚¹æ€§èƒ½æ¢å–æ›´é«˜çš„å¼€å‘æ•ˆç‡çš„.</p><p>æ€ä¹ˆè§£å†³ï¼Œå†åŠ ä¸€å±‚å§ï¼Œåæ¥Reactå°±æäº†ä¸€å±‚VirtualDOMã€‚æˆ‘ä»¬å¯ä»¥å£°æ˜å¼ã€ç»„åˆå¼åœ°æ„å»ºä¸€é¢—å¯¹è±¡æ ‘, ç„¶åäº¤ç”±Reactå°†å®ƒæ˜ å°„åˆ°DOMï¼š</p><p><img src="/images/arch-pattern/vd1.png" alt></p><p>ä¸€å¼€å§‹VirtualDOMå’ŒDOMçš„å…³ç³»æ¯”è¾ƒæš§æ˜§ï¼Œä¸¤è€…æ˜¯è€¦åˆåœ¨ä¸€èµ·çš„ã€‚åé¢æœ‰äººæƒ³ï¼Œæˆ‘ä»¬æœ‰äº†VirtualDOMè¿™ä¸ªæŠ½è±¡å±‚ï¼Œé‚£åº”è¯¥èƒ½å¤šæç‚¹åˆ«çš„ï¼Œæ¯”å¦‚æ¸²æŸ“åˆ°ç§»åŠ¨ç«¯åŸç”Ÿç»„ä»¶ã€PDFã€Canvasã€ç»ˆç«¯UIç­‰ç­‰ã€‚</p><p>åæ¥VirtualDOMè¿›è¡Œäº†æ›´å½»åº•çš„åˆ†å±‚ï¼Œæœ‰ç€è¿™ä¸ªæŠ½è±¡å±‚æˆ‘ä»¬å¯ä»¥å°†VirtualDOMæ˜ å°„åˆ°æ›´å¤šç±»ä¼¼åº”ç”¨åœºæ™¯:</p><p><img src="/images/arch-pattern/vd2.png" alt></p><p>æ‰€ä»¥è¯´ VirtualDOM æ›´å¤§çš„æ„ä¹‰åœ¨äºå¼€å‘æ–¹å¼çš„è½¬å˜: å£°æ˜å¼ã€ æ•°æ®é©±åŠ¨, è®©å¼€å‘è€…ä¸éœ€è¦å…³å¿ƒ DOM çš„æ“ä½œç»†èŠ‚(å±æ€§æ“ä½œã€äº‹ä»¶ç»‘å®šã€DOM èŠ‚ç‚¹å˜æ›´)ï¼Œæ¢å¥è¯è¯´åº”ç”¨çš„å¼€å‘æ–¹å¼å˜æˆäº†<code>view=f(state)</code>, è¿™å¯¹ç”Ÿäº§åŠ›çš„è§£æ”¾æ˜¯æœ‰å¾ˆå¤§æ¨åŠ¨ä½œç”¨çš„; å¦å¤–æœ‰äº†VirtualDOMè¿™ä¸€å±‚æŠ½è±¡å±‚ï¼Œä½¿å¾—å¤šå¹³å°æ¸²æŸ“æˆä¸ºå¯èƒ½ã€‚</p><p>å½“ç„¶VirtualDOMæˆ–è€…Reactï¼Œä¸æ˜¯å”¯ä¸€ï¼Œä¹Ÿä¸æ˜¯ç¬¬ä¸€ä¸ªè¿™æ ·çš„è§£å†³æ–¹æ¡ˆã€‚å…¶ä»–å‰ç«¯æ¡†æ¶ï¼Œä¾‹å¦‚Vueã€AngularåŸºæœ¬éƒ½æ˜¯è¿™æ ·ä¸€ä¸ªå‘å±•å†ç¨‹ã€‚</p><p>ä¸Šé¢è¯´äº†ï¼Œåˆ†å±‚ä¸æ˜¯é“¶å¼¹ã€‚æˆ‘ä»¬é€šè¿‡ReactNativeå¯ä»¥å¼€å‘è·¨å¹³å°çš„ç§»åŠ¨åº”ç”¨ï¼Œä½†æ˜¯ä¼—æ‰€å‘¨çŸ¥ï¼Œå®ƒè¿è¡Œæ•ˆç‡æˆ–è€…çµæ´»æ€§æš‚æ—¶æ˜¯æ— æ³•ä¸åŸç”Ÿåº”ç”¨æ¯”æ‹Ÿçš„ã€‚</p><p><br></p><h3 id="taro"><a href="#taro" class="headerlink" title="Taro"></a>Taro</h3><p><strong><a href="https://taro-docs.jd.com/taro/docs/README.html" target="_blank" rel="noopener">Taro</a> å’ŒReactä¸€æ ·ä¹Ÿé‡‡ç”¨åˆ†å±‚æ¶æ„é£æ ¼ï¼Œåªä¸è¿‡ä»–ä»¬è§£å†³çš„é—®é¢˜æ˜¯ç›¸åçš„ã€‚ReactåŠ ä¸Šä¸€ä¸ªåˆ†å±‚ï¼Œå¯ä»¥æ¸²æŸ“åˆ°ä¸åŒçš„è§†å›¾å½¢æ€ï¼›è€ŒTaroåˆ™æ˜¯ä¸ºäº†ç»Ÿä¸€å¤šæ ·çš„è§†å›¾å½¢æ€</strong>: å›½å†…ç°å¦‚ä»Šå¸‚é¢ä¸Šç«¯çš„å½¢æ€å¤šç§å¤šæ ·ï¼ŒWebã€React-Nativeã€å¾®ä¿¡å°ç¨‹åºâ€¦â€¦ é’ˆå¯¹ä¸åŒçš„ç«¯å»ç¼–å†™å¤šå¥—ä»£ç çš„æˆæœ¬éå¸¸é«˜ï¼Œè¿™ç§éœ€æ±‚å‚¬ç”Ÿäº†Taroè¿™ç±»æ¡†æ¶çš„è¯ç”Ÿ. ä½¿ç”¨ Taroï¼Œæˆ‘ä»¬å¯ä»¥åªä¹¦å†™ä¸€å¥—ä»£ç , é€šè¿‡ç¼–è¯‘å·¥å…·å¯ä»¥è¾“å‡ºåˆ°ä¸åŒçš„ç«¯:</p><p><img src="/images/arch-pattern/taro.jpg" alt><br>(å›¾ç‰‡æ¥æº: <a href="https://aotu.io/notes/2018/06/07/Taro/" target="_blank" rel="noopener">å¤šç«¯ç»Ÿä¸€å¼€å‘æ¡†æ¶ - Taro</a>)</p><p><br><br><br></p><h2 id="ç®¡é“å’Œè¿‡æ»¤å™¨"><a href="#ç®¡é“å’Œè¿‡æ»¤å™¨" class="headerlink" title="ç®¡é“å’Œè¿‡æ»¤å™¨"></a>ç®¡é“å’Œè¿‡æ»¤å™¨</h2><p>åœ¨ç®¡é“/è¿‡æ»¤å™¨æ¶æ„é£æ ¼ä¸­ï¼Œæ¯ä¸ªç»„ä»¶éƒ½æœ‰ä¸€ç»„è¾“å…¥å’Œè¾“å‡ºï¼Œæ¯ä¸ªç»„ä»¶èŒè´£éƒ½å¾ˆå•ä¸€, æ•°æ®è¾“å…¥ç»„ä»¶ï¼Œç»è¿‡å†…éƒ¨å¤„ç†ï¼Œç„¶åå°†å¤„ç†è¿‡çš„æ•°æ®è¾“å‡ºã€‚æ‰€ä»¥è¿™äº›ç»„ä»¶ä¹Ÿç§°ä¸ºè¿‡æ»¤å™¨ï¼Œè¿æ¥å™¨æŒ‰ç…§ä¸šåŠ¡éœ€æ±‚å°†ç»„ä»¶è¿æ¥èµ·æ¥ï¼Œå…¶å½¢çŠ¶å°±åƒâ€˜ç®¡é“â€™ä¸€æ ·ï¼Œè¿™ç§æ¶æ„é£æ ¼ç”±æ­¤å¾—åã€‚</p><p><img src="/images/arch-pattern/pipeline.png" alt></p><p>è¿™é‡Œé¢æœ€ç»å…¸çš„æ¡ˆä¾‹æ˜¯<code>*unix</code> Shellå‘½ä»¤ï¼ŒUnixçš„å“²å­¦å°±æ˜¯â€œåªåšä¸€ä»¶äº‹ï¼ŒæŠŠå®ƒåšå¥½â€ï¼Œæ‰€ä»¥æˆ‘ä»¬å¸¸ç”¨çš„Unixå‘½ä»¤åŠŸèƒ½éƒ½éå¸¸å•ä¸€ï¼Œä½†æ˜¯Unix Shellè¿˜æœ‰ä¸€ä»¶æ³•å®å°±æ˜¯ç®¡é“ï¼Œé€šè¿‡ç®¡é“æˆ‘ä»¬å¯ä»¥å°†å‘½ä»¤é€šè¿‡<code>æ ‡å‡†è¾“å…¥è¾“å‡º</code>ä¸²è”èµ·æ¥å®ç°å¤æ‚çš„åŠŸèƒ½:</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span> è·å–ç½‘é¡µï¼Œå¹¶è¿›è¡Œæ‹¼å†™æ£€æŸ¥ã€‚ä»£ç æ¥æºäºwiki</span><br><span class="line">curl "http://en.wikipedia.org/wiki/Pipeline_(Unix)" | \</span><br><span class="line">sed 's/[^a-zA-Z ]/ /g' | \</span><br><span class="line">tr 'A-Z ' 'a-z\n' | \</span><br><span class="line">grep '[a-z]' | \</span><br><span class="line">sort -u | \</span><br><span class="line">comm -23 - /usr/share/dict/words | \</span><br><span class="line">less</span><br></pre></td></tr></table></figure><p><br></p><p>å¦ä¸€ä¸ªå’ŒUnixç®¡é“ç›¸ä¼¼çš„ä¾‹å­æ˜¯<code>ReactiveX</code>, ä¾‹å¦‚<a href="https://github.com/ReactiveX/rxjs" target="_blank" rel="noopener">RxJS</a>. å¾ˆå¤šæ•™ç¨‹å°†Rxæ¯”å–»æˆæ²³æµï¼Œè¿™ä¸ªæ²³æµçš„å¼€å¤´å°±æ˜¯ä¸€ä¸ªäº‹ä»¶æºï¼Œè¿™ä¸ªäº‹ä»¶æºæŒ‰ç…§ä¸€å®šçš„é¢‘ç‡å‘å¸ƒäº‹ä»¶ã€‚RxçœŸæ­£å¼ºå¤§çš„å…¶å®æ˜¯å®ƒçš„æ“ä½œç¬¦ï¼Œæœ‰äº†è¿™äº›æ“ä½œç¬¦ï¼Œä½ å¯ä»¥å¯¹è¿™æ¡æ²³æµ<a href="https://rxjs.dev/operator-decision-tree" target="_blank" rel="noopener">åšä¸€åˆ‡å¯ä»¥åšçš„äº‹æƒ…</a>ï¼Œä¾‹å¦‚åˆ†æµã€èŠ‚æµã€å»ºå¤§åã€è½¬æ¢ã€ç»Ÿè®¡ã€åˆå¹¶ã€äº§ç”Ÿæ²³æµçš„æ²³æµâ€¦â€¦</p><p>è¿™äº›æ“ä½œç¬¦å’ŒUnixçš„å‘½ä»¤ä¸€æ ·ï¼ŒèŒè´£éƒ½å¾ˆå•ä¸€ï¼Œåªå¹²å¥½ä¸€ä»¶äº‹æƒ…ã€‚ä½†æˆ‘ä»¬ç®¡é“å°†å®ƒä»¬ç»„åˆèµ·æ¥çš„æ—¶å€™ï¼Œå°±è¿¸å‘äº†æ— é™çš„èƒ½åŠ›.</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent &#125; <span class="keyword">from</span> <span class="string">'rxjs'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; throttleTime, map, scan &#125; <span class="keyword">from</span> <span class="string">'rxjs/operators'</span>;</span><br><span class="line"></span><br><span class="line">fromEvent(<span class="built_in">document</span>, <span class="string">'click'</span>)</span><br><span class="line">  .pipe(</span><br><span class="line">    throttleTime(<span class="number">1000</span>),</span><br><span class="line">    map(<span class="function"><span class="params">event</span> =&gt;</span> event.clientX),</span><br><span class="line">    scan(<span class="function">(<span class="params">count, clientX</span>) =&gt;</span> count + clientX, <span class="number">0</span>)</span><br><span class="line">  )</span><br><span class="line">  .subscribe(<span class="function"><span class="params">count</span> =&gt;</span> <span class="built_in">console</span>.log(count));</span><br></pre></td></tr></table></figure><p><br></p><p>é™¤äº†ä¸Šè¿°çš„RxJSï¼Œç®¡é“æ¨¡å¼åœ¨å‰ç«¯é¢†åŸŸä¹Ÿæœ‰å¾ˆå¤šåº”ç”¨ï¼Œä¸»è¦é›†ä¸­åœ¨å‰ç«¯å·¥ç¨‹åŒ–é¢†åŸŸã€‚ä¾‹å¦‚â€™è€ç‰Œâ€™çš„é¡¹ç›®æ„å»ºå·¥å…·<a href="https://www.gulpjs.com.cn/" target="_blank" rel="noopener">Gulp</a>, Gulpä½¿ç”¨ç®¡é“åŒ–æ¨¡å¼æ¥å¤„ç†å„ç§æ–‡ä»¶ç±»å‹ï¼Œç®¡é“ä¸­çš„æ¯ä¸€ä¸ªæ­¥éª¤ç§°ä¸ºTranspiler(è½¬è¯‘å™¨), å®ƒä»¬ä»¥ NodeJS çš„Stream ä½œä¸ºè¾“å…¥è¾“å‡ºã€‚æ•´ä¸ªè¿‡ç¨‹é«˜æ•ˆè€Œç®€å•ã€‚</p><p><img src="/images/arch-pattern/gulp.png" alt></p><p><br></p><p>ä¸ç¡®å®šæ˜¯å¦å—åˆ°Gulpçš„å½±å“ï¼Œç°ä»£çš„<a href="https://www.webpackjs.com/" target="_blank" rel="noopener">Webpack</a>æ‰“åŒ…å·¥å…·ï¼Œä¹Ÿä½¿ç”¨åŒæ ·çš„æ¨¡å¼æ¥å®ç°å¯¹æ–‡ä»¶çš„å¤„ç†, å³<a href="https://www.webpackjs.com/concepts/loaders/" target="_blank" rel="noopener">Loader</a>, Loader ç”¨äºå¯¹æ¨¡å—çš„æºä»£ç è¿›è¡Œè½¬æ¢, é€šè¿‡Loaderçš„ç»„åˆï¼Œå¯ä»¥å®ç°å¤æ‚çš„æ–‡ä»¶è½¬è¯‘éœ€æ±‚.</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [&#123;</span><br><span class="line">      test: <span class="regexp">/\.scss$/</span>,</span><br><span class="line">      use: [&#123;</span><br><span class="line">          loader: <span class="string">"style-loader"</span> <span class="comment">// å°† JS å­—ç¬¦ä¸²ç”Ÿæˆä¸º style èŠ‚ç‚¹</span></span><br><span class="line">      &#125;, &#123;</span><br><span class="line">          loader: <span class="string">"css-loader"</span> <span class="comment">// å°† CSS è½¬åŒ–æˆ CommonJS æ¨¡å—</span></span><br><span class="line">      &#125;, &#123;</span><br><span class="line">          loader: <span class="string">"sass-loader"</span> <span class="comment">// å°† Sass ç¼–è¯‘æˆ CSS</span></span><br><span class="line">      &#125;]</span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><br></p><h3 id="ä¸­é—´ä»¶-middleware"><a href="#ä¸­é—´ä»¶-middleware" class="headerlink" title="ä¸­é—´ä»¶(Middleware)"></a>ä¸­é—´ä»¶(Middleware)</h3><p><img src="/images/arch-pattern/middleware.png" alt></p><p>å¦‚æœå¼€å‘è¿‡<code>Express</code>ã€<code>Koa</code>æˆ–è€…<code>Redux</code>, ä½ å¯èƒ½ä¼šå‘ç°ä¸­é—´ä»¶æ¨¡å¼å’Œä¸Šè¿°çš„ç®¡é“æ¨¡å¼æœ‰ä¸€å®šçš„ç›¸ä¼¼æ€§ï¼Œå¦‚ä¸Šå›¾ã€‚ç›¸æ¯”ç®¡é“ï¼Œä¸­é—´ä»¶æ¨¡å¼å¯ä»¥ä½¿ç”¨ä¸€ä¸ªæ´‹è‘±å‰–é¢æ¥å½¢å®¹. ä½†å’Œç®¡é“ç›¸æ¯”ï¼Œä¸€èˆ¬çš„ä¸­é—´ä»¶å®ç°æœ‰ä»¥ä¸‹ç‰¹ç‚¹:</p><ul><li>ä¸­é—´ä»¶æ²¡æœ‰æ˜¾å¼çš„è¾“å…¥è¾“å‡ºã€‚è¿™äº›ä¸­é—´ä»¶ä¹‹é—´é€šå¸¸é€šè¿‡é›†ä¸­å¼çš„ä¸Šä¸‹æ–‡å¯¹è±¡æ¥å…±äº«çŠ¶æ€</li><li>æœ‰ä¸€ä¸ªå¾ªç¯çš„è¿‡ç¨‹ã€‚ç®¡é“ä¸­ï¼Œæ•°æ®å¤„ç†å®Œæ¯•åäº¤ç»™ä¸‹æ¸¸äº†ï¼Œåé¢å°±ä¸ç®¡äº†ã€‚è€Œä¸­é—´ä»¶è¿˜æœ‰ä¸€ä¸ªå›å½’çš„è¿‡ç¨‹ï¼Œå½“ä¸‹æ¸¸å¤„ç†å®Œæ¯•åä¼šè¿›è¡Œå›æº¯ï¼Œæ‰€ä»¥æœ‰æœºä¼šå¹²é¢„ä¸‹æ¸¸çš„å¤„ç†ç»“æœã€‚</li></ul><p>æˆ‘åœ¨è°·æ­Œä¸Šæœäº†è€åŠå¤©ä¸­é—´ä»¶ï¼Œå¯¹äºä¸­é—´ä»¶éƒ½æ²¡æœ‰å¾—åˆ°ä¸€ä¸ªä»¤æˆ‘æ»¡æ„çš„å®šä¹‰. <strong>æš‚ä¸”æŠŠå®ƒå½“ä½œä¸€ä¸ªç‰¹æ®Šå½¢å¼çš„ç®¡é“æ¨¡å¼å§</strong>ã€‚è¿™ç§æ¨¡å¼é€šå¸¸ç”¨äºåç«¯ï¼Œå®ƒå¯ä»¥å¹²å‡€åœ°åˆ†ç¦»å‡ºè¯·æ±‚çš„ä¸åŒé˜¶æ®µï¼Œä¹Ÿå°±æ˜¯åˆ†ç¦»å…³æ³¨ç‚¹ã€‚æ¯”å¦‚æˆ‘ä»¬å¯ä»¥åˆ›å»ºè¿™äº›ä¸­é—´ä»¶ï¼š</p><ul><li>æ—¥å¿—ï¼š è®°å½•å¼€å§‹æ—¶é—´ â¸ è®¡ç®—å“åº”æ—¶é—´ï¼Œè¾“å‡ºè¯·æ±‚æ—¥å¿—</li><li>è®¤è¯ï¼š éªŒè¯ç”¨æˆ·æ˜¯å¦ç™»å½•</li><li>æˆæƒï¼š éªŒè¯ç”¨æˆ·æ˜¯å¦æœ‰æ‰§è¡Œè¯¥æ“ä½œçš„æƒé™</li><li>ç¼“å­˜ï¼š æ˜¯å¦æœ‰ç¼“å­˜ç»“æœï¼Œæœ‰çš„è¯å°±ç›´æ¥è¿”å› â¸ å½“ä¸‹æ¸¸å“åº”å®Œæˆåï¼Œå†åˆ¤æ–­ä¸€ä¸‹å“åº”æ˜¯å¦å¯ä»¥è¢«ç¼“å­˜</li><li>æ‰§è¡Œï¼š æ‰§è¡Œå®é™…çš„è¯·æ±‚å¤„ç† â¸ å“åº”</li></ul><p>æœ‰äº†ä¸­é—´ä»¶ä¹‹åï¼Œæˆ‘ä»¬ä¸éœ€è¦åœ¨æ¯ä¸ªå“åº”å¤„ç†æ–¹æ³•ä¸­éƒ½åŒ…å«è¿™äº›é€»è¾‘ï¼Œå…³æ³¨å¥½è‡ªå·±è¯¥åšçš„äº‹æƒ…ã€‚ä¸‹é¢æ˜¯Koaçš„ç¤ºä¾‹ä»£ç :</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"></span><br><span class="line"><span class="comment">// logger</span></span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> next();</span><br><span class="line">  <span class="keyword">const</span> rt = ctx.response.get(<span class="string">'X-Response-Time'</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;ctx.method&#125;</span> <span class="subst">$&#123;ctx.url&#125;</span> - <span class="subst">$&#123;rt&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// x-response-time</span></span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> start = <span class="built_in">Date</span>.now();</span><br><span class="line">  <span class="keyword">await</span> next();</span><br><span class="line">  <span class="keyword">const</span> ms = <span class="built_in">Date</span>.now() - start;</span><br><span class="line">  ctx.set(<span class="string">'X-Response-Time'</span>, <span class="string">`<span class="subst">$&#123;ms&#125;</span>ms`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// response</span></span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  ctx.body = <span class="string">'Hello World'</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure><p><br></p><h2 id="äº‹ä»¶é©±åŠ¨"><a href="#äº‹ä»¶é©±åŠ¨" class="headerlink" title="äº‹ä»¶é©±åŠ¨"></a>äº‹ä»¶é©±åŠ¨</h2><p>äº‹ä»¶é©±åŠ¨, æˆ–è€…ç§°ä¸º<code>å‘å¸ƒ-è®¢é˜…</code>é£æ ¼ï¼Œ å¯¹äºå‰ç«¯å¼€å‘æ¥è¯´æ˜¯å†ç†Ÿæ‚‰ä¸è¿‡çš„æ¦‚å¿µäº†. å®ƒ<strong>å®šä¹‰äº†ä¸€ç§ä¸€å¯¹å¤šçš„ä¾èµ–å…³ç³»</strong>ï¼Œ åœ¨äº‹ä»¶é©±åŠ¨ç³»ç»Ÿé£æ ¼ä¸­ï¼Œç»„ä»¶ä¸ç›´æ¥è°ƒç”¨å¦ä¸€ä¸ªç»„ä»¶ï¼Œè€Œæ˜¯è§¦å‘æˆ–å¹¿æ’­ä¸€ä¸ªæˆ–å¤šä¸ªäº‹ä»¶ã€‚ç³»ç»Ÿä¸­çš„å…¶ä»–ç»„ä»¶åœ¨ä¸€ä¸ªæˆ–å¤šä¸ªäº‹ä»¶ä¸­æ³¨å†Œã€‚å½“ä¸€ä¸ªäº‹ä»¶è¢«è§¦å‘ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨é€šçŸ¥åœ¨è¿™ä¸ªäº‹ä»¶ä¸­æ³¨å†Œçš„æ‰€æœ‰ç»„ä»¶. </p><p>è¿™æ ·å°±<strong>åˆ†ç¦»äº†å…³æ³¨ç‚¹ï¼Œè®¢é˜…è€…ä¾èµ–äºäº‹ä»¶è€Œä¸æ˜¯ä¾èµ–äºå‘å¸ƒè€…ï¼Œå‘å¸ƒè€…ä¹Ÿä¸éœ€è¦å…³å¿ƒè®¢é˜…è€…ï¼Œä¸¤è€…è§£é™¤äº†è€¦åˆ</strong>ã€‚</p><p>ç”Ÿæ´»ä¸­ä¹Ÿæœ‰å¾ˆå¤š<code>å‘å¸ƒ-è®¢é˜…</code>çš„ä¾‹å­ï¼Œæ¯”å¦‚å¾®ä¿¡å…¬ä¼—å·ä¿¡æ¯è®¢é˜…ï¼Œå½“æ–°å¢ä¸€ä¸ªè®¢é˜…è€…çš„æ—¶å€™ï¼Œå‘å¸ƒè€…å¹¶ä¸éœ€è¦ä½œå‡ºä»»ä½•è°ƒæ•´ï¼ŒåŒæ ·å‘å¸ƒè€…è°ƒæ•´çš„æ—¶å€™ä¹Ÿä¸ä¼šå½±å“åˆ°è®¢é˜…è€…ï¼Œåªè¦åè®®æ²¡æœ‰å˜åŒ–ã€‚æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œ<strong>å‘å¸ƒè€…å’Œè®¢é˜…è€…ä¹‹é—´å…¶å®æ˜¯ä¸€ç§å¼±åŒ–çš„åŠ¨æ€çš„å…³è”å…³ç³»</strong>ã€‚</p><p><strong>è§£é™¤è€¦åˆç›®çš„æ˜¯ä¸€æ–¹é¢, å¦ä¸€æ–¹é¢ä¹Ÿå¯èƒ½ç”±åŸºå› å†³å®šçš„ï¼Œä¸€äº›äº‹æƒ…å¤©ç„¶å°±ä¸é€‚åˆæˆ–ä¸æ”¯æŒç”¨åŒæ­¥çš„æ–¹å¼å»è°ƒç”¨ï¼Œæˆ–è€…è¿™äº›è¡Œä¸ºæ˜¯å¼‚æ­¥è§¦å‘çš„</strong>ã€‚</p><p>JavaScriptçš„åŸºå› å†³å®šäº‹ä»¶é©±åŠ¨æ¨¡å¼åœ¨å‰ç«¯é¢†åŸŸçš„å¹¿æ³›ä½¿ç”¨. åœ¨<a href="https://juejin.im/post/5d693d8b6fb9a06aca383488" target="_blank" rel="noopener">æµè§ˆå™¨å’ŒNodeä¸­çš„JavaScriptæ˜¯å¦‚ä½•å·¥ä½œçš„? å¯è§†åŒ–è§£é‡Š</a> ç®€å•ä»‹ç»äº†Javascriptçš„æ‰§è¡ŒåŸç†ï¼Œå…¶ä¸­æåˆ°JavaScriptæ˜¯å•çº¿ç¨‹çš„ç¼–ç¨‹è¯­è¨€ï¼Œä¸ºäº†åº”å¯¹å„ç§å®é™…çš„åº”ç”¨åœºæ™¯ï¼Œä¸€ä¸ªçº¿ç¨‹ä»¥å‹æ ¹å¿™ä¸è¿‡æ¥çš„ï¼Œäº‹ä»¶é©±åŠ¨çš„å¼‚æ­¥æ–¹å¼æ˜¯JavaScriptçš„æ•‘å‘½ç¨»è‰.</p><p>æµè§ˆå™¨æ–¹é¢ï¼Œæµè§ˆå™¨å°±æ˜¯ä¸€ä¸ªGUIç¨‹åºï¼Œ<strong>GUIç¨‹åºæ˜¯ä¸€ä¸ªå¾ªç¯(æ›´ä¸“ä¸šçš„åå­—æ˜¯äº‹ä»¶å¾ªç¯)ï¼Œæ¥æ”¶ç”¨æˆ·è¾“å…¥ï¼Œç¨‹åºå¤„ç†ç„¶ååé¦ˆåˆ°é¡µé¢ï¼Œå†æ¥æ”¶ç”¨æˆ·è¾“å…¥â€¦</strong> ç”¨æˆ·çš„è¾“å…¥æ˜¯å¼‚æ­¥ï¼Œå°†ç”¨æˆ·è¾“å…¥æŠ½è±¡ä¸ºäº‹ä»¶æ˜¯æœ€ç®€æ´ã€è‡ªç„¶ã€çµæ´»çš„æ–¹å¼ã€‚</p><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼šäº‹ä»¶é©±åŠ¨å’Œå¼‚æ­¥æ˜¯ä¸èƒ½åˆ’ç­‰å·çš„ã€‚å¼‚æ­¥ !== äº‹ä»¶é©±åŠ¨ï¼Œäº‹ä»¶é©±åŠ¨ !== å¼‚æ­¥</p></blockquote><p><strong>æ‰©å±•</strong>:</p><ul><li><strong>å“åº”å¼ç¼–ç¨‹</strong>: å“åº”å¼ç¼–ç¨‹æœ¬è´¨ä¸Šä¹Ÿæ˜¯äº‹ä»¶é©±åŠ¨çš„ï¼Œä¸‹é¢æ˜¯å‰ç«¯é¢†åŸŸæ¯”è¾ƒæµè¡Œçš„ä¸¤ç§å“åº”å¼æ¨¡å¼ï¼š<ul><li><code>å‡½æ•°å“åº”å¼(Functional Reactive Programming)</code>, å…¸å‹ä»£è¡¨RxJS</li><li><code>é€æ˜çš„å‡½æ•°å“åº”å¼ç¼–ç¨‹(Transparently applying Functional Reactive Programming - TFRP)</code>, å…¸å‹ä»£è¡¨Vueã€Mobx</li></ul></li><li><strong>æ¶ˆæ¯æ€»çº¿</strong>ï¼šæŒ‡æ¥æ”¶ã€å‘é€æ¶ˆæ¯çš„è½¯ä»¶ç³»ç»Ÿã€‚æ¶ˆæ¯åŸºäºä¸€ç»„å·²çŸ¥çš„æ ¼å¼ï¼Œä»¥ä¾¿ç³»ç»Ÿæ— éœ€çŸ¥é“å®é™…æ¥æ”¶è€…å°±èƒ½äº’ç›¸é€šä¿¡</li></ul><p><br></p><h2 id="mv"><a href="#mv" class="headerlink" title="MV*"></a>MV*</h2><p><code>MV*</code>æ¶æ„é£æ ¼åº”ç”¨ä¹Ÿéå¸¸å¹¿æ³›ã€‚æˆ‘è§‰MV*æœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ç§åˆ†å±‚æ¶æ„ï¼Œä¸€æ ·å¼ºè°ƒèŒè´£åˆ†ç¦»ã€‚å…¶ä¸­æœ€ä¸ºç»å…¸çš„æ˜¯MVCæ¶æ„é£æ ¼ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜æœ‰å„ç§è¡ç”Ÿé£æ ¼ï¼Œä¾‹å¦‚<code>MVP</code>ã€<code>MVVM</code>ã€<a href="https://medium.com/@fkrautwald/plug-and-play-all-your-observable-streams-with-cycle-js-e543fc287872#.by4c219c8" target="_blank" rel="noopener"><code>MVI(Model View Intent)</code></a>. è¿˜æœ‰æœ‰ç‚¹å…³è”<code>Flux</code>æˆ–è€…<code>Redux</code>æ¨¡å¼ã€‚</p><p><br></p><h3 id="å®¶å–»æˆ·æ™“çš„mvc"><a href="#å®¶å–»æˆ·æ™“çš„mvc" class="headerlink" title="å®¶å–»æˆ·æ™“çš„MVC"></a>å®¶å–»æˆ·æ™“çš„MVC</h3><p><img src="/images/arch-pattern/mvc.png" alt></p><p>å¦‚å…¶åï¼ŒMVCå°†åº”ç”¨åˆ†ä¸ºä¸‰å±‚ï¼Œåˆ†åˆ«æ˜¯ï¼š</p><ul><li>è§†å›¾å±‚(View) å‘ˆç°æ•°æ®ç»™ç”¨æˆ·</li><li>æ§åˆ¶å™¨(Controller) æ¨¡å‹å’Œè§†å›¾ä¹‹é—´çš„çº½å¸¦ï¼Œèµ·åˆ°ä¸åŒå±‚çš„ç»„ç»‡ä½œç”¨ï¼š<ul><li>å¤„ç†äº‹ä»¶å¹¶ä½œå‡ºå“åº”ã€‚ä¸€èˆ¬äº‹ä»¶æœ‰ç”¨æˆ·çš„è¡Œä¸º(æ¯”å¦‚ç”¨æˆ·ç‚¹å‡»ã€å®¢æˆ·ç«¯è¯·æ±‚)ï¼Œæ¨¡å‹å±‚çš„å˜æ›´</li><li>æ§åˆ¶ç¨‹åºçš„æµç¨‹ã€‚æ ¹æ®è¯·æ±‚é€‰æ‹©é€‚å½“çš„æ¨¡å‹è¿›è¡Œå¤„ç†ï¼Œç„¶åé€‰æ‹©é€‚å½“çš„è§†å›¾è¿›è¡Œæ¸²æŸ“ï¼Œæœ€åå‘ˆç°ç»™ç”¨æˆ·</li></ul></li><li>æ¨¡å‹(Model) å°è£…ä¸åº”ç”¨ç¨‹åºçš„ä¸šåŠ¡é€»è¾‘ç›¸å…³çš„æ•°æ®ä»¥åŠå¯¹æ•°æ®çš„å¤„ç†æ–¹æ³•, é€šå¸¸å®ƒéœ€è¦å’Œæ•°æ®æŒä¹…åŒ–å±‚è¿›è¡Œé€šä¿¡</li></ul><p>ç›®å‰å‰ç«¯åº”ç”¨å¾ˆå°‘æœ‰çº¯ç²¹ä½¿ç”¨MVCçš„ï¼Œè¦ä¹ˆè§†å›¾å±‚æ··åˆäº†æ§åˆ¶å™¨å±‚ï¼Œè¦ä¹ˆå°±æ˜¯æ¨¡å‹å’Œæ§åˆ¶å™¨æ··åˆï¼Œæˆ–è€…å¹²è„†å°±æ²¡æœ‰æ‰€è°“çš„æ§åˆ¶å™¨. ä½†ä¸€ç‚¹å¯ä»¥ç¡®å®šçš„æ˜¯ï¼Œå¾ˆå¤šåº”ç”¨éƒ½ä¸çº¦è€ŒåŒåˆ†ç¦»äº†â€™é€»è¾‘å±‚â€™å’Œâ€™è§†å›¾å±‚â€™ã€‚</p><p>ä¸‹é¢æ˜¯å…¸å‹çš„AngularJSä»£ç , è§†å›¾å±‚:</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Todo<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">ng-controller</span>=<span class="string">"TodoListController as todoList"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;&#123;todoList.remaining()&#125;&#125; of &#123;&#123;todoList.todos.length&#125;&#125; remaining<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">  [ <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span> <span class="attr">ng-click</span>=<span class="string">"todoList.archive()"</span>&gt;</span>archive<span class="tag">&lt;/<span class="name">a</span>&gt;</span> ]</span><br><span class="line">  <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"unstyled"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">ng-repeat</span>=<span class="string">"todo in todoList.todos"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">"checkbox"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">ng-model</span>=<span class="string">"todo.done"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"done-&#123;&#123;todo.done&#125;&#125;"</span>&gt;</span>&#123;&#123;todo.text&#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">form</span> <span class="attr">ng-submit</span>=<span class="string">"todoList.addTodo()"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">ng-model</span>=<span class="string">"todoList.todoText"</span>  <span class="attr">size</span>=<span class="string">"30"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">placeholder</span>=<span class="string">"add new todo here"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">"btn-primary"</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"add"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>é€»è¾‘å±‚:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">angular.module(<span class="string">'todoApp'</span>, [])</span><br><span class="line">  .controller(<span class="string">'TodoListController'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> todoList = <span class="keyword">this</span>;</span><br><span class="line">    todoList.todos = [</span><br><span class="line">      &#123;<span class="attr">text</span>:<span class="string">'learn AngularJS'</span>, <span class="attr">done</span>:<span class="literal">true</span>&#125;,</span><br><span class="line">      &#123;<span class="attr">text</span>:<span class="string">'build an AngularJS app'</span>, <span class="attr">done</span>:<span class="literal">false</span>&#125;];</span><br><span class="line"></span><br><span class="line">    todoList.addTodo = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      todoList.todos.push(&#123;<span class="attr">text</span>:todoList.todoText, <span class="attr">done</span>:<span class="literal">false</span>&#125;);</span><br><span class="line">      todoList.todoText = <span class="string">''</span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    todoList.remaining = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">var</span> count = <span class="number">0</span>;</span><br><span class="line">      angular.forEach(todoList.todos, <span class="function"><span class="keyword">function</span>(<span class="params">todo</span>) </span>&#123;</span><br><span class="line">        count += todo.done ? <span class="number">0</span> : <span class="number">1</span>;</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">return</span> count;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    todoList.archive = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">var</span> oldTodos = todoList.todos;</span><br><span class="line">      todoList.todos = [];</span><br><span class="line">      angular.forEach(oldTodos, <span class="function"><span class="keyword">function</span>(<span class="params">todo</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!todo.done) todoList.todos.push(todo);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure><p>è‡³äºMVPã€MVVMï¼Œè¿™äº›MVCæ¨¡å¼çš„å»¶å±•æˆ–è€…å‡çº§ï¼Œç½‘ä¸Šéƒ½å¤§é‡çš„èµ„æºï¼Œè¿™é‡Œå°±ä¸äºˆèµ˜è¿°ã€‚</p><p><br></p><h3 id="redux"><a href="#redux" class="headerlink" title="Redux"></a>Redux</h3><p>Reduxæ˜¯Fluxæ¶æ„çš„æ”¹è¿›ã€èåˆäº†Elmè¯­è¨€ä¸­å‡½æ•°å¼çš„æ€æƒ³. ä¸‹é¢æ˜¯Reduxçš„æ¶æ„å›¾:</p><p><img src="/images/arch-pattern/redux.png" alt></p><p>ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºReduxæ¶æ„æœ‰ä»¥ä¸‹è¦ç‚¹:</p><ul><li><strong>å•ä¸€çš„æ•°æ®æº</strong>.</li><li><strong>å•å‘çš„æ•°æ®æµ</strong>.</li></ul><p>å•ä¸€æ•°æ®æº, é¦–å…ˆè§£å†³çš„æ˜¯ä¼ ç»ŸMVCæ¶æ„å¤šæ¨¡å‹æ•°æ®æµæ··ä¹±é—®é¢˜(å¦‚ä¸‹å›¾)ã€‚å•ä¸€çš„æ•°æ®æºå¯ä»¥è®©åº”ç”¨çš„çŠ¶æ€å¯é¢„æµ‹å’Œå¯è¢«è°ƒè¯•ã€‚å¦å¤–å•ä¸€æ•°æ®æºä¹Ÿæ–¹ä¾¿åšæ•°æ®é•œåƒï¼Œå®ç°æ’¤é”€/é‡åšï¼Œæ•°æ®æŒä¹…åŒ–ç­‰ç­‰åŠŸèƒ½</p><p><img src="/images/arch-pattern/multi-model.png" alt></p><p>å•å‘æ•°æ®æµç”¨äºè¾…åŠ©å•ä¸€æ•°æ®æº, ä¸»è¦ç›®çš„æ˜¯é˜»æ­¢åº”ç”¨ä»£ç ç›´æ¥ä¿®æ”¹æ•°æ®æºï¼Œè¿™æ ·ä¸€æ–¹é¢ç®€åŒ–æ•°æ®æµï¼ŒåŒæ ·ä¹Ÿè®©åº”ç”¨çŠ¶æ€å˜åŒ–å˜å¾—å¯é¢„æµ‹ã€‚</p><p>ä¸Šé¢ä¸¤ä¸ªç‰¹ç‚¹æ˜¯Reduxæ¶æ„é£æ ¼çš„æ ¸å¿ƒï¼Œè‡³äºReduxè¿˜å¼ºè°ƒä¸å¯å˜æ•°æ®ã€åˆ©ç”¨ä¸­é—´ä»¶å°è£…å‰¯ä½œç”¨ã€èŒƒå¼åŒ–çŠ¶æ€æ ‘ï¼Œåªæ˜¯ä¸€ç§æœ€ä½³å®è·µã€‚è¿˜æœ‰è®¸å¤š<code>ç±»Redux</code>çš„æ¡†æ¶ï¼Œä¾‹å¦‚<a href="http://vuex.vuejs.org" target="_blank" rel="noopener"><code>Vuex</code></a>ã€<a href="https://ngrx.io" target="_blank" rel="noopener">ngrx</a>ï¼Œåœ¨æ¶æ„æ€æƒ³å±‚æ¬¡æ˜¯ä¸€è‡´çš„:</p><p><img src="/images/arch-pattern/vuex.png" alt></p><p><br></p><h2 id="å¤åˆ¶é£æ ¼"><a href="#å¤åˆ¶é£æ ¼" class="headerlink" title="å¤åˆ¶é£æ ¼"></a>å¤åˆ¶é£æ ¼</h2><p><img src="/images/arch-pattern/pm2.png" alt></p><p>åŸºäºå¤åˆ¶(Replication)é£æ ¼çš„ç³»ç»Ÿï¼Œä¼šåˆ©ç”¨å¤šä¸ªå®ä¾‹æä¾›ç›¸åŒçš„æœåŠ¡ï¼Œæ¥æ”¹å–„æœåŠ¡çš„å¯è®¿é—®æ€§å’Œå¯ä¼¸ç¼©æ€§ï¼Œä»¥åŠæ€§èƒ½ã€‚è¿™ç§æ¶æ„é£æ ¼å¯ä»¥æ”¹å–„ç”¨æˆ·å¯å¯Ÿè§‰çš„æ€§èƒ½ï¼Œç®€å•æœåŠ¡å“åº”çš„å»¶è¿Ÿã€‚</p><p>è¿™ç§é£æ ¼åœ¨åç«¯ç”¨å¾—æ¯”è¾ƒå¤šï¼Œä¸¾å‰ç«¯æ¯”è¾ƒç†Ÿæ‚‰çš„ä¾‹å­ï¼ŒNodeJS. NodeJSæ˜¯å•çº¿ç¨‹çš„ï¼Œä¸ºäº†åˆ©ç”¨å¤šæ ¸èµ„æºï¼ŒNodeJSæ ‡å‡†åº“æä¾›äº†ä¸€ä¸ª<a href="https://nodejs.org/api/cluster.html" target="_blank" rel="noopener"><code>cluster</code></a>æ¨¡å—ï¼Œå®ƒå¯ä»¥æ ¹æ®CPUæ•°åˆ›å»ºå¤šä¸ªWorkerè¿›ç¨‹ï¼Œè¿™äº›Workerè¿›ç¨‹å¯ä»¥å…±äº«ä¸€ä¸ªæœåŠ¡å™¨ç«¯å£ï¼Œå¯¹å¤–æä¾›åŒè´¨çš„æœåŠ¡, Masterè¿›ç¨‹ä¼šæ ¹æ®ä¸€å®šçš„ç­–ç•¥å°†èµ„æºåˆ†é…ç»™Worker:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> cluster = <span class="built_in">require</span>(<span class="string">'cluster'</span>);</span><br><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">const</span> numCPUs = <span class="built_in">require</span>(<span class="string">'os'</span>).cpus().length;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (cluster.isMaster) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Master <span class="subst">$&#123;process.pid&#125;</span> is running`</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Fork workers.</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; numCPUs; i++) &#123;</span><br><span class="line">    cluster.fork();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  cluster.on(<span class="string">'exit'</span>, (worker, code, signal) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`worker <span class="subst">$&#123;worker.process.pid&#125;</span> died`</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// Workerså¯ä»¥å…±äº«ä»»æ„çš„TCPè¿æ¥ </span></span><br><span class="line">  <span class="comment">// æ¯”å¦‚å…±äº«HTTPæœåŠ¡å™¨ </span></span><br><span class="line">  http.createServer(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    res.writeHead(<span class="number">200</span>);</span><br><span class="line">    res.end(<span class="string">'hello world\n'</span>);</span><br><span class="line">  &#125;).listen(<span class="number">8000</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Worker <span class="subst">$&#123;process.pid&#125;</span> started`</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨å¤šæ ¸èƒ½åŠ›å¯ä»¥æå‡åº”ç”¨çš„æ€§èƒ½å’Œå¯é æ€§ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ©ç”¨<a href="http://pm2.keymetrics.io/docs/usage/cluster-mode/" target="_blank" rel="noopener">PM2</a>è¿™æ ·çš„è¿›ç¨‹ç®¡ç†å·¥å…·ï¼Œæ¥ç®€åŒ–Nodeé›†ç¾¤çš„ç®¡ç†ï¼Œå®ƒæ”¯æŒå¾ˆå¤šæœ‰ç”¨çš„ç‰¹æ€§ï¼Œä¾‹å¦‚é›†ç¾¤èŠ‚ç‚¹é‡å¯ã€æ—¥å¿—å½’é›†ã€æ€§èƒ½ç›‘è§†ç­‰ã€‚</p><p>å¤åˆ¶é£æ ¼å¸¸ç”¨äºç½‘ç»œæœåŠ¡å™¨ã€‚æµè§ˆå™¨å’ŒNodeéƒ½æœ‰<code>Worker</code>çš„æ¦‚å¿µï¼Œä½†æ˜¯ä¸€èˆ¬éƒ½åªæ¨èåœ¨CPUå¯†é›†å‹çš„åœºæ™¯ä½¿ç”¨å®ƒä»¬ï¼Œå› ä¸ºæµè§ˆå™¨æˆ–è€…NodeJSå†…ç½®çš„å¼‚æ­¥æ“ä½œå·²ç»éå¸¸é«˜æ•ˆã€‚å®é™…ä¸Šå‰ç«¯åº”ç”¨CPUå¯†é›†å‹åœºæ™¯å¹¶ä¸å¤šï¼Œæˆ–è€…ç›®å‰é˜¶æ®µä¸æ˜¯ç‰¹åˆ«å®ç”¨ã€‚é™¤æ­¤ä¹‹å¤–ä½ è¿˜è¦æƒè¡¡è¿›ç¨‹é—´é€šä¿¡çš„æ•ˆç‡ã€Workerç®¡ç†å¤æ‚åº¦ã€å¼‚å¸¸å¤„ç†ç­‰äº‹æƒ…ã€‚</p><p>æœ‰ä¸€ä¸ªå…¸å‹çš„CPUå¯†é›†å‹çš„åœºæ™¯ï¼Œå³æºæ–‡ä»¶è½¬è¯‘. å…¸å‹çš„ä¾‹å­æ˜¯<a href="https://codesandbox.io/dashboard" target="_blank" rel="noopener">CodeSandbox</a>, å®ƒå°±æ˜¯åˆ©ç”¨æµè§ˆå™¨çš„Workeræœºåˆ¶æ¥æé«˜æºæ–‡ä»¶çš„è½¬è¯‘æ€§èƒ½çš„:</p><p><img src="/images/arch-pattern/codesandbox.png" alt></p><p>é™¤äº†å¤„ç†CPUå¯†é›†å‹ä»»åŠ¡ï¼Œå¯¹äºæµè§ˆå™¨æ¥è¯´ï¼ŒWorkerä¹Ÿæ˜¯ä¸€ä¸ªé‡è¦çš„å®‰å…¨æœºåˆ¶ï¼Œç”¨äºéš”ç¦»ä¸å®‰å…¨ä»£ç çš„æ‰§è¡Œï¼Œæˆ–è€…é™åˆ¶è®¿é—®æµè§ˆå™¨DOMç›¸å…³çš„ä¸œè¥¿ã€‚å°ç¨‹åºæŠ½ç¦»é€»è¾‘è¿›ç¨‹çš„åŸå› ä¹‹ä¸€å°±æ˜¯å®‰å…¨æ€§</p><p>å…¶ä»–ç¤ºä¾‹ï¼š</p><ul><li>ServerLess</li></ul><p><br></p><h2 id="å¾®å†…æ ¸æ¶æ„"><a href="#å¾®å†…æ ¸æ¶æ„" class="headerlink" title="å¾®å†…æ ¸æ¶æ„"></a>å¾®å†…æ ¸æ¶æ„</h2><p><img src="/images/arch-pattern/plugin-architecture.png" alt></p><p>å¾®å†…æ ¸æ¶æ„(MicroKernel)åˆç§°ä¸ºâ€æ’ä»¶æ¶æ„â€, æŒ‡çš„æ˜¯è½¯ä»¶çš„å†…æ ¸ç›¸å¯¹è¾ƒå°ï¼Œä¸»è¦åŠŸèƒ½å’Œä¸šåŠ¡é€»è¾‘éƒ½é€šè¿‡æ’ä»¶å½¢å¼å®ç°ã€‚å†…æ ¸åªåŒ…å«ç³»ç»Ÿè¿è¡Œçš„æœ€å°åŠŸèƒ½ã€‚æ’ä»¶ä¹‹é—´ç›¸äº’ç‹¬ç«‹ï¼Œæ’ä»¶ä¹‹é—´çš„é€šä¿¡ï¼Œåº”è¯¥é™åˆ°æœ€ä½ï¼Œå‡å°‘ç›¸äº’ä¾èµ–ã€‚</p><p>å¾®å†…æ ¸ç»“æ„çš„éš¾ç‚¹åœ¨äºå»ºç«‹ä¸€å¥—ç²’åº¦åˆé€‚çš„æ’ä»¶åè®®ã€ä»¥åŠå¯¹æ’ä»¶ä¹‹é—´è¿›è¡Œé€‚å½“çš„éš”ç¦»å’Œè§£è€¦ã€‚ä»è€Œæ‰èƒ½ä¿è¯è‰¯å¥½çš„æ‰©å±•æ€§ã€çµæ´»æ€§å’Œå¯è¿ç§»æ€§ã€‚</p><p>å‰ç«¯é¢†åŸŸæ¯”è¾ƒå…¸å‹çš„ä¾‹å­æ˜¯<code>Webpack</code>ã€<code>Babel</code>ã€<code>PostCSS</code>ä»¥åŠ<code>ESLint</code>, è¿™äº›åº”ç”¨éœ€è¦åº”å¯¹å¤æ‚çš„å®šåˆ¶éœ€æ±‚ï¼Œè€Œä¸”è¿™äº›éœ€æ±‚æ—¶åˆ»åœ¨å˜ï¼Œåªæœ‰å¾®å†…æ ¸æ¶æ„æ‰èƒ½ä¿è¯çµæ´»å’Œå¯æ‰©å±•æ€§ã€‚</p><p>ä»¥Webpackä¸ºä¾‹ã€‚Webpackçš„æ ¸å¿ƒæ˜¯ä¸€ä¸ªCompilerï¼Œè¿™ä¸ªCompilerä¸»è¦åŠŸèƒ½æ˜¯é›†æˆæ’ä»¶ç³»ç»Ÿã€ç»´æŠ¤<code>æ¨¡å—å¯¹è±¡å›¾</code>, å¯¹äºæ¨¡å—ä»£ç å…·ä½“ç¼–è¯‘å·¥ä½œã€æ¨¡å—çš„æ‰“åŒ…ã€ä¼˜åŒ–ã€åˆ†æã€èšåˆç»Ÿç»Ÿéƒ½æ˜¯åŸºäºå¤–éƒ¨æ’ä»¶å®Œæˆçš„.</p><p>å¦‚ä¸Šæ–‡è¯´çš„Loaderè¿ç”¨äº†ç®¡é“æ¨¡å¼ï¼Œè´Ÿè´£å¯¹æºæ–‡ä»¶è¿›è¡Œè½¬è¯‘ï¼›é‚£Pluginåˆ™å¯ä»¥å°†è¡Œä¸ºæ³¨å…¥åˆ°Compilerè¿è¡Œçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸçš„é’©å­ä¸­, å®Œå…¨è®¿é—®Compilerçš„å½“å‰çŠ¶æ€ã€‚</p><blockquote><p><a href="https://twitter.com/thelarkinn" target="_blank" rel="noopener">Sean Larkin</a>æœ‰ä¸ªæ¼”è®²: <a href="https://www.youtube.com/watch?v=4tQiJaFzuJ8" target="_blank" rel="noopener">Everything is a plugin! Mastering webpack from the inside out </a></p></blockquote><p><img src="/images/arch-pattern/webpack.png" alt></p><p><br></p><p>è¿™é‡Œè¿˜æœ‰ä¸€ç¯‡æ–‡ç« <a href="https://yunsong0922.github.io/2018/12/09/%E5%BE%AE%E5%86%85%E6%A0%B8%E6%9E%B6%E6%9E%84%E5%BA%94%E7%94%A8%E7%A0%94%E7%A9%B6/" target="_blank" rel="noopener">&lt;å¾®å†…æ ¸æ¶æ„åº”ç”¨ç ”ç©¶&gt;</a>ä¸“é—¨å†™äº†å‰ç«¯å¾®å†…æ ¸æ¶æ„æ¨¡å¼çš„ä¸€äº›åº”ç”¨ï¼Œæ¨èé˜…è¯»ä¸€ä¸‹ã€‚</p><p><br></p><h2 id="å¾®å‰ç«¯"><a href="#å¾®å‰ç«¯" class="headerlink" title="å¾®å‰ç«¯"></a>å¾®å‰ç«¯</h2><p>å‰å‡ å¤©å¬äº†<a href="http://codetimecn.com/" target="_blank" rel="noopener">ä»£ç æ—¶é—´</a>ä¸Š<a href="https://coolshell.cn/haoel" target="_blank" rel="noopener">å·¦è€³æœµè€—å­</a>çš„ä¸€æœŸ<a href="http://codetimecn.com/episodes/manager" target="_blank" rel="noopener">èŠ‚ç›®</a>, ä»–ä»‹ç»å¾—äº†äºšé©¬é€Šå†…éƒ¨æœ‰å¾ˆå¤šå°å›¢é˜Ÿï¼Œäºšé©¬é€Šç½‘ç«™ä¸Šä¸€å—è±†è…å—å¤§å°çš„åŒºåŸŸå¯èƒ½æ˜¯ä¸€ä¸ªå›¢é˜Ÿåœ¨ç»´æŠ¤ï¼Œæ¯”å¦‚åœ°å€é€‰æ‹©å™¨ã€è´­ç‰©è½¦ã€è¿è¾¾æ—¶é—´è®¡ç®—â€¦ å¤§å‚çš„è¿™ç§è¶…çº§é¡¹ç›®æ˜¯æ€ä¹ˆåè°ƒå’Œç»´æŠ¤çš„å‘¢ï¼Ÿ è¿™ä¹Ÿè®¸å°±æ˜¯å¾®å‰ç«¯æˆ–è€…å¾®æœåŠ¡å‡ºç°çš„åŸå› å§ã€‚</p><p>å¾®å‰ç«¯æ—¨åœ¨å°†<code>å•ä½“å‰ç«¯</code>åˆ†è§£æˆæ›´å°ã€æ›´ç®€å•çš„æ¨¡å—ï¼Œè¿™äº›æ¨¡å—å¯ä»¥è¢«ç‹¬ç«‹çš„å›¢é˜Ÿè¿›è¡Œå¼€å‘ã€æµ‹è¯•å’Œéƒ¨ç½²ï¼Œæœ€åå†ç»„åˆæˆä¸€ä¸ªå¤§å‹çš„æ•´ä½“ã€‚</p><p><img src="/images/arch-pattern/microfrontend.jpg" alt></p><p>å¾®å‰ç«¯ä¸‹å„ä¸ªåº”ç”¨æ¨¡å—æ˜¯ç‹¬ç«‹è¿è¡Œã€ç‹¬ç«‹å¼€å‘ã€ç‹¬ç«‹éƒ¨ç½²çš„ï¼Œç›¸å¯¹åº”çš„ä¼šé…å¤‡æ›´åŠ è‡ªæ²»çš„å›¢é˜Ÿ(ä¸€ä¸ªå›¢é˜Ÿå¹²å¥½ä¸€ä»¶äº‹æƒ…)ã€‚ å¾®å‰ç«¯çš„å®æ–½è¿˜éœ€è¦æœ‰ç¨³å›ºçš„å‰ç«¯åŸºç¡€è®¾æ–½å’Œç ”å‘ä½“ç³»çš„æ”¯æ’‘ã€‚</p><p>å¦‚æœä½ æƒ³æ·±å…¥å­¦ä¹ å¾®å‰ç«¯æ¶æ„ï¼Œå»ºè®®é˜…è¯»<a href="https://www.zhihu.com/people/phodal/activities" target="_blank" rel="noopener">Phodal</a>çš„<a href="https://juejin.im/user/5567e339e4b0349d3313190b/posts" target="_blank" rel="noopener">ç›¸å…³æ–‡ç« </a>ï¼Œè¿˜æœ‰ä»–çš„æ–°ä¹¦<a href="https://www.amazon.cn/dp/B07TJ7R9DX/ref=sr_1_1?__mk_zh_CN=%E4%BA%9A%E9%A9%AC%E9%80%8A%E7%BD%91%E7%AB%99&amp;keywords=%E5%89%8D%E7%AB%AF%E6%9E%B6%E6%9E%84&amp;qid=1568279892&amp;s=gateway&amp;sr=8-1" target="_blank" rel="noopener">ã€Šå‰ç«¯æ¶æ„ï¼šä»å…¥é—¨åˆ°å¾®å‰ç«¯ã€‹</a></p><p><br></p><h2 id="ç»„ä»¶åŒ–æ¶æ„"><a href="#ç»„ä»¶åŒ–æ¶æ„" class="headerlink" title="ç»„ä»¶åŒ–æ¶æ„"></a>ç»„ä»¶åŒ–æ¶æ„</h2><p>ç»„ä»¶åŒ–å¼€å‘å¯¹ç°åœ¨çš„æˆ‘ä»¬æ¥è¯´å¦‚æ­¤è‡ªç„¶ï¼Œå°±åƒæ°´å¯¹é±¼ä¸€æ ·ã€‚ ä»¥è‡´äºæˆ‘ä»¬å¿˜äº†ç»„ä»¶åŒ–ä¹Ÿæ˜¯ä¸€ç§éå¸¸é‡è¦çš„æ¶æ„æ€æƒ³ï¼Œå®ƒçš„ä¸­å¿ƒæ€æƒ³å°±æ˜¯åˆ†è€Œæ²»ä¹‹ã€‚æŒ‰ç…§Wikiä¸Šé¢çš„å®šä¹‰æ˜¯ï¼š<code>ç»„ä»¶åŒ–å°±æ˜¯åŸºäºå¯å¤ç”¨ç›®çš„ï¼Œå°†ä¸€ä¸ªå¤§çš„è½¯ä»¶ç³»ç»ŸæŒ‰ç…§åˆ†ç¦»å…³æ³¨ç‚¹çš„å½¢å¼ï¼Œæ‹†åˆ†æˆå¤šä¸ªç‹¬ç«‹çš„ç»„ä»¶ï¼Œä¸»è¦ç›®çš„å°±æ˜¯å‡å°‘è€¦åˆ</code>.</p><p>ä»å‰ç«¯çš„è§’åº¦å…·ä½“æ¥è®²ï¼Œå¦‚ä¸‹å›¾ï¼ŒçŸ³å™¨æ—¶ä»£å¼€å‘æ–¹å¼(å³ä¾§), ç»„ä»¶æ—¶ä»£(å·¦ä¾§):</p><p><img src="/images/arch-pattern/components2.png" alt><br>(å›¾ç‰‡æ¥æº: <a href="http://www.alloyteam.com/2015/11/we-will-be-componentized-web-long-text" target="_blank" rel="noopener">http://www.alloyteam.com/2015/11/we-will-be-componentized-web-long-text</a>)</p><p>æŒ‰ç…§Vueå®˜ç½‘çš„è¯´æ³•: <code>ç»„ä»¶ç³»ç»Ÿæ˜¯ Vue çš„å¦ä¸€ä¸ªé‡è¦æ¦‚å¿µï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ç§æŠ½è±¡ï¼Œå…è®¸æˆ‘ä»¬ä½¿ç”¨å°å‹ã€ç‹¬ç«‹å’Œé€šå¸¸å¯å¤ç”¨çš„ç»„ä»¶æ„å»ºå¤§å‹åº”ç”¨ã€‚ä»”ç»†æƒ³æƒ³ï¼Œå‡ ä¹ä»»æ„ç±»å‹çš„åº”ç”¨ç•Œé¢éƒ½å¯ä»¥æŠ½è±¡ä¸ºä¸€ä¸ªç»„ä»¶æ ‘</code>ï¼š</p><p><img src="/images/arch-pattern/components.png" alt></p><p>æŒ‰ç…§æˆ‘çš„ç†è§£<strong>ç»„ä»¶è·Ÿå‡½æ•°æ˜¯ä¸€æ ·çš„ä¸œè¥¿ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆå‡½æ•°å¼ç¼–ç¨‹æ€æƒ³åœ¨Reactä¸­ä¼šåº”ç”¨çš„å¦‚æ­¤è‡ªç„¶</strong>ã€‚è‹¥å¹²ä¸ªç®€å•å‡½æ•°ï¼Œå¯ä»¥å¤åˆæˆå¤æ‚çš„å‡½æ•°ï¼Œå¤æ‚çš„å‡½æ•°å†å¤åˆæˆå¤æ‚çš„åº”ç”¨ã€‚å¯¹äºå‰ç«¯æ¥è¯´ï¼Œé¡µé¢ä¹Ÿæ˜¯è¿™ä¹ˆæ¥çš„ï¼Œä¸€ä¸ªå¤æ‚çš„é¡µé¢å°±æ˜¯æœ‰ä¸åŒç²’åº¦çš„ç»„ä»¶å¤åˆè€Œæˆçš„ã€‚</p><p>ç»„ä»¶å¦å¤–ä¸€ä¸ªé‡è¦çš„ç‰¹å¾å°±æ˜¯<strong>å†…èšæ€§</strong>ï¼Œå®ƒæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å•å…ƒï¼Œè‡ªåŒ…å«äº†æ‰€æœ‰éœ€è¦çš„èµ„æºã€‚ä¾‹å¦‚ä¸€ä¸ªå‰ç«¯ç»„ä»¶è¾ƒåŒ…å«æ ·å¼ã€è§†å›¾ç»“æ„ã€ç»„ä»¶é€»è¾‘:</p><p><img src="/images/arch-pattern/vue-component.png" alt></p><p><br></p><h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><p><strong>æˆ‘ç»ˆäºç¼–ä¸ä¸‹å»äº†</strong>ï¼è¿˜æœ‰å¾ˆå¤šæ¶æ„é£æ ¼ï¼Œé™äºæ–‡ç« ç¯‡å¹…, ä¸”è¿™äº›é£æ ¼ä¸»è¦åº”ç”¨äºåç«¯é¢†åŸŸï¼Œè¿™é‡Œå°±ä¸ä¸€ä¸€é˜è¿°äº†ã€‚ä½ å¯ä»¥é€šè¿‡æ‰©å±•é˜…è¯»äº†è§£è¿™äº›æ¨¡å¼</p><ul><li>é¢å‘å¯¹è±¡é£æ ¼: å°†åº”ç”¨æˆ–ç³»ç»Ÿä»»åŠ¡åˆ†å‰²ä¸ºå•ç‹¬ã€å¯å¤ç”¨ã€å¯è‡ªç»™çš„å¯¹è±¡ï¼Œæ¯ä¸ªå¯¹è±¡éƒ½åŒ…å«æ•°æ®ã€ä»¥åŠå¯¹è±¡ç›¸å…³çš„è¡Œä¸º</li><li>C/S å®¢æˆ·ç«¯/æœåŠ¡å™¨é£æ ¼</li><li>é¢å‘æœåŠ¡æ¶æ„(SOA): æŒ‡é‚£äº›åˆ©ç”¨å¥‘çº¦å’Œæ¶ˆæ¯å°†åŠŸèƒ½æš´éœ²ä¸ºæœåŠ¡ã€æ¶ˆè´¹åŠŸèƒ½æœåŠ¡çš„åº”ç”¨</li><li>Nå±‚/ä¸‰å±‚: å’Œåˆ†å±‚æ¶æ„å·®ä¸å¤šï¼Œä¾§é‡ç‰©ç†å±‚. ä¾‹å¦‚C/Sé£æ ¼å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„Nå±‚æ¶æ„</li><li>ç‚¹å¯¹ç‚¹é£æ ¼</li></ul><p>é€šè¿‡ä¸Šæ–‡ï¼Œä½ ä¼°è®¡ä¼šè§‰å¾—æ¶æ„é£æ ¼æ¯”è®¾è®¡æ¨¡å¼æˆ–è€…ç®—æ³•å¥½ç†è§£å¤šçš„ï¼Œæ­£æ‰€è°“â€˜<strong>å¤§é“è‡³ç®€</strong>â€™ï¼Œä½†æ˜¯â€˜<strong>ç®€æ´è€Œä¸ç®€å•</strong>â€™ï¼å¤§éƒ¨åˆ†é¡¹ç›®çš„æ¶æ„ä¸æ˜¯ä¸€å¼€å§‹å°±æ˜¯è¿™æ ·çš„ï¼Œå®ƒä»¬å¯èƒ½ç»è¿‡é•¿æœŸçš„è¿­ä»£ï¼Œè¸©ç€å·¨äººçš„è‚©è†€ï¼Œä¸€è·¯èµ°è¿‡æ¥æ‰æˆä¸ºä»Šå¤©çš„æ ·å­ã€‚</p><p>å¸Œæœ›æœ¬æ–‡å¯ä»¥ç»™ä½ ä¸€ç‚¹å¯å‘ï¼Œå¯¹äºæˆ‘ä»¬å‰ç«¯å·¥ç¨‹å¸ˆæ¥è¯´ï¼Œæœ€ç‰›çš„ä¸æ˜¯èƒ½åšå¤šé…·çš„é¡µé¢ã€æŒæ¡å¤šå°‘APIï¼Œè¦å­¦ä¼šé€šè¿‡ç°è±¡çœ‹æœ¬è´¨ï¼Œä¸¾ä¸€åä¸‰èä¼šè´¯é€šï¼Œè¿™æ‰æ˜¯è¿›é˜¶ä¹‹é“ã€‚</p><p>æœ¬æ–‡å®Œï¼</p><p><br></p><h2 id="æ‰©å±•é˜…è¯»"><a href="#æ‰©å±•é˜…è¯»" class="headerlink" title="æ‰©å±•é˜…è¯»"></a>æ‰©å±•é˜…è¯»</h2><ul><li><a href="https://wxs.me/2069" target="_blank" rel="noopener">å‡ ç§å¸¸è§çš„è½¯ä»¶æ¶æ„é£æ ¼ä»‹ç»</a></li><li><a href="https://docs.huihoo.com/rest/REST_cn.pdf" target="_blank" rel="noopener">æ¶æ„é£æ ¼ä¸åŸºäºç½‘ç»œçš„è½¯ä»¶æ¶æ„è®¾è®¡</a> RESTæè®®è€…ï¼ŒRoy Thomas Fieldingçš„åšå£«è®ºæ–‡</li><li><a href="http://www.ruanyifeng.com/blog/2016/09/software-architecture.html" target="_blank" rel="noopener">è½¯ä»¶æ¶æ„å…¥é—¨</a></li><li><a href="https://zh.wikipedia.org/wiki/ç®¡é“_\(Unix\" target="_blank" rel="noopener">ç®¡é“ (Unix)</a>)</li><li><a href="https://zhuanlan.zhihu.com/p/20597452" target="_blank" rel="noopener">redux middleware è¯¦è§£</a></li><li><a href="https://juejin.im/post/593021272f301e0058273468" target="_blank" rel="noopener">æµ…æå‰ç«¯å¼€å‘ä¸­çš„ MVC/MVP/MVVM æ¨¡å¼</a></li><li><a href="https://juejin.im/post/5d1e0dea51882514bf5bedfa#comment" target="_blank" rel="noopener">CodeSandbox æµè§ˆå™¨ç«¯çš„webpackæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ ä¸Šç¯‡</a></li><li><a href="https://mp.weixin.qq.com/s/KT288QNmtJzKe-jaPyFtFA" target="_blank" rel="noopener">ä¸‡é‡‘æ²¹CSä¸åˆ†å±‚</a></li><li><a href="https://www.infoq.cn/article/03*BeU3zQegIbIytRsX9" target="_blank" rel="noopener">å¤§å‰ç«¯æ—¶ä»£ä¸‹çš„å¾®å‰ç«¯æ¶æ„ï¼šå®ç°å¢é‡å‡çº§ã€ä»£ç è§£è€¦ã€ç‹¬ç«‹éƒ¨ç½²</a></li><li><a href="https://www.iteye.com/blog/moon-walker-2393310" target="_blank" rel="noopener">ç³»ç»Ÿç»„ä»¶åŒ–æ¶æ„è®¾è®¡</a></li><li><a href="https://github.com/xufei/blog/issues/19" target="_blank" rel="noopener">2015å‰ç«¯ç»„ä»¶åŒ–æ¡†æ¶ä¹‹è·¯</a></li></ul><p><br></p><p><img src="/images/sponsor.jpg" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;æ‰€è°“è½¯ä»¶æ¶æ„é£æ ¼ï¼Œæ˜¯æŒ‡æè¿°æŸä¸ªç‰¹å®šåº”ç”¨é¢†åŸŸä¸­ç³»ç»Ÿç»„ç»‡æ–¹å¼çš„æƒ¯ç”¨æ¨¡å¼ã€‚æ¶æ„é£æ ¼å®šä¹‰ä¸€ä¸ªè¯æ±‡è¡¨å’Œä¸€ç»„çº¦æŸï¼Œè¯æ±‡è¡¨ä¸­åŒ…å«ä¸€äº›ç»„ä»¶åŠè¿æ¥å™¨ï¼Œçº¦æŸåˆ™æŒ‡å‡ºç³»ç»Ÿå¦‚ä½•å°†æ„å»ºå’Œè¿æ¥å™¨ç»„åˆèµ·æ¥ã€‚è½¯ä»¶æ¶æ„é£æ ¼åæ˜ äº†é¢†åŸŸä¸­ä¼—å¤šç³»ç»Ÿæ‰€å…±æœ‰çš„ç»“æ„å’Œè¯­ä¹‰ç‰¹æ€§ï¼Œå¹¶æŒ‡å¯¼å¦‚ä½•å°†ç³»ç»Ÿä¸­
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://bobi.ink/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>å…³äºReactçš„ä¸€ä¸ªV8æ€§èƒ½ç“¶é¢ˆèƒŒåçš„æ•…äº‹</title>
    <link href="https://bobi.ink/2019/09/07/react-cliff/"/>
    <id>https://bobi.ink/2019/09/07/react-cliff/</id>
    <published>2019-09-06T16:00:00.000Z</published>
    <updated>2019-09-08T13:08:08.958Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>è¯‘æ³¨: åŸæ–‡ä½œè€…æ˜¯<a href="https://twitter.com/mathias" target="_blank" rel="noopener">Mathias Bynens</a>, ä»–æ˜¯V8å¼€å‘è€…ï¼Œè¿™ç¯‡æ–‡ç« ä¹Ÿå‘å¸ƒåœ¨<a href="https://v8.dev/blog" target="_blank" rel="noopener">V8çš„åšå®¢</a>ä¸Šã€‚ä»–çš„<a href="https://mathiasbynens.be" target="_blank" rel="noopener">ç›¸å…³æ–‡ç« </a>è´¨é‡éå¸¸é«˜ï¼Œå¦‚æœä½ æƒ³äº†è§£JavaScriptå¼•æ“å†…éƒ¨æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œä»–çš„æ–‡ç« ä¸€å®šä¸èƒ½é”™è¿‡ã€‚åé¢æˆ‘è¿˜ä¼šç¿»è¯‘ä»–çš„å…¶ä»–æ–‡ç« ï¼Œä¸€æ–¹é¢æ˜¯ä»–æ–‡ç« è´¨é‡å¾ˆé«˜ï¼Œå¦å¤–ä¸€æ–¹é¢æ˜¯æˆ‘æƒ³å­¦ä¹ ä¸€ä¸‹ä»–ä»¬æ˜¯æ€ä¹ˆå†™æ–‡ç« çš„ï¼Œé€šè¿‡ç¿»è¯‘æ–‡ç« ï¼Œè®©æˆ‘å¯ä»¥æ›´å¥½åœ°æ¶ˆåŒ–çŸ¥è¯†å’Œæ¨¡ä»¿å†™ä½œæŠ€å·§, æœ€åå¥‡æ–‡å…±èµï¼</p></blockquote><p>åŸæ–‡é“¾æ¥: <a href="https://v8.dev/blog/react-cliff" target="_blank" rel="noopener">The story of a V8 performance cliff in React</a></p><p><a href="https://mathiasbynens.be/notes/shapes-ics" target="_blank" rel="noopener">ä¹‹å‰</a>æˆ‘ä»¬è®¨è®ºè¿‡Javascriptå¼•æ“æ˜¯å¦‚ä½•é€šè¿‡Shape(å¤–å½¢)å’Œå†…è”ç¼“å­˜(Inline Caches)æ¥ä¼˜åŒ–å¯¹è±¡å’Œæ•°ç»„çš„è®¿é—®çš„, æˆ‘ä»¬è¿˜ç‰¹åˆ«æ¢è®¨äº†<a href="https://mathiasbynens.be/notes/prototypes" target="_blank" rel="noopener">Javascriptå¼•æ“æ˜¯å¦‚ä½•åŠ é€ŸåŸå‹å±æ€§è®¿é—®</a>. è¿™ç¯‡æ–‡ç« è®²è¿°<strong>V8å¦‚ä½•ä¸ºä¸åŒçš„Javascriptå€¼é€‰æ‹©æœ€ä½³çš„å†…å­˜è¡¨ç¤º(representations), ä»¥åŠå®ƒæ˜¯å¦‚ä½•å½±å“å¤–å½¢æœºåˆ¶(shape machinery)çš„</strong>ã€‚è¿™äº›å¯ä»¥å¸®åŠ©æˆ‘ä»¬è§£é‡Šæœ€è¿‘Reactå†…æ ¸å‡ºç°çš„V8æ€§èƒ½ç“¶é¢ˆ(Performance cliff)é—®é¢˜</p><blockquote><p>å¦‚æœä¸æƒ³çœ‹æ–‡ç« ï¼Œå¯ä»¥çœ‹è¿™ä¸ªæ¼”è®²ï¼š <a href="https://www.youtube.com/watch?v=0I0d8LkDqyc" target="_blank" rel="noopener">â€œJavaScript engine fundamentals: the good, the bad, and the uglyâ€</a></p></blockquote><p><br></p><h2 id="javascript-ç±»å‹"><a href="#javascript-ç±»å‹" class="headerlink" title="JavaScript ç±»å‹"></a>JavaScript ç±»å‹</h2><p>æ¯ä¸€ä¸ªJavascriptå€¼éƒ½å±äºä»¥ä¸‹å…«ä¸ªç±»å‹ä¹‹ä¸€(ç›®å‰): <code>Number</code>, <code>String</code>, <code>Symbol</code>, <code>BigInt</code>, <code>Boolean</code>, <code>Undefined</code>, <code>Null</code>, ä»¥åŠ <code>Object</code>.</p><p><img src="/images/react-cliff/01-javascript-types.svg" alt></p><p>ä½†æ˜¯æœ‰ä¸ªæ€»æ‰€å‘¨çŸ¥çš„ä¾‹å¤–ï¼Œåœ¨JavaScriptä¸­å¯ä»¥é€šè¿‡<code>typeof</code>æ“ä½œç¬¦è§‚å¯Ÿå€¼çš„ç±»å‹ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typeof</span> <span class="number">42</span>;</span><br><span class="line"><span class="comment">// â†’ 'number'</span></span><br><span class="line"><span class="keyword">typeof</span> <span class="string">'foo'</span>;</span><br><span class="line"><span class="comment">// â†’ 'string'</span></span><br><span class="line"><span class="keyword">typeof</span> <span class="built_in">Symbol</span>(<span class="string">'bar'</span>);</span><br><span class="line"><span class="comment">// â†’ 'symbol'</span></span><br><span class="line"><span class="keyword">typeof</span> <span class="number">42</span>n;</span><br><span class="line"><span class="comment">// â†’ 'bigint'</span></span><br><span class="line"><span class="keyword">typeof</span> <span class="literal">true</span>;</span><br><span class="line"><span class="comment">// â†’ 'boolean'</span></span><br><span class="line"><span class="keyword">typeof</span> <span class="literal">undefined</span>;</span><br><span class="line"><span class="comment">// â†’ 'undefined'</span></span><br><span class="line"><span class="keyword">typeof</span> <span class="literal">null</span>;</span><br><span class="line"><span class="comment">// â†’ 'object' ğŸ¤”</span></span><br><span class="line"><span class="keyword">typeof</span> &#123; <span class="attr">x</span>: <span class="number">42</span> &#125;;</span><br><span class="line"><span class="comment">// â†’ 'object'</span></span><br></pre></td></tr></table></figure><p><code>typeof null</code>è¿”å›çš„æ˜¯â€™<code>object</code>â€˜, è€Œä¸æ˜¯â€™<code>null</code>â€˜, å°½ç®¡<code>Null</code>æœ‰ä¸€ä¸ªè‡ªå·±çš„ç±»å‹ã€‚è¦ç†è§£ä¸ºä»€ä¹ˆï¼Œè€ƒè™‘å°†æ‰€æœ‰Javascriptç±»å‹çš„é›†åˆåˆ†ä¸ºä¸¤ç»„ï¼š</p><ul><li><em>å¯¹è±¡ç±»å‹</em> (i.e. <code>Object</code>ç±»å‹)</li><li><em>åŸå§‹(primitives)ç±»å‹</em> (i.e. ä»»ä½•éå¯¹è±¡å€¼)</li></ul><p>å› æ­¤, <code>null</code>å¯ä»¥ç†è§£ä¸ºâ€æ— å¯¹è±¡å€¼â€, è€Œ<code>undefined</code>åˆ™è¡¨ç¤ºä¸ºâ€œæ— å€¼â€.</p><blockquote><p>è¯‘æ³¨ï¼šä¹Ÿå°±æ˜¯ï¼Œnullå¯ä»¥ç†è§£ä¸ºå¯¹è±¡ç±»å‹çš„â€™undefinedâ€™ï¼›è€Œundefinedæ˜¯æ‰€æœ‰ç±»å‹çš„â€™undefinedâ€™</p></blockquote><p><img src="/images/react-cliff/02-primitives-objects.svg" alt></p><p>éµå¾ªè¿™ä¸ªæ€è·¯ï¼ŒBrendan Eich åœ¨è®¾è®¡Javascriptçš„æ—¶å€™å—åˆ°äº†Javaçš„å½±å“ï¼Œè®©<code>typeof</code>å³ä¾§æ‰€æœ‰å€¼(å³æ‰€æœ‰å¯¹è±¡å’Œnullå€¼)éƒ½è¿”å›â€™objectâ€™. è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ<code>typeof null === &#39;object&#39;</code>çš„åŸå› , å°½ç®¡è§„èŒƒä¸­æœ‰ä¸€ä¸ªå•ç‹¬çš„<code>Null</code>ç±»å‹ã€‚</p><p><img src="/images/react-cliff/03-primitives-objects-typeof.svg" alt></p><p><br></p><h2 id="å€¼çš„è¡¨ç¤º"><a href="#å€¼çš„è¡¨ç¤º" class="headerlink" title="å€¼çš„è¡¨ç¤º"></a>å€¼çš„è¡¨ç¤º</h2><p>Javascriptå¼•æ“å¿…é¡»èƒ½å¤Ÿåœ¨å†…å­˜ä¸­è¡¨ç¤ºä»»æ„çš„Javascriptå€¼. ç„¶è€Œï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<strong>Javascriptçš„å€¼ç±»å‹å’ŒJavascriptå¼•æ“å¦‚ä½•åœ¨å†…å­˜ä¸­è¡¨ç¤ºå®ƒä»¬æ˜¯ä¸¤å›äº‹</strong>.</p><p>ä¾‹å¦‚å€¼ <code>42</code>ï¼ŒJavascriptä¸­æ˜¯<code>number</code>ç±»å‹ã€‚</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typeof</span> <span class="number">42</span>;</span><br><span class="line"><span class="comment">// â†’ 'number'</span></span><br></pre></td></tr></table></figure><p>åœ¨å†…å­˜ä¸­æœ‰å¾ˆå¤šç§æ–¹å¼æ¥è¡¨ç¤ºç±»ä¼¼<code>42</code>è¿™æ ·çš„æ•´å‹æ•°å­—:</p><table><thead><tr><th>è¡¨ç¤º</th><th>ä½</th></tr></thead><tbody><tr><td>8-bitäºŒè¿›åˆ¶è¡¥ç </td><td><code>0010 1010</code></td></tr><tr><td>32-bitäºŒè¿›åˆ¶è¡¥ç </td><td><code>0000 0000 0000 0000 0000 0000 0010 1010</code></td></tr><tr><td>å‹ç¼©äºŒè¿›åˆ¶ç¼–ç åè¿›åˆ¶(packed binary-coded decimal (BCD))</td><td><code>0100 0010</code></td></tr><tr><td>32-bit IEEE-754 æµ®ç‚¹æ•°</td><td><code>0100 0010 0010 1000 0000 0000 0000 0000</code></td></tr><tr><td>64-bit IEEE-754 æµ®ç‚¹æ•°</td><td><code>0100 0000 0100 0101 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000</code></td></tr></tbody></table><p>ECMAScriptæ ‡å‡†çš„æ•°å­—ç±»å‹æ˜¯64ä½çš„æµ®ç‚¹æ•°ï¼Œæˆ–è€…ç§°ä¸ºåŒç²¾åº¦æµ®ç‚¹æ•°æˆ–è€…Float64. ç„¶è€Œï¼Œè¿™ä¸æ˜¯æ„å‘³ç€Javascriptå¼•æ“å°±ä¸€å®šè¦ä¸€ç›´æŒ‰ç…§Float64è¡¨ç¤ºä¿å­˜æ•°å­— â€”â€” è¿™ä¹ˆåšä¼šéå¸¸ä½æ•ˆï¼å¼•æ“å¯ä»¥é€‰æ‹©å…¶ä»–å†…éƒ¨è¡¨ç¤ºï¼Œåªè¦å¯è¢«å¯Ÿè§‰çš„è¡Œä¸ºå’ŒFloat64å®Œå…¨åŒ¹é…å°±è¡Œã€‚</p><p>å®é™…çš„JavaScriptåº”ç”¨ä¸­ï¼Œå¤§å¤šæ•°æ•°å­—ç¢°å·§éƒ½æ˜¯<a href="https://tc39.es/ecma262/#array-index" target="_blank" rel="noopener">åˆæ³•ECMAScriptæ•°ç»„ç´¢å¼•</a>ã€‚å³0 to 2Â³Â²âˆ’2ä¹‹é—´çš„æ•´å‹å€¼.</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">array[<span class="number">0</span>]; <span class="comment">// æœ€å°åˆæ³•çš„æ•°ç»„ç´¢å¼•.</span></span><br><span class="line">array[<span class="number">42</span>];</span><br><span class="line">array[<span class="number">2</span>**<span class="number">32</span><span class="number">-2</span>]; <span class="comment">// æœ€å¤§åˆæ³•æ•°ç»„ç´¢å¼•.</span></span><br></pre></td></tr></table></figure><p>JavaScriptå¼•æ“å¯ä»¥ä¸ºè¿™ç±»æ•°å­—é€‰æ‹©æœ€ä¼˜å†…å­˜è¡¨ç¤ºï¼Œæ¥ä¼˜åŒ–é€šè¿‡ç´¢å¼•è®¿é—®æ•°ç»„å…ƒç´ çš„ä»£ç ã€‚ä¸ºäº†è®©å¤„ç†å™¨å¯ä»¥æ‰§è¡Œå†…å­˜è®¿é—®æ“ä½œï¼Œæ•°ç»„ç´¢å¼•å¿…é¡»æ˜¯<a href="https://en.wikipedia.org/wiki/Two%27s_complement" target="_blank" rel="noopener">äºŒè¿›åˆ¶è¡¥ç </a>. å°†æ•°ç»„ç´¢å¼•è¡¨ç¤ºä¸ºFloat64å®é™…ä¸Šæ˜¯ä¸€ç§æµªè´¹ï¼Œå› ä¸ºå¼•æ“å¿…é¡»åœ¨æ¯æ¬¡æœ‰äººè®¿é—®æ•°ç»„å…ƒç´ æ—¶åœ¨float64å’ŒäºŒè¿›åˆ¶è¡¥ç ä¹‹é—´æ¥å›è½¬æ¢</p><p>32ä½çš„äºŒè¿›åˆ¶è¡¥ç è¡¨ç¤ºä¸ä»…ä»…å¯¹æ•°ç»„æ“ä½œæœ‰ç”¨ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œ<strong>å¤„ç†å™¨æ‰§è¡Œæ•´å‹æ“ä½œä¼šæ¯”æµ®ç‚¹å‹æ“ä½œè¦å¿«å¾—å¤š</strong>ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸‹ä¸€ä¸ªä¾‹å­ä¸­ï¼Œç¬¬ä¸€ä¸ªå¾ªç¯æ‰§è¡Œé€Ÿåº¦æ˜¯ç¬¬äºŒä¸ªå¾ªç¯çš„ä¸¤å€.</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; ++i) &#123;</span><br><span class="line">  <span class="comment">// fast ğŸš€</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0.1</span>; i &lt; <span class="number">1000.1</span>; ++i) &#123;</span><br><span class="line">  <span class="comment">// slow ğŸŒ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ“ä½œç¬¦ä¹Ÿä¸€æ ·ã€‚ä¸‹é¢ä»£ç ç‰‡æ®µä¸­ï¼Œå–æ¨¡æ“ä½œç¬¦çš„æ€§èƒ½ä¾èµ–äºæ“ä½œæ•°æ˜¯å¦æ˜¯æ•´å‹.</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> remainder = value % divisor;</span><br><span class="line"><span class="comment">// Fast ğŸš€ å¦‚æœ `value` å’Œ `divisor` éƒ½è¡¨ç¤ºä¸ºæ•´å‹,</span></span><br><span class="line"><span class="comment">// slow ğŸŒ å…¶ä»–æƒ…å†µ</span></span><br></pre></td></tr></table></figure><p>å¦‚æœä¸¤ä¸ªæ“ä½œæ•°éƒ½è¡¨ç¤ºä¸ºæ•´å‹ï¼ŒCPUå°±å¯ä»¥éå¸¸é«˜æ•ˆåœ°è®¡ç®—ç»“æœã€‚å¦‚æœ<code>divisor</code>æ˜¯2çš„å¹‚, V8è¿˜æœ‰é¢å¤–çš„å¿«é€Ÿé€šé“(fast-paths)ã€‚å¯¹äºè¡¨ç¤ºä¸ºæµ®ç‚¹æ ‘çš„å€¼ï¼Œè®¡ç®—åˆ™è¦å¤æ‚çš„å¤šï¼Œå¹¶ä¸”éœ€è¦æ›´é•¿çš„æ—¶é—´.</p><p>å› ä¸ºæ•´å‹æ“ä½œé€šå¸¸éƒ½æ¯”æµ®ç‚¹å‹æ“ä½œè¦å¿«å¾—å¤šï¼Œæ‰€ä»¥å¼•æ“ä¼¼ä¹å¯ä»¥æ€»æ˜¯ä½¿ç”¨äºŒè¿›åˆ¶è¡¥ç æ¥è¡¨ç¤ºæ‰€æœ‰æ•´å‹å€¼å’Œæ•´å‹çš„è®¡ç®—ç»“æœã€‚ä¸å¹¸çš„æ˜¯ï¼Œè¿™ä¼šè¿åECMAScriptè§„èŒƒï¼ECMAScriptæ˜¯åœ¨Float64åŸºç¡€ä¸Šè¿›è¡Œæ ‡å‡†åŒ–ï¼Œå› æ­¤å®é™…ä¸ŠæŸäº›æ•´æ•°æ“ä½œä¹Ÿå¯èƒ½ä¼šè¾“å‡ºæµ®ç‚¹æ•°ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒJSå¼•æ“è¾“å‡ºæ­£ç¡®çš„ç»“æœæ›´é‡è¦ã€‚</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Float64 çš„å®‰å…¨æ•´å‹èŒƒå›´æ˜¯ 53 bits. è¶…è¿‡è¿™ä¸ªè¿”å›ä¼šå¤±å»ç²¾åº¦,</span></span><br><span class="line"><span class="number">2</span>**<span class="number">53</span> === <span class="number">2</span>**<span class="number">53</span>+<span class="number">1</span>;</span><br><span class="line"><span class="comment">// â†’ true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Float64 æ”¯æŒ-0, ç´¢å¼• -1 * 0 å¿…é¡»æ˜¯ -0, ä½†æ˜¯äºŒè¿›åˆ¶è¡¥ç æ˜¯æ²¡åŠæ³•è¡¨ç¤º-0.</span></span><br><span class="line"><span class="number">-1</span>*<span class="number">0</span> === <span class="number">-0</span>;</span><br><span class="line"><span class="comment">// â†’ true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Float64 å¯ä»¥é€šè¿‡é™¤ä»¥0æ¥å¾—åˆ°æ— ç©·å¤§.</span></span><br><span class="line"><span class="number">1</span>/<span class="number">0</span> === <span class="literal">Infinity</span>;</span><br><span class="line"><span class="comment">// â†’ true</span></span><br><span class="line"><span class="number">-1</span>/<span class="number">0</span> === -<span class="literal">Infinity</span>;</span><br><span class="line"><span class="comment">// â†’ true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Float64 è¿˜æœ‰NaN.</span></span><br><span class="line"><span class="number">0</span>/<span class="number">0</span> === <span class="literal">NaN</span>;</span><br></pre></td></tr></table></figure><p>å°½ç®¡å·¦ä¾§éƒ½æ˜¯æ•´å‹ï¼Œå³ä¾§æ‰€æœ‰å€¼å´éƒ½æ˜¯æµ®ç‚¹å‹ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ32ä½äºŒè¿›åˆ¶è¡¥ç ä¸èƒ½æ­£ç¡®åœ°æ‰§è¡Œä¸Šé¢è¿™äº›æ“ä½œã€‚æ‰€ä»¥JavaScriptå¼•æ“å¿…é¡»ç‰¹åˆ«è°¨æ…ï¼Œä»¥ç¡®ä¿æ•´æ•°æ“ä½œå¯ä»¥é€‚å½“åœ°å›é€€ï¼Œä»è€Œè¾“å‡ºèŠ±å“¨(ç¬¦åˆè§„èŒƒ)çš„Float64ç»“æœã€‚</p><p>å¯¹äº31ä½æœ‰ç¬¦å·æ•´æ•°èŒƒå›´å†…çš„å°æ•´æ•°ï¼ŒV8ä½¿ç”¨ä¸€ä¸ªç§°ä¸º<code>Smi</code>(è¯‘æ³¨: Small Integer)çš„ç‰¹æ®Šè¡¨ç¤ºã€‚å…¶ä»–é<code>Smi</code>çš„è¡¨ç¤ºç§°ä¸º<code>HeapObject</code>ï¼Œå³æŒ‡å‘å†…å­˜ä¸­æŸäº›å®ä½“çš„åœ°å€ã€‚å¯¹äºæ•°å­—ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ä¸€ä¸ªç‰¹æ®Šç±»å‹çš„<code>HeapObject</code>, å°šä¸”ç§°ä¸º<code>HeapNumber</code>, ç”¨æ¥è¡¨ç¤ºä¸åœ¨SmièŒƒå›´å†…çš„æ•°å­—.</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"> -<span class="literal">Infinity</span> <span class="comment">// HeapNumber</span></span><br><span class="line">-(<span class="number">2</span>**<span class="number">30</span>)<span class="number">-1</span> <span class="comment">// HeapNumber</span></span><br><span class="line">  -(<span class="number">2</span>**<span class="number">30</span>) <span class="comment">// Smi</span></span><br><span class="line">       <span class="number">-42</span> <span class="comment">// Smi</span></span><br><span class="line">        <span class="number">-0</span> <span class="comment">// HeapNumber</span></span><br><span class="line">         <span class="number">0</span> <span class="comment">// Smi</span></span><br><span class="line">       <span class="number">4.2</span> <span class="comment">// HeapNumber</span></span><br><span class="line">        <span class="number">42</span> <span class="comment">// Smi</span></span><br><span class="line">   <span class="number">2</span>**<span class="number">30</span><span class="number">-1</span> <span class="comment">// Smi</span></span><br><span class="line">     <span class="number">2</span>**<span class="number">30</span> <span class="comment">// HeapNumber</span></span><br><span class="line">  <span class="literal">Infinity</span> <span class="comment">// HeapNumber</span></span><br><span class="line">       <span class="literal">NaN</span> <span class="comment">// HeapNumber</span></span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šæ‰€ç¤ºï¼Œä¸€äº›JavaScriptæ•°å­—è¡¨ç¤ºä¸º<code>Smi</code>ï¼Œè€Œå¦ä¸€äº›åˆ™è¡¨ç¤ºä¸º<code>HeapNumber</code>. V8ç‰¹æ„ä¸º<code>Smi</code>ä¼˜åŒ–è¿‡ï¼Œå› ä¸ºå°æ•´æ•°åœ¨å®é™…JavaScriptç¨‹åºä¸­å¤ªå¸¸è§äº†ã€‚<code>Smi</code>ä¸éœ€è¦åœ¨å†…å­˜ä¸­é¢å¤–åˆ†é…ä¸“é—¨çš„å®ä½“, å¯ä»¥è¿›è¡Œå¿«é€Ÿçš„æ•´å‹æ“ä½œ.</p><p>è¿™é‡Œæ›´é‡è¦çš„ä¸€ç‚¹æ˜¯ï¼Œ<strong>å³ä½¿æ˜¯ç›¸åŒJavascriptç±»å‹çš„å€¼ï¼Œä¸ºäº†ä¼˜åŒ–ï¼ŒèƒŒåå¯èƒ½ä¼šä»¥å®Œå…¨ä¸åŒçš„æ–¹å¼è¿›è¡Œè¡¨ç¤º</strong>ã€‚</p><p><br><br><br></p><h2 id="smi-vs-heapnumber-vs-mutableheapnumber"><a href="#smi-vs-heapnumber-vs-mutableheapnumber" class="headerlink" title="Smi vs. HeapNumber vs. MutableHeapNumber"></a>Smi vs. HeapNumber vs. MutableHeapNumber</h2><p>ä¸‹é¢ä»‹ç»å®ƒä»¬åº•å±‚æ˜¯æ€ä¹ˆå·¥ä½œçš„ã€‚å‡è®¾ä½ æœ‰ä¸‹åˆ—å¯¹è±¡:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> o = &#123;</span><br><span class="line">  x: <span class="number">42</span>,  <span class="comment">// Smi</span></span><br><span class="line">  y: <span class="number">4.2</span>, <span class="comment">// HeapNumber</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>x</code>çš„å€¼<code>42</code>å¯ä»¥è¢«ç¼–ç ä¸º<code>Smi</code>ï¼Œæ‰€ä»¥ä½ å¯ä»¥åœ¨å¯¹è±¡è‡ªå·±å†…éƒ¨è¿›è¡Œä¿å­˜ã€‚å¦ä¸€æ–¹é¢ï¼Œå€¼<code>4.2</code>åˆ™éœ€è¦ä¸€ä¸ªå•ç‹¬çš„å®ä½“æ¥ä¿å­˜ï¼Œç„¶åå¯¹è±¡å†æŒ‡å‘è¿™ä¸ªå®ä½“.</p><p><img src="/images/react-cliff/04-smi-vs-heapnumber.svg" alt></p><p>ç°åœ¨å¼€å§‹æ‰§è¡Œä¸‹é¢çš„Javascriptç‰‡æ®µ:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">o.x += <span class="number">10</span>;</span><br><span class="line"><span class="comment">// â†’ o.x ç°åœ¨æ˜¯ 52</span></span><br><span class="line">o.y += <span class="number">1</span>;</span><br><span class="line"><span class="comment">// â†’ o.y ç°åœ¨æ˜¯ 5.2</span></span><br></pre></td></tr></table></figure><p>è¿™ç§æƒ…å†µä¸‹ï¼Œ<code>x</code>çš„å€¼å¯ä»¥è¢«åŸåœ°(in-place)æ›´æ–°ï¼Œå› ä¸ºæ–°çš„å€¼<code>52</code>è¿˜æ˜¯ç¬¦åˆ<code>Smi</code>çš„èŒƒå›´.</p><p><img src="/images/react-cliff/05-update-smi.svg" alt></p><p>ç„¶è€Œï¼Œæ–°å€¼<code>y=5.2</code>ä¸ç¬¦åˆ<code>Smi</code>ï¼Œä¸”å’Œä¹‹å‰çš„å€¼<code>4.2</code>ä¸ä¸€æ ·ï¼Œæ‰€ä»¥V8å¿…é¡»åˆ†é…ä¸€ä¸ªæ–°çš„<code>HeapNumber</code>å®ä½“ï¼Œå†èµ‹å€¼ç»™yã€‚</p><p><img src="/images/react-cliff/06-update-heapnumber.svg" alt></p><p><code>HeapNumber</code>æ˜¯ä¸å¯å˜çš„ï¼Œè¿™ä¹Ÿè®©æŸäº›ä¼˜åŒ–æˆä¸ºå¯èƒ½ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœæˆ‘ä»¬å°†yçš„å€¼èµ‹ç»™x:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">o.x = o.y;</span><br><span class="line"><span class="comment">// â†’ o.x ç°åœ¨æ˜¯ 5.2</span></span><br></pre></td></tr></table></figure><p>â€¦æˆ‘ä»¬ç°åœ¨å¯ä»¥ç®€å•åœ°é“¾æ¥åˆ°åŒä¸€ä¸ªHeapNumberï¼Œè€Œä¸æ˜¯åˆ†é…ä¸€ä¸ªæ–°çš„.</p><p><img src="/images/react-cliff/07-heapnumbers.svg" alt></p><p><code>HeapNumbers</code>ä¸å¯å˜çš„ä¸€ä¸ªç¼ºç‚¹æ˜¯ï¼Œé¢‘ç¹æ›´æ–°å­—æ®µä¸åœ¨<code>Smi</code>èŒƒå›´å†…çš„å€¼ä¼šæ¯”è¾ƒæ…¢ï¼Œå¦‚ä¸‹ä¾‹æ‰€ç¤º:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ª `HeapNumber` å®ä¾‹.</span></span><br><span class="line"><span class="keyword">const</span> o = &#123; <span class="attr">x</span>: <span class="number">0.1</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; ++i) &#123;</span><br><span class="line">  <span class="comment">// åˆ›å»ºå¦ä¸€ä¸ª `HeapNumber` å®ä¾‹.</span></span><br><span class="line">  o.x += <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€è¡Œé€šè¿‡åˆå§‹åŒ–å€¼<code>0.1</code>åˆ›å»ºä¸€ä¸ª<code>HeapNumber</code>å®ä¾‹ã€‚å¾ªç¯ä½“å°†å®ƒçš„å€¼æ”¹å˜ä¸º<code>1.1</code>ã€<code>2.1</code>ã€<code>3.1</code>ã€<code>4.1</code>ã€æœ€åæ˜¯<code>5.1</code>ï¼Œè¿™ä¸ªè¿‡ç¨‹æ€»å…±åˆ›å»ºäº†6ä¸ª<code>HeapNumber</code>å®ä¾‹ï¼Œå…¶ä¸­5ä¸ªä¼šåœ¨å¾ªç¯ç»“æŸåè¢«åƒåœ¾å›æ”¶ã€‚</p><p><img src="/images/react-cliff/08-garbage-heapnumbers.svg" alt></p><p>ä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜ï¼ŒV8ä¹Ÿæä¾›äº†ä¸€ç§æœºåˆ¶æ¥åŸåœ°æ›´æ–°é<code>Smi</code>æ•°å­—å­—æ®µä½œä¸ºä¼˜åŒ–ã€‚å½“ä¸€ä¸ªæ•°å­—å­—æ®µä¿å­˜çš„å€¼è¶…å‡ºäº†<code>Smi</code>çš„èŒƒå›´åï¼ŒV8ä¼šåœ¨<code>Shape</code>ä¸­å°†è¿™ä¸ªå­—æ®µæ ‡è®°ä¸º<code>Double</code>, å¹¶ä¸”åˆ†é…ä¸€ä¸ªç§°ä¸º<code>MutableHeapNumber</code>å®ä½“æ¥ä¿å­˜å®é™…çš„å€¼ã€‚</p><p><img src="/images/react-cliff/09-mutableheapnumber.svg" alt></p><blockquote><p>è¯‘æ³¨: å…³äº<code>Shape</code>æ˜¯ä»€ä¹ˆï¼Œå¯ä»¥é˜…è¯»è¿™ç¯‡<a href="https://mathiasbynens.be/notes/shapes-ics" target="_blank" rel="noopener">æ–‡ç« </a>, ç®€å•è¯´<code>Shape</code>å°±æ˜¯ä¸€ä¸ªå¯¹è±¡çš„â€˜å¤–å½¢â€™ï¼ŒJavaScriptå¼•æ“å¯ä»¥é€šè¿‡<code>Shape</code>æ¥ä¼˜åŒ–å¯¹è±¡çš„å±æ€§è®¿é—®ã€‚</p></blockquote><p>ç°åœ¨å½“å­—æ®µçš„å€¼å˜åŠ¨æ—¶ï¼ŒV8ä¸éœ€è¦åœ¨åˆ†é…ä¸€ä¸ªæ–°çš„<code>HeapNumber</code>ï¼Œè€Œæ˜¯ç›´æ¥åŸåœ°æ›´æ–°<code>MutableHeapNumber</code>.</p><p><img src="/images/react-cliff/10-update-mutableheapnumber.svg" alt></p><p>ç„¶è€Œï¼Œè¿™ç§æ–¹å¼ä¹Ÿæœ‰ä¸€ä¸ªç¼ºé™·ã€‚å› ä¸ºMutableHeapNumberçš„å€¼å¯ä»¥è¢«ä¿®æ”¹ï¼Œæ‰€ä»¥è¿™äº›å€¼ä¸èƒ½å®‰å…¨ä¼ é€’ç»™å…¶ä»–å˜é‡</p><p><img src="/images/react-cliff/11-mutableheapnumber-to-heapnumber.svg" alt></p><p>ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœä½ å°†<code>o.x</code>èµ‹å€¼ç»™å…¶ä»–å˜é‡<code>y</code>ï¼Œä½ å¯ä¸æƒ³ä¸‹ä¸€æ¬¡<code>o.x</code>å˜åŠ¨æ—¶å½±å“åˆ°<code>y</code>çš„å€¼ â€”â€” è¿™è¿åäº†JavaScriptè§„èŒƒï¼å› æ­¤ï¼Œå½“<code>o.x</code>è¢«è®¿é—®åï¼Œåœ¨å°†å…¶èµ‹å€¼ç»™<code>y</code>ä¹‹å‰ï¼Œå¿…é¡»å°†è¯¥æ•°å­—é‡æ–°è£…ç®±(re-boxed)æˆä¸€ä¸ªå¸¸è§„çš„<code>HeapNumber</code>ã€‚</p><p>å¯¹äºæµ®ç‚¹æ•°ï¼ŒV8ä¼šåœ¨èƒŒåæ‰§è¡Œæ‰€æœ‰ä¸Šé¢æåˆ°çš„â€œåŒ…è£…(boxing)â€é­”æ³•ã€‚ä½†æ˜¯å¯¹äºå°æ•´æ•°æ¥è¯´ï¼Œä½¿ç”¨<code>MutableHeapNumber</code>å°±æ˜¯æµªè´¹ï¼Œå› ä¸º<code>Smi</code>æ˜¯æ›´é«˜æ•ˆçš„è¡¨ç¤ºã€‚</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> object = &#123; <span class="attr">x</span>: <span class="number">1</span> &#125;;</span><br><span class="line"><span class="comment">// â†’ ä¸éœ€è¦â€˜åŒ…è£…â€™xå­—æ®µ</span></span><br><span class="line"></span><br><span class="line">object.x += <span class="number">1</span>;</span><br><span class="line"><span class="comment">// â†’ ç›´æ¥åœ¨å¯¹è±¡å†…éƒ¨æ›´æ–°</span></span><br></pre></td></tr></table></figure><p>ä¸ºäº†é¿å…ä½æ•ˆç‡ï¼Œå¯¹äºå°æ•´æ•°ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨<code>Shape</code>ä¸Šå°†è¯¥å­—æ®µæ ‡è®°ä¸º<code>Smi</code>è¡¨ç¤ºï¼Œåªè¦ç¬¦åˆå°æ•´æ•°çš„èŒƒå›´ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç®€å•åœ°åŸåœ°æ›´æ–°æ•°å­—å€¼ã€‚</p><p><img src="/images/react-cliff/12-smi-no-boxing.svg" alt></p><p><br></p><h2 id="shape-åºŸå¼ƒå’Œè¿ç§»"><a href="#shape-åºŸå¼ƒå’Œè¿ç§»" class="headerlink" title="Shape åºŸå¼ƒå’Œè¿ç§»"></a>Shape åºŸå¼ƒå’Œè¿ç§»</h2><p>é‚£ä¹ˆï¼Œå¦‚æœä¸€ä¸ªå­—æ®µåˆå§‹åŒ–æ—¶æ˜¯<code>Smi</code>ï¼Œä½†æ˜¯åç»­ä¿å­˜äº†ä¸€ä¸ªè¶…å‡ºå°æ•´æ•°æ–¹ä½çš„å€¼å‘¢ï¼Ÿæ¯”å¦‚ä¸‹é¢è¿™ç§æƒ…å†µï¼Œä¸¤ä¸ªå¯¹è±¡éƒ½ä½¿ç”¨ç›¸åŒçš„<code>Shape</code>ï¼Œå³<code>x</code>åœ¨åˆå§‹åŒ–æ—¶è¡¨ç¤ºä¸º<code>Smi</code>:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> a = &#123; <span class="attr">x</span>: <span class="number">1</span> &#125;;</span><br><span class="line"><span class="keyword">const</span> b = &#123; <span class="attr">x</span>: <span class="number">2</span> &#125;;</span><br><span class="line"><span class="comment">// â†’ å¯¹è±¡ç°åœ¨å°† `x`å­—æ®µ è¡¨ç¤ºä¸º `Smi`</span></span><br><span class="line"></span><br><span class="line">b.x = <span class="number">0.2</span>;</span><br><span class="line"><span class="comment">// â†’ `b.x` ç°åœ¨è¡¨ç¤ºä¸º `Double`</span></span><br><span class="line"></span><br><span class="line">y = a.x;</span><br></pre></td></tr></table></figure><p>ä¸€å¼€å§‹ä¸¤ä¸ªå¯¹è±¡éƒ½æŒ‡å‘åŒä¸€ä¸ª<code>Shape</code>ï¼Œ<code>x</code>è¢«æ ‡è®°ä¸º<code>Smi</code>è¡¨ç¤ºï¼š</p><p><img src="/images/react-cliff/13-shape.svg" alt></p><p>å½“<code>b.x</code>ä¿®æ”¹ä¸º<code>Double</code>è¡¨ç¤ºæ—¶ï¼ŒV8ä¼šåˆ†é…ä¸€ä¸ªæ–°çš„<code>Shape</code>ï¼Œå°†<code>x</code>è®¾ç½®ä¸º<code>Double</code>è¡¨ç¤ºï¼Œå¹¶ä¸”å®ƒä¼šæŒ‡å‘å›<code>ç©ºShape</code>(è¯‘æ³¨ï¼šShapeæ˜¯æ ‘ç»“æ„)ã€‚å¦å¤–V8è¿˜ä¼šåˆ†é…ä¸€ä¸ª<code>MutableHeapNumber</code>æ¥ä¿å­˜<code>x</code>çš„æ–°å€¼<code>0.2</code>. æ¥ç€æˆ‘ä»¬æ›´æ–°å¯¹è±¡<code>b</code>æŒ‡å‘æ–°çš„<code>Shape</code>ï¼Œå¹¶ä¸”ä¿®æ”¹å¯¹è±¡çš„<code>x</code>æŒ‡å‘åˆšæ‰åˆ†é…çš„<code>MutableHeapNumber</code>ã€‚æœ€åï¼Œæˆ‘ä»¬æ ‡è®°æ—§çš„<code>Shape</code>ä¸ºåºŸå¼ƒçŠ¶æ€ï¼Œå¹¶ä»è½¬æ¢æ ‘(transition tree)ä¸­ç§»é™¤ã€‚è¿™æ˜¯é€šè¿‡å°†<code>â€œxâ€</code>ä»ç©º<code>Shape</code>è½¬æ¢ä¸ºæ–°åˆ›å»ºçš„<code>Shape</code>çš„æ–¹å¼æ¥å®Œæˆçš„ã€‚</p><p><img src="/images/react-cliff/14-shape-transition.svg" alt></p><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬è¿˜ä¸èƒ½å®Œå…¨å°†<code>æ—§Shape</code>åˆ é™¤æ‰ï¼Œå› ä¸ºå®ƒè¿˜è¢«<code>a</code>ä½¿ç”¨ç€ï¼Œè€Œä¸”ä½ ä¸èƒ½ç€æ€¥éå†å†…å­˜æ¥æ‰¾å‡ºæ‰€æœ‰æŒ‡å‘<code>æ—§Shape</code>çš„å¯¹è±¡ï¼Œè¿™ç§åšæ³•å¤ªä½æ•ˆã€‚æ‰€ä»¥V8é‡‡ç”¨æƒ°æ€§æ–¹å¼: å¯¹äº<code>a</code>çš„ä»»æ„å±æ€§çš„è®¿é—®å’Œèµ‹å€¼ï¼Œä¼šé¦–å…ˆè¿ç§»åˆ°æ–°çš„<code>Shape</code>ã€‚è¿™æ ·åš, æœ€ç»ˆå¯ä»¥å°†åºŸå¼ƒçš„Shapeå˜æˆâ€˜ä¸èƒ½åˆ°è¾¾(unreachable)â€™, è®©åƒåœ¾å›æ”¶å™¨é‡Šæ”¾æ‰å®ƒã€‚</p><p><img src="/images/react-cliff/15-shape-deprecation.svg" alt></p><p>å¦‚æœä¿®æ”¹è¡¨ç¤ºçš„å­—æ®µä¸æ˜¯é“¾ä¸­çš„æœ€åä¸€ä¸ªå­—æ®µï¼Œåˆ™ä¼šå‡ºç°æ›´æ£˜æ‰‹çš„æƒ…å†µï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> o = &#123;</span><br><span class="line">  x: <span class="number">1</span>,</span><br><span class="line">  y: <span class="number">2</span>,</span><br><span class="line">  z: <span class="number">3</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">o.y = <span class="number">0.1</span>;</span><br></pre></td></tr></table></figure><p>è¿™ç§æƒ…å†µï¼ŒV8éœ€è¦æ‰¾åˆ°æ‰€è°“çš„<code>åˆ†å‰²Shape</code>(split shape), å³ç›¸å…³å±æ€§åœ¨è¢«å¼•å…¥åˆ°<code>Shape</code>é“¾ä¹‹å‰çš„<code>Shape</code>ã€‚è¿™é‡Œæˆ‘ä»¬ä¿®æ”¹çš„æ˜¯<code>y</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°å¼•å…¥<code>y</code>ä¹‹å‰çš„æœ€åä¸€ä¸ª<code>Shape</code>ï¼Œåœ¨ä¸Šé¢çš„ä¾‹å­ä¸­è¿™ä¸ª<code>Shape</code>å°±æ˜¯<code>x</code>ï¼š</p><p><img src="/images/react-cliff/16-split-shape.svg" alt></p><p>ä»<code>åˆ†å‰²Shape</code>(å³x)å¼€å§‹ï¼Œæˆ‘ä»¬ä¸ºyåˆ›å»ºä¸€ä¸ªæ–°çš„è½¬æ¢é“¾, å®ƒå°†yæ ‡è®°ä¸º<code>Double</code>è¡¨ç¤ºï¼Œå¹¶é‡æ”¾(replay)ä¹‹å‰çš„å…¶ä»–è½¬æ¢. æˆ‘ä»¬å°†å¯¹<code>y</code>åº”ç”¨è¿™ä¸ªæ–°çš„è½¬æ¢é“¾ï¼Œå°†æ—§çš„æ ‘æ ‡è®°ä¸ºåºŸå¼ƒã€‚åœ¨æœ€åä¸€æ­¥ï¼Œæˆ‘ä»¬å°†å®ä¾‹<code>o</code>è¿ç§»åˆ°æ–°çš„<code>Shape</code>ï¼Œç°åœ¨ä½¿ç”¨ä¸€ä¸ª<code>MutableHeapNumber</code>æ¥ä¿å­˜<code>y</code>çš„å€¼ã€‚åé¢æ–°åˆ›å»ºçš„å¯¹è±¡éƒ½ä¸ä¼šä½¿ç”¨æ—§çš„<code>Shape</code>çš„è·¯å¾„ï¼Œä¸€æ—¦æ‰€æœ‰æ—§<code>Shape</code>çš„å¼•ç”¨éƒ½ç§»é™¤äº†ï¼Œ<code>Shape</code>æ ‘çš„åºŸå¼ƒéƒ¨åˆ†å°±ä¼šè¢«é”€æ¯ã€‚</p><h2 id="å¯æ‰©å±•æ€§å’Œå®Œæ•´æ€§çº§åˆ«è½¬æ¢"><a href="#å¯æ‰©å±•æ€§å’Œå®Œæ•´æ€§çº§åˆ«è½¬æ¢" class="headerlink" title="å¯æ‰©å±•æ€§å’Œå®Œæ•´æ€§çº§åˆ«è½¬æ¢"></a>å¯æ‰©å±•æ€§å’Œå®Œæ•´æ€§çº§åˆ«è½¬æ¢</h2><p><code>Object.preventExtensions()</code>é˜»æ­¢æ–°çš„å±æ€§æ·»åŠ åˆ°å¯¹è±¡ä¸­, å¦åˆ™å®ƒå°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚(å¦‚æœä½ ä¸åœ¨ä¸¥æ ¼æ¨¡å¼ï¼Œå®ƒå°†ä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè€Œæ˜¯ä»€ä¹ˆéƒ½ä¸å¹²)</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> object = &#123; <span class="attr">x</span>: <span class="number">1</span> &#125;;</span><br><span class="line"><span class="built_in">Object</span>.preventExtensions(object);</span><br><span class="line">object.y = <span class="number">2</span>;</span><br><span class="line"><span class="comment">// TypeError: Cannot add property y;</span></span><br><span class="line"><span class="comment">//            object is not extensible</span></span><br></pre></td></tr></table></figure><p><code>Object.seal</code>å’Œ<code>Object.preventExtensions</code>ç±»ä¼¼ï¼Œåªä¸è¿‡å®ƒå°†æ‰€æœ‰å±æ€§æ ‡è®°ä¸º<code>non-configurable</code>, è¿™æ„å‘³ç€ä½ ä¸èƒ½åˆ é™¤å®ƒä»¬, æˆ–è€…æ”¹å˜å®ƒä»¬çš„<code>Configurable</code>ã€<code>Enumerable</code>ã€<code>Writable</code>å±æ€§ã€‚</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> object = &#123; <span class="attr">x</span>: <span class="number">1</span> &#125;;</span><br><span class="line"><span class="built_in">Object</span>.seal(object);</span><br><span class="line">object.y = <span class="number">2</span>;</span><br><span class="line"><span class="comment">// TypeError: Cannot add property y;</span></span><br><span class="line"><span class="comment">//            object is not extensible</span></span><br><span class="line"><span class="keyword">delete</span> object.x;</span><br><span class="line"><span class="comment">// TypeError: Cannot delete property x</span></span><br></pre></td></tr></table></figure><p><code>Object.freeze</code>å’Œ<code>Object.seal</code>å·®ä¸å¤š, åªä¸è¿‡å®ƒè¿˜ä¼šé˜»æ­¢å·²å­˜åœ¨çš„å±æ€§è¢«ä¿®æ”¹ã€‚</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> object = &#123; <span class="attr">x</span>: <span class="number">1</span> &#125;;</span><br><span class="line"><span class="built_in">Object</span>.freeze(object);</span><br><span class="line">object.y = <span class="number">2</span>;</span><br><span class="line"><span class="comment">// TypeError: Cannot add property y;</span></span><br><span class="line"><span class="comment">//            object is not extensible</span></span><br><span class="line"><span class="keyword">delete</span> object.x;</span><br><span class="line"><span class="comment">// TypeError: Cannot delete property x</span></span><br><span class="line">object.x = <span class="number">3</span>;</span><br><span class="line"><span class="comment">// TypeError: Cannot assign to read-only property x</span></span><br></pre></td></tr></table></figure><p>è®©æˆ‘ä»¬è€ƒè™‘è¿™æ ·ä¸€ä¸ªå…·ä½“çš„ä¾‹å­ï¼Œä¸‹é¢ä¸¤ä¸ªå¯¹è±¡éƒ½åŒ…å«å•ä¸ª<code>x</code>å±æ€§ï¼Œåè€…è¿˜é˜»æ­¢äº†å¯¹è±¡æ‰©å±•ã€‚</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> a = &#123; <span class="attr">x</span>: <span class="number">1</span> &#125;;</span><br><span class="line"><span class="keyword">const</span> b = &#123; <span class="attr">x</span>: <span class="number">2</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Object</span>.preventExtensions(b);</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬éƒ½çŸ¥é“å®ƒä¸€å¼€å§‹ä¼šä»ç©º<code>Shape</code>è½¬æ¢ä¸ºä¸€ä¸ªåŒ…å«<code>x</code>(è¡¨ç¤ºä¸ºSmi)çš„æ–°<code>Shape</code>ã€‚å½“æˆ‘ä»¬é˜»æ­¢<code>b</code>è¢«æ‰©å±•æ—¶ï¼Œæˆ‘ä»¬ä¼šæ‰§è¡Œä¸€é¡¹ç‰¹æ®Šçš„è½¬æ¢ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„<code>Shape</code>å¹¶æ ‡è®°ä¸ºâ€™ä¸å¯æ‰©å±•â€™ã€‚è¿™ä¸ªç‰¹æ®Šçš„è½¬æ¢ä¸ä¼šå¼•å…¥ä»»ä½•æ–°çš„å±æ€§ â€”â€” å®ƒåªæ˜¯ä¸€ä¸ªæ ‡è®°</p><p><img src="/images/react-cliff/17-shape-nonextensible.svg" alt></p><p>æ³¨æ„ï¼Œæˆ‘ä»¬ä¸èƒ½åŸåœ°æ›´æ–°<code>x</code>çš„<code>Shape</code>ï¼Œå› ä¸ºå®ƒè¿˜è¢«<code>a</code>å¯¹è±¡å¼•ç”¨ï¼Œ<code>a</code>å¯¹è±¡è¿˜æ˜¯å¯æ‰©å±•çš„ã€‚</p><p><br></p><h2 id="reactçš„æ€§èƒ½é—®é¢˜"><a href="#reactçš„æ€§èƒ½é—®é¢˜" class="headerlink" title="Reactçš„æ€§èƒ½é—®é¢˜"></a>Reactçš„æ€§èƒ½é—®é¢˜</h2><p>è®©æˆ‘ä»¬å°†ä¸Šè¿°æ‰€æœ‰ä¸œè¥¿éƒ½æ”¾åœ¨ä¸€èµ·ï¼Œç”¨æˆ‘ä»¬å­¦åˆ°çš„çŸ¥è¯†æ¥ç†è§£<a href="https://github.com/facebook/react/issues/14365" target="_blank" rel="noopener">æœ€è¿‘çš„React Issue #14365</a>. å½“Reactå›¢é˜Ÿåœ¨åˆ†æä¸€ä¸ªçœŸå®çš„åº”ç”¨æ—¶ï¼Œä»–ä»¬å‘ç°äº†V8ä¸€ä¸ªå½±å“React æ ¸å¿ƒçš„å¥‡æ€ªæ€§èƒ½é—®é¢˜. ä¸‹é¢æ˜¯è¿™ä¸ªbugçš„ç®€å•å¤ç°:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> o = &#123; <span class="attr">x</span>: <span class="number">1</span>, <span class="attr">y</span>: <span class="number">2</span> &#125;;</span><br><span class="line"><span class="built_in">Object</span>.preventExtensions(o);</span><br><span class="line">o.y = <span class="number">0.2</span>;</span><br></pre></td></tr></table></figure><p>ä¸€å¼€å§‹æˆ‘ä»¬è¿™ä¸ªå¯¹è±¡æœ‰ä¸¤ä¸ª<code>Smi</code>è¡¨ç¤ºçš„å­—æ®µã€‚æ¥ç€æˆ‘ä»¬è¿˜é˜»æ­¢äº†å¯¹è±¡æ‰©å±•ï¼Œæœ€åè¿˜å¼ºåˆ¶å°†ç¬¬äºŒä¸ªå­—æ®µè½¬æ¢ä¸º<code>Double</code>è¡¨ç¤ºã€‚</p><p>æŒ‰ç…§æˆ‘ä»¬ä¸Šé¢æè¿°çš„ï¼Œè¿™å¤§æ¦‚ä¼šåˆ›å»ºä»¥ä¸‹ä¸œè¥¿ï¼š</p><p><img src="/images/react-cliff/18-repro-shape-setup.svg" alt></p><p>ä¸¤ä¸ªå±æ€§éƒ½ä¼šè¢«æ ‡è®°ä¸º<code>Smi</code>è¡¨ç¤ºï¼Œæœ€åä¸€ä¸ªè½¬æ¢æ˜¯å¯æ‰©å±•æ€§è½¬æ¢ï¼Œç”¨äºå°†Shapeæ ‡è®°ä¸ºä¸å¯æ‰©å±•ã€‚</p><p>ç°åœ¨æˆ‘ä»¬éœ€è¦å°†<code>y</code>è½¬æ¢ä¸º<code>Double</code>è¡¨ç¤ºï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬åˆè¦å¼€å§‹æ‰¾å‡º<code>åˆ†å‰²Shape</code>. åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>åˆ†å‰²Shape</code>å°±æ˜¯å¼•å…¥<code>x</code>çš„é‚£ä¸ª<code>Shape</code>ã€‚ä½†æ˜¯V8ä¼šæœ‰ç‚¹è¿·æƒ‘ï¼Œå› ä¸º<code>åˆ†å‰²Shape</code>æ˜¯å¯æ‰©å±•çš„ï¼Œè€Œå½“å‰<code>Shape</code>å´è¢«æ ‡è®°ä¸ºä¸å¯æ‰©å±•ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒV8å¹¶ä¸çŸ¥é“å¦‚ä½•æ­£ç¡®åœ°é‡æ”¾è½¬æ¢ã€‚æ‰€ä»¥V8å¹²è„†ä¸Šæ”¾å¼ƒäº†å°è¯•ç†è§£å®ƒï¼Œç›´æ¥åˆ›å»ºäº†ä¸€ä¸ªå•ç‹¬çš„Shapeï¼Œå®ƒæ²¡æœ‰è¿æ¥åˆ°ç°æœ‰çš„Shapeæ ‘ï¼Œä¹Ÿæ²¡æœ‰ä¸ä»»ä½•å…¶ä»–å¯¹è±¡å…±äº«ã€‚å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆä¸€ä¸ª<code>å­¤å„¿Shape</code>ï¼š</p><p><img src="/images/react-cliff/19-orphaned-shape.svg" alt></p><p>ä½ å¯ä»¥æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœæœ‰å¾ˆå¤šå¯¹è±¡éƒ½è¿™æ ·å­æœ‰å¤šç³Ÿç³•ï¼Œè¿™ä¼šè®©æ•´ä¸ª<code>Shape</code>ç³»ç»Ÿå˜å¾—æ¯«æ— ç”¨å¤„ã€‚</p><p>åœ¨Reactçš„åœºæ™¯ä¸­ï¼Œæ¯ä¸ªFiberNodeåœ¨æ‰“å¼€åˆ†æå™¨æ—¶éƒ½ä¼šæœ‰å¥½å‡ ä¸ªå­—æ®µç”¨äºä¿å­˜æ—¶é—´æˆ³.</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FiberNode</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">this</span>.actualStartTime = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">Object</span>.preventExtensions(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> node1 = <span class="keyword">new</span> FiberNode();</span><br><span class="line"><span class="keyword">const</span> node2 = <span class="keyword">new</span> FiberNode();</span><br></pre></td></tr></table></figure><p>è¿™äº›å­—æ®µ(ä¾‹å¦‚actualStartTime)è¢«åˆå§‹åŒ–ä¸º0æˆ–-1ï¼Œå³ä¸€å¼€å§‹æ—¶æ˜¯<code>Smi</code>è¡¨ç¤ºã€‚åæ¥ï¼Œè¿™äº›å­—æ®µèµ‹å€¼ä¸º<code>performance.now()</code>è¾“å‡ºçš„æ—¶é—´æˆ³ï¼Œè¿™äº›æ—¶é—´æˆ³å®é™…æ˜¯æµ®ç‚¹å‹çš„ã€‚å› ä¸ºä¸ç¬¦åˆ<code>Smi</code>èŒƒå›´ï¼Œå®ƒä»¬éœ€è¦è½¬æ¢ä¸º<code>Double</code>è¡¨ç¤ºã€‚æ°å¥½åœ¨è¿™é‡Œï¼ŒReactè¿˜é˜»æ­¢äº†FiberNodeå®ä¾‹çš„å¯æ‰©å±•æ€§ã€‚</p><p>ä¸Šé¢ä¾‹å­çš„åˆå§‹çŠ¶æ€å¦‚ä¸‹:</p><p><img src="/images/react-cliff/20-fibernode-shape.svg" alt></p><p>æŒ‰ç…§æˆ‘ä»¬è®¾æƒ³çš„ä¸€æ ·, è¿™ä¸¤ä¸ªå®ä¾‹å…±äº«äº†åŒä¸€ä¸ªShareæ ‘. åé¢ï¼Œå½“ä½ ä¿å­˜çœŸæ­£çš„æ—¶é—´æˆ³æ—¶ï¼ŒV8æ‰¾åˆ°<code>åˆ†å‰²Shape</code>å°±è¿·æƒ‘äº†ï¼š</p><p><img src="/images/react-cliff/21-orphan-islands.svg" alt></p><p>V8ç»™<code>node1</code>åˆ†é…äº†ä¸€ä¸ªæ–°çš„<code>å­¤å„¿Shape</code>ï¼Œ<code>node2</code>åŒç†ï¼Œè¿™æ ·å°±ç”Ÿæˆäº†ä¸¤ä¸ªå­¤å²›ï¼Œæ¯ä¸ªå­¤å²›éƒ½æœ‰è‡ªå·±ä¸ç›¸äº¤çš„Shapeã€‚å¤§éƒ¨åˆ†çœŸå®çš„Reactåº”ç”¨æœ‰ä¸Šåƒä¸Šä¸‡ä¸ªFiberNodeã€‚å¯ä»¥æƒ³è±¡åˆ°ï¼Œè¿™ç§æƒ…å†µå¯¹V8çš„æ€§èƒ½ä¸æ˜¯ç‰¹åˆ«ä¹è§‚ã€‚</p><p>å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬åœ¨V8 <a href="https://v8.dev/blog/v8-release-74" target="_blank" rel="noopener">v7.4</a>ä¿®å¤äº†è¿™ä¸ª<a href="https://chromium-review.googlesource.com/c/v8/v8/+/1442640/" target="_blank" rel="noopener">æ€§èƒ½é—®é¢˜</a>, æˆ‘ä»¬ä¹Ÿæ­£åœ¨ç ”ç©¶<a href="https://bit.ly/v8-in-place-field-representation-changes" target="_blank" rel="noopener">å¦‚ä½•é™ä½ä¿®æ”¹å­—æ®µè¡¨ç¤ºçš„æˆæœ¬</a>ï¼Œä»¥æ¶ˆç­å‰©ä½™çš„æ€§èƒ½ç“¶é¢ˆ. ç»è¿‡ä¿®å¤åï¼ŒV8å¯ä»¥æ­£ç¡®å¤„ç†è¿™ç§æƒ…å†µ:</p><p><img src="/images/react-cliff/22-fix.svg" alt></p><p>ä¸¤ä¸ªFiberNodeå®ä¾‹éƒ½æŒ‡å‘äº†â€™actualStartTimeâ€™ä¸º<code>Smi</code>çš„ä¸å¯æ‰©å±•<code>Shape</code>. å½“ç¬¬ä¸€æ¬¡ç»™<code>node1.actualStartTime</code>èµ‹å€¼æ—¶ï¼Œå°†åˆ›å»ºä¸€ä¸ªæ–°çš„è½¬æ¢é“¾ï¼Œå¹¶å°†ä¹‹å‰çš„é“¾æ ‡è®°ä¸ºåºŸå¼ƒã€‚</p><p><img src="/images/react-cliff/23-fix-fibernode-shape-1.svg" alt></p><p>æ³¨æ„, ç°åœ¨æ‰©å±•æ€§è½¬æ¢å¯ä»¥åœ¨æ–°é“¾ä¸­æ­£ç¡®é‡æ”¾ã€‚</p><p><img src="/images/react-cliff/24-fix-fibernode-shape-2.svg" alt></p><p>åœ¨èµ‹å€¼<code>node2.actualStartTime</code>ä¹‹åï¼Œä¸¤ä¸ªèŠ‚ç‚¹éƒ½å¼•ç”¨åˆ°äº†æ–°çš„Shapeï¼Œè½¬æ¢æ ‘ä¸­åºŸå¼ƒçš„éƒ¨åˆ†å°†è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ã€‚</p><p>åœ¨Bugæœªä¿®å¤ä¹‹å‰ï¼ŒReactå›¢é˜Ÿé€šè¿‡ç¡®ä¿FiberNodeä¸Šçš„æ‰€æœ‰æ—¶é—´å’Œæ—¶é—´æ®µå­—æ®µéƒ½åˆå§‹åŒ–ä¸ºDoubleè¡¨ç¤ºï¼Œæ¥ç¼“è§£äº†è¿™ä¸ªé—®é¢˜ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FiberNode</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="comment">// åœ¨ä¸€å¼€å§‹å¼ºåˆ¶ä¸ºDoubleè¡¨ç¤º.</span></span><br><span class="line">    <span class="keyword">this</span>.actualStartTime = <span class="built_in">Number</span>.NaN;</span><br><span class="line">    <span class="comment">// åé¢ä¾æ—§å¯ä»¥æŒ‰ç…§ä¹‹å‰çš„æ–¹å¼åˆå§‹åŒ–å€¼</span></span><br><span class="line">    <span class="keyword">this</span>.actualStartTime = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">Object</span>.preventExtensions(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> node1 = <span class="keyword">new</span> FiberNode();</span><br><span class="line"><span class="keyword">const</span> node2 = <span class="keyword">new</span> FiberNode();</span><br></pre></td></tr></table></figure><p>é™¤äº†<code>Number.NaN</code>, ä»»ä½•æµ®ç‚¹æ•°å€¼éƒ½ä¸åœ¨<code>Smi</code>çš„èŒƒå›´å†…, å¯ä»¥ç”¨äºå¼ºåˆ¶<code>Double</code>è¡¨ç¤ºã€‚ä¾‹å¦‚<code>0.000001</code>, <code>Number.MIN_VALUE</code>, <code>-0</code>å’Œ<code>Infinity</code></p><p>å€¼å¾—æŒ‡å‡ºçš„æ˜¯ï¼Œè¿™ä¸ªå…·ä½“çš„React bugæ˜¯V8ç‰¹æœ‰çš„ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œå¼€å‘äººå‘˜ä¸åº”è¯¥é’ˆå¯¹ç‰¹å®šç‰ˆæœ¬çš„JavaScriptå¼•æ“è¿›è¡Œä¼˜åŒ–ã€‚ä¸è¿‡ï¼Œå½“äº‹æƒ…ä¸èµ·ä½œç”¨çš„æ—¶å€™æœ‰ä¸ªæŠŠæŸ„æ€»æ¯”æ²¡æœ‰å¥½ã€‚</p><p>è®°ä½è¿™äº›Javascriptå¼•æ“èƒŒåæ‰§è¡Œçš„ä¸€äº›é­”æ³•ï¼Œ<strong>å¦‚æœå¯èƒ½ï¼Œå°½é‡ä¸è¦æ··åˆç±»å‹ï¼Œä¸¾ä¸ªä¾‹å­ï¼Œä¸è¦å°†ä½ çš„æ•°å­—å­—æ®µåˆå§‹åŒ–ä¸ºnullï¼Œå› ä¸ºè¿™æ ·ä¼šä¸§å¤±è·Ÿè¸ªå­—æ®µè¡¨ç¤ºçš„æ‰€æœ‰å¥½å¤„</strong>ã€‚ä¸æ··åˆç±»å‹ä¹Ÿå¯ä»¥è®©ä½ çš„ä»£ç æ›´å…·å¯è¯»æ€§ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Donâ€™t do this!</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span> </span>&#123;</span><br><span class="line">  x = <span class="literal">null</span>;</span><br><span class="line">  y = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> p = <span class="keyword">new</span> Point();</span><br><span class="line">p.x = <span class="number">0.1</span>;</span><br><span class="line">p.y = <span class="number">402</span>;</span><br></pre></td></tr></table></figure><blockquote><p>è¯‘æ³¨ï¼šå¦‚æœä½ ä½¿ç”¨Typescriptï¼Œåº”è¯¥å¼€å¯strictNullæ¨¡å¼</p></blockquote><p>æ¢å¥è¯è¯´ï¼Œç¼–å†™é«˜å¯è¯»çš„ä»£ç ï¼Œæ˜¯å¯ä»¥æé«˜æ€§èƒ½çš„ï¼</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æˆ‘ä»¬æ·±å…¥è®¨è®ºäº†ä¸‹åˆ—å†…å®¹ï¼š</p><ul><li>JavaScript åŒºåˆ†äº†â€˜åŸå§‹ç±»å‹â€™å’Œâ€˜å¯¹è±¡ç±»å‹â€™ï¼Œtypeofæ˜¯ä¸€ä¸ªéª—å­</li><li>å³ä½¿æ˜¯ç›¸åŒJavascriptç±»å‹çš„å€¼ï¼Œåº•å±‚å¯èƒ½æœ‰ä¸åŒçš„è¡¨ç¤º</li><li>V8å°è¯•ç»™ä½ çš„Javascriptç¨‹åºçš„æ¯ä¸ªå±æ€§æ‰¾å‡ºä¸€ä¸ªæœ€ä¼˜çš„è¡¨ç¤º</li><li>æˆ‘ä»¬è¿˜è®¨è®ºäº†V8æ˜¯å¦‚ä½•å¤„ç†ShapeåºŸå¼ƒå’Œè¿ç§»çš„ï¼Œå¦å¤–è¿˜åŒ…æ‹¬æ‰©å±•æ€§è½¬æ¢</li></ul><p>åŸºäºè¿™äº›çŸ¥è¯†ï¼Œæˆ‘ä»¬æ€»ç»“å‡ºäº†ä¸€äº›å¯ä»¥å¸®åŠ©æå‡æ€§èƒ½çš„JavaScriptç¼–ç¨‹æŠ€å·§ï¼š</p><ul><li>å§‹ç»ˆæŒ‰ç…§ä¸€è‡´çš„æ–¹å¼åˆå§‹åŒ–ä½ çš„å¯¹è±¡ï¼Œè¿™æ ·Shapeä¼šæ›´æœ‰æ•ˆ</li><li>ä¸ºå­—æ®µé€‰æ‹©åˆç†çš„åˆå§‹å€¼ï¼Œä»¥å¸®åŠ©JavaScriptå¼•æ“é€‰æ‹©æœ€ä½³çš„è¡¨ç¤ºã€‚</li></ul><p><br><br><br></p><p><img src="/images/sponsor.jpg" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;è¯‘æ³¨: åŸæ–‡ä½œè€…æ˜¯&lt;a href=&quot;https://twitter.com/mathias&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Mathias Bynens&lt;/a&gt;, ä»–æ˜¯V8å¼€å‘è€…ï¼Œè¿™ç¯‡æ–‡ç« ä¹Ÿå‘å¸ƒåœ¨&lt;a href=&quot;h
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://bobi.ink/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>if æˆ‘æ˜¯å‰ç«¯å›¢é˜Ÿ Leaderï¼Œæ€ä¹ˆåšå¥½æ¦‚è¦è®¾è®¡</title>
    <link href="https://bobi.ink/2019/09/06/fe-design/"/>
    <id>https://bobi.ink/2019/09/06/fe-design/</id>
    <published>2019-09-05T16:00:00.000Z</published>
    <updated>2019-09-26T23:20:18.993Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://juejin.im/post/5d3a7134f265da1b5d57f1ed" target="_blank" rel="noopener">if æˆ‘æ˜¯å‰ç«¯å›¢é˜Ÿ Leaderï¼Œæ€ä¹ˆåˆ¶å®šå‰ç«¯åä½œè§„èŒƒ?</a>åœ¨æ˜é‡‘ç›®å‰å·²ç»çªç ´740ä¸ªğŸ‘äº†, è°¢è°¢å¤§å®¶çš„æ”¯æŒï¼Œè¿™ç¯‡æ–‡ç« æ˜¯å‰è€…å»¶å±•ã€‚ç»§ç»­ä»‹ç»æˆ‘åœ¨å‰ç«¯å›¢é˜Ÿç®¡ç†æ–¹é¢çš„æ€è€ƒå’Œæ¢ç´¢ã€‚</p><p>è½¯ä»¶å·¥ç¨‹ä¸­æœ‰ä¸€ä¸ªè½¯ä»¶è®¾è®¡é˜¶æ®µï¼Œé€šä¿—çš„è®²å°±æ˜¯åœ¨å¼€å·¥ä¹‹å‰å°†èƒ½ç¡®å®šçš„ç¡®å®šä¸‹æ¥ï¼ŒæŠŠè¯¥è€ƒè™‘çš„è€ƒè™‘äº†ã€‚è¿™ç›¸æ¯”åœ¨å¼€å‘é˜¶æ®µå‘ç°é—®é¢˜ï¼Œè§£å†³çš„æˆæœ¬è¦ä½å¾ˆå¤šã€‚</p><p>å¦‚æœæŒ‰ç…§æ•™ç§‘ä¹¦ä¸Šçš„å®šä¹‰ï¼Œè½¯ä»¶è®¾è®¡å°±æ˜¯<strong>æ˜¯ä¸€ä¸ªå°†éœ€æ±‚è½¬å˜ä¸ºè½¯ä»¶é™ˆè¿°ï¼ˆè¡¨è¾¾ï¼‰çš„è¿‡ç¨‹</strong>ã€‚ä¸€èˆ¬æœ‰<strong>æ¦‚è¦è®¾è®¡(æˆ–è€…åˆæ­¥è®¾è®¡ï¼Œ Preliminary design)</strong>å’Œ<strong>è¯¦ç»†è®¾è®¡(Detail design)</strong>. æ¦‚è¦è®¾è®¡å°†éœ€æ±‚è½¬æ¢æˆæ•°æ®å’Œè½¯ä»¶æ¡†æ¶ï¼Œè€Œè¯¦ç»†è®¾è®¡å°†æ¡†æ¶é€æ­¥æ±‚ç²¾ç»†åŒ–ä¸ºå…·ä½“çš„æ•°æ®ç»“æ„å’Œè½¯ä»¶çš„ç®—æ³•è¡¨è¾¾ã€‚æœ¬æ–‡è®²è¿°çš„æ˜¯å‰ç«¯é¡¹ç›®çš„æ¦‚è¦è®¾è®¡ã€‚</p><p>ç›¸æ¯”åç«¯å¼€å‘, å¯¹äºå‰ç«¯ï¼Œâ€™è½¯ä»¶è®¾è®¡â€˜å¾ˆå°‘è¢«æåŠï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯ä¸€ç›´ä»¥æ¥å‰ç«¯çš„å·¥ä½œéƒ½æ¯”è¾ƒâ€™ç®€å•â€™ï¼Œæ‰€ä»¥æ¯”è¾ƒç²—æ”¾ã€‚ä¸€èˆ¬ç»™äº†åŸå‹å’Œæ¥å£æ–‡æ¡£å°±ç›´æ¥å¼€å¹²äº†ã€‚ä½†æ˜¯éšç€å‰ç«¯å¼€å‘è€…çš„å·¥ä½œè¶Šæ¥è¶Šå¤æ‚ï¼Œæˆ–è€…é¡¹ç›®/å›¢é˜Ÿçš„è§„æ¨¡å˜å¤§ï¼Œæˆ‘ä»¬è¶Šæ¥è¶Šéœ€è¦åœ¨ç¼–ç ä¹‹å‰è¿›è¡Œåˆç†çš„è®¾è®¡ã€‚</p><p>ä½œä¸º<strong>å‰ç«¯å…¥é—¨Leader</strong>, æœ€è¿‘é¢ä¸´äº†ä¸€äº›é—®é¢˜: æ¯”å¦‚é¡¹ç›®åˆ†å·¥é—®é¢˜ã€é¡¹ç›®ç»´æŠ¤ç¼ºä¹æ–‡æ¡£é—®é¢˜, è®©æˆ‘å¼€å§‹é‡è§†è½¯ä»¶è®¾è®¡é˜¶æ®µ. å°±ç›®å‰çœ‹æ¥ï¼Œåšå¥½å‰ç«¯<strong>æ¦‚è¦è®¾è®¡</strong>ï¼Œè‡³å°‘æœ‰ä»¥ä¸‹å¥½å¤„:</p><ul><li><strong>äº‹å‰</strong>. è®¾è®¡æ–‡æ¡£æ˜¯å¼€å‘çš„è“å›¾ï¼Œåç»­å¼€å‘å¯ä»¥æŒ‰ç…§è¿™ä¸ªæ–‡æ¡£é€æ­¥å±•å¼€ã€‚è‰¯å¥½çš„è®¾è®¡å¯ä»¥ä¿è¯å¼€å‘æ²¿ç€æ­£å¸¸è½¨é“è¿ˆè¿›ã€‚<ul><li>æˆ‘ä»¬åœ¨è®¾è®¡é˜¶æ®µä¼šè¿›ä¸€æ­¥æ¢³ç†ä¸šåŠ¡æµç¨‹ï¼ŒåŠ æ·±å¯¹ä¸šåŠ¡æµç¨‹çš„ç†è§£ï¼Œç”šè‡³å¯ä»¥æ‰¾å‡ºä¸šåŠ¡æµç¨‹ä¸­çš„ä¸åˆç†çš„ä¸œè¥¿ã€‚</li><li>æ¨¡å—æ‹†åˆ†ã€‚è¿™ä¸ªé˜¶æ®µæˆ‘ä»¬ä¼šè¯†åˆ«å„ä¸ªæ¨¡å—ä¹‹é—´è¾¹ç•Œå’Œé‡å ï¼Œå°†é‡å çš„(å…±äº«çš„)éƒ¨åˆ†æŠ½ç¦»å‡ºæ¥ã€‚å¦å¤–æ¨¡å—æ˜¯åŸºæœ¬çš„å¼€å‘å·¥ä½œå•å…ƒï¼Œä¹Ÿæ˜¯æˆ‘ä»¬å›¢é˜Ÿåˆ†å·¥å’Œæ—¶é—´è¯„ä¼°çš„åŸºç¡€ã€‚</li><li>è€ƒå¯Ÿå…³é”®çš„æŠ€æœ¯ç‚¹ã€‚æå‡ºå¤šç§å¤‡é€‰æ–¹æ¡ˆï¼Œå……åˆ†è€ƒè™‘å„ç§é£é™©, é€‰æ‹©ç¬¦åˆå®é™…éœ€æ±‚çš„æ–¹æ¡ˆ</li></ul></li><li><strong>äº‹å</strong>. è®¾è®¡æ–‡æ¡£å¯¹äº‹åçš„è½¯ä»¶ç»´æŠ¤ã€åŠŸèƒ½æ–°å¢ï¼Œæœ‰å¾ˆå¤§çš„å¸®åŠ©</li></ul><p><br></p><p>ä¸‹é¢å¼€å§‹ä»‹ç»ï¼Œå‰ç«¯åœ¨<strong>è½¯ä»¶è®¾è®¡é˜¶æ®µ</strong>åº”è¯¥è€ƒè™‘ä¸œè¥¿ï¼Œæˆ–è€…è¯´å‰ç«¯çš„<code>æ¦‚è¦è®¾è®¡æ–‡æ¡£</code>é‡Œé¢åº”è¯¥åŒ…å«å“ªäº›ä¸œè¥¿. å½“ç„¶è¿™äº›åªæ˜¯ä¸€äº›åˆæ­¥çš„æƒ³æ³•ï¼Œéšç€åé¢æ·±å…¥å®è·µåï¼Œæœ¬æ–‡ä¼šæŒç»­æ›´æ–°è¿­ä»£.</p><p><br></p><p><strong>æ–‡ç« å¤§çº²</strong></p><!-- TOC --><ul><li><a href="#å…³é”®ä¸šåŠ¡æµç¨‹çš„æ¢³ç†">å…³é”®ä¸šåŠ¡æµç¨‹çš„æ¢³ç†</a></li><li><a href="#å…³é”®æŠ€æœ¯ç‚¹">å…³é”®æŠ€æœ¯ç‚¹</a></li><li><a href="#æ¨¡å—è®¾è®¡">æ¨¡å—è®¾è®¡</a><ul><li><a href="#å…¥å£å±‚">å…¥å£å±‚</a></li><li><a href="#é¡µé¢å±‚">é¡µé¢å±‚</a></li><li><a href="#ç»„ä»¶å±‚">ç»„ä»¶å±‚</a></li><li><a href="#åˆ†å·¥">åˆ†å·¥</a></li></ul></li><li><a href="#çŠ¶æ€è®¾è®¡">çŠ¶æ€è®¾è®¡</a></li><li><a href="#æ¥å£è®¾è®¡">æ¥å£è®¾è®¡</a></li><li><a href="#ç‰ˆæœ¬è§„åˆ’">ç‰ˆæœ¬è§„åˆ’</a></li><li><a href="#éªŒè¯">éªŒè¯</a></li><li><a href="#é¡¹ç›®è¦æ±‚å’Œç›®æ ‡">é¡¹ç›®è¦æ±‚å’Œç›®æ ‡</a></li><li><a href="#æ–‡æ¡£ç´¢å¼•">æ–‡æ¡£ç´¢å¼•</a></li><li><a href="#æ„å»ºè¯´æ˜">æ„å»ºè¯´æ˜</a></li><li><a href="#æŒç»­è¿­ä»£">æŒç»­è¿­ä»£</a></li><li><a href="#æ¨¡æ¿">æ¨¡æ¿</a></li><li><a href="#æ€»ç»“">æ€»ç»“</a></li><li><a href="#å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</a></li></ul><!-- /TOC --><p><br></p><p><strong>ç³»åˆ—æ–‡ç« </strong></p><ul><li><a href="https://juejin.im/post/5d3a7134f265da1b5d57f1ed" target="_blank" rel="noopener">if æˆ‘æ˜¯å‰ç«¯å›¢é˜Ÿ Leaderï¼Œæ€ä¹ˆåˆ¶å®šå‰ç«¯åä½œè§„èŒƒ? ğŸ”¥</a></li><li><a href="https://juejin.im/post/5d71cec6e51d4561b674c4d0" target="_blank" rel="noopener">if æˆ‘æ˜¯å‰ç«¯å›¢é˜Ÿ Leaderï¼Œæ€ä¹ˆåšå¥½æ¦‚è¦è®¾è®¡</a></li><li><a href="https://juejin.im/post/5d8d4557e51d4577fe41b62d" target="_blank" rel="noopener">if æˆ‘æ˜¯å‰ç«¯å›¢é˜Ÿ Leaderï¼Œæ€ä¹ˆç”¨å¥½çœ‹æ¿è¿›è¡Œä»»åŠ¡ç®¡ç†?</a></li></ul><p><br></p><blockquote><p>è¿™æ–¹é¢æˆ‘çš„ç»éªŒå®è·µæ¯”è¾ƒå°‘, ä¹Ÿæ²¡æœ‰åœ¨å¤§å‚å¾…è¿‡ï¼Œæ‰€ä»¥æœ¬æ–‡åªæ˜¯æˆ‘çš„ä¸€äº›æ€è€ƒå’Œå°è¯•, å¯èƒ½ä¸å¤ªç°å®ã€‚å¦‚æœä½ æˆ–ä½ çš„å›¢é˜Ÿæœ‰è¿™æ–¹é¢çš„æ›´å¥½çš„å®è·µï¼Œæ¬¢è¿åˆ†äº«ç»™æˆ‘ã€‚æ„Ÿæ¿€ğŸ™</p></blockquote><p><br><br><br></p><h2 id="å…³é”®ä¸šåŠ¡æµç¨‹çš„æ¢³ç†"><a href="#å…³é”®ä¸šåŠ¡æµç¨‹çš„æ¢³ç†" class="headerlink" title="å…³é”®ä¸šåŠ¡æµç¨‹çš„æ¢³ç†"></a>å…³é”®ä¸šåŠ¡æµç¨‹çš„æ¢³ç†</h2><p>å¼€å‘ä»»ä½•ä¸€ä¸ªäº§å“ä¹‹å‰ï¼Œé¦–å…ˆè¦ç¡®ä¿çš„æ˜¯å¯¹ä¸šåŠ¡æµç¨‹çš„ç†è§£ï¼Œå¦åˆ™å°±ä¼šå‡ºç°å—è¾•åŒ—è¾™çš„æƒ…å†µã€‚</p><p>åœ¨ç°å®é¡¹ç›®ä¸­å‘ç”Ÿè¿‡å¤šæ¬¡è¿™ç±»æƒ…å†µï¼š<em>é¡¹ç›®åˆ°è¾¾æµ‹è¯•é˜¶æ®µï¼Œæµ‹è¯•äººå‘˜æ‰å‘ç°åº”ç”¨çš„ä¸šåŠ¡å®ç°å’Œäº§å“å®šä¹‰ä¸ä¸€æ ·ï¼Œæˆ–è€…ä¸šåŠ¡æµç¨‹ä¸åˆç†</em>ã€‚<br>è¿™å…¶å®æ˜¯ä¸€ç§å¾ˆä½çº§çš„å¤±è¯¯ï¼Œæ”¹åŠ¨çš„æˆæœ¬å¯èƒ½å¾ˆé«˜ï¼Œç”šè‡³ä¼šè®©ä½ çš„æ‰€æœ‰å·¥ä½œç™½å¹²ã€‚</p><p>ç®¡ç†æ¯”è¾ƒæˆç†Ÿçš„å…¬å¸ä¼šæœ‰å¾ˆå¤šæ‰‹æ®µæ¥è§„é¿è¿™ç§å¤±è¯¯ã€‚</p><p>æ¯”å¦‚å®šä¹‰æ˜ç¡®éœ€æ±‚æ–‡æ¡£ï¼Œè¿™æ–¹é¢å¯ä»¥æ¨¡ä»¿ä¸€äº›æ ‡å‡†/è§„èŒƒ(Spec)çš„å†™ä½œæ–¹æ³•ï¼Œä¸¥æ ¼å®šä¹‰ä¸€äº›å…³é”®å­—ï¼Œé¿å…æ¨¡æ£±ä¸¤å¯çš„æè¿°;</p><p>å¦å¤–å¯ä»¥é€šè¿‡å„ç§å®£è´¯ä¼šè®®ï¼Œå°†ç›¸å…³äººå‘˜èšé›†åœ¨ä¸€èµ·ï¼Œç»Ÿä¸€å¯¼å…¥éœ€æ±‚ã€‚åœ¨è¿™äº›ä¼šè®®ä¸­å¯ä»¥è¿›è¡Œå¤´è„‘é£æš´ï¼Œä¼˜åŒ–æˆ–ç»†åŒ–éœ€æ±‚çš„å®šä¹‰ã€å‘ç°ç¼ºé™·å’Œé£é™©ï¼Œåˆ†æå¯è¡Œæ€§ç­‰ç­‰ã€‚é€šè¿‡ä¸æ–­æ²Ÿé€šï¼Œæˆå‘˜ä¹‹é—´å¯ä»¥åˆ†äº«äº¤å‰çŸ¥è¯†ï¼Œç¡®ä¿å¯¹ä¸šåŠ¡ä¸€è‡´ç†è§£.</p><p><img src="/images/fe-design/doc.png" alt></p><p><br></p><p>å› æ­¤ï¼Œæˆ‘è§‰å¾—<strong>å‰ç«¯åœ¨è®¾è®¡é˜¶æ®µä¹Ÿåº”è¯¥åƒåç«¯ä¸€æ ·ï¼Œç”¨æµç¨‹å›¾æˆ–è€…æ—¶åºå›¾è¿™ç±»å·¥å…·ï¼Œå°†å…³é”®ä¸šåŠ¡æµç¨‹æè¿°æ¸…æ¥š. å°¤å…¶æ˜¯æ¶‰åŠåˆ°å‰åç«¯, è·¨ç³»ç»Ÿ/è·¨é¡µé¢/è·¨ç»ˆç«¯ä¹‹é—´çš„ä¸šåŠ¡äº¤äº’çš„åœºæ™¯</strong>.</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚æˆ‘ä»¬åœ¨åšä¸€ä¸ªâ€™æ‰«ç ç™»å½•â€˜åŠŸèƒ½ã€‚æˆ‘ä»¬å¯ä»¥å°†è·¨ç»ˆç«¯çš„ä¸šåŠ¡æ¢³ç†å‡ºæ¥ï¼š</p><p><img src="/images/fe-design/scan-login.png" alt></p><p><br></p><p>ä»ä¸Šé¢çš„ä¸šåŠ¡æ¢³ç†ä¸­æˆ‘ä»¬å¯ä»¥è¯†åˆ«å‡ºä¸šåŠ¡å¯¹è±¡çš„åŸºæœ¬è¡Œä¸ºå’ŒçŠ¶æ€. ä¾‹å¦‚äºŒç»´ç çš„çŠ¶æ€è½¬æ¢å›¾:</p><p><img src="/images/fe-design/scan-login-state.png" alt></p><p><br></p><p>å½“ç„¶, ç®€å•çš„å¢åˆ æŸ¥æ”¹èŠ±ç¯‡å¹…å»é˜è¿°æ²¡æœ‰æ„ä¹‰ã€‚<strong>æˆ‘ä»¬åªå…³æ³¨åº”ç”¨å…³é”®çš„ä¸šåŠ¡æµç¨‹</strong>.</p><p>æ€»ä¹‹ï¼Œä¸šåŠ¡æµç¨‹çš„æ¢³ç†ï¼Œå¯ä»¥åŠ æ·±æˆ‘ä»¬å¯¹ä¸šåŠ¡çš„ç†è§£ï¼Œæ˜¯åç»­è®¾è®¡æ­¥éª¤å’Œå¼€å‘çš„åŸºç¡€.</p><p><br><br><br></p><h2 id="å…³é”®æŠ€æœ¯ç‚¹"><a href="#å…³é”®æŠ€æœ¯ç‚¹" class="headerlink" title="å…³é”®æŠ€æœ¯ç‚¹"></a>å…³é”®æŠ€æœ¯ç‚¹</h2><p>æè¿°åº”ç”¨é‡‡ç”¨çš„æˆ–è€…æ¶‰åŠåˆ°å…³é”®æŠ€æœ¯/ç®—æ³•, ä¹Ÿå¯ä»¥è®¤ä¸ºæ˜¯<strong>æŠ€æœ¯é€‰å‹</strong>.</p><p>æ¯”å¦‚å…¸å‹çš„æœ‰è§†é¢‘ç›´æ’­åº”ç”¨ï¼Œæ¶‰åŠåˆ°çš„å„ç§ç›´æ’­æ–¹æ¡ˆ:</p><ul><li>RTMP åè®®</li><li>RTPåè®®</li><li>HLS åè®®</li><li>flv.js</li><li>WebRTCåè®®</li><li>ç­‰ç­‰</li></ul><p><strong>åœ¨å¼€å¯ä¸€ä¸ªé¡¹ç›®ä¹‹å‰, æˆ‘ä»¬éœ€è¦å¯¹é¡¹ç›®æ¶‰åŠåˆ°çš„å…³é”®æŠ€æœ¯ç‚¹è¿›è¡Œè°ƒç ”å’Œæµ‹è¯•ï¼Œæœ€å¥½å¤šæ‰¾å‡ ä¸ªæ›¿ä»£æ–¹æ¡ˆï¼Œæ¨ªå‘åœ°æ¯”è¾ƒå®ƒä»¬çš„ä¼˜åŠ¿å’ŒåŠ£åŠ¿</strong>ã€‚é€‰æ‹©ç¬¦åˆé¡¹ç›®æˆ–å›¢é˜Ÿè‡ªå·±æƒ…å†µçš„æ–¹æ¡ˆ. å¦‚æœæ—¶é—´å……è¶³, å¯ä»¥å†™ä¸€äº›Demoï¼Œå®åœ°è¸©ä¸€ä¸‹å‘.</p><p>å¦‚æœæœ‰å¤šä¸ªå¤‡é€‰æ–¹æ¡ˆï¼Œæœ€åè¦ç”„é€‰å‡ºæ¨èæ–¹æ¡ˆï¼Œå¹¶è¯´æ˜é€‰æ‹©çš„åŸå› å’Œè€ƒè™‘ã€‚</p><p><strong>æå‰åšå¥½æŠ€æœ¯çš„è°ƒç ”å’Œé€‰å‹ï¼Œç¡®å®šå¯è¡Œæ€§ï¼Œä¸è‡³äºå¼€å‘å¤„äºè¢«åŠ¨çš„å¢ƒåœ°</strong>.</p><p>å…³äºå¦‚ä½•è¿›è¡ŒæŠ€æœ¯é€‰å‹ï¼Œæˆ‘åœ¨<a href="https://juejin.im/post/5d3a7134f265da1b5d57f1ed#heading-10" target="_blank" rel="noopener">if æˆ‘æ˜¯å‰ç«¯å›¢é˜Ÿ Leaderï¼Œæ€ä¹ˆåˆ¶å®šå‰ç«¯åä½œè§„èŒƒ?</a>è¿›è¡Œäº†ç®€å•çš„è®¨è®ºï¼Œå¯ä»¥å‚è€ƒä¸€ä¸‹.</p><p><br><br><br></p><h2 id="æ¨¡å—è®¾è®¡"><a href="#æ¨¡å—è®¾è®¡" class="headerlink" title="æ¨¡å—è®¾è®¡"></a>æ¨¡å—è®¾è®¡</h2><p>ç°ä»£å‰ç«¯ä¸€èˆ¬éƒ½ä½¿ç”¨<strong>ç»„ä»¶åŒ–æ€ç»´</strong>è¿›è¡Œå¼€å‘ï¼Œ<strong>è¿™æ—¶å€™æˆ‘ä»¬çš„åº”ç”¨å…¶å®å°±æ˜¯ä¸€é¢—ç”±ä¸åŒç²’åº¦çš„ç»„ä»¶å¤åˆèµ·æ¥çš„ç»„ä»¶æ ‘</strong>ï¼Œè¿™é¢—ç»„ä»¶æ ‘æœ€ç»ˆä¼šä½“ç°åˆ°é¡¹ç›®çš„ç›®å½•ç»“æ„ä¸Šã€‚ <strong>åœ¨è®¾è®¡é˜¶æ®µæˆ‘ä»¬å¯ä»¥æ ¹æ®äº§å“åŸå‹æˆ–UIè®¾è®¡ç¨¿ï¼Œè¯†åˆ«å‡ºå„ç§é¡µé¢å’Œç»„ä»¶</strong>ã€‚</p><p><img src="/images/fe-design/module-tree-map.png" alt></p><p>æ­£å¸¸çš„åº”ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥åˆ†ä¸‰ä¸ªå±‚çº§è¿›è¡Œæ‹†åˆ†:</p><p><img src="/images/fe-design/module.png" alt></p><h3 id="å…¥å£å±‚"><a href="#å…¥å£å±‚" class="headerlink" title="å…¥å£å±‚"></a>å…¥å£å±‚</h3><p>ç¨å¾®å¤æ‚ä¸€ç‚¹çš„åº”ç”¨å¯èƒ½æœ‰å¤šä¸ªå…¥å£ï¼Œè¿™äº›å…¥å£å‘ˆç°çš„é¡µé¢å¯èƒ½å·®å¼‚å¾ˆå¤§. ä¸‹é¢æ˜¯ä¸€ä¸ªå¸¸è§çš„åˆ’åˆ†æ–¹æ³•:</p><ul><li>æŒ‰å­ç³»ç»Ÿåˆ’åˆ†: æ¯”å¦‚å‰å°å’Œåå°ã€‚</li><li>æŒ‰è§’è‰²åˆ’åˆ†ï¼šæ¯”å¦‚ç®¡ç†å‘˜ã€æ™®é€šç”¨æˆ·</li><li>æŒ‰å…¥å£åˆ’åˆ†ï¼šæ¯”å¦‚ç§»åŠ¨ç«¯ã€æ¡Œé¢ç«¯ç­‰ç­‰</li></ul><p><br></p><h3 id="é¡µé¢å±‚"><a href="#é¡µé¢å±‚" class="headerlink" title="é¡µé¢å±‚"></a>é¡µé¢å±‚</h3><p>ä¸‹ä¸€æ­¥å°±æ˜¯è¯†åˆ«å„ç§é¡µé¢ï¼Œè¿™äº›é¡µé¢å³å¯¹åº”åˆ°æˆ‘ä»¬çš„å‰ç«¯è·¯ç”±é…ç½®è§„åˆ™. ä»¥ä¸‹é¢ç®€å•çš„åº”ç”¨ä¸ºä¾‹:</p><p><img src="/images/fe-design/sample-pages.png" alt></p><p>å…³äºæ¨¡å—çš„åˆ’åˆ†ï¼Œæˆ‘å»ºè®®ä½¿ç”¨<strong>æ€ç»´å¯¼å›¾</strong>è¿›è¡Œç»„ç»‡ã€‚<strong>æ¨¡å—åˆ’åˆ†è¿™ä¸ªç¯èŠ‚ï¼Œä½ å¯ä»¥å¬é›†å›¢é˜Ÿçš„å…¶ä»–æˆå‘˜å¼€ä¸ªä¼šè®®ï¼Œä¸€èµ·è¿›è¡Œå¤´è„‘é£æš´ã€‚å¤§å®¶å‚ç…§ç€äº§å“åŸå‹ï¼Œè¯†åˆ«å‡ºå„ç§æ¨¡å—æˆ–ç»„ä»¶çš„è¾¹ç•Œå’Œäº¤é›†, è®¨è®ºæ€ä¹ˆè®¾è®¡é¡µé¢çš„æ•°æ®æµã€ç»„ä»¶çš„æ¥å£ç­‰ç­‰</strong>, è¿™æ ·å¯ä»¥åˆ©ç”¨é›†ä½“æ™ºæ…§ï¼Œè®©æ¨¡å—æ‹†åˆ†æ›´åŠ åˆç†ï¼Œå¦å¤–å¯ä»¥ä¿ƒè¿›å›¢é˜Ÿæˆå‘˜æå‰ç†Ÿæ‚‰é¡¹ç›®çš„ç»“æ„ã€‚</p><p>æ‰€ä»¥è¯´<strong>è½¯ä»¶è®¾è®¡ä¸æ˜¯æ¶æ„å¸ˆæˆ–è®¾è®¡äººå‘˜ä¸€ä¸ªäººçš„äº‹ï¼Œåº”è¯¥é¼“åŠ±å¤§å®¶ä¸€èµ·å‚ä¸ï¼Œè®¾è®¡æ–‡æ¡£æ˜¯æ•´ä¸ªè½¯ä»¶å›¢é˜Ÿçš„äº§å‡º, æ˜¯å›¢é˜Ÿçš„çŸ¥è¯†æ²‰æ·€</strong>ã€‚</p><p>ä¸Šé¢çš„åº”ç”¨é€šè¿‡é¡µé¢å±‚åˆ’åˆ†åï¼Œç»“æœå¤§æ¦‚å¦‚ä¸‹ï¼š</p><p><img src="/images/fe-design/pages.png" alt></p><p>åœ¨è¿™ä¸ªé˜¶æ®µæˆ‘ä»¬ä¼šç¡®å®šä»¥ä¸‹å†…å®¹:</p><ul><li><strong>é¡µé¢ä»¥åŠè·¯ç”±è®¾è®¡, ç¡®å®šé¡µé¢ä¹‹é—´çš„å±‚çº§å…³ç³»</strong></li><li><strong>é¡µé¢ä¹‹é—´äº¤äº’æµç¨‹ã€æ•°æ®ä¼ é€’</strong></li></ul><p><strong>å…³äºè·¯ç”±è®¾è®¡ï¼Œå¯ä»¥éµå¾ªä¸€äº›è§„èŒƒï¼Œç¬”è€…æ¯”è¾ƒæ¨è<a href="http://www.ruanyifeng.com/blog/2018/10/restful-api-best-practices.html" target="_blank" rel="noopener">Restful URLè§„èŒƒ</a></strong>, è¿™ç¯‡<a href="https://novoland.github.io/è®¾è®¡/2015/08/17/Restful%20API%20çš„è®¾è®¡è§„èŒƒ.html" target="_blank" rel="noopener">æ–‡ç« </a>å†™å¾—ä¹Ÿä¸é”™.</p><p>è·¯ç”±ä¹‹é—´çš„æ•°æ®ä¼ é€’ä¸€èˆ¬æœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼:</p><ul><li>å°‘é‡æ•°æ®ï¼šå¯ä»¥é€šè¿‡è·¯ç”±å˜é‡(ä¾‹å¦‚<code>/posts/:id</code>)æˆ–è€…æŸ¥è¯¢å­—ç¬¦ä¸²å½¢å¼ä¼ é€’. è¿˜æœ‰å¦‚æœä½ ä½¿ç”¨çš„æ˜¯<a href="https://react-router.docschina.org/web/api/BrowserRouter" target="_blank" rel="noopener">åŸºäºHistory APIçš„å‰ç«¯è·¯ç”±æ¨¡å¼</a>ï¼Œå¯ä»¥ä½¿ç”¨Historyçš„<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/History_API" target="_blank" rel="noopener">state</a>å¯¹è±¡æ¥å­˜å‚¨ä¸€äº›çŠ¶æ€(æœ€å¤§640k)</li><li>å¤§é‡æ•°æ®ï¼šå¯ä»¥é€šè¿‡å…¨å±€å˜é‡ï¼Œæˆ–è€…çŠ¶æ€ç®¡ç†å™¨çš„æœºåˆ¶è¿›è¡Œå­˜å‚¨, ä¸ç®¡è¿™ç§å­˜å‚¨åœ¨å†…å­˜çš„æ–¹å¼ï¼Œä¸€æ—¦é¡µé¢åˆ·æ–°å°±ä¼šä¸¢å¤±ã€‚æ‰€ä»¥ä¹Ÿå¯ä»¥è€ƒè™‘å­˜å‚¨åœ¨æœ¬åœ°ç¼“å­˜ä¸­, ä¾‹å¦‚LocalStorage</li></ul><p><br></p><h3 id="ç»„ä»¶å±‚"><a href="#ç»„ä»¶å±‚" class="headerlink" title="ç»„ä»¶å±‚"></a>ç»„ä»¶å±‚</h3><p>Okï¼Œå†å¾€ä¸‹æ‹†åˆ†ï¼Œä¸è¿‡è¦é‡åŠ›è€Œè¡Œã€‚å¯¹äºä¸€ä¸ªéå¸¸å¤æ‚çš„é¡¹ç›®æ¥è¯´ï¼Œå¯èƒ½æœ‰æˆåƒä¸Šç™¾ä¸ªç»„ä»¶ï¼Œè€Œä¸”è¿™äº›ç»„ä»¶åœ¨æœªæ¥å¯èƒ½ä¼šä¸æ–­å˜åŒ–ï¼Œåœ¨è®¾è®¡é˜¶æ®µè€ƒè™‘è¿™äº›æ‹†åˆ†å¯èƒ½éœ€è¦èŠ±è´¹å¾ˆå¤šæ—¶é—´ï¼Œè€Œä¸”æ”¶ç›Šå¹¶ä¸æ˜æ˜¾ã€‚</p><p>é‚£ä¹ˆéœ€è¦æ€ä¹ˆæŠŠæ¡ç²’åº¦å‘¢ï¼Ÿå…¶å®ç»„ä»¶å±‚è®¾è®¡é˜¶æ®µçš„ä¸»è¦ç›®çš„æ˜¯<strong>æ‰¾å‡ºé‡å¤çš„ã€æˆ–è€…ç»“æ„ç±»ä¼¼çš„ç»„ä»¶ï¼Œå°†å®ƒä»¬æŠ½å–å‡ºæ¥ç»Ÿä¸€çš„è®¾è®¡ï¼Œåœ¨å¤šä¸ªé¡µé¢è¿›è¡Œå¤ç”¨. å¹¶ä¸æ˜¯æŠŠæ‰€æœ‰çš„ç»„ä»¶éƒ½åˆ—ä¸¾å‡ºæ¥</strong>ã€‚</p><p>æˆ‘åœ¨<a href="https://juejin.im/post/5cd8fb916fb9a03218556fc1" target="_blank" rel="noopener">Reactç»„ä»¶è®¾è®¡å®è·µæ€»ç»“02 - ç»„ä»¶çš„ç»„ç»‡</a>è¿™ç¯‡æ–‡ç« ä¸­ï¼Œä¸“é—¨ä»‹ç»Reactç»„ä»¶å¦‚ä½•è¿›è¡Œç»„ç»‡å’Œæ‹†åˆ†ã€‚å…¶ä¸­æå‡ºäº†ä»¥ä¸‹é›†ä¸­æ¨¡å¼:</p><ul><li>å®¹å™¨ç»„ä»¶å’Œå±•ç¤ºç»„ä»¶åˆ†ç¦»ã€‚æˆ–è€…è¯´åˆ†ç¦»è§†å›¾å’Œé€»è¾‘, ä¸šåŠ¡ç»„ä»¶å’Œå‚»ç“œç»„ä»¶. çº¯é€»è¾‘çš„ä¸œè¥¿æ”¾åœ¨Hooksä¸­ï¼Œä½¿ç”¨èµ·æ¥ä¼šæ›´åŠ æ–¹ä¾¿</li><li>çº¯ç»„ä»¶å’Œéçº¯ç»„ä»¶. å¯ä»¥è®¤ä¸ºçº¯ç»„ä»¶å®Œå…¨ä¾èµ–å¤–éƒ¨è¾“å…¥</li><li>æœ‰çŠ¶æ€ç»„ä»¶å’Œæ— çŠ¶æ€ç»„ä»¶</li><li>å¸ƒå±€ç»„ä»¶å’Œå†…å®¹ç»„ä»¶</li><li>ç»Ÿä¸€è®¾è®¡åŒä¸€ç±»å‹ç»„ä»¶çš„æ¥å£. æ¯”å¦‚è¡¨å•ç»„ä»¶åº”è¯¥ä¿æŒæ¥å£ç»Ÿä¸€</li></ul><p><img src="/images/fe-design/sample-pages2.png" alt></p><p>è¿˜æ˜¯ä¸Šé¢çš„ç¤ºä¾‹åº”ç”¨ï¼Œç”³æŠ¥é¡µé¢æœ‰éå¸¸å¤šçš„è¡¨å•é¡¹ï¼Œè€Œä¸”ç»å¸¸å˜åŠ¨ï¼Œå¦å¤–ä½ ä¼šå‘ç°å®ƒå’Œé¢„è§ˆé¡µé¢çš„ç»“æ„æ˜¯å·®ä¸å¤šçš„ï¼Œè€Œä¸”åé¢å¯èƒ½ä¼šæœ‰æ¡Œé¢ç«¯é¡µé¢ã€‚</p><p>ç»è¿‡è®¨è®ºï¼Œæˆ‘ä»¬å†³å®šé‡‡ç”¨é…ç½®æ–‡ä»¶çš„æ–¹å¼æ¥åŠ¨æ€æ¸²æŸ“è¡¨å•é¡µå’Œé¢„è§ˆé¡µã€‚å®ç°ä¸€å¥—é…ç½®æ§åˆ¶ç§»åŠ¨ç«¯ç”³è¯·è¡¨å•ã€æ¡Œé¢ç«¯ç”³è¯·è¡¨å•ã€ç§»åŠ¨ç«¯é¢„è§ˆã€æ¡Œé¢ç«¯é¢„è§ˆé¡µé¢ã€‚</p><p>ç±»ä¼¼ä¸Šé¢è¿™ç§åº”ç”¨åœºæ™¯ï¼Œå‰æœŸçš„ç»„ä»¶å±‚è®¾è®¡å°±å¾ˆæœ‰å¿…è¦äº†ã€‚</p><p><br></p><p><img src="/images/fe-design/components.png" alt></p><p><br></p><h3 id="åˆ†å·¥"><a href="#åˆ†å·¥" class="headerlink" title="åˆ†å·¥"></a>åˆ†å·¥</h3><p>å°†æ¨¡å—æ‹†åˆ†æ¸…æ¥šåï¼Œæˆ‘ä»¬å°±å¯ä»¥é’ˆå¯¹è¿™äº›æ¨¡å—è¿›è¡Œåˆç†çš„åˆ†å·¥å’Œæ—¶é—´è¯„ä¼°ã€‚åŸºæœ¬ä¸Šæœ‰ä¸‰ä¸ªæ­¥éª¤ï¼š</p><p><img src="/images/fe-design/module-plan.png" alt></p><p>é€šè¿‡ä¸Šé¢çš„æ­¥éª¤ï¼Œæˆ‘ä»¬è¯†åˆ«å‡ºæ¥äº†å„ç§æ¨¡å—ï¼Œæ¥ç€æˆ‘ä»¬è¦ç¡®å®šä¸‹æ¥è¿™äº›æ¨¡å—ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œè¿™äº›ä¾èµ–å…³ç³»å½±å“å®ƒä»¬æ˜¯å¦è¦ä½œä¸ºä¸€ä¸ªæ•´ä½“è¿›è¡Œå®ç°ã€‚æœ€åå†æ ¹æ®ä¸šåŠ¡çš„ä¼˜å…ˆçº§æˆ–ä¾èµ–å…³ç³»å†³å®šè¿™äº›<strong>æ¨¡å—ç°‡</strong>çš„å®ç°ä¼˜å…ˆçº§ã€‚</p><p>Ok, ç°åœ¨å¯ä»¥å°†è¿™äº›æ¨¡å—ç°‡æŒ‰ç…§ä¼˜å…ˆçº§æ’åº, åŠ ä¸Šè¯„ä¼°æ—¶é—´(äººå¤©)ï¼Œæ•´ç†æˆä¸€ä¸ªæ¸…å•ã€‚ å¦‚æœä½ ä»¬ä½¿ç”¨çœ‹æ¿æ¥è¿›è¡Œé¡¹ç›®ç®¡ç†, å¯ä»¥å°†å®ƒä»¬ä½œä¸ºä¸€ä¸ªä»»åŠ¡å•å…ƒï¼Œè´´åˆ°çœ‹æ¿ä¸­.</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">1. Foo åŠŸèƒ½</span><br><span class="line">  - c 2d</span><br><span class="line">  - d 1d</span><br><span class="line">  - f 3d</span><br><span class="line">2. Bar åŠŸèƒ½</span><br><span class="line">  - e 1d</span><br><span class="line">  - h 0.5d</span><br><span class="line">3. Baz åŠŸèƒ½</span><br><span class="line">  - g 1d</span><br><span class="line">4. Fu åŠŸèƒ½</span><br><span class="line">  - a 4d</span><br><span class="line">  - b 1d</span><br><span class="line"></span><br><span class="line">æ€»è®¡äººå¤©: 13.5</span><br></pre></td></tr></table></figure><p><br></p><p>ä»»åŠ¡çš„åˆ†å·¥æœ‰å¾ˆå¤šç­–ç•¥, ä¾‹å¦‚ï¼š</p><ul><li>æ¨ªå‘åˆ’åˆ†<ul><li>å…¬å…±ç»„ä»¶ vs ä¸šåŠ¡ç»„ä»¶(å¯¹æ¥ä¸šåŠ¡)</li><li>è‡ªä¸Šè€Œä¸‹ vs è‡ªä¸‹è€Œä¸Š(æŒ‡çš„æ˜¯ç»„ä»¶æ ‘)</li></ul></li><li>å‚ç›´åˆ’åˆ†: æŒ‰ç…§ç‹¬ç«‹çš„å‚ç›´æ¨¡å—åˆ†å·¥</li></ul><p><img src="/images/fe-design/module-tree.png" alt></p><p><br><br><br></p><h2 id="çŠ¶æ€è®¾è®¡"><a href="#çŠ¶æ€è®¾è®¡" class="headerlink" title="çŠ¶æ€è®¾è®¡"></a>çŠ¶æ€è®¾è®¡</h2><p><img src="/images/fe-design/redux.png" alt></p><p>å‰ç«¯ç»„ä»¶åŒ–ä¼´éšè€Œæ¥çš„æ˜¯å„ç§<code>æ•°æ®é©±åŠ¨</code>æˆ–<code>æ•°æ®æµé©±åŠ¨</code>çš„å¼€å‘æ¨¡å¼ã€‚è¿™ç§æ¨¡å¼ä¸‹ï¼Œå‰ç«¯åº”ç”¨å¯ä»¥æ€»ç»“ä¸ºè¿™æ ·ä¸€ä¸ªç­‰å¼:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">view = f(state)</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´<strong>è§†å›¾æ˜¯æ•°æ®æˆ–è€…æ•°æ®æµçš„æ˜ å°„</strong>. å¯è§çŠ¶æ€ç®¡ç†å¯¹ç°ä»£å‰ç«¯å¼€å‘çš„é‡è¦æ€§ã€‚</p><p>çŠ¶æ€çš„è®¾è®¡å’Œåç«¯å¯¹è±¡æ¨¡å‹è®¾è®¡å·®ä¸å¤šã€‚<strong>ä½ éœ€è¦æ ¹æ®ä¸šåŠ¡å’Œé¡µé¢æ¸²æŸ“è¦æ±‚æŠ½è±¡å‡ºå„ç§å¯¹è±¡æ¨¡å‹ï¼Œä»¥åŠç¼•æ¸…å¯¹è±¡æ¨¡å‹ä¹‹é—´çš„å…³ç³»</strong>ã€‚è¿™ä¸ªé˜¶æ®µå¯èƒ½éœ€è¦å’Œåç«¯ç´§å¯†ç»“åˆï¼Œæ‰èƒ½ç¡®å®šå‡ºåˆç†çš„å¯¹è±¡ç»“æ„ã€‚</p><p>å½“ç„¶çŠ¶æ€çš„è®¾è®¡è¿˜è·Ÿä½ é€‰æ‹©çš„çŠ¶æ€ç®¡ç†æ–¹æ¡ˆä¹Ÿæœ‰å…³ç³», ä¸åŒçŠ¶æ€ç®¡ç†å™¨æ–¹æ¡ˆä½“ç°çš„æ€æƒ³å·®å¼‚è¾ƒå¤§ï¼š<em>å¦‚æœä½ é€‰æ‹©Reduxï¼Œé‚£ä¹ˆåº”ç”¨çš„çŠ¶æ€å°±æ˜¯ä¸€é¢—å¯¹è±¡æ ‘ï¼›å¦‚æœä½ é€‰æ‹©Mobxï¼Œåº”ç”¨çš„çŠ¶æ€å¯èƒ½ç”±å¤šä¸ªæ¨¡å‹å¯¹è±¡ç»„æˆï¼Œæ›´æ¥è¿‘ä¼ ç»Ÿçš„OOPæ¨¡å¼</em>ã€‚</p><p>å¦‚æœé‡‡ç”¨OOPè®¾è®¡æ–¹æ³•ï¼Œå¯ä»¥ç»˜åˆ¶<code>UML</code>å›¾ï¼Œå¯è§†åŒ–è¡¨ç°å¯¹è±¡çš„ç»“æ„å’Œå…³ç³»:</p><p><img src="/images/fe-design/uml-sample.png" alt><br><i>(å›¾ç‰‡æ¥æº: <a href="https://zongren.me/2016/12/30/uml-diagram-sample/" target="_blank" rel="noopener">https://zongren.me/2016/12/30/uml-diagram-sample/</a>)</i></p><p><br></p><p>æˆ‘åœ¨<a href="https://juejin.im/post/5ce3ee436fb9a07f070e0220" target="_blank" rel="noopener">Reactç»„ä»¶è®¾è®¡å®è·µæ€»ç»“05 - çŠ¶æ€ç®¡ç†</a>è¿™ç¯‡æ–‡ç« èŠ±äº†å¾ˆå¤šç¯‡å¹…æ¥ä»‹ç»å„ç§çŠ¶æ€ç®¡ç†å™¨çš„æ€æƒ³å’Œå¼€å‘æ¨¡å¼, æ‰€ä»¥è¿™é‡Œå°±ä¸å±•å¼€äº†:</p><p><strong>Redux çŠ¶æ€è®¾è®¡</strong>:</p><p><img src="/images/fe-design/redux-design.png" alt></p><p><strong>Mobx çŠ¶æ€è®¾è®¡</strong>:</p><p><img src="/images/fe-design/mobx-design.png" alt></p><p><br><br><br></p><h2 id="æ¥å£è®¾è®¡"><a href="#æ¥å£è®¾è®¡" class="headerlink" title="æ¥å£è®¾è®¡"></a>æ¥å£è®¾è®¡</h2><p>å¦‚æœå‰ç«¯å›¢é˜Ÿåœ¨æ¥å£è®¾è®¡æ–¹é¢æœ‰ä¸»å¯¼æƒ, æˆ–è€…ä½¿ç”¨<a href="https://www.phodal.com/blog/architecture-101-bff-for-legacy-system-migrate/" target="_blank" rel="noopener">BFFæ¶æ„(æœåŠ¡äºå‰ç«¯çš„åç«¯)</a>ï¼Œåœ¨è®¾è®¡é˜¶æ®µæˆ‘ä»¬éœ€è¦å¯¹å„ç±»æ¥å£è¿›è¡Œè®¾è®¡ã€‚</p><p>ä¸è¿‡ä¸€èˆ¬ä¸»å¯¼æƒéƒ½æŒæ¡åœ¨åç«¯æ‰‹é‡Œï¼Œå› ä¸ºå‰ç«¯å¯¹ä¸šåŠ¡çš„å…³å¿ƒç¨‹åº¦è¾ƒä½ï¼Œåç«¯ä¸€èˆ¬ä¼šç»¼åˆè€ƒè™‘å„ç«¯çš„æ¥å£éœ€æ±‚ã€æ•°æ®åº“å­˜å‚¨æ•ˆç‡ã€å¯ç»´æŠ¤æ€§ç­‰å¤šä¸ªæ–¹é¢æ¥è®¾è®¡æ¥å£, è¿™æ—¶å€™å‰ç«¯å°±æ˜¯æ¥å£çš„ç”¨æˆ·ï¼Œæˆ‘ä»¬æœ‰è´£ä»»æ¥éªŒè¯åç«¯æ¥å£æ˜¯å¦ç¬¦åˆéœ€æ±‚.</p><p>æˆ‘åœ¨<a href="https://juejin.im/post/5d3a7134f265da1b5d57f1ed#heading-45" target="_blank" rel="noopener">if æˆ‘æ˜¯å‰ç«¯å›¢é˜Ÿ Leaderï¼Œæ€ä¹ˆåˆ¶å®šå‰ç«¯åä½œè§„èŒƒ?</a>å·²ç»æåŠäº†å„ç§æ¥å£è§„èŒƒ. è¿™é‡Œä¸äºˆèµ˜è¿°ã€‚</p><p><br><br><br></p><h2 id="ç‰ˆæœ¬è§„åˆ’"><a href="#ç‰ˆæœ¬è§„åˆ’" class="headerlink" title="ç‰ˆæœ¬è§„åˆ’"></a>ç‰ˆæœ¬è§„åˆ’</h2><p>é€šè¿‡ä¸Šé¢çš„æ­¥éª¤ï¼Œæˆ‘ä»¬åŸºæœ¬å·²ç»äº†è§£æˆ‘ä»¬éœ€è¦åšä»€ä¹ˆã€éœ€è¦èŠ±å¤šä¹…ã€‚æ¥ä¸‹æ¥ï¼Œ</p><p>åº”è¯¥åˆ¶å®šä¸€ä¸ªç‰ˆæœ¬è®¡åˆ’ï¼Œå¯¹äºä¸€ä¸ªå¤§é¡¹ç›®å¯ä»¥æ‹†åˆ†ä¸ºå¤šä¸ª<strong>é‡Œç¨‹ç¢‘</strong>, ä¼°è®¡ç‰ˆæœ¬å‘å¸ƒçš„æ—¶é—´. åŠ ä¸åŠ ç­å°±çœ‹ä½ äº†ï¼Œä½œä¸ºLeaderè¦ç»¼åˆè€ƒè™‘å„ç§å½±å“å› ç´ ï¼Œå®äº‹æ±‚æ˜¯åˆç†åœ°å®‰æ’ç‰ˆæœ¬å‘å¸ƒè®¡åˆ’ã€‚</p><p>è¿™ä¸ªå‘å¸ƒè®¡åˆ’å¯èƒ½è¿˜éœ€è¦ç»è¿‡PMå’Œé¡¹ç›®ç»ç†å®¡æ ¸, ä½œä¸ºå‰ç«¯é¡¹ç›®ï¼Œå¼€å‘è®¡åˆ’é€šå¸¸è¿˜ä¾èµ–äºåç«¯å›¢é˜Ÿ.</p><p><img src="/images/fe-design/roadmap.png" alt></p><p><br></p><p>è¿™ä¸ªç‰ˆæœ¬è®¡åˆ’ä¸­ä¼šåŒ…å«è¿™äº›å†…å®¹:</p><ul><li>ç‰ˆæœ¬å·</li><li>å‘å¸ƒæ—¶é—´</li><li>åŒ…å«çš„ä¸»è¦æ¨¡å—</li></ul><p><br><br><br></p><h2 id="éªŒè¯"><a href="#éªŒè¯" class="headerlink" title="éªŒè¯"></a>éªŒè¯</h2><p>éªŒè¯ï¼Œæˆ–è€…ç§°ä¸ºâ€™æµ‹è¯•æŒ‡å¯¼â€˜ã€‚ é™¤äº†æµ‹è¯•å›¢é˜Ÿæä¾›çš„æµ‹è¯•ç”¨ä¾‹ï¼Œä»å¼€å‘(ç™½ç›’)çš„è§’åº¦è¿˜éœ€è¦æ³¨æ„å“ªäº›ä¸œè¥¿?</p><p>äº§å“æˆ–è€…æµ‹è¯•å¯èƒ½åªä¼šä»ä¸šåŠ¡çš„å±‚æ¬¡è€ƒè™‘åº”ç”¨çš„è¿è¡Œï¼Œæˆ‘ä»¬éœ€è¦ä»ç ”å‘çš„è§’åº¦ï¼Œå……åˆ†è€ƒè™‘å„ç§<strong>å¼‚å¸¸æƒ…å†µ</strong>ã€<strong>æ€§èƒ½ç“¶é¢ˆ</strong>ã€è¿›è¡Œ<strong>é£é™©è¯„ä¼°</strong>. é˜æ˜é£é™©çš„åº”å¯¹æ–¹æ¡ˆç­‰å¾….</p><p>è¿™äº›æƒ…å†µä¹Ÿå¯ä»¥åé¦ˆç»™æµ‹è¯•å›¢é˜Ÿï¼Œä»¥å®Œå–„æµ‹è¯•çš„ç”¨ä¾‹.</p><p><br></p><h2 id="é¡¹ç›®è¦æ±‚å’Œç›®æ ‡"><a href="#é¡¹ç›®è¦æ±‚å’Œç›®æ ‡" class="headerlink" title="é¡¹ç›®è¦æ±‚å’Œç›®æ ‡"></a>é¡¹ç›®è¦æ±‚å’Œç›®æ ‡</h2><p>ä¸€äº›éœ€æ±‚æ˜¯è¦æå‰ç¡®å®šä¸‹æ¥çš„ï¼Œå¯¹äºå‰ç«¯æ¥è¯´ï¼Œæ¯”è¾ƒå…¸å‹çš„å°±æ˜¯æµè§ˆå™¨å…¼å®¹æ€§è¦æ±‚ã€‚ä½ å¯ä¸è¦ç­‰åˆ°é¡¹ç›®ä¸Šçº¿åï¼Œæ‰è·Ÿæˆ‘æç”¨æˆ·è¦æ±‚å…¼å®¹IE6!</p><p>è¿™äº›é¡¹ç›®è¦æ±‚å¯èƒ½ä¼šå½±å“æˆ‘ä»¬çš„å¼€å‘æˆæœ¬ã€é€‰å‹ã€æµ‹è¯•å’Œå…¶ä»–å› ç´ çš„è¯„ä¼°ã€‚åŸºæœ¬ä¸Šï¼Œå¯¹äºä¸€ä¸ªå‰ç«¯é¡¹ç›®æ¥è¯´ï¼Œè¿™äº›è¦æ±‚æ˜¯è¦æå‰é—®æ¸…æ¥šçš„:</p><ul><li>æµè§ˆå™¨å…¼å®¹æ€§</li><li>è¿è¡Œç¯å¢ƒ. ä¾‹å¦‚æ“ä½œç³»ç»Ÿã€å°ç¨‹åºç­‰ç­‰</li><li>æ—¶é—´ç‚¹</li><li>æ€§èƒ½æŒ‡æ ‡è¦æ±‚. ä¾‹å¦‚é¦–å±æŒ‡æ ‡ã€æ•°æ®é‡æŒ‡æ ‡</li></ul><p><br><br><br></p><h2 id="æ–‡æ¡£ç´¢å¼•"><a href="#æ–‡æ¡£ç´¢å¼•" class="headerlink" title="æ–‡æ¡£ç´¢å¼•"></a>æ–‡æ¡£ç´¢å¼•</h2><p>å‰ç«¯é¡¹ç›®å¼€å‘å¯èƒ½ä¼šå…³è”å¾ˆå¤šæ–‡æ¡£ï¼Œè¿™äº›æ–‡æ¡£æ˜¯åˆ†æ•£çš„ï¼Œåœ¨è®¾è®¡æ–‡æ¡£ä¸­æœ€å¥½æŠŠå®ƒä»¬èšåˆèµ·æ¥ï¼Œæ–¹ä¾¿æŸ¥é˜…å’Œå¼•ç”¨. ä¾‹å¦‚:</p><ul><li>éœ€æ±‚æ–‡æ¡£</li><li>DEMO, UIè®¾è®¡ç¨¿</li><li>æµ‹è¯•ç”¨ä¾‹</li><li>æ¥å£æ–‡æ¡£</li><li>UIè®¾è®¡è§„èŒƒæ–‡æ¡£</li><li>å‰ç«¯è§„èŒƒæ–‡æ¡£</li><li>â€¦</li></ul><p><br><br><br></p><h2 id="æ„å»ºè¯´æ˜"><a href="#æ„å»ºè¯´æ˜" class="headerlink" title="æ„å»ºè¯´æ˜"></a>æ„å»ºè¯´æ˜</h2><p>å¦‚æœä½ çš„é¡¹ç›®éœ€è¦è®¾è®¡æ„å»ºæµç¨‹ï¼Œä¹Ÿå¯ä»¥åœ¨è®¾è®¡æ–‡æ¡£ä¸­ç®€å•æåŠã€‚</p><p>ä¾‹å¦‚<strong>å¦‚ä½•ç¼–è¯‘å’Œè¿è¡Œ</strong>? <strong>å¦‚ä½•æµ‹è¯•å’Œè°ƒè¯•</strong>? <strong>å¦‚ä½•éƒ¨ç½²æˆ–å‘å¸ƒ</strong>ï¼Ÿ <strong>ä»£ç å¦‚ä½•ç»„ç»‡</strong>ï¼Ÿ<strong>å¼€å‘å·¥ä½œæµ</strong>ã€<strong>ç¼–ç çº¦å®š</strong>ç­‰ç­‰</p><p>æ–°æˆå‘˜é€šè¿‡è¿™äº›è¯´æ˜å¯ä»¥å¿«é€Ÿä¸Šæ‰‹å¼€å‘.</p><p><br></p><h2 id="æŒç»­è¿­ä»£"><a href="#æŒç»­è¿­ä»£" class="headerlink" title="æŒç»­è¿­ä»£"></a>æŒç»­è¿­ä»£</h2><p>è®¾è®¡æ–‡æ¡£ä¸æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œå®ƒåº”è¯¥è·Ÿéšé¡¹ç›®ä¸æ–­çš„è¿­ä»£ï¼Œä¸ç„¶å°±å¤±å»äº†æ–‡æ¡£çš„æ„ä¹‰ã€‚</p><p><br><br><br></p><h2 id="æ¨¡æ¿"><a href="#æ¨¡æ¿" class="headerlink" title="æ¨¡æ¿"></a>æ¨¡æ¿</h2><p>æœ€åï¼Œè§„èŒƒä¸€äº›è®¾è®¡æ–‡æ¡£çš„æ ¼å¼å’Œå†…å®¹</p><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="section"># XXX æ¦‚è¦è®¾è®¡æ–‡æ¡£</span></span><br><span class="line"></span><br><span class="line"><span class="section">## èƒŒæ™¯</span></span><br><span class="line"></span><br><span class="line">å¡«å†™é¡¹ç›®çš„èƒŒæ™¯, æˆ–è€…å¼€å‘æˆ–é‡æ„çš„ç›®çš„/å‡ºå‘ç‚¹.</span><br><span class="line"></span><br><span class="line"><span class="section">## å…³é”®ä¸šåŠ¡æµç¨‹</span></span><br><span class="line"></span><br><span class="line">å¯ä»¥æ”¾ç½®å…³é”®çš„ä¸šåŠ¡æµç¨‹å›¾ã€çŠ¶æ€å›¾ã€å¯¹è±¡å›¾ç­‰ç­‰. æ¢³ç†å…³é”®çš„ä¸šåŠ¡æµç¨‹</span><br><span class="line"></span><br><span class="line"><span class="section">## å…³é”®æŠ€æœ¯æè¿°</span></span><br><span class="line"></span><br><span class="line">å¯é€‰, æè¿°é¡¹ç›®ä¸­ä½¿ç”¨åˆ°çš„å…³é”®æŠ€æœ¯ã€ç®—æ³•ã€é€‰å‹ç»“è®ºç­‰ç­‰</span><br><span class="line"></span><br><span class="line"><span class="section">## æ¨¡å—æ‹†åˆ†</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>å…¥å£</span><br><span class="line"><span class="bullet">- </span>é¡µé¢è·¯ç”±</span><br><span class="line"><span class="bullet">- </span>ç»„ä»¶è®¾è®¡</span><br><span class="line"></span><br><span class="line">å¯ä»¥ä½¿ç”¨æ€ç»´å¯¼å›¾æè¿°</span><br><span class="line"></span><br><span class="line"><span class="section">## çŠ¶æ€è®¾è®¡</span></span><br><span class="line"></span><br><span class="line">æè¿°åº”ç”¨æ¶‰åŠçš„å…³é”®é¢†åŸŸå¯¹è±¡, æ¯”å¦‚å¤–å½¢ã€è¡Œä¸ºå’Œå…³ç³». å¦‚æœæ˜¯OOPæ–¹å¼ï¼Œå¯ä»¥ä½¿ç”¨UMLæè¿°</span><br><span class="line"></span><br><span class="line"><span class="section">## æ¥å£è®¾è®¡</span></span><br><span class="line"></span><br><span class="line">å¯é€‰ï¼Œå¦‚é¢˜</span><br><span class="line"></span><br><span class="line"><span class="section">## é¡¹ç›®è¦æ±‚å’Œç›®æ ‡</span></span><br><span class="line"></span><br><span class="line">é¡¹ç›®ç›®æ ‡ã€è¿è¡Œç¯å¢ƒã€å…¼å®¹æ€§è¦æ±‚ã€æ€§èƒ½æŒ‡æ ‡ç­‰ç­‰</span><br><span class="line"></span><br><span class="line"><span class="section">## éªŒè¯</span></span><br><span class="line"></span><br><span class="line">å¯é€‰, é£é™©è¯„ä¼°ã€å¼‚å¸¸æƒ…å†µè€ƒè™‘ã€ç‰¹æ®Šæµ‹è¯•è§„åˆ™ã€æµ‹è¯•æŒ‡å¯¼ç­‰ç­‰</span><br><span class="line"></span><br><span class="line"><span class="section">## åˆ†å·¥å’Œç‰ˆæœ¬è®¡åˆ’</span></span><br><span class="line"></span><br><span class="line">å¯é€‰, å¯ä»¥åœ¨å•ç‹¬æ–‡æ¡£æˆ–è€…çœ‹æ¿ä¸­ç»´æŠ¤</span><br><span class="line"></span><br><span class="line"><span class="section">## æ„å»ºè¯´æ˜</span></span><br><span class="line"></span><br><span class="line">å¯é€‰, é¡¹ç›®ç»„ç»‡ã€æ„å»ºã€æµ‹è¯•è¯´æ˜</span><br><span class="line"></span><br><span class="line"><span class="section">## æ–‡æ¡£ç´¢å¼•</span></span><br><span class="line"></span><br><span class="line">ç›¸å…³æ–‡æ¡£çš„ç´¢å¼•å’Œé“¾æ¥</span><br><span class="line"></span><br><span class="line"><span class="section">## å‚è€ƒèµ„æ–™</span></span><br><span class="line"></span><br><span class="line">æ–‡æ¡£ä¸­ç´¢å¼•é¡µçš„å¤–éƒ¨å‚è€ƒèµ„æ–™</span><br><span class="line"></span><br><span class="line"><span class="section">## CHANGELOG</span></span><br><span class="line"></span><br><span class="line">åˆ—å‡ºæœ¬æ–‡æ¡£ä¿®æ”¹çš„å†å²çºªå½•ã€‚å¿…é¡»æŒ‡æ˜ä¿®æ”¹çš„å†…å®¹ã€æ—¥æœŸä»¥åŠä¿®æ”¹äºº</span><br></pre></td></tr></table></figure><p>å¾ˆå¤šå¼€å‘äººå‘˜éƒ½ä¸å–œæ¬¢å†™æ–‡æ¡£ï¼ŒåŒ…æ‹¬æˆ‘ä»¥å‰ä¹Ÿæ˜¯è¿™æ ·çš„ã€‚æˆ‘ä»¬ä¼šæ‰¾å„ç§å€Ÿå£ï¼šâ€™æ—¶é—´ç´§å¼ ï¼Œæ²¡æ—¶é—´åšè®¾è®¡â€˜ã€â€™ç”¨æ¥å†™è®¾è®¡æ–‡æ¡£çš„æ—¶é—´ï¼Œæˆ‘çš„å¼€å‘æ—©å°±åšå®Œäº†â€˜ã€‚</p><p>è¿™äº›æƒ³æ³•æ˜¾ç„¶æ˜¯ä¸æ­£ç¡®çš„ï¼Œç»™æˆ‘çš„å¯ç¤ºæ˜¯<strong>æˆ‘ä»¬è¦æ ¹æ®å›¢é˜Ÿæƒ…å†µè€Œå®šï¼Œä¸è¦æ±‚è®¾è®¡æ–‡æ¡£æœ‰å¤šä¹ˆè¯¦å°½ï¼Œåœ¨æ—¶é—´ç´§å¼ çš„æ—¶å€™å¯ä»¥ç²—ç•¥ä¸€ç‚¹ã€‚ç­‰æ—¶é—´å……è£•å†å›é¡¾è¡¥å……ä¹Ÿæ˜¯å¯ä»¥æ¥å—çš„; æˆ–è€…å¦‚æœé¡¹ç›®åˆ’åˆ†ä¸ºå¤šä¸ªå‘¨æœŸè¿›è¡Œå¼€å‘ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨æ¯ä¸ªå‘¨æœŸå¼€å§‹æ—¶è¿›è¡Œè¯¦ç»†çš„è®¾è®¡</strong>ã€‚</p><p><br></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æ–‡ç« å·®ä¸å¤šå†™å®Œäº†ï¼Œçœ‹åˆ°äº†çŸ¥ä¹<a href="https://www.zhihu.com/people/zhang-ming-yun-88/activities" target="_blank" rel="noopener">@å¼ æ˜äº‘</a><a href="https://www.zhihu.com/question/300407894" target="_blank" rel="noopener">ç°ä»£è½¯ä»¶å¼€å‘ä¸­ï¼Œè¯¦ç»†è®¾è®¡è¿™ä¸€æ­¥è¦å¦‚ä½•æ¥åšï¼Ÿ</a>ä¸‹é¢çš„ä¸€ä¸ªå›ç­”:</p><p><br></p><p><img src="/images/fe-design/zhihu.png" alt></p><p><br></p><p>å’Œæˆ‘ä¸Šæ–‡æ‰€ä»‹ç»åŸºæœ¬å»åˆã€‚ä¸€ä¸ªè½¯ä»¶â€™æ¦‚è¦â€˜è®¾è®¡æ–‡æ¡£åŸºæœ¬å°±åŒ…å«è¿™å‡ å¤§å—ã€‚</p><p>æœ¬æ–‡å®Œã€‚</p><p><br></p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li><a href="https://www.infoq.cn/article/how-to-write-a-good-software-design-document" target="_blank" rel="noopener">å¦‚ä½•æ‰èƒ½å†™å‡ºå¥½çš„è½¯ä»¶è®¾è®¡æ–‡æ¡£ï¼Ÿ</a></li><li><a href="https://blog.csdn.net/lori2004/article/details/80011806" target="_blank" rel="noopener">è½¯ä»¶è®¾è®¡æ–‡æ¡£ç¼–å†™æ¦‚è¿°</a></li><li><a href="https://www.zhihu.com/question/300407894" target="_blank" rel="noopener">ç°ä»£è½¯ä»¶å¼€å‘ä¸­ï¼Œè¯¦ç»†è®¾è®¡è¿™ä¸€æ­¥è¦å¦‚ä½•æ¥åšï¼Ÿ</a></li></ul><p><br></p><p><img src="/images/sponsor.jpg" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;a href=&quot;https://juejin.im/post/5d3a7134f265da1b5d57f1ed&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;if æˆ‘æ˜¯å‰ç«¯å›¢é˜Ÿ Leaderï¼Œæ€ä¹ˆåˆ¶å®šå‰ç«¯åä½œè§„èŒƒ?&lt;/a&gt;åœ¨æ˜é‡‘ç›®å‰å·²ç»çªç ´740ä¸ªğŸ‘äº†
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://bobi.ink/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>æµè§ˆå™¨å’ŒNodeä¸­çš„JavaScriptæ˜¯å¦‚ä½•å·¥ä½œçš„? å¯è§†åŒ–è§£é‡Š</title>
    <link href="https://bobi.ink/2019/08/29/js-bs/"/>
    <id>https://bobi.ink/2019/08/29/js-bs/</id>
    <published>2019-08-28T16:00:00.000Z</published>
    <updated>2019-08-30T15:12:30.729Z</updated>
    
    <content type="html"><![CDATA[<p>åŸæ–‡åœ°å€: <a href="https://itnext.io/how-javascript-works-in-browser-and-node-ab7d0d09ac2f" target="_blank" rel="noopener">How JavaScript works in browser and node?</a></p><p>æœ‰éå¸¸å¤šæ»¡æ€€æ¿€æƒ…çš„å¼€å‘è€…ï¼Œä»–ä»¬æå‰ç«¯æˆ–è€…æåç«¯ï¼Œä¸ºJavaScriptå¥‰çŒ®è‡ªå·±é’æ˜¥å’Œè¡€æ±—ã€‚JavaScriptæ˜¯ä¸€ç§éå¸¸å®¹æ˜“ç†è§£è¯­è¨€ï¼Œæ¯«æ— ç–‘é—®å®ƒæ˜¯å‰ç«¯å¼€å‘ä¸­ä¸€ä¸ªéå¸¸å…³é”®çš„éƒ¨åˆ†ã€‚ä½†æ˜¯å’Œå…¶ä»–è¯­è¨€ä¸åŒçš„æ˜¯ï¼Œ å®ƒæ˜¯å•çº¿ç¨‹çš„ï¼Œè¿™å°±æ„å‘³ç€ï¼ŒåŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªä»£ç ç‰‡æ®µåœ¨æ‰§è¡Œã€‚å› ä¸ºä»£ç æ‰§è¡Œæ˜¯çº¿æ€§çš„ï¼Œå¦‚æœå½“ä¸­æœ‰ä»»ä½•ä»£ç æ‰§è¡Œå¾ˆé•¿æ—¶é—´ï¼Œå°†ä¼šé˜»å¡åé¢éœ€è¦è¢«æ‰§è¡Œçš„ä»£ç ã€‚å› æ­¤æœ‰æ—¶å€™ä½ ä¼šåœ¨Google Chromeä¸­çœ‹åˆ°è¿™æ ·çš„ç•Œé¢:</p><p><br></p><p><img src="/images/js-bs/crashed.png" alt></p><p><br></p><p>å½“ä½ åœ¨æµè§ˆå™¨æ‰“å¼€ä¸€ä¸ªç½‘ç«™æ—¶ï¼Œå®ƒä¼šä½¿ç”¨ä¸€ä¸ªJavaScriptæ‰§è¡Œçº¿ç¨‹ã€‚è¿™ä¸ªçº¿ç¨‹è´Ÿè´£å“åº”ä¸€åˆ‡æ“ä½œï¼Œæ¯”å¦‚é¡µé¢æ»šåŠ¨ã€é¡µé¢æ¸²æŸ“ã€ç›‘å¬DOMäº‹ä»¶(æ¯”å¦‚ç”¨æˆ·ç‚¹å‡»æŒ‰é’®)ç­‰ç­‰ã€‚ä½†æ˜¯å¦‚æœJavaScriptæ‰§è¡Œè¢«é˜»å¡äº†ï¼Œé‚£æµè§ˆå™¨å°±ä»€ä¹ˆäº‹æƒ…ä¹Ÿåšä¸äº†ï¼Œå³æ„å‘³ç€æµè§ˆå™¨ä¼šå‘ˆç°ä¸ºå¡æ­»ï¼Œæ— æ³•å“åº”çš„ç°è±¡ã€‚</p><p>ä¸ä¿¡ä½ å°±åœ¨æ§åˆ¶å°è¾“å…¥è¯•è¯•:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span>(<span class="literal">true</span>)&#123;&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>ä½ ä¼šä¸Šé¢è¯­å¥ä¹‹åçš„ä»»ä½•ä»£ç éƒ½ä¸ä¼šè¢«æ‰§è¡Œï¼Œè¿™ä¸ªâ€˜æ­»å¾ªç¯â€™ä¼šéœ¸å ç€ç³»ç»Ÿèµ„æº, è®©æµè§ˆå™¨æ— æ³•å“åº”ç”¨æˆ·æ“ä½œ. æ— é™é€’å½’è°ƒç”¨ä¹Ÿä¼šå‡ºç°è¿™ç§æƒ…å†µ, ä¸è¿‡ä¸‹æ–‡ä¼šä»‹ç»ï¼ŒJavascriptå¼•æ“å¯¹è°ƒç”¨æ ˆé•¿åº¦è¿›è¡Œé™åˆ¶ï¼Œæ— é™é€’å½’ä¼šæŠ›å‡ºRangeErrorå¼‚å¸¸, è€Œä¸ä¼šæ— ä¼‘æ­¢åœ°è¿è¡Œã€‚</p><p><br></p><p><img src="/images/js-bs/crashed2.png" alt></p><p><br></p><p>æ„Ÿè°¢ç°ä»£æµè§ˆå™¨ï¼Œç°åœ¨ä¸æ˜¯æ‰€æœ‰æ‰“å¼€çš„æ ‡ç­¾é¡µéƒ½ä¾èµ–äºä¸€ä¸ªJavaScriptçº¿ç¨‹ã€‚è€Œæ˜¯æ¯ä¸ªæ ‡ç­¾é¡µæˆ–è€…åŸŸåéƒ½ä¼šæœ‰ç‹¬ç«‹çš„JavaScriptçº¿ç¨‹ã€‚è¿™æ ·æ¯ä¸ªæ ‡ç­¾é¡µä¹‹é—´ä¸ä¼šäº’ç›¸é˜»å¡ã€‚æ¯”å¦‚ä½ å¯ä»¥åœ¨Chromeä¸­æ‰“å¼€å¤šä¸ªæ ‡ç­¾é¡µï¼Œåœ¨æŸä¸ªæ ‡ç­¾é¡µä¸‹æ‰§è¡Œä¸Šé¢çš„æ­»å¾ªç¯ï¼Œä½ ä¼šå‘ç°åªæœ‰æ‰§è¡Œäº†ä¸Šé¢è¯­å¥çš„æ ‡ç­¾å¡æ­»ï¼Œå…¶ä»–ä¸å—å½±å“ã€‚</p><p><br><br><br></p><h2 id="è°ƒç”¨æ ˆ-call-stack"><a href="#è°ƒç”¨æ ˆ-call-stack" class="headerlink" title="è°ƒç”¨æ ˆ(Call Stack)"></a>è°ƒç”¨æ ˆ(Call Stack)</h2><p>ä¸ºäº†å¯è§†åŒ–JavaScript å¦‚ä½•æ‰§è¡Œç¨‹åºï¼Œæˆ‘ä»¬é¦–å…ˆè¦ç†è§£JavaScriptè¿è¡Œæ—¶ã€‚</p><p><img src="/images/js-bs/vis1.png" alt></p><p><br></p><p>å’Œå…¶ä»–ç¼–ç¨‹è¯­è¨€ä¸€æ ·ï¼ŒJavaScriptè¿è¡Œæ—¶æœ‰ä¸€ä¸ªæ ˆ(Stack)å’Œä¸€ä¸ªå †(Heap)å­˜å‚¨å™¨ã€‚</p><p><img src="/images/js-bs/stack-vs-heap.jpg" alt></p><p>ä¸Šå›¾æ¥æºäº<a href="Confused about Stack and Heap?">Fhinkel</a>æ–‡ç« ï¼Œå…³äºæ ˆå’Œå †ä¹‹é—´çš„å·®å¼‚è®²å¾—æ¯”è¾ƒæ¸…æ™°. ä¸¾ä¸ªä¾‹å­:</p><p><em>åœ¨Javaæˆ–è€…C#ä¸­ï¼Œ å€¼ç±»å‹(primitivesåŸå§‹ç±»å‹)å­˜å‚¨åœ¨æ ˆä¸­ï¼Œè€Œå¼•ç”¨ç±»å‹(reference)åˆ™å­˜å‚¨åœ¨å †ä¸­ã€‚C++è§„èŒƒæ²¡æœ‰è§„å®šæ ˆå’Œå †çš„å†…å­˜åˆ†é…ï¼Œè€Œæ˜¯ä½¿ç”¨<code>è‡ªåŠ¨å­˜å‚¨(automatic)æœŸ</code>å’Œ<code>åŠ¨æ€å­˜å‚¨(dynamic)æœŸ</code>æ¥ä½œåŒºåˆ†ï¼Œå±€éƒ¨å˜é‡æ˜¯è‡ªåŠ¨å­˜å‚¨æœŸï¼Œç¼–è¯‘å™¨ä¼šå°†å®ƒä»¬å­˜å‚¨åœ¨æ ˆä¸­ã€‚è€ŒåŠ¨æ€åˆ†é…çš„å¯¹è±¡åˆ™é€šå¸¸ä¿å­˜åœ¨å †ä¸­ã€‚æ”¾åœ¨æ ˆä¸­çš„æ•°æ®ä¼šåœ¨å‡½æ•°æ‰§è¡Œå®Œæ¯•åè‡ªåŠ¨å›æ”¶ï¼Œè€Œæ”¾åœ¨å †ä¸­çš„å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰é‡Šæ”¾å°±ä¼šé€ æˆ<strong>å†…å­˜æ³„éœ²</strong></em></p><p><br></p><p>æœ¬æ–‡ä¸ä¼šæ·±å…¥è§£é‡ŠHeapï¼Œä½ å¯ä»¥çœ‹<a href="https://hashnode.com/post/does-javascript-use-stack-or-heap-for-memory-allocation-or-both-cj5jl90xl01nh1twuv8ug0bjk" target="_blank" rel="noopener">è¿™é‡Œ</a>. åœ¨æœ¬æ–‡æˆ‘ä»¬æ„Ÿå…´è¶£çš„æ˜¯æ ˆï¼Œ<strong>æ ˆæ˜¯ä¸€ä¸ªLIFO(åè¿›å…ˆå‡º)çš„æ•°æ®ç»“æ„ï¼Œç”¨æ¥ä¿å­˜ç¨‹åºå½“å‰çš„å‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡, æ¢å¥è¯è¯´ï¼Œå®ƒè¡¨ç¤ºçš„æ˜¯å½“å‰ç¨‹åºæ‰§è¡Œçš„ä½ç½®. æ¯æ¬¡å¼€å§‹æ‰§è¡Œä¸€ä¸ªå‡½æ•°ï¼Œå°±ä¼šå°†è¯¥å‡½æ•°æ¨å…¥æ ˆä¸­ï¼Œå½“å‡½æ•°è¿”å›æ—¶ä»æ ˆä¸­å¼¹å‡ºã€‚ å½“æ ˆä¸ºç©ºæ—¶è¡¨ç¤ºæ²¡æœ‰ç¨‹åºæ­£åœ¨æ‰§è¡Œã€‚æ‰€ä»¥æ ˆå¸¸å¸¸ä¹Ÿç§°ä¸ºâ€˜è°ƒç”¨æ ˆâ€™</strong>ã€‚</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">baz</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">   <span class="built_in">console</span>.log(<span class="string">'Hello from baz'</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bar</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">   baz();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">   bar();</span><br><span class="line">&#125;</span><br><span class="line">foo();</span><br></pre></td></tr></table></figure><p>å› æ­¤, å½“ä¸Šé¢çš„ç¨‹åºåŠ è½½è¿›å†…å­˜æ—¶ï¼Œä¼šå¼€å§‹æ‰§è¡Œç¬¬ä¸€ä¸ªå‡½æ•°ï¼Œå³<code>foo</code>ã€‚ å› æ­¤ç¬¬ä¸€ä¸ªæ ˆå…ƒç´ å°±æ˜¯<code>foo()</code>, å› ä¸º<code>foo</code>å‡½æ•°ä¼šè°ƒç”¨<code>bar</code>å‡½æ•°ï¼Œç¬¬äºŒä¸ªæ ˆå…ƒç´ å°±æ˜¯<code>bar()</code>; åŒç†<code>bar</code>å‡½æ•°ä¼šè°ƒç”¨<code>baz</code>ï¼Œç¬¬ä¸‰ä¸ªæ ˆå…ƒç´ å°±æ˜¯<code>baz()</code>. æœ€åï¼Œ<code>baz</code>è°ƒç”¨<code>console.log</code>ï¼Œæœ€åä¸€ä¸ªæ ˆå…ƒç´ å°±æ˜¯<code>console.log(&#39;Hello from baz&#39;)</code></p><p>æ ˆä¼šåœ¨å‡½æ•°æ‰§è¡Œå®Œæ¯•æ—¶(åˆ°è¾¾å‡½æ•°åº•éƒ¨æˆ–è€…è°ƒç”¨return)å¼¹å‡ºã€‚ç„¶åç»§ç»­æ‰§è¡Œå‡½æ•°è°ƒç”¨åç»­çš„è¯­å¥:</p><p><img src="/images/js-bs/vis1.gif" alt></p><p><br></p><p>æ¯ä¸ªæ ˆå…ƒç´ ä¸­ï¼Œå…ƒç´ çš„çŠ¶æ€ä¹Ÿè¢«ç§°ä¸ºæ ˆå¸§(Stack Frame). å¦‚æœåœ¨å‡½æ•°è°ƒç”¨æŠ›å‡ºé”™è¯¯ï¼ŒJavaScriptä¼šè¾“å‡ºæ ˆè·Ÿè¸ªè®°å½•(Stack trace)ï¼Œè¡¨ç¤ºä»£ç æ‰§è¡Œæ—¶çš„æ ˆå¸§çš„å¿«ç…§ã€‚</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">baz</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Something went wrong.'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bar</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">   baz();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">   bar();</span><br><span class="line">&#125;</span><br><span class="line">foo();</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ç¨‹åºï¼Œæˆ‘ä»¬åœ¨<code>baz</code>ä¸­æŠ›å‡ºé”™è¯¯ï¼ŒJavaScriptä¼šæ‰“å°å‡ºæ ˆè·Ÿä¸­è®°å½•ï¼ŒæŒ‡å‡ºé”™è¯¯å‘ç”Ÿçš„åœ°æ–¹å’Œé”™è¯¯ä¿¡æ¯ã€‚</p><p><img src="/images/js-bs/err-msg.png" alt></p><p><br></p><p><strong>æ ˆçš„å¤§å°ä¸æ˜¯æ— é™çš„ã€‚ä¾‹å¦‚Chromeå°±ä¼šé™å®šæ ˆçš„æœ€å¤§ä¸º16,000å¸§ã€‚æ‰€ä»¥æ— é™é€’å½’ä¼šå¯¼è‡´ChromeæŠ›å‡º<code>Maximum Call Stack size exceeded</code></strong>:</p><p><img src="/images/js-bs/overstack.png" alt></p><p><br><br><br></p><h2 id="äº‹ä»¶å¾ªç¯ä¸web-api"><a href="#äº‹ä»¶å¾ªç¯ä¸web-api" class="headerlink" title="äº‹ä»¶å¾ªç¯ä¸Web API"></a>äº‹ä»¶å¾ªç¯ä¸Web API</h2><p><strong>å› ä¸ºJavaScriptæ˜¯å•çº¿ç¨‹çš„ï¼Œæ‰€ä»¥å®ƒåªæœ‰ä¸€ä¸ªæ ˆå’Œå †</strong>ã€‚å› æ­¤ï¼Œå¦‚æœå…¶ä»–ç¨‹åºæƒ³è¦æ‰§è¡Œä¸€äº›ä¸œè¥¿ï¼Œéœ€è¦ç­‰å¾…ä¸Šä¸€ä¸ªç¨‹åºæ‰§è¡Œå®Œæ¯•</p><p>å¯¹æ¯”å…¶ä»–è¯­è¨€ï¼Œè¿™å¯èƒ½æ˜¯ä¸€ä¸ªç³Ÿç³•çš„è®¾è®¡ï¼Œä½†æ˜¯JavaScriptçš„å®šä½å°±æ˜¯é€šç”¨ç¼–ç¨‹è¯­è¨€ï¼Œè€Œä¸æ˜¯ç”¨äºéå¸¸å¤æ‚çš„åœºæ™¯</p><p>è€ƒè™‘è¿™æ ·ä¸€ä¸ªåœºæ™¯ã€‚å‡è®¾æµè§ˆå™¨å‘é€ä¸€ä¸ªHTTPè¯·æ±‚åˆ°æœåŠ¡å™¨ï¼ŒåŠ è½½å›¾ç‰‡å¹¶å±•ç¤ºåˆ°é¡µé¢ã€‚æµè§ˆå™¨ä¼šå¡æ­»ç­‰å¾…è¯·æ±‚å®Œæˆå—ï¼Ÿæ˜¾ç„¶ä¸ä¼šï¼Œè¿™æ ·ç”¨æˆ·ä½“éªŒå¤ªå·®äº†</p><p>æµè§ˆå™¨é€šè¿‡JavaScriptå¼•æ“æ¥æä¾›JavaScriptè¿è¡Œç¯å¢ƒã€‚æ¯”å¦‚Chromeä½¿ç”¨V8 å¼•æ“ã€‚ä½†æ˜¯æµè§ˆå™¨å†…éƒ¨å¯ä¸åªæœ‰JavaScriptå¼•æ“ã€‚ä¸‹é¢æ˜¯æµè§ˆå™¨çš„åº•å±‚ç»“æ„ï¼š</p><p><br></p><p><img src="/images/js-bs/underhood.png" alt></p><p><br></p><p>çœ‹èµ·æ¥å¾ˆå¤æ‚ï¼Œä½†æ˜¯å®ƒä¹Ÿå¾ˆå¥½ç†è§£ã€‚JavaScriptå¼•æ“éœ€è¦å’Œå…¶ä»–2ä¸ªç»„ä»¶åä½œï¼Œå³<strong>äº‹ä»¶å¾ªç¯(EventLoop)</strong>å’Œ<strong>å›è°ƒé˜Ÿåˆ—(CallbackQueue)</strong>ï¼Œå›è°ƒé˜Ÿåˆ—ä¹Ÿè¢«ç§°ä¸ºæ¶ˆæ¯é˜Ÿåˆ—æˆ–ä»»åŠ¡é˜Ÿåˆ—ã€‚</p><p>é™¤äº†JavaScriptå¼•æ“ï¼Œæµè§ˆå™¨è¿˜åŒ…å«äº†è®¸å¤šä¸åŒçš„åº”ç”¨æ¥åšå„ç§å„æ ·çš„äº‹æƒ…ï¼Œæ¯”å¦‚HTTPè¯·æ±‚ã€DOMäº‹ä»¶ç›‘å¬ã€é€šè¿‡setTimeoutã€setIntervalå»¶è¿Ÿæ‰§è¡Œã€ç¼“å­˜ã€æ•°æ®å­˜å‚¨ç­‰ç­‰ã€‚è¿™äº›ç‰¹æ€§å¯ä»¥å¸®åŠ©æˆ‘ä»¬åˆ›å»ºä¸°å¯Œçš„Webåº”ç”¨ã€‚</p><p>æƒ³ä¸€ä¸‹ï¼Œå¦‚æœæµè§ˆå™¨åªä½¿ç”¨åŒä¸€ä¸ªJavaScriptçº¿ç¨‹æ¥å¤„ç†ä¸Šé¢è¿™äº›ç‰¹æ€§ï¼Œç”¨æˆ·ä½“éªŒä¼šæœ‰å¤šç³Ÿç³•ã€‚å› ä¸ºç”¨æˆ·å³ä½¿åªæ˜¯ç®€å•çš„æ»šåŠ¨é¡µé¢ï¼ŒèƒŒåæ˜¯éœ€è¦å¤„ç†å¾ˆå¤šäº‹æƒ…çš„, å•ä¸ªJavascriptçº¿ç¨‹å‹æ ¹å¿™ä¸è¿‡æ¥ã€‚å› æ­¤æµè§ˆå™¨ä¼šä½¿ç”¨ä½çº§çš„è¯­è¨€ï¼Œæ¯”å¦‚C++ï¼Œæ¥æ‰§è¡Œè¿™äº›æ“ä½œï¼Œå¹¶æš´éœ²ç®€æ´çš„JavaScript APIç»™å¼€å‘è€…ã€‚è¿™äº›APIç»Ÿç§°ä¸º<strong>Web API</strong>ã€‚</p><p><strong>è¿™äº›Web APIé€šå¸¸æ˜¯å¼‚æ­¥çš„</strong>ã€‚è¿™æ„å‘³ç€ï¼Œä½ å¯ä»¥å‘½ä»¤è¿™äº›APIåœ¨â€™åå°â€™(ç‹¬ç«‹çº¿ç¨‹)å»åšä¸€äº›äº‹æƒ…ï¼Œå®Œæˆä»»åŠ¡ä¹‹åå†é€šçŸ¥Javascriptè¿è¡Œæ—¶. åœ¨æ­¤åŒæ—¶ï¼ŒJavascriptå¼•æ“ä¼šç»§ç»­æ‰§è¡Œå‰©ä¸‹çš„JavaScriptä»£ç . åœ¨å‘½ä»¤è¿™äº›APIåœ¨åå°åšäº‹æƒ…æ—¶ï¼Œæˆ‘ä»¬é€šå¸¸éœ€è¦ç»™å®ƒä»¬æä¾›ä¸€ä¸ªå›è°ƒã€‚è¿™ä¸ªå›è°ƒçš„èŒè´£å°±æ˜¯åœ¨Web APIå®Œæˆä»»åŠ¡åæ‰§è¡ŒJavaScriptä»£ç ã€‚è®©æˆ‘ä»¬å°†ä¸Šè¿°çš„æ‰€æœ‰ä¸œè¥¿æ•´åˆèµ·æ¥ç†è§£ä¸€ä¸‹:</p><p><img src="/images/js-bs/webapi-call.png" alt></p><p>å½“ä½ è°ƒç”¨ä¸€ä¸ªå‡½æ•°æ—¶ï¼Œå®ƒä¼šè¢«æ¨è¿›æ ˆä¸­ã€‚å¦‚æœè¿™ä¸ªå‡½æ•°ä¸­åŒ…å«äº†Web APIè°ƒç”¨ï¼ŒJavaScriptä¼šä»£ç†Web APIçš„è°ƒç”¨, é€šçŸ¥Web APIæ‰§è¡Œä»»åŠ¡ï¼Œæ¥ç€ç»§ç»­æ‰§è¡Œä¸‹ä¸€è¡Œä»£ç ç›´åˆ°å‡½æ•°è¿”å›ã€‚ä¸€æ—¦å‡½æ•°åˆ°è¾¾returnè¯­å¥æˆ–è€…å‡½æ•°åº•éƒ¨ï¼Œè¿™ä¸ªå‡½æ•°å°±ä¼šä»è°ƒç”¨æ ˆä¸­å¼¹å‡ºæ¥ã€‚</p><p>ä¸æ­¤åŒæ—¶ï¼Œå¦‚æœWeb APIåœ¨åå°å®Œæˆäº†å®ƒçš„å·¥ä½œï¼Œä¸”æœ‰ä¸€ä¸ªå›è°ƒå’Œè¿™ä¸ªå·¥ä½œç»‘å®šï¼ŒWeb APIä¼šå°†æ¶ˆæ¯ç»“æœå’Œå›è°ƒè¿›è¡Œç»‘å®šï¼Œå¹¶æ¨å…¥åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­(æˆ–è€…ç§°ä¸ºå›è°ƒé˜Ÿåˆ—).</p><p><strong>äº‹ä»¶å¾ªç¯, å°±åƒä¸€ä¸ªæ— é™å¾ªç¯ï¼Œå®ƒçš„å”¯ä¸€å·¥ä½œæ˜¯æ£€æŸ¥å›è°ƒé˜Ÿåˆ—ï¼Œä¸€æ—¦å›è°ƒé˜Ÿåˆ—ä¸­æœ‰å¾…å¤„ç†çš„ä»»åŠ¡ï¼Œå°±å°†è¯¥å›è°ƒæ¨é€åˆ°è°ƒç”¨æ ˆ</strong>ã€‚ä¸è¿‡å› ä¸ºJavascriptæ˜¯å•çº¿ç¨‹çš„, äº‹ä»¶å¾ªç¯ä¸€æ¬¡åªèƒ½æ¨é€ä¸€ä¸ªå›è°ƒåˆ°è°ƒç”¨æ ˆï¼Œæ ˆå°†ä¼šæ‰§è¡Œå›è°ƒå‡½æ•°ï¼Œ<strong>ä¸€æ—¦è°ƒç”¨æ ˆä¸ºç©ºï¼Œäº‹ä»¶å¾ªç¯æ‰ä¼šå°†ä¸‹ä¸€ä¸ªå›è°ƒå‡½æ•°æ¨é€åˆ°è°ƒç”¨å †</strong>ã€‚</p><p>äº‹ä»¶å¾ªç¯çš„ä¼ªä»£ç å¤§æ¦‚å¦‚ä¸‹:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">   <span class="keyword">let</span> task</span><br><span class="line">   <span class="keyword">while</span>(task = popCallbackQueue()) &#123;<span class="comment">// å¼¹å‡ºå›è°ƒé˜Ÿåˆ—ä»»åŠ¡</span></span><br><span class="line">      executeTask(task) <span class="comment">// æ‰§è¡Œä»»åŠ¡, è¿™é‡Œé¢å¯èƒ½ä¼šè§¦å‘æ–°çš„Web APIè°ƒç”¨</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (hasAnyPendingTask()) &#123;</span><br><span class="line">      sleep() <span class="comment">// ç¡ä¸€è§‰ï¼Œæœ‰æ–°ä»»åŠ¡æ¨é€åˆ°å›è°ƒé˜Ÿåˆ—æ—¶æ—¶å†å”¤é†’æˆ‘å“¦</span></span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">break</span> <span class="comment">// ç»ˆæ­¢ç¨‹åº, æ²¡ä»€ä¹ˆå¥½å¹²çš„æ‹œæ‹œäº†</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>æˆ‘ä»¬é€šè¿‡setTimeout Web APIè¿™ä¸ªä¾‹å­ä¸€æ­¥ä¸€æ­¥çœ‹çœ‹ä¸Šè¿°çš„ä¸€åˆ‡æ˜¯æ€ä¹ˆè¿ä½œçš„ã€‚setTimeout Web APIä¸»è¦ç”¨äºå»¶æ—¶æ‰§è¡Œä¸€äº›æ“ä½œï¼Œä½†æ˜¯å›è°ƒçœŸæ­£è¢«æ‰§è¡Œ, éœ€è¦ç­‰å¾…å½“å‰ç¨‹åºæ‰§è¡Œå®Œæ¯•(å³æ ˆä¸ºç©º), ä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>setTimeoutå‡½æ•°å›è°ƒæ‰§è¡Œæ—¶é—´æœªå¿…ç­‰äºä½ æŒ‡å®šçš„å»¶æ—¶æ—¶é—´</strong>ã€‚setTimeoutçš„è¯­æ³•å¦‚ä¸‹:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">setTimeout(callbackFunction, timeInMilliseconds);</span><br></pre></td></tr></table></figure><p>callbackFunctionæ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå®ƒå°†ä¼šåœ¨timeInMillisecondsä¹‹åæ‰§è¡Œ. æˆ‘ä»¬ä¿®æ”¹ä¸Šé¢çš„ä»£ç æ¥è°ƒç”¨setTimeout:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">printHello</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Hello from baz'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">baz</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    setTimeout(printHello, <span class="number">3000</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bar</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    baz();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    bar();</span><br><span class="line">&#125;</span><br><span class="line">foo();</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç å»¶æ—¶è°ƒç”¨äº†console.log. æ ˆè¿˜æ˜¯ä¼šåƒä¹‹å‰ä¸€æ ·ï¼Œå¦‚<code>foo() =&gt; bar() =&gt; baz()</code>, å½“bazå¼€å§‹æ‰§è¡Œå¹¶åˆ°è¾¾setTimeoutæ—¶ï¼ŒJavascriptä¼šå°†å›è°ƒå‡½æ•°ä¼ é€’ç»™Web APIï¼Œå¹¶ä¸”ç»§ç»­æ‰§è¡Œä¸‹ä¸€è¡Œã€‚ å› ä¸ºè¿™é‡Œæ²¡æœ‰ä¸‹ä¸€è¡Œäº†ï¼Œæ ˆä¼šå¼¹å‡ºbazï¼Œæ¥ç€å¼¹å‡ºbarå’Œfooã€‚</p><p>åœ¨è¿™æœŸé—´ï¼ŒWeb APIæ­£åœ¨è¿›è¡Œ3sç­‰å¾…ï¼Œå½“æ—¶é—´åˆ°è¾¾æ—¶ï¼Œå®ƒä¼šå°†å›è°ƒæ¨è¿›å›è°ƒé˜Ÿåˆ—ä¸­ã€‚ å› ä¸ºè¿™æ—¶å€™è°ƒç”¨æ ˆä¸ºç©ºï¼Œäº‹ä»¶å¾ªç¯ä¼šå°†è¿™ä¸ªå›è°ƒæ¨è¿›æ ˆä¸­ï¼Œå¹¶æ‰§è¡Œè¿™ä¸ªå›è°ƒã€‚</p><p><br></p><p><strong>ğŸ‰ğŸ‰<a href="http://latentflip.com/" target="_blank" rel="noopener">Philip Robers</a>åˆ›å»ºäº†ä¸€ä¸ªç¥å¥‡çš„åœ¨çº¿å·¥å…·<a href="http://latentflip.com/loupe/" target="_blank" rel="noopener">Loupe</a>ï¼Œæ¥å¯è§†åŒ–Javascriptçš„åº•å±‚è¿è¡Œã€‚ä¸Šé¢çš„å®ä¾‹å¯ä»¥æŸ¥çœ‹è¿™ä¸ª<a href="http://latentflip.com/loupe/?code=ZnVuY3Rpb24gcHJpbnRIZWxsbygpIHsNCiAgICBjb25zb2xlLmxvZygnSGVsbG8gZnJvbSBiYXonKTsNCn0NCg0KZnVuY3Rpb24gYmF6KCkgew0KICAgIHNldFRpbWVvdXQocHJpbnRIZWxsbywgMzAwMCk7DQp9DQoNCmZ1bmN0aW9uIGJhcigpIHsNCiAgICBiYXooKTsNCn0NCg0KZnVuY3Rpb24gZm9vKCkgew0KICAgIGJhcigpOw0KfQ0KDQpmb28oKTs%3D!!!PGJ1dHRvbj5DbGljayBtZSE8L2J1dHRvbj4%3D" target="_blank" rel="noopener">é“¾æ¥</a>ğŸ‰ğŸ‰</strong></p><p><img src="/images/js-bs/vis2.gif" alt></p><p><strong>æ‰€ä»¥è¯´æˆ‘ä»¬Javascriptæ˜¯å•çº¿ç¨‹çš„ï¼Œä½†æ˜¯å¾ˆå¤šWeb APIçš„æ‰§è¡Œæ˜¯å¤šçº¿ç¨‹çš„ã€‚ä¹Ÿå°±æ˜¯è¯´Javascriptçš„å•çº¿ç¨‹æŒ‡çš„æ˜¯â€˜Javascriptä»£ç â€™çš„æ‰§è¡Œæ˜¯å•çº¿ç¨‹</strong>.</p><p><br></p><h2 id="node-js"><a href="#node-js" class="headerlink" title="Node.js"></a>Node.js</h2><p>é€šè¿‡Node.jsæˆ‘ä»¬å¯ä»¥åšæ›´å¤šçš„äº‹æƒ…, è€Œä¸ä»…é™äºæµè§ˆå™¨çš„ç«¯ã€‚é‚£ä¹ˆå®ƒæ˜¯æ€ä¹ˆè¿ä½œçš„ï¼Ÿ</p><p>Node.js å’ŒChromeä¸€æ ·ï¼ŒåŒæ ·ä½¿ç”¨Googleçš„V8å¼•æ“æ¥æä¾›Javascriptè¿è¡Œæ—¶. å®ƒä½¿ç”¨<a href="https://github.com/libuv/libuv" target="_blank" rel="noopener">libuv</a>(C++ç¼–å†™)æ¥å’ŒV8çš„äº‹ä»¶å¾ªç¯é…åˆï¼Œæ‰©å±•æ›´å¤šå¯ä»¥åœ¨åå°æ‰§è¡Œçš„ä¸œè¥¿, æ¯”å¦‚æ–‡ä»¶ç³»ç»ŸI/O, ç½‘ç»œI/Oã€‚Nodeçš„æ ‡å‡†åº“APIéµå¾ªäº†æµè§ˆå™¨Web APIçš„ç±»ä¼¼å›è°ƒé£æ ¼ã€‚</p><p><img src="/images/js-bs/node.jpg" alt></p><p>å¦‚æœä½ æ¯”è¾ƒäº†æµè§ˆå™¨å’Œnodeçš„ç»“æ„å›¾ï¼Œä½ ä¼šå‘ç°ä¸¤è€…éå¸¸ç›¸ä¼¼ã€‚å³ä¾§çš„éƒ¨åˆ†ç±»ä¼¼äºWeb APIï¼ŒåŒæ ·åŒ…å«äº‹ä»¶é˜Ÿåˆ—(æˆ–è€…ç§°ä¸ºå›è°ƒé˜Ÿåˆ—/æ¶ˆæ¯é˜Ÿåˆ—)å’Œäº‹ä»¶å¾ªç¯ã€‚</p><p>V8ã€äº‹ä»¶å¾ªç¯ã€äº‹ä»¶é˜Ÿåˆ—éƒ½åœ¨å•çº¿ç¨‹ä¸­è¿è¡Œï¼Œæœ€å³ä¾§è¿˜æœ‰å·¥ä½œçº¿ç¨‹(Worker Thread)è´Ÿè´£æä¾›å¼‚æ­¥çš„I/Oæ“ä½œã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¯´Node.jsæ‹¥æœ‰éé˜»å¡çš„ã€äº‹ä»¶é©±åŠ¨çš„å¼‚æ­¥I/Oæ¶æ„ã€‚</p><p>ä¸Šé¢çš„å†…å®¹éƒ½æ¥æºäº<a href="http://latentflip.com/" target="_blank" rel="noopener">Philip Roberts</a>30minçš„é«˜å…‰<a href="https://youtu.be/8aGhZQkoFbQ" target="_blank" rel="noopener">æ¼”è®²</a>(äº”å¹´å‰)</p><p>æœ¬æ–‡å®Œ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åŸæ–‡åœ°å€: &lt;a href=&quot;https://itnext.io/how-javascript-works-in-browser-and-node-ab7d0d09ac2f&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;How JavaScript wor
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://bobi.ink/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>Typescriptç‰ˆå›¾è§£Functor , Applicative å’Œ Monad</title>
    <link href="https://bobi.ink/2019/08/22/ts-fam/"/>
    <id>https://bobi.ink/2019/08/22/ts-fam/</id>
    <published>2019-08-21T16:00:00.000Z</published>
    <updated>2019-08-24T14:25:35.093Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬æ–‡æ˜¯ç»å…¸çš„<a href="http://adit.io/posts/2013-04-17-functors,_applicatives,_and_monads_in_pictures.html" target="_blank" rel="noopener">Functors, Applicatives, And Monads In Pictures</a>çš„Typescriptç¿»è¯‘ç‰ˆæœ¬ã€‚</p><p>Functor/Applicative/Monadæ˜¯å‡½æ•°å¼ç¼–ç¨‹ä¸­çš„ä¸€äº›æ¯”è¾ƒâ€˜åŸºç¡€â€™çš„æ¦‚å¿µï¼Œåæ­£æˆ‘æ˜¯ä¸è®¤åŒâ€˜åŸºç¡€â€™è¿™ä¸ªè¯´æ³•çš„ï¼Œç¬”è€…ä¹Ÿé˜…è¯»è¿‡å¾ˆå¤šç±»ä¼¼ä»‹ç»Monadçš„æ–‡ç« ï¼Œæœ€åéƒ½ä¸äº†äº†ä¹‹ï¼Œè¿™äº›æ¦‚å¿µæ˜¯æ¯”è¾ƒéš¾ä»¥ç†è§£çš„ï¼Œè€Œä¸”å¹³æ—¶ç¼–ç¨‹å®è·µä¸­ä¹Ÿå¾ˆéš¾ä¼šæ¥è§¦åˆ°è¿™äº›ä¸œè¥¿ã€‚</p><p>åæ¥æ‹œè¯»äº†<a href="http://adit.io/posts/2013-04-17-functors,_applicatives,_and_monads_in_pictures.html" target="_blank" rel="noopener">Functors, Applicatives, And Monads In Pictures</a>, ä¸é”™ï¼Œå¥½åƒæ‡‚äº†ã€‚äºæ˜¯è‡ªå·±æƒ³é€šè¿‡ç¿»è¯‘ï¼Œå†æ·±å…¥æ¶ˆåŒ–æ¶ˆåŒ–è¿™ç¯‡æ–‡ç« ï¼Œè¿™é‡Œä½¿ç”¨<code>Typescript</code>ä½œä¸ºæè¿°è¯­è¨€ï¼Œå¯¹äºå‰ç«¯æ¥è¯´ä¼šæ›´å¥½ç†è§£ã€‚</p><p>æœ‰ç†è§£ä¸æ­£ç¡®çš„åœ°æ–¹ï¼Œæ•¬è¯·æŒ‡æ­£. å¼€å§‹å§ï¼</p><p><br></p><p>è¿™æ˜¯ä¸€ä¸ªç®€å•çš„å€¼:</p><p><img src="/images/ts-fam/value.png" alt></p><p>ä¾‹å¦‚è¿™äº›</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>        <span class="comment">// number</span></span><br><span class="line"><span class="string">'string'</span> <span class="comment">// string</span></span><br></pre></td></tr></table></figure><p>å¤§å®¶éƒ½çŸ¥é“æ€ä¹ˆå°†ä¸€ä¸ªå‡½æ•°åº”ç”¨åˆ°è¿™ä¸ªå€¼ä¸Šé¢:</p><p><img src="/images/ts-fam/value_apply.png" alt></p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// So easy</span></span><br><span class="line"><span class="keyword">const</span> add3 = <span class="function">(<span class="params">val: <span class="built_in">number</span></span>) =&gt;</span> val + <span class="number">3</span></span><br><span class="line"><span class="built_in">console</span>.log(add3(<span class="number">2</span>)) <span class="comment">// 5</span></span><br></pre></td></tr></table></figure><p>å¾ˆç®€å•äº†. æˆ‘ä»¬æ¥æ‰©å±•ä¸€ä¸‹, è®©ä»»æ„çš„å€¼æ˜¯å¯ä»¥åŒ…è£…åœ¨ä¸€ä¸ª<strong>ä¸Šä¸‹æ–‡(context)</strong>å½“ä¸­. ç°åœ¨çš„æƒ…å†µä½ å¯ä»¥æƒ³è±¡ä¸€ä¸ªå¯ä»¥æŠŠå€¼æ”¾è¿›å»çš„ç›’å­:</p><p><img src="/images/ts-fam/value_and_context.png" alt></p><p>ç°åœ¨ä½ <strong>æŠŠä¸€ä¸ªå‡½æ•°åº”ç”¨åˆ°è¿™ä¸ªåŒ…è£…å€¼çš„æ—¶å€™, æ ¹æ®å…¶ä¸Šä¸‹æ–‡ç±»å‹ä½ ä¼šå¾—åˆ°ä¸åŒçš„ç»“æœ</strong>. è¿™å°±æ˜¯ <code>Functor</code>, <code>Applicative</code>, <code>Monad</code>, <code>Arrow</code> ä¹‹ç±»æ¦‚å¿µçš„åŸºç¡€. </p><p><code>Maybe</code> å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„æ•°æ®ç±»å‹, å®ƒå®šä¹‰äº†ä¸¤ç§ç›¸å…³çš„â€˜<strong>ä¸Šä¸‹æ–‡</strong>â€™, Maybeæœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªâ€˜ä¸Šä¸‹æ–‡â€™(é™¤äº†å€¼ï¼Œå…¶ä»–ç±»å‹éƒ½å¯ä»¥æ˜¯ä¸€ä¸ªä¸Šä¸‹æ–‡ï¼Ÿ):</p><p><img src="/images/ts-fam/context.png" alt></p><p>åŸæ–‡åŸºäºHaskellï¼Œå®ƒçš„Maybeç±»å‹æœ‰ä¸¤ä¸ªä¸Šä¸‹æ–‡Just(è“è‰²ç›’å­)å’ŒNone(çº¢è‰²ç©ºç›’å­)ã€‚ä»¿é€ Haskellåœ¨Typescriptä¸­æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>å¯é€‰ç±»å‹(Maybe)</code>æ¥è¡¨ç¤º:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> Maybe&lt;T&gt; = Just&lt;T&gt; | Nothing <span class="comment">// Just è¡¨ç¤ºå€¼â€˜å­˜åœ¨â€™ï¼ŒNothingè¡¨ç¤ºç©ºå€¼ï¼Œç±»ä¼¼äºnullã€undefinedçš„æ¦‚å¿µ</span></span><br></pre></td></tr></table></figure><p>Justå’ŒNothingçš„åŸºæœ¬ç»“æ„:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æˆ‘ä»¬åªç”¨Noneæ¥å–ä»£null, è¿™é‡Œæˆ‘ä»¬å°†Noneä½œä¸ºä¸€ä¸ªå€¼ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªç±»</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> None &#123;&#125;</span><br><span class="line"><span class="comment">// å¯¹åº”Noneçš„ç±»å‹</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> Nothing = <span class="keyword">typeof</span> None</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ¤æ–­æ˜¯å¦æ˜¯Nothingï¼Œè¿™é‡Œä½¿ç”¨Typescriptçš„ `Type Guards`</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> isNothing = (val: <span class="built_in">any</span>): val is Nothing =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> val === None</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Justç±»å‹</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> Just&lt;T&gt; &#123;</span><br><span class="line">  <span class="keyword">static</span> of&lt;T&gt;(val: T) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Just(val)</span><br><span class="line">  &#125;</span><br><span class="line">  value: T</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params">value: T</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.value = value</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ç¤ºä¾‹:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> a: Maybe&lt;<span class="built_in">number</span>&gt;;</span><br><span class="line">a = None;</span><br><span class="line">a = Just.of(<span class="number">3</span>);</span><br></pre></td></tr></table></figure><blockquote><p>è¯´å®åœ¨è¿™ä¸ªå®ç°æœ‰ç‚¹æŒ«, ä½†æ˜¯ä¸ºäº†æ›´åŠ è´´è¿‘åŸæ–‡æè¿°ï¼Œæš‚ä¸”ä½¿ç”¨è¿™ä¸ªå®ç°ã€‚ä¹‹å‰è€ƒè™‘è¿‡çš„ä¸€ä¸ªç‰ˆæœ¬æ˜¯ä¸‹é¢è¿™æ ·çš„, å› ä¸ºæ— æ³•ç»™å®ƒä»¬æ‰©å±•æ–¹æ³•ï¼Œå°±æ”¾å¼ƒäº†è¿™ä¸ªæ–¹æ¡ˆ:<br>  <figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> Optional&lt;T&gt; = NonNullable&lt;T&gt; | nul</span><br><span class="line"><span class="keyword">let</span> a: Optional&lt;<span class="built_in">number</span>&gt; = <span class="number">1</span>;</span><br><span class="line">a = <span class="literal">null</span>;</span><br></pre></td></tr></table></figure></p></blockquote><p><br></p><p>å¾ˆå¿«æˆ‘ä»¬ä¼šçœ‹åˆ°å¯¹ä¸€ä¸ª <code>Just&lt;a&gt;</code> å’Œä¸€ä¸ª Nothing æ¥è¯´, å‡½æ•°åº”ç”¨æœ‰ä½•ä¸åŒ. é¦–å…ˆæˆ‘ä»¬æ¥çœ‹çœ‹ Functor!</p><p><br><br><br></p><h2 id="functors"><a href="#functors" class="headerlink" title="Functors"></a>Functors</h2><p>å½“ä¸€ä¸ªå€¼è¢«åŒ…è£…åœ¨ä¸€ä¸ªä¸Šä¸‹æ–‡ä¸­æ—¶, ä½ å°±ä¸èƒ½æ‹¿æ™®é€šå‡½æ•°æ¥åº”ç”¨äº†:</p><p><img src="/images/ts-fam/no_fmap_ouch.png" alt></p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">declare</span> <span class="keyword">let</span> a: Just&lt;<span class="built_in">number</span>&gt;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> add3 = <span class="function">(<span class="params">v: <span class="built_in">number</span></span>) =&gt;</span> v + <span class="number">3</span></span><br><span class="line">add3(a) <span class="comment">// âŒ ç±»å‹â€œJust&lt;number&gt;â€çš„å‚æ•°ä¸èƒ½èµ‹ç»™ç±»å‹â€œnumberâ€çš„å‚</span></span><br></pre></td></tr></table></figure><p>è¿™æ—¶å€™, è¯¥ <code>fmap</code> å‡ºåœºäº†. fmap ç¿©ç¿©è€Œæ¥ï¼Œä»å®¹åº”å¯¹ä¸Šä¸‹æ–‡(fmap is from the street, fmap is hip to contexts). è¿˜æœ‰è°? fmap çŸ¥é“æ€æ ·å°†ä¸€ä¸ªå‡½æ•°åº”ç”¨åˆ°ä¸€ä¸ªåŒ…è£…åœ¨ä¸Šä¸‹æ–‡çš„å€¼ä¸Š. <strong>ä½ å¯ä»¥å¯¹ä»»ä½•ä¸€ä¸ªç±»å‹ä¸º Functor çš„ç±»å‹ä½¿ç”¨ fmap</strong>ï¼Œ æ¢å¥è¯è¯´ï¼ŒFunctoréƒ½å®šä¹‰äº†fmap.</p><p>æ¯”å¦‚è¯´, æƒ³ä¸€ä¸‹ä½ æƒ³æŠŠ add3 åº”ç”¨åˆ° Just 2. ç”¨ fmap:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line">Just.of(<span class="number">2</span>).fmap(add3) <span class="comment">// Just 5</span></span><br></pre></td></tr></table></figure><p><img src="/images/ts-fam/fmap_apply.png" alt></p><p><strong>ğŸ’¥å˜­ï¼</strong> fmap å‘æˆ‘ä»¬å±•ç¤ºäº†å®ƒçš„æˆæœã€‚ ä½†æ˜¯ fmap æ€ä¹ˆçŸ¥é“å¦‚ä½•åº”ç”¨è¯¥å‡½æ•°çš„å‘¢ï¼Ÿ</p><p><br></p><h2 id="ç©¶ç«Ÿä»€ä¹ˆæ˜¯-functor-å‘¢ï¼Ÿ"><a href="#ç©¶ç«Ÿä»€ä¹ˆæ˜¯-functor-å‘¢ï¼Ÿ" class="headerlink" title="ç©¶ç«Ÿä»€ä¹ˆæ˜¯ Functor å‘¢ï¼Ÿ"></a>ç©¶ç«Ÿä»€ä¹ˆæ˜¯ Functor å‘¢ï¼Ÿ</h2><p>åœ¨ Haskell ä¸­ <code>Functor</code> æ˜¯ä¸€ä¸ª<a href="http://learnyouahaskell.com/types-and-typeclasses#typeclasses-101" target="_blank" rel="noopener">ç±»å‹ç±»(typeclass)</a>ã€‚ å…¶å®šä¹‰å¦‚ä¸‹ï¼š</p><p><img src="/images/ts-fam/functor_def.png" alt></p><p>åœ¨Typescriptä¸­ï¼Œ ä¸€ä¸ªFunctorè®¤ä¸ºæ˜¯<strong>å®šä¹‰äº†fmapçš„ä»»æ„ç±»å‹</strong>. çœ‹çœ‹<code>fmap</code>æ˜¯å¦‚ä½•å·¥ä½œçš„:</p><p><img src="/images/ts-fam/fmap_def.png" alt></p><ol><li>ä¸€ä¸ªFunctorç±»å‹çš„ fa, ä¾‹å¦‚Just 2</li><li>fa å®šä¹‰äº†ä¸€ä¸ªfmap, fmap æ¥å—ä¸€ä¸ªå‡½æ•°fnï¼Œä¾‹å¦‚add3</li><li>fmap ç›´åˆ°å¦‚ä½•å°†faåº”ç”¨åˆ°fnä¸­ï¼Œ è¿”å›ä¸€ä¸ªFunctorç±»å‹çš„ fb. <strong>faå’Œfbçš„åŒ…è£…ä¸Šä¸‹æ–‡ç±»å‹ä¸€æ ·</strong>, ä¾‹å¦‚faæ˜¯Just, é‚£ä¹ˆfbä¹Ÿæ˜¯Just; åä¹‹faæ˜¯Nothingï¼Œfbä¹Ÿæ˜¯Nothing;</li></ol><p>ç”¨Typescriptçš„å‡½æ•°ç­¾åæè¿°ä¸€ä¸‹ï¼š</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line">&lt;Functor T&gt;.fmap&lt;U&gt;<span class="function">(<span class="params">fn: (<span class="params">val: T</span>) =&gt; U</span>): &lt;<span class="params">Functor</span> <span class="params">U</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¿™ä¹ˆåšï¼š</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line">Just.of(<span class="number">2</span>).fmap(add3) <span class="comment">// Just 5</span></span><br></pre></td></tr></table></figure><p>è€Œ fmap ç¥å¥‡åœ°åº”ç”¨äº†è¿™ä¸ªå‡½æ•°ï¼Œå› ä¸º Maybe æ˜¯ä¸€ä¸ª Functor, å®ƒæŒ‡å®šäº† fmap å¦‚ä½•åº”ç”¨åˆ° Just ä¸Šä¸ Nothing ä¸Š:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> Just&lt;T&gt; &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// å®ç°fmap</span></span><br><span class="line">  fmap&lt;U&gt;<span class="function">(<span class="params">fn: (<span class="params">val: T</span>) =&gt; U</span>) &#123;</span></span><br><span class="line"><span class="function">    <span class="params">return</span> <span class="params">Just</span>.<span class="params">of</span>(<span class="params">fn(<span class="params"><span class="keyword">this</span>.value</span>)</span>)</span></span><br><span class="line"><span class="function">  &#125;</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="params">class</span> <span class="params">None</span> &#123;</span></span><br><span class="line"><span class="function">  // <span class="params">None</span> æ¥å—ä»»ä½•å‡½æ•°éƒ½è¿”å›<span class="params">None</span></span></span><br><span class="line"><span class="function">  <span class="params">static</span> <span class="params">fmap</span>(<span class="params">fn: <span class="built_in">any</span></span>) &#123;</span></span><br><span class="line"><span class="function">    <span class="params">return</span> <span class="params">None</span></span></span><br><span class="line"><span class="function">  &#125;</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure><p><br></p><p>å½“æˆ‘ä»¬å†™ <code>Just.of(2).fmap(add3)</code> æ—¶ï¼Œè¿™æ˜¯å¹•åå‘ç”Ÿçš„äº‹æƒ…ï¼š</p><p><img src="/images/ts-fam/fmap_just.png" alt></p><p>é‚£ä¹ˆç„¶åï¼Œå°±åƒè¿™æ ·ï¼Œfmapï¼Œè¯·å°† add3 åº”ç”¨åˆ° Nothing ä¸Šå¦‚ä½•ï¼Ÿ</p><p><img src="/images/ts-fam/fmap_nothing.png" alt></p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line">None.fmap(add3) <span class="comment">// Nothing</span></span><br></pre></td></tr></table></figure><p><img src="/images/ts-fam/bill.png" alt></p><p>å°±åƒã€Šé»‘å®¢å¸å›½ã€‹ä¸­çš„ Morpheusï¼Œfmap çŸ¥é“éƒ½è¦åšä»€ä¹ˆï¼›å¦‚æœä½ ä» Nothing å¼€å§‹ï¼Œé‚£ä¹ˆä½ ä¼šä»¥ Nothing ç»“æŸï¼ fmap æ˜¯ç¦…ã€‚</p><p>ç°åœ¨å®ƒå‘Šè¯‰æˆ‘ä»¬äº† Maybe æ•°æ®ç±»å‹å­˜åœ¨çš„æ„ä¹‰ã€‚ ä¾‹å¦‚ï¼Œè¿™æ˜¯åœ¨ä¸€ä¸ªæ²¡æœ‰ Maybe çš„è¯­è¨€ä¸­å¤„ç†ä¸€ä¸ªæ•°æ®åº“è®°å½•çš„æ–¹å¼, æ¯”å¦‚Javascript:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> post = Post.findByID(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">if</span> (post != <span class="literal">null</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> post.title</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ‰äº†fmapå:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å‡è®¾findPostè¿”å›Maybe&lt;Article&gt;</span></span><br><span class="line">findPost(<span class="number">1</span>).fmap(getPostTitle)</span><br></pre></td></tr></table></figure><p>å¦‚æœ findPost è¿”å›ä¸€ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬å°±ä¼šé€šè¿‡ getPostTitle è·å–å…¶æ ‡é¢˜ã€‚ å¦‚æœå®ƒè¿”å› Nothingï¼Œæˆ‘ä»¬å°±ä¹Ÿè¿”å› Nothingï¼ è¾ƒä¹‹å‰ç®€æ´äº†å¾ˆå¤šå¯¹å§?</p><blockquote><p>Typescriptæœ‰äº†Optional Chainingåï¼Œå¤„ç†nullä¹Ÿå¯ä»¥å¾ˆç®€æ´:<br> <figure class="highlight ts"><table><tr><td class="code"><pre><span class="line">findPost(<span class="number">1</span>)?.title <span class="comment">// å¼‚æ›²åŒå·¥</span></span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p>åŸæ–‡è¿˜æœ‰å®šä¹‰äº†ä¸€ä¸ªfmapçš„é‡è½½æ“ä½œç¬¦ç‰ˆæœ¬ï¼Œå› ä¸ºJavaScriptä¸æ”¯æŒæ“ä½œç¬¦é‡è½½ï¼Œæ‰€ä»¥è¿™é‡Œç®€å•å¸¦è¿‡<br> <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">getPostTitle &lt;$&gt; findPost(1) // ä½¿ç”¨æ“ä½œç¬¦é‡è½½&lt;$&gt; æ¥ç®€åŒ–fmap. ç­‰ä»·äºä¸Šé¢çš„ä»£ç </span><br></pre></td></tr></table></figure></p></blockquote><p><br></p><p>å†çœ‹ä¸€ä¸ªç¤ºä¾‹ï¼šå¦‚æœå°†ä¸€ä¸ªå‡½æ•°åº”ç”¨åˆ°ä¸€ä¸ª Arrayï¼ˆHaksell ä¸­æ˜¯ Listï¼‰ä¸Šä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</p><p><img src="/images/ts-fam/fmap_list.png" alt></p><p>Array ä¹Ÿæ˜¯ functorï¼</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].map(add3) <span class="comment">// [4, 5, 6]. faæ˜¯Arrayï¼Œè¾“å‡ºfbä¹Ÿæ˜¯Arrayï¼Œç¬¦åˆFunctorçš„å®šä¹‰å§ï¼Œæ‰€ä»¥Javascriptçš„mapå°±æ˜¯fmapï¼ŒArrayå°±æ˜¯Functor</span></span><br></pre></td></tr></table></figure><p><br></p><p>å¥½äº†ï¼Œå¥½äº†ï¼Œæœ€åä¸€ä¸ªç¤ºä¾‹ï¼šå¦‚æœå°†ä¸€ä¸ªå‡½æ•°åº”ç”¨åˆ°å¦ä¸€ä¸ªå‡½æ•°ä¸Šä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> multiply3 = <span class="function">(<span class="params">v: <span class="built_in">number</span></span>) =&gt;</span> v * <span class="number">3</span></span><br><span class="line"><span class="keyword">const</span> add3 = <span class="function">(<span class="params">v: <span class="built_in">number</span></span>) =&gt;</span> v + <span class="number">3</span></span><br><span class="line"></span><br><span class="line">add3.fmap(multiply3) <span class="comment">// â“</span></span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€ä¸ªå‡½æ•°ï¼š</p><p><img src="/images/ts-fam/function_with_value.png" alt></p><p>è¿™æ˜¯ä¸€ä¸ªåº”ç”¨åˆ°å¦ä¸€ä¸ªå‡½æ•°ä¸Šçš„å‡½æ•°ï¼š</p><p><img src="/images/ts-fam/fmap_function.png" alt></p><p>å…¶ç»“æœæ˜¯åˆä¸€ä¸ªå‡½æ•°ï¼</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä»…ä½œç¤ºä¾‹ï¼Œä¸è¦æ¨¡ä»¿</span></span><br><span class="line"><span class="keyword">interface</span> Function &#123;</span><br><span class="line">  fmap&lt;V, T, U&gt;<span class="function">(<span class="params"><span class="keyword">this</span>: (<span class="params">val: V</span>) =&gt; T, fn: (<span class="params">val: T</span>) =&gt; U</span>): (<span class="params">val: V</span>) =&gt;</span> U</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">Function</span>.prototype.fmap = <span class="function"><span class="keyword">function</span>(<span class="params">fn</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">v</span> =&gt;</span> fn(<span class="keyword">this</span>(v))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥å‡½æ•°ä¹Ÿæ˜¯ Functorï¼ å¯¹ä¸€ä¸ªå‡½æ•°ä½¿ç”¨ fmapï¼Œå…¶å®å°±æ˜¯å‡½æ•°ç»„åˆ(compose)ï¼ ä¹Ÿå°±æ˜¯è¯´: <code>f.fmap(g)</code> ç­‰ä»·äº <code>compose(f, g)</code></p><p><br></p><h3 id="functoræ€»ç»“"><a href="#functoræ€»ç»“" class="headerlink" title="Functoræ€»ç»“"></a>Functoræ€»ç»“</h3><p>é€šè¿‡ä¸Šé¢çš„ä¾‹å­ï¼Œå¯ä»¥çŸ¥é“Functorå…¶å®å¹¶æ²¡æœ‰é‚£ä¹ˆéš¾ä»¥ç†è§£, ä¸€ä¸ªFunctorå°±æ˜¯ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;Functor T&gt;.fmap(fn: (v: T) =&gt; U): &lt;Functor U&gt;</span><br></pre></td></tr></table></figure><p>Functorä¼šå®šä¹‰ä¸€ä¸ªâ€˜fmapâ€™æ“ä½œï¼Œè¿™ä¸ªfmapæ¥å—ä¸€ä¸ªå‡½æ•°fnï¼Œfnæ¥æ”¶çš„æ˜¯å…·ä½“çš„å€¼ï¼Œè¿”å›å¦ä¸€ä¸ªå…·ä½“çš„å€¼ï¼Œä¾‹å¦‚ä¸Šé¢çš„add3. <strong>fmapå†³å®šå¦‚ä½•æ¥åº”ç”¨fnåˆ°æºFunctor(a)</strong>ï¼Œ è¿”å›ä¸€ä¸ªæ–°çš„Functor(b)ã€‚ ä¹Ÿå°±æ˜¯fmapçš„æºå’Œè¾“å‡ºçš„å€¼â€˜ä¸Šä¸‹æ–‡â€™ç±»å‹æ˜¯ä¸€æ ·çš„ã€‚æ¯”å¦‚</p><ul><li><code>Just -&gt; fmap -&gt; Just</code></li><li><code>Nothing -&gt; fmap -&gt; Nothing</code></li><li><code>Maybe -&gt; fmap -&gt; Maybe</code></li><li><code>Array -&gt; fmap -&gt; Array</code></li></ul><p><br><br><br></p><h2 id="applicative"><a href="#applicative" class="headerlink" title="Applicative"></a>Applicative</h2><p>ç°åœ¨ç»ƒåˆ°äºŒé‡å¤©äº†ã€‚ Applicative åˆæå‡äº†ä¸€ä¸ªå±‚æ¬¡ã€‚</p><p>å¯¹äº Applicativeï¼Œæˆ‘ä»¬çš„å€¼ä¾ç„¶å’Œ Functor ä¸€æ ·åŒ…è£…åœ¨ä¸€ä¸ªä¸Šä¸‹æ–‡ä¸­</p><p><img src="/images/ts-fam/value_and_context.png" alt></p><p>ä¸ä¸€æ ·çš„æ˜¯ï¼Œæˆ‘ä»¬<strong>å°†Functorä¸­çš„å‡½æ•°(ä¾‹å¦‚add3)ä¹ŸåŒ…è£…åœ¨ä¸€ä¸ªä¸Šä¸‹æ–‡ä¸­</strong>ï¼</p><p><img src="/images/ts-fam/function_and_context.png" alt></p><p>å—¯ã€‚ æˆ‘ä»¬ç»§ç»­æ·±å…¥ã€‚ Applicative å¹¶æ²¡æœ‰å¼€ç©ç¬‘ã€‚ä¸åƒHaskellï¼ŒTypescriptå¹¶æ²¡æœ‰å†…ç½®æ–¹å¼æ¥å¤„ç†Applicativeã€‚æˆ‘ä»¬å¯ä»¥ç»™éœ€è¦æ”¯æŒApplicativeçš„ç±»å‹å®šä¹‰ä¸€ä¸ªapplyå‡½æ•°ã€‚<strong>applyå‡½æ•°çŸ¥é“æ€ä¹ˆå°†<code>åŒ…è£…åœ¨ä¸Šä¸‹æ–‡çš„å‡½æ•°</code>åº”ç”¨åˆ°ä¸€ä¸ª<code>åŒ…è£…åœ¨ä¸Šä¸‹æ–‡çš„å€¼</code></strong>ï¼š</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> None &#123;</span><br><span class="line">  <span class="keyword">static</span> apply(fn: <span class="built_in">any</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> None;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> Just&lt;T&gt; &#123;</span><br><span class="line">  <span class="comment">// ä½¿ç”¨æ–¹æ³•é‡è½½ï¼Œè®©Typescriptæ›´å¥½æ¨æ–­</span></span><br><span class="line">  <span class="comment">// å¦‚æœå€¼å’Œå‡½æ•°éƒ½æ˜¯Justç±»å‹ï¼Œç»“æœä¹Ÿæ˜¯Justç±»å‹</span></span><br><span class="line">  apply&lt;U&gt;<span class="function">(<span class="params">fn: Just&lt;(<span class="params">a: T</span>) =&gt; U&gt;</span>): <span class="params">Just</span>&lt;<span class="params">U</span>&gt;;</span></span><br><span class="line"><span class="function">  // å¦‚æœå‡½æ•°æ˜¯<span class="params">Nothing</span>ç±»å‹ï¼Œç»“æœæ˜¯<span class="params">Nothing</span>.</span></span><br><span class="line"><span class="function">  // ä¸¥æ ¼ä¸Š<span class="params">apply</span>åªåº”è¯¥æ¥æ”¶åŒä¸€ä¸ªä¸Šä¸‹æ–‡ç±»å‹çš„å‡½æ•°ï¼Œå³<span class="params">Just</span>,</span></span><br><span class="line"><span class="function">  // å› ä¸º<span class="params">Maybe</span>æ˜¯<span class="params">Typescript</span>çš„<span class="params">Union</span>ç±»å‹ï¼Œæ²¡åŠæ³•ç»™å®ƒæ‰©å±•æ–¹æ³•ï¼Œè¿™é‡Œå°†<span class="params">Maybe</span>å’Œ<span class="params">Just</span>æ··åœ¨ä¸€èµ·äº†</span></span><br><span class="line"><span class="function">  <span class="params">apply</span>&lt;<span class="params">U</span>&gt;(<span class="params">fn: Nothing</span>): <span class="params">Nothing</span>;</span></span><br><span class="line"><span class="function">  // å¦‚æœå€¼å’Œå‡½æ•°éƒ½æ˜¯<span class="params">Maybe</span>ç±»å‹, è¿”å›ä¸€ä¸ª<span class="params">Maybe</span>ç±»å‹</span></span><br><span class="line"><span class="function">  <span class="params">apply</span>&lt;<span class="params">U</span>&gt;(<span class="params">fn: Maybe&lt;(<span class="params">a: T</span>) =&gt; U&gt;</span>): <span class="params">Maybe</span>&lt;<span class="params">U</span>&gt; &#123;</span></span><br><span class="line"><span class="function">    <span class="params">if</span> (<span class="params">!isNothing(<span class="params">fn</span>)</span>) &#123;</span></span><br><span class="line"><span class="function">      <span class="params">return</span> <span class="params">Just</span>.<span class="params">of</span>(<span class="params">fn.value(<span class="params"><span class="keyword">this</span>.value</span>)</span>);</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function">    <span class="params">return</span> <span class="params">None</span>.<span class="params">apply</span>(<span class="params">fn</span>);</span></span><br><span class="line"><span class="function">  &#125;</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure><p><br></p><p>å†æ¥çœ‹çœ‹æ•°ç»„:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä»…ä½œç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">interface</span> Array&lt;T&gt; &#123;</span><br><span class="line">  apply&lt;U&gt;<span class="function">(<span class="params">fns: <span class="built_in">Array</span>&lt;(<span class="params">e: T</span>) =&gt; U&gt;</span>): <span class="params">U</span>[]</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">// æ¥æ”¶ä¸€ä¸ªå‡½æ•°â€˜æ•°ç»„(<span class="params">ä¸Šä¸‹æ–‡</span>)â€™ï¼Œè¿”å›ä¸€ä¸ªåº”ç”¨äº†â€˜å‡½æ•°â€™çš„æ–°çš„æ•°ç»„</span></span><br><span class="line"><span class="function"><span class="params">Array</span>.<span class="params">prototype</span>.<span class="params">apply</span> = <span class="params">function</span>&lt;<span class="params">T</span>, <span class="params">U</span>&gt;(<span class="params">fns: <span class="built_in">Array</span>&lt;(<span class="params">e: T</span>) =&gt; U&gt;</span>) &#123;</span></span><br><span class="line"><span class="function">  <span class="params">const</span> <span class="params">res</span>: <span class="params">U</span>[] = []</span></span><br><span class="line"><span class="function">  <span class="params">for</span> (<span class="params"><span class="keyword">const</span> fn of fns</span>) &#123;</span></span><br><span class="line"><span class="function">    <span class="params">this</span>.<span class="params">forEach</span>(<span class="params">el =&gt; res.push(<span class="params">fn(<span class="params">el</span>)</span>)</span>)</span></span><br><span class="line"><span class="function">  &#125;</span></span><br><span class="line"><span class="function">  <span class="params">return</span> <span class="params">res</span></span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure><p><br></p><p>åœ¨Haskellä¸­ï¼Œä½¿ç”¨<code>&lt;*&gt;</code>æ¥è¡¨ç¤ºapplyæ“ä½œ: <code>Just (+3) &lt;*&gt; Just 2 == Just 5</code>. Typescriptä¸æ”¯æŒæ“ä½œç¬¦é‡è½½ï¼Œæ‰€ä»¥å¿½ç•¥.</p><p>Justç±»å‹çš„Applicativeåº”ç”¨å›¾è§£ï¼š</p><p><img src="/images/ts-fam/applicative_just.png" alt></p><p>æ•°ç»„ç±»å‹çš„Applicativeåº”ç”¨å›¾è§£ï¼š</p><p><img src="/images/ts-fam/applicative_list.png" alt></p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> num: <span class="built_in">number</span>[] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"><span class="built_in">console</span>.log(num.apply([multiply2, add3]))</span><br><span class="line"><span class="comment">// [2, 4, 6, 4, 5, 6]</span></span><br></pre></td></tr></table></figure><p><strong>è¿™é‡Œæœ‰ Applicative èƒ½åšåˆ°è€Œ Functor ä¸èƒ½åšåˆ°çš„äº‹æƒ…</strong>ã€‚ å¦‚ä½•å°†ä¸€ä¸ªæ¥å—ä¸¤ä¸ªå‚æ•°çš„å‡½æ•°åº”ç”¨åˆ°ä¸¤ä¸ªå·²åŒ…è£…çš„å€¼ä¸Šï¼Ÿ</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä¸€ä¸ªæ”¯æŒä¸¤ä¸ªå‚æ•°çš„Curryå‹åŠ æ³•å‡½æ•°</span></span><br><span class="line"><span class="keyword">const</span> curriedAddition = <span class="function">(<span class="params">a: <span class="built_in">number</span></span>) =&gt;</span> (b: <span class="built_in">number</span>) =&gt; a + b</span><br><span class="line"></span><br><span class="line">Just.of(<span class="number">5</span>).fmap(curriedAddition) <span class="comment">// è¿”å› `Just.of((b: number) =&gt; 5 + b)`</span></span><br><span class="line"><span class="comment">// Ok ç»§ç»­</span></span><br><span class="line">Just.of(<span class="number">4</span>).fmap(Just.of(<span class="function">(<span class="params">b: <span class="built_in">number</span></span>) =&gt;</span> <span class="number">5</span> + b))  <span class="comment">// âŒä¸è¡Œäº†ï¼ŒæŠ¥é”™äº†ï¼ŒFunctoræ²¡åŠæ³•å¤„ç†åŒ…è£…åœ¨ä¸Šä¸‹æ–‡çš„fn</span></span><br></pre></td></tr></table></figure><p>ä½†æ˜¯Applicativeå¯ä»¥ï¼š</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line">Just.of(<span class="number">5</span>).fmap(curriedAddition) <span class="comment">// è¿”å› `Just.of((b: number) =&gt; 5 + b)`</span></span><br><span class="line"><span class="comment">// âœ…å½“å½“å½“</span></span><br><span class="line">Just.of(<span class="number">3</span>).apply(Just.of(<span class="function">(<span class="params">b: <span class="built_in">number</span></span>) =&gt;</span> <span class="number">5</span> + b)) <span class="comment">// Just.of(8)</span></span><br></pre></td></tr></table></figure><p>è¿™æ—¶å€™Applicative æŠŠ Functor æ¨åˆ°ä¸€è¾¹ã€‚ â€œå¤§äººç‰©å¯ä»¥ä½¿ç”¨å…·æœ‰ä»»æ„æ•°é‡å‚æ•°çš„å‡½æ•°ï¼Œâ€å®ƒè¯´ã€‚ â€œè£…å¤‡äº† &lt;$&gt;(fmap) ä¸ &lt;*&gt;(apply) ä¹‹åï¼Œæˆ‘å¯ä»¥æ¥å—å…·æœ‰ä»»æ„ä¸ªæ•°æœªåŒ…è£…å€¼å‚æ•°çš„ä»»æ„å‡½æ•°ã€‚ ç„¶åæˆ‘ä¼ ç»™å®ƒæ‰€æœ‰å·²åŒ…è£…çš„å€¼ï¼Œè€Œæˆ‘ä¼šå¾—åˆ°ä¸€ä¸ªå·²åŒ…è£…çš„å€¼å‡ºæ¥ï¼ å•Šå•Šå•Šå•Šå•Šï¼â€</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line">Just.of(<span class="number">3</span>).apply(Just.of(<span class="number">5</span>).fmap(curriedAddition)) <span class="comment">// è¿”å› `Just.of(8)`</span></span><br></pre></td></tr></table></figure><p><br></p><h3 id="applicativeæ€»ç»“"><a href="#applicativeæ€»ç»“" class="headerlink" title="Applicativeæ€»ç»“"></a>Applicativeæ€»ç»“</h3><p>æˆ‘ä»¬é‡ç”³ä¸€ä¸ªApplicativeçš„å®šä¹‰, <strong>å¦‚æœFunctorè¦æ±‚å®ç°fmapçš„è¯ï¼ŒApplicativeå°±æ˜¯è¦æ±‚å®ç°apply</strong>ï¼Œapplyç¬¦åˆä»¥ä¸‹å®šä¹‰:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// è¿™æ˜¯Functorçš„fmapå®šä¹‰</span><br><span class="line">&lt;Functor T&gt;.fmap(fn: (v: T) =&gt; U): &lt;Functor U&gt;</span><br><span class="line"></span><br><span class="line">// è¿™æ˜¯Applicativeçš„applyå®šä¹‰ï¼Œå’Œä¸Šé¢å¯¹æ¯”ï¼Œfnå˜æˆäº†ä¸€ä¸ªåŒ…è£…åœ¨ä¸Šä¸‹æ–‡çš„å‡½æ•°</span><br><span class="line">&lt;Applicative T&gt;.apply(fn: &lt;Applicative (v: T) =&gt; U&gt;): &lt;Applicative U&gt;</span><br></pre></td></tr></table></figure><p><br><br><br></p><h2 id="monad"><a href="#monad" class="headerlink" title="Monad"></a>Monad</h2><p>ç»ˆäºç»ƒåˆ°ä¸‰é‡å¤©äº†ï¼ç»§ç»­â›½åŠ æ²¹ï¸</p><p>å¦‚ä½•å­¦ä¹  Monad å‘¢ï¼š</p><ol><li>ä½ è¦å–å¾—è®¡ç®—æœºç§‘å­¦åšå£«å­¦ä½ã€‚</li><li>ç„¶åæŠŠå®ƒæ‰”æ‰ï¼Œå› ä¸ºåœ¨æœ¬æ–‡ä½ å¹¶ä¸éœ€è¦å®ƒï¼</li></ol><p>Monad å¢åŠ äº†ä¸€ä¸ªæ–°çš„è½¬å˜ã€‚</p><p><code>Functor</code> å°†ä¸€ä¸ª<code>å‡½æ•°</code>åº”ç”¨åˆ°ä¸€ä¸ª<code>å·²åŒ…è£…çš„å€¼</code>ä¸Šï¼š</p><p><img src="/images/ts-fam/fmap.png" alt></p><p><code>Applicative</code> å°†ä¸€ä¸ª<code>å·²åŒ…è£…çš„å‡½æ•°</code>åº”ç”¨åˆ°ä¸€ä¸ª<code>å·²åŒ…è£…çš„å€¼</code>ä¸Šï¼š</p><p><img src="/images/ts-fam/applicative.png" alt></p><p>Monad å°†ä¸€ä¸ª<code>è¿”å›å·²åŒ…è£…å€¼çš„å‡½æ•°</code>åº”ç”¨åˆ°ä¸€ä¸ª<code>å·²åŒ…è£…çš„å€¼</code>ä¸Šã€‚ Monad å®šä¹‰ä¸€ä¸ªå‡½æ•°<code>flatMap</code>ï¼ˆåœ¨ Haskell ä¸­æ˜¯ä½¿ç”¨æ“ä½œç¬¦ <code>&gt;&gt;=</code> æ¥åº”ç”¨Monadï¼Œè¯»ä½œâ€œbindâ€ï¼‰æ¥åšè¿™ä¸ªã€‚</p><p>è®©æˆ‘ä»¬æ¥çœ‹ä¸ªç¤ºä¾‹ã€‚ è€æ­æ¡£ Maybe æ˜¯ä¸€ä¸ª Monadï¼š</p><p><img src="/images/ts-fam/context.png" alt></p><p>å‡è®¾ <code>half</code> æ˜¯ä¸€ä¸ªåªé€‚ç”¨äºå¶æ•°çš„å‡½æ•°ï¼š</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è¿™å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„: "è¿”å›å·²åŒ…è£…å€¼"çš„å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">half</span>(<span class="params">value: <span class="built_in">number</span></span>): <span class="title">Maybe</span>&lt;<span class="title">number</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (value % <span class="number">2</span> === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> Just.of(value / <span class="number">2</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> None</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/images/ts-fam/half.png" alt></p><p>å¦‚æœæˆ‘ä»¬å–‚ç»™å®ƒä¸€ä¸ª<code>å·²åŒ…è£…çš„å€¼</code>ä¼šæ€æ ·ï¼Ÿ</p><p><img src="/images/ts-fam/half_ouch.png" alt></p><p>æˆ‘ä»¬éœ€è¦ä½¿ç”¨flatMap(Haskell ä¸­çš„&gt;&gt;=)æ¥å°†æˆ‘ä»¬å·²åŒ…è£…çš„å€¼å¡è¿›è¯¥å‡½æ•°ã€‚ è¿™æ˜¯ &gt;&gt;= çš„ç…§ç‰‡ï¼š</p><p><img src="/images/ts-fam/plunger.jpg" alt></p><p>ä»¥ä¸‹æ˜¯å®ƒçš„å·¥ä½œæ–¹å¼ï¼š</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line">Just.of(<span class="number">3</span>).flatMap(half) <span class="comment">// =&gt; Nothing, Haskellä¸­ä½¿ç”¨æ“ä½œç¬¦è¿™æ ·æ“ä½œ: Just 3 &gt;&gt;= half</span></span><br><span class="line">Just.of(<span class="number">4</span>).flatMap(half) <span class="comment">// =&gt; Just 2</span></span><br><span class="line">None.flatMap(half)       <span class="comment">// =&gt; Nothing</span></span><br></pre></td></tr></table></figure><p>å†…éƒ¨å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿæˆ‘ä»¬å†çœ‹çœ‹flatMapçš„æ–¹æ³•ç­¾å:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Maybe</span></span><br><span class="line">Maybe&lt;T&gt;.flatMap&lt;U&gt;<span class="function">(<span class="params">fn: (<span class="params">val: T</span>) =&gt; Maybe&lt;U&gt;</span>): <span class="params">Maybe</span>&lt;<span class="params">U</span>&gt;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">// <span class="params">Array</span></span></span><br><span class="line"><span class="function"><span class="params">Array</span>&lt;<span class="params">T</span>&gt;.<span class="params">flatMap</span>&lt;<span class="params">U</span>&gt;(<span class="params">fn: (<span class="params">val: T</span>) =&gt; U[]</span>): <span class="params">U</span>[]</span></span><br></pre></td></tr></table></figure><p><img src="/images/ts-fam/bind_def.png" alt></p><p><strong>Arrayæ˜¯ä¸€ä¸ªMonad</strong>, Javascriptçš„Arrayçš„flatMapå·²ç»æ­£å¼æˆä¸ºæ ‡å‡†ï¼Œ çœ‹çœ‹å®ƒçš„ä½¿ç”¨ç¤ºä¾‹:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> arr1 = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>];</span><br><span class="line">arr1.map(<span class="function"><span class="params">x</span> =&gt;</span> [x * <span class="number">2</span>]); </span><br><span class="line"><span class="comment">// [[2], [4], [6], [8]]</span></span><br><span class="line"></span><br><span class="line">arr1.flatMap(<span class="function"><span class="params">x</span> =&gt;</span> [x * <span class="number">2</span>]);</span><br><span class="line"><span class="comment">// [2, 4, 6, 8]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// only one level is flattened</span></span><br><span class="line">arr1.flatMap(<span class="function"><span class="params">x</span> =&gt;</span> [[x * <span class="number">2</span>]]);</span><br><span class="line"><span class="comment">// [[2], [4], [6], [8]]</span></span><br></pre></td></tr></table></figure><p><br></p><p>Maybe ä¹Ÿæ˜¯ä¸€ä¸ª Monadï¼š</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> None &#123;</span><br><span class="line">  <span class="keyword">static</span> flatMap(fn: <span class="built_in">any</span>): Nothing &#123;</span><br><span class="line">    <span class="keyword">return</span> None;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> Just&lt;T&gt; &#123;</span><br><span class="line">  <span class="comment">// å’Œä¸Šé¢çš„applyå·®ä¸å¤š</span></span><br><span class="line">  <span class="comment">// ä½¿ç”¨æ–¹æ³•é‡è½½ï¼Œè®©Typescriptæ›´å¥½æ¨æ–­</span></span><br><span class="line">  <span class="comment">// å¦‚æœå‡½æ•°è¿”å›Justç±»å‹ï¼Œç»“æœä¹Ÿæ˜¯Justç±»å‹</span></span><br><span class="line">  flatMap&lt;U&gt;<span class="function">(<span class="params">fn: (<span class="params">a: T</span>) =&gt; Just&lt;U&gt;</span>): <span class="params">Just</span>&lt;<span class="params">U</span>&gt;;</span></span><br><span class="line"><span class="function">  // å¦‚æœå‡½æ•°è¿”å›å€¼æ˜¯<span class="params">Nothing</span>ç±»å‹ï¼Œç»“æœæ˜¯<span class="params">Nothing</span>.</span></span><br><span class="line"><span class="function">  <span class="params">flatMap</span>&lt;<span class="params">U</span>&gt;(<span class="params">fn: (<span class="params">a: T</span>) =&gt; Nothing</span>): <span class="params">Nothing</span>;</span></span><br><span class="line"><span class="function">  // å¦‚æœå‡½æ•°è¿”å›å€¼æ˜¯<span class="params">Maybe</span>ç±»å‹, è¿”å›ä¸€ä¸ª<span class="params">Maybe</span>ç±»å‹</span></span><br><span class="line"><span class="function">  <span class="params">flatMap</span>&lt;<span class="params">U</span>&gt;(<span class="params">fn: (<span class="params">a: T</span>) =&gt; Maybe&lt;U&gt;</span>): <span class="params">Maybe</span>&lt;<span class="params">U</span>&gt; &#123;</span></span><br><span class="line"><span class="function">    <span class="params">return</span> <span class="params">fn</span>(<span class="params"><span class="keyword">this</span>.value</span>)</span></span><br><span class="line"><span class="function">  &#125;</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">// ç¤ºä¾‹</span></span><br><span class="line"><span class="function"><span class="params">Just</span>.<span class="params">of</span>(<span class="params">3</span>).<span class="params">flatMap</span>(<span class="params">half</span>) // <span class="params">Nothing</span></span></span><br><span class="line"><span class="function"><span class="params">Just</span>.<span class="params">of</span>(<span class="params">4</span>).<span class="params">flatMap</span>(<span class="params">half</span>) // <span class="params">Just</span>.<span class="params">of</span>(<span class="params">4</span>)</span></span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸ Just 3 è¿ä½œçš„æƒ…å†µï¼</p><p><img src="/images/ts-fam/monad_just.png" alt></p><p>å¦‚æœä¼ å…¥ä¸€ä¸ª Nothing å°±æ›´ç®€å•äº†ï¼š</p><p><img src="/images/ts-fam/monad_nothing.png" alt></p><p>ä½ è¿˜å¯ä»¥å°†è¿™äº›è°ƒç”¨ä¸²è”èµ·æ¥ï¼š</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line">Just.of(<span class="number">20</span>).flatMap(half).flatMap(half).flatMap(falf) <span class="comment">// =&gt; Nothing</span></span><br></pre></td></tr></table></figure><p><img src="/images/ts-fam/monad_chain.png" alt><br><img src="/images/ts-fam/whoa.png" alt></p><p><br></p><p>å¾ˆç‚«é…·å“ˆï¼æ‰€ä»¥æˆ‘ä»¬ç°åœ¨çŸ¥é“Maybeæ—¢æ˜¯ä¸€ä¸ªFunctorã€Applicativeï¼Œè¿˜æ˜¯ä¸€ä¸ªMonadã€‚</p><p>åŸæ–‡è¿˜ç¤ºèŒƒäº†å¦ä¸€ä¸ªä¾‹å­: <code>IO</code> Monad, æˆ‘ä»¬è¿™é‡Œå°±ç®€å•äº†è§£ä¸€ä¸‹</p><p><img src="/images/ts-fam/io.png" alt></p><p>IOçš„ç­¾åå¤§æ¦‚å¦‚ä¸‹:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> IO&lt;T&gt; &#123;</span><br><span class="line">  val: T</span><br><span class="line">  <span class="comment">// å…·ä½“å®ç°æˆ‘ä»¬æš‚ä¸å…³å¿ƒ</span></span><br><span class="line">  flatMap(fn: <span class="function">(<span class="params">val: T</span>) =&gt;</span> IO&lt;U&gt;): IO&lt;U&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…·ä½“æ¥çœ‹ä¸‰ä¸ªå‡½æ•°ã€‚ getLine æ²¡æœ‰å‚æ•°, ç”¨æ¥è·å–ç”¨æˆ·è¾“å…¥ï¼š</p><p><img src="/images/ts-fam/getLine.png" alt></p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getLine</span>(<span class="params"></span>): <span class="title">IO</span>&lt;<span class="title">string</span>&gt;</span></span><br></pre></td></tr></table></figure><p>readFile æ¥å—ä¸€ä¸ªå­—ç¬¦ä¸²ï¼ˆæ–‡ä»¶åï¼‰å¹¶è¿”å›è¯¥æ–‡ä»¶çš„å†…å®¹ï¼š</p><p><img src="/images/ts-fam/readFile.png" alt></p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">readFile</span>(<span class="params">filename: <span class="built_in">string</span></span>): <span class="title">IO</span>&lt;<span class="title">string</span>&gt;</span></span><br></pre></td></tr></table></figure><p>putStrLn è¾“å‡ºå­—ç¬¦ä¸²åˆ°æ§åˆ¶å°ï¼š</p><p><img src="/images/ts-fam/putStrLn.png" alt></p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">putStrLn</span>(<span class="params">str: <span class="built_in">string</span></span>): <span class="title">IO</span>&lt;<span class="title">void</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æ‰€æœ‰è¿™ä¸‰ä¸ªå‡½æ•°éƒ½æ¥å—æ™®é€šå€¼ï¼ˆæˆ–æ— å€¼ï¼‰å¹¶è¿”å›ä¸€ä¸ªå·²åŒ…è£…çš„å€¼ï¼Œå³IOã€‚ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ flatMap å°†å®ƒä»¬ä¸²è”èµ·æ¥ï¼</p><p><img src="/images/ts-fam/monad_io.png" alt></p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line">getLine().flatMap(readFile).flatMap(putStrLn)</span><br></pre></td></tr></table></figure><p>å¤ªæ£’äº†ï¼ å‰æ’å åº§æ¥çœ‹ monad å±•ç¤ºï¼æˆ‘ä»¬ä¸éœ€è¦åœ¨å–æ¶ˆåŒ…è£…å’Œé‡æ–°åŒ…è£… IO monad çš„å€¼ä¸Šæµªè´¹æ—¶é—´. flatMap ä¸ºæˆ‘ä»¬åšäº†é‚£äº›å·¥ä½œ!</p><p>Haskell è¿˜ä¸º monad æä¾›äº†è¯­æ³•ç³–, å«åš do è¡¨è¾¾å¼:</p><figure class="highlight haskell"><table><tr><td class="code"><pre><span class="line"><span class="title">foo</span> = <span class="keyword">do</span></span><br><span class="line">    filename &lt;- getLine</span><br><span class="line">    contents &lt;- readFile filename</span><br><span class="line">    putStrLn contents</span><br></pre></td></tr></table></figure><p><br></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ol><li>functor æ˜¯å®ç°äº† <code>fmap</code> çš„æ•°æ®ç±»å‹ã€‚</li><li>applicative æ˜¯å®ç°äº† <code>apply</code> çš„æ•°æ®ç±»å‹ã€‚</li><li>monad æ˜¯å®ç°äº† <code>flatMap</code> çš„æ•°æ®ç±»å‹ã€‚</li><li>Maybe å®ç°äº†è¿™ä¸‰è€…ï¼Œæ‰€ä»¥å®ƒæ˜¯ functorã€ applicativeã€ ä»¥åŠ monadã€‚</li></ol><p>è¿™ä¸‰è€…æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ</p><p><img src="/images/ts-fam/recap.png" alt></p><ol><li><strong>functor</strong>: å¯é€šè¿‡ fmap å°†ä¸€ä¸ª<code>å‡½æ•°</code>åº”ç”¨åˆ°ä¸€ä¸ª<code>å·²åŒ…è£…çš„å€¼</code>ä¸Šã€‚</li><li><strong>applicative</strong>: å¯é€šè¿‡ apply å°†ä¸€ä¸ª<code>å·²åŒ…è£…çš„å‡½æ•°</code>åº”ç”¨åˆ°<code>å·²åŒ…è£…çš„å€¼</code>ä¸Šã€‚</li><li><strong>monad</strong>: å¯é€šè¿‡ flatMap å°†ä¸€ä¸ª<code>è¿”å›å·²åŒ…è£…å€¼çš„å‡½æ•°</code>åº”ç”¨åˆ°<code>å·²åŒ…è£…çš„å€¼</code>ä¸Šã€‚</li></ol><p>ç»¼åˆèµ·æ¥çœ‹çœ‹å®ƒä»¬çš„ç­¾åï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// è¿™æ˜¯Functorçš„fmapå®šä¹‰</span><br><span class="line">&lt;Functor T&gt;.fmap(fn: (v: T) =&gt; U): &lt;Functor U&gt;</span><br><span class="line"></span><br><span class="line">// è¿™æ˜¯Applicativeçš„applyå®šä¹‰ï¼Œå’Œä¸Šé¢å¯¹æ¯”ï¼Œfnå˜æˆäº†ä¸€ä¸ªåŒ…è£…åœ¨ä¸Šä¸‹æ–‡çš„å‡½æ•°</span><br><span class="line">&lt;Applicative T&gt;.apply(fn: &lt;Applicative (v: T) =&gt; U&gt;): &lt;Applicative U&gt;</span><br><span class="line"></span><br><span class="line">// Monadçš„å®šä¹‰, è€Œæ¥å—ä¸€ä¸ªå‡½æ•°ï¼Œ è¿™ä¸ªå‡½æ•°è¿”å›ä¸€ä¸ªåŒ…è£…åœ¨ä¸Šä¸‹æ–‡çš„å€¼</span><br><span class="line">&lt;Monad T&gt;.flatmap(fn: (v: T) =&gt; &lt;Monad U&gt;): &lt;Monad U&gt;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥ï¼Œäº²çˆ±çš„æœ‹å‹ï¼ˆæˆ‘è§‰å¾—æˆ‘ä»¬ç°åœ¨æ˜¯æœ‹å‹äº†ï¼‰ï¼Œæˆ‘æƒ³æˆ‘ä»¬éƒ½åŒæ„ monad æ˜¯ä¸€ä¸ªç®€å•ä¸”é«˜æ˜çš„ä¸»æ„ï¼ˆSMART IDEA(tm)ï¼‰ã€‚ ç°åœ¨ä½ å·²ç»é€šè¿‡è¿™ç¯‡æŒ‡å—æ¶¦æ¹¿äº†ä½ çš„å£å“¨ï¼Œä¸ºä»€ä¹ˆä¸æ‹‰ä¸Š Mel Gibson å¹¶æŠ“ä½æ•´ä¸ªç“¶å­å‘¢ã€‚ å‚é˜…ã€ŠHaskell è¶£å­¦æŒ‡å—ã€‹çš„ã€Šæ¥çœ‹çœ‹å‡ ç§ Monadã€‹ã€‚ å¾ˆå¤šä¸œè¥¿æˆ‘å…¶å®æ©é¥°äº†å› ä¸º Miran æ·±å…¥è¿™æ–¹é¢åšå¾—å¾ˆæ£’.</p><p><br></p><h2 id="æ‰©å±•"><a href="#æ‰©å±•" class="headerlink" title="æ‰©å±•"></a>æ‰©å±•</h2><p>æœ¬æ–‡åœ¨<a href="http://adit.io/posts/2013-04-17-functors,_applicatives,_and_monads_in_pictures.html" target="_blank" rel="noopener">åŸæ–‡</a>çš„åŸºç¡€ä¸Š, å‚è€ƒäº†ä¸‹åˆ—è¿™äº›ç¿»è¯‘ç‰ˆæœ¬ï¼Œå†æ¬¡æ„Ÿè°¢è¿™äº›ä½œè€…:</p><ul><li><a href="http://adit.io/posts/2013-04-17-functors,_applicatives,_and_monads_in_pictures.html#translations" target="_blank" rel="noopener">Functors, Applicatives, And Monads In Pictures</a> - åŸæ–‡</li><li><a href="http://www.mokacoding.com/blog/functor-applicative-monads-in-pictures/" target="_blank" rel="noopener">Swift Functors, Applicatives, and Monads in Pictures</a> - Swiftç‰ˆæœ¬, æœ¬æ–‡ä¸»è¦å‚è€ƒè¿™ç¯‡æ–‡ç« </li><li><a href="https://hltj.me/kotlin/2017/08/25/kotlin-functor-applicative-monad-cn.html" target="_blank" rel="noopener">Kotlin ç‰ˆå›¾è§£ Functorã€Applicative ä¸ Monad</a> - Kotlinç‰ˆæœ¬ï¼Œç¿»è¯‘éå¸¸æ£’</li><li><a href="http://jiyinyiyong.github.io/monads-in-pictures/" target="_blank" rel="noopener">Functor, Applicative, ä»¥åŠ Monad çš„å›¾ç‰‡é˜é‡Š</a> - ä¸­æ–‡ç‰ˆæœ¬ï¼Œ<strong>é¢˜å¶</strong>ç¿»è¯‘</li><li><a href="https://medium.com/@lettier/your-easy-guide-to-monads-applicatives-functors-862048d61610" target="_blank" rel="noopener">Your easy guide to Monads, Applicatives, &amp; Functors</a> - Mediumä¸Šä¸€ç¯‡åŠ¨å›¾å›¾è§£Monadçš„æ–‡ç« ï¼Œå†™å¾—ä¹Ÿä¸é”™. è¯»å®Œæœ¬æ–‡å¯ä»¥å†è¯»è¿™ç¯‡æ–‡ç« </li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æœ¬æ–‡æ˜¯ç»å…¸çš„&lt;a href=&quot;http://adit.io/posts/2013-04-17-functors,_applicatives,_and_monads_in_pictures.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Functo
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://bobi.ink/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>2019å¹´äº†ï¼Œæ•´ç†äº†Nä¸ªå®ç”¨æ¡ˆä¾‹å¸®ä½ å¿«é€Ÿè¿ç§»åˆ°React Hooks(æ”¶è—æ…¢æ…¢çœ‹ç³»åˆ—)</title>
    <link href="https://bobi.ink/2019/08/10/react-hooks/"/>
    <id>https://bobi.ink/2019/08/10/react-hooks/</id>
    <published>2019-08-09T16:00:00.000Z</published>
    <updated>2019-08-18T06:14:32.162Z</updated>
    
    <content type="html"><![CDATA[<p><br></p><p><img src="/images/react-hooks/cover.png" alt></p><p><br></p><p>åœ¨<a href="https://www.youtube.com/channel/UCz5vTaEhvh7dOHEyd1efcaQ" target="_blank" rel="noopener">React Conf 2018</a>å®£å¸ƒReact Hooksåï¼Œæˆ‘ç¬¬ä¸€æ—¶é—´å¼€å§‹å°è¯•ä½¿ç”¨React Hooksï¼Œç°åœ¨æ–°é¡¹ç›®åŸºæœ¬ä¸å†™Classç»„ä»¶äº†ã€‚å¯¹æˆ‘æ¥è¯´ï¼Œå®ƒç¡®å®è®©æˆ‘çš„å¼€å‘æ•ˆç‡æé«˜äº†å¾ˆå¤šï¼Œæ”¹å˜äº†å·²æœ‰çš„ç»„ä»¶å¼€å‘æ€ç»´å’Œæ¨¡å¼.</p><p>æˆ‘åœ¨<a href="https://juejin.im/post/5cdc2f54e51d453b0c35930d#heading-3" target="_blank" rel="noopener">Reactç»„ä»¶è®¾è®¡å®è·µæ€»ç»“04 - ç»„ä»¶çš„æ€ç»´</a>ä¸­å·²ç»æ€»ç»“è¿‡<strong>React Hooksçš„æ„ä¹‰ï¼Œä»¥åŠä¸€äº›åº”ç”¨åœºæ™¯</strong>ã€‚</p><p>é‚£è¿™ç¯‡æ–‡ç« å°±å®Œå…¨æ˜¯ä»‹ç»<strong>React Hooksçš„åº”ç”¨å®ä¾‹</strong>ï¼Œåˆ—ä¸¾äº†æˆ‘ä½¿ç”¨React Hooksçš„ä¸€äº›å®è·µã€‚ å¸Œæœ›é€šè¿‡è¿™äº›æ¡ˆä¾‹ï¼Œå¯ä»¥å¸®åŠ©ä½ å¿«é€Ÿç†Ÿç»ƒï¼Œå¹¶è¿ç§»åˆ°React Hookså¼€å‘æ¨¡å¼. </p><blockquote><p><strong>æ–‡ç« ç¯‡å¹…å¾ˆé•¿ï¼Œå»ºè®®æ”¶è—ä¸çœ‹, è‡³å°‘çœ‹çœ‹ç›®å½•å§</strong></p></blockquote><p><br></p><p>æŠŠä¹‹å‰æ–‡ç« æ•´ç†çš„<code>React Hooksåº”ç”¨åœºæ™¯</code>æ€»ç»“æ‹¿è¿‡æ¥, æœ¬æ–‡åŸºæœ¬æŒ‰ç…§<strong>è¿™ä¸ªèŒƒå›´è¿›è¡Œç»„ç»‡</strong>:</p><p><img src="/images/react-hooks/apply.png" alt></p><p><br></p><p><strong>å¦‚æœä½ æƒ³è¦äº†è§£React Hooksçš„åŸç†å¯ä»¥é˜…è¯»è¿™äº›æ–‡ç« </strong>:</p><ul><li><a href="https://link.juejin.im/?target=https%3A%2F%2Fmedium.com%2F%40ryardley%2Freact-hooks-not-magic-just-arrays-cd4f1857236e" target="_blank" rel="noopener">React hooks: not magic, just arrays</a></li><li><a href="https://juejin.im/post/5cfa29e151882539c33e4f5e#heading-8" target="_blank" rel="noopener">ä»Preactä¸­äº†è§£ç»„ä»¶å’ŒhooksåŸºæœ¬åŸç†</a></li></ul><p><br></p><p><strong>ç›®å½•ç´¢å¼•</strong></p><!-- TOC --><ul><li><a href="#1-ç»„ä»¶çŠ¶æ€"><strong>1. ç»„ä»¶çŠ¶æ€</strong></a><ul><li><a href="#1-1-usesetstate-æ¨¡æ‹Ÿä¼ ç»Ÿçš„setstate">1-1 useSetState æ¨¡æ‹Ÿä¼ ç»Ÿçš„setState</a></li><li><a href="#1-2-usereducer-reduxé£æ ¼çŠ¶æ€ç®¡ç†">1-2 useReducer Reduxé£æ ¼çŠ¶æ€ç®¡ç†</a></li><li><a href="#1-3-useforceupdate-å¼ºåˆ¶é‡æ–°æ¸²æŸ“">1-3 useForceUpdate å¼ºåˆ¶é‡æ–°æ¸²æŸ“</a></li><li><a href="#1-4-usestorage-ç®€åŒ–localstorageå­˜å–">1-4 useStorage ç®€åŒ–localStorageå­˜å–</a></li><li><a href="#1-5-userefstate-å¼•ç”¨stateçš„æœ€æ–°å€¼">1-5 useRefState å¼•ç”¨stateçš„æœ€æ–°å€¼</a><ul><li><a href="#1-5-1-æ¯æ¬¡é‡æ–°æ¸²æŸ“éƒ½åˆ›å»ºé—­åŒ…ä¼šå½±å“æ•ˆç‡å—">1-5-1 æ¯æ¬¡é‡æ–°æ¸²æŸ“éƒ½åˆ›å»ºé—­åŒ…ä¼šå½±å“æ•ˆç‡å—?</a></li></ul></li><li><a href="#1-6-userefprops-å¼•ç”¨æœ€æ–°çš„props">1-6 useRefProps å¼•ç”¨æœ€æ–°çš„Props</a></li><li><a href="#1-7-useinstance-å®ä¾‹å˜é‡å­˜å–">1-7 useInstance â€˜å®ä¾‹â€™å˜é‡å­˜å–</a></li><li><a href="#1-9-useprevious-è·å–ä¸Šä¸€æ¬¡æ¸²æŸ“çš„å€¼">1-9 usePrevious è·å–ä¸Šä¸€æ¬¡æ¸²æŸ“çš„å€¼</a></li><li><a href="#1-10-useimmer-ç®€åŒ–ä¸å¯å˜æ•°æ®æ“ä½œ">1-10 useImmer ç®€åŒ–ä¸å¯å˜æ•°æ®æ“ä½œ</a></li><li><a href="#1-11-å°è£…å·¥å…·hooksç®€åŒ–stateçš„æ“ä½œ">1-11 å°è£…â€™å·¥å…·Hooksâ€™ç®€åŒ–Stateçš„æ“ä½œ</a><ul><li><a href="#1-11-1-usetoggle-å¼€å…³">1-11-1 useToggle å¼€å…³</a></li><li><a href="#1-11-2-usearray-ç®€åŒ–æ•°ç»„çŠ¶æ€æ“ä½œ">1-11-2 useArray ç®€åŒ–æ•°ç»„çŠ¶æ€æ“ä½œ</a></li></ul></li></ul></li><li><a href="#2-æ¨¡æ‹Ÿç”Ÿå‘½å‘¨æœŸå‡½æ•°"><strong>2. æ¨¡æ‹Ÿç”Ÿå‘½å‘¨æœŸå‡½æ•°</strong></a><ul><li><a href="#2-1-useonmount-æ¨¡æ‹Ÿcomponentdidmount">2-1 useOnMount æ¨¡æ‹ŸcomponentDidMount</a></li><li><a href="#2-2-useonunmount-æ¨¡æ‹Ÿcomponentwillunmount">2-2 useOnUnmount æ¨¡æ‹ŸcomponentWillUnmount</a></li><li><a href="#2-3-useonupdate-æ¨¡æ‹Ÿcomponentdidupdate">2-3 useOnUpdate æ¨¡æ‹ŸcomponentDidUpdate</a></li></ul></li><li><a href="#3-äº‹ä»¶å¤„ç†"><strong>3. äº‹ä»¶å¤„ç†</strong></a><ul><li><a href="#3-1-usechange-ç®€åŒ–onchangeè¡¨å•åŒå‘ç»‘å®š">3-1 useChange ç®€åŒ–onChangeè¡¨å•åŒå‘ç»‘å®š</a></li><li><a href="#3-2-usebind-ç»‘å®šå›è°ƒå‚æ•°">3-2 useBind ç»‘å®šå›è°ƒå‚æ•°</a></li><li><a href="#3-3-è‡ªå®šä¹‰äº‹ä»¶å°è£…">3-3 è‡ªå®šä¹‰äº‹ä»¶å°è£…</a><ul><li><a href="#3-3-1-useactive">3-3-1 useActive</a></li><li><a href="#3-3-2-usetouch-æ‰‹åŠ¿äº‹ä»¶å°è£…">3-3-2 useTouch æ‰‹åŠ¿äº‹ä»¶å°è£…</a></li><li><a href="#3-3-3-usedraggable-æ‹–æ‹½äº‹ä»¶å°è£…">3-3-3 useDraggable æ‹–æ‹½äº‹ä»¶å°è£…</a></li><li><a href="#3-3-4-react-events-é¢å‘æœªæ¥çš„é«˜çº§äº‹ä»¶å°è£…">3-3-4 react-events é¢å‘æœªæ¥çš„é«˜çº§äº‹ä»¶å°è£…</a></li></ul></li><li><a href="#3-4-usesubscription-é€šç”¨äº‹ä»¶æºè®¢é˜…">3-4 useSubscription é€šç”¨äº‹ä»¶æºè®¢é˜…</a></li><li><a href="#3-5-useobservable-hookså’Œrxjsä¼˜é›…çš„ç»“åˆrxjs-hooks">3-5 useObservable Hookså’ŒRxJSä¼˜é›…çš„ç»“åˆ(rxjs-hooks)</a></li><li><a href="#3-6-useeventemitter-å¯¹æ¥eventemitter">3-6 useEventEmitter å¯¹æ¥eventEmitter</a></li></ul></li><li><a href="#4-contextçš„å¦™ç”¨"><strong>4. Contextçš„å¦™ç”¨</strong></a><ul><li><a href="#4-1-usetheme-ä¸»é¢˜é…ç½®">4-1 useTheme ä¸»é¢˜é…ç½®</a></li><li><a href="#4-2-unstated-ç®€å•çŠ¶æ€ç®¡ç†å™¨">4-2 unstated ç®€å•çŠ¶æ€ç®¡ç†å™¨</a></li><li><a href="#4-3-usei18n-å›½é™…åŒ–">4-3 useI18n å›½é™…åŒ–</a></li><li><a href="#4-4-userouter-ç®€åŒ–è·¯ç”±çŠ¶æ€çš„è®¿é—®">4-4 useRouter ç®€åŒ–è·¯ç”±çŠ¶æ€çš„è®¿é—®</a></li><li><a href="#4-5-react-hook-form-hookså’Œè¡¨å•èƒ½æ“¦å‡ºä»€ä¹ˆç«èŠ±">4-5 react-hook-form Hookså’Œè¡¨å•èƒ½æ“¦å‡ºä»€ä¹ˆç«èŠ±?</a></li></ul></li><li><a href="#5-å‰¯ä½œç”¨å°è£…"><strong>5. å‰¯ä½œç”¨å°è£…</strong></a><ul><li><a href="#5-1-usetimeout-è¶…æ—¶ä¿®æ”¹çŠ¶æ€">5-1 useTimeout è¶…æ—¶ä¿®æ”¹çŠ¶æ€</a></li><li><a href="#5-2-useonlinestatus-ç›‘å¬åœ¨çº¿çŠ¶æ€">5-2 useOnlineStatus ç›‘å¬åœ¨çº¿çŠ¶æ€</a></li></ul></li><li><a href="#6-å‰¯ä½œç”¨è¡ç”Ÿ"><strong>6. å‰¯ä½œç”¨è¡ç”Ÿ</strong></a><ul><li><a href="#6-1-usetitle-è®¾ç½®æ–‡æ¡£title">6-1 useTitle è®¾ç½®æ–‡æ¡£title</a></li><li><a href="#6-2-usedebounce">6-2 useDebounce</a></li><li><a href="#6-3-usethrottle">6-3 useThrottle</a></li></ul></li><li><a href="#7-ç®€åŒ–ä¸šåŠ¡é€»è¾‘"><strong>7. ç®€åŒ–ä¸šåŠ¡é€»è¾‘</strong></a><ul><li><a href="#7-1-usepromise-å°è£…å¼‚æ­¥è¯·æ±‚">7-1 usePromise å°è£…å¼‚æ­¥è¯·æ±‚</a></li><li><a href="#7-2-usepromiseeffect-è‡ªåŠ¨è¿›è¡Œå¼‚æ­¥è¯·æ±‚">7-2 usePromiseEffect è‡ªåŠ¨è¿›è¡Œå¼‚æ­¥è¯·æ±‚</a></li><li><a href="#7-3-useinfinitelist-å®ç°æ— é™åŠ è½½åˆ—è¡¨">7-3 useInfiniteList å®ç°æ— é™åŠ è½½åˆ—è¡¨</a></li><li><a href="#7-4-usepoll-ç”¨hookå®ç°è½®è¯¢">7-4 usePoll ç”¨hookå®ç°è½®è¯¢</a></li><li><a href="#7-5-ä¸šåŠ¡é€»è¾‘æŠ½ç¦»">7-5 ä¸šåŠ¡é€»è¾‘æŠ½ç¦»</a></li></ul></li><li><a href="#8-å¼€è„‘æ´"><strong>8. å¼€è„‘æ´</strong></a><ul><li><a href="#8-1-usescript-hooks--suspend--â¤ï¸">8-1 useScript: Hooks + Suspend = â¤ï¸</a></li><li><a href="#8-2-usemodal-æ¨¡æ€æ¡†æ•°æ®æµç®¡ç†">8-2 useModal æ¨¡æ€æ¡†æ•°æ®æµç®¡ç†</a></li></ul></li><li><a href="#react-hooks-æŠ€æœ¯åœ°å›¾"><strong>React Hooks æŠ€æœ¯åœ°å›¾</strong></a></li><li><a href="#æ€»ç»“">æ€»ç»“</a></li></ul><!-- /TOC --><p><br></p><h2 id="1-ç»„ä»¶çŠ¶æ€"><a href="#1-ç»„ä»¶çŠ¶æ€" class="headerlink" title="1. ç»„ä»¶çŠ¶æ€"></a><strong>1. ç»„ä»¶çŠ¶æ€</strong></h2><p>Reactæä¾›äº†ä¸€ä¸ªå¾ˆåŸºæœ¬çš„ç»„ä»¶çŠ¶æ€è®¾ç½®Hook:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> [state, setState] = useState(initialState);</span><br></pre></td></tr></table></figure><p><a href="https://zh-hans.reactjs.org/docs/hooks-reference.html#usestate" target="_blank" rel="noopener">useState</a>è¿”å›<strong>ä¸€ä¸ªstateï¼Œä»¥åŠæ›´æ–°stateçš„å‡½æ•°</strong>. setStateå¯ä»¥æ¥å—ä¸€ä¸ªæ–°çš„å€¼ï¼Œä¼šè§¦å‘ç»„ä»¶é‡æ–°æ¸²æŸ“.</p><blockquote><p><strong>Reactä¼šç¡®ä¿setStateå‡½æ•°æ˜¯ç¨³å®šçš„ï¼Œä¸ä¼šåœ¨ç»„ä»¶é‡æ–°æ¸²æŸ“æ—¶æ”¹å˜</strong>ã€‚ä¸‹é¢çš„useReducerçš„dispatchå‡½æ•°ã€useRefçš„currentå±æ€§ä¹Ÿä¸€æ ·ã€‚<br><strong>è¿™å°±æ„å‘³ç€setStateã€dispatchã€ref.current, å¯ä»¥å®‰å…¨åœ°åœ¨useEffectã€useMemoã€ useCallbackä¸­å¼•ç”¨</strong></p></blockquote><p><br></p><h3 id="1-1-usesetstate-æ¨¡æ‹Ÿä¼ ç»Ÿçš„setstate"><a href="#1-1-usesetstate-æ¨¡æ‹Ÿä¼ ç»Ÿçš„setstate" class="headerlink" title="1-1 useSetState æ¨¡æ‹Ÿä¼ ç»Ÿçš„setState"></a>1-1 useSetState æ¨¡æ‹Ÿä¼ ç»Ÿçš„setState</h3><p>useStateå’ŒClassç»„ä»¶çš„setStateä¸å¤ªä¸€æ ·.</p><p>Classç»„ä»¶çš„stateå±æ€§ä¸€èˆ¬æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œè°ƒç”¨setStateæ—¶ï¼Œä¼šæµ…æ‹·è´åˆ°stateå±æ€§, å¹¶è§¦å‘æ›´æ–°, æ¯”å¦‚:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyComp</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  state = &#123;</span><br><span class="line">    name: <span class="string">'_sx_'</span>,</span><br><span class="line">    age: <span class="number">10</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  handleIncrementAge = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// åªæ›´æ–°age</span></span><br><span class="line">    <span class="keyword">this</span>.setState(&#123;<span class="attr">age</span>: <span class="keyword">this</span>.state.age + <span class="number">1</span>&#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>è€Œ<strong>useStateä¼šç›´æ¥è¦†ç›–stateå€¼</strong>ã€‚ä¸ºäº†å®ç°å’ŒsetStateä¸€æ ·çš„æ•ˆæœ, å¯ä»¥è¿™æ ·å­åš:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> initialState = &#123;name: <span class="string">'sx'</span>, age: <span class="number">10</span>&#125;</span><br><span class="line"><span class="keyword">const</span> MyComp: FC = <span class="function"><span class="params">props</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [state, setState] = useState(initialState)</span><br><span class="line">  <span class="keyword">const</span> handleIncrementAge = useCallback(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// setStateæ–¹æ³•æ”¯æŒæ¥æ”¶ä¸€ä¸ªå‡½æ•°ï¼Œé€šè¿‡è¿™ä¸ªå‡½æ•°å¯ä»¥è·å–æœ€æ–°çš„stateå€¼</span></span><br><span class="line">    <span class="comment">// ç„¶åä½¿ç”¨...æ“ä½œç¬¦å®ç°å¯¹è±¡æµ…æ‹·è´</span></span><br><span class="line">    setState(<span class="function">(<span class="params">prevState</span>) =&gt;</span> (&#123;...preState, age: prevState.age + <span class="number">1</span>&#125;) )</span><br><span class="line">  &#125;, [])</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>Okï¼Œç°åœ¨æŠŠå®ƒå°è£…æˆé€šç”¨çš„hooksï¼Œåœ¨å…¶ä»–ç»„ä»¶ä¸­å¤ç”¨ã€‚è¿™æ—¶å€™å°±ä½“ç°å‡ºæ¥Hookså¼ºå¤§çš„é€»è¾‘æŠ½è±¡èƒ½åŠ›ï¼š<strong>Hooks æ—¨åœ¨è®©ç»„ä»¶çš„å†…éƒ¨é€»è¾‘ç»„ç»‡æˆå¯å¤ç”¨çš„æ›´å°å•å…ƒï¼Œè¿™äº›å•å…ƒå„è‡ªç»´æŠ¤ä¸€éƒ¨åˆ†ç»„ä»¶â€˜çŠ¶æ€å’Œé€»è¾‘â€™</strong></p><p>çœ‹çœ‹æˆ‘ä»¬çš„<code>useSetState</code>, æˆ‘ä¼šä½¿ç”¨Typescriptè¿›è¡Œä»£ç ç¼–å†™:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useSetState</span>&lt;<span class="title">S</span> <span class="title">extends</span> <span class="title">object</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  initalState: S | ((</span>) =&gt; <span class="title">S</span>),</span></span><br><span class="line">): [S, (state: Partial&lt;S&gt; | ((state: S) =&gt; Partial&lt;S&gt;)) =&gt; void] &#123;</span><br><span class="line">  <span class="keyword">const</span> [_state, _setState] = useState&lt;S&gt;(initalState)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> setState = useCallback(<span class="function">(<span class="params">state: Partial&lt;S&gt; | ((state: S</span>) =&gt;</span> Partial&lt;S&gt;)) =&gt; &#123;</span><br><span class="line">    _setState(<span class="function">(<span class="params">prev: S</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> nextState = state</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> state === <span class="string">'function'</span>) &#123;</span><br><span class="line">        nextState = state(prev)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> &#123; ...prev, ...nextState &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> [_state, setState]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ------</span></span><br><span class="line"><span class="comment">// EXAMPLE</span></span><br><span class="line"><span class="comment">// ------</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">UseSetState</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [state, setState] = useSetState&lt;&#123; <span class="attr">name</span>: string; age: number &#125;&gt;(&#123; <span class="attr">name</span>: <span class="string">'sx'</span>, <span class="attr">age</span>: <span class="number">1</span> &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> incrementAge = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    setState(<span class="function"><span class="params">prev</span> =&gt;</span> (&#123; <span class="attr">age</span>: prev.age + <span class="number">1</span> &#125;))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div onClick=&#123;incrementAge&#125;&gt;</span><br><span class="line">      &#123;state.name&#125;: &#123;state.age&#125;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><blockquote><p>hookså‘½åä»¥<code>use</code>ä¸ºå‰ç¼€</p></blockquote><p><br></p><p><a href="#">â¤´ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="1-2-usereducer-reduxé£æ ¼çŠ¶æ€ç®¡ç†"><a href="#1-2-usereducer-reduxé£æ ¼çŠ¶æ€ç®¡ç†" class="headerlink" title="1-2 useReducer Reduxé£æ ¼çŠ¶æ€ç®¡ç†"></a>1-2 useReducer Reduxé£æ ¼çŠ¶æ€ç®¡ç†</h3><p>å¦‚æœç»„ä»¶çŠ¶æ€æ¯”è¾ƒå¤æ‚ï¼Œæ¨èä½¿ç”¨useReduceræ¥ç®¡ç†çŠ¶æ€ã€‚å¦‚æœä½ ç†Ÿæ‚‰Reduxï¼Œä¼šå¾ˆä¹ æƒ¯è¿™ç§æ–¹å¼ã€‚</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å®šä¹‰åˆå§‹çŠ¶æ€</span></span><br><span class="line"><span class="keyword">const</span> initialState = &#123;<span class="attr">count</span>: <span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®šä¹‰Reducer</span></span><br><span class="line"><span class="comment">// ruduceræ¥å—å½“å‰stateï¼Œä»¥åŠä¸€ä¸ªç”¨æˆ·æ“ä½œï¼Œè¿”å›ä¸€ä¸ª'æ–°'çš„state</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reducer</span>(<span class="params">state, action</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'increment'</span>:</span><br><span class="line">      <span class="keyword">return</span> &#123;<span class="attr">count</span>: state.count + <span class="number">1</span>&#125;;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'decrement'</span>:</span><br><span class="line">      <span class="keyword">return</span> &#123;<span class="attr">count</span>: state.count - <span class="number">1</span>&#125;;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// --------</span></span><br><span class="line"><span class="comment">// EXAMPLE</span></span><br><span class="line"><span class="comment">// --------</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Counter</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// è¿”å›stateï¼Œä»¥åŠdispatchå‡½æ•°</span></span><br><span class="line">  <span class="comment">// dispatchå‡½æ•°å¯ä»¥è§¦å‘reduceræ‰§è¡Œï¼Œç»™reducerä¼ é€’æŒ‡ä»¤å’Œè½½è·</span></span><br><span class="line">  <span class="keyword">const</span> [state, dispatch] = useReducer(reducer, initialState);</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;&gt;</span><br><span class="line">      Count: &#123;state.count&#125;</span><br><span class="line">      &lt;button onClick=&#123;() =&gt; dispatch(&#123;<span class="attr">type</span>: <span class="string">'increment'</span>&#125;)&#125;&gt;+<span class="xml"><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">      &lt;button onClick=&#123;() =&gt; dispatch(&#123;<span class="attr">type</span>: <span class="string">'decrement'</span>&#125;)&#125;&gt;-<span class="xml"><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">    &lt;<span class="regexp">/&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p>äº†è§£æ›´å¤šreducerçš„æ€æƒ³å¯ä»¥å‚è€ƒ<a href="https://redux.js.org/basics/reducers" target="_blank" rel="noopener">Reduxæ–‡æ¡£</a></p><p><br></p><p><a href="#">â¤´ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="1-3-useforceupdate-å¼ºåˆ¶é‡æ–°æ¸²æŸ“"><a href="#1-3-useforceupdate-å¼ºåˆ¶é‡æ–°æ¸²æŸ“" class="headerlink" title="1-3 useForceUpdate å¼ºåˆ¶é‡æ–°æ¸²æŸ“"></a>1-3 useForceUpdate å¼ºåˆ¶é‡æ–°æ¸²æŸ“</h3><p>Classç»„ä»¶å¯ä»¥é€šè¿‡<code>forceUpdate</code>å®ä¾‹æ–¹æ³•æ¥è§¦å‘å¼ºåˆ¶é‡æ–°æ¸²æŸ“ã€‚ä½¿ç”¨useStateä¹Ÿå¯ä»¥æ¨¡æ‹Ÿç›¸åŒçš„æ•ˆæœï¼š</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">useForceUpdate</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [, setValue] = useState(<span class="number">0</span>)</span><br><span class="line">  <span class="keyword">return</span> useCallback(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// é€’å¢stateå€¼ï¼Œå¼ºåˆ¶Reactè¿›è¡Œé‡æ–°æ¸²æŸ“</span></span><br><span class="line">    setValue(<span class="function"><span class="params">val</span> =&gt;</span> (val + <span class="number">1</span>) % (<span class="built_in">Number</span>.MAX_SAFE_INTEGER - <span class="number">1</span>))</span><br><span class="line">  &#125;, [])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -------</span></span><br><span class="line"><span class="comment">// EXAMPLE</span></span><br><span class="line"><span class="comment">// -------</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ForceUpdate</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> forceUpdate = useForceUpdate()</span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    somethingChange(forceUpdate)</span><br><span class="line">  &#125;, [])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p><a href="#">â¤´ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="1-4-usestorage-ç®€åŒ–localstorageå­˜å–"><a href="#1-4-usestorage-ç®€åŒ–localstorageå­˜å–" class="headerlink" title="1-4 useStorage ç®€åŒ–localStorageå­˜å–"></a>1-4 useStorage ç®€åŒ–localStorageå­˜å–</h3><p>é€šè¿‡è‡ªå®šä¹‰Hooksï¼Œå¯ä»¥å°†çŠ¶æ€ä»£ç†åˆ°å…¶ä»–æ•°æ®æºï¼Œæ¯”å¦‚localStorageã€‚ ä¸‹é¢æ¡ˆä¾‹å±•ç¤ºå¦‚æœä½¿ç”¨Hookså°è£…å’Œç®€åŒ–localStorageçš„å­˜å–:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useState, useCallback, Dispatch, SetStateAction &#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">useStorage</span>&lt;<span class="title">T</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  key: <span class="built_in">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="comment">// é»˜è®¤å€¼</span></span></span></span><br><span class="line"><span class="function"><span class="params">  defaultValue?: T | (() =&gt; T),</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="comment">// æ˜¯å¦åœ¨çª—å£å…³é—­åä¿æŒæ•°æ®</span></span></span></span><br><span class="line"><span class="function"><span class="params">  keepOnWindowClosed: <span class="built_in">boolean</span> = <span class="literal">true</span>,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): [<span class="title">T</span> | <span class="title">undefined</span>, <span class="title">Dispatch</span>&lt;<span class="title">SetStateAction</span>&lt;<span class="title">T</span>&gt;&gt;, (<span class="params"></span>) =&gt; <span class="title">void</span>] </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> storage = keepOnWindowClosed ? localStorage : sessionStorage</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å°è¯•ä»Storageæ¢å¤å€¼</span></span><br><span class="line">  <span class="keyword">const</span> getStorageValue = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> storageValue = storage.getItem(key)</span><br><span class="line">      <span class="keyword">if</span> (storageValue != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">JSON</span>.parse(storageValue)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (defaultValue) &#123;</span><br><span class="line">        <span class="comment">// è®¾ç½®é»˜è®¤å€¼</span></span><br><span class="line">        <span class="keyword">const</span> value = <span class="keyword">typeof</span> defaultValue === <span class="string">'function'</span> ? <span class="function">(<span class="params">defaultValue <span class="keyword">as</span> (<span class="params"></span>) =&gt; T</span>)<span class="params">()</span> : <span class="params">defaultValue</span></span></span><br><span class="line"><span class="function">        <span class="params">storage</span>.<span class="params">setItem</span>(<span class="params">key, <span class="built_in">JSON</span>.stringify(<span class="params">value</span>)</span>)</span></span><br><span class="line"><span class="function">        <span class="params">return</span> <span class="params">value</span></span></span><br><span class="line"><span class="function">      &#125;</span></span><br><span class="line"><span class="function">    &#125; <span class="params">catch</span> (<span class="params">err</span>) &#123;</span></span><br><span class="line"><span class="function">      <span class="params">console</span>.<span class="params">warn</span>(<span class="params">`useStorage æ— æ³•è·å–$&#123;key&#125;: `, err</span>)</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    <span class="params">return</span> <span class="params">undefined</span></span></span><br><span class="line"><span class="function">  &#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="params">const</span> [<span class="params">value</span>, <span class="params">setValue</span>] = <span class="params">useState</span>&lt;<span class="params">T</span> | <span class="params">undefined</span>&gt;(<span class="params">getStorageValue</span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  // æ›´æ–°ç»„ä»¶çŠ¶æ€å¹¶ä¿å­˜åˆ°<span class="params">Storage</span></span></span><br><span class="line"><span class="function">  <span class="params">const</span> <span class="params">save</span> = <span class="params">useCallback</span>&lt;<span class="params">Dispatch</span>&lt;<span class="params">SetStateAction</span>&lt;<span class="params">T</span>&gt;&gt;&gt;(<span class="params">value =&gt; &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">    setValue(<span class="params">prev =&gt; &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">      <span class="keyword">const</span> finalValue = <span class="keyword">typeof</span> value === '<span class="keyword">function</span>' ? (<span class="params">value <span class="keyword">as</span> (<span class="params">prev: T | <span class="literal">undefined</span></span>) =&gt; T</span>)(<span class="params">prev</span>) : value</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">      storage.setItem(<span class="params">key, <span class="built_in">JSON</span>.stringify(<span class="params">finalValue</span>)</span>)</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">      <span class="keyword">return</span> finalValue</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">    &#125;</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">  &#125;, []</span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  // ç§»é™¤çŠ¶æ€</span></span><br><span class="line"><span class="function">  <span class="params">const</span> <span class="params">clear</span> = <span class="params">useCallback</span>(<span class="params">(<span class="params"></span>) =&gt; &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">    storage.removeItem(<span class="params">key</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">    setValue(<span class="params"><span class="literal">undefined</span></span>)</span></span></span><br><span class="line"><span class="function"><span class="params">  &#125;, []</span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="params">return</span> [<span class="params">value</span>, <span class="params">save</span>, <span class="params">clear</span>]</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">// --------</span></span><br><span class="line"><span class="function">// <span class="params">EXAMPLE</span></span></span><br><span class="line"><span class="function">// --------</span></span><br><span class="line"><span class="function"><span class="params">function</span> <span class="params">Demo</span><span class="params">()</span> &#123;</span></span><br><span class="line"><span class="function">  // ä¿å­˜ç™»å½•çŠ¶æ€</span></span><br><span class="line"><span class="function">  <span class="params">const</span> [<span class="params">use</span>, <span class="params">setUser</span>, <span class="params">clearUser</span>] = <span class="params">useStorage</span>(<span class="params">'user'</span>)</span></span><br><span class="line"><span class="function">  <span class="params">const</span> <span class="params">handleLogin</span> = (<span class="params">user</span>) =&gt;</span> &#123;</span><br><span class="line">    setUser(user)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> handleLogout = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    clearUser()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p><a href="#">â¤´ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="1-5-userefstate-å¼•ç”¨stateçš„æœ€æ–°å€¼"><a href="#1-5-userefstate-å¼•ç”¨stateçš„æœ€æ–°å€¼" class="headerlink" title="1-5 useRefState å¼•ç”¨stateçš„æœ€æ–°å€¼"></a>1-5 useRefState å¼•ç”¨stateçš„æœ€æ–°å€¼</h3><p><br></p><p><img src="/images/react-hooks/vue-api.png" alt></p><p><br></p><p>ä¸Šå›¾æ˜¯ä»Šå¹´å…­æœˆä»½<a href="https://vue.w3ctech.com" target="_blank" rel="noopener">VueConf</a>ï¼Œå°¤é›¨æºªçš„Slideæˆªå›¾ï¼Œä»–å¯¹æ¯”äº†Vueæœ€æ–°çš„<a href="https://zhuanlan.zhihu.com/p/68477600" target="_blank" rel="noopener">FunctionBase API</a>å’ŒReact Hook. å®ƒ<strong>æŒ‡å‡ºReact Hooksæœ‰å¾ˆå¤šé—®é¢˜</strong>:</p><ul><li>æ¯ä¸ªHooksåœ¨ç»„ä»¶æ¯æ¬¡æ¸²æŸ“æ—¶éƒ½æ‰§è¡Œã€‚ä¹Ÿå°±æ˜¯è¯´æ¯æ¬¡æ¸²æŸ“éƒ½è¦é‡æ–°åˆ›å»ºé—­åŒ…å’Œå¯¹è±¡</li><li>éœ€è¦ç†è§£é—­åŒ…å˜é‡</li><li>å†…å®¹å›è°ƒ/å¯¹è±¡ä¼šå¯¼è‡´çº¯ç»„ä»¶propsæ¯”å¯¹å¤±æ•ˆ, å¯¼è‡´ç»„ä»¶æ°¸è¿œæ›´æ–°</li></ul><p><br></p><p>é—­åŒ…å˜é‡é—®é¢˜æ˜¯ä½ æŒæ¡React Hooksè¿‡ç¨‹ä¸­çš„é‡è¦ä¸€å…³ã€‚é—­åŒ…é—®é¢˜æ˜¯æŒ‡ä»€ä¹ˆå‘¢ï¼Ÿä¸¾ä¸ªç®€å•çš„ä¾‹å­, Counter:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Counter</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = useState(<span class="number">0</span>)</span><br><span class="line">  <span class="keyword">const</span> handleIncr = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    setCount(count + <span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (<span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;count&#125;: <span class="tag">&lt;<span class="name">ComplexButton</span> <span class="attr">onClick</span>=<span class="string">&#123;handleIncr&#125;</span>&gt;</span>increment<span class="tag">&lt;/<span class="name">ComplexButton</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡è®¾ComplexButtonæ˜¯ä¸€ä¸ªéå¸¸å¤æ‚çš„ç»„ä»¶ï¼Œæ¯ä¸€æ¬¡ç‚¹å‡»å®ƒï¼Œæˆ‘ä»¬ä¼šé€’å¢countï¼Œä»è€Œè§¦å‘ç»„å°†é‡æ–°æ¸²æŸ“ã€‚<strong>å› ä¸ºCounteræ¯æ¬¡æ¸²æŸ“éƒ½ä¼šé‡æ–°ç”ŸæˆhandleIncrï¼Œæ‰€ä»¥ä¹Ÿä¼šå¯¼è‡´ComplexButtoné‡æ–°æ¸²æŸ“ï¼Œä¸ç®¡ComplexButtonä½¿ç”¨äº†<code>PureComponent</code>è¿˜æ˜¯ä½¿ç”¨<code>React.memo</code>åŒ…è£…</strong>ã€‚</p><p><br></p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œ<strong>Reactä¹Ÿæä¾›äº†ä¸€ä¸ª<code>useCallback</code> Hook, ç”¨æ¥â€˜ç¼“å­˜â€™å‡½æ•°, ä¿æŒå›è°ƒçš„ä¸å˜æ€§</strong>. æ¯”å¦‚æˆ‘ä»¬å¯ä»¥è¿™æ ·ä½¿ç”¨:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Counter</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = useState(<span class="number">0</span>)</span><br><span class="line">  <span class="keyword">const</span> handleIncr = useCallback(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    setCount(count + <span class="number">1</span>)</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (<span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;count&#125;: <span class="tag">&lt;<span class="name">ComplexButton</span> <span class="attr">onClick</span>=<span class="string">&#123;handleIncr&#125;</span>&gt;</span>increment<span class="tag">&lt;/<span class="name">ComplexButton</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç æ˜¯æœ‰bugçš„ï¼Œä¸è¿‡æ€ä¹ˆç‚¹å‡»ï¼Œcountä¼šä¸€ç›´æ˜¾ç¤ºä¸º1ï¼</p><p>å†ä»”ç»†é˜…è¯»useCallbackçš„æ–‡æ¡£ï¼ŒuseCallbackæ”¯æŒç¬¬äºŒä¸ªå‚æ•°ï¼Œå½“è¿™äº›å€¼å˜åŠ¨æ—¶æ›´æ–°ç¼“å­˜çš„å‡½æ•°, <strong>useCallbackçš„å†…éƒ¨é€»è¾‘å¤§æ¦‚æ˜¯è¿™æ ·çš„</strong>ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> memoFn, memoArgs</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useCallback</span>(<span class="params">fn, args</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// å¦‚æœå˜åŠ¨åˆ™æ›´æ–°ç¼“å­˜å‡½æ•°</span></span><br><span class="line">  <span class="keyword">if</span> (!isEqual(memoArgs, args)) &#123;</span><br><span class="line">    memoArgs = args</span><br><span class="line">    <span class="keyword">return</span> (memoFn = fn)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> memoFn</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Ok, ç°åœ¨ç†è§£ä¸€ä¸‹ä¸ºä»€ä¹ˆä¼šä¸€ç›´æ˜¾ç¤º1ï¼Ÿ</p><p><img src="/images/react-hooks/usecallback.png" alt></p><p>é¦–æ¬¡æ¸²æŸ“æ—¶ç¼“å­˜äº†é—­åŒ…ï¼Œè¿™æ—¶å€™é—­åŒ…æ•è·çš„countå€¼æ˜¯0ã€‚åœ¨åç»­çš„é‡æ–°æ¸²æŸ“ä¸­ï¼Œå› ä¸ºuseCallbackç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šçš„å€¼æ²¡æœ‰å˜åŠ¨ï¼ŒhandleIncré—­åŒ…ä¼šæ°¸è¿œè¢«ç¼“å­˜ã€‚è¿™å°±è§£é‡Šäº†ä¸ºä»€ä¹ˆæ¯æ¬¡ç‚¹å‡»ï¼Œcountåªèƒ½ä¸º1.</p><p>è§£å†³åŠæ³•ä¹Ÿå¾ˆç®€å•ï¼Œè®©æˆ‘ä»¬åœ¨countå˜åŠ¨æ—¶ï¼Œè®©useCallbackæ›´æ–°ç¼“å­˜å‡½æ•°:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Counter</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = useState(<span class="number">0</span>)</span><br><span class="line">  <span class="keyword">const</span> handleIncr = useCallback(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    setCount(count + <span class="number">1</span>)</span><br><span class="line">  &#125;, [count])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (&lt;div&gt;&#123;count&#125;: &lt;ComplexButton onClick=&#123;handleIncr&#125;&gt;increment&lt;<span class="regexp">/ComplexButton&gt;&lt;/</span>div&gt;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>å¦‚æœuseCallbackä¾èµ–å¾ˆå¤šå€¼ï¼Œä½ çš„ä»£ç å¯èƒ½æ˜¯è¿™æ ·çš„ï¼š<code>useCallback(fn, [a, b, c, d, e])</code>. åæ­£æˆ‘æ˜¯æ— æ³•æ¥å—è¿™ç§ä»£ç çš„ï¼Œå¾ˆå®¹æ˜“é—æ¼, è€Œä¸”å¯ç»´æŠ¤æ€§å¾ˆå·®ï¼Œå°½ç®¡é€šè¿‡<a href="https://www.npmjs.com/package/eslint-plugin-react-hooks" target="_blank" rel="noopener">ESLintæ’ä»¶</a>å¯ä»¥æ£€æŸ¥è¿™äº›é—®é¢˜**ã€‚</p><p><br></p><p>å…¶å®é€šè¿‡<a href="https://reactjs.org/docs/hooks-reference.html#useref" target="_blank" rel="noopener"><code>useRef</code></a> Hookï¼Œå¯ä»¥è®©æˆ‘ä»¬åƒClassç»„ä»¶ä¸€æ ·ä¿å­˜ä¸€äº›â€˜å®ä¾‹å˜é‡â€™, Reactä¼šä¿è¯useRefè¿”å›å€¼çš„ç¨³å®šæ€§ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç»„ä»¶ä»»ä½•åœ°æ–¹å®‰å…¨åœ°å¼•ç”¨refã€‚</p><p>åŸºäºè¿™ä¸ªåŸç†ï¼Œæˆ‘ä»¬å°è¯•å°è£…ä¸€ä¸ª<code>useRefState</code>, å®ƒåœ¨useStateçš„åŸºç¡€ä¸Šæ‰©å±•äº†ä¸€ä¸ªè¿”å›å€¼ï¼Œç”¨äºè·å–stateçš„æœ€æ–°å€¼:</p><p><br></p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useState, useRef, useCallback, Dispatch, SetStateAction, MutableRefObject &#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useRefState</span>(<span class="params">initialState</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> ins = useRef()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> [state, setState] = useState(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–</span></span><br><span class="line">    <span class="keyword">const</span> value = <span class="keyword">typeof</span> initialState === <span class="string">'function'</span> ? initialState() : initialState</span><br><span class="line">    ins.current = value</span><br><span class="line">    <span class="keyword">return</span> value</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> setValue = useCallback(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">'function'</span>) &#123;</span><br><span class="line">      setState(<span class="function"><span class="params">prevState</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> finalValue = value(prevState)</span><br><span class="line">        ins.current = finalValue</span><br><span class="line">        <span class="keyword">return</span> finalValue</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      ins.current = value</span><br><span class="line">      setState(value)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> [state, setValue, ins]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>ä½¿ç”¨ç¤ºä¾‹:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Counter</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount, countRef] = useRefState(<span class="number">0</span>)</span><br><span class="line">  <span class="keyword">const</span> handleIncr = useCallback(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    setCount(countRef.current + <span class="number">1</span>)</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// åœ¨ç»„ä»¶å¸è½½æ—¶ä¿å­˜å½“å‰çš„count</span></span><br><span class="line">      saveCount(countRef.current)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (&lt;div&gt;&#123;count&#125;: &lt;ComplexButton onClick=&#123;handleIncr&#125;&gt;increment&lt;<span class="regexp">/ComplexButton&gt;&lt;/</span>div&gt;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><a href="https://reactjs.org/docs/hooks-reference.html#useeffect" target="_blank" rel="noopener"><code>useEffect</code></a>ã€<a href="https://reactjs.org/docs/hooks-reference.html#usememo" target="_blank" rel="noopener"><code>useMemo</code></a>å’Œ<code>useCallback</code>ä¸€æ ·å­˜åœ¨é—­åŒ…å˜é‡é—®é¢˜ï¼Œå®ƒä»¬å’ŒuseCallbackä¸€ä¸ªæ”¯æŒæŒ‡å®šç¬¬äºŒä¸ªå‚æ•°ï¼Œå½“è¿™ä¸ªå‚æ•°å˜åŒ–æ—¶æ‰§è¡Œå‰¯ä½œç”¨ã€‚</p></blockquote><p><br></p><p><a href="#">â¤´ï¸å›åˆ°é¡¶éƒ¨</a></p><h4 id="1-5-1-æ¯æ¬¡é‡æ–°æ¸²æŸ“éƒ½åˆ›å»ºé—­åŒ…ä¼šå½±å“æ•ˆç‡å—"><a href="#1-5-1-æ¯æ¬¡é‡æ–°æ¸²æŸ“éƒ½åˆ›å»ºé—­åŒ…ä¼šå½±å“æ•ˆç‡å—" class="headerlink" title="1-5-1 æ¯æ¬¡é‡æ–°æ¸²æŸ“éƒ½åˆ›å»ºé—­åŒ…ä¼šå½±å“æ•ˆç‡å—?"></a>1-5-1 æ¯æ¬¡é‡æ–°æ¸²æŸ“éƒ½åˆ›å»ºé—­åŒ…ä¼šå½±å“æ•ˆç‡å—?</h4><p>å‡½æ•°ç»„ä»¶å’ŒClassç»„ä»¶ä¸ä¸€æ ·çš„æ˜¯ï¼Œå‡½æ•°ç»„ä»¶å°†æ‰€æœ‰çŠ¶æ€å’Œé€»è¾‘éƒ½æ”¾åˆ°ä¸€ä¸ªå‡½æ•°ä¸­, æ¯ä¸€æ¬¡é‡æ–°æ¸²æŸ“ä¼šé‡å¤åˆ›å»ºå¤§é‡çš„é—­åŒ…ã€å¯¹è±¡ã€‚è€Œä¼ ç»Ÿçš„Classç»„ä»¶çš„renderå‡½æ•°åˆ™è¦ç®€æ´å¾ˆå¤šï¼Œä¸€èˆ¬åªæ”¾ç½®JSXæ¸²æŸ“é€»è¾‘ã€‚ç›¸æ¯”å¤§å®¶éƒ½è·Ÿæˆ‘ä¸€æ ·ï¼Œä¼šæ€€ç–‘å‡½æ•°ç»„ä»¶çš„æ€§èƒ½é—®é¢˜</p><p>æˆ‘ä»¬çœ‹çœ‹å®˜æ–¹æ˜¯æ€ä¹ˆå›åº”çš„ï¼š</p><p><img src="/images/react-hooks/fn-perf.png" alt></p><p><br></p><p>æˆ‘åœ¨SegmentFaultçš„<a href="https://segmentfault.com/q/1010000019644156/a-1020000019706666" target="_blank" rel="noopener"><strong>react functionç»„ä»¶ä¸classç»„ä»¶æ€§èƒ½é—®é¢˜</strong></a>ä¹Ÿè¿›è¡Œäº†è¯¦ç»†çš„å›ç­”, ç»“è®ºæ˜¯:</p><blockquote><p>ç›®å‰è€Œè¨€ï¼Œå®ç°åŒæ ·çš„åŠŸèƒ½ï¼Œç±»ç»„ä»¶å’Œå‡½æ•°ç»„ä»¶çš„æ•ˆç‡æ˜¯ä¸ç›¸ä¸Šä¸‹çš„ã€‚ä½†æ˜¯å‡½æ•°ç»„ä»¶æ˜¯æœªæ¥ï¼Œè€Œä¸”è¿˜æœ‰ä¼˜åŒ–ç©ºé—´ï¼ŒReactå›¢é˜Ÿä¼šç»§ç»­ä¼˜åŒ–å®ƒã€‚è€Œç±»ç»„ä»¶ä¼šé€æ¸é€€å‡ºå†å²</p></blockquote><p>ä¸ºäº†æé«˜å‡½æ•°ç»„ä»¶çš„æ€§èƒ½ï¼Œå¯ä»¥åœ¨è¿™äº›åœ°æ–¹åšä¸€äº›<strong>ä¼˜åŒ–</strong>:</p><ul><li><p>èƒ½å¦å°†å‡½æ•°æå–ä¸ºé™æ€çš„</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 1ï¸âƒ£ä¾‹å¦‚å°†ä¸ä¾èµ–äºç»„ä»¶çŠ¶æ€çš„å›è°ƒæŠ½å–ä¸ºé™æ€æ–¹æ³•</span></span><br><span class="line"><span class="keyword">const</span> goback = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  history.go(<span class="number">-1</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Demo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">//const goback = () =&gt; &#123;</span></span><br><span class="line">  <span class="comment">//  history.go(-1)</span></span><br><span class="line">  <span class="comment">//&#125;</span></span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;goback&#125;</span>&gt;</span>back<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2ï¸âƒ£ æŠ½ç¦»useStateçš„åˆå§‹åŒ–å‡½æ•°</span></span><br><span class="line"><span class="keyword">const</span> returnEmptyObject = <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">Object</span>.create(<span class="literal">null</span>)</span><br><span class="line"><span class="keyword">const</span> returnEmptyArray = <span class="function"><span class="params">()</span> =&gt;</span> []</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Demo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [state, setState] = useState(returnEmptyObject)</span><br><span class="line">  <span class="keyword">const</span> [arr, setArr] = useState(returnEmptyArray)</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ç®€åŒ–ç»„ä»¶çš„å¤æ‚åº¦ï¼ŒåŠ¨é™åˆ†ç¦»</p></li><li>å†æ‹†åˆ†æ›´ç»†ç²’åº¦çš„ç»„ä»¶ï¼Œè¿™äº›ç»„ä»¶ä½¿ç”¨React.memoç¼“å­˜</li></ul><p><br><br><br></p><p><a href="#">â¤´ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="1-6-userefprops-å¼•ç”¨æœ€æ–°çš„props"><a href="#1-6-userefprops-å¼•ç”¨æœ€æ–°çš„props" class="headerlink" title="1-6 useRefProps å¼•ç”¨æœ€æ–°çš„Props"></a>1-6 useRefProps å¼•ç”¨æœ€æ–°çš„Props</h3><p>ç°å®é¡¹ç›®ä¸­ä¹Ÿæœ‰å¾ˆå¤šè¿™ç§åœºæ™¯: æˆ‘ä»¬æƒ³<strong>åœ¨ç»„ä»¶çš„ä»»ä½•åœ°æ–¹è·å–æœ€æ–°çš„propså€¼</strong>ï¼Œè¿™ä¸ªåŒæ ·å¯ä»¥é€šè¿‡useRefæ¥å®ç°ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">useRefProps</span>&lt;<span class="title">T</span>&gt;(<span class="params">props: T</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> ref = useRef&lt;T&gt;(props)</span><br><span class="line">  <span class="comment">// æ¯æ¬¡é‡æ–°æ¸²æŸ“è®¾ç½®å€¼</span></span><br><span class="line">  ref.current = props</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ref</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---------</span></span><br><span class="line"><span class="comment">// EXAMPLE</span></span><br><span class="line"><span class="comment">// ---------</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyButton</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> propsRef = useRefProps(props)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ°¸ä¹…ä¸å˜çš„äº‹ä»¶å¤„ç†å™¨</span></span><br><span class="line">  <span class="keyword">const</span> handleClick = useCallback(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; onClick &#125; = propsRef.current</span><br><span class="line">    <span class="keyword">if</span> (onClick) &#123;</span><br><span class="line">      onClick()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">ComplexButton</span> <span class="attr">onClick</span>=<span class="string">&#123;handleClick&#125;</span>&gt;</span><span class="tag">&lt;/<span class="name">ComplexButton</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p><a href="#">â¤´ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="1-7-useinstance-â€˜å®ä¾‹â€™å˜é‡å­˜å–"><a href="#1-7-useinstance-â€˜å®ä¾‹â€™å˜é‡å­˜å–" class="headerlink" title="1-7 useInstance â€˜å®ä¾‹â€™å˜é‡å­˜å–"></a>1-7 useInstance â€˜å®ä¾‹â€™å˜é‡å­˜å–</h3><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isFunction</span>&lt;<span class="title">T</span>&gt;(<span class="params">initial?: T | (() =&gt; T)</span>): <span class="title">initial</span> <span class="title">is</span> (<span class="params"></span>) =&gt; <span class="title">T</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> initial === <span class="string">'function'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useInstance</span>&lt;<span class="title">T</span> <span class="title">extends</span> </span>&#123;&#125;&gt;<span class="function">(<span class="params">initial?: T | (<span class="params">(<span class="params"></span>) =&gt; T</span>)</span>) &#123;</span></span><br><span class="line"><span class="function">  <span class="params">const</span> <span class="params">instance</span> = <span class="params">useRef</span>&lt;<span class="params">T</span>&gt;<span class="params">()</span></span></span><br><span class="line"><span class="function">  // åˆå§‹åŒ–</span></span><br><span class="line"><span class="function">  <span class="params">if</span> (<span class="params">instance.current == <span class="literal">null</span></span>) &#123;</span></span><br><span class="line"><span class="function">    <span class="params">if</span> (<span class="params">initial</span>) &#123;</span></span><br><span class="line"><span class="function">      <span class="params">instance</span>.<span class="params">current</span> = <span class="params">isFunction</span>(<span class="params">initial</span>) ? <span class="params">initial</span><span class="params">()</span> : <span class="params">initial</span></span></span><br><span class="line"><span class="function">    &#125; <span class="params">else</span> &#123;</span></span><br><span class="line"><span class="function">      <span class="params">instance</span>.<span class="params">current</span> = &#123;&#125; <span class="params">as</span> <span class="params">T</span></span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function">  &#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="params">return</span> <span class="params">instance</span>.<span class="params">current</span></span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">// ---------</span></span><br><span class="line"><span class="function">// <span class="params">EXAMPLE</span></span></span><br><span class="line"><span class="function">// ---------</span></span><br><span class="line"><span class="function"><span class="params">function</span> <span class="params">Demo</span><span class="params">()</span> &#123;</span></span><br><span class="line"><span class="function">  <span class="params">const</span> <span class="params">inst</span> = <span class="params">useInstance</span>(<span class="params">&#123; count: 1 &#125;</span>)</span></span><br><span class="line"><span class="function">  <span class="params">const</span> <span class="params">update</span> = <span class="params">useForceUpdate</span><span class="params">()</span></span></span><br><span class="line"><span class="function">  <span class="params">useEffect</span>(<span class="params">(<span class="params"></span>) =&gt; &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> timer = setInterval(<span class="params">(<span class="params"></span>) =&gt; &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">      <span class="comment">// åƒç±»ç»„ä»¶ä¸€æ ·ï¼Œè¿›è¡Œâ€˜å®ä¾‹å˜é‡â€™å­˜å‚¨</span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">      <span class="comment">// åœ¨å‡½æ•°ç»„ä»¶çš„ä»»æ„åœ°æ–¹å¼•ç”¨</span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">      <span class="comment">// åªä¸è¿‡æ›´æ–°è¿™äº›æ•°æ®ä¸ä¼šè§¦å‘ç»„ä»¶çš„é‡æ–°æ¸²æŸ“</span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">      inst.count++</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">    &#125;, 1000</span>)</span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">return</span> (<span class="params"></span>) =&gt; clearInterval(<span class="params">timer</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">  &#125;, []</span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="params">return</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    &lt;div&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">      count: &#123;inst.count&#125;</span></span></span><br><span class="line"><span class="function"><span class="params">      &lt;button onClick=&#123;update&#125;&gt;åˆ·æ–°&lt;/button&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">    &lt;/div&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>)</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure><blockquote><p>æ³¨æ„ä¸è¦æ»¥ç”¨</p></blockquote><p><br></p><p><a href="#">â¤´ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="1-9-useprevious-è·å–ä¸Šä¸€æ¬¡æ¸²æŸ“çš„å€¼"><a href="#1-9-useprevious-è·å–ä¸Šä¸€æ¬¡æ¸²æŸ“çš„å€¼" class="headerlink" title="1-9 usePrevious è·å–ä¸Šä¸€æ¬¡æ¸²æŸ“çš„å€¼"></a>1-9 usePrevious è·å–ä¸Šä¸€æ¬¡æ¸²æŸ“çš„å€¼</h3><p>åœ¨Classç»„ä»¶ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šåœ¨<code>shouldComponentUpdate</code>æˆ–<code>componentDidUpdate</code>è¿™ç±»ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä¸­å¯¹propsæˆ–stateè¿›è¡Œæ¯”å¯¹ï¼Œæ¥å†³å®šåšæŸäº›äº‹æƒ…ï¼Œä¾‹å¦‚é‡æ–°å‘èµ·è¯·æ±‚ã€ç›‘å¬äº‹ä»¶ç­‰ç­‰.</p><p>Hooksä¸­æˆ‘ä»¬å¯ä»¥ä½¿ç”¨useEffectæˆ–useMemoæ¥å“åº”çŠ¶æ€å˜åŒ–ï¼Œè¿›è¡ŒçŠ¶æ€æˆ–å‰¯ä½œç”¨è¡ç”Ÿ. æ‰€ä»¥ä¸Šè¿°æ¯”å¯¹çš„åœºæ™¯åœ¨Hooksä¸­å¾ˆå°‘è§ã€‚ä½†ä¹Ÿä¸æ˜¯ä¸å¯èƒ½ï¼ŒReactå®˜æ–¹æ¡ˆä¾‹ä¸­å°±æœ‰ä¸€ä¸ª<code>usePrevious</code>:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">usePrevious</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> ref = useRef();</span><br><span class="line">  <span class="comment">// useEffectä¼šåœ¨å®Œæˆè¿™æ¬¡'æ¸²æŸ“'ä¹‹åæ‰§è¡Œ</span></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    ref.current = value;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> ref.current;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// --------</span></span><br><span class="line"><span class="comment">// EXAMPLE</span></span><br><span class="line"><span class="comment">// --------</span></span><br><span class="line"><span class="keyword">const</span> calculation = count * <span class="number">100</span>;</span><br><span class="line"><span class="keyword">const</span> prevCalculation = usePrevious(calculation);</span><br></pre></td></tr></table></figure><p><br></p><p><a href="#">â¤´ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="1-10-useimmer-ç®€åŒ–ä¸å¯å˜æ•°æ®æ“ä½œ"><a href="#1-10-useimmer-ç®€åŒ–ä¸å¯å˜æ•°æ®æ“ä½œ" class="headerlink" title="1-10 useImmer ç®€åŒ–ä¸å¯å˜æ•°æ®æ“ä½œ"></a>1-10 useImmer ç®€åŒ–ä¸å¯å˜æ•°æ®æ“ä½œ</h3><p>è¿™ä¸ªæ¡ˆä¾‹æ¥æºäº<a href="https://github.com/immerjs/use-immer" target="_blank" rel="noopener">use-immer</a>, ç»“åˆ<a href="https://github.com/mweststrate/immer" target="_blank" rel="noopener">immer.js</a>å’ŒHooksæ¥ç®€åŒ–ä¸å¯å˜æ•°æ®æ“ä½œ, çœ‹çœ‹ä»£ç ç¤ºä¾‹:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> [person, updatePerson] = useImmer(&#123;</span><br><span class="line">  name: <span class="string">"Michel"</span>,</span><br><span class="line">  age: <span class="number">33</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateName</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">  updatePerson(<span class="function"><span class="params">draft</span> =&gt;</span> &#123;</span><br><span class="line">    draft.name = name;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">becomeOlder</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  updatePerson(<span class="function"><span class="params">draft</span> =&gt;</span> &#123;</span><br><span class="line">    draft.age++;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ç°ä¹Ÿéå¸¸ç®€å•:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">useImmer</span>(<span class="params">initialValue</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [val, updateValue] = useState(initialValue);</span><br><span class="line">  <span class="keyword">return</span> [</span><br><span class="line">    val,</span><br><span class="line">    useCallback(<span class="function"><span class="params">updater</span> =&gt;</span> &#123;</span><br><span class="line">      updateValue(produce(updater));</span><br><span class="line">    &#125;, [])</span><br><span class="line">  ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç®€æ´çš„Hooksé…åˆç®€æ´çš„Immerï¼Œç®€ç›´å®Œç¾</strong></p><p><br></p><p><a href="#">â¤´ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="1-11-å°è£…â€™å·¥å…·hooksâ€™ç®€åŒ–stateçš„æ“ä½œ"><a href="#1-11-å°è£…â€™å·¥å…·hooksâ€™ç®€åŒ–stateçš„æ“ä½œ" class="headerlink" title="1-11 å°è£…â€™å·¥å…·Hooksâ€™ç®€åŒ–Stateçš„æ“ä½œ"></a>1-11 å°è£…â€™å·¥å…·Hooksâ€™ç®€åŒ–Stateçš„æ“ä½œ</h3><p>Hooksåªæ˜¯æ™®é€šå‡½æ•°ï¼Œæ‰€ä»¥å¯ä»¥çµæ´»åœ°è‡ªå®šä¹‰ã€‚ä¸‹é¢ä¸¾ä¸€äº›ä¾‹å­ï¼Œåˆ©ç”¨è‡ªå®šä¹‰Hooksæ¥ç®€åŒ–å¸¸è§çš„æ•°æ®æ“ä½œåœºæ™¯</p><p><br></p><h4 id="1-11-1-usetoggle-å¼€å…³"><a href="#1-11-1-usetoggle-å¼€å…³" class="headerlink" title="1-11-1 useToggle å¼€å…³"></a>1-11-1 useToggle å¼€å…³</h4><p>å®ç°booleanå€¼åˆ‡æ¢</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useToggle</span>(<span class="params">initialValue?: <span class="built_in">boolean</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [value, setValue] = useState(!!initialValue)</span><br><span class="line">  <span class="keyword">const</span> toggler = useCallback(<span class="function"><span class="params">()</span> =&gt;</span> setValue(<span class="function"><span class="params">value</span> =&gt;</span> !value), [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> [value, toggler]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// --------</span></span><br><span class="line"><span class="comment">// EXAMPLE</span></span><br><span class="line"><span class="comment">// --------</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Demo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [enable, toggleEnable] = useToggle()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &lt;Switch value=&#123;enable&#125; onClick=&#123;toggleEnable&#125;&gt;&lt;<span class="regexp">/Switch&gt;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p><br></p><p><a href="#">â¤´ï¸å›åˆ°é¡¶éƒ¨</a></p><h4 id="1-11-2-usearray-ç®€åŒ–æ•°ç»„çŠ¶æ€æ“ä½œ"><a href="#1-11-2-usearray-ç®€åŒ–æ•°ç»„çŠ¶æ€æ“ä½œ" class="headerlink" title="1-11-2 useArray ç®€åŒ–æ•°ç»„çŠ¶æ€æ“ä½œ"></a>1-11-2 useArray ç®€åŒ–æ•°ç»„çŠ¶æ€æ“ä½œ</h4><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useArray</span>&lt;<span class="title">T</span>&gt;(<span class="params">initial?: T[] | (() =&gt; T[]), idKey: <span class="built_in">string</span> = 'id'</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [value, setValue] = useState(initial || [])</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    value,</span><br><span class="line">    setValue,</span><br><span class="line">    push: useCallback(<span class="function"><span class="params">a</span> =&gt;</span> setValue(<span class="function"><span class="params">v</span> =&gt;</span> [...v, a]), []),</span><br><span class="line">    clear: useCallback(<span class="function"><span class="params">()</span> =&gt;</span> setValue(<span class="function"><span class="params">()</span> =&gt;</span> []), []),</span><br><span class="line">    removeById: useCallback(<span class="function"><span class="params">id</span> =&gt;</span> setValue(<span class="function"><span class="params">arr</span> =&gt;</span> arr.filter(<span class="function"><span class="params">v</span> =&gt;</span> v &amp;&amp; v[idKey] !== id)), []),</span><br><span class="line">    removeIndex: useCallback(</span><br><span class="line">      index =&gt;</span><br><span class="line">        setValue(<span class="function"><span class="params">v</span> =&gt;</span> &#123;</span><br><span class="line">          v.splice(index, <span class="number">1</span>)</span><br><span class="line">          <span class="keyword">return</span> v</span><br><span class="line">        &#125;),</span><br><span class="line">      [],</span><br><span class="line">    ),</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---------</span></span><br><span class="line"><span class="comment">// EXAMPLE</span></span><br><span class="line"><span class="comment">// ---------</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Demo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;value, push, removeById&#125; = useArray&lt;&#123;id: <span class="built_in">number</span>, name: <span class="built_in">string</span>&#125;&gt;()</span><br><span class="line">  <span class="keyword">const</span> handleAdd = useCallback(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    push(&#123;id: <span class="built_in">Math</span>.random(), name: getName()&#125;)</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (&lt;div&gt;</span><br><span class="line">    &lt;div&gt;&#123;value.map(<span class="function"><span class="params">i</span> =&gt;</span> &lt;span key=&#123;i.id&#125; onClick=&#123;<span class="function"><span class="params">()</span> =&gt;</span> removeById(i.id)&#125;&gt;&#123;i.name&#125;&lt;<span class="regexp">/span&gt;)&#125;&lt;/</span>div&gt;</span><br><span class="line">    &lt;button onClick=&#123;handleAdd&#125;&gt;add&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">  &lt;/</span>div&gt;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é™äºç¯‡å¹…ï¼Œå…¶ä»–æ•°æ®ç»“æ„, ä¾‹å¦‚Setã€Map, å°±ä¸å±•å¼€ä»‹ç»äº†ï¼Œè¯»è€…å¯ä»¥è‡ªå·±å‘æŒ¥æƒ³è±¡åŠ›.</p><p><br><br><br></p><p><a href="#">â¤´ï¸å›åˆ°é¡¶éƒ¨</a></p><h2 id="2-æ¨¡æ‹Ÿç”Ÿå‘½å‘¨æœŸå‡½æ•°"><a href="#2-æ¨¡æ‹Ÿç”Ÿå‘½å‘¨æœŸå‡½æ•°" class="headerlink" title="2. æ¨¡æ‹Ÿç”Ÿå‘½å‘¨æœŸå‡½æ•°"></a><strong>2. æ¨¡æ‹Ÿç”Ÿå‘½å‘¨æœŸå‡½æ•°</strong></h2><p>ç»„ä»¶ç”Ÿå‘½å‘¨æœŸç›¸å…³çš„æ“ä½œä¾èµ–äº<code>useEffect</code> Hook. <strong>Reactåœ¨å‡½æ•°ç»„ä»¶ä¸­åˆ»æ„æ·¡åŒ–äº†ç»„ä»¶ç”Ÿå‘½å‘¨æœŸçš„æ¦‚å¿µï¼Œè€Œæ›´å…³æ³¨â€˜æ•°æ®çš„å“åº”â€™</strong>.</p><p><code>useEffect</code>åç§°æ„å›¾éå¸¸æ˜æ˜¾ï¼Œå°±æ˜¯<strong>ä¸“é—¨ç”¨æ¥ç®¡ç†ç»„ä»¶çš„å‰¯ä½œç”¨</strong>ã€‚å’ŒuseCallbackä¸€æ ·ï¼ŒuseEffectæ”¯æŒä¼ é€’ç¬¬äºŒä¸ªå‚æ•°ï¼Œå‘ŠçŸ¥Reactåœ¨è¿™äº›å€¼å‘ç”Ÿå˜åŠ¨æ—¶æ‰æ‰§è¡Œçˆ¶ä½œç”¨. åŸç†å¤§æ¦‚å¦‚ä¸‹:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> memoCallback = &#123;<span class="attr">fn</span>: <span class="literal">undefined</span>, <span class="attr">disposer</span>: <span class="literal">undefined</span>&#125;</span><br><span class="line"><span class="keyword">let</span> memoArgs</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useEffect</span>(<span class="params">fn, args</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// å¦‚æœå˜åŠ¨åˆ™æ‰§è¡Œå‰¯ä½œç”¨</span></span><br><span class="line">  <span class="keyword">if</span> (args == <span class="literal">null</span> || !isEqual(memoArgs, args)) &#123;</span><br><span class="line">    memoArgs = args</span><br><span class="line">    memoCallback.fn = fn</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ”¾è¿›é˜Ÿåˆ—ç­‰å¾…è°ƒåº¦æ‰§è¡Œ</span></span><br><span class="line">    pushIntoEffectQueue(memoCallback)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‰¯ä½œç”¨æ‰§è¡Œ</span></span><br><span class="line"><span class="comment">// è¿™ä¸ªä¼šåœ¨ç»„ä»¶å®Œæˆæ¸²æŸ“ï¼Œåœ¨å¸ƒå±€(layout)å’Œç»˜åˆ¶(paint)ä¹‹åè¢«æ‰§è¡Œ</span></span><br><span class="line"><span class="comment">// å¦‚æœæ˜¯useLayoutEffect, æ‰§è¡Œçš„æ—¶æœºä¼šæ›´æ—©ä¸€äº›</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">queueExecute</span>(<span class="params">callback</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// å…ˆæ‰§è¡Œæ¸…ç†å‡½æ•°</span></span><br><span class="line">  <span class="keyword">if</span> (callback.disposer) &#123;</span><br><span class="line">    callback.disposer()</span><br><span class="line">  &#125;</span><br><span class="line">  callback.disposer = callback.fn()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>å…³äºuseEffectå®˜ç½‘æœ‰è¯¦å°½çš„<a href="https://zh-hans.reactjs.org/docs/hooks-reference.html#useeffect" target="_blank" rel="noopener">æè¿°</a>; Dan Abramovä¹Ÿå†™äº†ä¸€ç¯‡<a href="https://overreacted.io/zh-hans/a-complete-guide-to-useeffect/" target="_blank" rel="noopener">useEffect å®Œæ•´æŒ‡å—</a>, æ¨èğŸ‘ã€‚</p><p><br></p><p><a href="#">â¤´ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="2-1-useonmount-æ¨¡æ‹Ÿcomponentdidmount"><a href="#2-1-useonmount-æ¨¡æ‹Ÿcomponentdidmount" class="headerlink" title="2-1 useOnMount æ¨¡æ‹ŸcomponentDidMount"></a>2-1 useOnMount æ¨¡æ‹ŸcomponentDidMount</h3><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">useOnMount</span>(<span class="params">fn: <span class="built_in">Function</span></span>) </span>&#123;</span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    fn()</span><br><span class="line">  &#125;, []) <span class="comment">// ç¬¬äºŒä¸ªå‚æ•°è®¾ç½®ä¸º[], è¡¨ç¤ºä¸å¿…å¯¹ä»»ä½•æ•°æ®ï¼Œ æ‰€ä»¥åªåœ¨é¦–æ¬¡æ¸²æŸ“æ—¶è°ƒç”¨</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---------</span></span><br><span class="line"><span class="comment">// EXAMPLE</span></span><br><span class="line"><span class="comment">// ---------</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Demo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  useOnMount(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">await</span> loadList()</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">      <span class="comment">// log</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p><strong>å¦‚æœéœ€è¦åœ¨æŒ‚è½½/çŠ¶æ€æ›´æ–°æ—¶è¯·æ±‚ä¸€äº›èµ„æºã€å¹¶ä¸”éœ€è¦åœ¨å¸è½½æ—¶é‡Šæ”¾è¿™äº›èµ„æºï¼Œè¿˜æ˜¯æ¨èä½¿ç”¨useEffectï¼Œå› ä¸ºè¿™äº›é€»è¾‘æœ€å¥½æ”¾åœ¨ä¸€èµ·, æ–¹ä¾¿ç»´æŠ¤å’Œç†è§£</strong>:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä½†æ˜¯useEffectä¼ å…¥çš„å‡½æ•°ä¸æ”¯æŒasync/await(è¿”å›Promise)</span></span><br><span class="line">useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// è¯·æ±‚èµ„æº</span></span><br><span class="line">  <span class="keyword">const</span> subscription = props.source.subscribe();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é‡Šæ”¾èµ„æº</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    subscription.unsubscribe();</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;, []);</span><br></pre></td></tr></table></figure><p><br></p><p><a href="#">â¤´ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="2-2-useonunmount-æ¨¡æ‹Ÿcomponentwillunmount"><a href="#2-2-useonunmount-æ¨¡æ‹Ÿcomponentwillunmount" class="headerlink" title="2-2 useOnUnmount æ¨¡æ‹ŸcomponentWillUnmount"></a>2-2 useOnUnmount æ¨¡æ‹ŸcomponentWillUnmount</h3><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">useOnUnmount</span>(<span class="params">fn: <span class="built_in">Function</span></span>) </span>&#123;</span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        fn()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p><a href="#">â¤´ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="2-3-useonupdate-æ¨¡æ‹Ÿcomponentdidupdate"><a href="#2-3-useonupdate-æ¨¡æ‹Ÿcomponentdidupdate" class="headerlink" title="2-3 useOnUpdate æ¨¡æ‹ŸcomponentDidUpdate"></a>2-3 useOnUpdate æ¨¡æ‹ŸcomponentDidUpdate</h3><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useOnUpdate</span>(<span class="params">fn: () =&gt; <span class="built_in">void</span>, dep?: <span class="built_in">any</span>[]</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> ref = useRef(&#123; fn, mounted: <span class="literal">false</span> &#125;)</span><br><span class="line">  ref.current.fn = fn</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// é¦–æ¬¡æ¸²æŸ“ä¸æ‰§è¡Œ</span></span><br><span class="line">    <span class="keyword">if</span> (!ref.current.mounted) &#123;</span><br><span class="line">      ref.current.mounted = <span class="literal">true</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      ref.current.fn()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, dep)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -----------</span></span><br><span class="line"><span class="comment">// EXAMPLE</span></span><br><span class="line"><span class="comment">// -----------</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Demo</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  useOnUpdate(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    dosomethingwith(props.a)</span><br><span class="line">  &#125;, [props.a])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &lt;div&gt;...&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p><br></p><p>å…¶ä»–ç”Ÿå‘½å‘¨æœŸå‡½æ•°çš„æ¨¡æ‹Ÿ:</p><ul><li><code>shouldComponentUpdate</code> - React.memoåŒ…è£¹ç»„ä»¶</li><li><code>componentDidCatch</code> - æš‚ä¸æ”¯æŒ</li></ul><p><br><br><br></p><p><a href="#">â¤´ï¸å›åˆ°é¡¶éƒ¨</a></p><h2 id="3-äº‹ä»¶å¤„ç†"><a href="#3-äº‹ä»¶å¤„ç†" class="headerlink" title="3. äº‹ä»¶å¤„ç†"></a><strong>3. äº‹ä»¶å¤„ç†</strong></h2><h3 id="3-1-usechange-ç®€åŒ–onchangeè¡¨å•åŒå‘ç»‘å®š"><a href="#3-1-usechange-ç®€åŒ–onchangeè¡¨å•åŒå‘ç»‘å®š" class="headerlink" title="3-1 useChange ç®€åŒ–onChangeè¡¨å•åŒå‘ç»‘å®š"></a>3-1 useChange ç®€åŒ–onChangeè¡¨å•åŒå‘ç»‘å®š</h3><p>è¡¨å•å€¼çš„åŒå‘ç»‘å®šåœ¨é¡¹ç›®ä¸­éå¸¸å¸¸è§ï¼Œé€šå¸¸æˆ‘ä»¬çš„ä»£ç æ˜¯è¿™æ ·çš„:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Demo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [value, setValue] = useState(<span class="string">''</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> handleChange = useCallback&lt;React.ChangeEventHandler&lt;HTMLInputElement&gt;&gt;(<span class="function"><span class="params">evt</span> =&gt;</span> &#123;</span><br><span class="line">    setValue(evt.target.value)</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &lt;input value=&#123;value&#125; onChange=&#123;handleChange&#125; /&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœéœ€è¦ç»´æŠ¤å¤šä¸ªè¡¨å•ï¼Œè¿™ç§ä»£ç å°±ä¼šå˜å¾—éš¾ä»¥æ¥å—ã€‚å¹¸å¥½æœ‰Hooksï¼Œæˆ‘ä»¬å¯ä»¥ç®€åŒ–è¿™äº›ä»£ç :</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useChange</span>&lt;<span class="title">S</span>&gt;(<span class="params">initial?: S | (() =&gt; S)</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [value, setValue] = useState&lt;S | <span class="literal">undefined</span>&gt;(initial)</span><br><span class="line">  <span class="keyword">const</span> onChange = useCallback(<span class="function"><span class="params">e</span> =&gt;</span> setValue(e.target.value), [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    value,</span><br><span class="line">    setValue,</span><br><span class="line">    onChange,</span><br><span class="line">    <span class="comment">// ç»‘å®šåˆ°åŸç”Ÿäº‹ä»¶</span></span><br><span class="line">    bindEvent: &#123;</span><br><span class="line">      onChange,</span><br><span class="line">      value,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// ç»‘å®šåˆ°è‡ªå®šä¹‰ç»„ä»¶</span></span><br><span class="line">    bind: &#123;</span><br><span class="line">      onChange: setValue,</span><br><span class="line">      value,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ----------</span></span><br><span class="line"><span class="comment">// EXAMPLE</span></span><br><span class="line"><span class="comment">// ----------</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Demo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> userName = useChange(<span class="string">''</span>)</span><br><span class="line">  <span class="keyword">const</span> password = useChange(<span class="string">''</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;input &#123;...userName.bindEvent&#125; /&gt;</span><br><span class="line">      &lt;input <span class="keyword">type</span>=<span class="string">"password"</span> &#123;...password.bindEvent&#125; /&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p><br></p><p><a href="#">â¤´ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="3-2-usebind-ç»‘å®šå›è°ƒå‚æ•°"><a href="#3-2-usebind-ç»‘å®šå›è°ƒå‚æ•°" class="headerlink" title="3-2 useBind ç»‘å®šå›è°ƒå‚æ•°"></a>3-2 useBind ç»‘å®šå›è°ƒå‚æ•°</h3><p>ç»‘å®šä¸€äº›å›è°ƒå‚æ•°ï¼Œå¹¶åˆ©ç”¨useMemoç»™ä¸‹çº§ä¼ é€’ä¸€ä¸ªç¼“å­˜çš„å›è°ƒ, é¿å…é‡æ–°æ¸²æŸ“:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useBind</span>(<span class="params">fn?: (...args: <span class="built_in">any</span>[]) =&gt; <span class="built_in">any</span>, ...args: <span class="built_in">any</span>[]</span>): (<span class="params">...args: <span class="built_in">any</span>[]</span>) =&gt; <span class="title">any</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> useMemo(<span class="function"><span class="params">()</span> =&gt;</span> &#123;fn &amp;&amp; fn.bind(<span class="literal">null</span>, ...args)&#125;, args)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---------</span></span><br><span class="line"><span class="comment">// EXAMPLE</span></span><br><span class="line"><span class="comment">// ---------</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Demo</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;id, onClick&#125; = props</span><br><span class="line">  <span class="keyword">const</span> handleClick = useBind(onClick, id)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &lt;ComplexComponent onClick=&#123;handleClick&#125;&gt;&lt;<span class="regexp">/ComplexComponent&gt;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ ç­‰ä»·äº</span></span><br><span class="line"><span class="regexp">function Demo(props) &#123;</span></span><br><span class="line"><span class="regexp">  const &#123;id, onClick&#125; = props</span></span><br><span class="line"><span class="regexp">  const handleClick = useCallback(() =&gt; onClick(id), [id])</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  return &lt;ComplexComponent onClick=&#123;handleClick&#125;&gt;&lt;/</span>ComplexComponent&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p><a href="#">â¤´ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="3-3-è‡ªå®šä¹‰äº‹ä»¶å°è£…"><a href="#3-3-è‡ªå®šä¹‰äº‹ä»¶å°è£…" class="headerlink" title="3-3 è‡ªå®šä¹‰äº‹ä»¶å°è£…"></a>3-3 è‡ªå®šä¹‰äº‹ä»¶å°è£…</h3><p>Hooksä¹Ÿå¯ä»¥ç”¨äºå°è£…ä¸€äº›é«˜çº§äº‹ä»¶æˆ–è€…ç®€åŒ–äº‹ä»¶çš„å¤„ç†ï¼Œæ¯”å¦‚æ‹–æ‹½ã€æ‰‹åŠ¿ã€é¼ æ ‡Active/Hoverç­‰ç­‰ï¼›</p><p><br></p><h4 id="3-3-1-useactive"><a href="#3-3-1-useactive" class="headerlink" title="3-3-1 useActive"></a>3-3-1 useActive</h4><p>ä¸¾ä¸ªç®€å•çš„ä¾‹å­, useActive, åœ¨é¼ æ ‡æŒ‰ä¸‹æ—¶è®¾ç½®çŠ¶æ€ä¸ºtrueï¼Œé¼ æ ‡é‡Šæ”¾æ—¶æ¢å¤ä¸ºfalse:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useActive</span>(<span class="params">refEl: React.RefObject&lt;HTMLElement&gt;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [value, setValue] = useState(<span class="literal">false</span>)</span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> handleMouseDown = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      setValue(<span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> handleMouseUp = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      setValue(<span class="literal">false</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// DOM äº‹ä»¶ç›‘å¬</span></span><br><span class="line">    <span class="keyword">if</span> (refEl &amp;&amp; refEl.current) &#123;</span><br><span class="line">      refEl.current.addEventListener(<span class="string">'mousedown'</span>, handleMouseDown)</span><br><span class="line">      refEl.current.addEventListener(<span class="string">'mouseup'</span>, handleMouseUp)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (refEl &amp;&amp; refEl.current) &#123;</span><br><span class="line">        refEl.current.removeEventListener(<span class="string">'mousedown'</span>, handleMouseDown)</span><br><span class="line">        refEl.current.removeEventListener(<span class="string">'mouseup'</span>, handleMouseUp)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> value</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ----------</span></span><br><span class="line"><span class="comment">// EXAMPLE</span></span><br><span class="line"><span class="comment">// ----------</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Demo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> elRef = useRef(<span class="literal">null</span>)</span><br><span class="line">  <span class="keyword">const</span> active = useActive(inputRef)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (&lt;div ref=&#123;elRef&#125;&gt;&#123;active ? <span class="string">"Active"</span> : <span class="string">"Nop"</span>&#125;&lt;<span class="regexp">/div&gt;)</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p><br></p><p><a href="#">â¤´ï¸å›åˆ°é¡¶éƒ¨</a></p><h4 id="3-3-2-usetouch-æ‰‹åŠ¿äº‹ä»¶å°è£…"><a href="#3-3-2-usetouch-æ‰‹åŠ¿äº‹ä»¶å°è£…" class="headerlink" title="3-3-2 useTouch æ‰‹åŠ¿äº‹ä»¶å°è£…"></a>3-3-2 useTouch æ‰‹åŠ¿äº‹ä»¶å°è£…</h4><p>æ›´å¤æ‚çš„è‡ªå®šä¹‰äº‹ä»¶, ä¾‹å¦‚æ‰‹åŠ¿ã€‚é™äºç¯‡å¹…å°±ä¸åˆ—ä¸¾å®ƒä»¬çš„å®ç°ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹çœ‹å®ƒä»¬çš„Demo:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Demo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;ref&#125; = useTouch(&#123;</span><br><span class="line">    onTap: <span class="function"><span class="params">()</span> =&gt;</span> &#123; <span class="comment">/* ç‚¹å‡» */</span> &#125;,</span><br><span class="line">    onLongTap: <span class="function"><span class="params">()</span> =&gt;</span> &#123; <span class="comment">/* é•¿æŒ‰ */</span> &#125;,</span><br><span class="line">    onRotate: <span class="function"><span class="params">()</span> =&gt;</span> &#123;<span class="comment">/* æ—‹è½¬ */</span>&#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (&lt;div className=<span class="string">"box"</span> ref=&#123;ref&#125;&gt;&lt;<span class="regexp">/div&gt;)</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p>useTouchçš„å®ç°å¯ä»¥å‚è€ƒ<a href="https://github.com/GDJiaMi/hooks/blob/master/src/useTouch.ts" target="_blank" rel="noopener">useTouch.ts</a></p><p><br></p><p><a href="#">â¤´ï¸å›åˆ°é¡¶éƒ¨</a></p><h4 id="3-3-3-usedraggable-æ‹–æ‹½äº‹ä»¶å°è£…"><a href="#3-3-3-usedraggable-æ‹–æ‹½äº‹ä»¶å°è£…" class="headerlink" title="3-3-3 useDraggable æ‹–æ‹½äº‹ä»¶å°è£…"></a>3-3-3 useDraggable æ‹–æ‹½äº‹ä»¶å°è£…</h4><p>æ‹–æ‹½ä¹Ÿæ˜¯ä¸€ä¸ªå…¸å‹çš„è‡ªå®šä¹‰äº‹ä»¶, ä¸‹é¢è¿™ä¸ªä¾‹å­æ¥æºäº<a href="https://stackblitz.com/edit/usedraggable" target="_blank" rel="noopener">è¿™é‡Œ</a></p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useDraggable</span>(<span class="params">ref: React.RefObject&lt;HTMLElement&gt;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [&#123; dx, dy &#125;, setOffset] = useState(&#123; dx: <span class="number">0</span>, dy: <span class="number">0</span> &#125;)</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (ref.current == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`[useDraggable] refæœªæ³¨å†Œåˆ°ç»„ä»¶ä¸­`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> el = ref.current</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> handleMouseDown = <span class="function">(<span class="params">event: MouseEvent</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> startX = event.pageX - dx</span><br><span class="line">      <span class="keyword">const</span> startY = event.pageY - dy</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> handleMouseMove = <span class="function">(<span class="params">event: MouseEvent</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> newDx = event.pageX - startX</span><br><span class="line">        <span class="keyword">const</span> newDy = event.pageY - startY</span><br><span class="line">        setOffset(&#123; dx: newDx, dy: newDy &#125;)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">document</span>.addEventListener(<span class="string">'mousemove'</span>, handleMouseMove)</span><br><span class="line">      <span class="built_in">document</span>.addEventListener(</span><br><span class="line">        <span class="string">'mouseup'</span>,</span><br><span class="line">        () =&gt; &#123;</span><br><span class="line">          <span class="built_in">document</span>.removeEventListener(<span class="string">'mousemove'</span>, handleMouseMove)</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123; once: <span class="literal">true</span> &#125;,</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    el.addEventListener(<span class="string">'mousedown'</span>, handleMouseDown)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      el.removeEventListener(<span class="string">'mousedown'</span>, handleMouseDown)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [dx, dy])</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (ref.current) &#123;</span><br><span class="line">      ref.current.style.transform = <span class="string">`translate3d(<span class="subst">$&#123;dx&#125;</span>px, <span class="subst">$&#123;dy&#125;</span>px, 0)`</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [dx, dy])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -----------</span></span><br><span class="line"><span class="comment">// EXAMPLE</span></span><br><span class="line"><span class="comment">// -----------</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Demo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> el = useRef();</span><br><span class="line">  useDraggable(el);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &lt;div className=<span class="string">"box"</span> ref=&#123;el&#125; /&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯è¿è¡Œ<a href="https://stackblitz.com/edit/usedraggable" target="_blank" rel="noopener">ä¾‹å­</a></p><p><br></p><p><a href="#">â¤´ï¸å›åˆ°é¡¶éƒ¨</a></p><h4 id="3-3-4-react-events-é¢å‘æœªæ¥çš„é«˜çº§äº‹ä»¶å°è£…"><a href="#3-3-4-react-events-é¢å‘æœªæ¥çš„é«˜çº§äº‹ä»¶å°è£…" class="headerlink" title="3-3-4 react-events é¢å‘æœªæ¥çš„é«˜çº§äº‹ä»¶å°è£…"></a>3-3-4 react-events é¢å‘æœªæ¥çš„é«˜çº§äº‹ä»¶å°è£…</h4><p>æˆ‘åœ¨<a href="https://juejin.im/post/5d44e3745188255d5861d654" target="_blank" rel="noopener">&lt;è°ˆè°ˆReactäº‹ä»¶æœºåˆ¶å’Œæœªæ¥(react-events)&gt;</a>ä»‹ç»äº†<code>React-Events</code>è¿™ä¸ª<strong>å®éªŒæ€§</strong>çš„APIã€‚å½“è¿™ä¸ªAPIæˆç†Ÿåï¼Œæˆ‘ä»¬å¯ä»¥åŸºäºå®ƒæ¥å®ç°æ›´ä¼˜é›…çš„é«˜çº§äº‹ä»¶çš„å°è£…ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; PressResponder, usePressListener &#125; <span class="keyword">from</span> <span class="string">'react-events/press'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Button = <span class="function">(<span class="params">props</span>) =&gt;</span> (</span><br><span class="line">  <span class="keyword">const</span> listener = usePressListener(&#123;  <span class="comment">// âš›ï¸ é€šè¿‡hooksåˆ›å»ºResponder</span></span><br><span class="line">    onPressStart,</span><br><span class="line">    onPress,</span><br><span class="line">    onPressEnd,</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div listeners=&#123;listener&#125;&gt;</span><br><span class="line">      &#123;subtrees&#125;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">);</span></span><br></pre></td></tr></table></figure><p><br></p><p><a href="#">â¤´ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="3-4-usesubscription-é€šç”¨äº‹ä»¶æºè®¢é˜…"><a href="#3-4-usesubscription-é€šç”¨äº‹ä»¶æºè®¢é˜…" class="headerlink" title="3-4 useSubscription é€šç”¨äº‹ä»¶æºè®¢é˜…"></a>3-4 useSubscription é€šç”¨äº‹ä»¶æºè®¢é˜…</h3><p>Reactå®˜æ–¹ç»´æŠ¤äº†ä¸€ä¸ª<a href="https://github.com/facebook/react/tree/master/packages/use-subscription" target="_blank" rel="noopener">use-subscription</a>åŒ…ï¼Œæ”¯æŒä½¿ç”¨Hooksçš„å½¢å¼æ¥ç›‘å¬äº‹ä»¶æº. äº‹ä»¶æºå¯ä»¥æ˜¯DOMäº‹ä»¶ã€RxJSçš„Observableç­‰ç­‰.</p><p>å…ˆæ¥çœ‹çœ‹ä½¿ç”¨ç¤ºä¾‹:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ç›‘å¬rxjs behaviorSubject</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Demo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> subscription = useMemo(</span><br><span class="line">    () =&gt; (&#123;</span><br><span class="line">      getCurrentValue: <span class="function"><span class="params">()</span> =&gt;</span> behaviorSubject.getValue(),</span><br><span class="line">      subscribe: <span class="function"><span class="params">callback</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// å½“äº‹ä»¶è§¦å‘æ—¶è°ƒç”¨callback</span></span><br><span class="line">        <span class="keyword">const</span> subscription = behaviorSubject.subscribe(callback);</span><br><span class="line">        <span class="comment">// å’ŒuseEffectä¸€æ ·ï¼Œè¿”å›ä¸€ä¸ªå‡½æ•°æ¥å–æ¶ˆè®¢é˜…</span></span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> subscription.unsubscribe();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="comment">// åœ¨behaviorSubjectå˜åŒ–åé‡æ–°è®¢é˜…</span></span><br><span class="line">    [behaviorSubject]</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> value = useSubscription(subscription);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;value&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç°åœ¨æ¥çœ‹çœ‹å®ç°:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">useSubscription</span>&lt;<span class="title">T</span>&gt;(<span class="params">&#123;</span></span></span><br><span class="line"><span class="function"><span class="params">  getCurrentValue,</span></span></span><br><span class="line"><span class="function"><span class="params">  subscribe,</span></span></span><br><span class="line"><span class="function"><span class="params">&#125;: &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="comment">// è·å–å½“å‰å€¼</span></span></span></span><br><span class="line"><span class="function"><span class="params">  getCurrentValue?: () =&gt; T</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="comment">// ç”¨äºè®¢é˜…äº‹ä»¶æº</span></span></span></span><br><span class="line"><span class="function"><span class="params">  subscribe: (callback: <span class="built_in">Function</span>) =&gt; () =&gt; <span class="built_in">void</span></span></span></span><br><span class="line"><span class="function"><span class="params">&#125;</span>): <span class="title">T</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [state, setState] = useState(<span class="function"><span class="params">()</span> =&gt;</span> (&#123; getCurrentValue, subscribe, value: getCurrentValue() &#125;))</span><br><span class="line">  <span class="keyword">let</span> valueToReturn = state.value</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ›´æ–°getCurrentValueå’Œsubscribe</span></span><br><span class="line">  <span class="keyword">if</span> (state.getCurrentValue !== getCurrentValue || state.subscribe !== subscribe) &#123;</span><br><span class="line">    valueToReturn = getCurrentValue()</span><br><span class="line">    setState(&#123; getCurrentValue, subscribe, value: valueToReturn &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> didUnsubscribe = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">const</span> checkForUpdates = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (didUnsubscribe) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      setState(<span class="function"><span class="params">prevState</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// æ£€æŸ¥getCurrentValueå’Œsubscribeæ˜¯å¦å˜åŠ¨</span></span><br><span class="line">        <span class="comment">// setStateæ—¶å¦‚æœè¿”å›å€¼æ²¡æœ‰å˜åŒ–ï¼Œåˆ™ä¸ä¼šè§¦å‘é‡æ–°æ¸²æŸ“</span></span><br><span class="line">        <span class="keyword">if</span> (prevState.getCurrentValue !== getCurrentValue || prevState.subscribe !== subscribe) &#123;</span><br><span class="line">          <span class="keyword">return</span> prevState</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å€¼æ²¡å˜åŠ¨</span></span><br><span class="line">        <span class="keyword">const</span> value = getCurrentValue()</span><br><span class="line">        <span class="keyword">if</span> (prevState.value === value) &#123;</span><br><span class="line">          <span class="keyword">return</span> prevState</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> &#123; ...prevState, value &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> unsubscribe = subscribe(checkForUpdates)</span><br><span class="line">    checkForUpdates()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      didUnsubscribe = <span class="literal">true</span></span><br><span class="line">      unsubscribe()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [getCurrentValue, subscribe])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> valueToReturn</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ç°ä¹Ÿä¸å¤æ‚ï¼Œç”šè‡³å¯ä»¥è¯´æœ‰ç‚¹å•°å—¦.</p><p><br></p><p><a href="#">â¤´ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="3-5-useobservable-hookså’Œrxjsä¼˜é›…çš„ç»“åˆ-rxjs-hooks"><a href="#3-5-useobservable-hookså’Œrxjsä¼˜é›…çš„ç»“åˆ-rxjs-hooks" class="headerlink" title="3-5 useObservable Hookså’ŒRxJSä¼˜é›…çš„ç»“åˆ(rxjs-hooks)"></a>3-5 useObservable Hookså’ŒRxJSä¼˜é›…çš„ç»“åˆ(rxjs-hooks)</h3><p>å¦‚æœè¦é…åˆRxJSä½¿ç”¨ï¼ŒLeetCodeå›¢é˜Ÿå°è£…äº†ä¸€ä¸ª<a href="https://github.com/LeetCode-OpenSource/rxjs-hooks/blob/master/README.md" target="_blank" rel="noopener">rxjs-hooks</a>åº“ï¼Œç”¨èµ·æ¥åˆ™è¦ä¼˜é›…å¾ˆå¤š, éå¸¸æ¨è:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> value = useObservable(<span class="function"><span class="params">()</span> =&gt;</span> interval(<span class="number">500</span>).pipe(map(<span class="function">(<span class="params">val</span>) =&gt;</span> val * <span class="number">3</span>)));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div className=<span class="string">"App"</span>&gt;</span><br><span class="line">      &lt;h1&gt;Incremental <span class="built_in">number</span>: &#123;value&#125;&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p><a href="#">â¤´ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="3-6-useeventemitter-å¯¹æ¥eventemitter"><a href="#3-6-useeventemitter-å¯¹æ¥eventemitter" class="headerlink" title="3-6 useEventEmitter å¯¹æ¥eventEmitter"></a>3-6 useEventEmitter å¯¹æ¥eventEmitter</h3><p>æˆ‘åœ¨<a href="https://juejin.im/post/5cdc2f54e51d453b0c35930d#heading-3" target="_blank" rel="noopener">Reactç»„ä»¶è®¾è®¡å®è·µæ€»ç»“04 - ç»„ä»¶çš„æ€ç»´</a>è¿™ç¯‡æ–‡ç« é‡Œé¢æè¿‡ï¼š<strong>è‡ªå®šä¹‰ hook å’Œå‡½æ•°ç»„ä»¶çš„ä»£ç ç»“æ„åŸºæœ¬ä¸€è‡´, æ‰€ä»¥æœ‰æ—¶å€™hooks å†™ç€å†™ç€åŸæ¥è¶Šåƒç»„ä»¶, ç»„ä»¶å†™ç€å†™ç€è¶Šåƒ hooks. æˆ‘è§‰å¾—å¯ä»¥è®¤ä¸ºç»„ä»¶å°±æ˜¯ä¸€ç§ç‰¹æ®Šçš„ hook, åªä¸è¿‡å®ƒè¾“å‡º Virtual DOM</strong></p><p>Hooksè·Ÿç»„ä»¶ä¸€æ ·ï¼Œæ˜¯ä¸€ä¸ªé€»è¾‘å’ŒçŠ¶æ€çš„èšåˆå•å…ƒã€‚å¯ä»¥ç»´æŠ¤è‡ªå·±çš„çŠ¶æ€ã€æœ‰è‡ªå·±çš„â€™ç”Ÿå‘½å‘¨æœŸâ€™.</p><p><code>useEventEmitter</code>å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„ä¾‹å­ï¼Œå¯ä»¥ç‹¬ç«‹åœ°ç»´æŠ¤å’Œé‡Šæ”¾è‡ªå·±çš„èµ„æº:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="function"><span class="keyword">function</span><span class="title">ReturnObject</span> = (<span class="params"></span>) =&gt; (<span class="params">&#123;&#125;</span>)</span></span><br><span class="line"><span class="function"><span class="title">const</span> <span class="function"><span class="keyword">function</span><span class="title">ReturnArray</span> = (<span class="params"></span>) =&gt; []</span></span></span><br><span class="line"><span class="function"><span class="function"></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="title">export</span> <span class="function"><span class="keyword">function</span> <span class="title">useEventEmitter</span>(<span class="params">emmiter: EventEmitter</span>) </span>&#123;</span></span></span><br><span class="line"><span class="function"><span class="function">  <span class="title">const</span> <span class="title">disposers</span> = <span class="title">useRef</span>&lt;<span class="title">Function</span>[]&gt;(<span class="params">[]</span>)</span></span></span><br><span class="line"><span class="function"><span class="function">  <span class="title">const</span> <span class="title">listeners</span> = <span class="title">useRef</span>&lt;</span>&#123; [<span class="title">name</span>: <span class="title">string</span>]: <span class="title">Function</span> &#125;&gt;(<span class="params">&#123;&#125;</span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="title">const</span> <span class="title">on</span> = <span class="title">useCallback</span>(<span class="params">&lt;P&gt;(name: <span class="built_in">string</span>, cb: (data: P) =&gt; <span class="built_in">void</span>) =&gt; &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">if</span> (!(name <span class="keyword">in</span> listeners.current)) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">const</span> call = (...args: <span class="built_in">any</span>[]) =&gt; &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">const</span> fn = listeners.current[name]</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">if</span> (fn) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">          fn(...args)</span></span></span><br><span class="line"><span class="function"><span class="params">        &#125;</span></span></span><br><span class="line"><span class="function"><span class="params">      &#125;</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="comment">// ç›‘å¬eventEmitter</span></span></span></span><br><span class="line"><span class="function"><span class="params">      emmiter.on(name, call)</span></span></span><br><span class="line"><span class="function"><span class="params">      disposers.current.push(() =&gt; &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">        emmiter.off(name, call)</span></span></span><br><span class="line"><span class="function"><span class="params">      &#125;)</span></span></span><br><span class="line"><span class="function"><span class="params">    &#125;</span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    listeners.current[name] = cb</span></span></span><br><span class="line"><span class="function"><span class="params">  &#125;, []</span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="title">useEffect</span>(<span class="params">() =&gt; &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment">// èµ„æºé‡Šæ”¾</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">return</span> () =&gt; &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">      disposers.current.forEach(i =&gt; i())</span></span></span><br><span class="line"><span class="function"><span class="params">    &#125;</span></span></span><br><span class="line"><span class="function"><span class="params">  &#125;, []</span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="title">return</span> </span>&#123;</span><br><span class="line">    on,</span><br><span class="line">    emit: emmiter.emit,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ---------</span></span><br><span class="line"><span class="comment">// EXAMPLE</span></span><br><span class="line"><span class="comment">// ---------</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Demo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; on, emit &#125; = useEventEmitter(eventBus)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// äº‹ä»¶ç›‘å¬</span></span><br><span class="line">  on(<span class="string">'someEvent'</span>, <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> handleClick = useCallback(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// äº‹ä»¶è§¦å‘</span></span><br><span class="line">    emit(<span class="string">'anotherEvent'</span>, someData)</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (&lt;div onClick=&#123;handleClick&#125;&gt;...&lt;<span class="regexp">/div&gt;)</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p><br><br><br></p><p>æ›´å¤šè„‘æ´ï¼š</p><ul><li><a href="https://github.com/mfrachet/use-socketio" target="_blank" rel="noopener">use-socketio</a></li></ul><p><br></p><p><a href="#">â¤´ï¸å›åˆ°é¡¶éƒ¨</a></p><h2 id="4-contextçš„å¦™ç”¨"><a href="#4-contextçš„å¦™ç”¨" class="headerlink" title="4. Contextçš„å¦™ç”¨"></a><strong>4. Contextçš„å¦™ç”¨</strong></h2><p>é€šè¿‡<a href="https://reactjs.org/docs/hooks-reference.html#usecontext" target="_blank" rel="noopener"><code>useContext</code></a>å¯ä»¥æ–¹ä¾¿åœ°å¼•ç”¨Contextã€‚ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯å¦‚æœä¸Šçº§<code>Context.Provider</code>çš„valueå˜åŒ–ï¼Œä½¿ç”¨useContextçš„ç»„ä»¶å°±ä¼šè¢«å¼ºåˆ¶é‡æ–°æ¸²æŸ“ã€‚</p><h3 id="4-1-usetheme-ä¸»é¢˜é…ç½®"><a href="#4-1-usetheme-ä¸»é¢˜é…ç½®" class="headerlink" title="4-1 useTheme ä¸»é¢˜é…ç½®"></a>4-1 useTheme ä¸»é¢˜é…ç½®</h3><p>åŸæœ¬éœ€è¦ä½¿ç”¨é«˜é˜¶ç»„ä»¶æ³¨å…¥æˆ–Context.Consumerè·å–çš„Contextå€¼ï¼Œç°åœ¨å˜å¾—éå¸¸ç®€æ´ï¼š</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¼ ç»Ÿæ–¹å¼</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// é€šè¿‡é«˜é˜¶ç»„ä»¶æ³¨å…¥</span></span><br><span class="line">withTheme(MyComponent)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–åˆ©ç”¨Context.Consumer</span></span><br><span class="line"><span class="keyword">const</span> MyComponentWithTheme = <span class="function">(<span class="params">props</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (&lt;ThemeContext.Consumer&gt;</span><br><span class="line">    &#123;<span class="function"><span class="params">value</span> =&gt;</span> &lt;MyComponent theme=&#123;value&#125; &#123;...props&#125;&gt;&lt;<span class="regexp">/MyComponent&gt;&#125;</span></span><br><span class="line"><span class="regexp">  &lt;/</span>ThemeContext.Consumer&gt;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Hooksæ–¹å¼</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useContext, FC &#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ThemeContext = React.createContext&lt;object&gt;(&#123;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ThemeProvider: FC&lt;&#123; theme: object &#125;&gt; = <span class="function"><span class="params">props</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &lt;ThemeContext.Provider value=&#123;props.theme&#125;&gt;&#123;props.children&#125;&lt;<span class="regexp">/ThemeContext.Provider&gt;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export function useTheme&lt;T extends object&gt;(): T &#123;</span></span><br><span class="line"><span class="regexp">  return useContext(ThemeContext)</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ ---------</span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ EXAMPLE</span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ ---------</span></span><br><span class="line"><span class="regexp">const theme = &#123;</span></span><br><span class="line"><span class="regexp">  primary: '#000',</span></span><br><span class="line"><span class="regexp">  secondary: '#444',</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">function App() &#123;</span></span><br><span class="line"><span class="regexp">  return (</span></span><br><span class="line"><span class="regexp">    &lt;ThemeProvider theme=&#123;theme&#125;&gt;</span></span><br><span class="line"><span class="regexp">      &lt;div&gt;...&lt;/</span>div&gt;</span><br><span class="line">    &lt;<span class="regexp">/ThemeProvider&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">const Button: FC = props =&gt; &#123;</span></span><br><span class="line"><span class="regexp">  const t = useTheme&lt;typeof theme&gt;()</span></span><br><span class="line"><span class="regexp">  const style = &#123;</span></span><br><span class="line"><span class="regexp">    color: t.primary,</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">  return &lt;button style=&#123;style&#125;&gt;&#123;props.children&#125;&lt;/</span>button&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p><a href="#">â¤´ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="4-2-unstated-ç®€å•çŠ¶æ€ç®¡ç†å™¨"><a href="#4-2-unstated-ç®€å•çŠ¶æ€ç®¡ç†å™¨" class="headerlink" title="4-2 unstated ç®€å•çŠ¶æ€ç®¡ç†å™¨"></a>4-2 unstated ç®€å•çŠ¶æ€ç®¡ç†å™¨</h3><p>Hooks + Context ä¹Ÿå¯ä»¥ç”¨äºå®ç°ç®€å•çš„çŠ¶æ€ç®¡ç†ã€‚</p><p>æˆ‘åœ¨<a href="https://juejin.im/post/5ce3ee436fb9a07f070e0220#heading-2" target="_blank" rel="noopener">Reactç»„ä»¶è®¾è®¡å®è·µæ€»ç»“05 - çŠ¶æ€ç®¡ç†</a>å°±æåˆ°è¿‡<a href="https://link.juejin.im/?target=https%3A%2F%2Fgithub.com%2Fjamiebuilds%2Funstated-next" target="_blank" rel="noopener">unstated-next</a>ï¼Œ è¿™ä¸ªåº“åªæœ‰ä¸»ä½“ä»£ç åå‡ è¡Œï¼Œ<strong>åˆ©ç”¨äº†Reactæœ¬èº«çš„æœºåˆ¶æ¥å®ç°çŠ¶æ€ç®¡ç†</strong>.</p><p>å…ˆæ¥çœ‹çœ‹ä½¿ç”¨ç¤ºä¾‹</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useState &#125; <span class="keyword">from</span> <span class="string">"react"</span></span><br><span class="line"><span class="keyword">import</span> &#123; createContainer &#125; <span class="keyword">from</span> <span class="string">"unstated-next"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useCounter</span>(<span class="params">initialState = 0</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> [count, setCount] = useState(initialState)</span><br><span class="line">  <span class="keyword">let</span> decrement = <span class="function"><span class="params">()</span> =&gt;</span> setCount(count - <span class="number">1</span>)</span><br><span class="line">  <span class="keyword">let</span> increment = <span class="function"><span class="params">()</span> =&gt;</span> setCount(count + <span class="number">1</span>)</span><br><span class="line">  <span class="keyword">return</span> &#123; count, decrement, increment &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> Counter = createContainer(useCounter)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">CounterDisplay</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> counter = Counter.useContainer()</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;button onClick=&#123;counter.decrement&#125;&gt;-&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">      &lt;span&gt;&#123;counter.count&#125;&lt;/</span>span&gt;</span><br><span class="line">      &lt;button onClick=&#123;counter.increment&#125;&gt;+&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹çœ‹å®ƒçš„æºç :</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createContainer</span>(<span class="params">useHook</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// åªæ˜¯åˆ›å»ºä¸€ä¸ªContext</span></span><br><span class="line"><span class="keyword">let</span> Context = React.createContext(<span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Provider</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line"><span class="keyword">let</span> value = useHook(props.initialState)</span><br><span class="line"><span class="keyword">return</span> &lt;Context.Provider value=&#123;value&#125;&gt;&#123;props.children&#125;&lt;<span class="regexp">/Context.Provider&gt;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">function useContainer() &#123;</span></span><br><span class="line"><span class="regexp">    /</span><span class="regexp">/ åªæ˜¯ä½¿ç”¨useContext</span></span><br><span class="line"><span class="regexp">let value = React.useContext(Context)</span></span><br><span class="line"><span class="regexp">if (value === null) &#123;</span></span><br><span class="line"><span class="regexp">throw new Error("Component must be wrapped with &lt;Container.Provider&gt;")</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">return value</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">return &#123; Provider, useContainer &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export function useContainer(container) &#123;</span></span><br><span class="line"><span class="regexp">return container.useContainer()</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œï¼Œä½ ä¼šè¯´ï¼Œæˆ‘é ï¼Œå°±è¿™æ ·? è¿™ä¸ªåº“æ„Ÿè§‰å•¥äº‹æƒ…éƒ½æ²¡å¹²å•Š?</p><p>éœ€è¦æ³¨æ„çš„æ˜¯, <strong>Contextä¸æ˜¯ä¸‡é‡‘æ²¹ï¼Œå®ƒä½œä¸ºçŠ¶æ€ç®¡ç†æœ‰ä¸€ä¸ªæ¯”è¾ƒè‡´å‘½çš„ç¼ºé™·</strong>ï¼Œæˆ‘åœ¨<a href="https://juejin.im/post/5d045350f265da1b695d5bf2#heading-14" target="_blank" rel="noopener">æµ…è°ˆReactæ€§èƒ½ä¼˜åŒ–çš„æ–¹å‘</a>æ–‡ç« ä¸­ä¹Ÿæåˆ°äº†è¿™ä¸€ç‚¹:<br><strong>å®ƒæ˜¯å¯ä»¥ç©¿é€React.memoæˆ–è€…shouldComponentUpdateçš„æ¯”å¯¹çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€æ—¦ Context çš„ Value å˜åŠ¨ï¼Œæ‰€æœ‰ä¾èµ–è¯¥ Context çš„ç»„ä»¶ä¼šå…¨éƒ¨ forceUpdate</strong></p><p>æ‰€ä»¥å¦‚æœä½ æ‰“ç®—ä½¿ç”¨Contextä½œä¸ºçŠ¶æ€ç®¡ç†ï¼Œä¸€å®šè¦æ³¨æ„è§„é¿è¿™ä¸€ç‚¹. å®ƒå¯èƒ½ä¼šå¯¼è‡´ç»„ä»¶é¢‘ç¹é‡æ–°æ¸²æŸ“.</p><p><br></p><p>å…¶ä»–çŠ¶æ€ç®¡ç†æ–¹æ¡ˆ:</p><ul><li><a href="https://github.com/ctrlplusb/easy-peasy" target="_blank" rel="noopener">easy-peasy</a></li><li><a href="https://github.com/dai-shi/react-hooks-global-state" target="_blank" rel="noopener">react-hooks-global-state</a></li></ul><p><br></p><p><a href="#">â¤´ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="4-3-usei18n-å›½é™…åŒ–"><a href="#4-3-usei18n-å›½é™…åŒ–" class="headerlink" title="4-3 useI18n å›½é™…åŒ–"></a>4-3 useI18n å›½é™…åŒ–</h3><p>I18næ˜¯å¦ä¸€ä¸ªContextçš„å…¸å‹ä½¿ç”¨åœºæ™¯ã€‚<a href="https://github.com/formatjs/react-intl/blob/master/docs/API.md#useintl-hook-currently-available-in-300-beta" target="_blank" rel="noopener">react-intl</a>å’Œ<a href="https://react.i18next.com/latest/usetranslation-hook" target="_blank" rel="noopener">react-i18next</a>éƒ½ä¸æ—¶ä¿±è¿›ï¼Œæ¨å‡ºäº†è‡ªå·±çš„Hook API, <strong>åŸºæœ¬ä¸ŠåŸæœ¬ä½¿ç”¨é«˜é˜¶ç»„ä»¶(HOC)å®ç°çš„åŠŸèƒ½éƒ½å¯ä»¥ç”¨Hooksä»£æ›¿ï¼Œè®©ä»£ç å˜å¾—æ›´åŠ ç®€æ´</strong>:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; useTranslation &#125; <span class="keyword">from</span> <span class="string">'react-i18next'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">MyComponent</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; t, i18n &#125; = useTranslation();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;t('my translated text')&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p><a href="#">â¤´ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="4-4-userouter-ç®€åŒ–è·¯ç”±çŠ¶æ€çš„è®¿é—®"><a href="#4-4-userouter-ç®€åŒ–è·¯ç”±çŠ¶æ€çš„è®¿é—®" class="headerlink" title="4-4 useRouter ç®€åŒ–è·¯ç”±çŠ¶æ€çš„è®¿é—®"></a>4-4 useRouter ç®€åŒ–è·¯ç”±çŠ¶æ€çš„è®¿é—®</h3><p>React Hooks æ¨å‡ºå·²ç»æ¥è¿‘ä¸€å¹´ï¼ŒReactRouterç«Ÿç„¶è¿˜æ²¡æœ‰æ­£å¼æ¨å‡ºHook APIã€‚ä¸è¿‡å®ƒä»¬ä¹Ÿæä¸Šäº†è®¡åˆ’ â€”â€” <a href="https://reacttraining.com/blog/reach-react-router-future/" target="_blank" rel="noopener">The Future of React Router and @reach/router</a>ï¼Œ5.Xç‰ˆæœ¬ä¼šæ¨å‡ºHook API. æˆ‘ä»¬æš‚æ—¶å…ˆçœ‹çœ‹ä¸€äº›ä»£ç ç¤ºä¾‹:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">SomeComponent</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// è®¿é—®è·¯ç”±å˜é‡</span></span><br><span class="line">  <span class="keyword">const</span> &#123; userId &#125; = useParams()</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">usePageViews</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// è®¿é—®locationå¯¹è±¡</span></span><br><span class="line">  <span class="comment">// åŸæœ¬å¯¹äºéè·¯ç”±ç»„ä»¶ï¼Œéœ€è¦è®¿é—®è·¯ç”±ä¿¡æ¯éœ€è¦é€šè¿‡withRouteré«˜é˜¶ç»„ä»¶æ³¨å…¥</span></span><br><span class="line">  <span class="keyword">const</span> &#123; location &#125; = useLocation()</span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    ga(<span class="string">'send'</span>, <span class="string">'pageview'</span>, location.pathname)</span><br><span class="line">  &#125;, [location])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†ç­‰ç­‰å§!</p><p><br></p><p><a href="#">â¤´ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="4-5-react-hook-form-hookså’Œè¡¨å•èƒ½æ“¦å‡ºä»€ä¹ˆç«èŠ±"><a href="#4-5-react-hook-form-hookså’Œè¡¨å•èƒ½æ“¦å‡ºä»€ä¹ˆç«èŠ±" class="headerlink" title="4-5 react-hook-form Hookså’Œè¡¨å•èƒ½æ“¦å‡ºä»€ä¹ˆç«èŠ±?"></a>4-5 react-hook-form Hookså’Œè¡¨å•èƒ½æ“¦å‡ºä»€ä¹ˆç«èŠ±?</h3><p><a href="https://github.com/react-hook-form/react-hook-form" target="_blank" rel="noopener">react-hook-form</a>æ˜¯Hooks+Formçš„å…¸å‹æ¡ˆä¾‹ï¼Œæ¯”è¾ƒç¬¦åˆæˆ‘ç†æƒ³ä¸­çš„è¡¨å•ç®¡ç†æ–¹å¼:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> useForm <span class="keyword">from</span> <span class="string">'react-hook-form'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; register, handleSubmit, errors &#125; = useForm(); <span class="comment">// initialise the hook</span></span><br><span class="line">  <span class="keyword">const</span> onSubmit = <span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(data);</span><br><span class="line">  &#125;; <span class="comment">// callback when validation pass</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;form onSubmit=&#123;handleSubmit(onSubmit)&#125;&gt;</span><br><span class="line">      &lt;input name=<span class="string">"firstname"</span> ref=&#123;register&#125; /&gt; &#123;<span class="comment">/* register an input */</span>&#125;</span><br><span class="line">      </span><br><span class="line">      &lt;input name=<span class="string">"lastname"</span> ref=&#123;register(&#123; <span class="attr">required</span>: <span class="literal">true</span> &#125;)&#125; /&gt;</span><br><span class="line">      &#123;errors.lastname &amp;&amp; <span class="string">'Last name is required.'</span>&#125;</span><br><span class="line">      </span><br><span class="line">      &lt;input name=<span class="string">"age"</span> ref=&#123;register(&#123; <span class="attr">pattern</span>: <span class="regexp">/\d+/</span> &#125;)&#125; /&gt;</span><br><span class="line">      &#123;errors.age &amp;&amp; <span class="string">'Please enter number for age.'</span>&#125;</span><br><span class="line">      </span><br><span class="line">      &lt;input type=<span class="string">"submit"</span> /&gt;</span><br><span class="line">    &lt;<span class="regexp">/form&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p><br></p><p><a href="#">â¤´ï¸å›åˆ°é¡¶éƒ¨</a></p><p><br></p><h2 id="5-å‰¯ä½œç”¨å°è£…"><a href="#5-å‰¯ä½œç”¨å°è£…" class="headerlink" title="5. å‰¯ä½œç”¨å°è£…"></a><strong>5. å‰¯ä½œç”¨å°è£…</strong></h2><p>æˆ‘ä»¬å¯ä»¥<strong>åˆ©ç”¨Hooksæ¥å°è£…æˆ–ç›‘å¬ç»„ä»¶å¤–éƒ¨çš„å‰¯ä½œç”¨ï¼Œå°†å®ƒä»¬è½¬æ¢ä¸ºç»„ä»¶çš„çŠ¶æ€</strong>ã€‚</p><p><br></p><h3 id="5-1-usetimeout-è¶…æ—¶ä¿®æ”¹çŠ¶æ€"><a href="#5-1-usetimeout-è¶…æ—¶ä¿®æ”¹çŠ¶æ€" class="headerlink" title="5-1 useTimeout è¶…æ—¶ä¿®æ”¹çŠ¶æ€"></a>5-1 useTimeout è¶…æ—¶ä¿®æ”¹çŠ¶æ€</h3><p>useTimeoutç”±ç”¨æˆ·è§¦å‘ï¼Œåœ¨æŒ‡å®šæ—¶é—´åæ¢å¤çŠ¶æ€. æ¯”å¦‚å¯ä»¥ç”¨äºâ€™çŸ­æœŸç¦ç”¨â€™æŒ‰é’®, é¿å…é‡å¤ç‚¹å‡»:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Demo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [disabled, start] = useTimeout(<span class="number">5000</span>)</span><br><span class="line">  <span class="keyword">const</span> handleClick = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    start()</span><br><span class="line">    dosomething()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &lt;Button onClick=&#123;handleClick&#125; disabled=&#123;disabled&#125;&gt;ç‚¹æˆ‘&lt;<span class="regexp">/Button&gt;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p>å®ç°:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useTimeout</span>(<span class="params">ms: <span class="built_in">string</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [ready, setReady] = useState(<span class="literal">false</span>)</span><br><span class="line">  <span class="keyword">const</span> timerRef = useRef&lt;<span class="built_in">number</span>&gt;()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> start = useCallback(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    clearTimeout(timerRef.current)</span><br><span class="line">    setReady(<span class="literal">true</span>)</span><br><span class="line">    timerRef.current = setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      setReady(<span class="literal">false</span>)</span><br><span class="line">    &#125;, ms)</span><br><span class="line">  &#125;, [ms])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> stop = useCallback(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    clearTimeout(timeRef.current)</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  useOnUnmount(stop)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> [ready, start, stop]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p><a href="#">â¤´ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="5-2-useonlinestatus-ç›‘å¬åœ¨çº¿çŠ¶æ€"><a href="#5-2-useonlinestatus-ç›‘å¬åœ¨çº¿çŠ¶æ€" class="headerlink" title="5-2 useOnlineStatus ç›‘å¬åœ¨çº¿çŠ¶æ€"></a>5-2 useOnlineStatus ç›‘å¬åœ¨çº¿çŠ¶æ€</h3><p>å‰¯ä½œç”¨å°è£…ä¸€ä¸ªæ¯”è¾ƒå…¸å‹çš„æ¡ˆä¾‹å°±æ˜¯ç›‘å¬ä¸»æœºçš„åœ¨çº¿çŠ¶æ€ï¼š</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getOnlineStatus</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> navigator.onLine === <span class="string">'boolean'</span> ? navigator.onLine : <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useOnlineStatus</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> [onlineStatus, setOnlineStatus] = useState(getOnlineStatus())</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> online = <span class="function"><span class="params">()</span> =&gt;</span> setOnlineStatus(<span class="literal">true</span>)</span><br><span class="line">    <span class="keyword">const</span> offline = <span class="function"><span class="params">()</span> =&gt;</span> setOnlineStatus(<span class="literal">false</span>)</span><br><span class="line">    <span class="built_in">window</span>.addEventListener(<span class="string">'online'</span>, online)</span><br><span class="line">    <span class="built_in">window</span>.addEventListener(<span class="string">'offline'</span>, offline)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">window</span>.removeEventListener(<span class="string">'online'</span>, online)</span><br><span class="line">      <span class="built_in">window</span>.removeEventListener(<span class="string">'offline'</span>, offline)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> onlineStatus</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// --------</span></span><br><span class="line"><span class="comment">// EXAMPLE</span></span><br><span class="line"><span class="comment">// --------</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Demo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> onlineStatus = useOnlineStatus();</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h1&gt;ç½‘ç»œçŠ¶æ€: &#123;onlineStatus ? <span class="string">"åœ¨çº¿"</span> : <span class="string">"ç¦»çº¿"</span>&#125;&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>è¿˜æœ‰å¾ˆå¤šæ¡ˆä¾‹, è¿™é‡Œå°±ä¸ä¸€ä¸€åˆ—ä¸¾ï¼Œè¯»è€…å¯ä»¥è‡ªå·±å°è¯•å»å®ç°ï¼Œæ¯”å¦‚:</p><ul><li>useDeviceOrientation ç›‘å¬è®¾å¤‡æ–¹å‘</li><li>useGeolocation ç›‘å¬GPSåæ ‡å˜åŒ–</li><li>useScrollPosition ç›‘å¬æ»šåŠ¨ä½ç½®</li><li>useMotion ç›‘å¬è®¾å¤‡è¿åŠ¨</li><li>useMediaDevice ç›‘å¬åª’ä½“è®¾å¤‡</li><li>useDarkMode å¤œé—´æ¨¡å¼ç›‘å¬</li><li>useKeyBindings ç›‘å¬å¿«æ·é”®</li><li>â€¦.</li></ul><p><br></p><p><a href="#">â¤´ï¸å›åˆ°é¡¶éƒ¨</a></p><p><br></p><h2 id="6-å‰¯ä½œç”¨è¡ç”Ÿ"><a href="#6-å‰¯ä½œç”¨è¡ç”Ÿ" class="headerlink" title="6. å‰¯ä½œç”¨è¡ç”Ÿ"></a><strong>6. å‰¯ä½œç”¨è¡ç”Ÿ</strong></h2><p><strong>å’Œ<code>å‰¯ä½œç”¨å°è£…</code>ç›¸åï¼Œå‰¯ä½œç”¨è¡ç”Ÿæ˜¯æŒ‡å½“ç»„ä»¶çŠ¶æ€å˜åŒ–æ—¶ï¼Œè¡ç”Ÿå‡ºå…¶ä»–å‰¯ä½œç”¨. ä¸¤è€…çš„æ–¹å‘æ˜¯ç›¸åçš„</strong>.</p><p>å‰¯ä½œç”¨è¡ç”Ÿä¸»è¦ä¼šç”¨åˆ°useEffectï¼Œä½¿ç”¨useEffectæ¥å“åº”çŠ¶æ€çš„å˜åŒ–.</p><h3 id="6-1-usetitle-è®¾ç½®æ–‡æ¡£title"><a href="#6-1-usetitle-è®¾ç½®æ–‡æ¡£title" class="headerlink" title="6-1 useTitle è®¾ç½®æ–‡æ¡£title"></a>6-1 useTitle è®¾ç½®æ–‡æ¡£title</h3><p>useTitleæ˜¯æœ€ç®€å•çš„ï¼Œå½“ç»™å®šçš„å€¼å˜åŒ–æ—¶ï¼Œæ›´æ–°<code>document.title</code></p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useTitle</span>(<span class="params">t: <span class="built_in">string</span></span>) </span>&#123;</span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">document</span>.title = t</span><br><span class="line">  &#125;, [t])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// --------</span></span><br><span class="line"><span class="comment">// EXAMPLE</span></span><br><span class="line"><span class="comment">// --------</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Demo</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  useTitle(props.isEdit ? <span class="string">'ç¼–è¾‘'</span> : <span class="string">'æ–°å¢'</span>)</span><br><span class="line">  <span class="comment">// ....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p><a href="#">â¤´ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="6-2-usedebounce"><a href="#6-2-usedebounce" class="headerlink" title="6-2 useDebounce"></a>6-2 useDebounce</h3><p>å†æ¥ä¸ªå¤æ‚ä¸€ç‚¹çš„ï¼ŒuseDebounceï¼šå½“æŸäº›çŠ¶æ€å˜åŒ–æ—¶ï¼Œå®ƒä¼šå»¶è¿Ÿæ‰§è¡ŒæŸäº›æ“ä½œï¼š</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useDebounce</span>(<span class="params">fn: () =&gt; <span class="built_in">void</span>, args?: <span class="built_in">any</span>[], ms: <span class="built_in">number</span> = 100, skipMount?: <span class="built_in">boolean</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> mounted = useRef(<span class="literal">false</span>)</span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// è·³è¿‡æŒ‚è½½æ‰§è¡Œ</span></span><br><span class="line">    <span class="keyword">if</span> (skipMount &amp;&amp; !mounted.current) &#123;</span><br><span class="line">      mounted.current = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">undefined</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> timer = setTimeout(fn, ms)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// å¦‚æœargså˜åŒ–ï¼Œå…ˆæ¸…é™¤è®¡æ—¶å™¨</span></span><br><span class="line">      clearTimeout(timer)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, args)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -----------</span></span><br><span class="line"><span class="comment">// EXAMPLE</span></span><br><span class="line"><span class="comment">// -----------</span></span><br><span class="line"><span class="keyword">const</span> returnEmptyArray = <span class="function"><span class="params">()</span> =&gt;</span> []</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Demo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [query, setQuery] = useState(<span class="string">''</span>)</span><br><span class="line">  <span class="keyword">const</span> [list, setList] = useState(returnEmptyArray)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æœç´¢</span></span><br><span class="line">  <span class="keyword">const</span> handleSearch = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    setList(<span class="keyword">await</span> fetchList(query))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å½“queryå˜åŒ–æ—¶æ‰§è¡Œæœç´¢</span></span><br><span class="line">  useDebounce(handleSearch, [query], <span class="number">500</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (&lt;div&gt;</span><br><span class="line">    &lt;SearchBar value=&#123;query&#125; onChange=&#123;setQuery&#125; /&gt;</span><br><span class="line">    &lt;Result list=&#123;list&#125;&gt;&lt;<span class="regexp">/Result&gt;</span></span><br><span class="line"><span class="regexp">  &lt;/</span>div&gt;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p><a href="#">â¤´ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="6-3-usethrottle"><a href="#6-3-usethrottle" class="headerlink" title="6-3 useThrottle"></a>6-3 useThrottle</h3><p>åŒç†å¯ä»¥å®ç°useThrottle, ä¸‹é¢çš„ä¾‹å­æ¥æºäº<a href="https://github.com/streamich/react-use/blob/master/src/useThrottleFn.ts" target="_blank" rel="noopener">react-use</a>:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> useThrottleFn = &lt;T&gt;<span class="function">(<span class="params">fn: (<span class="params">...args: <span class="built_in">any</span>[]</span>) =&gt; T, ms: <span class="built_in">number</span> = 200, args: <span class="built_in">any</span>[]</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [state, setState] = useState&lt;T&gt;(<span class="literal">null</span> <span class="keyword">as</span> <span class="built_in">any</span>);</span><br><span class="line">  <span class="keyword">const</span> timeout = useRef&lt;<span class="built_in">any</span>&gt;(<span class="literal">null</span>);</span><br><span class="line">  <span class="keyword">const</span> nextArgs = useRef(<span class="literal">null</span>) <span class="keyword">as</span> <span class="built_in">any</span>;</span><br><span class="line">  <span class="keyword">const</span> hasNextArgs = useRef(<span class="literal">false</span>) <span class="keyword">as</span> <span class="built_in">any</span>;</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!timeout.current) &#123;</span><br><span class="line">      setState(fn(...args));</span><br><span class="line">      <span class="keyword">const</span> timeoutCallback = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (hasNextArgs.current) &#123;</span><br><span class="line">          hasNextArgs.current = <span class="literal">false</span>;</span><br><span class="line">          setState(fn(...nextArgs.current));</span><br><span class="line">          timeout.current = setTimeout(timeoutCallback, ms);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          timeout.current = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">      timeout.current = setTimeout(timeoutCallback, ms);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      nextArgs.current = args;</span><br><span class="line">      hasNextArgs.current = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, args);</span><br><span class="line"></span><br><span class="line">  useOnUnmount(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    clearTimeout(timeout.current);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> state;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><br></p><p><a href="#">â¤´ï¸å›åˆ°é¡¶éƒ¨</a></p><p><br></p><h2 id="7-ç®€åŒ–ä¸šåŠ¡é€»è¾‘"><a href="#7-ç®€åŒ–ä¸šåŠ¡é€»è¾‘" class="headerlink" title="7. ç®€åŒ–ä¸šåŠ¡é€»è¾‘"></a><strong>7. ç®€åŒ–ä¸šåŠ¡é€»è¾‘</strong></h2><p><strong>80%çš„ç¨‹åºå‘˜80%çš„æ—¶é—´åœ¨å†™ä¸šåŠ¡ä»£ç </strong>. æœ‰äº†Hooksï¼ŒReactå¼€å‘è€…å¦‚è·è‡³å®. ç»„ä»¶çš„ä»£ç å¯ä»¥å˜å¾—å¾ˆç²¾ç®€ï¼Œä¸”è¿™äº›Hookså¯ä»¥æ–¹ä¾¿åœ°åœ¨ç»„ä»¶ä¹‹é—´å¤ç”¨:</p><p><img src="/images/react-hooks/hooks-transform.png" alt></p><p><br></p><p>ä¸‹é¢ä»‹ç»ï¼Œå¦‚ä½•åˆ©ç”¨Hooksæ¥ç®€åŒ–ä¸šåŠ¡ä»£ç </p><h3 id="7-1-usepromise-å°è£…å¼‚æ­¥è¯·æ±‚"><a href="#7-1-usepromise-å°è£…å¼‚æ­¥è¯·æ±‚" class="headerlink" title="7-1 usePromise å°è£…å¼‚æ­¥è¯·æ±‚"></a>7-1 usePromise å°è£…å¼‚æ­¥è¯·æ±‚</h3><p>ç¬¬ä¸€ä¸ªä¾‹å­ï¼Œè¯•è¯•å°è£…ä¸€ä¸‹promiseï¼Œç®€åŒ–ç®€å•é¡µé¢å¼‚æ­¥è¯·æ±‚çš„æµç¨‹. å…ˆæ¥çœ‹çœ‹usePromiseçš„ä½¿ç”¨ç¤ºä¾‹ï¼Œæˆ‘ç†æƒ³ä¸­çš„usePromiseåº”è¯¥é•¿è¿™æ ·:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">function Demo() &#123;</span><br><span class="line">  const list = usePromise(async (id: string) =&gt; &#123;</span><br><span class="line">    return fetchList(id)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  return (&lt;div&gt;</span><br><span class="line">    &#123;/* è§¦å‘è¯·æ±‚ */&#125;</span><br><span class="line">    &lt;button onClick=&#123;() =&gt; list.callIgnoreError(&apos;myId&apos;)&#125;&gt;Get List&lt;/button&gt;</span><br><span class="line">    &#123;/* é”™è¯¯ä¿¡æ¯å±•ç¤ºå’Œé‡è¯• */&#125;</span><br><span class="line">    &#123;!!list.error &amp;&amp; &lt;ErrorMessage error=&#123;list.error&#125; retry=&#123;list.retry&#125;&gt;åŠ è½½å¤±è´¥:&lt;/ErrorMessage&gt;&#125;</span><br><span class="line">    &#123;/* åŠ è½½çŠ¶æ€ */&#125;</span><br><span class="line">    &lt;Loader loading=&#123;list.loading&#125;&gt;</span><br><span class="line">      &#123;/* è¯·æ±‚ç»“æœ */&#125;</span><br><span class="line">      &lt;Result value=&#123;list.value&#125;&gt;&lt;/Result&gt;</span><br><span class="line">    &lt;/Loader&gt;</span><br><span class="line">  &lt;/div&gt;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>usePromiseæ˜¯æˆ‘ç”¨å¾—æ¯”è¾ƒå¤šçš„ä¸€ä¸ªHooksï¼Œæ‰€ä»¥æˆ‘æŠŠå®ƒå®Œæ•´çš„ä»£ç ï¼ŒåŒ…æ‹¬Typescriptæ³¨è§£éƒ½è´´å‡ºæ¥ï¼Œä¾›å¤§å®¶å‚è€ƒå‚è€ƒ:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å®šä¹‰usePromiseçš„è¿”å›å€¼</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> Res&lt;T, S&gt; &#123;</span><br><span class="line">  loading: <span class="built_in">boolean</span></span><br><span class="line">  error?: <span class="built_in">Error</span></span><br><span class="line">  value?: S</span><br><span class="line">  setValue: <span class="function">(<span class="params">v: S</span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">  call: T</span><br><span class="line">  callIgnoreError: T</span><br><span class="line">  reset: <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">void</span></span><br><span class="line">  retry: <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">void</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®šä¹‰usePromise å‚æ•°</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> UsePromiseOptions &#123;</span><br><span class="line">  <span class="comment">// å¦‚æœpromiseæ­£åœ¨åŠ è½½ä¸­åˆ™è·³è¿‡ï¼Œé»˜è®¤ä¸ºtrue</span></span><br><span class="line">  skipOnLoading?: <span class="built_in">boolean</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ğŸ‘‡ ä¸‹é¢æ˜¯ä¸€å †Typescriptå‡½æ•°é‡è½½å£°æ˜ï¼Œä¸ºäº†æ–¹ä¾¿Typescriptæ¨æ–­æ³›å‹å˜é‡. å°ç™½å¯ä»¥è·³è¿‡</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">usePromise</span>&lt;<span class="title">T</span>&gt;(<span class="params">action: () =&gt; <span class="built_in">Promise</span>&lt;T&gt;, option?: UsePromiseOptions</span>): <span class="title">Res</span>&lt;(<span class="params"></span>) =&gt; <span class="title">Promise</span>&lt;<span class="title">T</span>&gt;, <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="function"><span class="function"><span class="keyword">function</span> <span class="title">usePromise</span>&lt;<span class="title">T</span>, <span class="title">A</span>&gt;(<span class="params">action: (arg0: A) =&gt; <span class="built_in">Promise</span>&lt;T&gt;, option?: UsePromiseOptions</span>): <span class="title">Res</span>&lt;(<span class="params">arg0: A</span>) =&gt; <span class="title">Promise</span>&lt;<span class="title">T</span>&gt;, <span class="title">T</span>&gt;</span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="keyword">function</span> <span class="title">usePromise</span>&lt;<span class="title">T</span>, <span class="title">A</span>, <span class="title">B</span>&gt;(<span class="params">action: (arg0: A, arg1: B) =&gt; <span class="built_in">Promise</span>&lt;T&gt;, option?: UsePromiseOptions</span>): <span class="title">Res</span>&lt;(<span class="params">arg0: A, arg1: B</span>) =&gt; <span class="title">Promise</span>&lt;<span class="title">T</span>&gt;, <span class="title">T</span>&gt;</span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="keyword">function</span> <span class="title">usePromise</span>&lt;<span class="title">T</span>, <span class="title">A</span>, <span class="title">B</span>, <span class="title">C</span>&gt;(<span class="params"> action: (arg0: A, arg1: B, arg2: C) =&gt; <span class="built_in">Promise</span>&lt;T&gt;, option?: UsePromiseOptions</span>): <span class="title">Res</span>&lt;(<span class="params">arg0: A, arg1: B, arg2: C</span>) =&gt; <span class="title">Promise</span>&lt;<span class="title">T</span>&gt;, <span class="title">T</span>&gt;</span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="keyword">function</span> <span class="title">usePromise</span>&lt;<span class="title">T</span>, <span class="title">A</span>, <span class="title">B</span>, <span class="title">C</span>, <span class="title">D</span>&gt;(<span class="params">action: (arg0: A, arg1: B, arg2: C, arg3: D) =&gt; <span class="built_in">Promise</span>&lt;T&gt;, option?: UsePromiseOptions</span>): <span class="title">Res</span>&lt;(<span class="params">arg0: A, arg1: B, arg2: C, arg3: D</span>) =&gt; <span class="title">Promise</span>&lt;<span class="title">T</span>&gt;, <span class="title">T</span>&gt;</span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="keyword">function</span> <span class="title">usePromise</span>(<span class="params">action: (...args: <span class="built_in">any</span>[]) =&gt; <span class="built_in">Promise</span>&lt;<span class="built_in">any</span>&gt;, option?: UsePromiseOptions</span>): <span class="title">Res</span>&lt;(<span class="params">...args: <span class="built_in">any</span></span>) =&gt; <span class="title">Promise</span>&lt;<span class="title">any</span>&gt;, <span class="title">any</span>&gt;</span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">// ğŸ‘† ä¸Šé¢æ˜¯ä¸€å †<span class="title">Typescript</span>å‡½æ•°é‡è½½å£°æ˜ï¼Œå¯ä»¥è·³è¿‡</span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">/**</span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"> * æ¥å—ä¸€ä¸ª<span class="title">action</span>ï¼Œç”¨äºæ‰§è¡Œå¼‚æ­¥æ“ä½œ</span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"> */</span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="keyword">function</span> <span class="title">usePromise</span>(<span class="params"></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">  action: (...args: <span class="built_in">any</span>[]) =&gt; <span class="built_in">Promise</span>&lt;<span class="built_in">any</span>&gt;,</span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">  option: UsePromiseOptions = &#123; skipOnLoading: <span class="literal">true</span> &#125;,</span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params"></span>): <span class="title">Res</span>&lt;(<span class="params">...args: <span class="built_in">any</span></span>) =&gt; <span class="title">Promise</span>&lt;<span class="title">any</span>&gt;, <span class="title">any</span>&gt; </span>&#123;</span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">  <span class="title">const</span> <span class="title">actionRef</span> = <span class="title">useRefProps</span>(<span class="params">action</span>)</span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">  <span class="title">const</span> <span class="title">optionRef</span> = <span class="title">useRefProps</span>(<span class="params">option</span>)</span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">  <span class="title">const</span> [<span class="title">loading</span>, <span class="title">setLoading</span>, <span class="title">loadingRef</span>] = <span class="title">useRefState</span>(<span class="params"><span class="literal">false</span></span>)</span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">  <span class="title">const</span> <span class="title">taskIdRef</span> = <span class="title">useRef</span>&lt;<span class="title">number</span>&gt;(<span class="params"></span>)</span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">  <span class="title">const</span> <span class="title">argsRef</span> = <span class="title">useRef</span>&lt;<span class="title">any</span>[]&gt;(<span class="params"></span>)</span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">  <span class="title">const</span> [<span class="title">value</span>, <span class="title">setValue</span>] = <span class="title">useState</span>(<span class="params"></span>)</span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">  <span class="title">const</span> [<span class="title">error</span>, <span class="title">setError</span>, <span class="title">errorRef</span>] = <span class="title">useRefState</span>&lt;<span class="title">Error</span> | <span class="title">undefined</span>&gt;(<span class="params"></span>)</span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">  <span class="title">const</span> <span class="title">caller</span> = <span class="title">useCallback</span>(<span class="params"><span class="keyword">async</span> (...args: <span class="built_in">any</span>[]) =&gt; &#123;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">    argsRef.current = args</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">    <span class="keyword">if</span> (loadingRef.current &amp;&amp; optionRef.current.skipOnLoading) &#123;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">      <span class="keyword">return</span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">    &#125;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">    <span class="keyword">const</span> taskId = getUid()</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">    taskIdRef.current = taskId</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params"></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">    <span class="comment">// å·²ç»æœ‰æ–°çš„ä»»åŠ¡åœ¨æ‰§è¡Œäº†ï¼Œä»€ä¹ˆéƒ½ä¸åš</span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">    <span class="keyword">const</span> shouldContinue = () =&gt; &#123;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">      <span class="keyword">if</span> (taskId !== taskIdRef.current) &#123;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">        <span class="keyword">return</span> <span class="literal">false</span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">      &#125;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">      <span class="keyword">return</span> <span class="literal">true</span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">    &#125;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params"></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">    <span class="keyword">try</span> &#123;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">      setLoading(<span class="literal">true</span>)</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">      setError(<span class="literal">undefined</span>)</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">      <span class="keyword">const</span> res = <span class="keyword">await</span> actionRef.current(...args)</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params"></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">      <span class="keyword">if</span> (!shouldContinue()) <span class="keyword">return</span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">      setValue(res)</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">      <span class="keyword">return</span> res</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">    &#125; <span class="keyword">catch</span> (err) &#123;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">      <span class="keyword">if</span> (shouldContinue()) &#123;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">        setError(err)</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">      &#125;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">      <span class="keyword">throw</span> err</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">    &#125; <span class="keyword">finally</span> &#123;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">      <span class="keyword">if</span> (shouldContinue()) &#123;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">        setLoading(<span class="literal">false</span>)</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">      &#125;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">    &#125;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">  &#125;, []</span>)</span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">  // ä¸æŠ›å‡ºå¼‚å¸¸</span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">  <span class="title">const</span> <span class="title">callIgnoreError</span> = <span class="title">useCallback</span>(<span class="params"></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">    <span class="keyword">async</span> (...args: <span class="built_in">any</span>[]) =&gt; &#123;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">      <span class="keyword">try</span> &#123;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">        <span class="keyword">return</span> <span class="keyword">await</span> caller(...args)</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">      &#125; <span class="keyword">catch</span> &#123;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">        <span class="comment">// ignore</span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">      &#125;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">    &#125;,</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">    [caller],</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">  </span>)</span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">  <span class="title">const</span> <span class="title">reset</span> = <span class="title">useCallback</span>(<span class="params">() =&gt; &#123;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">    setLoading(<span class="literal">false</span>)</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">    setValue(<span class="literal">undefined</span>)</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">    setError(<span class="literal">undefined</span>)</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">  &#125;, []</span>)</span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">  // å¤±è´¥åé‡è¯•</span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">  <span class="title">const</span> <span class="title">retry</span> = <span class="title">useCallback</span>(<span class="params">() =&gt; &#123;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">    <span class="keyword">if</span> (argsRef.current &amp;&amp; errorRef.current) &#123;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">      <span class="keyword">return</span> callIgnoreError(...argsRef.current)</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">    &#125;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(`not call yet`)</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">  &#125;, []</span>)</span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">  <span class="title">return</span> </span>&#123;</span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">    <span class="title">loading</span>,</span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">    <span class="title">error</span>,</span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">    <span class="title">call</span>: <span class="title">caller</span>,</span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">    <span class="title">callIgnoreError</span>,</span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">    <span class="title">value</span>,</span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">    <span class="title">setValue</span>,</span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">    <span class="title">reset</span>,</span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">    <span class="title">retry</span>,</span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">  &#125;</span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">&#125;</span></span></span></span></span></span><br></pre></td></tr></table></figure><p><br></p><p><a href="#">â¤´ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="7-2-usepromiseeffect-è‡ªåŠ¨è¿›è¡Œå¼‚æ­¥è¯·æ±‚"><a href="#7-2-usepromiseeffect-è‡ªåŠ¨è¿›è¡Œå¼‚æ­¥è¯·æ±‚" class="headerlink" title="7-2 usePromiseEffect è‡ªåŠ¨è¿›è¡Œå¼‚æ­¥è¯·æ±‚"></a>7-2 usePromiseEffect è‡ªåŠ¨è¿›è¡Œå¼‚æ­¥è¯·æ±‚</h3><p>å¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬æ˜¯åœ¨ç»„ä»¶ä¸€æŒ‚è½½æˆ–è€…æŸäº›çŠ¶æ€å˜åŒ–æ—¶è‡ªåŠ¨è¿›è¡Œä¸€æ­¥è¯·æ±‚çš„ï¼Œæˆ‘ä»¬åœ¨usePromiseçš„åŸºç¡€ä¸Šï¼Œç»“åˆuseEffectæ¥å®ç°è‡ªåŠ¨è°ƒç”¨:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä¸ºäº†ç¼©çŸ­ç¯‡å¹…ï¼Œè¿™é‡Œå°±ä¸è€ƒè™‘è·ŸusePromiseä¸€æ ·çš„å‡½æ•°é‡è½½äº†</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">usePromiseEffect</span>&lt;<span class="title">T</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  action: (...args: <span class="built_in">any</span>[]) =&gt; <span class="built_in">Promise</span>&lt;T&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  args?: <span class="built_in">any</span>[],</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> prom = usePromise(action)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä½¿ç”¨useEffectç›‘å¬å‚æ•°å˜åŠ¨å¹¶æ‰§è¡Œ</span></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    prom.callIgnoreError.apply(<span class="literal">null</span>, args)</span><br><span class="line">  &#125;, args)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> prom</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---------</span></span><br><span class="line"><span class="comment">// EXAMPLE</span></span><br><span class="line"><span class="comment">// ---------</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Demo</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// åœ¨æŒ‚è½½æˆ–è€…idå˜åŒ–æ—¶è¯·æ±‚</span></span><br><span class="line">  <span class="keyword">const</span> list = usePromiseEffect(<span class="function">(<span class="params">id</span>) =&gt;</span> fetchById(id), [id])</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åŒusePromise</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹åˆ°è¿™é‡Œï¼Œåº”è¯¥æƒŠå¹Hooksçš„æŠ½è±¡èƒ½åŠ›äº†å§ï¼ğŸ˜¸</p><p><br></p><p><a href="#">â¤´ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="7-3-useinfinitelist-å®ç°æ— é™åŠ è½½åˆ—è¡¨"><a href="#7-3-useinfinitelist-å®ç°æ— é™åŠ è½½åˆ—è¡¨" class="headerlink" title="7-3 useInfiniteList å®ç°æ— é™åŠ è½½åˆ—è¡¨"></a>7-3 useInfiniteList å®ç°æ— é™åŠ è½½åˆ—è¡¨</h3><p>è¿™é‡Œä¾‹å­åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­ä¹ŸæåŠè¿‡</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">useInfiniteList</span>&lt;<span class="title">T</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  fn: (params: &#123; offset: <span class="built_in">number</span>; pageSize: <span class="built_in">number</span>; list: T[] &#125;) =&gt; <span class="built_in">Promise</span>&lt;T[]&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  pageSize: <span class="built_in">number</span> = 20,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [list, setList] = useState&lt;T[]&gt;(returnEmptyArray)</span><br><span class="line">  <span class="comment">// åˆ—è¡¨æ˜¯å¦å…¨éƒ¨åŠ è½½å®Œæ¯•</span></span><br><span class="line">  <span class="keyword">const</span> [hasMore, setHasMore, hasMoreRef] = useRefState(<span class="literal">true</span>)</span><br><span class="line">  <span class="comment">// åˆ—è¡¨æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">  <span class="keyword">const</span> [empty, setEmpty] = useState(<span class="literal">false</span>)</span><br><span class="line">  <span class="keyword">const</span> promise = usePromise(<span class="function"><span class="params">()</span> =&gt;</span> fn(&#123; list, offset: list.length, pageSize &#125;))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> load = useCallback(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (!hasMoreRef.current) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> promise.call()</span><br><span class="line">    <span class="keyword">if</span> (res.length &lt; pageSize) &#123;</span><br><span class="line">      setHasMore(<span class="literal">false</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    setList(<span class="function"><span class="params">l</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (res.length === <span class="number">0</span> &amp;&amp; l.length === <span class="number">0</span>) &#123;</span><br><span class="line">        setEmpty(<span class="literal">true</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> [...l, ...res]</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ¸…ç©ºåˆ—è¡¨</span></span><br><span class="line">  <span class="keyword">const</span> clean = useCallback(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    setList([])</span><br><span class="line">    setHasMore(<span class="literal">true</span>)</span><br><span class="line">    setEmpty(<span class="literal">false</span>)</span><br><span class="line">    promise.reset()</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ·æ–°åˆ—è¡¨</span></span><br><span class="line">  <span class="keyword">const</span> refresh = useCallback(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    clean()</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      load()</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    list,</span><br><span class="line">    hasMore,</span><br><span class="line">    empty,</span><br><span class="line">    loading: promise.loading,</span><br><span class="line">    error: promise.error,</span><br><span class="line">    load,</span><br><span class="line">    refresh,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>ä½¿ç”¨ç¤ºä¾‹:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">interface</span> Item &#123;</span><br><span class="line">  id: <span class="built_in">number</span></span><br><span class="line">  name: <span class="built_in">string</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; load, list, hasMore, refresh &#125; = useInfiniteList&lt;Item&gt;<span class="function">(<span class="params"><span class="keyword">async</span> (<span class="params">&#123; offset, pageSize &#125;</span>) =&gt; &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> list = []</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">for</span> (<span class="params"><span class="keyword">let</span> i = offset; i &lt; offset + pageSize; i++</span>) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">if</span> (<span class="params">i === 200</span>) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">break</span></span></span></span><br><span class="line"><span class="function"><span class="params">      &#125;</span></span></span><br><span class="line"><span class="function"><span class="params">      list.push(<span class="params">&#123; id: i, name: `$&#123;i&#125;-----` &#125;</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">    &#125;</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">return</span> list</span></span></span><br><span class="line"><span class="function"><span class="params">  &#125;</span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="params">useEffect</span>(<span class="params">(<span class="params"></span>) =&gt; &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">    load(<span class="params"></span>)</span></span></span><br><span class="line"><span class="function"><span class="params">  &#125;, []</span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="params">return</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    &lt;div className="App"&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">      &lt;button onClick=&#123;refresh&#125;&gt;Refresh&lt;/button&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">      &#123;list.map(<span class="params">i =&gt; (<span class="params"></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params">        &lt;div key=&#123;i.id&#125;&gt;&#123;i.name&#125;&lt;/div&gt;</span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params">      </span>)</span>)&#125;</span></span></span><br><span class="line"><span class="function"><span class="params">      &#123;hasMore ? &lt;button onClick=&#123;load&#125;&gt;Load more&lt;/button&gt; : &lt;div&gt;No more&lt;/div&gt;&#125;</span></span></span><br><span class="line"><span class="function"><span class="params">    &lt;/div&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>)</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure><p><br></p><p><a href="#">â¤´ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="7-4-usepoll-ç”¨hookå®ç°è½®è¯¢"><a href="#7-4-usepoll-ç”¨hookå®ç°è½®è¯¢" class="headerlink" title="7-4 usePoll ç”¨hookå®ç°è½®è¯¢"></a>7-4 usePoll ç”¨hookå®ç°è½®è¯¢</h3><p>ä¸‹é¢ä½¿ç”¨Hookså®ç°ä¸€ä¸ªå®šæ—¶è½®è¯¢å™¨</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> UsePollOptions&lt;T&gt; &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * å†³å®šæ˜¯å¦è¦ç»§ç»­è½®è¯¢</span></span><br><span class="line"><span class="comment">   * @param arg ä¸Šä¸€æ¬¡è½®è¯¢è¿”å›çš„å€¼</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  condition: <span class="function">(<span class="params">arg?: T, error?: <span class="built_in">Error</span></span>) =&gt;</span> <span class="built_in">Promise</span>&lt;<span class="built_in">boolean</span>&gt;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * è½®è¯¢æ“ä½œ</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  poller: <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">Promise</span>&lt;T&gt;</span><br><span class="line">  onError?: <span class="function">(<span class="params">err: <span class="built_in">Error</span></span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * è½®è¯¢é—´éš”. é»˜è®¤ 5000</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  duration?: <span class="built_in">number</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * ç›‘å¬çš„å‚æ•°ï¼Œå½“è¿™äº›å‚æ•°å˜åŒ–æ—¶ï¼Œé‡æ–°æ£€æŸ¥è½®è¯¢æ¡ä»¶ï¼Œå†³å®šæ˜¯å¦ç»§ç»­è½®è¯¢</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  args?: <span class="built_in">any</span>[]</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * æ˜¯å¦ç«‹å³è½®è¯¢</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  immediately?: <span class="built_in">boolean</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å®ç°é¡µé¢è½®è¯¢æœºåˆ¶</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">usePoll</span>&lt;<span class="title">T</span> = <span class="title">any</span>&gt;(<span class="params">options: UsePollOptions&lt;T&gt;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [polling, setPolling, pollingRef] = useRefState(<span class="literal">false</span>)</span><br><span class="line">  <span class="keyword">const</span> [error, setError] = useState&lt;<span class="built_in">Error</span>&gt;()</span><br><span class="line">  <span class="keyword">const</span> state = useInstance&lt;&#123; timer?: <span class="built_in">number</span>; unmounted?: <span class="built_in">boolean</span> &#125;&gt;(&#123;&#125;)</span><br><span class="line">  <span class="keyword">const</span> optionsRef = useRefProps(options)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> poll = useCallback(<span class="keyword">async</span> (immediate?: <span class="built_in">boolean</span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">// å·²ç»å¸è½½ï¼Œæˆ–å…¶ä»–è½®è¯¢å™¨æ­£åœ¨è½®è¯¢</span></span><br><span class="line">    <span class="keyword">if</span> (state.unmounted || pollingRef.current) <span class="keyword">return</span></span><br><span class="line">    setPolling(<span class="literal">true</span>)</span><br><span class="line">    state.timer = <span class="built_in">window</span>.setTimeout(</span><br><span class="line">      <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (state.unmounted) <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">let</span> res: T | <span class="literal">undefined</span></span><br><span class="line">          <span class="keyword">let</span> error: <span class="built_in">Error</span> | <span class="literal">undefined</span></span><br><span class="line">          setError(<span class="literal">undefined</span>)</span><br><span class="line"></span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            res = <span class="keyword">await</span> optionsRef.current.poller()</span><br><span class="line">          &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">            error = err</span><br><span class="line">            setError(err)</span><br><span class="line">            <span class="keyword">if</span> (optionsRef.current.onError) &#123;</span><br><span class="line">              optionsRef.current.onError(err)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// å‡†å¤‡ä¸‹ä¸€æ¬¡è½®è¯¢</span></span><br><span class="line">          <span class="keyword">if</span> (!state.unmounted &amp;&amp; (<span class="keyword">await</span> optionsRef.current.condition(res, error))) &#123;</span><br><span class="line">            setTimeout(poll)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          !state.unmounted &amp;&amp; setPolling(<span class="literal">false</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      immediate ? <span class="number">0</span> : optionsRef.current.duration || <span class="number">5000</span>,</span><br><span class="line">    )</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  useOnUpdate(</span><br><span class="line">    <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">await</span> optionsRef.current.condition()) poll(options.immediately)</span><br><span class="line">    &#125;,</span><br><span class="line">    options.args || [],</span><br><span class="line">    <span class="literal">false</span>,</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  useOnUnmount(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    state.unmounted = <span class="literal">true</span></span><br><span class="line">    clearTimeout(state.timer)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123; polling, error &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ç¤ºä¾‹:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Demo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [query, setQuery] = useState(<span class="string">')</span></span><br><span class="line"><span class="string">  const [result, setResult] = useState&lt;Result&gt;()</span></span><br><span class="line"><span class="string">  usePoll(&#123;</span></span><br><span class="line"><span class="string">    poller: await() =&gt; &#123;</span></span><br><span class="line"><span class="string">      const res =await fetch(query)</span></span><br><span class="line"><span class="string">      setResult(res)</span></span><br><span class="line"><span class="string">      return res</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    condition: async () =&gt; &#123;</span></span><br><span class="line"><span class="string">      return query !== '</span><span class="string">'</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    args: [query],</span></span><br><span class="line"><span class="string">  &#125;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  // ...</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><p><br></p><p><a href="#">â¤´ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="7-5-ä¸šåŠ¡é€»è¾‘æŠ½ç¦»"><a href="#7-5-ä¸šåŠ¡é€»è¾‘æŠ½ç¦»" class="headerlink" title="7-5 ä¸šåŠ¡é€»è¾‘æŠ½ç¦»"></a>7-5 ä¸šåŠ¡é€»è¾‘æŠ½ç¦»</h3><p>é€šè¿‡ä¸Šé¢çš„æ¡ˆä¾‹å¯ä»¥çœ‹åˆ°, Hookséå¸¸é€‚åˆç”¨äºæŠ½ç¦»é‡å¤çš„ä¸šåŠ¡é€»è¾‘ã€‚</p><p>åœ¨<a href="https://juejin.im/post/5cd8fb916fb9a03218556fc1#heading-6" target="_blank" rel="noopener">Reactç»„ä»¶è®¾è®¡å®è·µæ€»ç»“02 - ç»„ä»¶çš„ç»„ç»‡</a>ä»‹ç»äº†å®¹å™¨ç»„ä»¶å’Œå±•ç¤ºç»„ä»¶åˆ†ç¦»ï¼ŒHooksæ—¶ä»£ï¼Œ<strong>æˆ‘ä»¬å¯ä»¥è‡ªç„¶åœ°å°†é€»è¾‘éƒ½æ”¾ç½®åˆ°Hooksä¸­ï¼Œå®ç°é€»è¾‘å’Œè§†å›¾çš„åˆ†ç¦»</strong>ã€‚</p><p>æŠ½ç¦»çš„åä¸šåŠ¡é€»è¾‘å¯ä»¥å¤ç”¨äºä¸åŒçš„â€™å±•ç¤ºå¹³å°â€™, ä¾‹å¦‚ web ç‰ˆå’Œ native ç‰ˆ:</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Login/</span><br><span class="line">  useLogin.ts   // å°†æ‰€æœ‰é€»è¾‘éƒ½æŠ½å–åˆ°Hooksä¸­</span><br><span class="line">  index.web.tsx // åªä¿ç•™è§†å›¾</span><br><span class="line">  index.tsx</span><br></pre></td></tr></table></figure><p><br><br><br></p><p><a href="#">â¤´ï¸å›åˆ°é¡¶éƒ¨</a></p><h2 id="8-å¼€è„‘æ´"><a href="#8-å¼€è„‘æ´" class="headerlink" title="8. å¼€è„‘æ´"></a><strong>8. å¼€è„‘æ´</strong></h2><p>ä¸€äº›å¥‡å¥‡æ€ªæ€ªçš„ä¸œè¥¿ï¼Œä¸çŸ¥é“æ€ä¹ˆåˆ†ç±»ã€‚ä½œè€…æƒ³è±¡åŠ›éå¸¸ä¸°å¯Œ!</p><h3 id="8-1-usescript-hooks-suspend-â¤ï¸"><a href="#8-1-usescript-hooks-suspend-â¤ï¸" class="headerlink" title="8-1 useScript: Hooks + Suspend = â¤ï¸"></a>8-1 useScript: Hooks + Suspend = â¤ï¸</h3><p>è¿™ä¸ªæ¡ˆä¾‹æ¥æºäº<a href="https://github.com/palmerhq/the-platform#usescript" target="_blank" rel="noopener">the-platform</a>, ä½¿ç”¨scriptæ ‡ç­¾æ¥åŠ è½½å¤–éƒ¨è„šæœ¬:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ³¨æ„: è¿™è¿˜æ˜¯å®éªŒæ€§ç‰¹æ€§</span></span><br><span class="line"><span class="keyword">import</span> &#123;createResource&#125; <span class="keyword">from</span> <span class="string">'react-cache'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ScriptResource = createResource(<span class="function">(<span class="params">src: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> script = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>);</span><br><span class="line">    script.src = src;</span><br><span class="line">    script.onload = <span class="function"><span class="params">()</span> =&gt;</span> resolve(script);</span><br><span class="line">    script.onerror = reject;</span><br><span class="line">    <span class="built_in">document</span>.body.appendChild(script);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useScript</span>(<span class="params">options: &#123; src: <span class="built_in">string</span> &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> ScriptResource.read(src);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>ä½¿ç”¨ç¤ºä¾‹:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useScript &#125; <span class="keyword">from</span> <span class="string">'the-platform'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Example = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">   useScript(&#123; src: <span class="string">'bundle.js'</span> &#125;);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Suspend</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &lt;Suspense fallback=&#123;<span class="string">'loading...'</span>&#125;&gt;&lt;Example&gt;&lt;<span class="regexp">/Example&gt;&lt;/</span>Suspense&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒç†è¿˜å¯ä»¥å®ç°</p><ul><li><a href="https://github.com/palmerhq/the-platform/blob/master/src/Stylesheet.tsx" target="_blank" rel="noopener">useStylesheet</a> ç”¨äºåŠ è½½æ ·å¼è¡¨</li><li><a href="https://github.com/CharlesStover/fetch-suspense" target="_blank" rel="noopener">fetch-suspense</a></li></ul><p><br></p><p><a href="#">â¤´ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="8-2-usemodal-æ¨¡æ€æ¡†æ•°æ®æµç®¡ç†"><a href="#8-2-usemodal-æ¨¡æ€æ¡†æ•°æ®æµç®¡ç†" class="headerlink" title="8-2 useModal æ¨¡æ€æ¡†æ•°æ®æµç®¡ç†"></a>8-2 useModal æ¨¡æ€æ¡†æ•°æ®æµç®¡ç†</h3><p>æˆ‘åœ¨<a href="https://juejin.im/post/5cdc2f54e51d453b0c35930d#heading-6" target="_blank" rel="noopener">Reactç»„ä»¶è®¾è®¡å®è·µæ€»ç»“04 - ç»„ä»¶çš„æ€ç»´</a>ä¹Ÿä¸¾åˆ°ä¸€ä¸ªä½¿ç”¨<code>Hooks + Context</code>æ¥å·§å¦™å®ç°æ¨¡æ€æ¡†ç®¡ç†çš„ä¾‹å­ã€‚</p><p>å…ˆæ¥çœ‹çœ‹å¦‚ä½•ä½¿ç”¨Contextæ¥æ¸²æŸ“æ¨¡æ€æ¡†, å¾ˆç®€å•, ModalContext.Providerç»™ä¸‹çº§ç»„ä»¶æš´éœ²ä¸€ä¸ªrenderæ–¹æ³•ï¼Œé€šè¿‡è¿™ä¸ªæ–¹æ³•æ¥ä¼ é€’éœ€è¦æ¸²æŸ“çš„æ¨¡æ€æ¡†ç»„ä»¶å’Œprops:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ¨¡æ€æ¡†ç»„ä»¶è¦å®ç°çš„æ¥å£</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> BaseModalProps &#123;</span><br><span class="line">  visible: <span class="built_in">boolean</span></span><br><span class="line">  onHide: <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">void</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> ModalContextValue &#123;</span><br><span class="line">  render(Component: React.ComponentType&lt;<span class="built_in">any</span>&gt;, props: <span class="built_in">any</span>): <span class="built_in">void</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Context = React.createContext&lt;ModalContextValue&gt;(&#123;</span><br><span class="line">  render: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"useModal å¿…é¡»åœ¨ModalRenderer ä¸‹çº§"</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¨¡æ€æ¡†æ¸²æŸ“å™¨</span></span><br><span class="line"><span class="keyword">const</span> ModalRenderer: FC&lt;&#123;&#125;&gt; = <span class="function"><span class="params">props</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [modal, setModal] = useState&lt;</span><br><span class="line">    | &#123; Comp: React.ComponentType&lt;<span class="built_in">any</span>&gt;; props: <span class="built_in">any</span>; visible?: <span class="built_in">boolean</span> &#125;</span><br><span class="line">    | <span class="literal">undefined</span></span><br><span class="line">  &gt;()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> hide = useCallback(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    setModal(<span class="function"><span class="params">prev</span> =&gt;</span> prev &amp;&amp; &#123; ...prev, visible: <span class="literal">false</span> &#125;)</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç”±ä¸‹çº§ç»„ä»¶è°ƒç”¨ï¼Œä¼ é€’éœ€è¦æ¸²æŸ“çš„ç»„ä»¶å’Œprops</span></span><br><span class="line">  <span class="keyword">const</span> render = useCallback&lt;ModalContextValue[<span class="string">"render"</span>]&gt;<span class="function">(<span class="params">(<span class="params">Comp, props</span>) =&gt; &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">    setModal(<span class="params">&#123; Comp, props, visible: <span class="literal">true</span> &#125;</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">  &#125;, []</span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="params">const</span> <span class="params">value</span> = <span class="params">useMemo</span>(<span class="params">(<span class="params"></span>) =&gt; (<span class="params">&#123;render&#125;</span>), []</span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="params">return</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    &lt;Context.Provider value=&#123;value&#125;&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">      &#123;props.children&#125;</span></span></span><br><span class="line"><span class="function"><span class="params">      &lt;div className="modal-container"&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">        &#123;<span class="comment">/*æ¨¡æ€æ¡†æ¸²æŸ“ */</span>&#125;</span></span></span><br><span class="line"><span class="function"><span class="params">        &#123;!!modal &amp;&amp;</span></span></span><br><span class="line"><span class="function"><span class="params">          React.createElement(<span class="params">modal.Comp, &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">            ...modal.props,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">            visible: modal.visible,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">            onHide: hide,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">          &#125;</span>)&#125;</span></span></span><br><span class="line"><span class="function"><span class="params">      &lt;/div&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">    &lt;/Context.Provider&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>)</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure><p>å†çœ‹çœ‹Hooksçš„å®ç°, ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯ä½¿ç”¨useContextæ¥è®¿é—®ModalContextï¼Œ å¹¶è°ƒç”¨renderæ–¹æ³•:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">useModal</span>&lt;<span class="title">P</span> <span class="title">extends</span> <span class="title">BaseModalProps</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  Modal: React.ComponentType&lt;P&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> renderer = useContext(Context)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> useCallback(</span><br><span class="line">    (props: Omit&lt;P, keyof BaseModalProps&gt;) =&gt; &#123;</span><br><span class="line">      renderer.render(Modal, props || &#123;&#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    [Modal],</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åº”ç”¨ç¤ºä¾‹:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> MyModal: FC&lt;BaseModalProps &amp; &#123; a: <span class="built_in">number</span> &#125;&gt; = <span class="function"><span class="params">props</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;Modal visible=&#123;props.visible&#125; onOk=&#123;props.onHide&#125; onCancel=&#123;props.onHide&#125;&gt;</span><br><span class="line">      &#123;props.a&#125;</span><br><span class="line">    &lt;<span class="regexp">/Modal&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">const Home: FC&lt;&#123;&#125;&gt; = props =&gt; &#123;</span></span><br><span class="line"><span class="regexp">  const showMyModal = useModal(MyModal)</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  const handleShow = useCallback(() =&gt; &#123;</span></span><br><span class="line"><span class="regexp">    /</span><span class="regexp">/ æ˜¾ç¤ºæ¨¡æ€æ¡†</span></span><br><span class="line"><span class="regexp">    showMyModal(&#123;</span></span><br><span class="line"><span class="regexp">      a: 123,</span></span><br><span class="line"><span class="regexp">    &#125;)</span></span><br><span class="line"><span class="regexp">  &#125;, [])</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  return (</span></span><br><span class="line"><span class="regexp">    &lt;div&gt;</span></span><br><span class="line"><span class="regexp">      showMyModal: &lt;button onClick=&#123;handleShow&#125;&gt;show&lt;/</span>button&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p>å¯è¿è¡Œçš„å®Œæ•´ç¤ºä¾‹å¯ä»¥çœ‹<a href="https://codesandbox.io/s/lryom9617l?fontsize=14" target="_blank" rel="noopener">è¿™é‡Œ</a></p><p><br></p><p><a href="#">â¤´ï¸å›åˆ°é¡¶éƒ¨</a></p><h2 id="react-hooks-æŠ€æœ¯åœ°å›¾"><a href="#react-hooks-æŠ€æœ¯åœ°å›¾" class="headerlink" title="React Hooks æŠ€æœ¯åœ°å›¾"></a><strong>React Hooks æŠ€æœ¯åœ°å›¾</strong></h2><p><strong>å…¨å®¶æ¡¶å’ŒHooksçš„ç»“åˆ</strong>:</p><ul><li><a href="https://react-redux.js.org/api/hooks" target="_blank" rel="noopener">Redux + Hooks</a></li><li><a href="https://github.com/mobxjs/mobx-react-lite" target="_blank" rel="noopener">Mobx + Hooks</a></li><li><a href="https://www.react-spring.io/docs/hooks/basics" target="_blank" rel="noopener">ReactSpring + Hooks</a></li><li><a href="https://www.apollographql.com/docs/react/api/react-hooks/" target="_blank" rel="noopener">Appoll</a></li><li><a href="https://react.i18next.com/latest/usetranslation-hook" target="_blank" rel="noopener">react-i18next</a></li><li><a href="https://reacttraining.com/blog/reach-react-router-future/" target="_blank" rel="noopener">react-router</a> Come in soon</li></ul><p><br></p><p><strong>ä¸€äº›æœ‰è¶£çš„Hooksé›†åˆ</strong>:</p><ul><li><a href="https://github.com/palmerhq/the-platform#usescript" target="_blank" rel="noopener">the-platform</a></li><li><a href="https://github.com/streamich/react-use" target="_blank" rel="noopener">react-use</a></li><li><a href="https://github.com/rehooks/ideas/issues" target="_blank" rel="noopener">rehooks/ideas</a> ä¸€èµ·å¼€è„‘æ´</li><li><a href="https://github.com/kitze/react-hanger" target="_blank" rel="noopener">react-hanger</a></li></ul><p><br></p><p><strong>Awesome</strong></p><ul><li><a href="https://github.com/rehooks/awesome-react-hooks" target="_blank" rel="noopener">Awesome React Hooks</a></li><li><a href="https://www.hooks.guide/rehooks/useComponentSize" target="_blank" rel="noopener">Hooks.Guide</a></li><li><a href="https://usehooks.com/" target="_blank" rel="noopener">useHooks</a></li></ul><p><br></p><p><strong>FAQ</strong></p><ul><li><a href="https://zh-hans.reactjs.org/docs/hooks-faq.html" target="_blank" rel="noopener">å®˜æ–¹Hooks FAQ</a> å¯ä»¥è§£ç­”å¤§éƒ¨åˆ†çš„ç–‘é—®</li></ul><p><br><br><br></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ¬æ–‡ç¯‡å¹…å¾ˆé•¿ã€ä»£ç å¾ˆå¤šã€‚èƒ½æ»‘åˆ°è¿™é‡Œç›¸å½“ä¸å®¹æ˜“, ç»™ä½ ç‚¹ä¸ªèµã€‚</p><p>ä½ ç”¨React Hooké‡åˆ°è¿‡ä»€ä¹ˆé—®é¢˜ï¼Ÿ å¼€è¿‡ä»€ä¹ˆè„‘æ´ï¼Œä¸‹æ–¹è¯„è®ºå‘Šè¯‰æˆ‘.</p><p>æ¬¢è¿å…³æ³¨æˆ‘, å’Œæˆ‘äº¤æµ. æˆ‘æœ‰ç¤¾æ, ä½†æƒ³å¤šäº¤äº›åœˆå†…æœ‹å‹(<code>atob(&#39;YmxhbmstY2FybmV5&#39;)</code>, å¤‡æ³¨æ˜é‡‘ï¼Œæˆ‘ä¸å–èŒ¶ï¼Œè¿‘æœŸä¹Ÿä¸æ¢å·¥ä½œ)</p><p>æœ¬æ–‡å®Œ!</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;br&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/react-hooks/cover.png&quot; alt&gt;&lt;/p&gt;
&lt;p&gt;&lt;br&gt;&lt;/p&gt;
&lt;p&gt;åœ¨&lt;a href=&quot;https://www.youtube.com/channel/UCz5vTaEhvh7dOHEyd
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://bobi.ink/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>100æ¥è¡Œä»£ç , è‡ªå·±åŠ¨æ‰‹å†™ä¸€ä¸ªæ¨¡æ¿å¼•æ“</title>
    <link href="https://bobi.ink/2019/08/09/ejs/"/>
    <id>https://bobi.ink/2019/08/09/ejs/</id>
    <published>2019-08-08T16:00:00.000Z</published>
    <updated>2019-08-14T01:29:53.703Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸€å¼ å›¾è¯´æ˜Ejsæ¨¡æ¿å¼•æ“çš„åŸç†</p><p><img src="/images/ejs/ejs.png" alt></p><p><br></p><p>ä¸Šé¢ä¸€å¼ å›¾ï¼Œå·²ç»å¤§æ¦‚æŠŠä¸€ä¸ªç®€å•æ¨¡æ¿å¼•æ“(è¿™é‡Œä»¥<a href="https://ejs.co/" target="_blank" rel="noopener">EJS</a>ä¸ºä¾‹)çš„åŸç†è§£é‡Šå¾—ä¸ƒä¸ƒå…«å…«äº†ã€‚æœ¬æ–‡å°†æè¿°ä¸€ä¸ªç®€å•çš„æ¨¡æ¿å¼•æ“æ˜¯æ€ä¹ˆè¿ä½œçš„ï¼ŸåŒ…å«å®ç°çš„å…³é”®æ­¥éª¤ã€ä»¥åŠå…¶èƒŒåçš„æ€æƒ³ã€‚</p><p>åŸºæœ¬ä¸Šæ¨¡æ¿å¼•æ“çš„å¥—è·¯ä¹Ÿå°±è¿™æ ·äº†ï¼Œä½†è¿™äº›æ€æƒ³æ˜¯é€šç”¨çš„ï¼Œæ¯”å¦‚ä½ åœ¨çœ‹vueçš„æ¨¡æ¿ç¼–è¯‘å™¨æºç ã€ä¹Ÿå¯ä»¥å¥—ç”¨è¿™äº›æ€æƒ³å’Œæ–¹æ³•.</p><p><br></p><h2 id="åŸºæœ¬apiè®¾è®¡"><a href="#åŸºæœ¬apiè®¾è®¡" class="headerlink" title="åŸºæœ¬APIè®¾è®¡"></a>åŸºæœ¬APIè®¾è®¡</h2><p>æˆ‘ä»¬å°†å®ç°ä¸€ä¸ªç®€åŒ–ç‰ˆçš„EJS, è¿™ä¸ªæ¨¡æ¿å¼•æ“æ”¯æŒè¿™äº›æ ‡ç­¾:</p><ul><li><p><code>&lt;% script %&gt;</code> - è„šæœ¬æ‰§è¡Œ. ä¸€èˆ¬ç”¨äºæ§åˆ¶è¯­å¥ï¼Œä¸ä¼šè¾“å‡ºå€¼ ä¾‹å¦‚</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">%</span> <span class="attr">if</span> (<span class="attr">user</span>) &#123; %&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span>some thing<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">%</span> &#125; %&gt;</span></span><br></pre></td></tr></table></figure></li><li><p><code>&lt;%= expression %&gt;</code> - è¾“å‡ºè¡¨è¾¾å¼çš„å€¼ï¼Œä½†æ˜¯ä¼šè½¬ä¹‰HTML:</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>&#123;%= title %&#125;<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p><code>&lt;%- expression %&gt;</code> -  å’Œ<code>&lt;%= expr %&gt;</code>ä¸€æ ·ï¼Œåªä¸è¿‡ä¸ä¼šå¯¹HTMLè¿›è¡Œè½¬ä¹‰</p></li><li><code>&lt;%%</code> å’Œ<code>%%&gt;</code> - è¡¨ç¤ºæ ‡ç­¾è½¬ä¹‰, æ¯”å¦‚<code>&lt;%%</code>ä¼šè¾“å‡ºä¸º<code>&lt;%</code></li><li><code>&lt;%# æ³¨é‡Š %&gt;</code> - ä¸ä¼šæœ‰å†…å®¹è¾“å‡º</li></ul><p><br></p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ¨¡æ¿ç¤ºä¾‹ï¼Œä¸‹æ–‡ä¼šåŸºäºè¿™ä¸ªæ¨¡æ¿è¿›è¡Œè®²è§£:</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">%=</span> <span class="attr">title</span> %&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">%%</span> è½¬ä¹‰ %%&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">%#</span> è¿™é‡Œæ˜¯æ³¨é‡Š %&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">%-</span> <span class="attr">before</span> %&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">%</span> <span class="attr">if</span> (<span class="attr">show</span>) &#123; %&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span>&gt;</span>root<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">%</span> &#125; %&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p><br></p><p><strong>åŸºæœ¬APIè®¾è®¡</strong></p><p>æˆ‘ä»¬å°†æ¨¡æ¿è§£æå’Œæ¸²æŸ“ç›¸å…³çš„é€»è¾‘æ”¾åˆ°ä¸€ä¸ªTemplateç±»ä¸­ï¼Œå®ƒçš„åŸºæœ¬æ¥å£å¦‚ä¸‹:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> Template &#123;</span><br><span class="line">  <span class="keyword">public</span> template: <span class="built_in">string</span>;</span><br><span class="line">  <span class="keyword">private</span> tokens: <span class="built_in">string</span>[] = [];</span><br><span class="line">  <span class="keyword">private</span> source: <span class="built_in">string</span> = <span class="string">""</span>;</span><br><span class="line">  <span class="keyword">private</span> state?: State;</span><br><span class="line">  <span class="keyword">private</span> fn?: <span class="built_in">Function</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">constructor</span>(<span class="params">template: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.template = template;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * æ¨¡æ¿ç¼–è¯‘</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> compile() &#123;</span><br><span class="line">    <span class="keyword">this</span>.parseTemplateText();</span><br><span class="line">    <span class="keyword">this</span>.transformTokens();</span><br><span class="line">    <span class="keyword">this</span>.wrapit();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * æ¸²æŸ“æ–¹æ³•ï¼Œç”±ç”¨æˆ·æŒ‡å®šä¸€ä¸ªå¯¹è±¡æ¥æ¸²æŸ“å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> render(local: object) &#123; &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * tokenè§£æ</span></span><br><span class="line"><span class="comment">   * å°†&lt;% if (codintion) &#123; %&gt;</span></span><br><span class="line"><span class="comment">   * è§£æä¸ºtokenæ•°ç»„ï¼Œä¾‹å¦‚['&lt;%', ' if (condition) &#123; ', '%&gt;']</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> parseTemplateText() &#123;&#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * å°†Tokenè½¬æ¢ä¸ºJavascriptè¯­å¥</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> transformTokens() &#123;&#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * å°†ä¸Šä¸€ä¸ªæ­¥éª¤è½¬æ¢å‡ºæ¥çš„Javascriptè¯­å¥ï¼Œå°è£…æˆä¸€ä¸ªæ¸²æŸ“æ–¹æ³•</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> wrapit() &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br><br><br></p><h2 id="tokenè§£æ"><a href="#tokenè§£æ" class="headerlink" title="tokenè§£æ"></a>tokenè§£æ</h2><p>ç¬¬ä¸€æ­¥æˆ‘ä»¬éœ€è¦å°†æ‰€æœ‰çš„å¼€å§‹æ ‡ç­¾(start tag)å’Œç»“æŸæ ‡ç­¾(end tag)éƒ½è§£æå‡ºæ¥ï¼Œæˆ‘ä»¬æœŸæœ›çš„è§£æç»“æœæ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">[</span><br><span class="line">  <span class="string">"\n&lt;html&gt;\n  &lt;head&gt;"</span>,</span><br><span class="line">  <span class="string">"&lt;%="</span>,</span><br><span class="line">  <span class="string">" title "</span>,</span><br><span class="line">  <span class="string">"%&gt;"</span>,</span><br><span class="line">  <span class="string">"&lt;/head&gt;\n  &lt;body&gt;\n    "</span>,</span><br><span class="line">  <span class="string">"&lt;%%"</span>,</span><br><span class="line">  <span class="string">" è½¬ä¹‰ "</span>,</span><br><span class="line">  <span class="string">"%%&gt;"</span>,</span><br><span class="line">  <span class="string">"\n    "</span>,</span><br><span class="line">  <span class="string">"&lt;%#"</span>,</span><br><span class="line">  <span class="string">" è¿™é‡Œæ˜¯æ³¨é‡Š "</span>,</span><br><span class="line">  <span class="string">"%&gt;"</span>,</span><br><span class="line">  <span class="string">"\n    "</span>,</span><br><span class="line">  <span class="string">"&lt;%-"</span>,</span><br><span class="line">  <span class="string">" before "</span>,</span><br><span class="line">  <span class="string">"%&gt;"</span>,</span><br><span class="line">  <span class="string">"\n    "</span>,</span><br><span class="line">  <span class="string">"&lt;%"</span>,</span><br><span class="line">  <span class="string">" if (show) &#123; "</span>,</span><br><span class="line">  <span class="string">"%&gt;"</span>,</span><br><span class="line">  <span class="string">"\n      &lt;div&gt;root&lt;/div&gt;\n    "</span>,</span><br><span class="line">  <span class="string">"&lt;%"</span>,</span><br><span class="line">  <span class="string">" &#125; "</span>,</span><br><span class="line">  <span class="string">"%&gt;"</span>,</span><br><span class="line">  <span class="string">"\n  &lt;/body&gt;\n&lt;/html&gt;\n"</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>å› ä¸ºæˆ‘ä»¬çš„æ¨¡æ¿å¼•æ“è¯­æ³•éå¸¸ç®€å•, å‹æ ¹å°±ä¸éœ€è¦è§£ææˆä»€ä¹ˆæŠ½è±¡è¯­æ³•æ ‘(AST)(å³çœå»äº†è¯­æ³•è§£æ, åªè¿›è¡Œè¯æ³•è§£æ). ç›´æ¥é€šè¿‡<code>æ­£åˆ™è¡¨è¾¾å¼</code>å°±å¯ä»¥å®ç°å°†æ ‡ç­¾æŠ½å–å‡ºæ¥ã€‚</p><p>å…ˆå®šä¹‰æ­£åˆ™è¡¨è¾¾å¼, ç”¨æ¥åŒ¹é…æˆ‘ä»¬æ‰€æœ‰æ”¯æŒçš„æ ‡ç­¾ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// &lt;%% %%&gt; ç”¨äºè½¬ä¹‰</span></span><br><span class="line"><span class="comment">// &lt;% è„šæœ¬</span></span><br><span class="line"><span class="comment">// &lt;%= è¾“å‡ºè„šæœ¬å€¼</span></span><br><span class="line"><span class="comment">// &lt;%- è¾“å‡ºè„šæœ¬å€¼ï¼Œunescape</span></span><br><span class="line"><span class="comment">// &lt;%# æ³¨é‡Š</span></span><br><span class="line"><span class="comment">// %&gt; ç»“æŸæ ‡ç­¾</span></span><br><span class="line"><span class="keyword">const</span> REGEXP = <span class="regexp">/(&lt;%%|%%&gt;|&lt;%=|&lt;%-|&lt;%#|&lt;%|%&gt;)/</span>;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼é€ä¸ªè¿›è¡ŒåŒ¹é…ï¼Œå°†å­—ç¬¦ä¸²æ‹†åˆ†å‡ºæ¥. ä»£ç ä¹Ÿå¾ˆç®€å•:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">parseTemplateText() &#123;</span><br><span class="line">  <span class="keyword">let</span> str = <span class="keyword">this</span>.template;</span><br><span class="line">  <span class="keyword">const</span> arr = <span class="keyword">this</span>.tokens;</span><br><span class="line">  <span class="comment">// é€šè¿‡execæ–¹æ³•å¯ä»¥è·å–åŒ¹é…çš„ä½ç½®, å¦‚æœåŒ¹é…å¤±è´¥åˆ™è¿”å›null</span></span><br><span class="line">  <span class="keyword">let</span> res = REGEXP.exec(str);</span><br><span class="line">  <span class="keyword">let</span> index;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (res) &#123;</span><br><span class="line">    index = res.index;</span><br><span class="line">    <span class="comment">// å‰ç½®å­—ç¬¦ä¸²</span></span><br><span class="line">    <span class="keyword">if</span> (index !== <span class="number">0</span>) &#123;</span><br><span class="line">      arr.push(str.substring(<span class="number">0</span>, index));</span><br><span class="line">      str = str.slice(index);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    arr.push(res[<span class="number">0</span>]);</span><br><span class="line">    <span class="comment">// æˆªæ–­å­—ç¬¦ä¸²ï¼Œç»§ç»­åŒ¹é…</span></span><br><span class="line">    str = str.slice(res[<span class="number">0</span>].length);</span><br><span class="line">    res = REGEXP.exec(str);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (str) &#123;</span><br><span class="line">    arr.push(str);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br><br><br></p><h2 id="ç®€å•çš„è¯­æ³•æ£€æŸ¥"><a href="#ç®€å•çš„è¯­æ³•æ£€æŸ¥" class="headerlink" title="ç®€å•çš„è¯­æ³•æ£€æŸ¥"></a>ç®€å•çš„è¯­æ³•æ£€æŸ¥</h2><p>Okï¼Œå°†æ ‡ç­¾è§£æå‡ºæ¥åï¼Œå°±å¯ä»¥å¼€å§‹å‡†å¤‡å°†å®ƒä»¬è½¬æ¢ç§°ä¸ºâ€˜æ¸²æŸ“â€™å‡½æ•°äº†.</p><p>é¦–å…ˆè¿›è¡Œä¸€ä¸‹<strong>ç®€å•çš„è¯­æ³•æ£€æŸ¥</strong>ï¼Œæ£€æŸ¥æ ‡ç­¾æ˜¯å¦<strong>é—­åˆ</strong>ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> start = <span class="string">"&lt;%"</span>;           <span class="comment">// å¼€å§‹æ ‡ç­¾</span></span><br><span class="line"><span class="keyword">const</span> end = <span class="string">"%&gt;"</span>;             <span class="comment">// ç»“æŸæ ‡ç­¾</span></span><br><span class="line"><span class="keyword">const</span> escpStart = <span class="string">"&lt;%%"</span>;      <span class="comment">// å¼€å§‹æ ‡ç­¾è½¬ä¹‰</span></span><br><span class="line"><span class="keyword">const</span> escpEnd = <span class="string">"%%&gt;"</span>;        <span class="comment">// ç»“æŸæ ‡ç­¾è½¬ä¹‰</span></span><br><span class="line"><span class="keyword">const</span> escpoutStart = <span class="string">"&lt;%="</span>;   <span class="comment">// è½¬ä¹‰çš„è¡¨è¾¾å¼è¾“å‡º</span></span><br><span class="line"><span class="keyword">const</span> unescpoutStart = <span class="string">"&lt;%-"</span>; <span class="comment">// ä¸è½¬ä¹‰çš„è¡¨è¾¾å¼è¾“å‡º</span></span><br><span class="line"><span class="keyword">const</span> comtStart = <span class="string">"&lt;%#"</span>;      <span class="comment">// æ³¨é‡Š</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (tok.includes(start) &amp;&amp; !tok.includes(escpStart)) &#123;</span><br><span class="line">  closing = <span class="keyword">this</span>.tokens[idx + <span class="number">2</span>];</span><br><span class="line">  <span class="keyword">if</span> (closing == <span class="literal">null</span> || !closing.includes(end)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`<span class="subst">$&#123;tok&#125;</span> æœªæ‰¾åˆ°å¯¹åº”çš„é—­åˆæ ‡ç­¾`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br><br><br></p><h2 id="è½¬æ¢"><a href="#è½¬æ¢" class="headerlink" title="è½¬æ¢"></a>è½¬æ¢</h2><p>ç°åœ¨å¼€å§‹éå†tokenã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªæœ‰é™çš„çŠ¶æ€æœº(Finite-state machine, FSM)æ¥æè¿°è½¬æ¢çš„é€»è¾‘.</p><p><code>çŠ¶æ€æœº</code>æ˜¯è¡¨ç¤º<strong>æœ‰é™ä¸ªçŠ¶æ€ä»¥åŠåœ¨è¿™äº›çŠ¶æ€ä¹‹é—´çš„è½¬ç§»å’ŒåŠ¨ä½œç­‰è¡Œä¸ºçš„æ•°å­¦æ¨¡å‹</strong>ã€‚ç®€å•è€Œè¨€ï¼Œæœ‰é™çŠ¶æ€æœºç”±ä¸€ç»„çŠ¶æ€ã€ä¸€ä¸ªåˆå§‹çŠ¶æ€ã€è¾“å…¥å’Œæ ¹æ®è¾“å…¥åŠç°æœ‰çŠ¶æ€è½¬æ¢ä¸ºä¸‹ä¸€ä¸ªçŠ¶æ€çš„è½¬æ¢å‡½æ•°ç»„æˆã€‚å®ƒæœ‰ä¸‰ä¸ªç‰¹å¾:</p><ul><li>çŠ¶æ€æ€»æ•°æ˜¯æœ‰é™çš„ã€‚</li><li>ä»»ä¸€æ—¶åˆ»ï¼Œåªå¤„åœ¨ä¸€ç§çŠ¶æ€ä¹‹ä¸­ã€‚</li><li>æŸç§æ¡ä»¶ä¸‹ï¼Œä¼šä»ä¸€ç§çŠ¶æ€è½¬å˜åˆ°å¦ä¸€ç§çŠ¶æ€</li></ul><p><br></p><p>ç¨å¾®åˆ†æä¸€ä¸‹ï¼Œæˆ‘ä»¬æ¨¡æ¿å¼•æ“çš„çŠ¶æ€è½¬æ¢å›¾å¦‚ä¸‹:</p><p><img src="/images/ejs/state.png" alt></p><p><br></p><p>é€šè¿‡ä¸Šå›¾å¯ä»¥æŠ½å–å‡ºä»¥ä¸‹çŠ¶æ€:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">enum State &#123;</span><br><span class="line">  EVAL,    <span class="comment">// è„šæœ¬æ‰§è¡Œ</span></span><br><span class="line">  ESCAPED, <span class="comment">// è¡¨è¾¾å¼è¾“å‡º</span></span><br><span class="line">  RAW,     <span class="comment">// è¡¨è¾¾å¼è¾“å‡ºä¸è½¬ä¹‰</span></span><br><span class="line">  COMMENT, <span class="comment">// æ³¨é‡Š</span></span><br><span class="line">  LITERAL  <span class="comment">// å­—é¢é‡ï¼Œç›´æ¥è¾“å‡º</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>Ok, ç°åœ¨å¼€å§‹éå†token:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">this</span>.tokens.forEach(<span class="function">(<span class="params">tok, idx</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">switch</span> (tok) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ ‡ç­¾è¯†åˆ«</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> start:</span><br><span class="line">      <span class="comment">// è„šæœ¬å¼€å§‹</span></span><br><span class="line">      <span class="keyword">this</span>.state = State.EVAL;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> escpoutStart:</span><br><span class="line">      <span class="comment">// è½¬ä¹‰è¾“å‡º</span></span><br><span class="line">      <span class="keyword">this</span>.state = State.ESCAPED;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> unescpoutStart:</span><br><span class="line">      <span class="comment">// éè½¬ä¹‰è¾“å‡º</span></span><br><span class="line">      <span class="keyword">this</span>.state = State.RAW;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> comtStart:</span><br><span class="line">      <span class="comment">// æ³¨é‡Š</span></span><br><span class="line">      <span class="keyword">this</span>.state = State.COMMENT;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> escpStart:</span><br><span class="line">      <span class="comment">// æ ‡ç­¾è½¬ä¹‰</span></span><br><span class="line">      <span class="keyword">this</span>.state = State.LITERAL;</span><br><span class="line">      <span class="keyword">this</span>.source += <span class="string">`;__append('&lt;%');\n`</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> escpEnd:</span><br><span class="line">      <span class="keyword">this</span>.state = State.LITERAL;</span><br><span class="line">      <span class="keyword">this</span>.source += <span class="string">`;__append('%&gt;');\n`</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> end:</span><br><span class="line">      <span class="comment">// æ¢å¤åˆå§‹çŠ¶æ€</span></span><br><span class="line">      <span class="keyword">this</span>.state = <span class="literal">undefined</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * è½¬æ¢è¾“å‡º</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.state != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (<span class="keyword">this</span>.state) &#123;</span><br><span class="line">          <span class="keyword">case</span> State.EVAL:</span><br><span class="line">            <span class="comment">// ä»£ç </span></span><br><span class="line">            <span class="keyword">this</span>.source += <span class="string">`;<span class="subst">$&#123;tok&#125;</span>\n`</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> State.ESCAPED:</span><br><span class="line">            <span class="comment">// stripSemi å°†å¤šä½™çš„åˆ†å·ç§»é™¤</span></span><br><span class="line">            <span class="keyword">this</span>.source += <span class="string">`;__append(escapeFn(<span class="subst">$&#123;stripSemi(tok)&#125;</span>));\n`</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> State.RAW:</span><br><span class="line">            <span class="keyword">this</span>.source += <span class="string">`;__append(<span class="subst">$&#123;stripSemi(tok)&#125;</span>);\n`</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> State.LITERAL:</span><br><span class="line">            <span class="comment">// å› ä¸ºæˆ‘ä»¬æŠŠå­—ç¬¦ä¸²æ”¾åˆ°å•å¼•å·ä¸­ï¼Œæ‰€ä»¥transformStringå°†tokä¸­çš„å•å¼•å·ã€æ¢è¡Œç¬¦ã€è½¬ä¹‰ç¬¦è¿›è¡Œè½¬ç§»</span></span><br><span class="line">            <span class="keyword">this</span>.source += <span class="string">`;__append('<span class="subst">$&#123;transformString(tok)&#125;</span>');\n`</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> State.COMMENT:</span><br><span class="line">            <span class="comment">// ä»€ä¹ˆéƒ½ä¸åš</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å­—é¢é‡</span></span><br><span class="line">        <span class="keyword">this</span>.source += <span class="string">`;__append('<span class="subst">$&#123;transformString(tok)&#125;</span>');\n`</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>ç»è¿‡ä¸Šé¢çš„è½¬æ¢ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°è¿™æ ·çš„ç»“æœ:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">;__append(<span class="string">'\n&lt;html&gt;\n  &lt;head&gt;'</span>);</span><br><span class="line">;__append(escapeFn( title ));</span><br><span class="line">;__append(<span class="string">'&lt;/head&gt;\n  &lt;body&gt;\n    '</span>);</span><br><span class="line">;__append(<span class="string">'&lt;%'</span>);</span><br><span class="line">;__append(<span class="string">' è½¬ä¹‰ '</span>);</span><br><span class="line">;__append(<span class="string">'%&gt;'</span>);</span><br><span class="line">;__append(<span class="string">'\n    '</span>);</span><br><span class="line">;__append(<span class="string">'\n    '</span>);</span><br><span class="line">;__append( before );</span><br><span class="line">;__append(<span class="string">'\n    '</span>);</span><br><span class="line">; <span class="keyword">if</span> (show) &#123;</span><br><span class="line">;__append(<span class="string">'\n      &lt;div&gt;root&lt;/div&gt;\n    '</span>);</span><br><span class="line">; &#125;</span><br><span class="line">;__append(<span class="string">'\n  &lt;/body&gt;\n&lt;/html&gt;\n'</span>);</span><br></pre></td></tr></table></figure><p><br><br><br></p><h2 id="æœ€åä¸€æ­¥ï¼Œç”Ÿæˆå‡½æ•°"><a href="#æœ€åä¸€æ­¥ï¼Œç”Ÿæˆå‡½æ•°" class="headerlink" title="æœ€åä¸€æ­¥ï¼Œç”Ÿæˆå‡½æ•°"></a>æœ€åä¸€æ­¥ï¼Œç”Ÿæˆå‡½æ•°</h2><p>ç°åœ¨æˆ‘ä»¬æŠŠè½¬æ¢ç»“æœåŒ…è£¹æˆå‡½æ•°:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">wrapit() &#123;</span><br><span class="line">    <span class="keyword">this</span>.source = <span class="string">`\</span></span><br><span class="line"><span class="string">const __out = [];</span></span><br><span class="line"><span class="string">const __append = __out.push.bind(__out);</span></span><br><span class="line"><span class="string">with(local||&#123;&#125;) &#123;</span></span><br><span class="line"><span class="string"><span class="subst">$&#123;<span class="keyword">this</span>.source&#125;</span></span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">return __out.join('');\</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line">    <span class="keyword">this</span>.fn = <span class="keyword">new</span> <span class="built_in">Function</span>(<span class="string">"local"</span>, <span class="string">"escapeFn"</span>, <span class="keyword">this</span>.source);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä½¿ç”¨åˆ°äº†<code>with</code>è¯­å¥ï¼Œæ¥åŒ…è£¹ä¸Šé¢è½¬æ¢çš„ä»£ç ï¼Œè¿™æ ·å¯ä»¥å…å»localå¯¹è±¡è®¿é—®é™å®šå‰ç¼€ã€‚</p><p>æ¸²æŸ“æ–¹æ³•å°±å¾ˆç®€å•äº†ï¼Œç›´æ¥è°ƒç”¨ä¸Šé¢åŒ…è£¹çš„å‡½æ•°:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">render(local: object) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.fn.call(<span class="literal">null</span>, local, <span class="built_in">escape</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><h2 id="è·‘èµ·æ¥"><a href="#è·‘èµ·æ¥" class="headerlink" title="è·‘èµ·æ¥"></a>è·‘èµ·æ¥</h2><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> temp = <span class="keyword">new</span> Template(<span class="string">`</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">  &lt;head&gt;&lt;%= title %&gt;&lt;/head&gt;</span></span><br><span class="line"><span class="string">  &lt;body&gt;</span></span><br><span class="line"><span class="string">    &lt;%% è½¬ä¹‰ %%&gt;</span></span><br><span class="line"><span class="string">    &lt;%# è¿™é‡Œæ˜¯æ³¨é‡Š %&gt;</span></span><br><span class="line"><span class="string">    &lt;%- before %&gt;</span></span><br><span class="line"><span class="string">    &lt;% if (show) &#123; %&gt;</span></span><br><span class="line"><span class="string">      &lt;div&gt;root&lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;% &#125; %&gt;</span></span><br><span class="line"><span class="string">  &lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="string">`</span>);</span><br><span class="line"></span><br><span class="line">temp.compile();</span><br><span class="line">temp.render(&#123; <span class="attr">show</span>: <span class="literal">true</span>, <span class="attr">title</span>: <span class="string">"hello"</span>, <span class="attr">before</span>: <span class="string">"&lt;div&gt;xx&lt;/div&gt;"</span> &#125;)</span><br><span class="line"><span class="comment">// &lt;html&gt;</span></span><br><span class="line"><span class="comment">//   &lt;head&gt;hello&lt;/head&gt;</span></span><br><span class="line"><span class="comment">//   &lt;body&gt;</span></span><br><span class="line"><span class="comment">//     &lt;% è½¬ä¹‰ %&gt;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//     &lt;div&gt;xx&lt;/div&gt;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//       &lt;div&gt;root&lt;/div&gt;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//   &lt;/body&gt;</span></span><br><span class="line"><span class="comment">// &lt;/html&gt;</span></span><br></pre></td></tr></table></figure><p>ä½ å¯ä»¥åœ¨CodeSandboxè¿è¡Œå®Œæ•´çš„ä»£ç :</p><p><a href="https://codesandbox.io/s/ejs-wp11m?fontsize=14" target="_blank" rel="noopener"><img src="https://codesandbox.io/static/img/play-codesandbox.svg" alt="Edit ejs"></a></p><p><br></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ¬æ–‡å…¶å®å—åˆ°äº†<a href="https://github.com/jamiebuilds/the-super-tiny-compiler" target="_blank" rel="noopener">the-super-tiny-compiler</a>å¯å‘ï¼Œå®ç°äº†ä¸€ä¸ªæç®€çš„æ¨¡æ¿å¼•æ“ï¼Œå…¶å®æ¨¡æ¿å¼•æ“æœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªCompilerï¼Œé€šè¿‡ä¸Šæ–‡å¯ä»¥äº†è§£åˆ°ä¸€ä¸ªæ¨¡æ¿å¼•æ“ç¼–è¯‘æœ‰ä¸‰ä¸ªæ­¥éª¤ï¼š</p><ol><li><p><strong>è§£æ</strong> å°†æ¨¡æ¿ä»£ç è§£ææˆæŠ½è±¡çš„è¡¨ç¤ºå½¢å¼ã€‚å¤æ‚çš„ç¼–è¯‘å™¨ä¼šæœ‰<code>è¯æ³•è§£æ(Lexical Analysis)</code>å’Œ<code>è¯­æ³•è§£æ(Syntactic Analysis)</code></p><p> <strong>è¯æ³•è§£æ</strong>, ä¸Šæ–‡æˆ‘ä»¬å°†æ¨¡æ¿å†…å®¹è§£ææˆtokençš„è¿‡ç¨‹å°±å¯ä»¥è®¤ä¸ºæ˜¯â€˜è¯æ³•è§£æâ€™ï¼Œå®ƒä¼šå°†æºä»£ç æ‹†åˆ†ç§°ä¸ºtokenæ•°ç»„ï¼Œtokenæ˜¯ä¸€ä¸ªå°å•å…ƒï¼Œè¡¨ç¤ºç‹¬ç«‹çš„â€˜è¯­æ³•ç‰‡æ®µâ€™ã€‚</p><p> <strong>è¯­æ³•è§£æ</strong>ï¼Œè¯­æ³•è§£æå™¨æ¥æ”¶tokenæ•°ç»„ï¼Œå°†å®ƒä»¬é‡æ–°æ ¼å¼åŒ–ç§°ä¸ºæŠ½è±¡è¯­æ³•æ ‘(Abstract Syntax Tree, AST), æŠ½è±¡è¯­æ³•æ ‘å¯ä»¥ç”¨äºæè¿°è¯­æ³•å•å…ƒ, ä»¥åŠå•å…ƒä¹‹é—´çš„å…³ç³»ã€‚ è¯­æ³•è§£æé˜¶æ®µå¯ä»¥å‘ç°è¯­æ³•é—®é¢˜ã€‚</p><p> <img src="/images/ejs/ast.png" alt></p><p> (å›¾ç‰‡æ¥æº: <a href="https://ruslanspivak.com/lsbasi-part7" target="_blank" rel="noopener">https://ruslanspivak.com/lsbasi-part7</a>)</p><p> æœ¬æ–‡ä»‹ç»çš„æ¨¡æ¿å¼•æ“ï¼Œå› ä¸ºè¯­æ³•å¤ªç®€å•äº†ï¼Œæ‰€ä»¥ä¸éœ€è¦ASTè¿™ä¸ªä¸­é—´è¡¨ç¤ºå½¢å¼ã€‚ç›´æ¥åœ¨tokensä¸Šè¿›è¡Œè½¬æ¢</p></li><li><p><strong>è½¬æ¢</strong> å°†ä¸Šä¸ªæ­¥éª¤æŠ½è±¡çš„è¡¨ç¤ºå½¢å¼ï¼Œè½¬æ¢æˆä¸ºç¼–è¯‘å™¨æƒ³è¦çš„ã€‚æ¯”å¦‚ä¸Šæ–‡æ¨¡æ¿å¼•æ“ä¼šè½¬æ¢ä¸ºå¯¹åº”è¯­è¨€çš„è¯­å¥ã€‚å¤æ‚çš„ç¼–è¯‘å™¨ä¼šåŸºäºASTè¿›è¡Œâ€˜è½¬æ¢â€™ï¼Œä¹Ÿå°±æ˜¯å¯¹ASTè¿›è¡Œâ€˜å¢åˆ æŸ¥æ”¹â€™. é€šå¸¸ä¼šé…åˆVisitorsæ¨¡å¼æ¥éå†/è®¿é—®ASTçš„èŠ‚ç‚¹</p></li><li><strong>ä»£ç ç”Ÿæˆ</strong> å°†è½¬æ¢åçš„æŠ½è±¡è¡¨ç¤ºè½¬æ¢ä¸ºæ–°çš„ä»£ç ã€‚ æ¯”å¦‚æ¨¡æ¿å¼•æ“æœ€åä¸€æ­¥ä¼šå°è£…æˆä¸ºä¸€ä¸ªæ¸²æŸ“å‡½æ•°. å¤æ‚çš„ç¼–è¯‘å™¨ä¼šå°†ASTè½¬æ¢ä¸ºç›®æ ‡ä»£ç </li></ol><p>ç¼–è¯‘å™¨ç›¸å…³çš„ä¸œè¥¿ç¡®å®å¾ˆæœ‰è¶£ï¼Œåç»­æœ‰æœºä¼šå¯ä»¥è®²è®²æ€ä¹ˆç¼–å†™babelæ’ä»¶ã€‚</p><p><br></p><h2 id="æ‰©å±•"><a href="#æ‰©å±•" class="headerlink" title="æ‰©å±•"></a>æ‰©å±•</h2><ul><li><a href="https://github.com/mde/ejs/tree/master/lib" target="_blank" rel="noopener">Ejsæºä»£ç </a></li><li><a href="https://github.com/jamiebuilds/the-super-tiny-compiler" target="_blank" rel="noopener">the-super-tiny-compiler</a></li><li><a href="https://ruslanspivak.com/lsbasi-part7/" target="_blank" rel="noopener">Letâ€™s Build A Simple Interpreter. Part 7: Abstract Syntax Trees</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;ä¸€å¼ å›¾è¯´æ˜Ejsæ¨¡æ¿å¼•æ“çš„åŸç†&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/ejs/ejs.png&quot; alt&gt;&lt;/p&gt;
&lt;p&gt;&lt;br&gt;&lt;/p&gt;
&lt;p&gt;ä¸Šé¢ä¸€å¼ å›¾ï¼Œå·²ç»å¤§æ¦‚æŠŠä¸€ä¸ªç®€å•æ¨¡æ¿å¼•æ“(è¿™é‡Œä»¥&lt;a href=&quot;https://ejs.co/&quot; target=&quot;_b
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://bobi.ink/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>æ­å¼€Electronçš„remoteæ¨¡å—çš„é¢çº±</title>
    <link href="https://bobi.ink/2019/08/04/electron-remote/"/>
    <id>https://bobi.ink/2019/08/04/electron-remote/</id>
    <published>2019-08-03T16:00:00.000Z</published>
    <updated>2019-08-09T13:28:24.883Z</updated>
    
    <content type="html"><![CDATA[<p>Electronçš„remoteæ¨¡å—æ˜¯ä¸€ä¸ªæ¯”è¾ƒç¥å¥‡çš„ä¸œè¥¿ï¼Œä¸º<code>æ¸²æŸ“è¿›ç¨‹</code>å’Œ<code>ä¸»è¿›ç¨‹</code>é€šä¿¡å°è£…äº†ä¸€ç§ç®€å•æ–¹æ³•ï¼Œé€šè¿‡remoteä½ å¯ä»¥â€™ç›´æ¥â€™è·å–ä¸»è¿›ç¨‹å¯¹è±¡æˆ–è€…è°ƒç”¨ä¸»è¿›ç¨‹å‡½æ•°æˆ–å¯¹è±¡çš„æ–¹æ³•, è€Œä¸å¿…æ˜¾å¼å‘é€è¿›ç¨‹é—´æ¶ˆæ¯, ç±»ä¼¼äº Java çš„ RMI. ä¾‹å¦‚:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; remote &#125; = <span class="built_in">require</span>(<span class="string">'electron'</span>)</span><br><span class="line"><span class="keyword">const</span> myModal = remote.require(<span class="string">'myModal'</span>) <span class="comment">// è®©ä¸»è¿›ç¨‹requireæŒ‡å®šæ¨¡å—ï¼Œå¹¶è¿”å›åˆ°æ¸²æŸ“è¿›ç¨‹</span></span><br><span class="line">myModal.dosomething()                     <span class="comment">// è°ƒç”¨æ–¹æ³•</span></span><br></pre></td></tr></table></figure><p><br></p><p><strong>æœ¬è´¨ä¸Šï¼Œremoteæ¨¡å—æ˜¯åŸºäºElectronçš„IPCæœºåˆ¶çš„ï¼Œè¿›ç¨‹ä¹‹é—´çš„é€šä¿¡çš„æ•°æ®å¿…é¡»æ˜¯å¯åºåˆ—åŒ–çš„ï¼Œæ¯”å¦‚JSONåºåˆ—åŒ–</strong>ã€‚æ‰€ä»¥æœ¬æ–‡çš„ç›®çš„æ˜¯ä»‹ç»Electronæ˜¯å¦‚ä½•è®¾è®¡remoteæ¨¡å—çš„ï¼Œä»¥åŠé‡Œé¢æœ‰ä»€ä¹ˆå‘ã€‚</p><p><br></p><p><img src="/images/electron-remote/ipc.png" alt></p><p><br></p><p><strong>æ–‡ç« å¤§çº²</strong></p><ul><li><a href="#%e9%80%9a%e4%bf%a1%e5%8d%8f%e8%ae%ae%e7%9a%84%e5%ae%9a%e4%b9%89">é€šä¿¡åè®®çš„å®šä¹‰</a></li><li><a href="#%e5%af%b9%e8%b1%a1%e7%9a%84%e5%ba%8f%e5%88%97%e5%8c%96">å¯¹è±¡çš„åºåˆ—åŒ–</a></li><li><a href="#%e5%bd%b1%e5%ad%90%e5%af%b9%e8%b1%a1">å½±å­å¯¹è±¡</a></li><li><a href="#%e5%af%b9%e8%b1%a1%e7%9a%84%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f">å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸ</a></li><li><a href="#%e6%b8%b2%e6%9f%93%e8%bf%9b%e7%a8%8b%e6%80%8e%e4%b9%88%e7%bb%99%e4%b8%bb%e8%bf%9b%e7%a8%8b%e4%bc%a0%e9%80%92%e5%9b%9e%e8%b0%83">æ¸²æŸ“è¿›ç¨‹æ€ä¹ˆç»™ä¸»è¿›ç¨‹ä¼ é€’å›è°ƒ</a></li><li><a href="#%e4%b8%80%e4%ba%9b%e7%bc%ba%e9%99%b7">ä¸€äº›ç¼ºé™·</a></li><li><a href="#remote%e6%a8%a1%e5%9d%97%e5%ae%9e%e8%b7%b5%e5%92%8c%e4%bc%98%e5%8c%96">remoteæ¨¡å—å®è·µå’Œä¼˜åŒ–</a></li><li><a href="#%e6%80%bb%e7%bb%93">æ€»ç»“</a></li><li><a href="#%e6%89%a9%e5%b1%95">æ‰©å±•</a></li></ul><p><br></p><h2 id="é€šä¿¡åè®®çš„å®šä¹‰"><a href="#é€šä¿¡åè®®çš„å®šä¹‰" class="headerlink" title="é€šä¿¡åè®®çš„å®šä¹‰"></a>é€šä¿¡åè®®çš„å®šä¹‰</h2><p>ä¸Šæ–‡è¯´åˆ°ï¼Œremoteæœ¬è´¨ä¸ŠåŸºäºåºåˆ—åŒ–çš„IPCé€šä¿¡çš„ï¼Œæ‰€ä»¥é¦–å…ˆå…³é”®éœ€è¦<strong>å®šä¹‰ä¸€ä¸ªåè®®æ¥æè¿°ä¸€ä¸ªæ¨¡å—/å¯¹è±¡çš„å¤–å½¢</strong>ï¼Œå…¶ä¸­åŒ…å«ä¸‹åˆ—ç±»å‹:</p><ul><li>åŸå§‹å€¼ã€‚ä¾‹å¦‚å­—ç¬¦ä¸²ã€æ•°å­—ã€å¸ƒå°”å€¼</li><li>æ•°ç»„ã€‚</li><li>å¯¹è±¡ã€‚å¯¹è±¡å±æ€§ã€å¯¹è±¡çš„æ–¹æ³•ã€ä»¥åŠå¯¹è±¡çš„åŸå‹</li><li>å‡½æ•°ã€‚æ™®é€šå‡½æ•°å’Œæ„é€ æ–¹æ³•ã€å¼‚å¸¸å¤„ç†</li><li>ç‰¹æ®Šå¯¹è±¡ã€‚Dateã€Bufferã€Promiseã€å¼‚å¸¸å¯¹è±¡ç­‰ç­‰</li></ul><p><br></p><p>Electronä½¿ç”¨MetaData(å…ƒæ•°æ®)æ¥æè¿°è¿™äº›å¯¹è±¡å¤–å½¢çš„åè®®. ä¸‹é¢æ˜¯ä¸€äº›è½¬æ¢çš„ç¤ºä¾‹:</p><ul><li><p><strong>åŸºæœ¬å¯¹è±¡</strong>: åŸºæœ¬å¯¹è±¡å¾ˆå®¹æ˜“å¤„ç†ï¼Œç›´æ¥å€¼æ‹·è´ä¼ é€’å³å¯</p><ul><li><p>è¾“å…¥</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>;</span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">Buffer.from(<span class="string">'hello world'</span>);</span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'message'</span>);</span><br></pre></td></tr></table></figure></li><li><p>è¾“å‡º</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;<span class="attr">type</span>: <span class="string">"value"</span>, <span class="attr">value</span>: <span class="number">1</span>&#125;;</span><br><span class="line">&#123;<span class="attr">type</span>: <span class="string">"date"</span>, <span class="attr">value</span>: <span class="number">1565002306662</span>&#125;;  <span class="comment">// åºåˆ—åŒ–ä¸ºæ—¶é—´æˆ³</span></span><br><span class="line">&#123;<span class="attr">type</span>:Â <span class="string">"buffer"</span>, <span class="attr">value</span>:Â &#123;<span class="attr">data</span>:Â <span class="built_in">Uint8Array</span>(<span class="number">11</span>),Â <span class="attr">length</span>:Â <span class="number">11</span>,Â <span class="attr">type</span>:Â <span class="string">"Buffer"</span>&#125;&#125;; <span class="comment">// åºåˆ—åŒ–ä¸ºæ•°ç»„</span></span><br><span class="line">&#123;</span><br><span class="line">  members: [</span><br><span class="line">    &#123;</span><br><span class="line">      name: <span class="string">"stack"</span>,</span><br><span class="line">      value: <span class="string">"Error: message\n    at Object.&lt;anonymous&gt; (çœç•¥è°ƒç”¨æ ˆ)"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123; <span class="attr">name</span>: <span class="string">"message"</span>, <span class="attr">value</span>: <span class="string">"message"</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">name</span>: <span class="string">"name"</span>, <span class="attr">value</span>: <span class="string">"Error"</span> &#125;</span><br><span class="line">  ],</span><br><span class="line">  type: <span class="string">"error"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p></li></ul></li><li><p><strong>æ•°ç»„</strong>: æ•°ç»„ä¹Ÿæ˜¯å€¼æ‹·è´</p><ul><li><p>è¾“å…¥</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br></pre></td></tr></table></figure></li><li><p>è¾“å‡º</p><p>æ•°ç»„ä¼šé€’å½’å¯¹æˆå‘˜è¿›è¡Œè½¬æ¢. æ³¨æ„æ•°ç»„å’ŒåŸºæœ¬ç±»å‹æ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œå®ƒä¹Ÿæ˜¯å€¼æ‹·è´ï¼Œä¹Ÿå°±æ˜¯è¯´ä¿®æ”¹æ•°ç»„ä¸ä¼šå½±å“åˆ°å¯¹ç«¯è¿›ç¨‹çš„æ•°ç»„å€¼ã€‚</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"members"</span>: [</span><br><span class="line">    &#123;<span class="string">"type"</span>:<span class="string">"value"</span>,<span class="string">"value"</span>:<span class="number">1</span>&#125;,</span><br><span class="line">    &#123;<span class="string">"type"</span>:<span class="string">"value"</span>,<span class="string">"value"</span>:<span class="number">2</span>&#125;,</span><br><span class="line">    &#123;<span class="string">"type"</span>:<span class="string">"value"</span>,<span class="string">"value"</span>:<span class="number">3</span>&#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"type"</span>:<span class="string">"array"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li></ul><p><br></p><ul><li><p><strong>çº¯å¯¹è±¡</strong>: </p><ul><li><p>è¾“å…¥</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  a: <span class="number">1</span>,</span><br><span class="line">  b: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.a;</span><br><span class="line">  &#125;,</span><br><span class="line">  c: &#123;</span><br><span class="line">    d: <span class="string">'d'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>è¾“å‡º</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="comment">// è¿™é‡Œæœ‰ä¸€ä¸ªidï¼Œç”¨äºæ ‡è¯†ä¸»è¿›ç¨‹çš„ä¸€ä¸ªå¯¹è±¡</span></span><br><span class="line">  id: <span class="number">1</span>,</span><br><span class="line">  <span class="comment">// å¯¹è±¡æˆå‘˜</span></span><br><span class="line">  members: [</span><br><span class="line">    &#123; <span class="attr">enumerable</span>: <span class="literal">true</span>, <span class="attr">name</span>: <span class="string">"a"</span>, <span class="attr">type</span>: <span class="string">"get"</span>, <span class="attr">writable</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">enumerable</span>: <span class="literal">true</span>, <span class="attr">name</span>: <span class="string">"b"</span>, <span class="attr">type</span>: <span class="string">"method"</span>, <span class="attr">writable</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">    <span class="comment">// electronåªä¼šè½¬æ¢ä¸€å±‚ï¼Œä¸ä¼šé€’å½’è½¬æ¢å†…åµŒå¯¹è±¡</span></span><br><span class="line">    &#123; <span class="attr">enumerable</span>: <span class="literal">true</span>, <span class="attr">name</span>: <span class="string">"c"</span>, <span class="attr">type</span>: <span class="string">"get"</span>, <span class="attr">writable</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">  ],</span><br><span class="line">  name: <span class="string">"Object"</span>,</span><br><span class="line">  <span class="comment">// å¯¹è±¡çš„ä¸Šçº§åŸå‹çš„MetaData</span></span><br><span class="line">  proto: <span class="literal">null</span>,</span><br><span class="line">  type: <span class="string">"object"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p></li></ul></li><li><p><strong>å‡½æ•°</strong>:</p><ul><li><p>è¾“å…¥</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'hello world'</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li><li><p>è¾“å‡º</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="comment">// å‡½æ•°ä¹Ÿæœ‰ä¸€ä¸ªå”¯ä¸€idæ ‡è¯†ï¼Œå› ä¸ºå®ƒä¹Ÿæ˜¯å¯¹è±¡ï¼Œä¸»è¿›ç¨‹éœ€è¦ä¿æŒè¯¥å¯¹è±¡çš„å¼•ç”¨</span></span><br><span class="line">  id: <span class="number">2</span>,</span><br><span class="line">  <span class="comment">// å‡½æ•°å±æ€§æˆå‘˜</span></span><br><span class="line">  members: [],</span><br><span class="line">  name: <span class="string">"Function"</span>,</span><br><span class="line">  type: <span class="string">"function"</span></span><br><span class="line">  <span class="comment">// Electronè§£æå¯¹è±¡çš„åŸå‹é“¾</span></span><br><span class="line">  proto: &#123;</span><br><span class="line">    members: [</span><br><span class="line">      <span class="comment">// æ„é€ å‡½æ•°</span></span><br><span class="line">      &#123;</span><br><span class="line">        enumerable: <span class="literal">false</span>,</span><br><span class="line">        name: <span class="string">"constructor"</span>,</span><br><span class="line">        type: <span class="string">"method"</span>,</span><br><span class="line">        writable: <span class="literal">false</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123; <span class="attr">enumerable</span>: <span class="literal">false</span>, <span class="attr">name</span>: <span class="string">"apply"</span>, <span class="attr">type</span>: <span class="string">"method"</span>, <span class="attr">writable</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">enumerable</span>: <span class="literal">false</span>, <span class="attr">name</span>: <span class="string">"bind"</span>, <span class="attr">type</span>: <span class="string">"method"</span>, <span class="attr">writable</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">enumerable</span>: <span class="literal">false</span>, <span class="attr">name</span>: <span class="string">"call"</span>, <span class="attr">type</span>: <span class="string">"method"</span>, <span class="attr">writable</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">enumerable</span>: <span class="literal">false</span>, <span class="attr">name</span>: <span class="string">"toString"</span>, <span class="attr">type</span>: <span class="string">"method"</span>, <span class="attr">writable</span>: <span class="literal">false</span> &#125;</span><br><span class="line">    ],</span><br><span class="line">    proto: <span class="literal">null</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p></li></ul></li><li><p><strong>Promise</strong>ï¼šPromiseåªéœ€æè¿°thenå‡½æ•°</p><ul><li><p>è¾“å…¥:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.resolve();</span><br></pre></td></tr></table></figure></li><li><p>è¾“å…¥:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Promiseè¿™é‡Œå…³é”®åœ¨äºthenï¼Œè¯¦è§ä¸Šé¢çš„å‡½æ•°å…ƒæ•°æ®</span></span><br><span class="line">&#123;</span><br><span class="line">  type: <span class="string">"promise"</span></span><br><span class="line">  then: &#123;</span><br><span class="line">    id: <span class="number">2</span>,</span><br><span class="line">    members: [],</span><br><span class="line">    name: <span class="string">"Function"</span>,</span><br><span class="line">    proto: &#123;<span class="comment">/*è§ä¸Šé¢*/</span>&#125;,</span><br><span class="line">    type: <span class="string">"function"</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li></ul></li></ul><p><br></p><p>äº†è§£remoteçš„æ•°æ®ä¼ è¾“åè®®åï¼Œæœ‰ç»éªŒçš„å¼€å‘è€…åº”è¯¥å¿ƒé‡Œæœ‰åº•äº†ï¼Œå®ƒçš„åŸç†å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š</p><p><img src="/images/electron-remote/meta-transform.png" alt></p><p>ä¸»è¿›ç¨‹å’Œæ¸²æŸ“è¿›ç¨‹ä¹‹é—´éœ€è¦å°†å¯¹è±¡åºåˆ—åŒ–æˆMetaDataæè¿°ï¼Œè½¬æ¢çš„è§„åˆ™ä¸Šé¢å·²ç»è§£é‡Šçš„æ¯”è¾ƒæ¸…æ¥šäº†ã€‚è¿™é‡Œé¢éœ€è¦ç‰¹æ®Šå¤„ç†æ˜¯å¯¹è±¡å’Œå‡½æ•°ï¼Œæ¸²æŸ“è¿›ç¨‹æ‹¿åˆ°MetaDataåéœ€è¦å°è£…æˆä¸€ä¸ªå½±å­å¯¹è±¡/å‡½æ•°ï¼Œæ¥ä¾›æ¸²æŸ“è¿›ç¨‹åº”ç”¨è°ƒç”¨ã€‚</p><p>å…¶ä¸­æ¯”è¾ƒå¤æ‚çš„æ˜¯å¯¹è±¡å’Œå‡½æ•°çš„å¤„ç†ï¼ŒElectronä¸ºäº†é˜²æ­¢å¯¹è±¡è¢«åƒåœ¾å›æ”¶ï¼Œéœ€è¦å°†è¿™äº›å¯¹è±¡æ”¾è¿›ä¸€ä¸ªæ³¨å†Œè¡¨ä¸­ï¼Œåœ¨è¿™ä¸ªè¡¨ä¸­æ¯ä¸ªå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„idæ¥æ ‡è¯†ã€‚è¿™ä¸ªidæœ‰ç‚¹ç±»ä¼¼äºâ€˜æŒ‡é’ˆâ€™ï¼Œæ¸²æŸ“è¿›ç¨‹ä¼šæ‹¿ç€è¿™ä¸ªidå‘ä¸»è¿›ç¨‹è¯·æ±‚è®¿é—®å¯¹è±¡ã€‚</p><p>é‚£ä»€ä¹ˆæ—¶å€™éœ€è¦é‡Šæ”¾è¿™äº›å¯¹è±¡å‘¢ï¼Ÿä¸‹æ–‡ä¼šè®²å…·ä½“çš„å®ç°ç»†èŠ‚ã€‚</p><p>è¿˜æœ‰ä¸€ä¸ªä¸Šå›¾æ²¡æœ‰å±•ç¤ºå‡ºæ¥çš„ç»†èŠ‚æ˜¯ï¼ŒElectronä¸ä¼šé€’å½’å»è½¬æ¢å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒåªä¼šè½¬æ¢ä¸€å±‚ã€‚è¿™æ ·å¯ä»¥å®‰å…¨åœ°å¼•ç”¨å­˜åœ¨å¾ªç¯å¼•ç”¨çš„å¯¹è±¡ã€å¦å¤–æ‰€æœ‰å±æ€§å€¼åº”è¯¥ä»è¿œç¨‹è·å–æœ€æ–°çš„å€¼ï¼Œä¸èƒ½å‡è®¾å®ƒçš„ç»“æ„ä¸å¯å˜ã€‚</p><p><br><br><br></p><h2 id="å¯¹è±¡çš„åºåˆ—åŒ–"><a href="#å¯¹è±¡çš„åºåˆ—åŒ–" class="headerlink" title="å¯¹è±¡çš„åºåˆ—åŒ–"></a>å¯¹è±¡çš„åºåˆ—åŒ–</h2><p>å…ˆæ¥çœ‹çœ‹ä¸»è¿›ç¨‹çš„å®ç°ï¼Œå®ƒçš„ä»£ç ä½äº<a href="https://github.com/electron/electron/blob/master/lib/browser/rpc-server.js" target="_blank" rel="noopener">/lib/browser/rpc-server.js</a>ï¼Œä»£ç å¾ˆå°‘è€Œä¸”å¾ˆå¥½ç†è§£ï¼Œè¯»è€…å¯ä»¥è‡ªå·±è¯»ä¸€ä¸‹ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬ä¸å…³æ³¨å¯¹è±¡åºåˆ—åŒ–çš„ç»†èŠ‚ï¼Œé‡ç‚¹å…³æ³¨å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå’Œè°ƒç”¨çš„æµç¨‹. </p><p><br></p><p>ä»¥<code>remote.require</code>ä¸ºä¾‹, è¿™ä¸ªæ–¹æ³•ç”¨äºè®©ä¸»è¿›ç¨‹å»requireæŒ‡å®šæ¨¡å—ï¼Œç„¶åè¿”å›æ¨¡å—å†…å®¹ç»™æ¸²æŸ“è¿›ç¨‹ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">handleRemoteCommand(<span class="string">'ELECTRON_BROWSER_REQUIRE'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">event, contextId, moduleName</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// è°ƒç”¨require</span></span><br><span class="line">  <span class="keyword">const</span> returnValue = process.mainModule.require(moduleName)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å°†returnValueåºåˆ—åŒ–ä¸ºMetaData</span></span><br><span class="line">  <span class="keyword">return</span> valueToMeta(event.sender, contextId, returnValue)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><code>handleRemoteCommand</code> ä½¿ç”¨<a href="https://electronjs.org/docs/api/ipc-main" target="_blank" rel="noopener">ipcMain</a>ç›‘å¬rendererå‘é€çš„è¯·æ±‚ï¼Œ<code>contextId</code>ç”¨äºæ ‡è¯†ä¸€ä¸ªæ¸²æŸ“è¿›ç¨‹ã€‚</p><p><br></p><p><code>valueToMeta</code>æ–¹æ³•å°†å€¼åºåˆ—åŒ–ä¸ºMetaData:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> valueToMeta = <span class="function"><span class="keyword">function</span> (<span class="params">sender, contextId, value, optimizeSimpleObject = false</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Determine the type of value.</span></span><br><span class="line">  <span class="keyword">const</span> meta = &#123; <span class="attr">type</span>: <span class="keyword">typeof</span> value &#125;</span><br><span class="line">  <span class="keyword">if</span> (meta.type === <span class="string">'object'</span>) &#123;</span><br><span class="line">    <span class="comment">// Recognize certain types of objects.</span></span><br><span class="line">    <span class="keyword">if</span> (value === <span class="literal">null</span>) &#123;</span><br><span class="line">      meta.type = <span class="string">'value'</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (bufferUtils.isBuffer(value)) &#123;</span><br><span class="line">      <span class="comment">// ... ğŸ”´ åŸºæœ¬ç±»å‹</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (meta.type === <span class="string">'array'</span>) &#123;</span><br><span class="line">    <span class="comment">// ğŸ”´ æ•°ç»„è½¬æ¢</span></span><br><span class="line">    meta.members = value.map(<span class="function">(<span class="params">el</span>) =&gt;</span> valueToMeta(sender, contextId, el, optimizeSimpleObject))</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (meta.type === <span class="string">'object'</span> || meta.type === <span class="string">'function'</span>) &#123;</span><br><span class="line">    meta.name = value.constructor ? value.constructor.name : <span class="string">''</span></span><br><span class="line">    <span class="comment">// ğŸ”´ å°†å¯¹è±¡ä¿å­˜åˆ°æ³¨å†Œè¡¨ä¸­ï¼Œå¹¶è¿”å›å”¯ä¸€çš„å¯¹è±¡id.</span></span><br><span class="line">    <span class="comment">// Electronä¼šå‡è®¾æ¸²æŸ“è¿›ç¨‹ä¼šä¸€ç›´å¼•ç”¨è¿™ä¸ªå¯¹è±¡, ç›´åˆ°æ¸²æŸ“è¿›ç¨‹é€€å‡º</span></span><br><span class="line">    meta.id = objectsRegistry.add(sender, contextId, value)</span><br><span class="line">    meta.members = getObjectMembers(value)</span><br><span class="line">    meta.proto = getObjectPrototype(value)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (meta.type === <span class="string">'buffer'</span>) &#123;</span><br><span class="line">    meta.value = bufferUtils.bufferToMeta(value)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (meta.type === <span class="string">'promise'</span>) &#123;</span><br><span class="line">    <span class="comment">// ğŸ”´promise</span></span><br><span class="line">    value.then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;)</span><br><span class="line">    meta.then = valueToMeta(sender, contextId, <span class="function"><span class="keyword">function</span> (<span class="params">onFulfilled, onRejected</span>) </span>&#123;</span><br><span class="line">      value.then(onFulfilled, onRejected)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (meta.type === <span class="string">'error'</span>) &#123;</span><br><span class="line">    <span class="comment">// ğŸ”´é”™è¯¯å¯¹è±¡</span></span><br><span class="line">    meta.members = plainObjectToMeta(value)</span><br><span class="line">    meta.members.push(&#123;</span><br><span class="line">      name: <span class="string">'name'</span>,</span><br><span class="line">      value: value.name</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (meta.type === <span class="string">'date'</span>) &#123;</span><br><span class="line">    <span class="comment">// ğŸ”´æ—¥æœŸ</span></span><br><span class="line">    meta.value = value.getTime()</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// å…¶ä»–</span></span><br><span class="line">    meta.type = <span class="string">'value'</span></span><br><span class="line">    meta.value = value</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> meta</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br><br><br></p><h2 id="å½±å­å¯¹è±¡"><a href="#å½±å­å¯¹è±¡" class="headerlink" title="å½±å­å¯¹è±¡"></a>å½±å­å¯¹è±¡</h2><p><img src="/images/electron-remote/naruto.jpeg" alt></p><p>æ¸²æŸ“è¿›ç¨‹ä¼šä»MetaDataä¸­ååºåˆ—åŒ–çš„å¯¹è±¡æˆ–å‡½æ•°, ä¸è¿‡è¿™åªæ˜¯ä¸€ä¸ªâ€˜å½±å­â€™ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å°†å®ƒä»¬ç§°ä¸º<strong>å½±å­å¯¹è±¡</strong>æˆ–è€…<strong>ä»£ç†å¯¹è±¡</strong>ã€<strong>æ›¿èº«</strong>. ç±»ä¼¼äºç«å½±å¿è€…ä¸­çš„å½±åˆ†èº«ä¹‹æœ¯ï¼Œä¸»ä½“å­˜å‚¨åœ¨ä¸»è¿›ç¨‹ä¸­ï¼Œå½±å­å¯¹è±¡ä¸åŒ…å«ä»»ä½•å®ä½“æ•°æ®ï¼Œå½“è®¿é—®è¿™äº›å¯¹è±¡æˆ–è°ƒç”¨å‡½æ•°/æ–¹æ³•æ—¶ï¼Œå½±å­å¯¹è±¡ç›´æ¥è¿œç¨‹è¯·æ±‚ã€‚</p><blockquote><p>æ¸²æŸ“è¿›ç¨‹çš„ä»£ç å¯ä»¥çœ‹<a href="https://github.com/electron/electron/blob/master/lib/renderer/api/remote.js" target="_blank" rel="noopener">è¿™é‡Œ</a></p></blockquote><p>æ¥çœ‹çœ‹æ¸²æŸ“è¿›ç¨‹æ€ä¹ˆåˆ›å»ºâ€˜å½±å­å¯¹è±¡â€™:</p><p><strong>å‡½æ•°çš„å¤„ç†</strong>:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (meta.type === <span class="string">'function'</span>) &#123;</span><br><span class="line">  <span class="comment">// ğŸ”´åˆ›å»ºä¸€ä¸ª'å½±å­'å‡½æ•°</span></span><br><span class="line">  <span class="keyword">const</span> remoteFunction = <span class="function"><span class="keyword">function</span> (<span class="params">...args</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> command</span><br><span class="line">    <span class="comment">// é€šè¿‡new Objå½¢å¼è°ƒç”¨</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span> &amp;&amp; <span class="keyword">this</span>.constructor === remoteFunction) &#123;</span><br><span class="line">      command = <span class="string">'ELECTRON_BROWSER_CONSTRUCTOR'</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      command = <span class="string">'ELECTRON_BROWSER_FUNCTION_CALL'</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ğŸ”´åŒæ­¥IPCè¿œç¨‹</span></span><br><span class="line">    <span class="comment">// wrapArgså°†å‡½æ•°å‚æ•°åºåˆ—åŒ–ä¸ºMetaData</span></span><br><span class="line">    <span class="keyword">const</span> obj = ipcRendererInternal.sendSync(command, contextId, meta.id, wrapArgs(args))</span><br><span class="line">    <span class="comment">// ğŸ”´ååºåˆ—åŒ–è¿”å›å€¼</span></span><br><span class="line">    <span class="keyword">return</span> metaToValue(obj)</span><br><span class="line">  &#125;</span><br><span class="line">  ret = remoteFunction</span><br></pre></td></tr></table></figure><p><br></p><p><strong>å¯¹è±¡æˆå‘˜çš„å¤„ç†</strong>:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setObjectMembers</span> (<span class="params">ref, object, metaId, members</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> member <span class="keyword">of</span> members) &#123;</span><br><span class="line">    <span class="keyword">if</span> (object.hasOwnProperty(member.name)) <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> descriptor = &#123; <span class="attr">enumerable</span>: member.enumerable &#125;</span><br><span class="line">    <span class="keyword">if</span> (member.type === <span class="string">'method'</span>) &#123;</span><br><span class="line">      <span class="comment">// ğŸ”´åˆ›å»ºâ€˜å½±å­â€™æ–¹æ³•. å’Œä¸Šé¢çš„å‡½æ•°è°ƒç”¨å·®ä¸å¤š</span></span><br><span class="line">      <span class="keyword">const</span> remoteMemberFunction = <span class="function"><span class="keyword">function</span> (<span class="params">...args</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> command</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> &amp;&amp; <span class="keyword">this</span>.constructor === remoteMemberFunction) &#123;</span><br><span class="line">          command = <span class="string">'ELECTRON_BROWSER_MEMBER_CONSTRUCTOR'</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          command = <span class="string">'ELECTRON_BROWSER_MEMBER_CALL'</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> ret = ipcRendererInternal.sendSync(command, contextId, metaId, member.name, wrapArgs(args))</span><br><span class="line">        <span class="keyword">return</span> metaToValue(ret)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (member.type === <span class="string">'get'</span>) &#123;</span><br><span class="line">      <span class="comment">// ğŸ”´å±æ€§çš„è·å–</span></span><br><span class="line">      descriptor.get = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> command = <span class="string">'ELECTRON_BROWSER_MEMBER_GET'</span></span><br><span class="line">        <span class="keyword">const</span> meta = ipcRendererInternal.sendSync(command, contextId, metaId, member.name)</span><br><span class="line">        <span class="keyword">return</span> metaToValue(meta)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ğŸ”´å±æ€§çš„è®¾ç½®</span></span><br><span class="line">      <span class="keyword">if</span> (member.writable) &#123;</span><br><span class="line">        descriptor.set = <span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> args = wrapArgs([value])</span><br><span class="line">          <span class="keyword">const</span> command = <span class="string">'ELECTRON_BROWSER_MEMBER_SET'</span></span><br><span class="line">          <span class="keyword">const</span> meta = ipcRendererInternal.sendSync(command, contextId, metaId, member.name, args)</span><br><span class="line">          <span class="keyword">if</span> (meta != <span class="literal">null</span>) metaToValue(meta)</span><br><span class="line">          <span class="keyword">return</span> value</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(object, member.name, descriptor)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br><br><br></p><h2 id="å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸ"><a href="#å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸ"></a>å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸ</h2><p><strong>ä¸»è¿›ç¨‹çš„<code>valueToMeta</code>ä¼šå°†æ¯ä¸€ä¸ªå¯¹è±¡å’Œå‡½æ•°éƒ½æ”¾å…¥æ³¨å†Œè¡¨ä¸­ï¼ŒåŒ…æ‹¬æ¯æ¬¡å‡½æ•°è°ƒç”¨çš„è¿”å›å€¼</strong>ã€‚</p><p>è¿™æ˜¯å¦æ„å‘³ç€ï¼Œå¦‚æœé¢‘ç¹è°ƒç”¨å‡½æ•°ï¼Œä¼šå¯¼è‡´æ³¨å†Œè¡¨æš´æ¶¨å ç”¨å¤ªå¤šå†…å­˜å‘¢ï¼Ÿè¿™äº›å¯¹è±¡ä»€ä¹ˆæ—¶å€™é‡Šæ”¾?</p><p><br></p><p>é¦–å…ˆ<strong>å½“æ¸²æŸ“è¿›ç¨‹é”€æ¯æ—¶ï¼Œä¸»è¿›ç¨‹ä¼šé›†ä¸­é”€æ¯æ‰è¯¥è¿›ç¨‹çš„æ‰€æœ‰å¯¹è±¡å¼•ç”¨</strong>ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ¸²æŸ“è¿›ç¨‹é€€å‡ºæ—¶ä¼šé€šè¿‡è¿™ä¸ªäº‹ä»¶å‘Šè¯‰ä¸»è¿›ç¨‹ï¼Œä½†æ˜¯è¿™ä¸ªå¹¶ä¸èƒ½ä¿è¯æ”¶åˆ°</span></span><br><span class="line">handleRemoteCommand(<span class="string">'ELECTRON_BROWSER_CONTEXT_RELEASE'</span>, (event, contextId) =&gt; &#123;</span><br><span class="line">  <span class="comment">// æ¸…ç©ºå¯¹è±¡æ³¨å†Œè¡¨</span></span><br><span class="line">  objectsRegistry.clear(event.sender, contextId)</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>å› ä¸º<code>ELECTRON_BROWSER_CONTEXT_RELEASE</code>ä¸èƒ½ä¿è¯èƒ½å¤Ÿæ”¶åˆ°ï¼Œæ‰€ä»¥<code>objectsRegistry</code>è¿˜ä¼šç›‘å¬å¯¹åº”æ¸²æŸ“è¿›ç¨‹çš„é”€æ¯äº‹ä»¶:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ObjectsRegistry</span> </span>&#123;</span><br><span class="line">    registerDeleteListener (webContents, contextId) &#123;</span><br><span class="line">    <span class="comment">// contextId =&gt; $&#123;processHostId&#125;-$&#123;contextCount&#125;</span></span><br><span class="line">    <span class="keyword">const</span> processHostId = contextId.split(<span class="string">'-'</span>)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">const</span> listener = <span class="function">(<span class="params">event, deletedProcessHostId</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (deletedProcessHostId &amp;&amp;</span><br><span class="line">          deletedProcessHostId.toString() === processHostId) &#123;</span><br><span class="line">        webContents.removeListener(<span class="string">'render-view-deleted'</span>, listener)</span><br><span class="line">        <span class="keyword">this</span>.clear(webContents, contextId)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ğŸ”´ ç›‘å¬æ¸²æŸ“è¿›ç¨‹é”€æ¯äº‹ä»¶, ç¡®ä¿ä¸‡æ— ä¸€å¤±</span></span><br><span class="line">    webContents.on(<span class="string">'render-view-deleted'</span>, listener)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>ç­‰<strong>åˆ°æ¸²æŸ“è¿›ç¨‹é”€æ¯å†å»é‡Šæ”¾è¿™äº›å¯¹è±¡æ˜¾ç„¶æ˜¯æ— æ³•æ¥å—çš„</strong>ï¼Œå’Œç½‘é¡µä¸ä¸€æ ·ï¼Œæ¡Œé¢ç«¯åº”ç”¨å¯èƒ½ä¼š7*24ä¸é—´æ–­è¿è¡Œï¼Œå¦‚æœè¦ç­‰åˆ°æ¸²æŸ“è¿›ç¨‹é€€å‡ºæ‰å»å›æ”¶å¯¹è±¡, æœ€ç»ˆä¼šå¯¼è‡´ç³»ç»Ÿèµ„æºè¢«æ¶ˆè€—æ®†å°½ã€‚</p><p>æ‰€ä»¥<strong>Electronä¼šåœ¨æ¸²æŸ“è¿›ç¨‹ä¸­ç›‘å¬å¯¹è±¡çš„åƒåœ¾å›æ”¶äº‹ä»¶ï¼Œå†é€šè¿‡IPCé€šçŸ¥ä¸»è¿›ç¨‹æ¥é€’å‡å¯¹åº”å¯¹è±¡çš„å¼•ç”¨è®¡æ•°</strong>ï¼Œ çœ‹çœ‹æ¸²æŸ“è¿›ç¨‹æ˜¯æ€ä¹ˆåšçš„ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ¸²æŸ“è¿›ç¨‹ï¼Œååºåˆ—åŒ–</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">metaToValue</span> (<span class="params">meta</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// å¯¹è±¡ç±»å‹è½¬æ¢</span></span><br><span class="line">    <span class="keyword">let</span> ret</span><br><span class="line">    <span class="keyword">if</span> (remoteObjectCache.has(meta.id)) &#123;</span><br><span class="line">      <span class="comment">// ğŸ”´ å¯¹è±¡å†ä¸€æ¬¡è¢«è®¿é—®ï¼Œé€’å¢å¯¹è±¡å¼•ç”¨è®¡æ•°. </span></span><br><span class="line">      <span class="comment">// v8Utilæ˜¯electronåŸç”Ÿæ¨¡å—</span></span><br><span class="line">      v8Util.addRemoteObjectRef(contextId, meta.id)</span><br><span class="line">      <span class="keyword">return</span> remoteObjectCache.get(meta.id)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ªå½±å­ç±»è¡¨ç¤ºè¿œç¨‹å‡½æ•°å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">if</span> (meta.type === <span class="string">'function'</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> remoteFunction = <span class="function"><span class="keyword">function</span> (<span class="params">...args</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">      &#125;</span><br><span class="line">      ret = remoteFunction</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      ret = &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    setObjectMembers(ret, ret, meta.id, meta.members)</span><br><span class="line">    setObjectPrototype(ret, ret, meta.id, meta.proto)</span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(ret.constructor, <span class="string">'name'</span>, &#123; <span class="attr">value</span>: meta.name &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ğŸ”´ ç›‘å¬å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œå½“å¯¹è±¡è¢«åƒåœ¾å›æ”¶æ—¶ï¼Œé€šçŸ¥åˆ°ä¸»è¿›ç¨‹</span></span><br><span class="line">    v8Util.setRemoteObjectFreer(ret, contextId, meta.id)</span><br><span class="line">    v8Util.setHiddenValue(ret, <span class="string">'atomId'</span>, meta.id)</span><br><span class="line">    <span class="comment">// ğŸ”´ æ·»åŠ å¯¹è±¡å¼•ç”¨è®¡æ•°</span></span><br><span class="line">    v8Util.addRemoteObjectRef(contextId, meta.id)</span><br><span class="line">    remoteObjectCache.set(meta.id, ret)</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>ç®€å•äº†è§£ä¸€ä¸‹ObjectFreerä»£ç :</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// atom/common/api/remote_object_freer.cc</span></span><br><span class="line"><span class="comment">// æ·»åŠ å¼•ç”¨è®¡æ•°</span></span><br><span class="line"><span class="keyword">void</span> RemoteObjectFreer::AddRef(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; context_id, <span class="keyword">int</span> object_id) &#123;</span><br><span class="line">  ref_mapper_[context_id][object_id]++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯¹è±¡é‡Šæ”¾äº‹ä»¶å¤„ç†å™¨</span></span><br><span class="line"><span class="keyword">void</span> RemoteObjectFreer::RunDestructor() &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">auto</span>* channel = <span class="string">"ELECTRON_BROWSER_DEREFERENCE"</span>;</span><br><span class="line">  base::ListValue args;</span><br><span class="line">  args.AppendString(context_id_);</span><br><span class="line">  args.AppendInteger(object_id_);</span><br><span class="line">  args.AppendInteger(ref_mapper_[context_id_][object_id_]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ğŸ”´ æ¸…ç©ºå¼•ç”¨è¡¨</span></span><br><span class="line">  ref_mapper_[context_id_].erase(object_id_);</span><br><span class="line">  <span class="keyword">if</span> (ref_mapper_[context_id_].empty())</span><br><span class="line">    ref_mapper_.erase(context_id_);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ğŸ”´ ipcé€šçŸ¥ä¸»è¿›ç¨‹</span></span><br><span class="line">  electron_ptr-&gt;Message(<span class="literal">true</span>, channel, args.Clone());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>å†å›åˆ°ä¸»è¿›ç¨‹, ä¸»è¿›ç¨‹ç›‘å¬<code>ELECTRON_BROWSER_DEREFERENCE</code>äº‹ä»¶ï¼Œå¹¶é€’å‡æŒ‡å®šå¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">handleRemoteCommand(<span class="string">'ELECTRON_BROWSER_DEREFERENCE'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">event, contextId, id, rendererSideRefCount</span>) </span>&#123;</span><br><span class="line">  objectsRegistry.remove(event.sender, contextId, id, rendererSideRefCount)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><br></p><p>å¦‚æœè¢«ä¸Šé¢çš„ä»£ç ç»•å¾—ä¼˜ç‚¹æ™•ï¼Œé‚£å°±çœ‹çœ‹ä¸‹é¢çš„æµç¨‹å›¾, æ¶ˆåŒ–æ¶ˆåŒ–ï¼š</p><p><img src="/images/electron-remote/lifetime.png" alt></p><p><br><br><br></p><h2 id="æ¸²æŸ“è¿›ç¨‹æ€ä¹ˆç»™ä¸»è¿›ç¨‹ä¼ é€’å›è°ƒ"><a href="#æ¸²æŸ“è¿›ç¨‹æ€ä¹ˆç»™ä¸»è¿›ç¨‹ä¼ é€’å›è°ƒ" class="headerlink" title="æ¸²æŸ“è¿›ç¨‹æ€ä¹ˆç»™ä¸»è¿›ç¨‹ä¼ é€’å›è°ƒ"></a>æ¸²æŸ“è¿›ç¨‹æ€ä¹ˆç»™ä¸»è¿›ç¨‹ä¼ é€’å›è°ƒ</h2><p>åœ¨æ¸²æŸ“è¿›ç¨‹ä¸­ï¼Œé€šè¿‡remoteè¿˜å¯ä»¥ç»™ä¸»è¿›ç¨‹çš„å‡½æ•°ä¼ é€’å›è°ƒã€‚å…¶å®è·Ÿä¸»è¿›ç¨‹æš´éœ²å‡½æ•°/å¯¹è±¡ç»™æ¸²æŸ“è¿›ç¨‹çš„åŸç†ä¸€æ ·ï¼Œæ¸²æŸ“è¿›ç¨‹åœ¨å°†å›è°ƒä¼ é€’ç»™ä¸»è¿›ç¨‹ä¹‹å‰ä¼šæ”¾ç½®åˆ°<strong>å›è°ƒæ³¨å†Œè¡¨</strong>ä¸­ï¼Œç„¶åç»™ä¸»è¿›ç¨‹æš´éœ²ä¸€ä¸ªcallbackIDã€‚</p><p>æ¸²æŸ“è¿›ç¨‹ä¼šè°ƒç”¨<code>wrapArgs</code>å°†å‡½æ•°è°ƒç”¨å‚æ•°åºåˆ—åŒ–ä¸ºMetaData:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wrapArgs</span> (<span class="params">args, visited = new Set(</span>)) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> valueToMeta = <span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// ğŸ”´ é˜²æ­¢å¾ªç¯å¼•ç”¨</span></span><br><span class="line">    <span class="keyword">if</span> (visited.has(value)) &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        type: <span class="string">'value'</span>,</span><br><span class="line">        value: <span class="literal">null</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... çœç•¥å…¶ä»–ç±»å‹çš„å¤„ç†ï¼Œè¿™äº›ç±»å‹åŸºæœ¬éƒ½æ˜¯å€¼æ‹·è´</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">'function'</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        type: <span class="string">'function'</span>,</span><br><span class="line">        <span class="comment">// ğŸ”´ ç»™ä¸»è¿›ç¨‹ä¼ é€’callbackIdï¼Œå¹¶æ·»åŠ åˆ°å›è°ƒæ³¨å†Œè¡¨ä¸­</span></span><br><span class="line">        id: callbacksRegistry.add(value),</span><br><span class="line">        location: v8Util.getHiddenValue(value, <span class="string">'location'</span>),</span><br><span class="line">        length: value.length</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>å›åˆ°ä¸»è¿›ç¨‹ï¼Œè¿™é‡Œä¹Ÿæœ‰ä¸€ä¸ªå¯¹åº”çš„<code>unwrapArgs</code>å‡½æ•°æ¥ååºåˆ—åŒ–å‡½æ•°å‚æ•°ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> unwrapArgs = <span class="function"><span class="keyword">function</span> (<span class="params">sender, frameId, contextId, args</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> metaToValue = <span class="function"><span class="keyword">function</span> (<span class="params">meta</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (meta.type) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'value'</span>:</span><br><span class="line">        <span class="keyword">return</span> meta.value</span><br><span class="line">      <span class="comment">// ... çœç•¥</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">'function'</span>: &#123;</span><br><span class="line">        <span class="keyword">const</span> objectId = [contextId, meta.id]</span><br><span class="line">        <span class="comment">// å›è°ƒç¼“å­˜</span></span><br><span class="line">        <span class="keyword">if</span> (rendererFunctions.has(objectId)) &#123;</span><br><span class="line">          <span class="keyword">return</span> rendererFunctions.get(objectId)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ğŸ”´ å°è£…å½±å­å‡½æ•°</span></span><br><span class="line">        <span class="keyword">const</span> callIntoRenderer = <span class="function"><span class="keyword">function</span> (<span class="params">...args</span>) </span>&#123;</span><br><span class="line">          <span class="keyword">let</span> succeed = <span class="literal">false</span></span><br><span class="line">          <span class="keyword">if</span> (!sender.isDestroyed()) &#123;</span><br><span class="line">            <span class="comment">// ğŸ”´ è°ƒç”¨æ—¶ï¼Œé€šè¿‡IPCé€šçŸ¥æ¸²æŸ“è¿›ç¨‹</span></span><br><span class="line">            <span class="comment">// å¿½ç•¥å›è°ƒè¿”å›å€¼</span></span><br><span class="line">            succeed = sender._sendToFrameInternal(frameId, <span class="string">'ELECTRON_RENDERER_CALLBACK'</span>, contextId, meta.id, valueToMeta(sender, contextId, args))</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (!succeed) &#123;</span><br><span class="line">            <span class="comment">// æ²¡æœ‰å‘é€æˆåŠŸåˆ™è¡¨æ˜æ¸²æŸ“è¿›ç¨‹çš„å›è°ƒå¯èƒ½è¢«é‡Šæ”¾äº†ï¼Œè¾“å‡ºè­¦å‘Šä¿¡æ¯</span></span><br><span class="line">            <span class="comment">// è¿™ç§æƒ…å†µæ¯”è¾ƒå¸¸è§ï¼Œæ¯”å¦‚è¢«æ¸²æŸ“è¿›ç¨‹åˆ·æ–°äº†</span></span><br><span class="line">            removeRemoteListenersAndLogWarning(<span class="keyword">this</span>, callIntoRenderer)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        v8Util.setHiddenValue(callIntoRenderer, <span class="string">'location'</span>, meta.location)</span><br><span class="line">        <span class="built_in">Object</span>.defineProperty(callIntoRenderer, <span class="string">'length'</span>, &#123; <span class="attr">value</span>: meta.length &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ğŸ”´ ç›‘å¬å›è°ƒå‡½æ•°åƒåœ¾å›æ”¶äº‹ä»¶</span></span><br><span class="line">        v8Util.setRemoteCallbackFreer(callIntoRenderer, contextId, meta.id, sender)</span><br><span class="line">        rendererFunctions.set(objectId, callIntoRenderer)</span><br><span class="line">        <span class="keyword">return</span> callIntoRenderer</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">`Unknown type: <span class="subst">$&#123;meta.type&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> args.map(metaToValue)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¸²æŸ“è¿›ç¨‹å“åº”å°±æ¯”è¾ƒç®€å•äº†ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">handleMessage(<span class="string">'ELECTRON_RENDERER_CALLBACK'</span>, (id, args) =&gt; &#123;</span><br><span class="line">  callbacksRegistry.apply(id, metaToValue(args))</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><br></p><p>é‚£å›è°ƒä»€ä¹ˆæ—¶å€™é‡Šæ”¾å‘¢ï¼Ÿè¿™ä¸ªç›¸æ¯”æ¸²æŸ“è¿›ç¨‹çš„å¯¹è±¡å¼•ç”¨è¦ç®€å•å¾ˆå¤šï¼Œå› ä¸ºä¸»è¿›ç¨‹åªæœ‰ä¸€ä¸ªã€‚é€šè¿‡ä¸Šé¢çš„ä»£ç å¯ä»¥çŸ¥é“, <code>setRemoteCallbackFreer</code>ä¼šç›‘å¬å½±å­å›è°ƒæ˜¯å¦è¢«åƒåœ¾å›æ”¶ï¼Œä¸€æ—¦è¢«åƒåœ¾å›æ”¶äº†åˆ™é€šçŸ¥æ¸²æŸ“è¿›ç¨‹:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ¸²æŸ“è¿›ç¨‹</span></span><br><span class="line">handleMessage(<span class="string">'ELECTRON_RENDERER_RELEASE_CALLBACK'</span>, (id) =&gt; &#123;</span><br><span class="line">  callbacksRegistry.remove(id)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><br></p><p>æŒ‰ç…§æƒ¯ä¾‹ï¼Œæ¥ä¸ªæµç¨‹å›¾:</p><p><img src="/images/electron-remote/callback.png" alt></p><p><br><br><br></p><h2 id="ä¸€äº›ç¼ºé™·"><a href="#ä¸€äº›ç¼ºé™·" class="headerlink" title="ä¸€äº›ç¼ºé™·"></a>ä¸€äº›ç¼ºé™·</h2><p>remoteæœºåˆ¶åªæ˜¯å¯¹è¿œç¨‹å¯¹è±¡çš„ä¸€ä¸ªâ€˜å½±åˆ†èº«â€™ï¼Œæ— æ³•ç™¾åˆ†ç™¾å’Œè¿œç¨‹å¯¹è±¡çš„è¡Œä¸ºä¿æŒä¸€è‡´ï¼Œä¸‹é¢æ˜¯ä¸€äº›æ¯”è¾ƒå¸¸è§çš„ç¼ºé™·:</p><ul><li>å½“æ¸²æŸ“è¿›ç¨‹è°ƒç”¨è¿œç¨‹å¯¹è±¡çš„æ–¹æ³•/å‡½æ•°æ—¶ï¼Œæ˜¯è¿›è¡ŒåŒæ­¥IPCé€šä¿¡çš„ã€‚æ¢è¨€ä¹‹ï¼ŒåŒæ­¥IPCè°ƒç”¨ä¼šé˜»å¡ç”¨æˆ·ä»£ç çš„æ‰§è¡Œï¼Œè€Œä¸”è·¨ç«¯çš„é€šä¿¡æ•ˆç‡æ— æ³•å’ŒåŸç”Ÿå‡½æ•°è°ƒç”¨ç›¸æ¯”ï¼Œæ‰€ä»¥é¢‘ç¹çš„IPCè°ƒç”¨ä¼šå½±å“ä¸»è¿›ç¨‹å’Œæ¸²æŸ“è¿›ç¨‹çš„æ€§èƒ½.</li><li>ä¸»è¿›ç¨‹ä¼šä¿æŒå¼•ç”¨æ¯ä¸€ä¸ªæ¸²æŸ“è¿›ç¨‹è®¿é—®çš„å¯¹è±¡ï¼ŒåŒ…æ‹¬å‡½æ•°çš„è¿”å›å€¼ã€‚åŒç†ï¼Œé¢‘ç¹çš„è¿œç¨‹å¯¹è±¡è¯·æ±‚ï¼Œå¯¹å†…å­˜çš„å ç”¨å’Œåƒåœ¾å›æ”¶é€ æˆä¸å°çš„å‹åŠ›</li><li>æ— æ³•å®Œå…¨æ¨¡æ‹ŸJavaScriptå¯¹è±¡çš„è¡Œä¸ºã€‚æ¯”å¦‚åœ¨remoteæ¨¡å—ä¸­å­˜åœ¨è¿™äº›é—®é¢˜:<ul><li>æ•°ç»„å±äºâ€™åŸºæœ¬å¯¹è±¡â€™ï¼Œå®ƒæ˜¯é€šè¿‡å€¼æ‹·è´ä¼ é€’ç»™å¯¹ç«¯çš„ã€‚ä¹Ÿå°±æ˜¯è¯´å®ƒä¸æ˜¯ä¸€ä¸ªâ€˜å¼•ç”¨å¯¹è±¡â€™ï¼Œåœ¨å¯¹ç«¯ä¿®æ”¹å®ƒä»¬æ—¶ï¼Œæ— æ³•ååº”åˆ°åŸå§‹çš„æ•°ç»„.</li><li>å¯¹è±¡åœ¨ç¬¬ä¸€æ¬¡å¼•ç”¨æ—¶ï¼Œåªæœ‰å¯æšä¸¾çš„å±æ€§å¯ä»¥è¿œç¨‹è®¿é—®ã€‚è¿™ä¹Ÿæ„å‘³ç€ï¼Œä¸€å¼€å§‹å¯¹è±¡çš„å¤–å½¢å°±ç¡®å®šä¸‹æ¥äº†ï¼Œå¦‚æœè¿œç¨‹å¯¹è±¡åŠ¨æ€æ‰©å±•äº†å±æ€§ï¼Œæ˜¯æ— æ³•è¢«è¿œç¨‹è®¿é—®åˆ°çš„</li><li>æ¸²æŸ“è¿›ç¨‹ä¼ é€’çš„å›è°ƒä¼šè¢«å¼‚æ­¥è°ƒç”¨ï¼Œè€Œä¸”ä¸»è¿›ç¨‹ä¼šå¿½ç•¥å®ƒçš„è¿”å›å€¼ã€‚å¼‚æ­¥è°ƒç”¨æ˜¯ä¸ºäº†é¿å…äº§ç”Ÿæ­»é”</li></ul></li><li>å¯¹è±¡æ³„éœ²ã€‚<ul><li>å¦‚æœè¿œç¨‹å¯¹è±¡åœ¨æ¸²æŸ“è¿›ç¨‹ä¸­æ³„éœ²ï¼ˆä¾‹å¦‚å­˜å‚¨åœ¨æ˜ å°„ä¸­ï¼Œä½†ä»æœªé‡Šæ”¾ï¼‰ï¼Œåˆ™ä¸»è¿›ç¨‹ä¸­çš„ç›¸åº”å¯¹è±¡ä¹Ÿå°†è¢«æ³„æ¼ï¼Œæ‰€ä»¥æ‚¨åº”è¯¥éå¸¸å°å¿ƒï¼Œä¸è¦æ³„æ¼è¿œç¨‹å¯¹è±¡ã€‚</li><li>åœ¨ç»™ä¸»è¿›ç¨‹ä¼ é€’å›è°ƒæ—¶ä¹Ÿè¦ç‰¹åˆ«å°å¿ƒï¼Œä¸»è¿›ç¨‹ä¼šä¿æŒå›è°ƒçš„å¼•ç”¨ï¼Œç›´åˆ°å®ƒè¢«é‡Šæ”¾ã€‚æ‰€ä»¥åœ¨ä½¿ç”¨remoteæ¨¡å—è¿›è¡Œä¸€äº›â€˜äº‹ä»¶è®¢é˜…â€™æ—¶ï¼Œåˆ‡è®°è¦è§£é™¤äº‹ä»¶è®¢é˜….</li><li>è¿˜æœ‰ä¸€ç§åœºæ™¯ï¼Œä¸‹æ–‡ä¼šæåˆ°</li></ul></li></ul><p><br><br><br></p><h2 id="remoteæ¨¡å—å®è·µå’Œä¼˜åŒ–"><a href="#remoteæ¨¡å—å®è·µå’Œä¼˜åŒ–" class="headerlink" title="remoteæ¨¡å—å®è·µå’Œä¼˜åŒ–"></a>remoteæ¨¡å—å®è·µå’Œä¼˜åŒ–</h2><p><img src="/images/electron-remote/gzb.png" alt></p><p>ä¸Šé¢æ˜¯æˆ‘å‚ä¸è¿‡çš„æŸä¸ªé¡¹ç›®çš„è½¯ä»¶æ¶æ„å›¾ï¼Œ<code>Hybrid</code>å±‚ä½¿ç”¨C/C++ç¼–å†™ï¼Œå°è£…äº†è·¨å¹³å°çš„æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼Œåœ¨æ­¤ä¹‹ä¸Šæ¥æ„å»ºå„ä¸ªå¹³å°çš„è§†å›¾ã€‚å…¶ä¸­æ¡Œé¢ç«¯æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ElectronæŠ€æœ¯ã€‚</p><p>å¦‚ä¸Šå›¾ï¼ŒBridgeè¿›æ˜¯å¯¹Hybridçš„ä¸€å±‚Nodeæ¡¥æ¥å°è£…ã€‚ä¸€ä¸ªåº”ç”¨ä¸­åªèƒ½æœ‰ä¸€ä¸ªBridgeå®ä¾‹ï¼Œå› æ­¤æˆ‘ä»¬çš„åšæ³•æ˜¯ä½¿ç”¨Electronçš„remoteæ¨¡å—ï¼Œè®©æ¸²æŸ“è¿›ç¨‹é€šè¿‡ä¸»è¿›ç¨‹é—´æ¥åœ°è®¿é—®Bridge.</p><p><br></p><p>é¡µé¢éœ€è¦ç›‘å¬Bridgeçš„ä¸€äº›äº‹ä»¶ï¼Œæœ€åˆæˆ‘ä»¬çš„ä»£ç æ˜¯è¿™æ ·çš„:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// bridge.ts</span></span><br><span class="line"><span class="comment">// ä½¿ç”¨remoteçš„ä¸€ä¸ªå¥½å¤„æ—¶ï¼Œå¯ä»¥é…åˆTypescriptå®ç°è¾ƒå¥½çš„ç±»å‹æ£€æŸ¥</span></span><br><span class="line"><span class="keyword">const</span> bridge = electron.remote.require(<span class="string">'bridge'</span>) <span class="keyword">as</span> <span class="keyword">typeof</span> <span class="keyword">import</span>(<span class="string">'bridge'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> bridge</span><br></pre></td></tr></table></figure><p>ç›‘å¬Bridgeäº‹ä»¶:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> bridge <span class="keyword">from</span> <span class="string">'~/bridge'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> Store <span class="keyword">extends</span> MobxStore &#123;</span><br><span class="line">  <span class="comment">// åˆå§‹åŒ–</span></span><br><span class="line">  pageReady() &#123;</span><br><span class="line">    <span class="keyword">this</span>.someEventDispose = bridge.addListener(<span class="string">'someEvent'</span>, <span class="keyword">this</span>.handleSomeEvent)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é¡µé¢å…³é—­</span></span><br><span class="line">  pageWillClose() &#123;</span><br><span class="line">    <span class="keyword">this</span>.someEventDispose()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµç¨‹å›¾å¦‚ä¸‹:</p><p><img src="/images/electron-remote/addListener.png" alt></p><p>è¿™ç§æ–¹å¼å­˜åœ¨å¾ˆå¤šé—®é¢˜:</p><ul><li><p>ä¸»è¿›ç¨‹éœ€è¦ä¸ºæ¯ä¸€ä¸ªaddListenerå›è°ƒéƒ½ç»´æŒä¸€ä¸ªå¼•ç”¨ã€‚ä¸Šé¢çš„ä»£ç ä¼šåœ¨é¡µé¢å…³é—­æ—¶é‡Šæ”¾è®¢é˜…ï¼Œä½†æ˜¯å®ƒæ²¡æœ‰è€ƒè™‘ç”¨æˆ·åˆ·æ–°é¡µé¢æˆ–è€…é¡µé¢å´©æºƒçš„åœºæ™¯ã€‚è¿™ä¼šå¯¼è‡´å›è°ƒåœ¨ä¸»è¿›ç¨‹æ³„éœ²ã€‚</p><p>ç„¶è€Œå°±ç®—Electronå¯ä»¥åœ¨è°ƒç”¨å›è°ƒæ—¶å‘ç°å›è°ƒåœ¨æ¸²æŸ“è¿›ç¨‹å·²ç»è¢«é‡Šæ”¾æ‰äº†ï¼Œä½†æ˜¯å¼€å‘è€…å´è·å–ä¸åˆ°è¿™äº›ä¿¡æ¯ï¼Œ Bridgeä¼šå§‹ç»ˆä¿æŒå¯¹å½±å­å›è°ƒçš„å¼•ç”¨.</p></li><li><p>å¦å¤–ä¸€ä¸ªæ¯”è¾ƒæ˜æ˜¾çš„æ˜¯è°ƒç”¨æ•ˆç‡çš„é—®é¢˜ã€‚å‡è®¾é¡µé¢ç›‘å¬äº†Næ¬¡Aäº‹ä»¶ï¼Œå½“Aäº‹ä»¶è§¦å‘æ—¶ï¼Œä¸»è¿›ç¨‹éœ€è¦ç»™è¿™ä¸ªé¡µé¢å‘é€Nä¸ªé€šçŸ¥ã€‚</p></li></ul><p><br></p><p>åæ¥æˆ‘ä»¬æŠ›å¼ƒäº†ä½¿ç”¨remoteè¿›è¡Œäº‹ä»¶è®¢é˜…è¿™ç§æ–¹å¼ï¼Œè®©ä¸»è¿›ç¨‹æ¥ç»´æŠ¤è¿™ç§è®¢é˜…å…³ç³», å¦‚ä¸‹å›¾:</p><p><img src="/images/electron-remote/addListener2.png" alt></p><p>æˆ‘ä»¬æ”¹è¿›äº†å¾ˆå¤šä¸œè¥¿ï¼š</p><p><strong>ä¸»è¿›ç¨‹ç°åœ¨åªç»´æŠ¤â€˜å“ªä¸ªé¡µé¢â€™è®¢é˜…äº†å“ªä¸ªäº‹ä»¶ï¼Œä»â€˜ç»‘å®šå›è°ƒâ€™è¿›åŒ–æˆä¸ºâ€˜ç»‘å®šé¡µé¢â€™</strong>ã€‚è¿™æ ·å¯ä»¥è§£å†³ä¸Šé¢è°ƒç”¨æ•ˆç‡å’Œå›è°ƒæ³„éœ²é—®é¢˜ã€æ¯”å¦‚ä¸ä¼šå› ä¸ºé¡µé¢åˆ·æ–°å¯¼è‡´å›è°ƒæ³„éœ², å¹¶ä¸”å½“äº‹ä»¶è§¦å‘æ—¶åªä¼šé€šçŸ¥ä¸€æ¬¡é¡µé¢ã€‚</p><p>å¦å¤–è¿™é‡Œå‚è€ƒäº†remoteæœ¬èº«çš„å®ç°ï¼Œåœ¨é¡µé¢é”€æ¯æ—¶ç§»é™¤è¯¥é¡µé¢çš„æ‰€æœ‰è®¢é˜…ã€‚ç›¸æ¯”æ¯”remoteé»‘ç›’ï¼Œæˆ‘ä»¬è‡ªå·±æ¥å®ç°è¿™ç§äº‹ä»¶è®¢é˜…å…³ç³»æ¯”ä¹‹å‰è¦æ›´å¥½è°ƒè¯•ã€‚</p><p><br><br><br></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>remoteæ¨¡å—å¯¹äºElectronå¼€å‘æœ‰å¾ˆé‡è¦çš„æ„ä¹‰ï¼Œæ¯•ç«Ÿå¾ˆå¤šæ¨¡å—åªæœ‰åœ¨ä¸»è¿›ç¨‹æ‰èƒ½è®¿é—®ï¼Œæ¯”å¦‚BrowserWindowã€dialog. </p><p>ç›¸æ¯”ipcé€šä¿¡ï¼Œremoteå®åœ¨æ–¹é¢å¾ˆå¤šã€‚é€šè¿‡ä¸Šæ–‡æˆ‘ä»¬ä¹Ÿäº†è§£äº†å®ƒçš„åŸºæœ¬åŸç†å’Œç¼ºé™·ï¼Œæ‰€ä»¥remoteè™½å¥½ï¼Œåˆ‡å¿Œä¸è¦æ»¥ç”¨ã€‚</p><p>remoteçš„æºç ä¹Ÿå¾ˆå®¹æ˜“ç†è§£ï¼Œå€¼å¾—å­¦ä¹ . æ¯•ç«Ÿå‰ç«¯ç›®å‰è·¨ç«¯é€šä¿¡éå¸¸å¸¸è§ï¼Œä¾‹å¦‚WebViewBridgeã€Worker. </p><p>remoteå¯ä»¥ç»™ä½ ä¸€äº›çµæ„Ÿï¼Œä½†æ˜¯è¦å®Œå…¨ç…§æ¬å®ƒæ˜¯ä¸å¯è¡Œçš„ï¼Œå› ä¸ºæ¯”å¦‚å®ƒä¾èµ–ä¸€äº›v8 â€˜Hackâ€™æ¥ç›‘å¬å¯¹è±¡çš„åƒåœ¾å›æ”¶ï¼Œæ™®é€šå¼€å‘åœºæ™¯æ˜¯åšä¸åˆ°çš„ã€‚</p><p>æœ¬æ–‡å®Œ.</p><p><br><br><br></p><h2 id="æ‰©å±•"><a href="#æ‰©å±•" class="headerlink" title="æ‰©å±•"></a>æ‰©å±•</h2><ul><li><a href="https://electronjs.org/docs/api/remote" target="_blank" rel="noopener">Electron remote æ–‡æ¡£</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Electronçš„remoteæ¨¡å—æ˜¯ä¸€ä¸ªæ¯”è¾ƒç¥å¥‡çš„ä¸œè¥¿ï¼Œä¸º&lt;code&gt;æ¸²æŸ“è¿›ç¨‹&lt;/code&gt;å’Œ&lt;code&gt;ä¸»è¿›ç¨‹&lt;/code&gt;é€šä¿¡å°è£…äº†ä¸€ç§ç®€å•æ–¹æ³•ï¼Œé€šè¿‡remoteä½ å¯ä»¥â€™ç›´æ¥â€™è·å–ä¸»è¿›ç¨‹å¯¹è±¡æˆ–è€…è°ƒç”¨ä¸»è¿›ç¨‹å‡½æ•°æˆ–å¯¹è±¡çš„æ–¹æ³•, è€Œä¸å¿…æ˜¾å¼å‘é€è¿›ç¨‹é—´æ¶ˆæ¯, ç±»ä¼¼äº Java 
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://bobi.ink/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>è°ˆè°ˆReactäº‹ä»¶æœºåˆ¶å’Œæœªæ¥(react-events)</title>
    <link href="https://bobi.ink/2019/07/29/react-event/"/>
    <id>https://bobi.ink/2019/07/29/react-event/</id>
    <published>2019-07-28T16:00:00.000Z</published>
    <updated>2019-08-04T08:19:59.764Z</updated>
    
    <content type="html"><![CDATA[<p><img src="/images/react-event/sample.png" alt></p><p>å½“æˆ‘ä»¬åœ¨ç»„ä»¶ä¸Šè®¾ç½®äº‹ä»¶å¤„ç†å™¨æ—¶ï¼ŒReactå¹¶ä¸ä¼šåœ¨è¯¥DOMå…ƒç´ ä¸Šç›´æ¥ç»‘å®šäº‹ä»¶å¤„ç†å™¨. Reactå†…éƒ¨è‡ªå®šä¹‰äº†ä¸€å¥—äº‹ä»¶ç³»ç»Ÿï¼Œåœ¨è¿™ä¸ªç³»ç»Ÿä¸Šç»Ÿä¸€è¿›è¡Œäº‹ä»¶è®¢é˜…å’Œåˆ†å‘. </p><p>å…·ä½“æ¥è®²ï¼ŒReactåˆ©ç”¨äº‹ä»¶å§”æ‰˜æœºåˆ¶åœ¨Documentä¸Šç»Ÿä¸€ç›‘å¬DOMäº‹ä»¶ï¼Œå†æ ¹æ®è§¦å‘çš„targetå°†äº‹ä»¶åˆ†å‘åˆ°å…·ä½“çš„ç»„ä»¶å®ä¾‹ã€‚å¦å¤–ä¸Šé¢eæ˜¯ä¸€ä¸ªåˆæˆäº‹ä»¶å¯¹è±¡(SyntheticEvent), è€Œä¸æ˜¯åŸå§‹çš„DOMäº‹ä»¶å¯¹è±¡.</p><p><br></p><p><strong>æ–‡ç« å¤§çº²</strong></p><!-- TOC --><ul><li><a href="#é‚£ä¸ºä»€ä¹ˆè¦è‡ªå®šä¹‰ä¸€å¥—äº‹ä»¶ç³»ç»Ÿ">é‚£ä¸ºä»€ä¹ˆè¦è‡ªå®šä¹‰ä¸€å¥—äº‹ä»¶ç³»ç»Ÿ?</a></li><li><a href="#åŸºæœ¬æ¦‚å¿µ">åŸºæœ¬æ¦‚å¿µ</a><ul><li><a href="#æ•´ä½“çš„æ¶æ„">æ•´ä½“çš„æ¶æ„</a></li><li><a href="#äº‹ä»¶åˆ†ç±»ä¸ä¼˜å…ˆçº§">äº‹ä»¶åˆ†ç±»ä¸ä¼˜å…ˆçº§</a></li></ul></li><li><a href="#å®ç°ç»†èŠ‚">å®ç°ç»†èŠ‚</a><ul><li><a href="#äº‹ä»¶æ˜¯å¦‚ä½•ç»‘å®šçš„">äº‹ä»¶æ˜¯å¦‚ä½•ç»‘å®šçš„ï¼Ÿ</a></li><li><a href="#äº‹ä»¶æ˜¯å¦‚ä½•åˆ†å‘çš„">äº‹ä»¶æ˜¯å¦‚ä½•åˆ†å‘çš„ï¼Ÿ</a><ul><li><a href="#äº‹ä»¶è§¦å‘è°ƒåº¦">äº‹ä»¶è§¦å‘è°ƒåº¦</a></li><li><a href="#æ’ä»¶æ˜¯å¦‚ä½•å¤„ç†äº‹ä»¶">æ’ä»¶æ˜¯å¦‚ä½•å¤„ç†äº‹ä»¶?</a></li><li><a href="#æ‰¹é‡æ‰§è¡Œ">æ‰¹é‡æ‰§è¡Œ</a></li></ul></li></ul></li><li><a href="#æœªæ¥">æœªæ¥</a><ul><li><a href="#åˆæ¢responderçš„åˆ›å»º">åˆæ¢Responderçš„åˆ›å»º</a></li><li><a href="#react-eventsæ„ä¹‰ä½•åœ¨">react-eventsæ„ä¹‰ä½•åœ¨?</a></li></ul></li><li><a href="#æ‰©å±•é˜…è¯»">æ‰©å±•é˜…è¯»</a></li></ul><!-- /TOC --><blockquote><p>æˆªæ­¢æœ¬æ–‡å†™ä½œæ—¶ï¼ŒReactç‰ˆæœ¬æ˜¯16.8.6</p></blockquote><p><br></p><h2 id="é‚£ä¸ºä»€ä¹ˆè¦è‡ªå®šä¹‰ä¸€å¥—äº‹ä»¶ç³»ç»Ÿ"><a href="#é‚£ä¸ºä»€ä¹ˆè¦è‡ªå®šä¹‰ä¸€å¥—äº‹ä»¶ç³»ç»Ÿ" class="headerlink" title="é‚£ä¸ºä»€ä¹ˆè¦è‡ªå®šä¹‰ä¸€å¥—äº‹ä»¶ç³»ç»Ÿ?"></a>é‚£ä¸ºä»€ä¹ˆè¦è‡ªå®šä¹‰ä¸€å¥—äº‹ä»¶ç³»ç»Ÿ?</h2><p>å¦‚æœäº†è§£è¿‡Preact(ç¬”è€…ä¹‹å‰å†™è¿‡ä¸€ç¯‡æ–‡ç« <a href="https://juejin.im/post/5cfa29e151882539c33e4f5e" target="_blank" rel="noopener">è§£æPreactçš„æºç </a>)ï¼ŒPreactè£å‰ªäº†å¾ˆå¤šReactçš„ä¸œè¥¿ï¼Œå…¶ä¸­åŒ…æ‹¬äº‹ä»¶æœºåˆ¶ï¼ŒPreactæ˜¯ç›´æ¥åœ¨DOMå…ƒç´ ä¸Šè¿›è¡Œäº‹ä»¶ç»‘å®šçš„ã€‚</p><p>åœ¨ç ”ç©¶ä¸€ä¸ªäº‹ç‰©ä¹‹å‰ï¼Œæˆ‘é¦–å…ˆè¦é—®ä¸ºä»€ä¹ˆï¼Ÿäº†è§£å®ƒçš„åŠ¨æœºï¼Œæ‰æœ‰åˆ©äºä½ å¯¹å®ƒæœ‰æœ¬è´¨çš„è®¤è¯†ã€‚</p><p>Reactè‡ªå®šä¹‰ä¸€å¥—äº‹ä»¶ç³»ç»Ÿçš„åŠ¨æœºæœ‰ä»¥ä¸‹å‡ ä¸ª:</p><ul><li><p><strong>1. æŠ¹å¹³æµè§ˆå™¨ä¹‹é—´çš„å…¼å®¹æ€§å·®å¼‚</strong>ã€‚ è¿™æ˜¯ä¼°è®¡æœ€åŸå§‹çš„åŠ¨æœºï¼ŒReactæ ¹æ®<a href="https://www.w3.org/TR/DOM-Level-3-Events/" target="_blank" rel="noopener">W3C è§„èŒƒ</a>æ¥å®šä¹‰è¿™äº›åˆæˆäº‹ä»¶(SyntheticEvent), æ„åœ¨æŠ¹å¹³æµè§ˆå™¨ä¹‹é—´çš„å·®å¼‚ã€‚</p><p>å¦å¤–Reactè¿˜ä¼šè¯•å›¾é€šè¿‡å…¶ä»–ç›¸å…³äº‹ä»¶æ¥æ¨¡æ‹Ÿä¸€äº›ä½ç‰ˆæœ¬ä¸å…¼å®¹çš„äº‹ä»¶, è¿™æ‰æ˜¯â€˜åˆæˆâ€™çš„æœ¬æ¥æ„æ€å§ï¼Ÿã€‚</p></li><li><p><strong>2. äº‹ä»¶â€˜åˆæˆâ€™, å³äº‹ä»¶è‡ªå®šä¹‰</strong>ã€‚äº‹ä»¶åˆæˆé™¤äº†å¤„ç†å…¼å®¹æ€§é—®é¢˜ï¼Œè¿˜å¯ä»¥ç”¨æ¥è‡ªå®šä¹‰é«˜çº§äº‹ä»¶ï¼Œæ¯”è¾ƒå…¸å‹çš„æ˜¯Reactçš„onChangeäº‹ä»¶ï¼Œå®ƒä¸ºè¡¨å•å…ƒç´ å®šä¹‰äº†ç»Ÿä¸€çš„å€¼å˜åŠ¨äº‹ä»¶ã€‚å¦å¤–ç¬¬ä¸‰æ–¹ä¹Ÿå¯ä»¥é€šè¿‡Reactçš„äº‹ä»¶æ’ä»¶æœºåˆ¶æ¥åˆæˆè‡ªå®šä¹‰äº‹ä»¶ï¼Œå°½ç®¡å¾ˆå°‘äººè¿™ä¹ˆåšã€‚</p></li><li><p><strong>3. æŠ½è±¡è·¨å¹³å°äº‹ä»¶æœºåˆ¶</strong>ã€‚ å’ŒVirtualDOMçš„æ„ä¹‰å·®ä¸å¤šï¼ŒVirtualDOMæŠ½è±¡äº†è·¨å¹³å°çš„æ¸²æŸ“æ–¹å¼ï¼Œé‚£ä¹ˆå¯¹åº”çš„SyntheticEventç›®çš„ä¹Ÿæ˜¯æƒ³æä¾›ä¸€ä¸ªæŠ½è±¡çš„è·¨å¹³å°äº‹ä»¶æœºåˆ¶ã€‚</p></li><li><p><strong>4. Reactæ‰“ç®—åšæ›´å¤šä¼˜åŒ–</strong>ã€‚æ¯”å¦‚åˆ©ç”¨äº‹ä»¶å§”æ‰˜æœºåˆ¶ï¼Œå¤§éƒ¨åˆ†äº‹ä»¶æœ€ç»ˆç»‘å®šåˆ°äº†Documentï¼Œè€Œä¸æ˜¯DOMèŠ‚ç‚¹æœ¬èº«. è¿™æ ·ç®€åŒ–äº†DOMäº‹ä»¶å¤„ç†é€»è¾‘ï¼Œå‡å°‘äº†å†…å­˜å¼€é”€. ä½†è¿™ä¹Ÿæ„å‘³ç€ï¼Œ<strong>Reactéœ€è¦è‡ªå·±æ¨¡æ‹Ÿä¸€å¥—äº‹ä»¶å†’æ³¡çš„æœºåˆ¶</strong>ã€‚</p></li><li><p><strong>5. Reactæ‰“ç®—å¹²é¢„äº‹ä»¶çš„åˆ†å‘</strong>ã€‚v16å¼•å…¥Fiberæ¶æ„ï¼ŒReactä¸ºäº†ä¼˜åŒ–ç”¨æˆ·çš„äº¤äº’ä½“éªŒï¼Œä¼šå¹²é¢„äº‹ä»¶çš„åˆ†å‘ã€‚ä¸åŒç±»å‹çš„äº‹ä»¶æœ‰ä¸åŒçš„ä¼˜å…ˆçº§ï¼Œæ¯”å¦‚é«˜ä¼˜å…ˆçº§çš„äº‹ä»¶å¯ä»¥ä¸­æ–­æ¸²æŸ“ï¼Œè®©ç”¨æˆ·ä»£ç å¯ä»¥åŠæ—¶å“åº”ç”¨æˆ·äº¤äº’ã€‚</p></li></ul><p><br></p><p>Ok, åé¢æˆ‘ä»¬ä¼šæ·±å…¥äº†è§£Reactçš„äº‹ä»¶å®ç°ï¼Œæˆ‘ä¼šå°½é‡ä¸è´´ä»£ç ï¼Œç”¨æµç¨‹å›¾è¯´è¯ã€‚</p><p><br></p><h2 id="åŸºæœ¬æ¦‚å¿µ"><a href="#åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h2><h3 id="æ•´ä½“çš„æ¶æ„"><a href="#æ•´ä½“çš„æ¶æ„" class="headerlink" title="æ•´ä½“çš„æ¶æ„"></a>æ•´ä½“çš„æ¶æ„</h3><p><img src="/images/react-event/st.png" alt></p><ul><li><strong>ReactEventListener</strong> - äº‹ä»¶å¤„ç†å™¨. åœ¨è¿™é‡Œè¿›è¡Œäº‹ä»¶å¤„ç†å™¨çš„ç»‘å®šã€‚å½“DOMè§¦å‘äº‹ä»¶æ—¶ï¼Œä¼šä»è¿™é‡Œå¼€å§‹è°ƒåº¦åˆ†å‘åˆ°Reactç»„ä»¶æ ‘</li><li><strong>ReactEventEmitter</strong> - æš´éœ²æ¥å£ç»™Reactç»„ä»¶å±‚ç”¨äºæ·»åŠ äº‹ä»¶è®¢é˜…</li><li><strong>EventPluginHub</strong> - å¦‚å…¶åï¼Œè¿™æ˜¯ä¸€ä¸ªâ€˜æ’ä»¶æ’æ§½â€™ï¼Œè´Ÿè´£ç®¡ç†å’Œæ³¨å†Œå„ç§æ’ä»¶ã€‚åœ¨äº‹ä»¶åˆ†å‘æ—¶ï¼Œè°ƒç”¨æ’ä»¶æ¥ç”Ÿæˆåˆæˆäº‹ä»¶</li><li><p><strong>Plugin</strong> - Reactäº‹ä»¶ç³»ç»Ÿä½¿ç”¨äº†æ’ä»¶æœºåˆ¶æ¥ç®¡ç†ä¸åŒè¡Œä¸ºçš„äº‹ä»¶ã€‚è¿™äº›æ’ä»¶ä¼šå¤„ç†è‡ªå·±æ„Ÿå…´è¶£çš„äº‹ä»¶ç±»å‹ï¼Œå¹¶ç”Ÿæˆåˆæˆäº‹ä»¶å¯¹è±¡ã€‚ç›®å‰ReactDOMæœ‰ä»¥ä¸‹å‡ ç§æ’ä»¶ç±»å‹:</p><ul><li><strong>SimpleEventPlugin</strong> - ç®€å•äº‹ä»¶, å¤„ç†ä¸€äº›æ¯”è¾ƒé€šç”¨çš„äº‹ä»¶ç±»å‹ï¼Œä¾‹å¦‚clickã€inputã€keyDownã€mouseOverã€mouseOutã€pointerOverã€pointerOut</li><li><p><strong>EnterLeaveEventPlugin</strong> - mouseEnter/mouseLeaveå’ŒpointerEnter/pointerLeaveè¿™ä¸¤ç±»äº‹ä»¶æ¯”è¾ƒç‰¹æ®Š, å’Œ<code>*over/*leave</code>äº‹ä»¶ç›¸æ¯”, å®ƒä»¬ä¸æ”¯æŒäº‹ä»¶å†’æ³¡, <code>*enter</code>ä¼šç»™æ‰€æœ‰è¿›å…¥çš„å…ƒç´ å‘é€äº‹ä»¶, è¡Œä¸ºæœ‰ç‚¹ç±»ä¼¼äº<code>:hover</code>; è€Œ<code>*over</code>åœ¨è¿›å…¥å…ƒç´ åï¼Œè¿˜ä¼šå†’æ³¡é€šçŸ¥å…¶ä¸Šçº§. å¯ä»¥é€šè¿‡è¿™ä¸ª<a href="https://codesandbox.io/s/enter-and-over-608cl" target="_blank" rel="noopener">å®ä¾‹</a>è§‚å¯Ÿenterå’Œoverçš„åŒºåˆ«.</p><p>å¦‚æœæ ‘å±‚æ¬¡æ¯”è¾ƒæ·±ï¼Œå¤§é‡çš„mouseenterè§¦å‘å¯èƒ½å¯¼è‡´æ€§èƒ½é—®é¢˜ã€‚å¦å¤–å…¶ä¸æ”¯æŒå†’æ³¡ï¼Œæ— æ³•åœ¨Documentå®Œç¾çš„ç›‘å¬å’Œåˆ†å‘, æ‰€ä»¥ReactDOMä½¿ç”¨<code>*over/*out</code>äº‹ä»¶æ¥æ¨¡æ‹Ÿè¿™äº›<code>*enter/*leave</code>ã€‚</p></li><li><p><strong>ChangeEventPlugin</strong> - changeäº‹ä»¶æ˜¯Reactçš„ä¸€ä¸ªè‡ªå®šä¹‰äº‹ä»¶ï¼Œæ—¨åœ¨è§„èŒƒåŒ–è¡¨å•å…ƒç´ çš„å˜åŠ¨äº‹ä»¶ã€‚</p><p>å®ƒæ”¯æŒè¿™äº›è¡¨å•å…ƒç´ : input, textarea, select </p></li><li><p><strong>SelectEventPlugin</strong> - å’Œchangeäº‹ä»¶ä¸€æ ·ï¼ŒReactä¸ºè¡¨å•å…ƒç´ è§„èŒƒåŒ–äº†select(é€‰æ‹©èŒƒå›´å˜åŠ¨)äº‹ä»¶ï¼Œé€‚ç”¨äºinputã€textareaã€contentEditableå…ƒç´ .</p></li><li><strong>BeforeInputEventPlugin</strong> - beforeinputäº‹ä»¶ä»¥åŠ<a href="https://developer.mozilla.org/zh-CN/docs/Web/Events/compositionstart" target="_blank" rel="noopener">composition</a>äº‹ä»¶å¤„ç†ã€‚</li></ul><p>æœ¬æ–‡ä¸»è¦ä¼šå…³æ³¨<code>SimpleEventPlugin</code>çš„å®ç°ï¼Œæœ‰å…´è¶£çš„è¯»è€…å¯ä»¥è‡ªå·±é˜…è¯»Reactçš„æºä»£ç .</p></li><li><p><strong>EventPropagators</strong> æŒ‰ç…§DOMäº‹ä»¶ä¼ æ’­çš„ä¸¤ä¸ªé˜¶æ®µï¼Œéå†Reactç»„ä»¶æ ‘ï¼Œå¹¶æ”¶é›†æ‰€æœ‰ç»„ä»¶çš„äº‹ä»¶å¤„ç†å™¨.</p></li><li><strong>EventBatching</strong> è´Ÿè´£æ‰¹é‡æ‰§è¡Œäº‹ä»¶é˜Ÿåˆ—å’Œäº‹ä»¶å¤„ç†å™¨ï¼Œå¤„ç†äº‹ä»¶å†’æ³¡ã€‚</li><li><p><strong>SyntheticEvent</strong> è¿™æ˜¯â€˜åˆæˆâ€™äº‹ä»¶çš„åŸºç±»ï¼Œå¯ä»¥å¯¹åº”DOMçš„Eventå¯¹è±¡ã€‚åªä¸è¿‡Reactä¸ºäº†å‡ä½å†…å­˜æŸè€—å’Œåƒåœ¾å›æ”¶ï¼Œä½¿ç”¨ä¸€ä¸ªå¯¹è±¡æ± æ¥æ„å»ºå’Œé‡Šæ”¾äº‹ä»¶å¯¹è±¡ï¼Œ ä¹Ÿå°±æ˜¯è¯´SyntheticEventä¸èƒ½ç”¨äºå¼‚æ­¥å¼•ç”¨ï¼Œå®ƒåœ¨åŒæ­¥æ‰§è¡Œå®Œäº‹ä»¶å¤„ç†å™¨åå°±ä¼šè¢«é‡Šæ”¾ã€‚</p><p>SyntheticEventä¹Ÿæœ‰å­ç±»ï¼Œå’ŒDOMå…·ä½“äº‹ä»¶ç±»å‹ä¸€ä¸€åŒ¹é…:</p><ul><li>SyntheticAnimationEvent</li><li>SyntheticClipboardEvent</li><li>SyntheticCompositionEvent</li><li>SyntheticDragEvent</li><li>SyntheticFocusEvent</li><li>SyntheticInputEvent</li><li>SyntheticKeyboardEvent</li><li>SyntheticMouseEvent</li><li>SyntheticPointerEvent</li><li>SyntheticTouchEvent</li><li>â€¦.</li></ul></li></ul><p><br></p><h3 id="äº‹ä»¶åˆ†ç±»ä¸ä¼˜å…ˆçº§"><a href="#äº‹ä»¶åˆ†ç±»ä¸ä¼˜å…ˆçº§" class="headerlink" title="äº‹ä»¶åˆ†ç±»ä¸ä¼˜å…ˆçº§"></a>äº‹ä»¶åˆ†ç±»ä¸ä¼˜å…ˆçº§</h3><p>SimpleEventPluginå°†äº‹ä»¶ç±»å‹åˆ’åˆ†æˆäº†ä¸‰ç±», å¯¹åº”ä¸åŒçš„ä¼˜å…ˆçº§(<strong>ä¼˜å…ˆçº§ç”±ä½åˆ°é«˜</strong>):</p><ul><li><strong>DiscreteEvent</strong> ç¦»æ•£äº‹ä»¶. ä¾‹å¦‚blurã€focusã€ clickã€ submitã€ touchStart. è¿™äº›äº‹ä»¶éƒ½æ˜¯ç¦»æ•£è§¦å‘çš„</li><li><strong>UserBlockingEvent</strong> ç”¨æˆ·é˜»å¡äº‹ä»¶. ä¾‹å¦‚touchMoveã€mouseMoveã€scrollã€dragã€dragOverç­‰ç­‰ã€‚è¿™äº›äº‹ä»¶ä¼šâ€™é˜»å¡â€™ç”¨æˆ·çš„äº¤äº’ã€‚</li><li><strong>ContinuousEvent</strong> å¯è¿ç»­äº‹ä»¶ã€‚ä¾‹å¦‚loadã€errorã€loadStartã€abortã€animationEnd. è¿™ä¸ªä¼˜å…ˆçº§æœ€é«˜ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒä»¬åº”è¯¥æ˜¯ç«‹å³åŒæ­¥æ‰§è¡Œçš„ï¼Œè¿™å°±æ˜¯Continuousçš„æ„ä¹‰ï¼Œå³å¯è¿ç»­çš„æ‰§è¡Œï¼Œä¸è¢«æ‰“æ–­.</li></ul><p>å¯èƒ½è¦å…ˆäº†è§£ä¸€ä¸‹Reactè°ƒåº¦(Schedule)çš„ä¼˜å…ˆçº§ï¼Œæ‰èƒ½ç†è§£è¿™ä¸‰ç§äº‹ä»¶ç±»å‹çš„åŒºåˆ«ã€‚æˆªæ­¢åˆ°æœ¬æ–‡å†™ä½œæ—¶ï¼ŒReactæœ‰5ä¸ªä¼˜å…ˆçº§çº§åˆ«:</p><ul><li><code>Immediate</code> - è¿™ä¸ªä¼˜å…ˆçº§çš„ä»»åŠ¡ä¼šåŒæ­¥æ‰§è¡Œ, æˆ–è€…è¯´è¦é©¬ä¸Šæ‰§è¡Œä¸”ä¸èƒ½ä¸­æ–­</li><li><code>UserBlocking</code>(250ms timeout) è¿™äº›ä»»åŠ¡ä¸€èˆ¬æ˜¯ç”¨æˆ·äº¤äº’çš„ç»“æœ, éœ€è¦å³æ—¶å¾—åˆ°åé¦ˆ .</li><li><code>Normal</code> (5s timeout) åº”å¯¹å“ªäº›ä¸éœ€è¦ç«‹å³æ„Ÿå—åˆ°çš„ä»»åŠ¡ï¼Œä¾‹å¦‚ç½‘ç»œè¯·æ±‚</li><li><code>Low</code> (10s timeout) è¿™äº›ä»»åŠ¡å¯ä»¥æ”¾åï¼Œä½†æ˜¯æœ€ç»ˆåº”è¯¥å¾—åˆ°æ‰§è¡Œ. ä¾‹å¦‚åˆ†æé€šçŸ¥</li><li><code>Idle</code> (no timeout) ä¸€äº›æ²¡æœ‰å¿…è¦åšçš„ä»»åŠ¡ (e.g. æ¯”å¦‚éšè—çš„å†…å®¹).</li></ul><p>ç›®å‰ContinuousEventå¯¹åº”çš„æ˜¯Immediateä¼˜å…ˆçº§; UserBlockingEventå¯¹åº”çš„æ˜¯UserBlocking(éœ€è¦æ‰‹åŠ¨å¼€å¯); è€ŒDiscreteEventå¯¹åº”çš„ä¹Ÿæ˜¯UserBlocking, åªä¸è¿‡å®ƒåœ¨æ‰§è¡Œä¹‹å‰ï¼Œå…ˆä¼šæ‰§è¡Œå®Œå…¶ä»–Discreteä»»åŠ¡ã€‚</p><p>æœ¬æ–‡ä¸ä¼šæ·±å…¥React Fiberæ¶æ„çš„ç»†èŠ‚ï¼Œæœ‰å…´è¶£çš„è¯»è€…å¯ä»¥é˜…è¯»æ–‡æœ«çš„æ‰©å±•é˜…è¯»åˆ—è¡¨.</p><p><br><br><br></p><h2 id="å®ç°ç»†èŠ‚"><a href="#å®ç°ç»†èŠ‚" class="headerlink" title="å®ç°ç»†èŠ‚"></a>å®ç°ç»†èŠ‚</h2><p>ç°åœ¨å¼€å§‹è¿›å…¥æ–‡ç« æ­£é¢˜ï¼ŒReactæ˜¯æ€ä¹ˆå®ç°äº‹ä»¶æœºåˆ¶ï¼Ÿä¸»è¦åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†: <strong>ç»‘å®š</strong>å’Œ<strong>åˆ†å‘</strong>.</p><h3 id="äº‹ä»¶æ˜¯å¦‚ä½•ç»‘å®šçš„ï¼Ÿ"><a href="#äº‹ä»¶æ˜¯å¦‚ä½•ç»‘å®šçš„ï¼Ÿ" class="headerlink" title="äº‹ä»¶æ˜¯å¦‚ä½•ç»‘å®šçš„ï¼Ÿ"></a>äº‹ä»¶æ˜¯å¦‚ä½•ç»‘å®šçš„ï¼Ÿ</h3><p>ä¸ºäº†é¿å…åé¢ç»•æ™•äº†ï¼Œæœ‰å¿…è¦å…ˆäº†è§£ä¸€ä¸‹Reactäº‹ä»¶æœºåˆ¶ä¸­çš„æ’ä»¶åè®®ã€‚ æ¯ä¸ªæ’ä»¶çš„ç»“æ„å¦‚ä¸‹:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> EventTypes = &#123;[key: <span class="built_in">string</span>]: DispatchConfig&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ’ä»¶æ¥å£</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> PluginModule&lt;NativeEvent&gt; = &#123;</span><br><span class="line">  eventTypes: EventTypes,          <span class="comment">// å£°æ˜æ’ä»¶æ”¯æŒçš„äº‹ä»¶ç±»å‹</span></span><br><span class="line">  extractEvents: (                 <span class="comment">// å¯¹äº‹ä»¶è¿›è¡Œå¤„ç†ï¼Œå¹¶è¿”å›åˆæˆäº‹ä»¶å¯¹è±¡</span></span><br><span class="line">    topLevelType: TopLevelType,</span><br><span class="line">    targetInst: <span class="literal">null</span> | Fiber,</span><br><span class="line">    nativeEvent: NativeEvent,</span><br><span class="line">    nativeEventTarget: EventTarget,</span><br><span class="line">  ) =&gt; ?ReactSyntheticEvent,</span><br><span class="line">  tapMoveThreshold?: <span class="built_in">number</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><br></p><p><strong>eventTypes</strong>å£°æ˜è¯¥æ’ä»¶è´Ÿè´£çš„äº‹ä»¶ç±»å‹, å®ƒé€šè¿‡<code>DispatchConfig</code>æ¥æè¿°:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> DispatchConfig = &#123;</span><br><span class="line">  dependencies: <span class="built_in">Array</span>&lt;TopLevelType&gt;, <span class="comment">// ä¾èµ–çš„åŸç”Ÿäº‹ä»¶ï¼Œè¡¨ç¤ºå…³è”è¿™äº›äº‹ä»¶çš„è§¦å‘. â€˜ç®€å•äº‹ä»¶â€™ä¸€èˆ¬åªæœ‰ä¸€ä¸ªï¼Œå¤æ‚äº‹ä»¶å¦‚onChangeä¼šç›‘å¬å¤šä¸ª, å¦‚ä¸‹å›¾ğŸ‘‡</span></span><br><span class="line">  phasedRegistrationNames?: &#123;    <span class="comment">// ä¸¤é˜¶æ®µpropsäº‹ä»¶æ³¨å†Œåç§°, Reactä¼šæ ¹æ®è¿™äº›åç§°åœ¨ç»„ä»¶å®ä¾‹ä¸­æŸ¥æ‰¾å¯¹åº”çš„propsäº‹ä»¶å¤„ç†å™¨</span></span><br><span class="line">    bubbled: <span class="built_in">string</span>,             <span class="comment">// å†’æ³¡é˜¶æ®µ, å¦‚onClick</span></span><br><span class="line">    captured: <span class="built_in">string</span>,            <span class="comment">// æ•è·é˜¶æ®µï¼Œå¦‚onClickCapture</span></span><br><span class="line">  &#125;,</span><br><span class="line">  registrationName?: <span class="built_in">string</span>      <span class="comment">// propsäº‹ä»¶æ³¨å†Œåç§°, æ¯”å¦‚onMouseEnterè¿™äº›ä¸æ”¯æŒå†’æ³¡çš„äº‹ä»¶ç±»å‹ï¼Œåªä¼šå®šä¹‰  registrationNameï¼Œä¸ä¼šå®šä¹‰phasedRegistrationNames</span></span><br><span class="line">  eventPriority: EventPriority,  <span class="comment">// äº‹ä»¶çš„ä¼˜å…ˆçº§ï¼Œä¸Šæ–‡å·²ç»ä»‹ç»è¿‡äº†</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><br></p><p>çœ‹ä¸€ä¸‹å®ä¾‹:</p><p><img src="/images/react-event/dispatch-config.png" alt></p><p>ä¸Šé¢åˆ—ä¸¾äº†ä¸‰ä¸ªå…¸å‹çš„EventPluginï¼š</p><ul><li><p><strong>SimpleEventPlugin</strong> - ç®€å•äº‹ä»¶æœ€å¥½ç†è§£ï¼Œå®ƒä»¬çš„è¡Œä¸ºéƒ½æ¯”è¾ƒé€šç”¨ï¼Œæ²¡æœ‰ä»€ä¹ˆTrick, ä¾‹å¦‚ä¸æ”¯æŒäº‹ä»¶å†’æ³¡ã€ä¸æ”¯æŒåœ¨Documentä¸Šç»‘å®šç­‰ç­‰. å’ŒåŸç”ŸDOMäº‹ä»¶æ˜¯ä¸€ä¸€å¯¹åº”çš„å…³ç³»ï¼Œæ¯”è¾ƒå¥½å¤„ç†.</p></li><li><p><strong>EnterLeaveEventPlugin</strong> - ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºæ¥ï¼Œ<code>mouseEnter</code>å’Œ<code>mouseLeave</code>ä¾èµ–çš„æ˜¯<code>mouseout</code>å’Œ<code>mouseover</code>äº‹ä»¶ã€‚ä¹Ÿå°±æ˜¯è¯´<code>*Enter/*Leave</code>äº‹ä»¶åœ¨Reactä¸­æ˜¯é€šè¿‡<code>*Over/*Out</code>äº‹ä»¶æ¥æ¨¡æ‹Ÿçš„ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯å¯ä»¥åœ¨documentä¸Šé¢è¿›è¡Œå§”æ‰˜ç›‘å¬ï¼Œè¿˜æœ‰é¿å…<code>*Enter/*Leave</code>ä¸€äº›å¥‡æ€ªè€Œä¸å®ç”¨çš„è¡Œä¸ºã€‚</p></li><li><p><strong>ChangeEventPlugin</strong> - onChangeæ˜¯Reactçš„ä¸€ä¸ªè‡ªå®šä¹‰äº‹ä»¶ï¼Œå¯ä»¥çœ‹å‡ºå®ƒä¾èµ–äº†å¤šç§åŸç”ŸDOMäº‹ä»¶ç±»å‹æ¥æ¨¡æ‹ŸonChangeäº‹ä»¶.</p></li></ul><p><br></p><p>å¦å¤–æ¯ä¸ªæ’ä»¶è¿˜ä¼šå®šä¹‰<code>extractEvents</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ¥å—äº‹ä»¶åç§°ã€åŸç”ŸDOMäº‹ä»¶å¯¹è±¡ã€äº‹ä»¶è§¦å‘çš„DOMå…ƒç´ ä»¥åŠReactç»„ä»¶å®ä¾‹, è¿”å›ä¸€ä¸ªåˆæˆäº‹ä»¶å¯¹è±¡ï¼Œå¦‚æœè¿”å›ç©ºåˆ™è¡¨ç¤ºä¸ä½œå¤„ç†. å…³äºextractEventsçš„ç»†èŠ‚ä¼šåœ¨ä¸‹ä¸€èŠ‚é˜è¿°.</p><p><br></p><p>åœ¨ReactDOMå¯åŠ¨æ—¶å°±ä¼šå‘<code>EventPluginHub</code>æ³¨å†Œè¿™äº›æ’ä»¶ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">EventPluginHubInjection.injectEventPluginsByName(&#123;</span><br><span class="line">  SimpleEventPlugin: SimpleEventPlugin,</span><br><span class="line">  EnterLeaveEventPlugin: EnterLeaveEventPlugin,</span><br><span class="line">  ChangeEventPlugin: ChangeEventPlugin,</span><br><span class="line">  SelectEventPlugin: SelectEventPlugin,</span><br><span class="line">  BeforeInputEventPlugin: BeforeInputEventPlugin,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><br></p><p>Ok, å›åˆ°æ­£é¢˜ï¼Œäº‹ä»¶æ˜¯æ€ä¹ˆç»‘å®šçš„å‘¢ï¼Ÿ æ‰“ä¸ªæ–­ç‚¹çœ‹ä¸€ä¸‹è°ƒç”¨æ ˆ:</p><p><img src="/images/react-event/listento.png" alt></p><p>å‰é¢è°ƒç”¨æ ˆå…³äºReactæ ‘å¦‚ä½•æ›´æ–°å’Œæ¸²æŸ“å°±ä¸åœ¨æœ¬æ–‡çš„èŒƒå›´å†…äº†ï¼Œé€šè¿‡è°ƒç”¨æ ˆå¯ä»¥çœ‹å‡ºReactåœ¨propsåˆå§‹åŒ–å’Œæ›´æ–°æ—¶ä¼šè¿›è¡Œäº‹ä»¶ç»‘å®šã€‚è¿™é‡Œå…ˆçœ‹ä¸€ä¸‹æµç¨‹å›¾ï¼Œå¿½ç•¥æ‚ä¹±çš„è·³è½¬ï¼š</p><p><img src="/images/react-event/binding.png" alt></p><ul><li><strong>1. åœ¨propsåˆå§‹åŒ–å’Œæ›´æ–°æ—¶ä¼šè¿›è¡Œäº‹ä»¶ç»‘å®š</strong>ã€‚é¦–å…ˆReactä¼šåˆ¤æ–­å…ƒç´ æ˜¯å¦æ˜¯<code>åª’ä½“ç±»å‹</code>ï¼Œ<strong>åª’ä½“ç±»å‹çš„äº‹ä»¶æ˜¯æ— æ³•åœ¨Documentç›‘å¬çš„ï¼Œæ‰€ä»¥ä¼šç›´æ¥åœ¨å…ƒç´ ä¸Šè¿›è¡Œç»‘å®š</strong></li><li><strong>2. åä¹‹å°±åœ¨Documentä¸Šç»‘å®š</strong>. è¿™é‡Œé¢éœ€è¦ä¸¤ä¸ªä¿¡æ¯ï¼Œä¸€ä¸ªå°±æ˜¯ä¸Šæ–‡æåˆ°çš„â€™äº‹ä»¶ä¾èµ–åˆ—è¡¨â€™, æ¯”å¦‚<code>onMouseEnter</code>ä¾èµ–<code>mouseover/mouseout</code>; ç¬¬äºŒä¸ªæ˜¯ReactBrowserEventEmitterç»´æŠ¤çš„â€™å·²è®¢é˜…äº‹ä»¶è¡¨â€™ã€‚<strong>äº‹ä»¶å¤„ç†å™¨åªéœ€åœ¨Documentè®¢é˜…ä¸€æ¬¡ï¼Œæ‰€ä»¥ç›¸æ¯”åœ¨æ¯ä¸ªå…ƒç´ ä¸Šè®¢é˜…äº‹ä»¶ä¼šèŠ‚çœå¾ˆå¤šèµ„æº</strong>.</li></ul><p>ä»£ç å¤§æ¦‚å¦‚ä¸‹:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">listenTo</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  registrationName: <span class="built_in">string</span>,           <span class="comment">// æ³¨å†Œåç§°ï¼Œå¦‚onClick</span></span></span></span><br><span class="line"><span class="function"><span class="params">  mountAt: Document | Element | Node, <span class="comment">// ç»„ä»¶æ ‘å®¹å™¨ï¼Œä¸€èˆ¬æ˜¯Document</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> listeningSet = getListeningSetForElement(mountAt);             <span class="comment">// å·²è®¢é˜…äº‹ä»¶è¡¨</span></span><br><span class="line">  <span class="keyword">const</span> dependencies = registrationNameDependencies[registrationName]; <span class="comment">// äº‹ä»¶ä¾èµ–</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; dependencies.length; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> dependency = dependencies[i];</span><br><span class="line">    <span class="keyword">if</span> (!listeningSet.has(dependency)) &#123;                               <span class="comment">// æœªè®¢é˜…</span></span><br><span class="line">      <span class="keyword">switch</span> (dependency) &#123;</span><br><span class="line">        <span class="comment">// ... ç‰¹æ®Šçš„äº‹ä»¶ç›‘å¬å¤„ç†</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">          <span class="keyword">const</span> isMediaEvent = mediaEventTypes.indexOf(dependency) !== <span class="number">-1</span>;</span><br><span class="line">          <span class="keyword">if</span> (!isMediaEvent) &#123;</span><br><span class="line">            trapBubbledEvent(dependency, mountAt);                     <span class="comment">// è®¾ç½®äº‹ä»¶å¤„ç†å™¨</span></span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      listeningSet.add(dependency);                                    <span class="comment">// æ›´æ–°å·²è®¢é˜…è¡¨</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>æ¥ä¸‹æ¥å°±æ˜¯æ ¹æ®äº‹ä»¶çš„â€™ä¼˜å…ˆçº§â€™å’Œâ€™æ•è·é˜¶æ®µâ€™(æ˜¯å¦æ˜¯capture)æ¥è®¾ç½®äº‹ä»¶å¤„ç†å™¨</strong>:</li></ul><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">trapEventForPluginEventSystem</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  element: Document | Element | Node,   <span class="comment">// ç»‘å®šåˆ°å…ƒç´ ï¼Œä¸€èˆ¬æ˜¯Document</span></span></span></span><br><span class="line"><span class="function"><span class="params">  topLevelType: DOMTopLevelEventType,   <span class="comment">// äº‹ä»¶åç§°</span></span></span></span><br><span class="line"><span class="function"><span class="params">  capture: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> listener;</span><br><span class="line">  <span class="keyword">switch</span> (getEventPriority(topLevelType)) &#123;</span><br><span class="line">    <span class="comment">// ä¸åŒä¼˜å…ˆçº§çš„äº‹ä»¶ç±»å‹ï¼Œæœ‰ä¸åŒçš„äº‹ä»¶å¤„ç†å™¨è¿›è¡Œåˆ†å‘, ä¸‹æ–‡ä¼šè¯¦ç»†ä»‹ç»</span></span><br><span class="line">    <span class="keyword">case</span> DiscreteEvent:                      <span class="comment">// âš›ï¸ç¦»æ•£äº‹ä»¶</span></span><br><span class="line">      listener = dispatchDiscreteEvent.bind(</span><br><span class="line">        <span class="literal">null</span>,</span><br><span class="line">        topLevelType,</span><br><span class="line">        PLUGIN_EVENT_SYSTEM,</span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> UserBlockingEvent:                 <span class="comment">// âš›ï¸ç”¨æˆ·é˜»å¡äº‹ä»¶</span></span><br><span class="line">      listener = dispatchUserBlockingUpdate.bind(</span><br><span class="line">        <span class="literal">null</span>,</span><br><span class="line">        topLevelType,</span><br><span class="line">        PLUGIN_EVENT_SYSTEM,</span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ContinuousEvent:                   <span class="comment">// âš›ï¸å¯è¿ç»­äº‹ä»¶</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      listener = dispatchEvent.bind(<span class="literal">null</span>, topLevelType, PLUGIN_EVENT_SYSTEM);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> rawEventName = getRawEventName(topLevelType);</span><br><span class="line">  <span class="keyword">if</span> (capture) &#123;                            <span class="comment">// ç»‘å®šäº‹ä»¶å¤„ç†å™¨åˆ°å…ƒç´ </span></span><br><span class="line">    addEventCaptureListener(element, rawEventName, listener);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    addEventBubbleListener(element, rawEventName, listener);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>äº‹ä»¶ç»‘å®šçš„è¿‡ç¨‹è¿˜æ¯”è¾ƒç®€å•, æ¥ä¸‹æ¥çœ‹çœ‹äº‹ä»¶æ˜¯å¦‚ä½•åˆ†å‘çš„ã€‚</p><p><br></p><h3 id="äº‹ä»¶æ˜¯å¦‚ä½•åˆ†å‘çš„ï¼Ÿ"><a href="#äº‹ä»¶æ˜¯å¦‚ä½•åˆ†å‘çš„ï¼Ÿ" class="headerlink" title="äº‹ä»¶æ˜¯å¦‚ä½•åˆ†å‘çš„ï¼Ÿ"></a>äº‹ä»¶æ˜¯å¦‚ä½•åˆ†å‘çš„ï¼Ÿ</h3><p>æŒ‰æƒ¯ä¾‹è¿˜æ˜¯å…ˆä¸Šæµç¨‹å›¾:</p><p><img src="/images/react-event/binding.png" alt></p><h4 id="äº‹ä»¶è§¦å‘è°ƒåº¦"><a href="#äº‹ä»¶è§¦å‘è°ƒåº¦" class="headerlink" title="äº‹ä»¶è§¦å‘è°ƒåº¦"></a>äº‹ä»¶è§¦å‘è°ƒåº¦</h4><p>é€šè¿‡ä¸Šé¢çš„<code>trapEventForPluginEventSystem</code>å‡½æ•°å¯ä»¥çŸ¥é“ï¼Œä¸åŒçš„äº‹ä»¶ç±»å‹æœ‰ä¸åŒçš„äº‹ä»¶å¤„ç†å™¨, å®ƒä»¬çš„åŒºåˆ«æ˜¯è°ƒåº¦çš„ä¼˜å…ˆçº§ä¸ä¸€æ ·:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ç¦»æ•£äº‹ä»¶</span></span><br><span class="line"><span class="comment">// discrentUpdates åœ¨UserBlockingä¼˜å…ˆçº§ä¸­æ‰§è¡Œ</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dispatchDiscreteEvent</span>(<span class="params">topLevelType, eventSystemFlags, nativeEvent</span>) </span>&#123;</span><br><span class="line">  flushDiscreteUpdatesIfNeeded(nativeEvent.timeStamp);</span><br><span class="line">  discreteUpdates(dispatchEvent, topLevelType, eventSystemFlags, nativeEvent);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é˜»å¡äº‹ä»¶</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dispatchUserBlockingUpdate</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  topLevelType,</span></span></span><br><span class="line"><span class="function"><span class="params">  eventSystemFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">  nativeEvent,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// å¦‚æœå¼€å¯äº†enableUserBlockingEvents, åˆ™åœ¨UserBlockingä¼˜å…ˆçº§ä¸­è°ƒåº¦ï¼Œ</span></span><br><span class="line">  <span class="comment">// å¼€å¯enableUserBlockingEventså¯ä»¥é˜²æ­¢é¥¥é¥¿é—®é¢˜ï¼Œå› ä¸ºé˜»å¡äº‹ä»¶ä¸­æœ‰scrollã€mouseMoveè¿™ç±»é¢‘ç¹è§¦å‘çš„äº‹ä»¶</span></span><br><span class="line">  <span class="comment">// å¦åˆ™åŒæ­¥æ‰§è¡Œ</span></span><br><span class="line">  <span class="keyword">if</span> (enableUserBlockingEvents) &#123;</span><br><span class="line">    runWithPriority(</span><br><span class="line">      UserBlockingPriority,</span><br><span class="line">      dispatchEvent.bind(<span class="literal">null</span>, topLevelType, eventSystemFlags, nativeEvent),</span><br><span class="line">    );</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    dispatchEvent(topLevelType, eventSystemFlags, nativeEvent);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯è¿ç»­äº‹ä»¶åˆ™ç›´æ¥åŒæ­¥è°ƒç”¨dispatchEvent</span></span><br></pre></td></tr></table></figure><p><br></p><p>æœ€ç»ˆä¸åŒçš„äº‹ä»¶ç±»å‹éƒ½ä¼šè°ƒç”¨<code>dispatchEvent</code>å‡½æ•°. <code>dispatchEvent</code>ä¸­ä¼šä»DOMåŸç”Ÿäº‹ä»¶å¯¹è±¡è·å–äº‹ä»¶è§¦å‘çš„targetï¼Œå†æ ¹æ®è¿™ä¸ªtargetè·å–å…³è”çš„ReactèŠ‚ç‚¹å®ä¾‹.</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatchEvent</span>(<span class="params">topLevelType: DOMTopLevelEventType, eventSystemFlags: EventSystemFlags, nativeEvent: AnyNativeEvent</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="comment">// è·å–äº‹ä»¶è§¦å‘çš„ç›®æ ‡DOM</span></span><br><span class="line">  <span class="keyword">const</span> nativeEventTarget = getEventTarget(nativeEvent);</span><br><span class="line">  <span class="comment">// è·å–ç¦»è¯¥DOMæœ€è¿‘çš„ç»„ä»¶å®ä¾‹(åªèƒ½æ˜¯DOMå…ƒç´ ç»„ä»¶)</span></span><br><span class="line">  <span class="keyword">let</span> targetInst = getClosestInstanceFromNode(nativeEventTarget);</span><br><span class="line">  <span class="comment">// ....</span></span><br><span class="line">  dispatchEventForPluginEventSystem(topLevelType, eventSystemFlags, nativeEvent, targetInst);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>æ¥ç€(ä¸­é—´è¿˜æœ‰ä¸€äº›æ­¥éª¤ï¼Œè¿™é‡Œå¿½ç•¥)ä¼šè°ƒç”¨<code>EventPluginHub</code>çš„<code>runExtractedPluginEventsInBatch</code>ï¼Œè¿™ä¸ªæ–¹æ³•éå†æ’ä»¶åˆ—è¡¨æ¥å¤„ç†äº‹ä»¶ï¼Œç”Ÿæˆä¸€ä¸ªSyntheticEventåˆ—è¡¨:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">runExtractedPluginEventsInBatch</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  topLevelType: TopLevelType,</span></span></span><br><span class="line"><span class="function"><span class="params">  targetInst: <span class="literal">null</span> | Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  nativeEvent: AnyNativeEvent,</span></span></span><br><span class="line"><span class="function"><span class="params">  nativeEventTarget: EventTarget,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// éå†æ’ä»¶åˆ—è¡¨, è°ƒç”¨æ’ä»¶çš„extractEventsï¼Œç”ŸæˆSyntheticEventåˆ—è¡¨</span></span><br><span class="line">  <span class="keyword">const</span> events = extractPluginEvents(</span><br><span class="line">    topLevelType,</span><br><span class="line">    targetInst,</span><br><span class="line">    nativeEvent,</span><br><span class="line">    nativeEventTarget,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// äº‹ä»¶å¤„ç†å™¨æ‰§è¡Œ, è§åæ–‡æ‰¹é‡æ‰§è¡Œ</span></span><br><span class="line">  runEventsInBatch(events);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><h4 id="æ’ä»¶æ˜¯å¦‚ä½•å¤„ç†äº‹ä»¶"><a href="#æ’ä»¶æ˜¯å¦‚ä½•å¤„ç†äº‹ä»¶" class="headerlink" title="æ’ä»¶æ˜¯å¦‚ä½•å¤„ç†äº‹ä»¶?"></a>æ’ä»¶æ˜¯å¦‚ä½•å¤„ç†äº‹ä»¶?</h4><p>ç°åœ¨æ¥çœ‹çœ‹æ’ä»¶æ˜¯å¦‚ä½•å¤„ç†äº‹ä»¶çš„ï¼Œæˆ‘ä»¬ä»¥<code>SimpleEventPlugin</code>ä¸ºä¾‹:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> SimpleEventPlugin: PluginModule&lt;MouseEvent&gt; &amp; &#123;</span><br><span class="line">  getEventPriority: <span class="function">(<span class="params">topLevelType: TopLevelType</span>) =&gt;</span> EventPriority,</span><br><span class="line">&#125; = &#123;</span><br><span class="line">  eventTypes: eventTypes,</span><br><span class="line">  <span class="comment">// æŠ½å–äº‹ä»¶å¯¹è±¡</span></span><br><span class="line">  extractEvents: <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    topLevelType: TopLevelType,</span></span></span><br><span class="line"><span class="function"><span class="params">    targetInst: null | Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    nativeEvent: MouseEvent,</span></span></span><br><span class="line"><span class="function"><span class="params">    nativeEventTarget: EventTarget,</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">null</span> | <span class="title">ReactSyntheticEvent</span> </span>&#123;</span><br><span class="line">    <span class="comment">// äº‹ä»¶é…ç½®</span></span><br><span class="line">    <span class="keyword">const</span> dispatchConfig = topLevelEventsToDispatchConfig[topLevelType];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1ï¸âƒ£ æ ¹æ®äº‹ä»¶ç±»å‹è·å–SyntheticEventå­ç±»äº‹ä»¶æ„é€ å™¨</span></span><br><span class="line">    <span class="keyword">let</span> EventConstructor;</span><br><span class="line">    <span class="keyword">switch</span> (topLevelType) &#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">      <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_KEY_DOWN:</span><br><span class="line">      <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_KEY_UP:</span><br><span class="line">        EventConstructor = SyntheticKeyboardEvent;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_BLUR:</span><br><span class="line">      <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_FOCUS:</span><br><span class="line">        EventConstructor = SyntheticFocusEvent;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="comment">// ... çœç•¥</span></span><br><span class="line">      <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_GOT_POINTER_CAPTURE:</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">      <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_POINTER_UP:</span><br><span class="line">        EventConstructor = SyntheticPointerEvent;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        EventConstructor = SyntheticEvent;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2ï¸âƒ£ æ„é€ äº‹ä»¶å¯¹è±¡, ä»å¯¹è±¡æ± ä¸­è·å–</span></span><br><span class="line">    <span class="keyword">const</span> event = EventConstructor.getPooled(</span><br><span class="line">      dispatchConfig,</span><br><span class="line">      targetInst,</span><br><span class="line">      nativeEvent,</span><br><span class="line">      nativeEventTarget,</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3ï¸âƒ£ æ ¹æ®DOMäº‹ä»¶ä¼ æ’­çš„é¡ºåºè·å–ç”¨æˆ·äº‹ä»¶å¤„ç†å™¨</span></span><br><span class="line">    accumulateTwoPhaseDispatches(event);</span><br><span class="line">    <span class="keyword">return</span> event;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>SimpleEventPlugin</code>çš„<code>extractEvents</code>ä¸»è¦åšä»¥ä¸‹ä¸‰ä¸ªäº‹æƒ…:</p><ul><li>1ï¸âƒ£ æ ¹æ®äº‹ä»¶çš„ç±»å‹ç¡®å®šSyntheticEventæ„é€ å™¨</li><li>2ï¸âƒ£ æ„é€ SyntheticEventå¯¹è±¡ã€‚</li><li>3ï¸âƒ£ æ ¹æ®DOMäº‹ä»¶ä¼ æ’­çš„é¡ºåºè·å–ç”¨æˆ·äº‹ä»¶å¤„ç†å™¨åˆ—è¡¨</li></ul><p><br></p><p><strong>ä¸ºäº†é¿å…é¢‘ç¹åˆ›å»ºå’Œé‡Šæ”¾äº‹ä»¶å¯¹è±¡å¯¼è‡´æ€§èƒ½æŸè€—(å¯¹è±¡åˆ›å»ºå’Œåƒåœ¾å›æ”¶)ï¼ŒReactä½¿ç”¨ä¸€ä¸ªäº‹ä»¶æ± æ¥è´Ÿè´£ç®¡ç†äº‹ä»¶å¯¹è±¡ï¼Œä½¿ç”¨å®Œçš„äº‹ä»¶å¯¹è±¡ä¼šæ”¾å›æ± ä¸­ï¼Œä»¥å¤‡åç»­çš„å¤ç”¨</strong>ã€‚</p><p>è¿™ä¹Ÿæ„å‘³ç€ï¼Œ<strong>åœ¨äº‹ä»¶å¤„ç†å™¨åŒæ­¥æ‰§è¡Œå®Œåï¼ŒSyntheticEventå¯¹è±¡å°±ä¼šé©¬ä¸Šè¢«å›æ”¶</strong>ï¼Œæ‰€æœ‰å±æ€§éƒ½ä¼šæ— æ•ˆã€‚æ‰€ä»¥ä¸€èˆ¬ä¸ä¼šåœ¨å¼‚æ­¥æ“ä½œä¸­è®¿é—®SyntheticEventäº‹ä»¶å¯¹è±¡ã€‚ä½ ä¹Ÿå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹æ³•æ¥ä¿æŒäº‹ä»¶å¯¹è±¡çš„å¼•ç”¨ï¼š</p><ul><li>è°ƒç”¨<code>SyntheticEvent#persist()</code>æ–¹æ³•ï¼Œå‘Šè¯‰Reactä¸è¦å›æ”¶åˆ°å¯¹è±¡æ± </li><li>ç›´æ¥å¼•ç”¨<code>SyntheticEvent#nativeEvent</code>, nativeEventæ˜¯å¯ä»¥æŒä¹…å¼•ç”¨çš„ï¼Œä¸è¿‡ä¸ºäº†ä¸æ‰“ç ´æŠ½è±¡ï¼Œå»ºè®®ä¸è¦ç›´æ¥å¼•ç”¨nativeEvent</li></ul><p><br></p><p>æ„å»ºå®ŒSyntheticEventå¯¹è±¡åï¼Œå°±éœ€è¦<strong>éå†ç»„ä»¶æ ‘æ¥è·å–è®¢é˜…è¯¥äº‹ä»¶çš„ç”¨æˆ·äº‹ä»¶å¤„ç†å™¨</strong>äº†:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">accumulateTwoPhaseDispatchesSingle</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ä»¥_targetInstä¸ºåŸºç‚¹, æŒ‰ç…§DOMäº‹ä»¶ä¼ æ’­çš„é¡ºåºéå†ç»„ä»¶æ ‘</span></span><br><span class="line">  traverseTwoPhase(event._targetInst, accumulateDirectionalDispatches, event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éå†æ–¹æ³•å…¶å®å¾ˆç®€å•ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">traverseTwoPhase</span>(<span class="params">inst, fn, arg</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> path = [];</span><br><span class="line">  <span class="keyword">while</span> (inst) &#123;           <span class="comment">// ä»instå¼€å§‹ï¼Œå‘ä¸Šçº§å›æº¯</span></span><br><span class="line">    path.push(inst);</span><br><span class="line">    inst = getParent(inst);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> i;</span><br><span class="line">  <span class="comment">// æ•è·é˜¶æ®µï¼Œå…ˆä»æœ€é¡¶å±‚çš„çˆ¶ç»„ä»¶å¼€å§‹, å‘ä¸‹çº§ä¼ æ’­</span></span><br><span class="line">  <span class="keyword">for</span> (i = path.length; i-- &gt; <span class="number">0</span>; ) &#123;</span><br><span class="line">    fn(path[i], <span class="string">'captured'</span>, arg);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å†’æ³¡é˜¶æ®µï¼Œä»instï¼Œå³äº‹ä»¶è§¦å‘ç‚¹å¼€å§‹, å‘ä¸Šçº§ä¼ æ’­</span></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; path.length; i++) &#123;</span><br><span class="line">    fn(path[i], <span class="string">'bubbled'</span>, arg);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>accumulateDirectionalDispatches</code>å‡½æ•°åˆ™æ˜¯ç®€å•æŸ¥æ‰¾å½“å‰èŠ‚ç‚¹æ˜¯å¦æœ‰å¯¹åº”çš„äº‹ä»¶å¤„ç†å™¨:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">accumulateDirectionalDispatches</span>(<span class="params">inst, phase, event</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// æ£€æŸ¥æ˜¯å¦å­˜åœ¨äº‹ä»¶å¤„ç†å™¨</span></span><br><span class="line">  <span class="keyword">const</span> listener = listenerAtPhase(inst, event, phase);</span><br><span class="line">  <span class="comment">// æ‰€æœ‰å¤„ç†å™¨éƒ½æ”¾å…¥åˆ°_dispatchListenersé˜Ÿåˆ—ä¸­ï¼Œåç»­æ‰¹é‡æ‰§è¡Œè¿™ä¸ªé˜Ÿåˆ—</span></span><br><span class="line">  <span class="keyword">if</span> (listener) &#123;</span><br><span class="line">    event._dispatchListeners = accumulateInto(</span><br><span class="line">      event._dispatchListeners,</span><br><span class="line">      listener,</span><br><span class="line">    );</span><br><span class="line">    event._dispatchInstances = accumulateInto(event._dispatchInstances, inst);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>ä¾‹å¦‚ä¸‹é¢çš„ç»„ä»¶æ ‘, éå†è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š</p><p><img src="/images/react-event/event-delivery.png" alt></p><p>æœ€ç»ˆè®¡ç®—å‡ºæ¥çš„<code>_dispatchListeners</code>é˜Ÿåˆ—æ˜¯è¿™æ ·çš„ï¼š<code>[handleB, handleC, handleA]</code></p><p><br></p><h4 id="æ‰¹é‡æ‰§è¡Œ"><a href="#æ‰¹é‡æ‰§è¡Œ" class="headerlink" title="æ‰¹é‡æ‰§è¡Œ"></a>æ‰¹é‡æ‰§è¡Œ</h4><p>éå†æ‰§è¡Œæ’ä»¶åï¼Œä¼šå¾—åˆ°ä¸€ä¸ªSyntheticEventåˆ—è¡¨ï¼Œ<code>runEventsInBatch</code>å°±æ˜¯æ‰¹é‡æ‰§è¡Œè¿™äº›äº‹ä»¶ä¸­çš„<code>_dispatchListeners</code>äº‹ä»¶é˜Ÿåˆ—</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">runEventsInBatch</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  events: Array&lt;ReactSyntheticEvent&gt; | ReactSyntheticEvent | null,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  forEachAccumulated(processingEventQueue, executeDispatchesAndRelease);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ğŸ‘‡</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> executeDispatchesAndRelease = <span class="function"><span class="keyword">function</span>(<span class="params">event: ReactSyntheticEvent</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (event) &#123;</span><br><span class="line">    <span class="comment">// æŒ‰é¡ºåºæ‰§è¡Œ_dispatchListeners</span></span><br><span class="line">    <span class="comment">// ğŸ‘‡</span></span><br><span class="line">    executeDispatchesInOrder(event);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœæ²¡æœ‰è°ƒç”¨persist()æ–¹æ³•åˆ™ç›´æ¥å›æ”¶</span></span><br><span class="line">    <span class="keyword">if</span> (!event.isPersistent()) &#123;</span><br><span class="line">      event.constructor.release(event);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">executeDispatchesInOrder</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// éå†dispatchListeners</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; dispatchListeners.length; i++) &#123;</span><br><span class="line">    <span class="comment">// é€šè¿‡è°ƒç”¨ stopPropagation æ–¹æ³•å¯ä»¥ç¦æ­¢æ‰§è¡Œä¸‹ä¸€ä¸ªäº‹ä»¶å¤„ç†å™¨</span></span><br><span class="line">    <span class="keyword">if</span> (event.isPropagationStopped()) &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ‰§è¡Œäº‹ä»¶å¤„ç†å™¨</span></span><br><span class="line">    executeDispatch(event, dispatchListeners[i], dispatchInstances[i]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/images/react-event/dispatch.png" alt></p><p>OK, åˆ°è¿™é‡ŒReactçš„äº‹ä»¶æœºåˆ¶å°±åŸºæœ¬ä»‹ç»å®Œäº†ï¼Œè¿™é‡Œåªæ˜¯ç®€å•äº†ä»‹ç»äº†ä¸€ä¸‹<code>SimpleEventPlugin</code>, å®é™…ä»£ç ä¸­è¿˜æœ‰å¾ˆå¤šäº‹ä»¶å¤„ç†çš„ç»†èŠ‚ï¼Œé™äºç¯‡å¹…ï¼Œæœ¬æ–‡å°±ä¸å±•å¼€å»è®²äº†ã€‚æœ‰å…´è¶£çš„è¯»è€…å¯ä»¥äº²è‡ªå»è§‚æ‘©Reactçš„æºä»£ç .</p><p><br><br><br></p><h2 id="æœªæ¥"><a href="#æœªæ¥" class="headerlink" title="æœªæ¥"></a>æœªæ¥</h2><p>Reactå†…éƒ¨æœ‰ä¸€ä¸ªå®éªŒæ€§çš„äº‹ä»¶APIï¼ŒReactå†…éƒ¨ç§°ä¸º<code>React Flare</code>ã€æ­£å¼åç§°æ˜¯<a href="https://github.com/facebook/react/tree/master/packages/react-events" target="_blank" rel="noopener"><code>react-events</code></a>, <strong>é€šè¿‡è¿™ä¸ªAPIå¯ä»¥å®ç°è·¨å¹³å°ã€è·¨è®¾å¤‡çš„é«˜çº§äº‹ä»¶å°è£…</strong>.</p><p>react-eventså®šä¹‰äº†ä¸€ä¸ª<strong>äº‹ä»¶å“åº”å™¨(Event Responders)</strong>çš„æ¦‚å¿µï¼Œè¿™ä¸ªäº‹ä»¶å“åº”å™¨å¯ä»¥æ•è·å­ç»„ä»¶æ ‘æˆ–åº”ç”¨æ ¹èŠ‚ç‚¹çš„äº‹ä»¶ï¼Œç„¶åè½¬æ¢ä¸ºè‡ªå®šä¹‰äº‹ä»¶.</p><p>æ¯”è¾ƒå…¸å‹çš„é«˜çº§äº‹ä»¶æ˜¯pressã€longPressã€swipeè¿™äº›æ‰‹åŠ¿ã€‚é€šå¸¸æˆ‘ä»¬éœ€è¦è‡ªå·±æˆ–è€…åˆ©ç”¨ç¬¬ä¸‰æ–¹åº“æ¥å®ç°è¿™ä¸€å¥—æ‰‹åŠ¿è¯†åˆ«, ä¾‹å¦‚</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> Gesture <span class="keyword">from</span> <span class="string">'rc-gesture'</span>;</span><br><span class="line"></span><br><span class="line">ReactDOM.render(</span><br><span class="line">  &lt;Gesture</span><br><span class="line">    onTap=&#123;handleTap&#125;</span><br><span class="line">    onSwipe=&#123;onSwipe&#125;</span><br><span class="line">    onPinch=&#123;handlePinch&#125;</span><br><span class="line">  &gt;</span><br><span class="line">    &lt;div&gt;container&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  &lt;/</span>Gesture&gt;,</span><br><span class="line">container);</span><br></pre></td></tr></table></figure><p><br></p><p>é‚£ä¹ˆreact-eventsçš„ç›®çš„å°±æ˜¯<strong>æä¾›ä¸€å¥—é€šç”¨çš„äº‹ä»¶æœºåˆ¶ç»™å¼€å‘è€…æ¥å®ç°â€™é«˜çº§äº‹ä»¶â€™çš„å°è£…, ç”šè‡³å®ç°äº‹ä»¶çš„è·¨å¹³å°ã€è·¨è®¾å¤‡</strong>, ç°åœ¨ä½ å¯ä»¥é€šè¿‡react-eventsæ¥å°è£…è¿™äº›æ‰‹åŠ¿äº‹ä»¶.</p><p>react-eventsé™¤äº†æ ¸å¿ƒçš„<code>Responder</code>æ¥å£ï¼Œè¿˜å°è£…äº†ä¸€äº›å†…ç½®æ¨¡å—, å®ç°è·¨å¹³å°çš„ã€å¸¸ç”¨çš„é«˜çº§äº‹ä»¶å°è£…ï¼š</p><ul><li>Focus module</li><li>Hover module</li><li>Press module</li><li>FocusScope module</li><li>Input module</li><li>KeyBoard module</li><li>Drag module</li><li>Pan module</li><li>Scroll module</li><li>Swipe module</li></ul><p>ä¸¾<code>Press</code>æ¨¡å—ä½œä¸ºä¾‹å­, <a href="https://github.com/facebook/react/blob/master/packages/react-events/docs/Press.md" target="_blank" rel="noopener">Pressæ¨¡å—</a>ä¼šå“åº”å®ƒåŒ…è£¹çš„å…ƒç´ çš„pressäº‹ä»¶ã€‚pressäº‹ä»¶åŒ…æ‹¬onContextMenuã€onLongPressã€onPressã€onPressEndã€onPressMoveã€onPressStartç­‰ç­‰. å…¶åº•å±‚é€šè¿‡mouseã€penã€touchã€trackpadç­‰äº‹ä»¶æ¥è½¬æ¢.</p><p>çœ‹çœ‹ä½¿ç”¨ç¤ºä¾‹ï¼š</p><figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; PressResponder, usePressListener &#125; <span class="keyword">from</span> <span class="string">'react-events/press'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Button = <span class="function">(<span class="params">props</span>) =&gt;</span> (</span><br><span class="line">  <span class="keyword">const</span> listener = usePressListener(&#123;  <span class="comment">// âš›ï¸é€šè¿‡hooksåˆ›å»ºResponder</span></span><br><span class="line">    onPressStart,</span><br><span class="line">    onPress,</span><br><span class="line">    onPressEnd,</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div listeners=&#123;listener&#125;&gt;</span><br><span class="line">      &#123;subtrees&#125;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">);</span></span><br></pre></td></tr></table></figure><p><br></p><p>react-eventsçš„è¿ä½œæµç¨‹å›¾å¦‚ä¸‹, <strong>äº‹ä»¶å“åº”å™¨(Event Responders)ä¼šæŒ‚è½½åˆ°hostèŠ‚ç‚¹ï¼Œå®ƒä¼šåœ¨hostèŠ‚ç‚¹ç›‘å¬hostæˆ–å­èŠ‚ç‚¹åˆ†å‘çš„åŸç”Ÿäº‹ä»¶(DOMæˆ–React Native), å¹¶å°†å®ƒä»¬è½¬æ¢/åˆå¹¶æˆé«˜çº§çš„äº‹ä»¶</strong>:</p><p><img src="/images/react-event/responder.png" alt></p><p><br></p><blockquote><p>ä½ å¯ä»¥é€šè¿‡è¿™ä¸ªCodesanboxç©ä¸€ä¸‹<code>react-events</code>: <a href="https://codesandbox.io/s/github/ivan-94/react-events-playground" target="_blank" rel="noopener"><img src="https://codesandbox.io/static/img/play-codesandbox.svg" alt="Edit react-events-playground"></a></p></blockquote><p><br></p><h3 id="åˆæ¢responderçš„åˆ›å»º"><a href="#åˆæ¢responderçš„åˆ›å»º" class="headerlink" title="åˆæ¢Responderçš„åˆ›å»º"></a>åˆæ¢Responderçš„åˆ›å»º</h3><p>æˆ‘ä»¬æŒ‘ä¸€ä¸ªç®€å•çš„æ¨¡å—æ¥äº†è§£ä¸€äº›react-eventsçš„æ ¸å¿ƒAPI, ç›®å‰æœ€ç®€å•çš„æ˜¯Keyboardæ¨¡å—. Keyboardæ¨¡å—çš„ç›®çš„å°±æ˜¯è§„èŒƒåŒ–keydownå’Œkeyupäº‹ä»¶å¯¹è±¡çš„keyå±æ€§(éƒ¨åˆ†æµè§ˆå™¨keyå±æ€§çš„è¡Œä¸ºä¸ä¸€æ ·)ï¼Œå®ƒçš„å®ç°å¦‚ä¸‹:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å®šä¹‰Responderçš„å®ç°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> keyboardResponderImpl = &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 1ï¸âƒ£å®šä¹‰Responderéœ€è¦ç›‘å¬çš„å­æ ‘çš„DOMäº‹ä»¶ï¼Œå¯¹äºKeyboardæ¥è¯´æ˜¯['keydown', 'keyup';]</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  targetEventTypes,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 2ï¸âƒ£ç›‘å¬å­æ ‘è§¦å‘çš„äº‹ä»¶</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  onEvent(</span><br><span class="line">    event: ReactDOMResponderEvent,     <span class="comment">// åŒ…å«äº†å½“å‰è§¦å‘äº‹ä»¶çš„ç›¸å…³ä¿¡æ¯ï¼Œå¦‚åŸç”Ÿäº‹ä»¶å¯¹è±¡ï¼Œäº‹ä»¶è§¦å‘çš„èŠ‚ç‚¹ï¼Œäº‹ä»¶ç±»å‹ç­‰ç­‰</span></span><br><span class="line">    context: ReactDOMResponderContext, <span class="comment">// Responderçš„ä¸Šä¸‹æ–‡ï¼Œç»™Responderæä¾›äº†ä¸€äº›æ–¹æ³•æ¥é©±åŠ¨äº‹ä»¶åˆ†å‘</span></span><br><span class="line">    props: KeyboardResponderProps,     <span class="comment">// ä¼ é€’ç»™Responderçš„props</span></span><br><span class="line">  ): <span class="keyword">void</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;responderTarget, type&#125; = event;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (props.disabled) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (type === <span class="string">'keydown'</span>) &#123;</span><br><span class="line">      dispatchKeyboardEvent(</span><br><span class="line">        <span class="string">'onKeyDown'</span>,</span><br><span class="line">        event,</span><br><span class="line">        context,</span><br><span class="line">        <span class="string">'keydown'</span>,</span><br><span class="line">        ((responderTarget: any): Element | Document),</span><br><span class="line">      );</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type === <span class="string">'keyup'</span>) &#123;</span><br><span class="line">      dispatchKeyboardEvent(</span><br><span class="line">        <span class="string">'onKeyUp'</span>,</span><br><span class="line">        event,</span><br><span class="line">        context,</span><br><span class="line">        <span class="string">'keyup'</span>,</span><br><span class="line">        ((responderTarget: any): Element | Document),</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å†æ¥çœ‹çœ‹dispatchKeyboardEvent:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dispatchKeyboardEvent</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  eventPropName: string,</span></span></span><br><span class="line"><span class="function"><span class="params">  event: ReactDOMResponderEvent,</span></span></span><br><span class="line"><span class="function"><span class="params">  context: ReactDOMResponderContext,</span></span></span><br><span class="line"><span class="function"><span class="params">  type: KeyboardEventType,</span></span></span><br><span class="line"><span class="function"><span class="params">  target: Element | Document,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="comment">// âš›ï¸åˆ›å»ºåˆæˆäº‹ä»¶å¯¹è±¡ï¼Œåœ¨è¿™ä¸ªå‡½æ•°ä¸­ä¼šè§„èŒƒåŒ–äº‹ä»¶çš„keyå±æ€§</span></span><br><span class="line">  <span class="keyword">const</span> syntheticEvent = createKeyboardEvent(event, context, type, target);</span><br><span class="line">  <span class="comment">// âš›ï¸é€šè¿‡Responderä¸Šä¸‹æ–‡åˆ†å‘äº‹ä»¶</span></span><br><span class="line">  context.dispatchEvent(eventPropName, syntheticEvent, DiscreteEvent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¼å‡ºResponder:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// âš›ï¸createResponderæŠŠkeyboardResponderImplè½¬æ¢ä¸ºç»„ä»¶å½¢å¼</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> KeyboardResponder = React.unstable_createResponder(</span><br><span class="line">  <span class="string">'Keyboard'</span>,</span><br><span class="line">  keyboardResponderImpl,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// âš›ï¸åˆ›å»ºhookså½¢å¼</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">useKeyboardListener</span>(<span class="params">props: KeyboardListenerProps</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  React.unstable_useListener(KeyboardResponder, props);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>ç°åœ¨è¯»è€…åº”è¯¥å¯¹<strong>Responderçš„èŒè´£</strong>æœ‰äº†ä¸€äº›åŸºæœ¬çš„äº†è§£ï¼Œå®ƒä¸»è¦åšä»¥ä¸‹å‡ ä»¶äº‹æƒ…:</p><ul><li>å£°æ˜è¦ç›‘å¬çš„åŸç”Ÿäº‹ä»¶(å¦‚DOM), å¦‚ä¸Šé¢çš„<code>targetEventTypes</code></li><li>å¤„ç†å’Œè½¬æ¢åˆæˆäº‹ä»¶ï¼Œå¦‚ä¸Šé¢çš„<code>onEvent</code></li><li>åˆ›å»ºå¹¶åˆ†å‘è‡ªå®šä¹‰äº‹ä»¶ã€‚å¦‚ä¸Šé¢çš„<code>context.dispatchEvent</code></li></ul><p><br></p><p>å’Œä¸Šé¢çš„Keyboardæ¨¡å—ç›¸æ¯”ï¼Œç°å®ä¸­çš„å¾ˆå¤šé«˜çº§äº‹ä»¶ï¼Œå¦‚longPress, å®ƒä»¬çš„å®ç°åˆ™è¦å¤æ‚å¾—å¤š. å®ƒä»¬å¯èƒ½è¦ç»´æŒä¸€å®šçš„<strong>çŠ¶æ€</strong>ã€ä¹Ÿå¯èƒ½è¦ç‹¬å å“åº”çš„<strong>æ‰€æœ‰æƒ</strong>(å³åŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªResponderå¯ä»¥å¯¹äº‹ä»¶è¿›è¡Œå¤„ç†, è¿™ä¸ªå¸¸ç”¨äºç§»åŠ¨ç«¯è§¦æ‘¸æ‰‹åŠ¿ï¼Œä¾‹å¦‚React Nativeçš„<a href="https://reactnative.cn/docs/gesture-responder-system/" target="_blank" rel="noopener">GestureResponderSystem</a>)ã€‚</p><p>react-eventsç›®å‰éƒ½è€ƒè™‘äº†è¿™äº›åœºæ™¯, çœ‹ä¸€ä¸‹APIæ¦‚è§ˆ:</p><p><img src="/images/react-event/react-events.png" alt></p><p><br></p><p>è¯¦ç»†å¯ä»¥çœ‹react-events<a href="https://github.com/facebook/react/tree/master/packages/react-events" target="_blank" rel="noopener">å®˜æ–¹ä»“åº“</a></p><p><br></p><h3 id="react-eventsæ„ä¹‰ä½•åœ¨"><a href="#react-eventsæ„ä¹‰ä½•åœ¨" class="headerlink" title="react-eventsæ„ä¹‰ä½•åœ¨?"></a>react-eventsæ„ä¹‰ä½•åœ¨?</h3><p>ä¸Šæ–‡æåˆ°äº†Reactäº‹ä»¶å†…éƒ¨é‡‡ç”¨äº†æ’ä»¶æœºåˆ¶ï¼Œæ¥å®ç°äº‹ä»¶å¤„ç†å’Œåˆæˆï¼Œæ¯”è¾ƒå…¸å‹çš„å°±æ˜¯onChangeäº‹ä»¶ã€‚onChangeäº‹ä»¶å…¶å®å°±æ˜¯æ‰€è°“çš„â€˜é«˜çº§äº‹ä»¶â€™ï¼Œå®ƒæ˜¯é€šè¿‡è¡¨å•ç»„ä»¶çš„å„ç§åŸç”Ÿäº‹ä»¶æ¥æ¨¡æ‹Ÿçš„ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼ŒReacté€šè¿‡æ’ä»¶æœºåˆ¶æœ¬è´¨ä¸Šæ˜¯å¯ä»¥å®ç°é«˜çº§äº‹ä»¶çš„å°è£…çš„ã€‚ä½†æ˜¯å¦‚æœè¯»è€…çœ‹è¿‡æºä»£ç ï¼Œå°±ä¼šè§‰å¾—é‡Œé¢é€»è¾‘æ¯”è¾ƒç»•ï¼Œè€Œä¸”ä¾èµ–Reactçš„å¾ˆå¤šå†…éƒ¨å®ç°ã€‚<strong>æ‰€ä»¥è¿™ç§å†…éƒ¨çš„æ’ä»¶æœºåˆ¶å¹¶ä¸æ˜¯é¢å‘æ™®é€šå¼€å‘è€…çš„</strong>ã€‚</p><p><code>react-events</code>æ¥å£å°±ç®€å•å¾ˆå¤šäº†ï¼Œå®ƒå±è”½äº†å¾ˆå¤šå†…éƒ¨ç»†èŠ‚ï¼Œé¢å‘æ™®é€šå¼€å‘è€…ã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨å®ƒæ¥å®ç°é«˜æ€§èƒ½çš„è‡ªå®šä¹‰äº‹ä»¶åˆ†å‘ï¼Œæ›´å¤§çš„æ„ä¹‰æ˜¯é€šè¿‡å®ƒå¯ä»¥å®ç°è·¨å¹³å°/è®¾å¤‡çš„äº‹ä»¶å¤„ç†æ–¹å¼.</p><p>ç›®å‰react-eventsè¿˜æ˜¯å®éªŒé˜¶æ®µï¼Œç‰¹æ€§æ˜¯é»˜è®¤å…³é—­ï¼ŒAPIå¯èƒ½ä¼šå‡ºç°å˜æ›´, æ‰€ä»¥ä¸å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ã€‚å¯ä»¥é€šè¿‡è¿™ä¸ª<a href="https://github.com/facebook/react/issues/15257" target="_blank" rel="noopener">Issue</a>æ¥å…³æ³¨å®ƒçš„è¿›å±•ã€‚</p><p><br></p><p>æœ€åèµå¹ä¸€ä¸‹Reactå›¢é˜Ÿçš„åˆ›æ–°èƒ½åŠ›ï¼</p><p><br></p><p>å®Œï¼</p><p><br></p><h2 id="æ‰©å±•é˜…è¯»"><a href="#æ‰©å±•é˜…è¯»" class="headerlink" title="æ‰©å±•é˜…è¯»"></a>æ‰©å±•é˜…è¯»</h2><ul><li><a href="https://segmentfault.com/a/1190000013094932" target="_blank" rel="noopener">inputäº‹ä»¶ä¸­æ–‡è§¦å‘å¤šæ¬¡é—®é¢˜ç ”ç©¶</a></li><li><a href="http://www.ayqy.net/blog/dive-into-react-fiber/" target="_blank" rel="noopener">å®Œå…¨ç†è§£React Fiber</a></li><li><a href="https://www.youtube.com/watch?v=ZCuYPiUIONs" target="_blank" rel="noopener">Lin Clark â€“ A Cartoon Intro to Fiber â€“ React Conf 2017</a></li><li><a href="https://philippspiess.com/scheduling-in-react/" target="_blank" rel="noopener">Scheduling in React</a></li><li><a href="https://github.com/facebook/react/issues/15257" target="_blank" rel="noopener">[Umbrella] React Flare</a></li><li><a href="https://github.com/facebook/react/tree/master/packages/react-events" target="_blank" rel="noopener">react-events</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;img src=&quot;/images/react-event/sample.png&quot; alt&gt;&lt;/p&gt;
&lt;p&gt;å½“æˆ‘ä»¬åœ¨ç»„ä»¶ä¸Šè®¾ç½®äº‹ä»¶å¤„ç†å™¨æ—¶ï¼ŒReactå¹¶ä¸ä¼šåœ¨è¯¥DOMå…ƒç´ ä¸Šç›´æ¥ç»‘å®šäº‹ä»¶å¤„ç†å™¨. Reactå†…éƒ¨è‡ªå®šä¹‰äº†ä¸€å¥—äº‹ä»¶ç³»ç»Ÿï¼Œåœ¨è¿™ä¸ªç³»ç»Ÿä¸Šç»Ÿä¸€è¿›è¡Œäº‹ä»¶è®¢é˜…å’Œåˆ†å‘. &lt;/p
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://bobi.ink/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>if æˆ‘æ˜¯å‰ç«¯å›¢é˜ŸLeaderï¼Œæ€ä¹ˆåˆ¶å®šå‰ç«¯åä½œè§„èŒƒ?</title>
    <link href="https://bobi.ink/2019/07/19/frontend-standard/"/>
    <id>https://bobi.ink/2019/07/19/frontend-standard/</id>
    <published>2019-07-18T16:00:00.000Z</published>
    <updated>2019-09-26T23:19:55.258Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>ä¸‡å­—é•¿æ–‡ï¼Œç»§ç»­åˆ·æ–°æˆ‘çš„æ–‡ç« é•¿åº¦è®°å½•ï¼Œæ¶‰åŠå‰ç«¯å¼€å‘çš„æ–¹æ–¹é¢é¢ã€‚æœ¬æ–‡å°†æŒç»­æ›´æ–°å’Œå®Œå–„, æ–‡ç« éƒ¨åˆ†è§‚ç‚¹å¯èƒ½æ¯”è¾ƒæ­¦æ–­æˆ–ä¸å®Œæ•´ï¼Œæ¬¢è¿è¯„è®ºå’Œè¡¥å……ï¼Œä¸€èµ·å®Œå–„è¯¥æ–‡ç« . è°¢è°¢</p></blockquote><p><br></p><p>ç¬”è€…é•¿æœŸå•æªåŒ¹é©¬åœ¨å‰ç«¯é¢†åŸŸå®æ€(è¨€å¤–ä¹‹æ„å°±æ˜¯å›¢é˜Ÿå°±ä¸€ä¸ªäºº)ï¼Œè‡ªå·±å°±æ˜¯è§„èŒƒã€‚éšç€å…¬å¸ä¸šåŠ¡çš„æ‰©å±•ï¼Œæ‰©å……äº†ä¸€äº›äººå‘˜ï¼Œè¿™æ—¶å€™å°±è¦å¼€å§‹è€ƒè™‘åä½œå’Œç¼–ç è§„èŒƒé—®é¢˜äº†ã€‚æœ¬æ–‡è®°å½•äº†ç¬”è€…åœ¨åˆ¶å®š<code>å‰ç«¯åä½œè§„èŒƒ</code>æ—¶çš„ä¸€äº›æ€è€ƒï¼Œå¸Œæœ›èƒ½ç»™ä½ ä»¬ä¹Ÿå¸¦æ¥ä¸€äº›å¸®åŠ©.</p><p><strong>ä¸€ä¸ªäººèµ°çš„æ›´å¿«ï¼Œä¸€ç¾¤äººå¯ä»¥èµ°å¾—æ›´è¿œï¼Œå‰ææ˜¯ç»Ÿä¸€çš„ç­–ç•¥ï¼Œè¿˜è¦ä¸æ–­åœ°åçœå’Œä¼˜åŒ–</strong>ã€‚</p><p><br></p><p><strong>ä»¥ä¸‹æ˜¯ç›®å½•æ¦‚è§ˆ, çœ‹å‡ºè¿™æ˜¯ä¸€ç¯‡æµ©æµ©è¡è¡çš„é•¿æ–‡</strong></p><!-- TOC --><ul><li><a href="#1-å·¥ä½œæµè§„èŒƒ">1 å·¥ä½œæµè§„èŒƒ</a><ul><li><a href="#11-å¼€å‘">1.1 å¼€å‘</a><ul><li><a href="#111-ç‰ˆæœ¬è§„èŒƒ">1.1.1 ç‰ˆæœ¬è§„èŒƒ</a></li><li><a href="#112-ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿè§„èŒƒ">1.1.2 ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿè§„èŒƒ</a></li><li><a href="#113-æäº¤ä¿¡æ¯è§„èŒƒ">1.1.3 æäº¤ä¿¡æ¯è§„èŒƒ</a></li></ul></li><li><a href="#12-æ„å»ºè§„èŒƒ">1.2 æ„å»ºè§„èŒƒ</a></li><li><a href="#13-å‘å¸ƒå·¥ä½œæµè§„èŒƒ">1.3 å‘å¸ƒå·¥ä½œæµè§„èŒƒ</a></li><li><a href="#14-æŒç»­é›†æˆ">1.4 æŒç»­é›†æˆ</a></li><li><a href="#15-ä»»åŠ¡ç®¡ç†">1.5 ä»»åŠ¡ç®¡ç†</a></li></ul></li><li><a href="#2-æŠ€æœ¯æ ˆè§„èŒƒ">2 æŠ€æœ¯æ ˆè§„èŒƒ</a><ul><li><a href="#21-æŠ€æœ¯é€‰å‹">2.1 æŠ€æœ¯é€‰å‹</a></li><li><a href="#22-è¿æ¥æ–°æŠ€æœ¯">2.2 è¿æ¥æ–°æŠ€æœ¯</a></li></ul></li><li><a href="#3-æµè§ˆå™¨å…¼å®¹è§„èŒƒ">3 æµè§ˆå™¨å…¼å®¹è§„èŒƒ</a><ul><li><a href="#31-ç¡®å®šå…¼å®¹ç­–ç•¥">3.1 ç¡®å®šå…¼å®¹ç­–ç•¥</a></li><li><a href="#32-ç¡®å®šæµè§ˆå™¨åˆ†çº§">3.2 ç¡®å®šæµè§ˆå™¨åˆ†çº§</a></li><li><a href="#33-è·å–ç»Ÿè®¡æ•°æ®">3.3 è·å–ç»Ÿè®¡æ•°æ®</a></li></ul></li><li><a href="#4-é¡¹ç›®ç»„ç»‡è§„èŒƒ">4 é¡¹ç›®ç»„ç»‡è§„èŒƒ</a><ul><li><a href="#41-é€šç”¨çš„é¡¹ç›®ç»„ç»‡è§„èŒƒ">4.1 é€šç”¨çš„é¡¹ç›®ç»„ç»‡è§„èŒƒ</a></li><li><a href="#42-ç›®å½•ç»„ç»‡çš„é£æ ¼">4.2 ç›®å½•ç»„ç»‡çš„é£æ ¼</a></li><li><a href="#43-è„šæ‰‹æ¶å’Œé¡¹ç›®æ¨¡æ¿">4.3 è„šæ‰‹æ¶å’Œé¡¹ç›®æ¨¡æ¿</a></li></ul></li><li><a href="#5-ç¼–ç è§„èŒƒ">5 ç¼–ç è§„èŒƒ</a><ul><li><a href="#51-javascript">5.1 Javascript</a></li><li><a href="#52-html">5.2 HTML</a></li><li><a href="#53-css">5.3 CSS</a></li><li><a href="#54-ä»£ç æ ¼å¼åŒ–">5.4 ä»£ç æ ¼å¼åŒ–</a></li><li><a href="#55-é›†å¤§æˆçš„">5.5 é›†å¤§æˆçš„</a></li><li><a href="#56-ç‰¹å®šæ¡†æ¶é£æ ¼æŒ‡å—">5.6 ç‰¹å®šæ¡†æ¶é£æ ¼æŒ‡å—</a></li><li><a href="#57-code-review">5.7 Code Review</a></li></ul></li><li><a href="#6-æ–‡æ¡£è§„èŒƒ">6 æ–‡æ¡£è§„èŒƒ</a><ul><li><a href="#61-å»ºç«‹æ–‡æ¡£ä¸­å¿ƒ">6.1 å»ºç«‹æ–‡æ¡£ä¸­å¿ƒ</a></li><li><a href="#62-æ–‡æ¡£æ ¼å¼">6.2 æ–‡æ¡£æ ¼å¼</a></li><li><a href="#63-å®šä¹‰æ–‡æ¡£çš„æ¨¡æ¿">6.3 å®šä¹‰æ–‡æ¡£çš„æ¨¡æ¿</a></li><li><a href="#64-è®¨è®ºå³æ–‡æ¡£">6.4 è®¨è®ºå³æ–‡æ¡£</a></li><li><a href="#65-æ³¨é‡Šå³æ–‡æ¡£">6.5 æ³¨é‡Šå³æ–‡æ¡£</a></li><li><a href="#66-ä»£ç å³æ–‡æ¡£">6.6 ä»£ç å³æ–‡æ¡£</a></li></ul></li><li><a href="#7-uiè®¾è®¡è§„èŒƒ">7 UIè®¾è®¡è§„èŒƒ</a></li><li><a href="#8-æµ‹è¯•è§„èŒƒ">8 æµ‹è¯•è§„èŒƒ</a><ul><li><a href="#81-æµ‹è¯•çš„æµç¨‹">8.1 æµ‹è¯•çš„æµç¨‹</a></li><li><a href="#82-å•å…ƒæµ‹è¯•">8.2 å•å…ƒæµ‹è¯•</a></li></ul></li><li><a href="#9-å¼‚å¸¸å¤„ç†ç›‘æ§å’Œè°ƒè¯•è§„èŒƒ">9 å¼‚å¸¸å¤„ç†ã€ç›‘æ§å’Œè°ƒè¯•è§„èŒƒ</a><ul><li><a href="#91-å¼‚å¸¸å¤„ç†">9.1 å¼‚å¸¸å¤„ç†</a></li><li><a href="#92-æ—¥å¿—">9.2 æ—¥å¿—</a></li><li><a href="#93-å¼‚å¸¸ç›‘æ§">9.3 å¼‚å¸¸ç›‘æ§</a></li></ul></li><li><a href="#10-å‰åç«¯åä½œè§„èŒƒ">10 å‰åç«¯åä½œè§„èŒƒ</a><ul><li><a href="#101-åä½œæµç¨‹è§„èŒƒ">10.1 åä½œæµç¨‹è§„èŒƒ</a></li><li><a href="#102-æ¥å£è§„èŒƒ">10.2 æ¥å£è§„èŒƒ</a></li><li><a href="#103-æ¥å£æ–‡æ¡£è§„èŒƒ">10.3 æ¥å£æ–‡æ¡£è§„èŒƒ</a></li><li><a href="#104-æ¥å£æµ‹è¯•ä¸æ¨¡æ‹Ÿ">10.4 æ¥å£æµ‹è¯•ä¸æ¨¡æ‹Ÿ</a></li></ul></li><li><a href="#11-åŸ¹è®­çŸ¥è¯†ç®¡ç†æŠ€æœ¯æ²‰æ·€">11 åŸ¹è®­/çŸ¥è¯†ç®¡ç†/æŠ€æœ¯æ²‰æ·€</a><ul><li><a href="#111-æ–°äººåŸ¹è®­">11.1 æ–°äººåŸ¹è®­</a></li><li><a href="#112-è¥é€ æŠ€æœ¯æ°›å›´">11.2 è¥é€ æŠ€æœ¯æ°›å›´</a></li></ul></li><li><a href="#12-åé¦ˆ">12 åé¦ˆ</a></li></ul><!-- /TOC --><p><br></p><p><strong>CHANGELOG</strong></p><ul><li>2019.7.28<br>æ–°å¢<a href="#tech-select">æŠ€æœ¯é€‰å‹</a></li><li>2019.7.29<br>æ–°å¢<a href="#brw-anly">æµè§ˆå™¨ç»Ÿè®¡æ•°æ®è·å–</a></li><li>2019.9.6<br>å»ºç«‹æŠ€æœ¯æ°›å›´ä¸€èŠ‚ æ–°å¢é¢è¯•é¢˜åº“</li><li>2019.9.27<br>æ›´æ–°ç³»åˆ—æ–‡ç« </li></ul><p><br></p><p><strong>ç³»åˆ—æ–‡ç« </strong></p><ul><li><a href="https://juejin.im/post/5d3a7134f265da1b5d57f1ed" target="_blank" rel="noopener">if æˆ‘æ˜¯å‰ç«¯å›¢é˜Ÿ Leaderï¼Œæ€ä¹ˆåˆ¶å®šå‰ç«¯åä½œè§„èŒƒ? ğŸ”¥</a></li><li><a href="https://juejin.im/post/5d71cec6e51d4561b674c4d0" target="_blank" rel="noopener">if æˆ‘æ˜¯å‰ç«¯å›¢é˜Ÿ Leaderï¼Œæ€ä¹ˆåšå¥½æ¦‚è¦è®¾è®¡</a></li><li><a href="https://juejin.im/post/5d8d4557e51d4577fe41b62d" target="_blank" rel="noopener">if æˆ‘æ˜¯å‰ç«¯å›¢é˜Ÿ Leaderï¼Œæ€ä¹ˆç”¨å¥½çœ‹æ¿è¿›è¡Œä»»åŠ¡ç®¡ç†?</a></li></ul><p><br></p><p><strong>ä»€ä¹ˆæ˜¯è§„èŒƒ?</strong></p><p>è§„èŒƒï¼Œåè¯æ„ä¹‰ä¸Šï¼šå³æ˜æ–‡è§„å®šæˆ–çº¦å®šä¿—æˆçš„æ ‡å‡†ï¼Œå¦‚ï¼šé“å¾·è§„èŒƒã€æŠ€æœ¯è§„èŒƒç­‰ã€‚ åŠ¨è¯æ„ä¹‰ä¸Šï¼šæ˜¯æŒ‡æŒ‰ç…§æ—¢å®šæ ‡å‡†ã€è§„èŒƒçš„è¦æ±‚è¿›è¡Œæ“ä½œï¼Œä½¿æŸä¸€è¡Œä¸ºæˆ–æ´»åŠ¨è¾¾åˆ°æˆ–è¶…è¶Šè§„å®šçš„æ ‡å‡†ï¼Œå¦‚ï¼šè§„èŒƒç®¡ç†ã€è§„èŒƒæ“ä½œ.</p><p><br></p><p><strong>ä¸ºä»€ä¹ˆéœ€è¦è§„èŒƒ?</strong></p><ul><li>é™ä½æ–°æˆå‘˜èå…¥å›¢é˜Ÿçš„æˆæœ¬, åŒæ—¶ä¹Ÿä¸€å®šç¨‹åº¦é¿å…æŒ–å‘</li><li>æé«˜å¼€å‘æ•ˆç‡ã€å›¢é˜Ÿåä½œæ•ˆç‡, é™ä½æ²Ÿé€šæˆæœ¬</li><li>å®ç°é«˜åº¦ç»Ÿä¸€çš„ä»£ç é£æ ¼ï¼Œæ–¹ä¾¿review, å¦å¤–ä¸€æ–¹é¢å¯ä»¥æé«˜é¡¹ç›®çš„å¯ç»´æŠ¤æ€§</li><li>è§„èŒƒæ˜¯å®ç°è‡ªåŠ¨åŒ–çš„åŸºç¡€</li><li>è§„èŒƒæ˜¯ä¸€ä¸ªå›¢é˜ŸçŸ¥è¯†æ²‰æ·€çš„ç›´æ¥è¾“å‡º</li></ul><p><br></p><p><strong>è§„èŒƒåŒ…å«å“ªäº›å†…å®¹?</strong></p><p>å¦‚æ–‡ç« æ ‡é¢˜ï¼Œ<strong>å‰ç«¯åä½œè§„èŒƒå¹¶ä¸å•å•æŒ‡â€˜ç¼–ç è§„èŒƒâ€™ï¼Œè¿™ä¸ªè§„èŒƒæ¶‰åŠåˆ°å‰ç«¯å¼€å‘æ´»åŠ¨çš„æ–¹æ–¹é¢é¢</strong>ï¼Œä¾‹å¦‚ä»£ç åº“çš„ç®¡ç†ã€å‰åç«¯åä½œã€ä»£ç è§„èŒƒã€å…¼å®¹æ€§è§„èŒƒï¼›</p><p>ä¸ä»…ä»…æ˜¯å‰ç«¯å›¢é˜Ÿå†…éƒ¨éœ€è¦åä½œï¼Œä¸€ä¸ªå®Œæ•´çš„è½¯ä»¶ç”Ÿå‘½å‘¨æœŸå†…ï¼Œæˆ‘ä»¬éœ€è¦å’Œäº§å“/è®¾è®¡ã€åç«¯(æˆ–è€…åŸç”Ÿå®¢æˆ·ç«¯å›¢é˜Ÿ)ã€æµ‹è¯•è¿›è¡Œåä½œ, æˆ‘ä»¬éœ€è¦è¦†ç›–è¿™äº›å†…å®¹.</p><p><br></p><p>ä¸‹é¢å°±å¼€å§‹ä»‹ç»ï¼Œ<strong>å¦‚æœæˆ‘æ˜¯å‰ç«¯å›¢é˜Ÿçš„Leaderï¼Œæˆ‘ä¼šæ€ä¹ˆåˆ¶å®šå‰ç«¯è§„èŒƒï¼Œè¿™ä¸ªè§„èŒƒéœ€è¦åŒ…å«å“ªäº›å†…å®¹</strong>?</p><p><br></p><h2 id="1-å·¥ä½œæµè§„èŒƒ"><a href="#1-å·¥ä½œæµè§„èŒƒ" class="headerlink" title="1 å·¥ä½œæµè§„èŒƒ"></a>1 å·¥ä½œæµè§„èŒƒ</h2><h3 id="1-1-å¼€å‘"><a href="#1-1-å¼€å‘" class="headerlink" title="1.1 å¼€å‘"></a>1.1 å¼€å‘</h3><h4 id="1-1-1-ç‰ˆæœ¬è§„èŒƒ"><a href="#1-1-1-ç‰ˆæœ¬è§„èŒƒ" class="headerlink" title="1.1.1 ç‰ˆæœ¬è§„èŒƒ"></a>1.1.1 ç‰ˆæœ¬è§„èŒƒ</h4><p>é¡¹ç›®çš„ç‰ˆæœ¬å·åº”è¯¥æ ¹æ®æŸäº›è§„åˆ™è¿›è¡Œè¿­ä»£, è¿™é‡Œæ¨èä½¿ç”¨<a href="https://semver.org/lang/zh-CN/" target="_blank" rel="noopener">è¯­ä¹‰åŒ–ç‰ˆæœ¬</a>è§„èŒƒ, <strong>é€šè¿‡è¿™ä¸ªè§„èŒƒï¼Œç”¨æˆ·å¯ä»¥äº†è§£ç‰ˆæœ¬å˜æ›´çš„å½±å“èŒƒå›´</strong>ã€‚ è§„åˆ™å¦‚ä¸‹:</p><ul><li>ä¸»ç‰ˆæœ¬å·ï¼šå½“ä½ åšäº†ä¸å…¼å®¹çš„ API ä¿®æ”¹ï¼Œ</li><li>æ¬¡ç‰ˆæœ¬å·ï¼šå½“ä½ åšäº†å‘ä¸‹å…¼å®¹çš„åŠŸèƒ½æ€§æ–°å¢ï¼Œ</li><li>ä¿®è®¢å·ï¼šå½“ä½ åšäº†å‘ä¸‹å…¼å®¹çš„é—®é¢˜ä¿®æ­£ã€‚</li></ul><p><br></p><p><a href="#">â¬†ï¸å›åˆ°é¡¶éƒ¨</a></p><h4 id="1-1-2-ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿè§„èŒƒ"><a href="#1-1-2-ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿè§„èŒƒ" class="headerlink" title="1.1.2 ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿè§„èŒƒ"></a>1.1.2 ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿè§„èŒƒ</h4><p>å¤§éƒ¨åˆ†å›¢é˜Ÿéƒ½ä½¿ç”¨gitä½œä¸ºç‰ˆæœ¬åº“ï¼Œç®¡ç†å¥½ä»£ç ä¹Ÿæ˜¯ä¸€ç§å­¦é—®ã€‚å°¤å…¶æ˜¯æ¶‰åŠå¤šäººå¹¶å‘åä½œã€éœ€è¦ç®¡ç†å¤šä¸ªè½¯ä»¶ç‰ˆæœ¬çš„æƒ…å†µä¸‹ï¼Œå®šä¹‰è‰¯å¥½çš„ç‰ˆæœ¬åº“ç®¡ç†è§„èŒƒï¼Œå¯ä»¥è®©å¤§å‹é¡¹ç›®æ›´æœ‰ç»„ç»‡æ€§ï¼Œä¹Ÿå¯ä»¥æé«˜æˆå‘˜åä½œæ•ˆç‡.</p><p>æ¯”è¾ƒæµè¡Œçš„gitåˆ†æ”¯æ¨¡å‹/å·¥ä½œæµæ˜¯<a href="https://www.git-tower.com/learn/git/ebook/cn/command-line/advanced-topics/git-flow" target="_blank" rel="noopener">git-flow</a>, ä½†æ˜¯å¤§éƒ¨åˆ†å›¢é˜Ÿä¼šæ ¹æ®è‡ªå·±çš„æƒ…å†µåˆ¶å®šè‡ªå·±çš„gitå·¥ä½œæµè§„èŒƒ, ä¾‹å¦‚æˆ‘ä»¬å›¢é˜Ÿçš„<a href="https://github.com/GDJiaMi/frontend-standards/blob/master/development.md#git-%E5%88%86%E6%94%AF%E6%A8%A1%E5%9E%8B" target="_blank" rel="noopener">åˆ†æ”¯è§„èŒƒ</a></p><p><strong>Git æœ‰å¾ˆå¤šå·¥ä½œæµæ–¹æ³•è®ºï¼Œè¿™äº›å·¥ä½œæµçš„é€‰æ‹©å¯èƒ½ä¾èµ–äºé¡¹ç›®çš„è§„æ¨¡ã€é¡¹ç›®çš„ç±»å‹ä»¥åŠå›¢é˜Ÿæˆå‘˜çš„ç»“æ„</strong>.</p><p>æ¯”å¦‚ä¸€ä¸ªç®€å•çš„ä¸ªäººé¡¹ç›®å¯èƒ½ä¸éœ€è¦å¤æ‚çš„åˆ†æ”¯åˆ’åˆ†ï¼Œæˆ‘ä»¬çš„å˜æ›´éƒ½æ˜¯ç›´æ¥æäº¤åˆ° master åˆ†æ”¯;</p><p>å†æ¯”å¦‚å¼€æºé¡¹ç›®ï¼Œé™¤äº†æ ¸å¿ƒå›¢é˜Ÿæˆå‘˜ï¼Œå…¶ä»–è´¡çŒ®è€…æ˜¯æ²¡æœ‰æäº¤çš„æƒé™çš„ï¼Œè€Œä¸”æˆ‘ä»¬ä¹Ÿéœ€è¦ä¸€å®šçš„æ‰‹æ®µæ¥éªŒè¯å’Œè®¨è®ºè´¡çŒ®çš„ä»£ç æ˜¯å¦åˆç†ã€‚ æ‰€ä»¥å¯¹äºå¼€æºé¡¹ç›® fork å·¥ä½œæµæ›´ä¸ºé€‚åˆ.</p><p>äº†è§£å¸¸è§çš„å·¥ä½œæµæœ‰åˆ©äºç»„ç»‡æˆ–åˆ›å»ºé€‚åˆè‡ªå·±å›¢é˜Ÿçš„å·¥ä½œæµ, æäº¤å›¢é˜Ÿåä½œçš„æ•ˆç‡:</p><p><img src="/images/frontend-standard/branch.png" alt></p><ul><li><a href="https://github.com/ivan-94/git-guide/blob/master/branch/centralized.md" target="_blank" rel="noopener">ç®€å•çš„é›†ä¸­å¼</a></li><li><a href="https://github.com/ivan-94/git-guide/blob/master/branch/feature.md" target="_blank" rel="noopener">åŸºäºåŠŸèƒ½åˆ†æ”¯çš„å·¥ä½œæµ</a></li><li><a href="https://github.com/ivan-94/git-guide/blob/master/branch/gitflow.md" target="_blank" rel="noopener">Git Flow</a> ğŸ”¥</li><li><a href="https://github.com/ivan-94/git-guide/blob/master/branch/fork.md" target="_blank" rel="noopener">Fork/Pull Request å·¥ä½œæµ</a></li></ul><p><br></p><p><a href="#">â¬†ï¸å›åˆ°é¡¶éƒ¨</a></p><h4 id="1-1-3-æäº¤ä¿¡æ¯è§„èŒƒ"><a href="#1-1-3-æäº¤ä¿¡æ¯è§„èŒƒ" class="headerlink" title="1.1.3 æäº¤ä¿¡æ¯è§„èŒƒ"></a>1.1.3 æäº¤ä¿¡æ¯è§„èŒƒ</h4><p><img src="/images/frontend-standard/commit.png" alt></p><p>ç»„ç»‡å¥½çš„æäº¤ä¿¡æ¯, å¯ä»¥æé«˜é¡¹ç›®çš„æ•´ä½“è´¨é‡. è‡³å°‘å…·æœ‰ä¸‹é¢è¿™äº›ä¼˜ç‚¹:</p><ul><li><strong>æ ¼å¼ç»Ÿä¸€çš„æäº¤ä¿¡æ¯æœ‰åŠ©äºè‡ªåŠ¨åŒ–ç”ŸæˆCHANGELOG</strong></li><li><strong>ç‰ˆæœ¬åº“ä¸åªæ˜¯å­˜æ”¾ä»£ç çš„ä»“åº“, å®ƒè®°å½•é¡¹ç›®çš„å¼€å‘æ—¥å¿—, å®ƒåº”è¯¥è¦æ¸…æ™°è¡¨è¾¾è¿™æ¬¡æäº¤çš„åšäº†ä»€ä¹ˆ</strong>. è¿™äº›è®°å½•åº”è¯¥å¯ä»¥å¸®åŠ©åæ¥è€…å¿«é€Ÿåœ°å­¦ä¹ å’Œå›é¡¾ä»£ç , ä¹Ÿåº”è¯¥æ–¹ä¾¿å…¶ä»–åä½œè€…reviewä½ çš„ä»£ç </li><li><strong>è§„èŒƒåŒ–æäº¤ä¿¡æ¯å¯ä»¥ä¿ƒè¿›æäº¤è€…æäº¤æœ‰æ„ä¹‰çš„ã€ç²’åº¦åˆé€‚çš„â€™æäº¤â€™</strong>. æäº¤è€…è¦æƒ³å¥½è¦æ€ä¹ˆæè¿°è¿™ä¸ªæäº¤ï¼Œè¿™æ ·è¢«åŠ¨ä¿ƒè¿›äº†ä»–ä»¬å»æŠŠæ§<strong>æäº¤çš„ç²’åº¦</strong></li></ul><p><br></p><p>ç¤¾åŒºä¸Šæ¯”è¾ƒæµè¡Œçš„æäº¤ä¿¡æ¯è§„èŒƒæ˜¯<a href="https://github.com/angular/angular/blob/master/CONTRIBUTING.md#commit" target="_blank" rel="noopener">Angularçš„æäº¤ä¿¡æ¯è§„èŒƒ</a>, é™¤æ­¤ä¹‹å¤–ï¼Œè¿™äº›ä¹Ÿå¾ˆä¸é”™:</p><ul><li><a href="https://github.com/atom/atom/blob/master/CONTRIBUTING.md#git-commit-messages" target="_blank" rel="noopener">Atom</a></li><li><a href="https://github.com/conventional-changelog/conventional-changelog/tree/master/packages/conventional-changelog-ember" target="_blank" rel="noopener">Ember</a></li><li><a href="https://github.com/conventional-changelog/conventional-changelog/tree/master/packages/conventional-changelog-eslint" target="_blank" rel="noopener">Eslint</a></li><li><a href="https://github.com/conventional-changelog/conventional-changelog/tree/master/packages/conventional-changelog-jquery" target="_blank" rel="noopener">JQuery</a></li></ul><p><br></p><p>å¦å¤–è¿™äº›å·¥å…·å¯ä»¥å¸®åŠ©ä½ æ£€éªŒæäº¤ä¿¡æ¯, ä»¥åŠç”ŸæˆCHANGELOG:</p><ul><li><a href="https://github.com/conventional-changelog/conventional-changelog" target="_blank" rel="noopener">conventional-changelog</a> - ä»é¡¹ç›®çš„æäº¤ä¿¡æ¯ä¸­ç”ŸæˆCHANGELOGå’Œå‘å¸ƒä¿¡æ¯</li><li><a href="https://github.com/conventional-changelog/commitlint" target="_blank" rel="noopener">commitlint</a> - æ£€éªŒæäº¤ä¿¡æ¯</li><li><a href="https://github.com/commitizen/cz-cli" target="_blank" rel="noopener">commitizen</a> - ğŸ”¥ç®€å•çš„æäº¤è§„èŒƒå’Œæäº¤å¸®åŠ©å·¥å…·ï¼Œæ¨è</li><li><a href="https://github.com/conventional-changelog/commitlint" target="_blank" rel="noopener">standard-changelog</a> - angularé£æ ¼çš„æäº¤å‘½ä»¤è¡Œå·¥å…· </li></ul><p><br></p><p><a href="#">â¬†ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="1-2-æ„å»ºè§„èŒƒ"><a href="#1-2-æ„å»ºè§„èŒƒ" class="headerlink" title="1.2 æ„å»ºè§„èŒƒ"></a>1.2 æ„å»ºè§„èŒƒ</h3><p>å¯¹äºå›¢é˜Ÿã€æˆ–è€…éœ€è¦ç»´æŠ¤å¤šä¸ªé¡¹ç›®åœºæ™¯ï¼Œç»Ÿä¸€çš„æ„å»ºå·¥å…·é“¾å¾ˆé‡è¦, <strong>è¿™å¥—å·¥å…·åº”è¯¥å¼ºè°ƒâ€çº¦å®šå¤§äºé…ç½®â€ï¼Œè®©å¼€å‘è€…æ›´ä¸“æ³¨äºä¸šåŠ¡çš„å¼€å‘</strong>ã€‚ç¬”è€…åœ¨<a href="https://juejin.im/post/5d2fcaacf265da1b95708f63" target="_blank" rel="noopener">&lt;ä¸ºä»€ä¹ˆè¦ç”¨vue-cli3?&gt;</a>æ–‡ç« ä¸­æå‡ºäº†<code>vue-cli3</code>æ›´æ–°æœ‰å¾ˆå¤šäº®ç‚¹ï¼Œéå¸¸é€‚åˆä½œä¸ºå›¢é˜Ÿæ„å»ºå·¥å…·é“¾çš„åŸºç¡€:</p><ul><li><strong>é¦–å…ˆè¿™ç±»å·¥å…·æ˜¯æ¨å´‡â€™çº¦å®šå¤§äºé…ç½®â€™</strong>ã€‚å³æŒ‰ç…§ä»–ä»¬çš„è§„èŒƒï¼Œå¯ä»¥å®ç°å¼€ç®±å³ç”¨ï¼Œå¿«é€Ÿå¼€å‘ä¸šåŠ¡. åœ¨å›¢é˜Ÿåä½œä¸­è¿™ç‚¹å¾ˆé‡è¦ï¼Œæˆ‘ä»¬ä¸æ¨èå›¢é˜Ÿæˆå‘˜å»å…³å¿ƒåˆè‡­åˆé•¿çš„webpackæ„å»ºé…ç½®</li><li><strong><code>vue-cli3</code>æŠ½ç¦»äº†<code>cli serviceå±‚</code>ï¼Œå¯ä»¥ç‹¬ç«‹æ›´æ–°å·¥å…·é“¾</strong>ã€‚ä¹Ÿå°±æ˜¯è¯´é¡¹ç›®çš„æ„å»ºè„šæœ¬å’Œé…ç½®åœ¨ä¸€ä¸ªç‹¬ç«‹çš„serviceé¡¹ç›®ä¸­ç»´æŠ¤ï¼Œè€Œä¸æ˜¯åƒä»¥å‰ä¸€æ ·åœ¨æ¯ä¸ªé¡¹ç›®ç›®å½•ä¸‹éƒ½æœ‰webpacké…ç½®å’Œä¾èµ–. è¿™æ ·åšçš„å¥½å¤„æ˜¯ç‹¬ç«‹åœ°ã€ç®€å•åœ°å‡çº§æ•´ä¸ªæ„å»ºé“¾</li><li><strong>çµæ´»çš„æ’ä»¶æœºåˆ¶</strong>ã€‚å¯¹äºå›¢é˜Ÿçš„å®šåˆ¶åŒ–æ„å»ºåº”è¯¥å°è£…åˆ°æ’ä»¶ä¸­ï¼Œè¿™æ ·ä¹Ÿå¯ä»¥å®ç°ç‹¬ç«‹çš„æ›´æ–°ã€‚</li></ul><p><strong>æˆ‘ä»¬å¯ä»¥é€‰æ‹©ç¬¬ä¸‰æ–¹CLI, å½“ç„¶ä¹Ÿå®šåˆ¶è‡ªå·±çš„æ„å»ºé“¾ï¼ŒæŒ‰ç…§ä¸Šé¢è¯´çš„è¿™ä¸ªæ„å»ºé“¾åº”è¯¥æœ‰ä»¥ä¸‹ç‰¹ç‚¹</strong>:</p><ul><li><strong>å¼ºçº¦å®šï¼Œä½“ç°å›¢é˜Ÿçš„è§„èŒƒ</strong>ã€‚é¦–å…ˆå®ƒåº”è¯¥é¿å…å›¢é˜Ÿæˆå‘˜å»å…³å¿ƒæˆ–æ›´æ”¹æ„å»ºçš„é…ç½®ç»†èŠ‚ï¼Œæš´éœ²æœ€å°åŒ–çš„é…ç½®æ¥å£ã€‚ <em>å¦å¤–æ„å»ºå·¥å…·ä¸ä»…ä»…æ˜¯æ„å»ºï¼Œé€šå¸¸å®ƒè¿˜ä¼šé›†æˆä»£ç æ£€æŸ¥ã€æµ‹è¯•ç­‰åŠŸèƒ½</em>ã€‚</li><li><strong>æ–¹ä¾¿å‡çº§</strong>ã€‚å°¤å…¶æ˜¯å›¢é˜Ÿéœ€è¦ç»´æŠ¤å¤šä¸ªé¡¹ç›®åœºæ™¯, è¿™ä¸€ç‚¹å¾ˆæœ‰æ„ä¹‰</li></ul><p>ä¸‹é¢æ˜¯ç¤¾åŒºä¸Šæ¯”è¾ƒæµè¡Œçš„æ„å»ºå·¥å…·. å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥æ ¹æ®è‡ªå·±çš„å›¢é˜Ÿæƒ…å†µå¼€å‘è‡ªå·±çš„CLI, ä½†æ˜¯ä¸‹é¢çš„å·¥å…·ä¾ç„¶å¾ˆæœ‰<em>å‚è€ƒä»·å€¼</em>ï¼š</p><ul><li><a href="https://github.com/facebook/create-react-app" target="_blank" rel="noopener">create-react-app</a> - ğŸ”¥é›¶é…ç½®å¼€å§‹Reactå¼€å‘</li><li><a href="https://cli.vuejs.org/" target="_blank" rel="noopener">vue-cli</a> - ğŸ”¥é›¶é…ç½®ã€æ¸è¿›å¢å¼ºçš„é¡¹ç›®æ„å»ºCLI</li><li><a href="https://parceljs.org/" target="_blank" rel="noopener">parcel</a> - é›¶é…ç½®çš„Webåº”ç”¨æ‰“åŒ…å·¥å…·</li><li><a href="https://github.com/fuse-box/fuse-box" target="_blank" rel="noopener">Fusebox</a> - é«˜é€Ÿæ˜“ç”¨çš„æ‰“åŒ…å·¥å…·</li><li><a href="https://github.com/developit/microbundle" target="_blank" rel="noopener">microbundle</a> - é›¶é…ç½®, åŸºäºRollupï¼Œé€‚åˆç”¨äºæ‰“åŒ…â€˜åº“â€™</li></ul><p><br></p><p><a href="#">â¬†ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="1-3-å‘å¸ƒå·¥ä½œæµè§„èŒƒ"><a href="#1-3-å‘å¸ƒå·¥ä½œæµè§„èŒƒ" class="headerlink" title="1.3 å‘å¸ƒå·¥ä½œæµè§„èŒƒ"></a>1.3 å‘å¸ƒå·¥ä½œæµè§„èŒƒ</h3><p>å‘å¸ƒå·¥ä½œæµæŒ‡çš„æ˜¯å°†â€˜è½¯ä»¶æˆå“â€™å¯¹å¤–å‘å¸ƒ(å¦‚æµ‹è¯•æˆ–ç”Ÿäº§)çš„ä¸€å¥—æµç¨‹, å°†è¿™å¥—æµç¨‹è§„èŒƒåŒ–åï¼Œå¯ä»¥å®ç°è‡ªåŠ¨åŒ–.</p><p>ä¸¾ä¸ªä¾‹å­, ä¸€ä¸ªå…¸å‹çš„å‘å¸ƒå·¥ä½œæµå¦‚ä¸‹ï¼š</p><p><img src="/images/frontend-standard/pub.png" alt></p><ul><li>ä»£ç å˜æ›´</li><li>æäº¤ä»£ç å˜æ›´åˆ°è¿œç¨‹ç‰ˆæœ¬åº“</li><li>ç¨‹åºé€šè¿‡CIæµ‹è¯•(ä¾‹å¦‚Traviså˜ç»¿)</li><li>æå‡package.jsonä¸­çš„ç‰ˆæœ¬</li><li>ç”ŸæˆCHANGELOG</li><li>æäº¤package.jsonå’ŒCHANGELOG.mdæ–‡ä»¶</li><li>æ‰“ä¸ŠTag</li><li>æ¨é€</li></ul><p>å¦‚æœä½ éµå¾ªä¸Šé¢çš„è§„èŒƒï¼Œé‚£ä¹ˆå°±å¯ä»¥åˆ©ç”¨ç¤¾åŒºä¸Šç°æœ‰çš„å·¥å…·æ¥è‡ªåŠ¨åŒ–è¿™ä¸ªæµç¨‹. è¿™äº›å·¥å…·æœ‰:</p><ul><li><a href="https://github.com/conventional-changelog/conventional-changelog/tree/master/packages/conventional-changelog-cli" target="_blank" rel="noopener">conventional-changelog-cli</a></li><li><a href="https://github.com/conventional-changelog/conventional-github-releaser" target="_blank" rel="noopener">conventional-github-releaser</a></li><li>å®é™…ä¸Šè‡ªå·±å¼€å‘ä¸€ä¸ªä¹Ÿä¸æ˜¯ç‰¹åˆ«éš¾çš„äº‹æƒ….</li></ul><p><br></p><p><a href="#">â¬†ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="1-4-æŒç»­é›†æˆ"><a href="#1-4-æŒç»­é›†æˆ" class="headerlink" title="1.4 æŒç»­é›†æˆ"></a>1.4 æŒç»­é›†æˆ</h3><p>å°†æ•´å¥—å¼€å‘å·¥ä½œæµç¡®å®šä¸‹æ¥ä¹‹å, å°±å¯ä»¥ä½¿ç”¨<code>æŒç»­é›†æˆæœåŠ¡</code>æ¥è‡ªåŠ¨åŒ–æ‰§è¡Œæ•´ä¸ªæµç¨‹ã€‚æ¯”å¦‚ä¸€ä¸ªå…¸å‹çš„CIæµç¨‹:</p><p><img src="/images/frontend-standard/ci.png" alt></p><p><strong>æŒç»­é›†æˆæ˜¯ä»€ä¹ˆï¼Œæœ‰ä»€ä¹ˆæ„ä¹‰å‘¢</strong>?</p><p>æˆ‘ä»¬éœ€è¦<code>æŒç»­é›†æˆ</code>æ‹†æˆä¸¤ä¸ªè¯åˆ†åˆ«æ¥ç†è§£, ä»€ä¹ˆæ˜¯<code>æŒç»­</code>? ä»€ä¹ˆæ˜¯<code>é›†æˆ</code>?</p><p><strong>æŒç»­(Continuous), å¯ä»¥ç†è§£ä¸ºâ€™é¢‘ç¹â€™æˆ–è€…â€˜è¿ç»­æ€§â€™</strong>. ä¸ç®¡æ˜¯æŒç»­é›†æˆè¿˜æ˜¯æ•æ·å¼€å‘æ€ç»´ã€çœ‹æ¿ï¼Œéƒ½è®¤ä¸ºâ€˜æŒç»­â€™æ˜¯å®ƒä»¬çš„åŸºç¡€ã€‚</p><p>ä¸¾ä¸€ä¸ªé€šä¿—çš„ä¾‹å­ï¼Œ<strong>æ¯”å¦‚ä»£ç æ£€æŸ¥ï¼Œâ€˜æŒç»­çš„â€™çš„ä»£ç æ£€æŸ¥å°±æ˜¯ä»£ç ä¸€å˜åŠ¨(å¦‚ä¿å­˜ï¼Œæˆ–è€…IDEå®æ—¶æ£€æŸ¥ã€æˆ–è€…æäº¤åˆ°ç‰ˆæœ¬åº“æ—¶)å°±é©¬ä¸Šæ£€æŸ¥ä»£ç ï¼Œè€Œâ€˜éæŒç»­â€™çš„ä»£ç æ£€æŸ¥å°±æ˜¯åœ¨å®Œæˆæ‰€æœ‰ç¼–ç åï¼Œå†è¿›è¡Œæ£€æŸ¥</strong>ã€‚å¯¹æ¯”ä¸¤è€…å¯ä»¥å‘ç°ï¼ŒæŒç»­æ€§çš„ä»£ç æ£€æŸ¥å¯ä»¥å°½æ—©åœ°å‘ç°é”™è¯¯ï¼Œè€Œä¸”é”™è¯¯ä¹Ÿæ¯”è¾ƒå®¹æ˜“ç†è§£å’Œå¤„ç†ï¼Œåä¹‹éæŒç»­æ€§çš„ä»£ç æ£€æŸ¥ï¼Œå¯èƒ½ä¼šå‘ç°ä¸€å †çš„é”™è¯¯ï¼Œå¤±ä¹‹æ¯«å˜è°¬ä»¥åƒé‡Œï¼Œé”™è¯¯ç›¸äº’ç‰µè¿ï¼Œæœ€ç»ˆä¼šå˜å¾—éš¾ä»¥æ”¶æ‹¾ã€‚</p><p><strong>â€˜æŒç»­â€™çš„æ¦‚å¿µï¼Œå¯ä»¥ç”¨äºè½¯ä»¶å¼€å‘çš„æ–¹æ–¹é¢é¢ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯æŠŠä¼ ç»Ÿç€‘å¸ƒå¼çš„è½¯ä»¶å¼€å‘æµç¨‹æ‰“ç¢ï¼Œå½¢æˆä¸€ä¸ªä¸ªæ›´å°çš„å¼€å‘é—­ç¯ï¼ŒæŒç»­åœ°è¾“å‡ºäº§å“ï¼ŒåŒæ—¶äº§å“ä¹ŸæŒç»­åœ°ç»™ä¸Šæ¸¸åé¦ˆå’Œçº æ­£</strong>ã€‚</p><p><img src="/images/frontend-standard/continous.png" alt></p><p><strong>é‚£ä»€ä¹ˆæ˜¯â€˜é›†æˆâ€™å‘¢</strong>ï¼Ÿç‹­ä¹‰çš„é›†æˆå¯ä»¥ç®€å•è®¤ä¸ºæ˜¯<a href="https://juejin.im/post/5d2c515d6fb9a07ead5a2bbe#heading-26" target="_blank" rel="noopener">â€˜é›†æˆæµ‹è¯•â€™</a>å§. é›†æˆæµ‹è¯•å¯ä»¥å¯¹ä»£ç é™æ€æµ‹è¯•ã€å•å…ƒæµ‹è¯•ã€é€šè¿‡å•å…ƒæµ‹è¯•åå¯ä»¥è¿›è¡Œé›†æˆæµ‹è¯•ï¼Œåœ¨åº”ç”¨ç»„æˆä¸€ä¸ªæ•´ä½“ååœ¨æ¨¡æ‹Ÿç¯å¢ƒä¸­è·‘E2Eæµ‹è¯•ç­‰ç­‰ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨è¿™é‡Œè¿›è¡Œä¸€ç³»åˆ—çš„è‡ªåŠ¨åŒ–æµ‹è¯•æ¥éªŒè¯è½¯ä»¶ç³»ç»Ÿã€‚</p><p>å¹¿ä¹‰çš„æŒç»­é›†æˆæœåŠ¡ï¼Œä¸ä»…ä»…æ˜¯æµ‹è¯•ï¼Œå®ƒè¿˜è¡ç”Ÿå‡ºå¾ˆå¤šæ¦‚å¿µï¼Œä¾‹å¦‚æŒç»­äº¤ä»˜ã€æŒç»­éƒ¨ç½²ï¼Œå¦‚ä¸‹å›¾</p><p><img src="/images/frontend-standard/devops.png" alt></p><p>OK, <strong>æ€»ç»“ä¸€ä¸‹ä¸ºä»€ä¹ˆæŒç»­é›†æˆçš„å¥½å¤„</strong>:</p><ul><li>å°½æ—©å‘ç°é”™è¯¯ï¼Œå¿«é€Ÿè¯•é”™ã€‚è¶Šæ—©å‘ç°é”™è¯¯ï¼Œå¤„ç†é”™è¯¯çš„æˆæœ¬è¶Šä½</li><li>è‡ªåŠ¨åŒ–å·¥ä½œæµï¼Œå‡å°‘äººå·¥å¹²é¢„ã€‚äººç±»æ¯”æœºå™¨å®¹æ˜“çŠ¯é”™, è€Œä¸”æœºå™¨æ“…é•¿åšé‡å¤çš„äº‹æƒ…</li></ul><p><br></p><p><strong>å¯¹äºæŒç»­é›†æˆè§„èŒƒä¸€èˆ¬ä¼šå®šä¹‰è¿™äº›å†…å®¹</strong>:</p><ul><li>æ‰§è¡Œçš„ç¯å¢ƒ. æ¯”å¦‚å®¹å™¨ã€Nodeç‰ˆæœ¬ã€æ“ä½œç³»ç»Ÿç­‰ç­‰</li><li>è§¦å‘çš„æ¡ä»¶ã€‚æ¯”å¦‚å®šæ—¶è§¦å‘ã€åœ¨å“ªä¸ªåˆ†æ”¯è§¦å‘ã€ä¼šè§¦å‘ä»€ä¹ˆä»»åŠ¡ç­‰ç­‰</li><li>æ‰§è¡Œçš„ä»»åŠ¡</li><li>åˆ’åˆ†æŒç»­é›†æˆçš„é˜¶æ®µ. æ¯”å¦‚<ul><li>æ£€æŸ¥ï¼šåŒ…æ‹¬å•å…ƒæµ‹è¯•å’Œä»£ç lint. æ‰€æœ‰pushåˆ°ç‰ˆæœ¬åº“çš„ä»£ç éƒ½ä¼šè·‘è¿™ä¸ªé˜¶æ®µ. ä¸€èˆ¬å¯ä»¥åœ¨æäº¤titleä¸­åŒ…å«[ci skip]æ¥è·³è¿‡è¿™ä¸ªé˜¶æ®µ</li><li>æ„å»º: å¯¹å‰ç«¯é¡¹ç›®è¿›è¡Œæ„å»º. åªæœ‰æ‰“ä¸Šç‰ˆæœ¬tagçš„æäº¤æˆ–releaseåˆ†æ”¯ä¼šè·‘æ„å»ºä»»åŠ¡</li><li>å‘å¸ƒ: å°†å‰ç«¯çš„æ„å»ºç»“æœè¿›è¡Œäº¤ä»˜/å‘å¸ƒ.  åªæœ‰æ‰“ä¸Šç‰ˆæœ¬tagçš„æäº¤æˆ–è€…releaseåˆ†æ”¯åœ¨æ„å»ºæˆåŠŸåä¼šè·‘å‘å¸ƒä»»åŠ¡</li></ul></li><li>å®šä¹‰æŒç»­é›†æˆè„šæœ¬æ¨¡æ¿</li></ul><p><br></p><p>å¸¸ç”¨çš„CIæœåŠ¡:</p><ul><li>Github<ul><li><a href="https://github.com/marketplace/travis-ci" target="_blank" rel="noopener">Travis CI</a></li><li><a href="https://github.com/marketplace/circleci" target="_blank" rel="noopener">CircleCI</a></li><li><a href="https://github.com/marketplace/category/continuous-integration" target="_blank" rel="noopener">å®Œæ•´åˆ—è¡¨</a></li></ul></li><li>GitLab: <a href="https://docs.gitlab.com/ee/ci/" target="_blank" rel="noopener">Gitlab-CI</a></li><li>é€šç”¨<ul><li><a href="https://jenkins.io" target="_blank" rel="noopener">Jenkins</a></li></ul></li></ul><p><br></p><p>æ‰©å±•</p><ul><li><a href="https://juejin.im/post/58f9ee860ce46300611be392" target="_blank" rel="noopener">æŒç»­é›†æˆæ˜¯ä»€ä¹ˆ</a></li></ul><p><br></p><p><a href="#">â¬†ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="1-5-ä»»åŠ¡ç®¡ç†"><a href="#1-5-ä»»åŠ¡ç®¡ç†" class="headerlink" title="1.5 ä»»åŠ¡ç®¡ç†"></a>1.5 ä»»åŠ¡ç®¡ç†</h3><p><img src="/images/frontend-standard/kanban.png" alt></p><p>ä½œä¸ºå‰ç«¯Leaderå°‘ä¸äº†ä»»åŠ¡ç®¡ç†ã€‚<strong>çœ‹æ¿æ˜¯ç›®å‰æœ€ä¸ºæµè¡Œçš„ä»»åŠ¡ç®¡ç†å·¥å…·ï¼Œå®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬äº†è§£é¡¹ç›®çš„è¿›åº¦ã€èµ„æºçš„åˆ†é…æƒ…å†µã€è¿˜åŸå¼€å‘ç°åœº</strong>.</p><p>ç¬”è€…æ¯•ä¸šç¬¬ä¸€å¹´åœ¨ä¸€å®¶å¾ˆå°çš„å¤–åŒ…å…¬å¸ä¸­å·¥ä½œï¼Œåˆç”Ÿç‰›çŠŠä¸æ€•è™ï¼Œæˆ‘ç«Ÿç„¶ç»™è€æ¿æ¨é”€èµ·äº†çœ‹æ¿å’Œæ•æ·é¡¹ç›®ç®¡ç†ï¼Œæƒ³è¦æ”¹å–„é¡¹ç›®ç®¡ç†è¿™å—æ•ˆç‡ä½ä¸‹é—®é¢˜ï¼Œè€æ¿è¡¨ç¤ºå¾ˆæ”¯æŒï¼Œä½†æ˜¯å…¶ä»–æˆå‘˜ç§¯ææ€§å¹¶ä¸é«˜, ç»“æœå½“ç„¶æ˜¯å¤±è´¥çš„ã€‚</p><p>å½“æ—¶è¿˜èµ·è‰äº†ä¸€ä»½<a href="https://github.com/ivan-94/kanban_enforcement/blob/master/README.md#%E4%BB%80%E4%B9%88%E6%98%AF%E7%9C%8B%E6%9D%BF" target="_blank" rel="noopener">â€˜çœ‹æ¿å®æ–½ç»†åˆ™â€™</a>, æ‰€ä»¥ä»»åŠ¡ç®¡ç†è¿™ä¸€å—ä¹Ÿç®—å°æœ‰å¿ƒå¾—å§.</p><p>è¯´è¯´ä¸€äº›æ¯”è¾ƒå¥½ç”¨çš„å·¥å…·å§ï¼š</p><ul><li><strong>åŸºäºissueçœ‹æ¿</strong> - å¯ä»¥åŸºäºGitlabæˆ–Githubçš„Issueæ¥åšä»»åŠ¡ç®¡ç†ï¼Œå®ƒä»¬éƒ½æ”¯æŒçœ‹æ¿ã€‚å¾ˆGeekï¼Œæ¨è</li><li><a href="https://tower.im/" target="_blank" rel="noopener"><strong>Tower</strong></a> - ä¸“é—¨åšçœ‹æ¿ä»»åŠ¡ç®¡ç†çš„ã€‚å°å›¢é˜ŸåŸºæœ¬å¤Ÿç”¨ã€‚æˆ‘ä»¬ç°åœ¨å°±ä½¿ç”¨è¿™æ¬¾äº§å“</li><li><a href="https://www.teambition.com/" target="_blank" rel="noopener"><strong>teambition</strong></a> - å’ŒTowerå·®ä¸å¤šï¼Œæ²¡æœ‰æ·±å…¥ä½¿ç”¨è¿‡</li><li><a href="https://trello.com/" target="_blank" rel="noopener"><strong>Trello</strong></a> - é¢œå€¼é«˜.</li></ul><p><br></p><p><a href="#">â¬†ï¸å›åˆ°é¡¶éƒ¨</a></p><p><br></p><h2 id="2-æŠ€æœ¯æ ˆè§„èŒƒ"><a href="#2-æŠ€æœ¯æ ˆè§„èŒƒ" class="headerlink" title="2 æŠ€æœ¯æ ˆè§„èŒƒ"></a>2 æŠ€æœ¯æ ˆè§„èŒƒ</h2><p>ç¬”è€…ç°åœ¨æ‰€åœ¨çš„å…¬å¸ä¹‹å‰å‰ç«¯æŠ€æœ¯æ ˆå°±éå¸¸æ··ä¹±ï¼ŒVueã€Reactå’ŒAngularJSä¸‰å¤§æ¡†æ¶éƒ½æœ‰, è€Œä¸”é£æ ¼ç›¸å·®ä¹Ÿå¾ˆå¤§. å½“æ—¶æˆ‘å°±æƒ³æ”¶åŒ…è£¹èµ°äºº. å…³äºæŠ€æœ¯æ ˆä¸è§„èŒƒçš„ä¸‹åœºå¯ä»¥å‚è€ƒå°åº¦çš„é£æœº: <a href="https://www.zhihu.com/question/26042167/answer/690035402" target="_blank" rel="noopener">&lt;ä¸ºä»€ä¹ˆå°åº¦çš„é£æœºé¢‘ç¹è¢«æ‘”ï¼Ÿ&gt;</a></p><p>å¾ˆå°‘æœ‰äººèƒ½ç²¾é€šè¿™ä¸‰ä¸ªæ¡†æ¶çš„ï¼Œæ›´åˆ«è¯´æ˜¯ä¸€ä¸ªå›¢é˜Ÿã€‚</p><p><strong>ä¸‰å¤§æ¡†æ¶è·Ÿç¼–ç¨‹è¯­è¨€ä¸€æ ·éƒ½æœ‰è‡ªå·±çš„è®¾è®¡å“²å­¦ï¼Œè¿™è·Ÿåº“æ˜¯ä¸ä¸€æ ·, ä¸€ä¸ªåº“çš„æ›¿æ¢æˆæœ¬å¾ˆä½ï¼›è€Œæ¡†æ¶çš„èƒŒåæ˜¯ä¸€ä¸ªæ¶æ„ã€ä¸€ä¸ªç”Ÿæ€ã€‚æ¯ä¸ªæ¡†æ¶èƒŒåç‰µæ¶‰ç€å¼€å‘æ€ç»´ã€ç”Ÿæ€ç³»ç»Ÿã€é…å¥—å·¥å…·ã€æœ€ä½³å®è·µã€æ€§èƒ½è°ƒä¼˜ã€‚è¦ç²¾é€šå’Œç†Ÿç»ƒä¸€ä¸ªæ¡†æ¶éœ€è¦ä»˜å‡ºçš„æˆæœ¬æ˜¯å¾ˆé«˜</strong>ã€‚</p><p><strong>æ‰€ä»¥è¯´å›¢é˜Ÿçš„å¼€å‘æ•ˆç‡æ˜¯åŸºäºç¨³å®šä¸”ç†Ÿç»ƒçš„æŠ€æœ¯æ ˆçš„</strong>ã€‚ç¨³å®šçš„æŠ€æœ¯æ ˆè§„èŒƒæœ‰åˆ©äºå›¢é˜Ÿåä½œå’Œæ²Ÿé€š; å¦å¤–å¦‚æœå›¢é˜Ÿç²¾é€šè¿™ä¸ªæŠ€æœ¯æ ˆï¼Œå½“å‡ºç°é—®é¢˜æˆ–è€…éœ€è¦æ·±å…¥è°ƒä¼˜, ä¼šç›¸å¯¹è½»æ¾ã€‚</p><p>å‰ç«¯æŠ€æœ¯æ ˆè§„èŒƒä¸»è¦åŒ…å«ä¸‹é¢è¿™äº›ç±»å‹:</p><ul><li>ç¼–ç¨‹è¯­è¨€ - Typescriptæˆ–Javascript</li><li>UIæ¡†æ¶åŠå…¶é…å¥—ç”Ÿæ€, ä»¥åŠå¤‡é€‰æ–¹æ¡ˆã€‚å…¶èƒŒåçš„ç”Ÿæ€éå¸¸åºå¤§:<ul><li>UIæ¡†æ¶</li><li>è·¯ç”±</li><li>çŠ¶æ€ç®¡ç†</li><li>ç»„ä»¶åº“</li><li>å›½é™…åŒ–</li><li>åŠ¨ç”»</li><li>æœåŠ¡ç«¯æ¸²æŸ“</li><li>è„šæ‰‹æ¶ã€CLIå·¥å…·</li><li>ç»„ä»¶æµ‹è¯•</li></ul></li><li>æ ·å¼. åŒ…å«äº†å‘½åè§„èŒƒã€é¢„å¤„ç†å™¨ã€æ–¹æ³•è®ºç­‰ç­‰</li><li>åŠ¨ç”»å¼•æ“</li><li>QA. åŒ…å«äº†æµ‹è¯•ã€Lintã€æ ¼å¼åŒ–å·¥å…·ã€ç›‘æ§</li><li>é¡¹ç›®æ„å»ºå·¥å…·æµ. ä¾‹å¦‚webpackã€vue-cli</li><li>åŒ…ç®¡ç†å™¨ã€‚npmã€yarn</li><li>é¡¹ç›®ç®¡ç†å·¥å…·</li><li>æ—¶é—´å¤„ç†ã€‚ä¾‹å¦‚Moment.js</li><li>æ¨¡æ¿å¼•æ“</li><li>å¼€å‘å·¥å…·</li><li>åç«¯å¼€å‘æ¡†æ¶</li><li>å·¥å…·åº“</li><li>å¼€å‘/è°ƒè¯•å·¥å…·</li><li>ç­‰ç­‰</li></ul><p>å¯ä»¥å‚è€ƒä¸€ä¸‹æˆ‘ä»¬å›¢é˜Ÿçš„<a href="https://github.com/GDJiaMi/frontend-standards/blob/master/tech-stack.md" target="_blank" rel="noopener">æŠ€æœ¯æ ˆè§„èŒƒ</a></p><p><br></p><p><a href="#">â¬†ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="2-1-æŠ€æœ¯é€‰å‹"><a href="#2-1-æŠ€æœ¯é€‰å‹" class="headerlink" title="2.1 æŠ€æœ¯é€‰å‹"></a>2.1 æŠ€æœ¯é€‰å‹</h3><p><a id="tech-select"></a></p><p><strong>å¦‚ä½•ä»é›¶å¯¹å›¢é˜Ÿçš„æŠ€æœ¯æ ˆè¿›è¡Œè§„èŒƒ, æˆ–è€…è¯´æ€ä¹ˆè¿›è¡Œé€‰å‹å‘¢</strong>ï¼Ÿä¸¾ä¸ªä¾‹å­, å…ˆç¡®å®šå¤‡é€‰é¡¹, ä½ ç°åœ¨è¦é€‰Vueè¿˜æ˜¯é€‰React(ä¸€ä¸ªå¯èƒ½å¼•èµ·è®ºæˆ˜çš„ä¸»é¢˜)ï¼Ÿ</p><p>æ°å¥½å‰å‡ å¤©åœ¨SegmentFaultå›ç­”äº†ä¸€ä¸ªé—®é¢˜: <a href="https://segmentfault.com/q/1010000019762657/a-1020000019775888" target="_blank" rel="noopener">&lt;ä»€ä¹ˆæ—¶å€™ç”¨vueä»€ä¹ˆæ—¶å€™ç”¨reactï¼Ÿ&gt;</a>, æˆ‘è®²äº†ä¸€ä¸ªæˆ‘ä»¬<strong>å‡ å¹´å‰</strong>æ˜¯å¦‚ä½•å†³å®šè¦ä½¿ç”¨Reactè¿˜æ˜¯Vueçš„ä¾‹å­(æ³¨æ„ç»“æœä¸é‡è¦ï¼)ï¼š</p><p><img src="/images/frontend-standard/vue-vs-react.png" alt></p><p><br></p><p><a href="https://www.infoq.cn/article/points-for-attention-with-technology-choice" target="_blank" rel="noopener">&lt;è°ˆè°ˆæŠ€æœ¯é€‰å‹çš„æ³¨æ„äº‹é¡¹&gt;</a>è¿™ç¯‡æ–‡ç« å†™å¾—éå¸¸å¥½ï¼Œç»™äº†æˆ‘ä¸€äº›å¯å‘ã€‚ç»“åˆä¸Šé¢çš„å›ç­”çš„ä¾‹å­, æ¥è®²ä¸€è®²åœ¨å¯¹ç›¸å…³æŠ€æœ¯è¿›è¡Œé€‰å‹çš„ä¸€äº›æ–¹æ³•(è¯„åˆ†é¡¹):</p><ul><li><p><strong>é€‰æ‹©ä½ æœ€ç†Ÿæ‚‰çš„æŠ€æœ¯</strong>ã€‚ä¸Šé¢è¯´åˆ°å›¢é˜Ÿå¦‚æœç†Ÿæ‚‰è¯¥æŠ€æœ¯ï¼Œåˆ™å¯ä»¥å¾ˆå¥½åœ°æ§åˆ¶ä½¿ç”¨è¿‡ç¨‹ä¸­çš„é£é™©ï¼Œæ–¹ä¾¿å¯¹ç¨‹åºè¿›è¡Œè°ƒä¼˜ã€‚æ‰€ä»¥æˆå‘˜ç†Ÿæ‚‰ã€æˆ–è‡³å°‘Leaderç†Ÿæ‚‰ç¨‹åº¦ï¼Œæ˜¯æŠ€æœ¯é€‰å‹çš„ä¸€ä¸ªæ‰“åˆ†é¡¹ã€‚</p><p>æˆ‘ä»¬å›¢é˜Ÿæœ€ç»ˆé€‰æ‹©Reactçš„ä¸€ä¸ªåŸå› ï¼Œå°±æ˜¯æˆ‘ä»¬ç†Ÿæ‚‰å®ƒï¼Œå®ƒå·²ç»åœ¨ç°æœ‰çš„å‡ ä¸ªåº”ç”¨ä¸­è‰¯å¥½çš„è¿è¡Œäº†ï¼Œæ‰€ä»¥ React + 1</p></li><li><p><strong>é€‰æ‹©æ‹¥æœ‰å¼ºå¤§ç”Ÿæ€å’Œç¤¾åŒºæ”¯æ’‘çš„å¼€æºæŠ€æœ¯</strong>ã€‚æœ‰å¼ºå¤§çš„ç”Ÿæ€å’Œç¤¾åŒºæ„å‘³ç€ï¼Œå¾ˆå¤šä¸œè¥¿ä½ ä¸éœ€è¦é‡å¤å»é€ è½®å­ï¼Œæˆ–è€…é‡åˆ°é—®é¢˜å¯ä»¥å¾ˆå¿«è§£å†³ï¼Œæœ‰æ›´å¤šçš„é€‰æ‹©ã€‚ä»å…¬å¸å±‚é¢ã€ä½¿ç”¨æ´»è·ƒçš„æŠ€æœ¯ä¹Ÿæ¯”è¾ƒå¥½æ‹›äººã€‚</p><p>ä¸Šé¢çš„ä¾‹å­ä¹Ÿæåˆ°äº†è¿™ç‚¹ï¼Œå‡ å¹´å‰Reactçš„ç”Ÿæ€æ˜¯å¼ºäºVueçš„ï¼Œæ‰€ä»¥ React + 1</p></li><li><p><strong>é€‰æ‹©æˆé•¿æœŸçš„æŠ€æœ¯</strong>ã€‚<a href="https://www.infoq.cn/article/points-for-attention-with-technology-choice" target="_blank" rel="noopener">&lt;è°ˆè°ˆæŠ€æœ¯é€‰å‹çš„æ³¨æ„äº‹é¡¹&gt;</a>é‡Œé¢æœ‰ä¸€å¥è¯ï¼šâ€™é€‰æ‹©ä¸€ä¸ªæŠ€æœ¯çš„æœ€ä½æ ‡å‡†æ˜¯ï¼ŒæŠ€æœ¯çš„ç”Ÿå‘½å‘¨æœŸå¿…é¡»æ˜¾è‘—é•¿äºé¡¹ç›®çš„ç”Ÿå‘½å‘¨æœŸâ€™</p><p> æˆ‘ä»¬é€‰æ‹©çš„æŠ€æœ¯åº”è¯¥æ˜¯å‘å‰å‘å±•çš„ã€é¢å‘æœªæ¥çš„, è¿™æ˜¯é€‰å‹çš„åŸºæœ¬åŸåˆ™ã€‚æ‰€ä»¥æˆ‘ä»¬ä¸€èˆ¬ä¸ä¼šå»é€‰æ‹©é‚£äº›â€™è¿‡æ°”â€™çš„æŠ€æœ¯ï¼Œæ¯”å¦‚<code>AngularJS</code>(1.x)ã€<code>Backbone</code>. å› ä¸ºç°åœ¨æœ‰æ›´å¥½çš„é€‰æ‹©ï¼Œä¸å¿…è¿‡äºä¿å®ˆã€‚</p><p> â€˜å‘å‰â€™è¿˜æ„å‘³ç€Leaderè¦èƒ½å¤Ÿé¢„åˆ¤è¯¥æŠ€æœ¯æœªæ¥èµ°å‘ï¼Œè¿™é‡Œæœ‰å¾ˆå¤šå‚è€ƒå› ç´ ï¼Œæ¯”å¦‚å¤§å‚çš„æ”¯æ’‘ã€ç›®å‰ç¤¾åŒºçš„æ´»è·ƒåº¦ã€å¼€å‘æ´»è·ƒåº¦ç­‰ç­‰</p><p> Reactã€Vueéƒ½éå¸¸æœ‰åŠ¨åŠ›ï¼Œæ¯”å¦‚Reactæœ€è¿‘çš„React Hookã€è¿˜æœ‰æœªæ¥çš„ConcurrentModeã€Async Renderingâ€¦ åœ¨è¿™ç‚¹ä¸ŠVueå’ŒReactæ‰“æˆå¹³æ‰‹å§</p></li><li><p><strong>APIçš„ç¨³å®šæ€§</strong>ã€‚æ¯”è¾ƒå…¸å‹çš„ä¾‹å­å°±æ˜¯Angularå’ŒPythonï¼ŒAPIä¸ç¨³å®šä¼šå¯¼è‡´ç¤¾åŒºçš„å‰²è£‚ï¼Œä¹Ÿä¼šå¯¼è‡´é¡¹ç›®å‡çº§æˆæœ¬å˜é«˜ã€æˆ–è€…æ— æ³•å‡çº§, æœ€ç»ˆæˆä¸ºæŠ€æœ¯å€ºã€‚</p><p>ä¸è¿‡å€¼å¾—åº†å¹¸çš„æ˜¯å› ä¸ºæœ‰è¿™ä¹ˆå¤šå†å²æ•™è®­ï¼Œç°åœ¨å¼€æºé¡¹ç›®åœ¨APIå˜æ›´ä¸Šé¢æ˜¯éå¸¸è°¨æ…çš„ï¼Œå‚è€ƒ<a href="https://juejin.im/post/5d0f64d4f265da1b67211893" target="_blank" rel="noopener">[è¯‘] Vue æœ€é»‘æš—çš„ä¸€å¤©</a>äº‹ä»¶. </p><p>è¿™ç‚¹ä¸ŠReactå’ŒVueä¾æ—§æ‰“å¹³</p></li><li><p><strong>åŸºç¡€è®¾æ–½é…åˆ</strong>ã€‚ä¸€ä¸ªæŠ€æœ¯å¾€å¾€ä¸æ˜¯å­¤ç«‹å­˜åœ¨çš„ï¼Œå®ƒéœ€è¦å’Œå…¶ä»–æŠ€æœ¯ç›¸äº’é…åˆï¼Œè¿™ç§æŠ€æœ¯ä¹‹é—´çš„èåˆåº¦ä¹Ÿæ˜¯éœ€è¦è€ƒè™‘çš„ã€‚</p><p>è¿™ä¸ªæ ¹æ®å›¢é˜Ÿä½¿ç”¨æƒ…å†µæ¥å®šï¼Œæ¯”å¦‚æˆ‘ä»¬å›¢é˜Ÿç»Ÿä¸€ä½¿ç”¨Typescriptï¼ŒVueè·ŸTypescripté…åˆä½¿ç”¨å…¶å®ä¸ç†æƒ³ï¼Œæ‰€ä»¥ React + 1</p></li><li><p><strong>ä¸šåŠ¡è€ƒè™‘</strong> <a href="https://www.infoq.cn/article/points-for-attention-with-technology-choice" target="_blank" rel="noopener">&lt;è°ˆè°ˆæŠ€æœ¯é€‰å‹çš„æ³¨æ„äº‹é¡¹&gt;</a> æåˆ°ä¸€ç‚¹å°±æ˜¯â€˜å­¦ä¼šä»ä¸šåŠ¡ç«¯å¼€å§‹æ€è€ƒâ€™. æ„æ€<strong>å°±æ˜¯é€‰å‹éœ€è¦å……åˆ†åœ°ç†è§£ä¸šåŠ¡ï¼Œç†è§£ç”¨æˆ·éœ€æ±‚ï¼Œå½“ä¸‹éœ€è¦è§£å†³çš„é¦–è¦é—®é¢˜ï¼Œä»¥åŠå¯èƒ½çš„é£é™©æœ‰å“ªäº›ï¼Œå†å°†ç›®æ ‡è¿›è¡Œåˆ†è§£ï¼Œè¿›è¡Œå…·ä½“çš„æŠ€æœ¯é€‰å‹ã€æ¨¡å‹è®¾è®¡ã€æ¶æ„è®¾è®¡</strong>.</p><p>ä¸€ä¸ªå…¸å‹çš„ä¾‹å­å°±æ˜¯10å¹´å‰ç«éä¸–ç•Œçš„<code>Rails</code>, åç«¯æ˜¯ä½¿ç”¨Railsè¿˜æ˜¯Java/C#/PHPè¿™äº›ä¼ ç»Ÿåç«¯æŠ€æœ¯? å¾ˆå¤šåˆåˆ›å…¬å¸(å¦‚Githubã€Gitlabã€Twitter)é€‰æ‹©äº†å‰è€…ï¼Œä»–ä»¬éœ€è¦å¿«é€Ÿå¼€å‘åŸå‹ã€å¿«é€Ÿå é¢†å¸‚åœº, Railså¼€å‘å¾ˆçˆ½å¾ˆå¿«å•Š, è¿™ç§é€‰å‹å°±æ˜¯ç¬¦åˆâ€˜ä¸šåŠ¡éœ€æ±‚çš„â€™ã€‚</p><p>é‚£ä¹ˆå‰ç«¯å¥½åƒè·Ÿä¸šåŠ¡ç¦»å¾—æœ‰ç‚¹è¿œ? éšç€â€˜å¤§å‰ç«¯â€™çš„å‘å±•ï¼Œæˆ‘ä»¬çš„å·¥ä½œå¯¹å…¬å¸ä¸šåŠ¡çš„å½±å“åªä¼šè¶Šæ¥è¶Šå¤§ã€‚</p><p>æ¯”å¦‚ä¸Šé¢æåˆ°çš„React Nativeï¼Œæˆ‘ä»¬å½“æ—¶æœ‰è€ƒè™‘åœ¨ç§»åŠ¨ç«¯åº”ç”¨React NativeæŠ€æœ¯ï¼Œå®ç°å®¢æˆ·ç«¯çš„è·¨å¹³å°ï¼Œè¿™å°±æ˜¯ä¸šåŠ¡å½±å“å•Šã€‚è¿™æ—¶å€™Reactæ˜¯ä¸æ˜¯åˆè¦ +1? åŒç†è¿˜æœ‰ä»€ä¹ˆæœåŠ¡ç«¯æ¸²æŸ“ã€Serverlessç­‰ç­‰ï¼ŒæœŸå¾…å‰ç«¯çš„åœ°ä½ä¼šè¶Šæ¥è¶Šé«˜</p></li></ul><p>ç»¼ä¸Šï¼Œåœ¨è¿™ä¸ªæ¡ˆä¾‹ä¸­ï¼ŒReactæ˜¯èƒœå‡ºçš„ã€‚</p><p>æ‰©å±•:</p><ul><li><a href="https://www.infoq.cn/article/2017/02/Technology-selection" target="_blank" rel="noopener">è°ˆè°ˆæŠ€æœ¯é€‰å‹</a></li><li><a href="https://www.infoq.cn/article/points-for-attention-with-technology-choice" target="_blank" rel="noopener">è°ˆè°ˆæŠ€æœ¯é€‰å‹çš„æ³¨æ„äº‹é¡¹</a></li></ul><p><br></p><p><a href="#">â¬†ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="2-2-è¿æ¥æ–°æŠ€æœ¯"><a href="#2-2-è¿æ¥æ–°æŠ€æœ¯" class="headerlink" title="2.2 è¿æ¥æ–°æŠ€æœ¯"></a>2.2 è¿æ¥æ–°æŠ€æœ¯</h3><p>å½“ç„¶ï¼Œå¯¹äºå›¢é˜Ÿè€Œè¨€ä¹Ÿè¦é¼“åŠ±å­¦ä¹ æ–°çš„æŠ€æœ¯ã€æ·˜æ±°æ—§çš„æŠ€æœ¯æ ˆã€‚å› ä¸ºä¸€èˆ¬è€Œè¨€æ–°çš„æŠ€æœ¯æˆ–è§£å†³æ–¹æ¡ˆï¼Œæ˜¯ä¸ºäº†æ›´é«˜çš„ç”Ÿäº§åŠ›è€Œè¯ç”Ÿçš„ã€‚<strong>å½“å›¢é˜Ÿå®¹çº³ä¸€ä¸ªæ–°çš„æŠ€æœ¯é€‰å‹éœ€è¦è€ƒè™‘ä»¥ä¸‹å‡ ç‚¹</strong>ï¼š</p><ul><li><strong>å­¦ä¹ æˆæœ¬</strong>ã€‚è€ƒè™‘å›¢é˜Ÿæˆå‘˜çš„æ¥çº³èƒ½åŠ›ã€‚å¦‚æœæˆæœ¬å°äºæ”¶è·çš„åˆ©ç›Šï¼Œåœ¨å›¢é˜Ÿé‡Œé¢æ¨è¡Œä¼°è®¡é˜»åŠ›ä¼šæ¯”è¾ƒå¤§</li><li><strong>æ”¶ç›Š</strong>ã€‚æ˜¯å¦èƒ½å¤Ÿè§£å†³å½“å‰çš„æŸäº›ç—›ç‚¹</li><li><strong>è€ƒè™‘é£é™©</strong>ã€‚ä¸€èˆ¬æˆ‘ä»¬ä¸èƒ½å°†ä¸€ä¸ªå®éªŒé˜¶æ®µçš„æŠ€æœ¯ä½¿ç”¨çš„ç”Ÿäº§ç¯å¢ƒä¸­</li></ul><p>å°±æˆ‘ä»¬å›¢é˜Ÿè€Œè¨€ï¼Œæ¯ä¸ªæˆå‘˜éƒ½æœ‰è‡ªå·±æ„Ÿå…´è¶£çš„æ–¹å‘å’Œé¢†åŸŸï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ†å·¥åˆä½œï¼Œæ¢ç´¢å„è‡ªçš„é¢†åŸŸï¼Œå†å°†æˆæœåˆ†äº«å‡ºæ¥ï¼Œå¦‚æœé è°±çš„è¯åˆ™å¯ä»¥åœ¨å®éªŒé¡¹ç›®ä¸­å…ˆè¯•éªŒä¸€ä¸‹ï¼Œæœ€åæ‰æ¨å¹¿åˆ°å…¶ä»–é¡¹ç›®.</p><p><br></p><p><a href="#">â¬†ï¸å›åˆ°é¡¶éƒ¨</a></p><p><br></p><h2 id="3-æµè§ˆå™¨å…¼å®¹è§„èŒƒ"><a href="#3-æµè§ˆå™¨å…¼å®¹è§„èŒƒ" class="headerlink" title="3 æµè§ˆå™¨å…¼å®¹è§„èŒƒ"></a>3 æµè§ˆå™¨å…¼å®¹è§„èŒƒ</h2><p>å‰ç«¯å›¢é˜Ÿåº”è¯¥æ ¹æ®é’ˆå¯¹åº”ç”¨æ‰€é¢å¯¹çš„ç”¨æˆ·æƒ…å†µã€åº”ç”¨ç±»å‹ã€å¼€å‘æˆæœ¬ã€æµè§ˆå™¨å¸‚åœºç»Ÿè®¡æ•°æ®ç­‰å› ç´ ï¼Œæ¥åˆ¶å®šè‡ªå·±çš„æµè§ˆå™¨å…¼å®¹è§„èŒƒï¼Œå¹¶å†™å…¥åº”ç”¨ä½¿ç”¨æ‰‹å†Œä¸­.</p><p><strong>æœ‰äº†æµè§ˆå™¨å…¼å®¹è§„èŒƒï¼Œå‰ç«¯å¼€å‘å’Œå…¼å®¹æ€§æµ‹è¯•å°±æœ‰ç†æœ‰æ®ï¼Œé¿å…äº‰è®®; åŒæ—¶å®ƒä¹Ÿæ˜¯å‰ç«¯å›¢é˜Ÿçš„ä¸€ç§å¯¹å¤–å£°æ˜ï¼Œé™¤éç‰¹æ®Šè¦æ±‚ï¼Œä¸ç¬¦åˆæµè§ˆå™¨å…¼å®¹è§„èŒƒçš„æµè§ˆå™¨ï¼Œå‰ç«¯å¼€å‘äººå‘˜å¯ä»¥é€‰æ‹©å¿½ç•¥</strong>ã€‚</p><p><br></p><h3 id="3-1-ç¡®å®šå…¼å®¹ç­–ç•¥"><a href="#3-1-ç¡®å®šå…¼å®¹ç­–ç•¥" class="headerlink" title="3.1 ç¡®å®šå…¼å®¹ç­–ç•¥"></a>3.1 ç¡®å®šå…¼å®¹ç­–ç•¥</h3><p><img src="/images/frontend-standard/g-p.jpg" alt></p><p><strong>æ¸è¿›å¢å¼º</strong>è¿˜æ˜¯<strong>ä¼˜é›…é™çº§</strong>. è¿™æ˜¯ä¸¤ä¸ªä¸åŒæ–¹å‘ç­–ç•¥ï¼Œ<strong>æ¸è¿›å¢å¼ºä¿è¯ä½ç‰ˆæœ¬æµè§ˆå™¨çš„ä½“éªŒï¼Œå¯¹äºæ”¯æŒæ–°ç‰¹æ€§çš„æ–°æµè§ˆå™¨æä¾›ç¨å¥½çš„ä½“éªŒ</strong>ï¼›<strong>ä¼˜é›…é™çº§åˆ™æ˜¯ç›¸åçš„ï¼Œä¸ºç°ä»£æµè§ˆå™¨æä¾›æœ€å¥½çš„ä½“éªŒï¼Œè€Œæ—§æµè§ˆå™¨åˆ™é€€è€Œæ±‚ä¹‹æ¬¡ï¼Œä¿è¯å¤§æ¦‚çš„åŠŸèƒ½</strong>.</p><p>é€‰æ‹©ä¸åŒçš„ç­–ç•¥å¯¹å‰ç«¯å¼€å‘çš„å½±å“æ˜¯æ¯”è¾ƒå¤§çš„ï¼Œä½†æ˜¯å¼€å‘è€…æ²¡æœ‰é€‰æ‹©æƒã€‚<strong>ç¡®å®šå“ªç§å…¼å®¹ç­–ç•¥ï¼Œåº”è¯¥å–å†³äºç”¨æˆ·æ¯”é‡ï¼Œå¦‚æœå¤§éƒ¨åˆ†ç”¨æˆ·ä½¿ç”¨çš„æ˜¯ç°ä»£æµè§ˆå™¨ï¼Œå°±åº”è¯¥ä½¿ç”¨ä¼˜é›…é™çº§ï¼Œåä¹‹é€‰æ‹©æ¸è¿›å¢å¼º</strong>.</p><p><br></p><p><a href="#">â¬†ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="3-2-ç¡®å®šæµè§ˆå™¨åˆ†çº§"><a href="#3-2-ç¡®å®šæµè§ˆå™¨åˆ†çº§" class="headerlink" title="3.2 ç¡®å®šæµè§ˆå™¨åˆ†çº§"></a>3.2 ç¡®å®šæµè§ˆå™¨åˆ†çº§</h3><p><img src="/images/frontend-standard/brw-levl.gif" alt></p><p>YUIå°±æ›¾æå‡ºæµè§ˆå™¨åˆ†çº§åŸåˆ™ï¼Œåˆ°ä»Šå¤©è¿™ä¸ªåŸåˆ™ä¾ç„¶é€‚ç”¨ã€‚ç®€å•è¯´å°±æ˜¯å°†æµè§ˆå™¨åˆ’åˆ†ä¸ºå¤šä¸ªç­‰çº§ï¼Œä¸åŒç­‰çº§è¡¨ç¤ºä¸åŒçš„æ”¯æŒç¨‹åº¦. æ¯”å¦‚æˆ‘ä»¬å›¢é˜Ÿå°±å°†æµè§ˆå™¨åˆ’åˆ†ä¸ºä»¥ä¸‹<a href="https://github.com/GDJiaMi/frontend-standards/blob/master/browser-compatibility.md" target="_blank" rel="noopener">ä¸‰ä¸ªç­‰çº§</a>:</p><ul><li><strong>å®Œå…¨å…¼å®¹</strong>: ä¿è¯ç™¾åˆ†ç™¾åŠŸèƒ½æ­£å¸¸</li><li><strong>éƒ¨åˆ†å…¼å®¹</strong>: åªèƒ½ä¿è¯åŠŸèƒ½ã€æ ·å¼ä¸éœ€æ±‚å¤§è‡´ä¸€è‡´ã€‚å¯¹äºä¸€äº›ä¸å½±å“ä¸»ä½“éœ€æ±‚å’ŒåŠŸèƒ½çš„bugï¼Œä¼šåšé™ä½ä¼˜å…ˆçº§å¤„ç†æˆ–è€…ä¸å¤„ç†ã€‚</li><li><strong>ä¸å…¼å®¹</strong>: ä¸è€ƒè™‘å…¼å®¹æ€§</li></ul><p>ä¸€èˆ¬è€Œè¨€, æ ¹æ®æµè§ˆå™¨å¸‚åœºåˆ†å¸ƒæƒ…å†µã€ç”¨æˆ·å æ¯”ã€å¼€å‘æˆæœ¬ç­‰å› ç´ åˆ’åˆ†ç­‰çº§.</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œä¸‹é¢æ˜¯æˆ‘ä»¬å¯¹ç®¡ç†ç³»ç»Ÿçš„å…¼å®¹è§„èŒƒ:</p><p><img src="/images/frontend-standard/cpt.png" alt></p><p><br></p><p><a href="#">â¬†ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="3-3-è·å–ç»Ÿè®¡æ•°æ®"><a href="#3-3-è·å–ç»Ÿè®¡æ•°æ®" class="headerlink" title="3.3 è·å–ç»Ÿè®¡æ•°æ®"></a>3.3 è·å–ç»Ÿè®¡æ•°æ®</h3><p><a id="brw-anly"></a></p><p><img src="/images/frontend-standard/bdtj.png" alt></p><p><br></p><p><a href="https://tongji.baidu.com/web/welcome/login" target="_blank" rel="noopener">ç™¾åº¦ç»Ÿè®¡</a>æ˜¯ä¸­æ–‡ç½‘ç«™ä½¿ç”¨æœ€ä¸ºå¹¿æ³›çš„ã€å…è´¹çš„æµé‡åˆ†æå¹³å°. å¦‚ä¸Šå›¾ï¼Œé€šè¿‡è¿™äº›ç»Ÿè®¡å¹³å°å¯ä»¥è·å–åˆ°ç»ˆç«¯çœŸå®çš„æµè§ˆå™¨ä½¿ç”¨æƒ…å†µ, ç‚¹å‡»<a href="https://tongji.baidu.com/web/demo/visit/client?siteId=5503017" target="_blank" rel="noopener">æŸ¥çœ‹ç¤ºä¾‹</a>ã€‚</p><p>å¦‚æœå…¬å¸æ²¡æœ‰å¼€å‘è‡ªå·±ç›‘æ§æœåŠ¡ï¼Œè¿˜æ˜¯å»ºè®®ä½¿ç”¨è¿™äº›å…è´¹çš„ï¼Œæœ‰å¤§å‚æ”¯æŒçš„ç›‘æ§å·¥å…·:</p><ul><li><a href="https://tongji.baidu.com/web/welcome/login" target="_blank" rel="noopener">ç™¾åº¦ç»Ÿè®¡</a></li><li><a href="https://web.umeng.com/main.php?spm=a211g2.211692.0.0.3a437d23sjzEPv&amp;c=user&amp;a=index" target="_blank" rel="noopener">å‹ç›Ÿ</a></li><li><a href="https://analytics.google.com/analytics/web/" target="_blank" rel="noopener">Google Analytics</a> éœ€è¦kxä¸Šç½‘</li></ul><p><br></p><p><strong>å¯ä»¥ä»è¿™äº›åœ°æ–¹è·å–é€šç”¨çš„æµè§ˆå™¨ç»Ÿè®¡æ•°æ®</strong>:</p><ul><li><a href="http://tongji.baidu.com/data/browser" target="_blank" rel="noopener">ç™¾åº¦æµé‡ç ”ç©¶é™¢</a>ï¼šä¸»è¦æä¾›å›½å†…æµè§ˆå™¨ç»Ÿè®¡</li><li><a href="http://gs.statcounter.com/" target="_blank" rel="noopener">statcounter</a>: å›½é™…æµè§ˆå™¨ç»Ÿè®¡</li><li><a href="https://en.wikipedia.org/wiki/Timeline_of_web_browsers" target="_blank" rel="noopener">æµè§ˆå™¨å‘å¸ƒå¹´ä»½ç»Ÿè®¡</a></li></ul><p><br></p><p><strong>ç¡®å®šæµè§ˆå™¨æ˜¯å¦æ”¯æŒæŸä¸ªç‰¹æ€§</strong>:</p><ul><li><a href="https://caniuse.com" target="_blank" rel="noopener">caniuse</a></li><li><a href="https://developer.mozilla.org/zh-CN/" target="_blank" rel="noopener">MDN</a></li></ul><p><br></p><p><a href="#">â¬†ï¸å›åˆ°é¡¶éƒ¨</a></p><p><br></p><h2 id="4-é¡¹ç›®ç»„ç»‡è§„èŒƒ"><a href="#4-é¡¹ç›®ç»„ç»‡è§„èŒƒ" class="headerlink" title="4 é¡¹ç›®ç»„ç»‡è§„èŒƒ"></a>4 é¡¹ç›®ç»„ç»‡è§„èŒƒ</h2><p>é¡¹ç›®ç»„ç»‡è§„èŒƒå®šä¹‰äº†å¦‚ä½•ç»„ç»‡ä¸€ä¸ªå‰ç«¯é¡¹ç›®, ä¾‹å¦‚é¡¹ç›®çš„å‘½åã€é¡¹ç›®çš„æ–‡ä»¶ç»“æ„ã€ç‰ˆæœ¬å·è§„èŒƒç­‰ç­‰ã€‚å°¤å…¶å¯¹äºå¼€æºé¡¹ç›®ï¼Œè§„èŒƒåŒ–çš„é¡¹ç›®ç»„ç»‡å°±æ›´é‡è¦äº†ã€‚</p><h3 id="4-1-é€šç”¨çš„é¡¹ç›®ç»„ç»‡è§„èŒƒ"><a href="#4-1-é€šç”¨çš„é¡¹ç›®ç»„ç»‡è§„èŒƒ" class="headerlink" title="4.1 é€šç”¨çš„é¡¹ç›®ç»„ç»‡è§„èŒƒ"></a>4.1 é€šç”¨çš„é¡¹ç›®ç»„ç»‡è§„èŒƒ</h3><p>ä¸€ä¸ªå…¸å‹çš„é¡¹ç›®ç»„ç»‡è§„èŒƒå¦‚ä¸‹:</p><ul><li><strong>README.md</strong>: é¡¹ç›®è¯´æ˜, è¿™ä¸ªæ˜¯æœ€é‡è¦ã€‚ä½ å¿…é¡»åœ¨è¿™é‡Œæä¾›å…³äºé¡¹ç›®çš„å…³é”®ä¿¡æ¯æˆ–è€…ç›¸å…³ä¿¡æ¯çš„å…¥å£. ä¸€èˆ¬åŒ…å«ä¸‹åˆ—ä¿¡æ¯:<ul><li>ç®€è¦æè¿°ã€é¡¹ç›®ä¸»è¦ç‰¹æ€§</li><li>è¿è¡Œç¯å¢ƒ/ä¾èµ–ã€å®‰è£…å’Œæ„å»ºã€æµ‹è¯•æŒ‡å—</li><li>ç®€å•ç¤ºä¾‹ä»£ç </li><li>æ–‡æ¡£æˆ–æ–‡æ¡£å…¥å£, å…¶ä»–ç‰ˆæœ¬æˆ–ç›¸å…³èµ„æºå…¥å£</li><li>è”ç³»æ–¹å¼ã€è®¨è®ºç¾¤</li><li>è®¸å¯ã€è´¡çŒ®/å¼€å‘æŒ‡å—</li></ul></li><li><strong>CHANGELOG.md</strong>: æ”¾ç½®æ¯ä¸ªç‰ˆæœ¬çš„å˜åŠ¨å†…å®¹, é€šå¸¸è¦æè¿°æ¯ä¸ªç‰ˆæœ¬å˜æ›´çš„å†…å®¹ã€‚æ–¹ä¾¿ä½¿ç”¨è€…ç¡®å®šåº”è¯¥ä½¿ç”¨å“ªä¸ªç‰ˆæœ¬. å…³äºCHANGELOGçš„è§„èŒƒå¯ä»¥å‚è€ƒ<a href="https://keepachangelog.com/en/1.0.0/" target="_blank" rel="noopener">keep a changelog</a></li><li><strong>package.json</strong>: å‰ç«¯é¡¹ç›®å¿…é¡». æè¿°å½“å‰çš„ç‰ˆæœ¬ã€<strong>å¯ç”¨çš„å‘½ä»¤</strong>ã€åŒ…åã€ä¾èµ–ã€ç¯å¢ƒçº¦æŸã€é¡¹ç›®é…ç½®ç­‰ä¿¡æ¯.</li><li><strong>.gitignore</strong>: å¿½ç•¥ä¸å¿…è¦çš„æ–‡ä»¶ï¼Œé¿å…å°†è‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶æäº¤åˆ°ç‰ˆæœ¬åº“</li><li><strong>.gitattributes</strong>: gité…ç½®ï¼Œæœ‰ä¸€äº›è·¨å¹³å°å·®å¼‚çš„è¡Œä¸ºå¯èƒ½éœ€è¦åœ¨è¿™é‡Œé…ç½®ä¸€ä¸‹ï¼Œå¦‚æ¢è¡Œè§„åˆ™</li><li><strong>docs/</strong>: é¡¹ç›®çš„ç»†åŒ–æ–‡æ¡£, å¯é€‰.</li><li><strong>examples/</strong>: é¡¹ç›®çš„ç¤ºä¾‹ä»£ç ï¼Œå¯é€‰.</li><li><strong>build</strong>: é¡¹ç›®å·¥å…·ç±»è„šæœ¬æ”¾ç½®åœ¨è¿™é‡Œï¼Œéå¿…é¡»ã€‚å¦‚æœä½¿ç”¨ç»Ÿä¸€æ„å»ºå·¥å…·ï¼Œåˆ™æ²¡æœ‰è¿™ä¸ªç›®å½•</li><li><strong>dist/</strong>: é¡¹ç›®æ„å»ºç»“æœè¾“å‡ºç›®å½•</li><li><strong>src/</strong>: æºä»£ç ç›®å½•</li><li><p><strong><strong>tests</strong>/</strong>: å•å…ƒæµ‹è¯•ç›®å½•. æŒ‰ç…§<a href="http://jestjs.io" target="_blank" rel="noopener">Jest</a>è§„èŒƒ, <code>__tests__</code>ç›®å½•é€šå¸¸å’Œè¢«æµ‹è¯•çš„æ¨¡å—åœ¨åŒä¸€ä¸ªçˆ¶ç›®å½•ä¸‹, ä¾‹å¦‚:</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">/src</span><br><span class="line">  __tests__/</span><br><span class="line">    index.ts</span><br><span class="line">    a.ts</span><br><span class="line">  index.ts</span><br><span class="line">  a.ts</span><br></pre></td></tr></table></figure></li><li><p><strong>tests</strong>: å…¨å±€çš„æµ‹è¯•ç›®å½•ï¼Œé€šå¸¸æ”¾åº”ç”¨çš„é›†æˆæµ‹è¯•æˆ–E2Eæµ‹è¯•ç­‰ç”¨ä¾‹</p></li><li><p><strong>.env*</strong>: é¡¹ç›®ä¸­æˆ‘ä»¬é€šå¸¸ä¼šä½¿ç”¨<code>ç¯å¢ƒå˜é‡</code>æ¥å½±å“åº”ç”¨åœ¨ä¸åŒè¿è¡Œç¯å¢ƒä¸‹çš„è¡Œä¸º. å¯ä»¥é€šè¿‡<a href="https://github.com/motdotla/dotenv" target="_blank" rel="noopener">dotEnv</a>æ¥ä»æ–‡ä»¶ä¸­è¯»å–ç¯å¢ƒå˜é‡. é€šå¸¸æœ‰ä¸‰ä¸ªæ–‡ä»¶:</p><ul><li><code>.env</code> é€šç”¨çš„ç¯å¢ƒå˜é‡</li><li><code>.env.development</code> å¼€å‘ç¯å¢ƒçš„ç¯å¢ƒå˜é‡</li><li><code>.env.production</code> ç”Ÿæˆç¯å¢ƒçš„ç¯å¢ƒå˜é‡</li></ul><p>åŸºæœ¬ä¸Šè¿™äº›æ–‡ä»¶çš„å˜åŠ¨çš„é¢‘ç‡å¾ˆå°‘ï¼Œå›¢é˜Ÿæˆå‘˜åº”è¯¥ä¸è¦éšæ„å˜åŠ¨ï¼Œä»¥å…å½±å“å…¶ä»–æˆå‘˜ã€‚æ‰€ä»¥é€šå¸¸ä¼šä½¿ç”¨<code>.env.*.local</code>æ–‡ä»¶æ¥è¦†ç›–ä¸Šè¿°çš„é…ç½®, å¦å¤–ä¼šè®¾ç½®ç‰ˆæœ¬åº“æ¥å¿½ç•¥<code>*.local</code>æ–‡ä»¶.</p></li></ul><p><br></p><p><strong>å¯¹äºå¼€æºé¡¹ç›®é€šå¸¸è¿˜åŒ…æ‹¬è¿™äº›ç›®å½•</strong>:</p><ul><li><strong>LICENSE</strong>: è¯´æ˜é¡¹ç›®è®¸å¯</li><li><strong>.github</strong>: å¼€æºè´¡çŒ®è§„èŒƒå’ŒæŒ‡å—<ul><li>CONTRIBUTING: è´¡çŒ®æŒ‡å—, è¿™é‡Œä¸€èˆ¬ä¼šè¯´æ˜è´¡çŒ®çš„è§„èŒƒã€ä»¥åŠé¡¹ç›®çš„åŸºæœ¬ç»„ç»‡ã€æ¶æ„ç­‰ä¿¡æ¯</li><li>CODE_OF_CONDUCT: è¡Œä¸ºå‡†åˆ™</li><li>COMMIT_CONVENTION: æäº¤ä¿¡æ¯è§„èŒƒï¼Œä¸Šæ–‡å·²ç»æåŠ</li><li>ISSUE_TEMPLATE: Issueçš„æ¨¡æ¿ï¼Œgithubå¯ä»¥è‡ªåŠ¨è¯†åˆ«è¿™ä¸ªæ¨¡æ¿</li><li>PULL_REQUEST_TEMPLATE: PRæ¨¡æ¿</li></ul></li></ul><p>ä»»æ„ä¸€ä¸ªä¼˜ç§€çš„å¼€æºé¡¹ç›®éƒ½æ˜¯ä½ çš„è€å¸ˆï¼Œä¾‹å¦‚<a href="https://github.com/facebook/react" target="_blank" rel="noopener">React</a>ã€<a href="https://github.com/vuejs/vue" target="_blank" rel="noopener">Vue</a>â€¦</p><p><br></p><p><a href="#">â¬†ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="4-2-ç›®å½•ç»„ç»‡çš„é£æ ¼"><a href="#4-2-ç›®å½•ç»„ç»‡çš„é£æ ¼" class="headerlink" title="4.2 ç›®å½•ç»„ç»‡çš„é£æ ¼"></a>4.2 ç›®å½•ç»„ç»‡çš„é£æ ¼</h3><p>ä¸Šé¢åªæ˜¯ä¸€ä¸ªé€šç”¨çš„é¡¹ç›®ç»„ç»‡è§„èŒƒï¼Œå…·ä½“æºä»£ç å¦‚ä½•ç»„ç»‡è¿˜å–å†³äºä½ ä»¬ä½¿ç”¨çš„æŠ€æœ¯æ ˆå’Œå›¢é˜Ÿå–œå¥½ã€‚ç½‘ä¸Šæœ‰å¾ˆå¤šæ•™ç¨‹ï¼Œå…·ä½“å¯ä»¥æœç´¢<code>æ€ä¹ˆç»„ç»‡XXé¡¹ç›®</code>. æ€»ç»“ä¸€ä¸‹é¡¹ç›®ç»„ç»‡ä¸»è¦æœ‰ä¸‰ç§é£æ ¼:</p><ul><li><p><strong>Rails-style</strong>: æŒ‰ç…§æ–‡ä»¶çš„ç±»å‹åˆ’åˆ†ä¸ºä¸åŒçš„ç›®å½•ï¼Œä¾‹å¦‚<code>components</code>ã€<code>constants</code>ã€ <code>typings</code>ã€<code>views</code>. è¿™ä¸ªæ¥æºäºRuby-on-Railsæ¡†æ¶ï¼Œå®ƒæŒ‰ç…§MVCæ¶æ„æ¥åˆ’åˆ†ä¸åŒçš„ç›®å½•ç±»å‹ï¼Œå…¸å‹çš„ç›®å½•ç»“æ„å¦‚ä¸‹:</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">app</span><br><span class="line">  models # æ¨¡å‹</span><br><span class="line">  views # è§†å›¾</span><br><span class="line">  controllers # æ§åˆ¶å™¨</span><br><span class="line">  helpers # å¸®åŠ©ç¨‹åº</span><br><span class="line">  assets  # é™æ€èµ„æº</span><br><span class="line">config     # é…ç½®</span><br><span class="line">  application.rb</span><br><span class="line">  database.yml</span><br><span class="line">  routes.rb      # è·¯ç”±æ§åˆ¶</span><br><span class="line">  locales        # å›½é™…åŒ–é…ç½®</span><br><span class="line">  environments/</span><br><span class="line">db        # æ•°æ®åº“ç›¸å…³</span><br></pre></td></tr></table></figure></li></ul><ul><li><p><strong>Domain-style</strong>:  æŒ‰ç…§ä¸€ä¸ªåŠŸèƒ½ç‰¹æ€§æˆ–ä¸šåŠ¡åˆ›å»ºå•ç‹¬çš„ç›®å½•ï¼Œè¿™ä¸ªç›®å½•å°±è¿‘åŒ…å«å¤šç§ç±»å‹çš„æ–‡ä»¶æˆ–ç›®å½•. æ¯”å¦‚ä¸€ä¸ªå…¸å‹çš„Reduxé¡¹ç›®ï¼Œæ‰€æœ‰é¡¹ç›®çš„æ–‡ä»¶å°±è¿‘æ”¾ç½®åœ¨åŒä¸€ä¸ªç›®å½•ä¸‹:</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Users/</span><br><span class="line">Home/</span><br><span class="line">  components/</span><br><span class="line">  actions.js</span><br><span class="line">  actionTypes.js</span><br><span class="line">  constants.js</span><br><span class="line">  index.js</span><br><span class="line">  model.js</span><br><span class="line">  reducer.js</span><br><span class="line">  selectors.js</span><br><span class="line">  style.css</span><br><span class="line">index.js</span><br><span class="line">rootReducer.js</span><br></pre></td></tr></table></figure></li><li><p><strong>Ducks-style</strong>: ä¼˜ç‚¹ç±»ä¼¼äºDomain-styleï¼Œä¸è¿‡æ›´å½»åº•, å®ƒé€šå¸¸å°†ç›¸å…³è”çš„å…ƒç´ å®šä¹‰åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸‹ã€‚Vueçš„å•æ–‡ä»¶ç»„ä»¶å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„ä¾‹å­ï¼Œé™¤æ­¤ä¹‹å¤–Vuexä¹Ÿæ˜¯ä½¿ç”¨è¿™ç§é£æ ¼:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div id=&quot;app&quot;&gt;</span><br><span class="line">    &lt;h1&gt;My Todo App!&lt;/h1&gt;</span><br><span class="line">    &lt;TodoList/&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import TodoList from &apos;./components/TodoList.vue&apos;</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  components: &#123;</span><br><span class="line">    TodoList</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style lang=&quot;scss&quot;&gt;</span><br><span class="line">@import &apos;./variables.scss&apos;;</span><br><span class="line">/* ... */</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure></li></ul><p><br></p><p>å¤§éƒ¨åˆ†æƒ…å†µä¸‹, æˆ‘ä»¬éƒ½æ˜¯ä½¿ç”¨æ··åˆä¸¤ç§æ–¹å¼çš„ç›®å½•ç»“æ„ï¼Œä¾‹å¦‚:</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">src/</span><br><span class="line">  components/      # ğŸ”´ é¡¹ç›®é€šç”¨çš„â€˜å±•ç¤ºç»„ä»¶â€™</span><br><span class="line">    Button/</span><br><span class="line">      index.tsx    # ç»„ä»¶çš„å…¥å£, å¯¼å‡ºç»„ä»¶</span><br><span class="line">      Groups.tsx   # å­ç»„ä»¶</span><br><span class="line">      loading.svg  # é™æ€èµ„æº</span><br><span class="line">      style.css    # ç»„ä»¶æ ·å¼</span><br><span class="line">    ...</span><br><span class="line">    index.ts       # åˆ°å¤„æ‰€æœ‰ç»„ä»¶</span><br><span class="line">  containers/      # ğŸ”´ åŒ…å«'å®¹å™¨ç»„ä»¶'å’Œ'é¡µé¢ç»„ä»¶'</span><br><span class="line">    LoginPage/     # é¡µé¢ç»„ä»¶, ä¾‹å¦‚ç™»å½•</span><br><span class="line">      components/  # é¡µé¢çº§åˆ«å±•ç¤ºç»„ä»¶ï¼Œè¿™äº›ç»„ä»¶ä¸èƒ½å¤ç”¨ä¸å…¶ä»–é¡µé¢ç»„ä»¶ã€‚</span><br><span class="line">        Button.tsx # ç»„ä»¶æœªå¿…æ˜¯ä¸€ä¸ªç›®å½•å½¢å¼ï¼Œå¯¹äºä¸€ä¸ªç®€å•ç»„ä»¶å¯ä»¥æ˜¯ä¸€ä¸ªå•æ–‡ä»¶å½¢å¼. ä½†è¿˜æ˜¯æ¨èä½¿ç”¨ç›®å½•ï¼Œæ–¹ä¾¿æ‰©å±•</span><br><span class="line">        Panel.tsx</span><br><span class="line">      reducer.ts   # redux reduces</span><br><span class="line">      useLogin.ts  # (å¯é€‰)æ”¾ç½®'é€»è¾‘', æŒ‰ç…§ğŸ‘†åˆ†ç¦»é€»è¾‘å’Œè§†å›¾çš„åŸåˆ™ï¼Œå°†é€»è¾‘ã€çŠ¶æ€å¤„ç†æŠ½å–åˆ°hookæ–‡ä»¶</span><br><span class="line">      types.ts     # typescript ç±»å‹å£°æ˜</span><br><span class="line">      style.css</span><br><span class="line">      logo.png</span><br><span class="line">      message.ts</span><br><span class="line">      constants.ts</span><br><span class="line">      index.tsx</span><br><span class="line">    HomePage/</span><br><span class="line">    ...</span><br><span class="line">    index.tsx      # ğŸ”´åº”ç”¨æ ¹ç»„ä»¶</span><br><span class="line">  hooks/           # ğŸ”´å¯å¤ç”¨çš„hook</span><br><span class="line">    useList.ts</span><br><span class="line">    usePromise.ts</span><br><span class="line">  ...</span><br><span class="line">  index.tsx        # åº”ç”¨å…¥å£, åœ¨è¿™é‡Œä½¿ç”¨ReactDOMå¯¹è·Ÿç»„ä»¶è¿›è¡Œæ¸²æŸ“</span><br><span class="line">  stores.ts        # redux stores</span><br><span class="line">  contants.ts      # å…¨å±€å¸¸é‡</span><br></pre></td></tr></table></figure><p><br></p><p>æ¡†æ¶å®˜æ–¹å¾ˆå°‘ä¼šå»å¹²é¢„é¡¹ç›®çš„ç»„ç»‡æ–¹å¼ï¼Œè¯»è€…å¯ä»¥å‚è€ƒä¸‹é¢è¿™äº›èµ„æºæ¥å»ºç«‹è‡ªå·±é¡¹ç›®ç»„ç»‡è§„èŒƒ:</p><ul><li><a href="https://link.juejin.im/?target=http%3A%2F%2Fcn.redux.js.org%2Fdocs%2Ffaq%2FCodeStructure.html" target="_blank" rel="noopener">Redux å¸¸è§é—®é¢˜ï¼šä»£ç ç»“æ„</a></li><li><a href="https://link.juejin.im/?target=https%3A%2F%2Fgithub.com%2Freact-boilerplate%2Freact-boilerplate" target="_blank" rel="noopener">react-boilerplate</a></li><li><a href="https://vuex.vuejs.org/zh/guide/structure.html" target="_blank" rel="noopener">vuex é¡¹ç›®ç»“æ„</a></li><li><a href="https://juejin.im/post/5cd8fb916fb9a03218556fc1#heading-11" target="_blank" rel="noopener">Reactç»„ä»¶è®¾è®¡å®è·µæ€»ç»“02 - ç»„ä»¶çš„ç»„ç»‡</a></li></ul><p><br></p><p><a href="#">â¬†ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="4-3-è„šæ‰‹æ¶å’Œé¡¹ç›®æ¨¡æ¿"><a href="#4-3-è„šæ‰‹æ¶å’Œé¡¹ç›®æ¨¡æ¿" class="headerlink" title="4.3 è„šæ‰‹æ¶å’Œé¡¹ç›®æ¨¡æ¿"></a>4.3 è„šæ‰‹æ¶å’Œé¡¹ç›®æ¨¡æ¿</h3><p>åœ¨å°†é¡¹ç›®ç»“æ„è§„èŒƒç¡®å®šä¸‹æ¥åï¼Œå¯ä»¥åˆ›å»ºè‡ªå·±çš„è„šæ‰‹æ¶å·¥å…·æˆ–è€…é¡¹ç›®æ¨¡æ¿ï¼Œç”¨äºå¿«é€Ÿåˆå§‹åŒ–ä¸€ä¸ªé¡¹ç›®æˆ–ä»£ç æ¨¡æ¿ã€‚</p><p>ç›¸å…³èµ„æº:</p><ul><li><a href="https://yeoman.io" target="_blank" rel="noopener">yeoman</a> - è€ç‰Œçš„é¡¹ç›®è„šæ‰‹æ¶å·¥å…·</li><li><a href="https://github.com/amwmedia/plop" target="_blank" rel="noopener">plop</a> - ä»£ç ç”Ÿæˆè¾…åŠ©CLI</li><li><a href="https://github.com/jondot/hygen" target="_blank" rel="noopener">hygen</a> - ç±»ä¼¼äºplop</li><li><a href="https://github.com/diegohaz/generact" target="_blank" rel="noopener">generact</a> - ç”ŸæˆReactç»„ä»¶, å¤§éƒ¨åˆ†ç»„ä»¶çš„æ–‡ä»¶ç»“æ„å·®ä¸å¤š, è¿™ä¸ªå·¥å…·å°±æ˜¯å¸®åŠ©ä½ ç”Ÿæˆè¿™äº›é‡å¤çš„ä»£ç </li><li><a href="https://babeljs.io/docs/en/babel-generator" target="_blank" rel="noopener">babel-code-generator</a> - åˆ©ç”¨babelæ¥å®ç°æ›´é«˜çº§çš„ä»£ç ç¼–è¾‘å’Œè‡ªåŠ¨ç”Ÿæˆ</li></ul><p><br></p><p><a href="#">â¬†ï¸å›åˆ°é¡¶éƒ¨</a></p><p><br></p><h2 id="5-ç¼–ç è§„èŒƒ"><a href="#5-ç¼–ç è§„èŒƒ" class="headerlink" title="5 ç¼–ç è§„èŒƒ"></a>5 ç¼–ç è§„èŒƒ</h2><p>ç½‘ç»œä¸Šå¤§éƒ¨åˆ†â€˜å‰ç«¯è§„èŒƒâ€™æŒ‡çš„éƒ½æ˜¯ç¼–ç è§„èŒƒ, è¿™æ˜¯ä¸€ç§â€˜ç‹­ä¹‰â€™çš„å‰ç«¯è§„èŒƒ. </p><p><strong>ç»Ÿä¸€çš„ç¼–ç è§„èŒƒå¯¹å›¢é˜Ÿé¡¹ç›®çš„é•¿è¿œç»´æŠ¤ä¸æ— è£¨ç›Š. ä¸€è‡´æ€§çš„ä»£ç è§„èŒƒå¯ä»¥å¢å¼ºå›¢é˜Ÿå¼€å‘åä½œæ•ˆç‡ã€æé«˜ä»£ç è´¨é‡ã€å‡å°‘é—ç•™ç³»ç»Ÿç»´æŠ¤çš„è´Ÿæ‹…</strong>ã€‚</p><p>æœ€ç›´æ¥çš„å¥½å¤„å°±æ˜¯é¿å…å†™å‡ºç³Ÿç³•çš„ä»£ç , ç³Ÿç³•çš„ä»£ç ä¸æ–°æ‰‹å’Œè€æ‰‹å…³ç³»ä¸å¤§ï¼Œæˆ‘ä¹Ÿè§è¿‡å¥½å¤„å·¥ä½œå¾ˆå¤šå¹´çš„â€˜èµ„æ·±â€™å·¥ç¨‹å¸ˆå†™å‡ºæ¶å¿ƒçš„ä»£ç . è¿™æ ·çš„ä»£ç éšç€é¡¹ç›®çš„è¿­ä»£ä¼šå˜å¾—éš¾ä»¥æ§åˆ¶ã€‚</p><p><strong>ç°ä»£çš„Lintå·¥å…·å·²ç»éå¸¸å…ˆè¿›ï¼Œå‡ ä¹å¯ä»¥çº¦æŸå„ç§ç¼–ç è¡Œä¸º</strong>. æ¯”å¦‚çº¦æŸä¸€ä¸ªæ–‡ä»¶çš„é•¿åº¦ã€å‡½æ•°çš„å¤æ‚åº¦ã€å‘½åè§„èŒƒã€æ³¨é‡Šè§„èŒƒã€æ¥å£é»‘åå•ã€DeadCodeã€æ£€æŸ¥ç®€å•çš„é€»è¾‘é”™è¯¯â€¦</p><p>æ¯ä¸€ä¸ªç¨‹åºå‘˜å¿ƒç›®ä¸­å¯¹â€˜å¥½ä»£ç â€™éƒ½æœ‰è‡ªå·±çš„ä¸»è§ï¼Œç»Ÿä¸€çš„ç¼–ç è§„èŒƒå¯ä»¥åƒç§¦å§‹çš‡ç»Ÿä¸€æˆ˜å›½ä¸€æ ·ï¼Œé¿å…ä¸å¿…è¦çš„è®ºæˆ˜å’Œäº‰è®®ã€‚</p><p><br></p><p><strong>å…¶å®ä¸å…¶è‡ªå·±å»ºç«‹å‰ç«¯ç¼–ç è§„èŒƒï¼Œç¬”è€…æ¨èé€‰æ‹©ç¤¾åŒºæ²‰æ·€ä¸‹æ¥çš„è§„èŒƒ</strong>. è¿™æ–¹é¢çš„èµ„æºéå¸¸å¤šï¼Œæ‰€ä»¥æœ¬æ–‡ä¹Ÿä¸æ­¦æ–­åœ°æå‡ºè‡ªå·±çš„è§„èŒƒå»ºè®®. æ¨èä¸‹é¢è¿™äº›èµ„æº:</p><p><br></p><h3 id="5-1-javascript"><a href="#5-1-javascript" class="headerlink" title="5.1 Javascript"></a>5.1 Javascript</h3><ul><li>Lintå·¥å…·<ul><li><a href="https://cn.eslint.org" target="_blank" rel="noopener">ESLint</a> - ğŸ”¥ç›®å‰æ˜¯ç¤¾åŒºæœ€æµè¡Œçš„ã€é€šç”¨çš„Javascript Lintå·¥å…·ï¼ŒLintç•Œçš„Babelã€‚æ”¯æŒå®šåˆ¶æ’ä»¶ã€presetã€‚å¦‚æœä¸æƒ³æŠ˜è…¾å¯ä»¥é€‰æ‹©å®ƒçš„ä¸€äº›é¢„å®šä¹‰é…ç½®</li><li><a href="https://github.com/palantir/tslint" target="_blank" rel="noopener">TSLint</a> - Typescript Lintå·¥å…·ã€‚ä¸è¿‡å³å°†<a href="https://github.com/palantir/tslint/issues/4534" target="_blank" rel="noopener">åºŸå¼ƒ</a>äº†, æ¨èä½¿ç”¨ESLint</li></ul></li><li>è§„èŒƒ<ul><li><a href="https://standardjs.com/readme-zhcn.html#why-should-i-use-javascript-standard-style" target="_blank" rel="noopener">JavaScript Standard Style</a> - ğŸ”¥ é›¶é…ç½®çš„ã€â€˜æ ‡å‡†â€™çš„Javascriptç¼–ç è§„èŒƒ. åº•å±‚åŸºäºEslintã€‚ç›®å‰ä¸æ”¯æŒTypescript</li><li><a href="https://github.com/airbnb/javascript" target="_blank" rel="noopener">Airbnb JavaScript Style Guide</a> - Airbnbçš„ç¼–ç è§„èŒƒï¼Œä¸šç•Œæ ‡æ†</li></ul></li><li>ç±»å‹æ£€æŸ¥. æš‚æ—¶å°†å®ƒä»¬å½’ç±»åˆ°è¿™é‡Œï¼Œå› ä¸ºå®ƒä»¬åŒå±äº<a href="https://juejin.im/post/5d2c515d6fb9a07ead5a2bbe#heading-39" target="_blank" rel="noopener">â€˜é™æ€æµ‹è¯•â€™</a><ul><li><a href="https://www.typescriptlang.org" target="_blank" rel="noopener">Typescript</a> - ğŸ”¥ Javascriptè¯­è¨€çš„è¶…é›†ï¼Œè¿™æ˜¯ä¸€é—¨â€˜æ–°â€™çš„è¯­è¨€ï¼Œè€Œä¸æ˜¯ç®€å•çš„ç±»å‹æ£€æŸ¥å™¨. ä¸è¿‡<strong>å®ƒä¹Ÿæ”¯æŒ<a href="https://www.typescriptlang.org/docs/handbook/type-checking-javascript-files.html" target="_blank" rel="noopener">åŸç”ŸJavascriptçš„ç±»å‹æ£€æŸ¥</a></strong></li><li><a href="https://flow.org" target="_blank" rel="noopener">Flow</a> - Facebookå‡ºå“çš„ç±»å‹æ£€æŸ¥å™¨ï¼Œè¯­æ³•å’ŒTypescriptç±»ä¼¼. ä¸ªäººæ¨èä½¿ç”¨Typescript</li></ul></li></ul><p><br></p><p><a href="#">â¬†ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="5-2-html"><a href="#5-2-html" class="headerlink" title="5.2 HTML"></a>5.2 HTML</h3><ul><li>Lintå·¥å…·<ul><li><a href="https://htmlhint.io" target="_blank" rel="noopener">HTMLHint</a></li><li><a href="https://github.com/twbs/bootlint" target="_blank" rel="noopener">bootlint</a></li></ul></li><li>è§„èŒƒ<ul><li><a href="https://codeguide.co" target="_blank" rel="noopener">Code Guide</a></li></ul></li></ul><p><br></p><p><a href="#">â¬†ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="5-3-css"><a href="#5-3-css" class="headerlink" title="5.3 CSS"></a>5.3 CSS</h3><ul><li>Lintå·¥å…·<ul><li><a href="https://stylelint.docschina.org" target="_blank" rel="noopener">stylelint</a> - ğŸ”¥ é€šç”¨çš„CSSç¼–ç æ£€æŸ¥å·¥å…·ï¼Œæ”¯æŒæœ€æ–°çš„CSSè¯­æ³•ã€CSS-in-jsã€ä»¥åŠå…¶ä»–ç±»CSSè¯­æ³•(å¦‚SCSSã€Less). å®ƒä¹Ÿæœ‰é¢„å®šä¹‰é…ç½®ï¼Œæ¨èä½¿ç”¨</li></ul></li><li>è§„èŒƒ<ul><li><a href="https://github.com/airbnb/css" target="_blank" rel="noopener">Airbnb CSS / Sass Styleguide</a></li><li><a href="https://codeguide.co" target="_blank" rel="noopener">Code Guide</a></li><li><a href="https://css-tricks.com/css-style-guides/" target="_blank" rel="noopener">æ›´å¤š</a></li></ul></li><li>æ–¹æ³•è®º<ul><li><a href="https://css-tricks.com/bem-101/" target="_blank" rel="noopener">BEM</a> - ğŸ”¥ BEMå‘½åè§„èŒƒ</li><li><a href="https://github.com/stubbornella/oocss/wiki" target="_blank" rel="noopener">OOCSS</a></li><li><a href="http://smacss.com" target="_blank" rel="noopener">smacss</a></li></ul></li></ul><p><br></p><p>å…³äºCSSå¯ä»¥å­¦ä¹ <a href="http://twitter.github.com/bootstrap/" target="_blank" rel="noopener">Bootstrap</a>è¿™äº›ä¼ ç»ŸUIæ¡†æ¶ï¼Œä»–ä»¬çš„ä»£ç ç»„ç»‡æ€§éå¸¸å¥½, å€¼å¾—å­¦ä¹ </p><p><br></p><p><a href="#">â¬†ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="5-4-ä»£ç æ ¼å¼åŒ–"><a href="#5-4-ä»£ç æ ¼å¼åŒ–" class="headerlink" title="5.4 ä»£ç æ ¼å¼åŒ–"></a>5.4 ä»£ç æ ¼å¼åŒ–</h3><p><img src="/images/frontend-standard/prt.png" alt></p><ul><li><a href="https://prettier.io" target="_blank" rel="noopener">Prettier</a> - ğŸ”¥ å…³äºä»£ç æ ¼å¼åŒ–çš„æ‰€æœ‰ä¸œè¥¿éƒ½äº¤ç»™å®ƒå§ï¼</li></ul><p>åŸºæœ¬ä¸Šï¼Œæ‰€æœ‰ä»£ç æ ¼å¼ç›¸å…³çš„å·¥ä½œéƒ½å¯ä»¥äº¤ç»™Prettieræ¥åšï¼Œåœ¨è¿™ä¸ªåŸºç¡€ä¸Šå†ä½¿ç”¨Eslintè¦†ç›–è¯­ä¹‰ç›¸å…³çš„æ£€æŸ¥</p><p><br></p><p><a href="#">â¬†ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="5-5-é›†å¤§æˆçš„"><a href="#5-5-é›†å¤§æˆçš„" class="headerlink" title="5.5 é›†å¤§æˆçš„"></a>5.5 é›†å¤§æˆçš„</h3><ul><li><a href="https://coderlmn.github.io/code-standards/#_code_reviews" target="_blank" rel="noopener">isobar å‰ç«¯ä»£ç è§„èŒƒåŠæœ€ä½³å®è·µ</a></li><li><a href="https://guide.aotu.io/index.html" target="_blank" rel="noopener">å‡¹å‡¸å®éªŒå®¤ä»£ç è§„èŒƒ</a></li><li><a href="https://github.com/fex-team/styleguide" target="_blank" rel="noopener">ç™¾åº¦FEXè§„èŒƒ</a></li><li><a href="http://nec.netease.com/standard" target="_blank" rel="noopener">è€ç‰Œçš„NECè§„èŒƒ</a> - æœ‰ç‚¹è€</li></ul><p><br></p><p><a href="#">â¬†ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="5-6-ç‰¹å®šæ¡†æ¶é£æ ¼æŒ‡å—"><a href="#5-6-ç‰¹å®šæ¡†æ¶é£æ ¼æŒ‡å—" class="headerlink" title="5.6 ç‰¹å®šæ¡†æ¶é£æ ¼æŒ‡å—"></a>5.6 ç‰¹å®šæ¡†æ¶é£æ ¼æŒ‡å—</h3><ul><li><a href="https://vue.docschina.org/v2/style-guide/" target="_blank" rel="noopener">vue-style-guide</a></li><li><a href="https://github.com/airbnb/javascript/tree/master/react" target="_blank" rel="noopener">Airbnb React/JSX Style Guide</a></li><li><a href="https://juejin.im/post/5cd7f2c4e51d453a7d63b715" target="_blank" rel="noopener">Reactç»„ä»¶è®¾è®¡å®è·µæ€»ç»“</a> - è‡ªèä¸€ä¸‹ç¬”è€…å†™çš„Reactç»„ä»¶è®¾è®¡ç›¸å…³å®è·µ</li></ul><p><br></p><p><a href="#">â¬†ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="5-7-code-review"><a href="#5-7-code-review" class="headerlink" title="5.7 Code Review"></a>5.7 Code Review</h3><p><img src="/images/frontend-standard/code-review.png" alt></p><p>ä¸Šè¿°çš„Lintå·¥å…·å’Œç±»å‹æ£€æŸ¥å™¨, å¯ä»¥çº¦æŸä»£ç é£æ ¼ã€é¿å…ä½çº§çš„è¯­æ³•é”™è¯¯ã€‚ä½†æ˜¯å³ä½¿é€šè¿‡ä¸Šé¢çš„Lintå’Œç±»å‹æ£€æŸ¥ï¼Œä»£ç ä¹Ÿå¯èƒ½æœªå¿…æ˜¯â€˜å¥½ä»£ç â€™ã€‚</p><p><strong>å¾ˆå¤šä»£ç è®¾è®¡çš„â€˜æœ€ä½³å®è·µâ€™æ˜¯æ— æ³•é€šè¿‡å…·è±¡åŒ–çš„è‡ªåŠ¨åŒ–å·¥å…·æˆ–æ–‡æ¡£è¦†ç›–çš„, è¿™æ—¶å€™ï¼Œâ€™ç»éªŒâ€™æˆ–è€…â€™ç¾¤ä½“æ™ºæ…§â€™å°±æ´¾ä¸Šç”¨åœºäº†</strong>. æ¯”å¦‚Code Reviewé˜¶æ®µä¼šæ£€æŸ¥è¿™äº›ä¸œè¥¿:</p><ul><li>ç¼–ç¨‹åŸåˆ™ã€è®¾è®¡æ€æƒ³. ä¾‹å¦‚ç¬¦åˆSOLIDåŸåˆ™? æ˜¯å¦è¶³å¤ŸDRYï¼Ÿæ¥å£è®¾è®¡æ˜¯å¦ç®€æ´æ˜“æ‰©å±•ã€</li><li>æ¨¡å—è€¦åˆç¨‹åº¦ã€ä»£ç é‡å¤</li><li>ä»£ç å¥å£®æ€§ã€‚æ˜¯å¦å­˜åœ¨å†…å­˜æ³„éœ²ã€æ˜¯å¦çº¿ç¨‹å®‰å…¨ã€æ˜¯å¦æœ‰æ½œåœ¨æ€§èƒ½é—®é¢˜å’Œå¼‚å¸¸ã€é”™è¯¯æ˜¯å¦è¢«å¤„ç†</li><li>ä»£ç çš„æ€§èƒ½å’Œæ•ˆç‡ã€‚</li><li>æ˜¯å¦æœ‰æ²¡æœ‰è€ƒè™‘åˆ°çš„åœºæ™¯ï¼Ÿ</li></ul><p>å¦‚æœä½ ä»¬æ˜¯ç¬¬ä¸€æ¬¡æ¨è¡ŒCode Review, å¯ä»¥å»ºç«‹ä¸€ä¸ªæ£€æŸ¥åˆ—è¡¨ï¼Œå¯¹ç…§ç€è¿›è¡Œæ£€æŸ¥ã€‚ç†Ÿç»ƒåï¼Œå¿ƒä¸­è‡ªç„¶æ— ç ã€‚</p><p><br></p><p>Code Reviewæœ‰å¾ˆå¤šå¥½å¤„ï¼Œæ¯”å¦‚ï¼š</p><ul><li><strong>Code Reviewå¯ä»¥è®©å…¶ä»–æˆå‘˜éƒ½ç†Ÿæ‚‰ä»£ç </strong>ã€‚è¿™æ ·ä¿è¯å…¶ä»–äººéƒ½å¯ä»¥è¾ƒå¿«åœ°æ¥æ‰‹ä½ çš„å·¥ä½œï¼Œæˆ–è€…å¸®ä½ è§£å†³æŸäº›é—®é¢˜</li><li><strong>æé«˜ä»£ç è´¨é‡</strong>ã€‚æ¯«æ— ç–‘é—®. ä¸€æ–¹é¢æ˜¯<em>ä¸»åŠ¨æ€§</em>çš„ä»£ç è´¨é‡æå‡ï¼Œæ¯”å¦‚ä½ çš„ä»£ç éœ€è¦è¢«äººReviewï¼Œä¼šè‡ªè§‰å°½é‡çš„æé«˜ä»£ç è´¨é‡ï¼›å¦ä¸€æ–¹é¢ï¼Œå…¶ä»–æˆå‘˜å¯ä»¥æ£€æŸ¥æäº¤æ–¹çš„ä»£ç è´¨é‡</li><li><strong>æ£€æŸ¥æˆ–æé«˜æ–°æˆå‘˜çš„ç¼–ç¨‹æ°´å¹³</strong>ã€‚åŸ¹å…»æ–°äººæ—¶ï¼Œç”±äºä¸ä¿¡ä»»å®ƒä»¬æäº¤çš„ä»£ç ï¼Œæˆ‘ä»¬ä¼šåšä¸€æ¬¡Reviewæ£€æŸ¥ä»£ç æ˜¯å¦è¿‡å…³ã€‚å¦ä¸€æ–¹é¢è¿™æ˜¯ä¸€æ¬¡çœŸå®çš„æ¡ˆä¾‹è®²è§£, å¯ä»¥è¾ƒå¿«æé«˜ä»–ä»¬çš„èƒ½åŠ›</li></ul><p><br></p><p><strong>Code Reviewæœ‰ä¸¤ç§æ–¹å¼: ä¸€ä¸ª<code>æäº¤æ—¶</code>ã€ä¸€ä¸ªæ˜¯<code>å®šæ—¶</code></strong>:</p><ul><li><code>æäº¤æ—¶</code>. å¤§éƒ¨åˆ†å¼€æºé¡¹ç›®é‡‡ç”¨è¿™ç§æ–¹å¼ã€‚é€šä¿—è®²å°±æ˜¯Pull Requestã€‚åªæœ‰ä»£ç é€šè¿‡æµ‹è¯•ã€å’Œå…¶ä»–æˆå‘˜çš„Reviewæ‰å¯ä»¥åˆè¿›æ­£å¼ç‰ˆæœ¬åº“ã€‚è¿™ç§æ–¹å¼ä¹Ÿç§°ä¸ºâ€˜é˜»å¡å¼â€™ä»£ç æ£€æŸ¥ï¼Œä¸€èˆ¬é…åˆGitFlowä½¿ç”¨ã€‚</li><li><code>å®šæ—¶</code>. åœ¨é¡¹ç›®å®Œç»“åã€é¡¹ç›®çš„æŸä¸ªé‡Œç¨‹ç¢‘ã€æˆ–è€…å›ºå®šçš„æ—¶é—´(æ¯å¤©ã€æ¯ä¸ªæ˜ŸæœŸ..). å›¢é˜Ÿæˆå‘˜èšåœ¨ä¸€èµ·ï¼Œå›é¡¾è‡ªå·±å†™çš„ä»£ç , è®©å…¶ä»–æˆå‘˜è¿›è¡Œå®¡æŸ¥</li></ul><p>Code Reviewæ˜¯æ¯”è¾ƒéš¾ä»¥æ¨è¡Œçš„ï¼Œä¸è¿‡è¿™ä¸ªä¹Ÿè¦çœ‹ä½ ä»¬å›¢é˜Ÿçš„æƒ…å†µï¼Œå‘æˆ‘ä»¬é’±å°‘æ´»å¤šçš„å›¢é˜Ÿï¼Œå¾ˆå°‘çš„æ—¶é—´å»ç«‹é©¬å»å…¼é¡¾å…¶ä»–æˆå‘˜çš„ä»£ç . è¿™æ—¶å€™<code>å®šæ—¶Review</code>ä¼šæ›´æœ‰ç”¨ï¼Œå› ä¸ºçœ‹èµ·æ¥æ›´â€˜èŠ‚çœæ—¶é—´â€™.</p><p>è€Œ<code>æäº¤æ—¶Review</code>åˆ™å¯ä»¥é’ˆå¯¹æ–°äººï¼Œæ¯”å¦‚ä½ ä¸ä¿¡ä»»ä»–ä»¬çš„ä»£ç æˆ–è€…å¸Œæœ›å¸®åŠ©ä»–ä»¬æé«˜ç¼–ç èƒ½åŠ›ã€‚</p><p><br></p><p><strong>ç›¸å…³èµ„æº</strong>:</p><ul><li><a href="https://mp.weixin.qq.com/s?__biz=MzIwMTQwNTA3Nw==&amp;mid=400946871&amp;idx=1&amp;sn=5a125337833768d705f9d87ba8cd9fff&amp;scene=1&amp;srcid=0104FLyeXIS6N0EShgDseIfI&amp;key=41ecb04b051110031290b34976240e650f0169d239c89f125162a89c8d3412f2087198612e71fd7685cae9eebe08e295&amp;ascene=0&amp;uin=MTYyMDMzMTAwMA%3D%3D&amp;devicetype=iMac+MacBookPro11%2C5+OSX+OSX+10.10.5+build(14F1509" target="_blank" rel="noopener">Code Reviewæœ€ä½³å®è·µ</a>&amp;version=11020201&amp;pass_ticket=dc5bBckt1XSthRKTIsukYHIcAvKfv0jninbMlYQ5TWnE6XS%2FrRkdHKlJjNTI2Wsg)</li><li><a href="https://juejin.im/post/5c9740ba6fb9a071090d6a37" target="_blank" rel="noopener">æ˜¯å¦è¦åšCode Reviewï¼Ÿä¸BATèµ„æ·±æ¶æ„å¸ˆäº‰è®ºä¹‹åçš„æ€è€ƒ</a></li><li><a href="https://richardcao.me/2016/09/30/Talk-About-Codereview/" target="_blank" rel="noopener">ä¸€äº›Code Reviewå·¥å…·</a></li></ul><p><br></p><p><a href="#">â¬†ï¸å›åˆ°é¡¶éƒ¨</a></p><p><br></p><h2 id="6-æ–‡æ¡£è§„èŒƒ"><a href="#6-æ–‡æ¡£è§„èŒƒ" class="headerlink" title="6 æ–‡æ¡£è§„èŒƒ"></a>6 æ–‡æ¡£è§„èŒƒ</h2><p>æ–‡æ¡£å¯¹äºé¡¹ç›®å¼€å‘å’Œç»´æŠ¤ã€å­¦ä¹ ã€é‡æ„ã€ä»¥åŠçŸ¥è¯†ç®¡ç†éå¸¸é‡è¦ã€‚</p><p>å’Œå†™æµ‹è¯•ä¸€æ ·ã€å¤§éƒ¨åˆ†å¼€å‘äººå‘˜ä¼šè§‰å¾—å†™æ–‡æ¡£æ˜¯ä¸€ä»¶ç—›è‹¦çš„äº‹æƒ…ï¼Œä¸è¿‡åªæœ‰æ—¶é—´èƒ½å¤Ÿè¯æ˜å®ƒçš„ä»·å€¼ã€‚æ¯”å¦‚å¯¹äºäººå‘˜æµåŠ¨æ¯”è¾ƒå¤§çš„å…¬å¸ï¼Œå¦‚æœæœ‰è§„èŒƒçš„æ–‡æ¡£ä½“ç³»ï¼Œè½¬äº¤å·¥ä½œå°±ä¼šå˜åŠ¨éå¸¸è½»æ¾.</p><p><strong>å¹¿ä¹‰çš„æ–‡æ¡£ä¸å•æŒ‡â€˜è¯´æ˜æ–‡ä»¶â€™æœ¬èº«ï¼Œå®ƒæœ‰å¾ˆå¤šå½¢å¼ã€æ¥æºå’Œè½½ä½“ï¼Œå¯ä»¥æè¿°ä¸€ä¸ªçŸ¥è¯†ã€ä»¥åŠçŸ¥è¯†å½¢æˆå’Œè¿­ä»£çš„è¿‡ç¨‹</strong>ã€‚ä¾‹å¦‚ç‰ˆæœ¬åº“ä»£ç æäº¤è®°å½•ã€ä»£ç æ³¨é‡Šã€å†³ç­–å’Œè®¨è®ºè®°å½•ã€CHANGELOGã€ç¤ºä¾‹ä»£ç ã€è§„èŒƒã€ä¼ ç»Ÿæ–‡æ¡£ç­‰ç­‰</p><p><br></p><h3 id="6-1-å»ºç«‹æ–‡æ¡£ä¸­å¿ƒ"><a href="#6-1-å»ºç«‹æ–‡æ¡£ä¸­å¿ƒ" class="headerlink" title="6.1 å»ºç«‹æ–‡æ¡£ä¸­å¿ƒ"></a>6.1 å»ºç«‹æ–‡æ¡£ä¸­å¿ƒ</h3><p>æˆ‘ä»¬å…¬å¸æ˜¯åšIMçš„ï¼Œæ‰€ä»¥ä¹‹å‰æˆ‘ä»¬ä¼˜å…ˆä½¿ç”¨â€™è‡ªå·±çš„â€™é€šè®¯å·¥å…·æ¥åˆ†äº«æ–‡æ¡£ï¼Œè¿™ç§æ–¹å¼æœ‰å¾ˆå¤§é—®é¢˜:</p><ol><li>å¦‚æœæ²¡æœ‰å­˜æ¡£ä¹ æƒ¯(æ¯”å¦‚åç«¯çš„APIæ–‡æ¡£ï¼Œå› ä¸ºç”±åç«¯ç»´æŠ¤ï¼Œä¸€èˆ¬ä¸ä¼šä¸»åŠ¨å»å­˜æ¡£), æ–‡æ¡£å°±å¯èƒ½ä¸¢å¤±ï¼Œè€Œä¸”é€šè®¯å·¥å…·æ˜¯ä¸ä¼šæ°¸ä¹…ä¿å­˜ä½ çš„æ–‡æ¡£çš„ã€‚å½“ä¸¢å¤±æ–‡ä»¶å°±éœ€è¦é‡æ–°å’Œæ–‡æ¡£ç»´æŠ¤è€…ç´¢è¦</li><li>ç³Ÿç³•çš„æ˜¯æ–‡æ¡£ç»´æŠ¤è€…ä¹Ÿæ˜¯è‡ªå·±æ‰‹åŠ¨åœ¨æœ¬åœ°å­˜æ¡£çš„ï¼Œè¿™æ ·å¯¼è‡´çš„é—®é¢˜æ˜¯: å¦‚æœå·¥ä½œè½¬äº¤ï¼Œå…¶ä»–å¼€å‘è€…éœ€è¦èŠ±è´¹ä¸€ç‚¹æ—¶é—´æ¥æŸ¥æ‰¾; ä¸¢å¤±äº†å°±çœŸçš„æ²¡äº†</li><li>æ¯ä¸€æ¬¡æ–‡æ¡£æ›´æ–°è¦é‡æ–°å‘ä¸€ä»½, è¿™å¾ˆéº»çƒ¦ï¼Œè€Œä¸”å¯èƒ½å‡ºç°æ¼å‘çš„æƒ…å†µ, å¯¼è‡´å‰åä¸ä¸€è‡´.</li><li>å…³äºçŸ¥è¯†çš„å­¦ä¹ ã€ä»¥åŠæœ‰æ„ä¹‰çš„è®¨è®ºè®°å½•æ— æ³•å½’æ¡£ã€‚</li></ol><p>ä¸Šé¢ä»‹ç»çš„æ˜¯ä¸€ç§éå¸¸åŸå§‹çš„æ–‡æ¡£å…±äº«æ–¹å¼ï¼Œå¾ˆå¤šå°å›¢é˜Ÿå°±æ˜¯è¿™ä¹ˆå¹²çš„ã€‚</p><p><strong>å¯¹äºé¡¹ç›®æœ¬èº«çš„æ–‡æ¡£å»ºè®®æ”¾ç½®åœ¨å…³è”é¡¹ç›®ç‰ˆæœ¬åº“é‡Œé¢ï¼Œè·Ÿéšé¡¹ç›®ä»£ç è¿›è¡Œè¿­ä»£, å½“æˆ‘ä»¬åœ¨æ£€ç´¢æˆ–è·Ÿè¸ªæ–‡æ¡£çš„å†å²è®°å½•æ—¶ï¼Œè¿™ç§æ–¹å¼æ˜¯æœ€æ–¹ä¾¿çš„</strong>ã€‚</p><p>ç„¶è€Œå¾ˆå¤šåº”ç”¨æ˜¯è·¨è¶Šå¤šä¸ªå›¢é˜Ÿçš„ï¼Œæ¯ä¸ªå›¢é˜Ÿéƒ½ä¼šæœ‰è‡ªå·±çš„æ–‡æ¡£è¾“å‡º(æ¯”å¦‚éœ€æ±‚æ–‡æ¡£ã€ç³»ç»Ÿè®¾è®¡æ–‡æ¡£ã€APIæ–‡æ¡£ã€é…ç½®æ–‡æ¡£ç­‰ç­‰)ï¼Œè€Œä¸”é€šå¸¸ä¹Ÿä¸ä¼šåœ¨ä¸€ä¸ªç‰ˆæœ¬åº“é‡Œã€‚è¿™æ—¶å€™æ–‡æ¡£å°±æ¯”è¾ƒåˆ†æ•£ã€‚æ‰€ä»¥ä¸€ä¸ªç»Ÿä¸€çš„æ–‡æ¡£ä¸­å¿ƒæ˜¯å¾ˆæœ‰å¿…è¦ã€‚</p><p>æˆ‘ä»¬å…¬å¸ç°åœ¨é€‰æ‹©çš„æ–¹æ¡ˆæ˜¯<code>Git+Markdown</code>ï¼Œä¹Ÿå°±æ˜¯è¯´æ‰€æœ‰çš„æ–‡æ¡£éƒ½æ”¾ç½®åœ¨ä¸€ä¸ªgitç‰ˆæœ¬åº“ä¸‹ã€‚ä¹‹å‰ä¹Ÿè€ƒè™‘è¿‡å•†ä¸šçš„æ–¹æ¡ˆï¼Œè­¬å¦‚<a href="https://shimo.im/welcome" target="_blank" rel="noopener">çŸ³å¢¨æ–‡æ¡£</a>ã€<a href="https://docs.qq.com" target="_blank" rel="noopener">è…¾è®¯æ–‡æ¡£</a>, ä½†ç®¡ç†å±‚å¹¶ä¸ä¿¡ä»»è¿™äº›æœåŠ¡ã€‚</p><p>å¤§æ¦‚çš„gité¡¹ç›®ç»„ç»‡å¦‚ä¸‹:</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">è§„èŒƒ/</span><br><span class="line">Aåº”ç”¨/</span><br><span class="line">  äº§å“/</span><br><span class="line">  è®¾è®¡/</span><br><span class="line">  APIæ–‡æ¡£/</span><br><span class="line">  æµ‹è¯•/</span><br><span class="line">  å…¶ä»–/</span><br><span class="line">Båº”ç”¨/</span><br></pre></td></tr></table></figure><p><strong>Gitç‰ˆæœ¬åº“(ä¾‹å¦‚Gitlab)æœ‰å¾ˆå¤šä¼˜åŠ¿ï¼Œä¾‹å¦‚å†å²è®°å½•è·Ÿè¸ªã€ç‰ˆæœ¬åŒ–ã€é—®é¢˜è®¨è®º(å¯ä»¥å…³è”issueã€æˆ–è€…æäº¤)ã€å¤šäººåä½œã€æœç´¢ã€æƒé™ç®¡ç†(é’ˆå¯¹ä¸åŒçš„ç‰ˆæœ¬åº“æˆ–åˆ†ç»„ä¸ºä¸åŒäººå‘˜è®¾ç½®æƒé™)ç­‰ç­‰</strong>ã€‚</p><p><code>Git+Markdown</code>å¯ä»¥æ»¡è¶³å¼€å‘è€…çš„å¤§éƒ¨åˆ†éœ€æ±‚ã€‚ä½†æ˜¯<strong>Gitæœ€æ“…é•¿çš„æ˜¯å¤„ç†çº¯æ–‡æœ¬æ–‡ä»¶ã€å¯¹äºäºŒè¿›åˆ¶æ˜¯æ— èƒ½ä¸ºåŠ›çš„ï¼Œæ— æ³•é’ˆå¯¹è¿™äº›ç±»å‹çš„æ–‡æ¡£è¿›è¡Œåœ¨çº¿é¢„è§ˆå’Œç¼–è¾‘</strong>ã€‚</p><p>æ‰€ä»¥<code>Git+Markdown</code>å¹¶ä¸èƒ½æ»¡è¶³å¤šæ ·åŒ–çš„æ–‡æ¡£å¤„ç†éœ€æ±‚ï¼Œæ¯”å¦‚æ€ç»´å¯¼å›¾ã€å›¾è¡¨ã€è¡¨æ ¼ã€PPTã€ç™½æ¿ç­‰éœ€æ±‚. æ¯•ç«Ÿå®ƒä¸æ˜¯ä¸“ä¸šçš„æ–‡æ¡£å¤„ç†å·¥å…·ã€‚æ‰€ä»¥å¯¹äºäº§å“ã€è®¾è®¡äººå‘˜è¿™äº›å¯Œæ–‡æ¡£éœ€æ±‚åœºæ™¯ï¼Œé€šå¸¸ä¼šæŒ‰ç…§ä¼ ç»Ÿæ–¹å¼æˆ–è€…æ›´ä¸“ä¸šçš„å·¥å…·å¯¹æ–‡æ¡£è¿›è¡Œç®¡ç†.</p><p><br></p><p><a href="#">â¬†ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="6-2-æ–‡æ¡£æ ¼å¼"><a href="#6-2-æ–‡æ¡£æ ¼å¼" class="headerlink" title="6.2 æ–‡æ¡£æ ¼å¼"></a>6.2 æ–‡æ¡£æ ¼å¼</h3><p>æ¯«æ— ç–‘é—®ï¼Œå¯¹äºå¼€å‘è€…æ¥è¯´ï¼Œ<a href="https://zh.wikipedia.org/wiki/Markdown" target="_blank" rel="noopener">Markdown</a>æ˜¯æœ€é€‚åˆçš„ã€æœ€é€šç”¨çš„æ–‡æ¡£æ ¼å¼ã€‚æ”¯æŒç‰ˆæœ¬åº“åœ¨çº¿é¢„è§ˆå’Œå˜æ›´å†å²è·Ÿè¸ªã€‚</p><p>ä¸‹é¢è¿™äº›å·¥å…·å¯ä»¥æé«˜Markdownçš„å¼€å‘æ•ˆç‡:</p><ul><li>å¯è§†åŒ–ç¼–è¾‘å™¨<ul><li><strong>Visual Code</strong>: å¤§éƒ¨åˆ†ä»£ç ç¼–è¾‘éƒ½æ”¯æŒMarkdownç¼–è¾‘å’Œé¢„è§ˆ</li><li><a href="https://link.jianshu.com/?t=http://mouapp.com/" target="_blank" rel="noopener"><strong>Mou</strong></a>: Macä¸‹çš„è€ç‰Œç¼–è¾‘å™¨</li><li><a href="https://typora.io" target="_blank" rel="noopener"><strong>typora</strong></a>: è·¨å¹³å°çš„Markdownç¼–è¾‘å™¨ï¼Œæ¨è</li></ul></li><li><strong>markdownlint</strong>: ç¼–ç æ£€æŸ¥å™¨</li><li>æ‰©å±•(Visual Studio Code):<ul><li><strong>Markdown All in One</strong>: All you need to write Markdown (keyboard shortcuts, table of contents, auto preview and more)</li><li><strong>Markdown TOC</strong>: markdown ç›®å½•ç”Ÿæˆï¼Œæˆ‘æœ€å¸¸ç”¨çš„markdownæ’ä»¶</li></ul></li><li>å›¾è¡¨ç»˜åˆ¶å·¥å…·:<ul><li><a href="https://www.draw.io" target="_blank" rel="noopener"><strong>drawio</strong></a> åŸºäºWebçš„å›¾è¡¨ç»˜åˆ¶å·¥å…·ã€ä¹Ÿæœ‰ç¦»çº¿å®¢æˆ·ç«¯</li><li><strong>KeyNote/PPT</strong> ä¸´æ—¶ç»˜å›¾ä¹Ÿä¸é”™</li></ul></li></ul><p><br></p><p><a href="#">â¬†ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="6-3-å®šä¹‰æ–‡æ¡£çš„æ¨¡æ¿"><a href="#6-3-å®šä¹‰æ–‡æ¡£çš„æ¨¡æ¿" class="headerlink" title="6.3 å®šä¹‰æ–‡æ¡£çš„æ¨¡æ¿"></a>6.3 å®šä¹‰æ–‡æ¡£çš„æ¨¡æ¿</h3><p>å…³äºå¦‚ä½•å†™å¥½æ–‡æ¡£ï¼Œå¾ˆéš¾é€šè¿‡æ ‡å‡†æˆ–è§„èŒƒæ¥è¿›è¡Œçº¦æŸï¼Œå› ä¸ºå®ƒçš„ä¸»è§‚æ€§æ¯”è¾ƒå¼º, å¥½çš„æ–‡æ¡£å–å†³äºç¼–è¾‘è€…çš„é€»è¾‘æ€»ç»“èƒ½åŠ›ã€è¡¨è¾¾èƒ½åŠ›ã€ä»¥åŠæœ‰æ²¡æœ‰ç«™åœ¨è¯»è€…çš„è§’åº¦å»æ€è€ƒé—®é¢˜ã€‚</p><p>æ‰€ä»¥å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºä¸åŒç±»å‹çš„æ–‡æ¡£æä¾›ä¸€ä¸ªæ¨¡æ¿ï¼Œé€šè¿‡æ¨¡æ¿æ¥è¯´æ˜ä¸€ä¸ªæ–‡æ¡£éœ€è¦åŒ…å«å“ªäº›å†…å®¹, å¯¹æ–‡æ¡£çš„ç¼–å†™è€…è¿›è¡Œå¼•å¯¼.</p><p>ä¾‹å¦‚ä¸€ä¸ªAPIæ–‡æ¡£å¯èƒ½éœ€è¦è¿™äº›å†…å®¹:</p><ul><li>æ¥å£çš„ç´¢å¼•</li><li>æ¥å£çš„ç‰ˆæœ¬ã€å˜æ›´è®°å½•</li><li>ç”¨æ³•å’Œæ•´ä½“æè¿°, è®¤è¯é‰´æƒç­‰ç­‰</li><li>æè¿°å…·ä½“çš„æ¥å£<ul><li>åŠŸèƒ½è¯´æ˜</li><li>æ–¹æ³•åç§°æˆ–è€…URI</li><li>å‚æ•°å’Œè¿”å›å€¼å®šä¹‰</li><li>è°ƒç”¨ç¤ºä¾‹</li><li>æ³¨æ„äº‹é¡¹ç­‰ç­‰</li></ul></li></ul><p>å…·ä½“è§„èŒƒå†…å®¹å› å›¢é˜Ÿè€Œå¼‚ï¼Œè¿™é‡Œç‚¹åˆ°ä¸ºæ­¢.</p><p><br></p><p>æ‰©å±•:</p><ul><li><a href="https://github.com/ruanyf/document-style-guide/blob/master/docs/reference.md" target="_blank" rel="noopener">ä¸­æ–‡æŠ€æœ¯æ–‡æ¡£çš„å†™ä½œè§„èŒƒ</a></li><li><a href="https://github.com/reactjs/rfcs/blob/master/0000-template.md" target="_blank" rel="noopener">React RFCæ¨¡æ¿</a></li></ul><p><br></p><p><a href="#">â¬†ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="6-4-è®¨è®ºå³æ–‡æ¡£"><a href="#6-4-è®¨è®ºå³æ–‡æ¡£" class="headerlink" title="6.4 è®¨è®ºå³æ–‡æ¡£"></a>6.4 è®¨è®ºå³æ–‡æ¡£</h3><p><strong>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¯¹äºä¸€ä¸ªå¼€æºé¡¹ç›®æ¥è¯´é™¤äº†å®˜æ–¹æ–‡æ¡£ï¼ŒIssuesä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„ä¿¡æ¯æ¥æºã€‚åœ¨Issueä¸­æˆ‘ä»¬å¯ä»¥è·å–å…¶ä»–å¼€å‘è€…é‡åˆ°çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆã€ç»™å®˜æ–¹åé¦ˆ/æŠ•ç¥¨ã€å…³æ³¨å®˜æ–¹çš„æœ€æ–°åŠ¨æ€ã€å’Œå…¶ä»–å¼€å‘è€…å¤´è„‘é£æš´å”‡æªèˆŒæˆ˜ç­‰ç­‰</strong>ã€‚</p><p>æ‰€ä»¥ç›¸å¯¹äºä½¿ç”¨IMï¼Œç¬”è€…æ›´æ¨èIssueè¿™ç§æ²Ÿé€šæ¨¡å¼ï¼Œå› ä¸º<strong>å®ƒæ–¹ä¾¿å½’æ¡£ç»„ç»‡ï¼Œç´¢å¼•å’ŒæŸ¥æ‰¾</strong>ã€‚è€ŒIMä¸Šçš„è®¨è®ºå°±åƒæµæ°´ä¸€æ ·ï¼Œä¸€å»ä¸å¤è¿”ã€‚</p><p>å½“ç„¶ä¸¤ç§å·¥å…·çš„é€‚ç”¨åœºæ™¯ä¸ä¸€æ ·ï¼Œä½ æ‹¿IMçš„ä½¿ç”¨æ–¹å¼æ¥ä½¿ç”¨Issueï¼ŒIssueå°±ä¼šå˜å¾—å¾ˆæ°´ã€‚<strong>Issueé€‚åˆåšæœ‰æ„ä¹‰çš„ã€ç›®çš„æ˜ç¡®çš„è®¨è®º</strong>ã€‚ æ‰€ä»¥è¦è°´è´£ä¸€ä¸‹åœ¨Github Issueä¸ŠçŒæ°´çš„å¼€å‘è€…ã€‚</p><p>å…³äºIssueæœ‰å¾ˆå¤šå¦™ç”¨ï¼Œæ¨èé˜…è¯»è¿™ç¯‡æ–‡ç« <a href="http://www.ruanyifeng.com/blog/2017/08/issue.html" target="_blank" rel="noopener">&lt;å¦‚ä½•ä½¿ç”¨ Issue ç®¡ç†è½¯ä»¶é¡¹ç›®ï¼Ÿ&gt;</a></p><p>ç°åœ¨å¾ˆå¤šå¼€æºé¡¹ç›®éƒ½å¼•å…¥äº†RFC(è¯·æ±‚æ„è§ç¨¿)æµç¨‹(å‚è€ƒ<a href="https://www.infoq.cn/article/2017/12/react-rfc-process" target="_blank" rel="noopener">Reacté‡‡ç”¨æ–°çš„RFCæµç¨‹</a>, ä»¥åŠ<a href="https://juejin.im/post/5d0f64d4f265da1b67211893" target="_blank" rel="noopener">Vue æœ€é»‘æš—çš„ä¸€å¤©</a>), è¿™è®©å¼€å‘è€…æœ‰â€˜ç¿»èº«å†œå¥´ã€å½“å®¶åšä¸»â€™çš„æ„Ÿè§‰ï¼Œä»»ä½•äººéƒ½å¯ä»¥å‚ä¸åˆ°ä¸€ä¸ªå¼€æºé¡¹ç›®é‡å¤§äº‹ä»¶çš„å†³ç­–ä¹‹ä¸­ã€‚<strong>æ¯ä¸ªRFCä¼šè¯´æ˜å†³ç­–çš„åŠ¨æœºã€è¯¦ç»†è®¾è®¡ã€ä¼˜ç¼ºç‚¹ã€‚é™¤äº†å®˜æ–¹æ–‡æ¡£ä¹‹å¤–ï¼Œè¿™äº›RFCæ˜¯å¾ˆæœ‰ä»·å€¼çš„å­¦ä¹ èµ„æ–™</strong>ã€‚</p><p>æˆ‘è§‰å¾—å¦‚æœä¸æ¶‰åŠæœºå¯†ï¼Œå›¢é˜Ÿåº”è¯¥è¦è®©æ›´å¤šäººå‚ä¸åˆ°é¡¹ç›®çš„è®¾è®¡å’Œå†³ç­–ä¸­ï¼Œå¯¹äºæ–°æ‰‹å¯ä»¥å­¦åˆ°å¾ˆå¤šä¸œè¥¿ï¼Œè€Œå¯¹äºå‘èµ·è€…ä¹Ÿå¯èƒ½æœ‰è€ƒè™‘ä¸å‘¨çš„æƒ…å†µã€‚</p><p>é‚£å¯¹äºä¼ä¸šåº”ç”¨å¼€å‘, Issueæœ‰ç”¨å—?</p><p>å½“ç„¶æœ‰ç”¨, æ¯”å¦‚æˆ‘ä»¬å¯ä»¥å°†è¿™ç±»è¯é¢˜ä»IMè½¬ç§»åˆ°Issue:</p><ul><li>è®¾è®¡æ–¹æ¡ˆ</li><li>å†³ç­–/å»ºè®®<ul><li>æ–°åŠŸèƒ½ã€æ–°æŠ€æœ¯å¼•å…¥</li><li>é‡æ„</li><li>æ€§èƒ½ä¼˜åŒ–</li><li>è§„èŒƒ</li></ul></li><li>é—®é¢˜è®¨è®º</li><li>é‡å¤§äº‹ä»¶</li><li>è®¡åˆ’æˆ–è¿›åº¦è·Ÿè¸ª</li><li>â€¦</li></ul><p><br></p><p>å¦å¤–Issueé€šå¸¸é€šè¿‡æ ‡ç­¾æ¥è¿›è¡Œåˆ†ç±»ï¼Œæ–¹ä¾¿ç»„ç»‡å’Œæ£€ç´¢:</p><p><img src="/images/frontend-standard/issue.png" alt></p><p><br></p><p><a href="#">â¬†ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="6-5-æ³¨é‡Šå³æ–‡æ¡£"><a href="#6-5-æ³¨é‡Šå³æ–‡æ¡£" class="headerlink" title="6.5 æ³¨é‡Šå³æ–‡æ¡£"></a>6.5 æ³¨é‡Šå³æ–‡æ¡£</h3><p><strong>å¿…è¦å’Œé€‚é‡çš„æ³¨é‡Šå¯¹é˜…è¯»æºä»£ç çš„äººæ¥è¯´å°±æ˜¯ä¸€ä¸ªè·¯ç‰Œ, å¯ä»¥å°‘èµ°å¾ˆå¤šå¼¯è·¯</strong>.</p><p>å…³äºæ³¨é‡Šçš„ä¸€äº›å‡†åˆ™ï¼Œ<a href="https://github.com/alibaba/p3c/blob/master/p3c-gitbook/%E7%BC%96%E7%A8%8B%E8%A7%84%E7%BA%A6/%E6%B3%A8%E9%87%8A%E8%A7%84%E7%BA%A6.md" target="_blank" rel="noopener">&lt;é˜¿é‡Œå·´å·´Javaå¼€å‘æ‰‹å†Œ&gt;</a>æ€»ç»“å¾—éå¸¸å¥½, æ¨èåŸºäºè¿™ä¸ªæ¥å»ºç«‹æ³¨é‡Šè§„èŒƒã€‚å¦å¤–é€šè¿‡ESlintæ˜¯å¯ä»¥å¯¹æ³¨é‡Šè¿›è¡Œä¸€å®šç¨‹åº¦çš„è§„èŒƒã€‚</p><p><br></p><p><a href="#">â¬†ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="6-6-ä»£ç å³æ–‡æ¡£"><a href="#6-6-ä»£ç å³æ–‡æ¡£" class="headerlink" title="6.6 ä»£ç å³æ–‡æ¡£"></a>6.6 ä»£ç å³æ–‡æ¡£</h3><p>ç°åœ¨æœ‰å¾ˆå¤šç§å·¥å…·æ”¯æŒä»ä»£ç ä¸­è§£æå’Œç”Ÿæˆæ–‡æ¡£, è¿™å¯ä»¥ç»™å¼€å‘è€…ç®€åŒ–å¾ˆå¤šæ–‡æ¡£ç»´æŠ¤çš„å·¥ä½œã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°ä¿®æ”¹äº†ä»£ç ï¼Œä½†æ˜¯æ–‡æ¡£å¿˜è®°åŒæ­¥çš„æƒ…å†µã€‚é€šè¿‡â€˜ä»£ç å³æ–‡æ¡£â€™çš„æ–¹å¼è‡³å°‘å¯ä»¥<strong>ä¿æŒæ–‡æ¡£å’Œä»£ç åŒæ­¥æ›´æ–°</strong>ï¼›å¦å¤–<strong>å¾ˆå¤šå·¥å…·ä¼šåˆ†æä»£ç çš„æ•°æ®ç±»å‹</strong>ï¼Œè‡ªåŠ¨å¸®æˆ‘ä»¬ç”Ÿæˆå‚æ•°å’Œè¿”å›å€¼å®šä¹‰ï¼Œè¿™ä¹Ÿå¯ä»¥å‡å°‘å¾ˆå¤šæ–‡æ¡£ç¼–å†™å·¥ä½œä»¥åŠå‡ºé”™ç‡ã€‚</p><p>æ¯”å¦‚å¯ä»¥é€šè¿‡ä¸‹é¢æ³¨é‡Šæ–¹å¼æ¥ç”Ÿæˆç»„ä»¶æ–‡æ¡£:</p><figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Component &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Propsæ³¨é‡Š</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> interface ColumnProps extends React.HTMLAttributes&lt;any&gt; &#123;</span><br><span class="line">  <span class="comment">/** prop1 description */</span></span><br><span class="line">  prop1?: string;</span><br><span class="line">  <span class="comment">/** prop2 description */</span></span><br><span class="line">  prop2: number;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * prop3 description</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  prop3: <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">void</span>;</span><br><span class="line">  <span class="comment">/** prop4 description */</span></span><br><span class="line">  prop4: <span class="string">'option1'</span> | <span class="string">'option2'</span> | <span class="string">'option3'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¯¹ç»„ä»¶è¿›è¡Œæ³¨é‡Š</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Column</span> <span class="keyword">extends</span> <span class="title">Component</span>&lt;<span class="title">ColumnProps</span>, </span>&#123;&#125;&gt; &#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>Column<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>ç›¸å…³çš„å·¥å…·æœ‰:</p><ul><li>APIæ–‡æ¡£<ul><li>Typescript<ul><li><a href="https://github.com/microsoft/tsdoc" target="_blank" rel="noopener">tsdoc</a> Typescriptå®˜æ–¹çš„æ³¨é‡Šæ–‡æ¡£æ ‡å‡†</li><li><a href="https://github.com/TypeStrong/typedoc" target="_blank" rel="noopener">typedoc</a> åŸºäºtsdocæ ‡å‡†çš„æ–‡æ¡£ç”Ÿæˆå™¨</li></ul></li><li>Javascript<ul><li><a href="https://github.com/jsdoc/jsdoc" target="_blank" rel="noopener">jsdoc</a> Javascriptæ–‡æ¡£æ³¨é‡Šæ ‡å‡†å’Œç”Ÿæˆå™¨</li></ul></li></ul></li><li>åç«¯æ¥å£æ–‡æ¡£<ul><li><a href="https://swagger.io" target="_blank" rel="noopener">Swagger</a> Restfulæ¥å£æ–‡æ¡£è§„èŒƒ</li><li>GraphQL: è¿™ä¸ªæœ‰å¾ˆå¤šå·¥å…·ï¼Œä¾‹å¦‚<a href="https://github.com/graphql/graphiql" target="_blank" rel="noopener">graphiql</a>, é›†æˆäº†Playgroundå’Œæ–‡æ¡£ï¼Œå¾ˆå…ˆè¿›</li><li><a href="https://easy-mock.com/login" target="_blank" rel="noopener">Easy Mock</a> ä¸€ä¸ªå¯è§†åŒ–ï¼Œå¹¶ä¸”èƒ½å¿«é€Ÿç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®çš„æœåŠ¡</li></ul></li><li>ç»„ä»¶æ–‡æ¡£<ul><li><a href="https://storybook.js.org" target="_blank" rel="noopener">StoryBook</a> é€šç”¨çš„ç»„ä»¶å¼€å‘ã€æµ‹è¯•ã€æ–‡æ¡£å·¥å…·</li><li>React<ul><li><a href="http://docz.site" target="_blank" rel="noopener">Docz</a></li><li><a href="https://github.com/styleguidist/react-styleguidist" target="_blank" rel="noopener">Styleguidist</a></li></ul></li><li>Vue<ul><li><a href="https://github.com/vue-styleguidist/vue-styleguidist" target="_blank" rel="noopener">vue-styleguidist</a></li><li>æœ‰æ›´å¥½çš„å·¥å…·è¯·è¯„è®ºå‘Šè¯‰æˆ‘</li></ul></li></ul></li></ul><p><br></p><p><a href="#">â¬†ï¸å›åˆ°é¡¶éƒ¨</a></p><p><br></p><h2 id="7-uiè®¾è®¡è§„èŒƒ"><a href="#7-uiè®¾è®¡è§„èŒƒ" class="headerlink" title="7 UIè®¾è®¡è§„èŒƒ"></a>7 UIè®¾è®¡è§„èŒƒ</h2><p><img src="/images/frontend-standard/ui-design.png" alt></p><p>è¿™æ˜¯ä¸€ä¸ªå®¹æ˜“è¢«å¿½ç•¥çš„è§„èŒƒç±»å‹ã€‚ç¬”è€…å°±æ·±å—å…¶è‹¦ï¼Œæˆ‘ä»¬å…¬å¸åˆæœŸUIå¹¶ä¸ä¸“ä¸šï¼Œæ²¡æœ‰æ‰€è°“çš„è®¾è®¡è§„èŒƒï¼Œè¿™å°±å¯¼è‡´ä»–ä»¬è®¾è®¡å‡ºæ¥çš„äº§å“éƒ½æ˜¯ä¸œå€Ÿè¥¿å‡‘ï¼Œå‰åä¸ç»Ÿä¸€ï¼Œå¤šä¸ªåº”ç”¨ä¹‹é—´çš„ç»„ä»¶ä¸èƒ½å¤ç”¨ã€‚è¿™æå¾—æˆ‘ä»¬ä¸å¾—ä¸æµªè´¹æ—¶é—´ï¼Œå†™å¾ˆå¤šå®šåˆ¶åŒ–æ ·å¼å’Œç»„ä»¶ï¼Œä¸ºä»–ä»¬çš„ä¸ä¸“ä¸šä¹°å•.</p><p>å…³äºUIè®¾è®¡è§„èŒƒçš„é‡è¦æ€§æœ‰å…´è¶£çš„è¯»è€…å¯ä»¥çœ‹è¿™ç¯‡æ–‡ç« <a href="https://juejin.im/post/5b766ac56fb9a009aa154c27" target="_blank" rel="noopener">&lt;å¼€å‘å’Œè®¾è®¡æ²Ÿé€šæœ‰å¤šéš¾ï¼Ÿ - ä½ åªå·®ä¸€ä¸ªè®¾è®¡è§„èŒƒ&gt;</a>. </p><p>ç®€å•æ€»ç»“ä¸€ä¸‹UIè®¾è®¡è§„èŒƒçš„æ„ä¹‰ï¼š</p><ul><li>æä¾›å›¢é˜Ÿåä½œæ•ˆç‡(äº§å“å’Œå¼€å‘)</li><li>æé«˜ç»„ä»¶çš„å¤ç”¨ç‡. ç»Ÿä¸€çš„ç»„ä»¶è§„èŒƒå¯ä»¥è®©ç»„ä»¶æ›´å¥½ç®¡ç†</li><li>ä¿æŒäº§å“è¿­ä»£è¿‡ç¨‹ä¸­å“ç‰Œä¸€è‡´æ€§</li></ul><p>å»ºç«‹ä¸€ä¸ªå®šä¹‰è‰¯å¥½çš„è®¾è®¡è§„èŒƒéœ€è¦<code>UIè®¾è®¡å’Œå¼€å‘</code>çš„ç´§å¯†é…åˆï¼Œæœ‰æ—¶å€™ä¹Ÿå¯ä»¥ç”±æˆ‘ä»¬å‰ç«¯æ¥æ¨åŠ¨ã€‚</p><p>æ¯”å¦‚å¾ˆå¤šå¼€æºçš„UIæ¡†æ¶ï¼Œä¸€å¼€å§‹éƒ½æ˜¯å¼€å‘è€…YYå‡ºæ¥çš„ï¼Œå¹¶æ²¡æœ‰è®¾è®¡å‚ä¸ï¼Œåæ¥ç»„ä»¶åº“æ…¢æ…¢æ²‰æ·€æˆå‹ï¼ŒUIè®¾è®¡å¸ˆæ‰ä»‹å…¥è§„èŒƒä¸€ä¸‹ã€‚</p><p>å¦‚æœä½ ä»¬å›¢é˜Ÿä¸æ‰“ç®—åˆ¶å®šè‡ªå·±çš„UIè®¾è®¡è§„èŒƒï¼Œåˆ™æ¨èä½¿ç”¨ç°æˆçš„å¼€æºç»„ä»¶åº“ï¼š</p><ul><li><a href="https://ant.design/index-cn" target="_blank" rel="noopener">Ant Design</a></li><li><a href="https://material-ui.com" target="_blank" rel="noopener">Material-UI</a></li><li><a href="https://element.eleme.io" target="_blank" rel="noopener">Element UI</a></li><li><a href="https://weui.io" target="_blank" rel="noopener">WeUI</a></li><li><a href="https://developer.microsoft.com/en-us/fabric#/" target="_blank" rel="noopener">Microsoft Fabric</a></li></ul><p>è¿™äº›å¼€æºç»„ä»¶åº“éƒ½ç»è¿‡è‰¯å¥½çš„è®¾è®¡å’Œæ²‰æ·€, è€Œä¸”é…å¥—äº†å®Œå–„çš„è®¾è®¡åŸåˆ™ã€æœ€ä½³å®è·µå’Œè®¾è®¡èµ„æºæ–‡ä»¶ï¼ˆSketch å’Œ Axureï¼‰ï¼Œå¯ä»¥å¸®åŠ©ä¸šåŠ¡å¿«é€Ÿè®¾è®¡å‡ºé«˜è´¨é‡çš„äº§å“åŸå‹ã€‚</p><p><br></p><p><a href="#">â¬†ï¸å›åˆ°é¡¶éƒ¨</a></p><p><br></p><h2 id="8-æµ‹è¯•è§„èŒƒ"><a href="#8-æµ‹è¯•è§„èŒƒ" class="headerlink" title="8 æµ‹è¯•è§„èŒƒ"></a>8 æµ‹è¯•è§„èŒƒ</h2><p>æµ‹è¯•æ˜¯ä¿éšœä»£ç è´¨é‡çš„é‡è¦æ‰‹æ®µï¼Œä½†æ˜¯å¾ˆå°‘æœ‰äººæ„¿æ„åœ¨è¿™é‡ŒèŠ±å¤ªå¤šæ—¶é—´ã€‚</p><p>æ¯”å¦‚ç¬”è€…ï¼Œæˆ‘å¾ˆå°‘ä¼šå»ç»™ä¸šåŠ¡ä»£ç å’Œç»„ä»¶å†™å•å…ƒæµ‹è¯•ï¼Œé™¤éè‡ªå·±å¯¹ä»£ç éå¸¸æ²¡æœ‰ä¿¡å¿ƒï¼ŒæŒ‰ç…§æˆ‘çš„ç†å¿µå†™æµ‹è¯•ä¸å¦‚å°†ä»£ç å†™å¾—æ›´ç®€å•ä¸€ç‚¹ï¼Œæ¯”å¦‚æŠŠä¸€ä¸ªå‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•°ï¼Œä¿æŒå•ä¸€èŒè´£ã€‚</p><p>ä½†æ˜¯<strong>å¯¹äºä¸€äº›åº•å±‚ã€å…±äº«çš„ä»£ç æ¨¡å—è¿˜æ˜¯æœ‰æµ‹è¯•çš„å¿…è¦çš„</strong>ã€‚</p><p>æˆ‘åœ¨<a href="https://juejin.im/post/5d2c515d6fb9a07ead5a2bbe" target="_blank" rel="noopener">ä¸çŸ¥é“æµ‹è¯•ä»€ä¹ˆï¼Ÿè¿™äº›æ˜¯ä½ éœ€è¦çŸ¥é“çš„è½¯ä»¶æµ‹è¯•ç±»å‹å’Œå¸¸è¯†</a>æ–‡ç« ä¸­ï¼Œåˆ—ä¸¾äº†ä¸€äº›å¼€å‘è€…éœ€è¦å…³æ³¨çš„æµ‹è¯•ç±»å‹å’Œå¸¸è¯†, å¦‚æœæŒ‰ç…§æµ‹è¯•çš„é˜¶æ®µè¿›è¡Œåˆ†ç±»ï¼Œå¤§æ¦‚æ˜¯è¿™æ ·å­çš„:</p><p><img src="/images/frontend-standard/testing.png" alt></p><p><br></p><p>å…¶ä¸­å‰ç«¯å¼€å‘è€…éœ€è¦å…³æ³¨çš„ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§æµ‹è¯•ç±»å‹:</p><ul><li><strong>å•å…ƒæµ‹è¯•</strong>: å¯¹ç‹¬ç«‹çš„è½¯ä»¶æ¨¡å—è¿›è¡Œæµ‹è¯•<ul><li><strong>UIç»„ä»¶æµ‹è¯•</strong>: åŒ…æ‹¬äº†å¿«ç…§(Snapshot)æµ‹è¯•</li></ul></li><li><strong>é›†æˆæµ‹è¯•</strong>: åœ¨å•å…ƒæµ‹è¯•çš„åŸºç¡€ä¸Šï¼Œå°†æ¨¡å—ç»„åˆèµ·æ¥ï¼Œæµ‹è¯•å®ƒä»¬çš„ç»„åˆæ€§</li><li><strong>E2Eæµ‹è¯•</strong>: åœ¨å®Œæ•´ã€çœŸå®çš„è¿è¡Œç¯å¢ƒä¸‹æ¨¡æ‹ŸçœŸå®ç”¨æˆ·å¯¹åº”ç”¨è¿›è¡Œæµ‹è¯•ã€‚<strong>ä¸»è¦æµ‹è¯•å‰ç«¯å’Œåç«¯çš„åè°ƒæ€§</strong></li><li><strong>å…¼å®¹æ€§æµ‹è¯•</strong>: ä¸Šé¢æåˆ°äº†æµè§ˆå™¨å…¼å®¹è§„èŒƒï¼Œåœ¨å°†ç‰ˆæœ¬æäº¤ç»™æµ‹è¯•/å‘å¸ƒä¹‹å‰ï¼Œéœ€è¦ç¡®ä¿èƒ½ç¬¦åˆå…¼å®¹æ€§è¦æ±‚</li><li><strong>æ€§èƒ½æµ‹è¯•</strong>: æµ‹è¯•å’Œåˆ†ææ˜¯å¦å­˜åœ¨æ€§èƒ½é—®é¢˜</li><li><strong>å…¶ä»–</strong>:<ul><li>å®‰å…¨æµ‹è¯•</li><li>SEOæµ‹è¯•</li></ul></li></ul><p>å› ä¸ºå¯¹äºå°å…¬å¸æ¥è¯´æ•´ä¸ªè½¯ä»¶å¼€å‘æµç¨‹å¯èƒ½æ²¡æœ‰é‚£ä¹ˆè§„èŒƒï¼Œæ¯”å¦‚å¾ˆéš¾æ„å»ºä¸€ä¸ªå®Œæ•´çš„ç«¯å¯¹ç«¯æµ‹è¯•ç¯å¢ƒï¼Œè¿™äº›éƒ½ä¸æ˜¯å‰ç«¯å›¢é˜Ÿå¯ä»¥æ“ä½œçš„èŒƒå›´, æ‰€ä»¥è‡ªåŠ¨åŒ–æµ‹è¯•å¾ˆéš¾æ¨è¡Œã€‚ä½†æ˜¯å¯ä»¥æ ¹æ®å›¢é˜Ÿå’Œä¸šåŠ¡æƒ…å†µé€æ­¥è¿›è¡Œå¼€å±•ã€‚</p><p>å¯å®æ–½æ€§æ¯”è¾ƒé«˜çš„, ä¹Ÿæ¯”è¾ƒç®€å•æ˜¯å•å…ƒæµ‹è¯•ï¼Œæ‰€ä»¥æœ¬æ–‡ä¹Ÿé‡ç‚¹å…³æ³¨å•å…ƒæµ‹è¯•.</p><p><br></p><h3 id="8-1-æµ‹è¯•çš„æµç¨‹"><a href="#8-1-æµ‹è¯•çš„æµç¨‹" class="headerlink" title="8.1 æµ‹è¯•çš„æµç¨‹"></a>8.1 æµ‹è¯•çš„æµç¨‹</h3><p>é¦–å…ˆè¦å®šä¹‰ä¸€ä¸ªåˆé€‚çš„è½¯ä»¶æµ‹è¯•æµç¨‹, åˆé€‚çš„æµ‹è¯•æµç¨‹å¯ä»¥é™ä½å¼€å‘å’Œæµ‹è¯•å›¢é˜Ÿä¹‹é—´çš„æ²Ÿé€šåä½œæˆæœ¬ã€æé«˜æµ‹è¯•æ•ˆç‡ã€‚ä¾‹å¦‚æˆ‘ä»¬å›¢é˜Ÿç›®å‰çš„æµ‹è¯•æµç¨‹:</p><p><img src="/images/frontend-standard/test-proc.png" alt></p><p><br></p><p><a href="#">â¬†ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="8-2-å•å…ƒæµ‹è¯•"><a href="#8-2-å•å…ƒæµ‹è¯•" class="headerlink" title="8.2 å•å…ƒæµ‹è¯•"></a>8.2 å•å…ƒæµ‹è¯•</h3><p>å•å…ƒæµ‹è¯•æœ‰å¾ˆå¤š<strong>å¥½å¤„</strong>, æ¯”å¦‚:</p><ul><li><strong>æé«˜ä¿¡å¿ƒï¼Œé€‚åº”å˜åŒ–å’Œè¿­ä»£</strong>. å¦‚æœç°æœ‰ä»£ç æœ‰è¾ƒä¸ºå®Œå–„çš„å•å…ƒæµ‹è¯•ï¼Œåœ¨ä»£ç é‡æ„æ—¶ï¼Œå¯ä»¥æ£€éªŒæ¨¡å—æ˜¯å¦ä¾ç„¶å¯ä»¥å·¥ä½œ, ä¸€æ—¦å˜æ›´å¯¼è‡´é”™è¯¯ï¼Œå•å…ƒæµ‹è¯•ä¹Ÿå¯ä»¥å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿå®šä½å¹¶ä¿®å¤é”™è¯¯</li><li><strong>å•å…ƒæµ‹è¯•æ˜¯é›†æˆæµ‹è¯•çš„åŸºç¡€</strong></li><li><strong>æµ‹è¯•å³æ–‡æ¡£</strong>ã€‚å¦‚æœæ–‡æ¡£ä¸èƒ½è§£å†³ä½ çš„é—®é¢˜ï¼Œåœ¨ä½ æ‰“ç®—çœ‹æºç ä¹‹å‰ï¼Œå¯ä»¥æŸ¥çœ‹å•å…ƒæµ‹è¯•ã€‚é€šè¿‡è¿™äº›æµ‹è¯•ç”¨ä¾‹ï¼Œå¼€å‘äººå‘˜å¯ä»¥ç›´è§‚åœ°ç†è§£ç¨‹åºå•å…ƒçš„åŸºç¡€API</li><li><strong>æå‡ä»£ç è´¨é‡ã€‚æ˜“äºæµ‹è¯•çš„ä»£ç ï¼Œä¸€èˆ¬éƒ½æ˜¯å¥½ä»£ç </strong></li></ul><p><br></p><p><strong>æµ‹ä»€ä¹ˆ?</strong></p><p>ä¸šåŠ¡ä»£ç æˆ–ä¸šåŠ¡ç»„ä»¶æ˜¯æ¯”è¾ƒéš¾ä»¥å®æ–½å•å…ƒæµ‹è¯•çš„ï¼Œä¸€æ–¹é¢å®ƒä»¬æ¯”è¾ƒå¤šå˜ã€å¦ä¸€æ–¹é¢å¾ˆå¤šå›¢é˜Ÿå¾ˆå°‘æœ‰ç²¾åŠ›ç»´æŠ¤è¿™éƒ¨åˆ†å•å…ƒæµ‹è¯•ã€‚æ‰€ä»¥<strong>é€šå¸¸åªè¦æ±‚å¯¹ä¸€äº›åŸºç¡€/åº•å±‚çš„ç»„ä»¶ã€æ¡†æ¶æˆ–è€…æœåŠ¡è¿›è¡Œæµ‹è¯•, è§†æƒ…å†µè€ƒè™‘æ˜¯å¦è¦æµ‹è¯•ä¸šåŠ¡ä»£ç </strong></p><p><br></p><p><strong>æµ‹è¯•çš„å‡†åˆ™</strong>:</p><ul><li>æ¨èPetrowareçš„<a href="https://petroware.no/unittesting.html" target="_blank" rel="noopener">Unit Testing Guidelines</a>, æ€»ç»“äº†27æ¡å•å…ƒæµ‹è¯•å‡†åˆ™ï¼Œéå¸¸å—ç”¨.</li><li>å¦å¤–&lt;é˜¿é‡Œå·´å·´çš„Javaå¼€å‘æ‰‹å†Œ&gt;ä¸­æ€»ç»“çš„<a href="https://github.com/alibaba/p3c/blob/master/p3c-gitbook/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95.md" target="_blank" rel="noopener">å•å…ƒæµ‹è¯•å‡†åˆ™</a>, ä¹Ÿä¸é”™ï¼Œè™½ç„¶ä¹¦åæ˜¯Javaï¼Œå‡†åˆ™æ˜¯é€šç”¨çš„.</li></ul><p><br></p><p><strong>å•å…ƒæµ‹è¯•æŒ‡æ ‡</strong>:</p><p>ä¸€èˆ¬ä½¿ç”¨<a href="https://zh.wikipedia.org/wiki/ä»£ç¢¼è¦†è“‹ç‡" target="_blank" rel="noopener"><code>æµ‹è¯•è¦†ç›–ç‡</code></a>æ¥é‡åŒ–ï¼Œå°½ç®¡å¯¹äºè¦†ç›–ç‡èƒ½ä¸èƒ½è¡¡é‡å•å…ƒæµ‹è¯•çš„æœ‰æ•ˆæ€§å­˜åœ¨è¾ƒå¤šäº‰è®®ã€‚</p><p>å¤§éƒ¨åˆ†æƒ…å†µä¸‹è¿˜æ˜¯æ¨èå°½å¯èƒ½æé«˜è¦†ç›–ç‡, æ¯”å¦‚è¦æ±‚<code>è¯­å¥è¦†ç›–ç‡è¾¾åˆ°70%ï¼›æ ¸å¿ƒæ¨¡å—çš„è¯­å¥è¦†ç›–ç‡å’Œåˆ†æ”¯è¦†ç›–ç‡éƒ½è¦è¾¾åˆ°100%</code>. è§†å›¢é˜Ÿæƒ…å†µè€Œå®š</p><p>æ‰©å±•:</p><ul><li><a href="https://www.infoq.cn/article/test-coverage-rate-role" target="_blank" rel="noopener">æµ‹è¯•è¦†ç›–ï¼ˆç‡ï¼‰åˆ°åº•æœ‰ä»€ä¹ˆç”¨ï¼Ÿ</a></li></ul><p><br></p><p><strong>ç›¸å…³å·¥å…·</strong></p><ul><li>Headless Browsers: æ— å¤´æµè§ˆå™¨æ˜¯ç½‘é¡µè‡ªåŠ¨åŒ–çš„é‡è¦è¿è¡Œç¯å¢ƒã€‚ å¸¸ç”¨äºåŠŸèƒ½æµ‹è¯•ã€å•å…ƒæµ‹è¯•ã€ç½‘ç»œçˆ¬è™«<ul><li><a href="https://github.com/GoogleChrome/puppeteer" target="_blank" rel="noopener">puppeteer</a></li><li><a href="https://chromium.googlesource.com/chromium/src/+/lkgr/headless/README.md" target="_blank" rel="noopener">Headless Chromium</a></li></ul></li><li>æµ‹è¯•æ¡†æ¶<ul><li><a href="http://jest.io/" target="_blank" rel="noopener">Jest</a> ğŸ”¥Facebookçš„å•å…ƒæµ‹è¯•æ¡†æ¶. é›¶é…ç½®, æ”¯æŒç»„ä»¶å¿«ç…§æµ‹è¯•ã€æ¨¡å—Mockã€Spy. ä¸€èˆ¬åœºæ™¯, å•å…ƒæµ‹è¯•å­¦å®ƒä¸€ä¸ªå°±è¡Œäº†<ul><li>ç»„ä»¶æµ‹è¯•<ul><li><a href="https://github.com/testing-library" target="_blank" rel="noopener">testing-library</a> ğŸ”¥</li><li><a href="https://github.com/airbnb/enzyme" target="_blank" rel="noopener">Enzyme</a></li></ul></li></ul></li><li><a href="https://theintern.github.io/" target="_blank" rel="noopener">Intern</a></li></ul></li><li>å•å…ƒæµ‹è¯•<ul><li><a href="https://github.com/avajs/ava" target="_blank" rel="noopener">AVA</a></li><li><a href="http://jasmine.github.io/" target="_blank" rel="noopener">Jasmine</a></li><li><a href="http://mochajs.org/" target="_blank" rel="noopener">Mocha</a></li><li><a href="https://github.com/substack/tape" target="_blank" rel="noopener">Tape</a></li></ul></li><li>æ–­è¨€åº“<ul><li><a href="http://chaijs.com/" target="_blank" rel="noopener">Chai</a></li><li><a href="https://github.com/Automattic/expect.js" target="_blank" rel="noopener">expect.js</a></li><li><a href="http://shouldjs.github.io/" target="_blank" rel="noopener">should.js</a></li></ul></li><li>Mock/Stubs/Spies<ul><li><a href="http://sinonjs.org/" target="_blank" rel="noopener">sinon.js</a></li></ul></li><li>ä»£ç è¦†ç›–ç‡<ul><li><a href="https://github.com/gotwarlost/istanbul" target="_blank" rel="noopener">istanbul</a></li></ul></li><li>åŸºå‡†æµ‹è¯•<ul><li><a href="http://benchmarkjs.com/" target="_blank" rel="noopener">benchmark.js</a></li><li><a href="https://jsperf.com/" target="_blank" rel="noopener">jsperf.com</a></li></ul></li></ul><p><br></p><p><a href="#">â¬†ï¸å›åˆ°é¡¶éƒ¨</a></p><p><br></p><h2 id="9-å¼‚å¸¸å¤„ç†ã€ç›‘æ§å’Œè°ƒè¯•è§„èŒƒ"><a href="#9-å¼‚å¸¸å¤„ç†ã€ç›‘æ§å’Œè°ƒè¯•è§„èŒƒ" class="headerlink" title="9 å¼‚å¸¸å¤„ç†ã€ç›‘æ§å’Œè°ƒè¯•è§„èŒƒ"></a>9 å¼‚å¸¸å¤„ç†ã€ç›‘æ§å’Œè°ƒè¯•è§„èŒƒ</h2><p>å¾ˆå¤šå¼€å‘è€…å¸¸å¸¸è¯¯ç”¨æˆ–è€…è½»è§†å¼‚å¸¸çš„å¤„ç†, åˆç†æœ‰æ•ˆçš„å¼‚å¸¸å¤„ç†å¯ä»¥æé«˜åº”ç”¨çš„å¥å£®æ€§å’Œå¯ç”¨æ€§ï¼Œå¦å¤–è¿˜å¯ä»¥å¸®åŠ©å¼€å‘è€…å¿«é€Ÿå®šä½å¼‚å¸¸.</p><h3 id="9-1-å¼‚å¸¸å¤„ç†"><a href="#9-1-å¼‚å¸¸å¤„ç†" class="headerlink" title="9.1 å¼‚å¸¸å¤„ç†"></a>9.1 å¼‚å¸¸å¤„ç†</h3><p>&lt;é˜¿é‡Œå·´å·´çš„Javaå¼€å‘æ‰‹å†Œ&gt;ä¸­æ€»ç»“çš„<a href="https://github.com/alibaba/p3c/blob/master/p3c-gitbook/%E5%BC%82%E5%B8%B8%E6%97%A5%E5%BF%97/%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86.md" target="_blank" rel="noopener">å¼‚å¸¸å¤„ç†è§„èŒƒ</a>å¯¹JavaScriptçš„å¼‚å¸¸å¤„ç†ä¹Ÿå¾ˆæœ‰å‚è€ƒæ„ä¹‰ï¼Œæ¯”å¦‚:</p><ul><li>å¼‚å¸¸ä¸è¦ç”¨æ¥åšæµç¨‹æ§åˆ¶ï¼Œæ¡ä»¶æ§åˆ¶ã€‚</li><li>æ•è·å¼‚å¸¸æ˜¯ä¸ºäº†å¤„ç†å®ƒï¼Œä¸è¦æ•è·äº†å´ä»€ä¹ˆéƒ½ä¸å¤„ç†è€ŒæŠ›å¼ƒä¹‹ï¼Œå¦‚æœä¸æƒ³å¤„ç†å®ƒï¼Œè¯·å°†è¯¥å¼‚å¸¸æŠ›ç»™å®ƒçš„è°ƒç”¨è€…ã€‚æœ€å¤–å±‚çš„ä¸šåŠ¡ä½¿ç”¨è€…ï¼Œå¿…é¡»å¤„ç†å¼‚å¸¸ï¼Œå°†å…¶è½¬åŒ–ä¸ºç”¨æˆ·å¯ä»¥ç†è§£çš„å†…å®¹ã€‚</li><li>catchæ—¶è¯·åˆ†æ¸…ç¨³å®šä»£ç å’Œéç¨³å®šä»£ç ï¼Œç¨³å®šä»£ç æŒ‡çš„æ˜¯æ— è®ºå¦‚ä½•ä¸ä¼šå‡ºé”™çš„ä»£ç ã€‚å¯¹äºéç¨³å®šä»£ç çš„catchå°½å¯èƒ½è¿›è¡ŒåŒºåˆ†å¼‚å¸¸ç±»å‹ï¼Œå†åšå¯¹åº”çš„å¼‚å¸¸å¤„ç†ã€‚ä¸è¦å¯¹å¤§æ®µä»£ç è¿›è¡Œtry-catch</li><li>â€¦</li></ul><p>ç„¶åå†æ ¹æ®JavaScriptæœ¬èº«çš„å¼‚å¸¸å¤„ç†ç‰¹ç‚¹æ€»ç»“ä¸€äº›è§„èŒƒè¡Œä¸º, ä¾‹å¦‚:</p><ul><li>ä¸è¦throwéErrorå¯¹è±¡</li><li>ä¸è¦å¿½ç•¥å¼‚æ­¥å¼‚å¸¸</li><li>å…¨å±€ç›‘æ§Javascriptå¼‚å¸¸</li><li>â€¦</li></ul><p><br></p><p>èµ„æº:</p><ul><li><a href="https://rollbar.com/blog/top-10-javascript-errors/" target="_blank" rel="noopener">ä»1000+ä¸ªé¡¹ç›®ä¸­æ€»ç»“å‡ºæ¥çš„å‰10ä¸ªJavaScripté”™è¯¯, ä»¥åŠå¦‚ä½•é¿å…å®ƒä»¬</a></li><li><a href="https://levelup.gitconnected.com/the-definite-guide-to-handling-errors-gracefully-in-javascript-58424d9c60e6" target="_blank" rel="noopener">Javascriptå¼‚å¸¸å¤„ç†â€˜æƒå¨â€™æŒ‡å—</a></li><li><a href="https://zhuanlan.zhihu.com/p/63698500" target="_blank" rel="noopener">å‰ç«¯å¼‚å¸¸å¤„ç†æœ€ä½³å®è·µ</a></li></ul><p><br></p><p><a href="#">â¬†ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="9-2-æ—¥å¿—"><a href="#9-2-æ—¥å¿—" class="headerlink" title="9.2 æ—¥å¿—"></a>9.2 æ—¥å¿—</h3><p>å¯¹äºå‰ç«¯æ¥è¯´ï¼Œæ—¥å¿—ä¹Ÿä¸æ˜¯æ¯«æ— æ„ä¹‰(å¾ˆå¤šæ¡†æ¶æ€§èƒ½ä¼˜åŒ–å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒç§»é™¤console)ã€‚å°¤å…¶æ˜¯åœ¨<strong>ç”Ÿäº§ç°åœº</strong>è°ƒè¯•ä»£ç æ—¶ï¼Œè¿™æ—¶å€™å¯è´µçš„æ§åˆ¶å°æ—¥å¿—å¯ä»¥å¸®åŠ©ä½ å¿«é€Ÿæ‰¾åˆ°å¼‚å¸¸çš„çº¿ç´¢.</p><p>ä¸è¿‡é€šå¸¸æˆ‘ä»¬<strong>åªè¦ä¿ç•™å¿…è¦çš„ã€æœ‰æ„ä¹‰çš„æ—¥å¿—è¾“å‡º</strong>ï¼Œæ¯”å¦‚ä½ ä¸åº”è¯¥å°†console.logæ”¾åˆ°ä¸€ä¸ªReactæ¸²æŸ“å‡½æ•°ä¸­ã€æˆ–è€…æ”¾åˆ°ä¸€ä¸ªå¾ªç¯ä¸­, <strong>DDoså¼çš„æ—¥å¿—ä¿¡æ¯å¹¶ä¸èƒ½å¸®åŠ©æˆ‘ä»¬å®šä½é—®é¢˜ï¼Œåè€Œä¼šå½±å“è¿è¡Œçš„æ€§èƒ½</strong>. æ‰€ä»¥éœ€è¦ä¸€ä¸ªè§„èŒƒæ¥çº¦æŸæ—¥å¿—è¾“å‡ºè¡Œä¸º, æ¯”å¦‚:</p><ul><li>é¿å…é‡å¤æ‰“å°æ—¥å¿—</li><li>è°¨æ…åœ°è®°å½•æ—¥å¿—, åˆ’åˆ†æ—¥å¿—çº§åˆ«ã€‚æ¯”å¦‚ç”Ÿäº§ç¯å¢ƒç¦æ­¢è¾“å‡ºdebugæ—¥å¿—ï¼›æœ‰é€‰æ‹©åœ°è¾“å‡ºinfoæ—¥å¿—ï¼›</li><li>ä½¿ç”¨å‰ç¼€å¯¹æ—¥å¿—è¿›è¡Œåˆ†ç±», ä¾‹å¦‚: <code>[User] xxxx</code></li><li>åªè®°å½•å…³é”®ä¿¡æ¯, è¿™äº›ä¿¡æ¯å¯ä»¥å¸®åŠ©ä½ è¯Šæ–­é—®é¢˜</li><li>â€¦</li></ul><p>æ‰©å±•èµ„æº</p><ul><li><a href="https://github.com/visionmedia/debug" target="_blank" rel="noopener">debug</a> é€‚åˆNode.jså’Œæµè§ˆå™¨çš„debugæ—¥å¿—å·¥å…·, æ”¯æŒåŠ¨æ€å¼€å¯æ—¥å¿—æ‰“å°</li><li><a href="https://github.com/Tencent/vConsole" target="_blank" rel="noopener">vConsole</a> ç§»åŠ¨ç«¯è°ƒè¯•åˆ©å™¨</li></ul><p><br></p><p><a href="#">â¬†ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="9-3-å¼‚å¸¸ç›‘æ§"><a href="#9-3-å¼‚å¸¸ç›‘æ§" class="headerlink" title="9.3 å¼‚å¸¸ç›‘æ§"></a>9.3 å¼‚å¸¸ç›‘æ§</h3><p>å› ä¸ºç¨‹åºè·‘åœ¨ä¸å—æ§çš„ç¯å¢ƒï¼Œæ‰€ä»¥å¯¹äºå®¢æˆ·ç«¯åº”ç”¨æ¥è¯´ï¼Œå¼‚å¸¸ç›‘æ§åœ¨ç”Ÿäº§ç¯å¢ƒæ˜¯éå¸¸é‡è¦çš„ï¼Œå®ƒå¯ä»¥æ”¶é›†å„ç§æ„æ–™ä¹‹å¤–ç”Ÿäº§ç¯å¢ƒé—®é¢˜ï¼Œå¸®åŠ©å¼€å‘è€…å¿«é€Ÿå®šä½å¼‚å¸¸ã€‚</p><p><br></p><p>å¼‚å¸¸ç›‘æ§é€šå¸¸ä¼šé€šè¿‡ä¸‰ç§æ–¹å¼æ¥æ”¶é›†å¼‚å¸¸æ•°æ®:</p><ol><li>å…¨å±€æ•è·ã€‚ä¾‹å¦‚ä½¿ç”¨window.onerror, æˆ–è€…<code>unhandledrejection</code></li><li>ä¸»åŠ¨ä¸ŠæŠ¥ã€‚åœ¨try/catchä¸­ä¸»åŠ¨ä¸ŠæŠ¥. </li><li>ç”¨æˆ·åé¦ˆã€‚æ¯”å¦‚å¼¹çª—è®©ç”¨æˆ·å¡«å†™åé¦ˆä¿¡æ¯.</li></ol><p>å’Œæ—¥å¿—ä¸€æ ·ï¼Œ<strong>ä¸æ˜¯æ‰€æœ‰â€˜å¼‚å¸¸â€™éƒ½åº”è¯¥ä¸ŠæŠ¥ç»™å¼‚å¸¸ç›‘æ§ç³»ç»Ÿï¼Œè­¬å¦‚ä¸€äº›é¢„æ–™ä¹‹å†…çš„â€˜å¼‚å¸¸â€™</strong>ï¼Œæ¯”å¦‚ç”¨æˆ·è¾“å…¥é”™è¯¯ã€é‰´æƒå¤±è´¥ã€ç½‘ç»œé”™è¯¯ç­‰ç­‰. <strong>å¼‚å¸¸ç›‘æ§ä¸»è¦ç”¨æ¥ä¸ŠæŠ¥ä¸€äº›æ„æ–™ä¹‹å¤–çš„ã€æˆ–è€…è‡´å‘½æ€§çš„å¼‚å¸¸</strong>.</p><p><br></p><p>è¦åšå¥½å‰ç«¯çš„å¼‚å¸¸ç›‘æ§å…¶å®å¹¶ä¸å®¹æ˜“ï¼Œå®ƒéœ€è¦å¤„ç†è¿™äº›ä¸œè¥¿:</p><ul><li>æµè§ˆå™¨å…¼å®¹æ€§ã€‚</li><li>ç¢ç‰‡æ”¶é›†(breadcrumbs)ã€‚ æ”¶é›†â€˜ç¾éš¾â€™ç°åœºçš„ä¸€äº›çº¿ç´¢ï¼Œè¿™äº›çº¿ç´¢å¯¹é—®é¢˜è¯Šæ–­å¾ˆé‡è¦ã€‚ä¾‹å¦‚å½“å‰ç”¨æˆ·ä¿¡æ¯ã€ç‰ˆæœ¬ã€è¿è¡Œç¯å¢ƒã€æ‰“å°çš„æ—¥å¿—ã€å‡½æ•°è°ƒç”¨æ ˆç­‰ç­‰</li><li>è°ƒç”¨æ ˆçš„è½¬æ¢ã€‚é€šå¸¸åœ¨æµè§ˆå™¨è¿è¡Œçš„å‹ç¼©ä¼˜åŒ–è¿‡çš„ä»£ç ï¼Œè¿™ç§è°ƒç”¨æ ˆåŸºæœ¬æ²¡ä»€ä¹ˆå¯è¯»æ€§ï¼Œé€šå¸¸éœ€è¦é€šè¿‡SourceMapæ˜ å°„åˆ°åŸå§‹ä»£ç . å¯ä»¥ä½¿ç”¨è¿™ä¸ªåº“: <a href="https://github.com/mozilla/source-map#sourcemapconsumer" target="_blank" rel="noopener">source-map</a></li><li>æ•°æ®çš„èšåˆã€‚åç«¯ç›‘æ§ç³»ç»Ÿéœ€è¦å¯¹å‰ç«¯ä¸ŠæŠ¥çš„ä¿¡æ¯è¿›è¡Œåˆ†æå’Œèšåˆ</li></ul><p><br></p><p>å¯¹äºå°å›¢é˜Ÿæœªå¿…æœ‰èƒ½åŠ›å¼€å‘è¿™ä¸€å¥—ç³»ç»Ÿï¼Œæ‰€ä»¥æ¨èä½¿ç”¨ä¸€äº›ç¬¬ä¸‰æ–¹å·¥å…·ã€‚ä¾‹å¦‚</p><ul><li><a href="https://sentry.io/welcome/" target="_blank" rel="noopener">Sentry</a> ğŸ”¥å…è´¹åŸºæœ¬å¤Ÿç”¨</li><li><a href="https://www.fundebug.com/price" target="_blank" rel="noopener">FunDebug</a> ä»˜è´¹å¢å¼º</li></ul><p><strong>æ‰©å±•</strong>:</p><ul><li><a href="https://cdc.tencent.com/2018/09/13/frontend-exception-monitor-research/" target="_blank" rel="noopener">å‰ç«¯å¼‚å¸¸ç›‘æ§è§£å†³æ–¹æ¡ˆç ”ç©¶</a></li><li><a href="https://www.cnblogs.com/warm-stranger/p/9417084.html" target="_blank" rel="noopener">æ­å»ºå‰ç«¯ç›‘æ§ç³»ç»Ÿ</a></li></ul><p><br></p><p><a href="#">â¬†ï¸å›åˆ°é¡¶éƒ¨</a></p><p><br></p><h2 id="10-å‰åç«¯åä½œè§„èŒƒ"><a href="#10-å‰åç«¯åä½œè§„èŒƒ" class="headerlink" title="10 å‰åç«¯åä½œè§„èŒƒ"></a>10 å‰åç«¯åä½œè§„èŒƒ</h2><p>å‰ç«¯æ˜¯Webçš„ä¸€ä¸ªç»†åˆ†é¢†åŸŸï¼Œå¾€å¾€ä¸èƒ½è„±ç¦»åç«¯è€Œå­˜åœ¨ã€‚æ‰€ä»¥å’Œåç«¯åä½œçš„æ—¶é—´æ˜¯æœ€é•¿çš„.</p><h3 id="10-1-åä½œæµç¨‹è§„èŒƒ"><a href="#10-1-åä½œæµç¨‹è§„èŒƒ" class="headerlink" title="10.1 åä½œæµç¨‹è§„èŒƒ"></a>10.1 åä½œæµç¨‹è§„èŒƒ</h3><p>å‰åç«¯å›¢é˜Ÿç»è¿‡é•¿æœŸçš„åˆä½œï¼Œä¸€èˆ¬å¯ä»¥æ€»ç»“å‡ºä¸€æ¡å¯¹äºåŒæ–¹å¼€å‘æ•ˆç‡æœ€ä¼˜çš„åä½œæµç¨‹. å°†è¿™ä¸ªè½å®ä¸ºè§„èŒƒï¼Œåé¢çš„å›¢é˜Ÿæˆå‘˜éƒ½éµå¾ªè¿™ä¸ªæ­¥è°ƒè¿›è¡Œåä½œã€‚</p><p>ä¸€ä¸ªå…¸å‹çš„å‰åç«¯åä½œæµç¨‹å¦‚ä¸‹:</p><p><img src="/images/frontend-standard/f-b.png" alt></p><ol><li>éœ€æ±‚åˆ†æã€‚å‚ä¸è€…ä¸€èˆ¬æœ‰å‰åç«¯ã€æµ‹è¯•ã€ä»¥åŠäº§å“. ç”±äº§å“ä¸»æŒï¼Œå¯¹éœ€æ±‚è¿›è¡Œå®£è´¯ï¼Œæ¥å—å¼€å‘å’Œæµ‹è¯•çš„åé¦ˆï¼Œç¡®ä¿å¤§å®¶å¯¹éœ€æ±‚æœ‰ä¸€è‡´çš„è®¤çŸ¥</li><li>å‰åç«¯å¼€å‘è®¨è®ºã€‚è®¨è®ºåº”ç”¨çš„ä¸€äº›å¼€å‘è®¾è®¡ï¼Œæ²Ÿé€šæŠ€æœ¯ç‚¹ã€éš¾ç‚¹ã€ä»¥åŠåˆ†å·¥é—®é¢˜.</li><li>è®¾è®¡æ¥å£æ–‡æ¡£ã€‚å¯ä»¥ç”±å‰åç«¯ä¸€èµ·è®¾è®¡ï¼›æˆ–è€…ç”±åç«¯è®¾è®¡ã€å‰ç«¯ç¡®è®¤æ˜¯å¦ç¬¦åˆè¦æ±‚</li><li>å¹¶è¡Œå¼€å‘ã€‚å‰åç«¯å¹¶è¡Œå¼€å‘ï¼Œåœ¨è¿™ä¸ªé˜¶æ®µï¼Œå‰ç«¯å¯ä»¥å…ˆå®ç°é™æ€é¡µé¢; æˆ–è€…æ ¹æ®æ¥å£æ–‡æ¡£å¯¹æ¥å£è¿›è¡ŒMock, æ¥æ¨¡æ‹Ÿå¯¹æ¥åç«¯æ¥å£</li><li>åœ¨è”è°ƒä¹‹å‰ï¼Œè¦æ±‚åç«¯åšå¥½æ¥å£æµ‹è¯•</li><li>çœŸå®ç¯å¢ƒè”è°ƒã€‚å‰ç«¯å°†æ¥å£è¯·æ±‚ä»£ç†åˆ°åç«¯æœåŠ¡ï¼Œè¿›è¡ŒçœŸå®ç¯å¢ƒè”è°ƒã€‚</li></ol><p><br></p><p><a href="#">â¬†ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="10-2-æ¥å£è§„èŒƒ"><a href="#10-2-æ¥å£è§„èŒƒ" class="headerlink" title="10.2 æ¥å£è§„èŒƒ"></a>10.2 æ¥å£è§„èŒƒ</h3><p>é¦–å…ˆåº”è¯¥ç¡®å®šä¸‹æ¥çš„æ˜¯æ¥å£è§„èŒƒã€‚å…¶å®ä½¿ç”¨å“ªç§æ¥å£æ ‡å‡†æ˜¯å…¶æ¬¡ï¼Œé‡è¦çš„æ˜¯ç»Ÿä¸€ï¼Œä¸”è¦æ»¡è¶³å‰åç«¯çš„å¼€å‘æ•ˆç‡è¦æ±‚.</p><p>ç¬”è€…ä¸å»ºè®®åç«¯å»å®šä¹‰è‡ªå·±çš„æ¥å£æ ‡å‡†ï¼Œè€Œåº”è¯¥å»é€‰æ‹©ä¸€äº›é€šç”¨çš„ã€æœ‰æ ‡å‡†å®šä¹‰æ¥å£å½¢å¼, ä¾‹å¦‚:</p><ul><li><p><a href="https://zh.wikipedia.org/zh-hans/è¡¨ç°å±‚çŠ¶æ€è½¬æ¢" target="_blank" rel="noopener">RESTful</a>: RESTfulæ˜¯ç›®å‰ä½¿ç”¨æœ€ä¸ºå¹¿æ³›çš„APIè®¾è®¡è§„èŒƒ, åŸºäºHTTPæœ¬èº«çš„æœºåˆ¶æ¥å®ç°. </p><p>ç¬”è€…ä¸ªäººæ˜¯æ¯”è¾ƒå–œæ¬¢è¿™ä¸ªAPIè§„èŒƒï¼Œä½†æ˜¯æˆ‘å‘ç°å¾ˆå¤šå¼€å‘è€…å¹¶ä¸èƒ½çœŸæ­£(æˆ–è€…è¯´æ²¡å¿ƒæ€)ç†è§£å®ƒï¼Œè®¾è®¡å‡ºæ¥çš„æ¥å£ï¼Œè·Ÿæˆ‘æƒ³è±¡çš„ç›¸å·®ç”šè¿œã€‚æ¢å¥è¯è¯´ï¼Œå¯¹äºRESTfulï¼Œå¼€å‘è€…ä¹‹é—´å¾ˆéš¾è¾¾æˆä¸€è‡´çš„ç†è§£ï¼Œå®¹æ˜“äº§ç”Ÿåˆ†æ­§ã€‚</p><p>å› ä¸ºæ˜¯ä½¿ç”¨æœ€å¹¿æ³›çš„APIå½¢å¼ï¼Œæ‰€ä»¥ç¤¾åŒºä¸Šæœ‰å¾ˆå¤šå·¥å…·æ¥å¯¹RESTfulæ¥å£è¿›è¡Œæ–‡æ¡£åŒ–ã€æµ‹è¯•å’Œæ¨¡æ‹Ÿ.</p></li><li><p><a href="http://wiki.geekdream.com/Specification/json-rpc_2.0.html" target="_blank" rel="noopener">JSONRPC</a> è¿™æ˜¯ä¸€ç§éå¸¸ç®€å•ã€å®¹æ˜“ç†è§£çš„æ¥å£è§„èŒƒã€‚ç›¸å¯¹äºRESTfulæˆ‘æ›´æ¨èè¿™ä¸ªï¼Œç®€å•åˆ™ä¸å®¹æ˜“äº§ç”Ÿåˆ†æ­§ï¼Œæ–°æ‰‹ä¹Ÿå¯ä»¥å¾ˆå¿«æ¥å—.</p></li><li><a href="https://graphql.org/learn/" target="_blank" rel="noopener">GraphQL</a> ğŸ”¥æ›´ä¸ºå…ˆè¿›ã€æ›´æœ‰å‰æ™¯çš„APIè§„èŒƒã€‚ä½†æ˜¯ä½ è¦è¯´æœåç«¯é…åˆä½ ä½¿ç”¨è¿™ç§æ ‡å‡†å¯èƒ½å¾ˆæœ‰éš¾åº¦</li></ul><p><br></p><p><strong>æ¥å£è®¾è®¡éœ€è¦æ³¨æ„çš„ç‚¹</strong>:</p><ul><li>æ˜ç¡®åŒºåˆ†æ˜¯æ­£å¸¸è¿˜æ˜¯å¼‚å¸¸, ä¸¥æ ¼éµå¾ªæ¥å£çš„å¼‚å¸¸åŸè¯­. ä¸Šè¿°æ¥å£å½¢å¼éƒ½æœ‰æ˜ç¡®çš„å¼‚å¸¸åŸè¯­ï¼Œæ¯”å¦‚JSONRPCï¼Œå½“å‡ºç°å¼‚å¸¸æ—¶åº”è¯¥è¿”å›<code>é”™è¯¯å¯¹è±¡</code>å“åº”ï¼Œè€Œä¸æ˜¯åœ¨æ­£å¸¸çš„å“åº”ä½“ä¸­è¿”å›é”™è¯¯ä»£ç . å¦å¤–è¦è§„èŒƒåŒ–çš„é”™è¯¯ç , HTTPå“åº”ç å°±æ˜¯ä¸€ä¸ªä¸é”™çš„å­¦ä¹ å¯¹è±¡</li><li>æ˜ç¡®æ•°æ®ç±»å‹ã€‚å¾ˆå¤šåç«¯å†™çš„æ¥å£éƒ½æ˜¯stringå’Œnumberä¸åˆ†çš„ï¼Œå¦‚æœå¦¥åçš„è¯ã€å‰ç«¯å°±éœ€è¦é’ˆå¯¹è¿™ä¸ªå±æ€§åšç‰¹æ®Šå¤„ç†ï¼Œè¿™ä¹Ÿå¯èƒ½æ˜¯æ½œåœ¨çš„bug</li><li>æ˜ç¡®ç©ºå€¼çš„æ„ä¹‰ã€‚æ¯”å¦‚åœ¨åšæ›´æ–°æ“ä½œæ˜¯ï¼Œç©ºå€¼æ˜¯è¡¨ç¤ºé‡ç½®ï¼Œè¿˜æ˜¯å¿½ç•¥æ›´æ–°ï¼Ÿ</li><li>å“åº”é¿å…å†—ä½™çš„åµŒå¥—ã€‚</li><li>æ¥å£ç‰ˆæœ¬åŒ–ï¼Œä¿æŒå‘ä¸‹å…¼å®¹ã€‚å°±åƒæˆ‘ä»¬ä¸Šæ–‡çš„â€˜è¯­ä¹‰åŒ–ç‰ˆæœ¬è§„èŒƒâ€™è¯´çš„ï¼Œå¯¹äºåç«¯æ¥è¯´ï¼ŒAPIå°±æ˜¯å…¬å…±çš„æ¥å£. å…¬å…±æš´éœ²çš„æ¥å£åº”è¯¥æœ‰ä¸€ä¸ªç‰ˆæœ¬å·ï¼Œæ¥è¯´æ˜å½“å‰æè¿°çš„æ¥å£åšäº†ä»€ä¹ˆå˜åŠ¨ï¼Œæ˜¯å¦å‘ä¸‹å…¼å®¹ã€‚<br>ç°åœ¨å‰ç«¯ä»£ç å¯èƒ½ä¼šåœ¨å®¢æˆ·ç«¯è¢«ç¼“å­˜ï¼Œä¾‹å¦‚å°ç¨‹åºã€‚å¦‚æœåç«¯åšäº†break changeï¼Œå°±ä¼šå½±å“è¿™éƒ¨åˆ†ç”¨æˆ·ã€‚</li></ul><p><br></p><p><a href="#">â¬†ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="10-3-æ¥å£æ–‡æ¡£è§„èŒƒ"><a href="#10-3-æ¥å£æ–‡æ¡£è§„èŒƒ" class="headerlink" title="10.3 æ¥å£æ–‡æ¡£è§„èŒƒ"></a>10.3 æ¥å£æ–‡æ¡£è§„èŒƒ</h3><p>åç«¯é€šè¿‡æ¥å£æ–‡æ¡£å‘å‰ç«¯æš´éœ²æ¥å£ç›¸å…³çš„ä¿¡æ¯ã€‚é€šå¸¸éœ€è¦åŒ…å«è¿™äº›ä¿¡æ¯ï¼š</p><ul><li>ç‰ˆæœ¬å·</li><li>æ–‡æ¡£æè¿°</li><li>æœåŠ¡çš„å…¥å£. ä¾‹å¦‚åŸºæœ¬è·¯å¾„</li><li>æµ‹è¯•æœåŠ¡å™¨. å¯é€‰</li><li>ç®€å•ä½¿ç”¨ç¤ºä¾‹</li><li>å®‰å…¨å’Œè®¤è¯</li><li>å…·ä½“æ¥å£å®šä¹‰<ul><li>æ–¹æ³•åç§°æˆ–è€…URL</li><li>æ–¹æ³•æè¿°</li><li>è¯·æ±‚å‚æ•°åŠå…¶æè¿°ï¼Œå¿…é¡»è¯´æ˜ç±»å‹(æ•°æ®ç±»å‹ã€æ˜¯å¦å¯é€‰ç­‰)</li><li>å“åº”å‚æ•°åŠå…¶æè¿°, å¿…é¡»è¯´æ˜ç±»å‹(æ•°æ®ç±»å‹ã€æ˜¯å¦å¯é€‰ç­‰)</li><li>å¯èƒ½çš„å¼‚å¸¸æƒ…å†µã€é”™è¯¯ä»£ç ã€ä»¥åŠæè¿°</li><li>è¯·æ±‚ç¤ºä¾‹ï¼Œå¯é€‰</li></ul></li></ul><p><strong>äººå·¥ç»´æŠ¤å¯¼è‡´çš„é—®é¢˜</strong>:</p><p>ä¸Šæ–‡â€˜ä»£ç å³æ–‡æ¡£â€™å°±æåˆ°äº†äººå·¥ç»´æŠ¤æ¥å£æ–‡æ¡£å¯èƒ½å¯¼è‡´ä»£ç å’Œæ–‡æ¡£ä¸åŒæ­¥é—®é¢˜ã€‚</p><p>å¦‚æœå¯ä»¥ä»ä»£ç æˆ–è€…è§„èŒƒæ–‡æ¡£(ä¾‹å¦‚OpenAPIè¿™ç±»APIæè¿°è§„èŒƒ)ä¸­ç”Ÿæˆæ¥å£æ–‡æ¡£ï¼Œå¯ä»¥è§£å†³å®ç°å’Œæ–‡æ¡£ä¸ä¸€è‡´é—®é¢˜, åŒæ—¶ä¹Ÿå¯ä»¥å‡å°‘æ–‡æ¡£ç¼–å†™å’Œç»´æŠ¤çš„æŠ•å…¥.</p><p><br></p><p><a href="#">â¬†ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="10-4-æ¥å£æµ‹è¯•ä¸æ¨¡æ‹Ÿ"><a href="#10-4-æ¥å£æµ‹è¯•ä¸æ¨¡æ‹Ÿ" class="headerlink" title="10.4 æ¥å£æµ‹è¯•ä¸æ¨¡æ‹Ÿ"></a>10.4 æ¥å£æµ‹è¯•ä¸æ¨¡æ‹Ÿ</h3><p>ä¸ºäº†åšåˆ°é«˜æ•ˆç‡çš„å‰åç«¯å¹¶è¡Œå¼€å‘ï¼Œæ¥å£çš„æµ‹è¯•ä¸æ¨¡æ‹Ÿæ˜¯å¿…è¦çš„ã€‚</p><ul><li>å‰ç«¯è¦æ±‚åç«¯åœ¨è”è°ƒä¹‹å‰ï¼Œéœ€è¦æµ‹è¯•éªŒè¯å¥½è‡ªå·±çš„æ¥å£æ˜¯å¦å¯ä»¥æ­£å¸¸å·¥ä½œã€‚è€Œä¸æ˜¯åœ¨è”è°ƒæœŸé—´ï¼ŒæŠŠå‰ç«¯å½“â€˜æ¥å£æµ‹è¯•å‘˜â€™ï¼Œé˜»å¡æ¥å£è”è°ƒè¿›åº¦</li><li>å¦å¤–å‰ç«¯éœ€è¦åœ¨åç«¯æ¥å£æœªå‡†å¤‡å¥½ä¹‹å‰ï¼Œé€šè¿‡æ¥å£æ¨¡æ‹Ÿçš„æ–¹å¼ï¼Œæ¥ç¼–å†™ä¸šåŠ¡é€»è¾‘ä»£ç ã€‚</li></ul><p>é’ˆå¯¹æ¥å£æµ‹è¯•ä¸æ¨¡æ‹Ÿï¼Œå­˜åœ¨ä¸‹å›¾è¿™æ ·ä¸€ä¸ªç†æƒ³çš„æ¨¡å‹:</p><p><img src="/images/frontend-standard/api-mock.png" alt></p><p>ä¸€åˆ‡ä»å®šä¹‰è‰¯å¥½çš„æ¥å£æ–‡æ¡£å‡ºå‘ï¼Œç”Ÿæˆ<code>Mock Server</code>å’Œ<code>Mock Client</code>, Mock Serverç»™å‰ç«¯æä¾›æ¨¡æ‹Ÿæ•°æ®ï¼Œè€ŒMock Clientåˆ™è¾…åŠ©åç«¯å¯¹å®ƒä»¬çš„æ¥å£è¿›è¡Œæµ‹è¯•.</p><p>èµ„æº:</p><ul><li>RESTful<ul><li><a href="https://swagger.io/" target="_blank" rel="noopener">Swagger</a> è¿™æ˜¯æœ€ä¸ºæ¥è¿‘ä¸Šé¢ç†æƒ³æ¨¡å‹çš„ä¸€ä¸ªè§£å†³æ–¹æ¡ˆ</li><li><a href="https://github.com/nuysoft/Mock" target="_blank" rel="noopener">JSON Server</a> å¿«é€Ÿç”ŸæˆJSON mockæœåŠ¡å™¨</li><li><a href="https://easy-mock.com" target="_blank" rel="noopener">Easy Mock</a> å¯è§†åŒ–çš„ã€åœ¨çº¿çš„æ¥å£mockæœåŠ¡</li></ul></li><li>GraphQl<ul><li><a href="https://github.com/APIs-guru/graphql-faker" target="_blank" rel="noopener">GraphQL Faker</a></li><li><a href="https://www.apollographql.com/docs/graphql-tools/mocking/" target="_blank" rel="noopener">graphql-tools</a></li></ul></li><li>æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆ<ul><li><a href="https://github.com/Marak/faker.js" target="_blank" rel="noopener">faker.js</a> ğŸ”¥å¼ºå¤§çš„æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆå·¥å…·ï¼Œæ”¯æŒNodeå’Œæµè§ˆå™¨</li><li><a href="https://github.com/nuysoft/Mock" target="_blank" rel="noopener">Mock.js</a> æ•°æ®ç”Ÿæˆå’Œæ¨¡æ‹Ÿå·¥å…·</li></ul></li></ul><p><br></p><p><a href="#">â¬†ï¸å›åˆ°é¡¶éƒ¨</a></p><p><br></p><h2 id="11-åŸ¹è®­-çŸ¥è¯†ç®¡ç†-æŠ€æœ¯æ²‰æ·€"><a href="#11-åŸ¹è®­-çŸ¥è¯†ç®¡ç†-æŠ€æœ¯æ²‰æ·€" class="headerlink" title="11 åŸ¹è®­/çŸ¥è¯†ç®¡ç†/æŠ€æœ¯æ²‰æ·€"></a>11 åŸ¹è®­/çŸ¥è¯†ç®¡ç†/æŠ€æœ¯æ²‰æ·€</h2><p>æˆ‘è§‰å¾—ä¸€ä¸ªå›¢é˜Ÿçš„çŸ¥è¯†ç®¡ç†æ˜¯éå¸¸é‡è¦çš„. ä½ è¦é—®ä¸€ä¸ªåˆšå…¥è¡Œçš„æ–°æ‰‹åŠ å…¥å›¢é˜Ÿå¸Œæœ›å¾—åˆ°ä»€ä¹ˆï¼Ÿå¾ˆå¤šäººçš„å›ç­”æ˜¯â€™å­¦ä¹ â€™,  å¸Œæœ›è‡ªå·±çš„æŠ€æœ¯å¯ä»¥æ›´åŠ ç²¾è¿›, é’±å€’è¿˜æ˜¯å…¶æ¬¡ã€‚</p><p>ç„¶è€Œç°å®æ˜¯ç›®å‰å¾ˆå¤šå…¬å¸çš„æ°›å›´å¹¶ä¸æ˜¯è¿™æ ·çš„ï¼Œä¸€å¤©åˆ°æ™šå†™ä¸šåŠ¡ä»£ç ã€å·¥ä½œé‡å¤§ã€æ¯å¤©åšé‡å¤çš„äº‹æƒ…ï¼Œè€Œä¸”è¿˜åŠ ç­ï¼Œå·¥ä½œå¤šå¹´æŠ€æœ¯ä¹Ÿæ²¡æ„Ÿè§‰æœ‰å¤šå°‘è¿›æ­¥, ç¡®å®ä¼šè®©äººéå¸¸æ²®ä¸§ã€‚åŒ…æ‹¬ç¬”è€…ä¹Ÿæ˜¯è¿™æ ·çš„ã€‚</p><p>æ‰€ä»¥ä¸ºäº†æ”¹å–„è¿™ç§æƒ…å†µï¼Œæˆ‘æ¥èŠèŠæœ€è¿‘åœ¨â€˜å°å›¢é˜Ÿâ€™åšçš„ä¸€äº›å°è¯•.</p><h3 id="11-1-æ–°äººåŸ¹è®­"><a href="#11-1-æ–°äººåŸ¹è®­" class="headerlink" title="11.1 æ–°äººåŸ¹è®­"></a>11.1 æ–°äººåŸ¹è®­</h3><p>å¦‚æœå›¢é˜Ÿæœ‰è§„èŒƒçš„æ–°æˆå‘˜åŸ¹è®­æ‰‹å†Œï¼Œå¯ä»¥èŠ‚çœå¾ˆå¤šåŸ¹è®­çš„æ—¶é—´ï¼Œé¿å…æ¯æ¬¡é‡å¤å£è¿°ä¸€æ ·çš„å†…å®¹ã€‚åŸ¹è®­æ‰‹å†ŒåŒ…å«ä»¥ä¸‹å†…å®¹:</p><ul><li><p><strong>äº§å“æ¶æ„ä¸ç»„ç»‡æ¶æ„</strong>. ä»‹ç»å…¬å¸èƒŒæ™¯å’Œäº§å“ï¼Œä¸€èˆ¬ç»„ç»‡çš„å›¢é˜Ÿç»“æ„å’Œäº§å“çš„æ¶æ„æ˜¯ç›¸å…³è”çš„. ä»¥ç¬”è€…æ‰€åœ¨å…¬å¸ä¸ºä¾‹, ä¸»è¦äº§å“æ˜¯å³æ—¶é€šä¿¡:</p><p><img src="/images/frontend-standard/org.png" alt></p></li><li><p><strong>äº§å“ç ”å‘æµç¨‹</strong>: ä»‹ç»äº§å“å¼€å‘å’Œè¿­ä»£ä¼šæ¶‰åŠåˆ°çš„æµç¨‹ã€ä»¥åŠå›¢é˜Ÿä¹‹é—´çš„åä½œè¡”æ¥ï¼Œä¾‹å¦‚:</p><p><img src="/images/frontend-standard/dev-proc.png" alt></p></li><li><p><strong>å·¥ä½œèŒƒå›´</strong>: å›¢é˜Ÿæˆå‘˜çš„èŒè´£èŒƒå›´</p></li><li><strong>å»ºç«‹èµ„æºç´¢å¼•</strong>: å¼€å‘éœ€è¦è®¾è®¡åˆ°çš„èµ„æºï¼Œæ¯”å¦‚å„ç§æ–‡æ¡£åœ°å€ã€ç ”å‘ç³»ç»Ÿå…¥å£(ä¾‹å¦‚gitlabã€bugè·Ÿè¸ªç³»ç»Ÿã€æ–‡ä»¶å…±äº«ã€å‘å¸ƒå¹³å°ã€å¼€å‘/æµ‹è¯•ç¯å¢ƒã€ç›‘æ§ç³»ç»Ÿ)ã€åä½œè§„èŒƒç­‰ç­‰ã€‚å°†è¿™äº›èµ„æºæ•´ç†å¥½å¯ä»¥å‡å°‘ä¸å¿…è¦çš„æ²Ÿé€šæˆæœ¬</li><li><strong>è§„èŒƒ</strong>: å³æœ¬æ–‡çš„ä¸»ä½“â€™å‰ç«¯åä½œè§„èŒƒâ€™ã€‚æœ‰è§„èŒƒå¯å¾ªï¼Œå¯ä»¥è®©æˆå‘˜ä»¥è¾ƒå¿«çš„é€Ÿåº¦å…¥æ‰‹å¼€å‘ã€åŒæ—¶ä¹Ÿå‡å°‘åŸ¹è®­æˆæœ¬æŠ•å…¥ã€‚</li></ul><p>åŸ¹è®­æ‰‹å†Œå°†å¯ä»¥æ–‡æ¡£å…·è±¡åŒ–çš„å†…å®¹æ•´ç†ä¸ºæ–‡æ¡£ï¼Œå’Œä¸Šæ–‡è¯´åˆ°çš„Code Reviewä¸€æ ·ï¼Œä¸€äº›ä¸œè¥¿æ— æ³•é€šè¿‡æ–‡æ¡£æ¥è¯´æ˜ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€èˆ¬ä¼šæ­é…ä¸€ä¸ªâ€˜åŸ¹è®­å¯¼å¸ˆâ€™ï¼Œåœ¨è¯•ç”¨æœŸé—´ï¼Œä¸€å¯¹ä¸€è¾…å¯¼ã€‚</p><p><br></p><p><a href="#">â¬†ï¸å›åˆ°é¡¶éƒ¨</a></p><h3 id="11-2-è¥é€ æŠ€æœ¯æ°›å›´"><a href="#11-2-è¥é€ æŠ€æœ¯æ°›å›´" class="headerlink" title="11.2 è¥é€ æŠ€æœ¯æ°›å›´"></a>11.2 è¥é€ æŠ€æœ¯æ°›å›´</h3><ul><li><strong>é¼“åŠ±æˆå‘˜å†™æŠ€æœ¯åšå®¢ï¼Œæˆ–è€…å»ºç«‹è‡ªå·±çš„å›¢é˜Ÿä¸“æ </strong>. å†™ä¸€ç¯‡å¥½çš„æ–‡ç« ä¸å®¹æ˜“</li><li><strong>é¼“åŠ±å‚ä¸å¼€æºé¡¹ç›®</strong></li><li><strong>å»ºç«‹é¢è¯•é¢˜åº“</strong> ç»„ç»‡ä¸€èµ·è§£ä¸€äº›é¢è¯•é¢˜æˆ–ç®—æ³•é¢˜ï¼ŒåŠ æ·±å¯¹çŸ¥è¯†ç‚¹çš„ç†è§£</li><li><p><strong>å®šæœŸçš„ä¸“é¢˜åˆ†äº«</strong>. é¼“åŠ±å›¢é˜Ÿæˆå‘˜å®šæœŸè¿›è¡Œä¸“é¢˜å­¦ä¹ å’Œç ”ç©¶ï¼Œç¼–å†™æŠ€æœ¯åšå®¢ï¼Œå¹¶å°†å­¦ä¹ çš„æˆæœåˆ†äº«ç»™å…¶ä»–æˆå‘˜. è¿™æ˜¯ä¸€ç§æŠ±å›¢å–æš–çš„å­¦ä¹ æ–¹å¼ï¼Œæ—¨åœ¨å¸®åŠ©å›¢é˜Ÿæˆå‘˜ä¸€èµ·å­¦ä¹ å’Œæˆé•¿ã€‚</p><p>æ¯”å¦‚å¼€å‘è€æ‰‹å¯ä»¥åˆ†äº«è‡ªå·±çš„ç»éªŒï¼Œç ”ç©¶æ›´æ·±å±‚æ¬¡çš„æŠ€æœ¯ï¼›æ–°æ‰‹åˆ™å¯ä»¥ç ”ç©¶æŸäº›å¼€å‘æŠ€å·§ã€æ–°æŠ€æœ¯ï¼Œä¾‹å¦‚CSS Gridï¼ŒsvgåŠ¨ç”»ç­‰ç­‰ã€‚æ¨èå›¢é˜Ÿæˆå‘˜æœ‰ä¸ªæ˜ç¡®çš„ç ”ç©¶é¢†åŸŸï¼Œè¿™æ ·åˆ†å·¥åˆä½œå¯ä»¥å­¦ä¹ åˆ°æ›´å¤šä¸œè¥¿.</p><p><strong>ä¸“é¢˜æ€ä¹ˆæ¥?</strong></p><ul><li>ä¸“é¢˜è¯·æ±‚. å¯ä»¥è¯·æ±‚å…¶ä»–æˆå‘˜å®Œæˆä¸“é¢˜ï¼Œæ¯”å¦‚æ¯”è¾ƒæ·±çš„çŸ¥è¯†ï¼Œå¯ä»¥è¦æ±‚å›¢é˜Ÿæ¯”è¾ƒæœ‰ç»éªŒçš„è¿›è¡Œå­¦ä¹ åˆ†äº«</li><li>å­¦ä¹ æ€»ç»“.</li><li>é¡¹ç›®å›é¡¾</li><li>éš¾ç‚¹æ”»å…‹</li><li>é¡¹ç›®è§„èŒƒ</li><li>å·¥å…·ä½¿ç”¨</li></ul></li><li><p><strong>è½å®å’Œå®Œå–„å¼€å‘è§„èŒƒ</strong>. è§„èŒƒæœ¬èº«å°±æ˜¯å›¢é˜ŸçŸ¥è¯†æ²‰æ·€çš„ä¸€ç§ç›´æ¥è¾“å‡º</p></li><li><strong>å›¾ä¹¦åˆ†äº«</strong>. å’Œç¦»æ•£çš„æ–‡ç« æˆ–æ•™ç¨‹ç›¸æ¯”ï¼Œå›¾ä¹¦çš„çŸ¥è¯†ä¼šæ¯”è¾ƒç³»ç»Ÿï¼Œå¦å¤–å¾ˆå¤šç»å…¸çš„å›¾ä¹¦æ˜¯è¦é™ä¸‹æ¥å¥½å¥½æ¬£èµçš„ã€‚</li><li><strong>é¼“åŠ±é‡æ„å’ŒæŒç»­ä¼˜åŒ–ä»£ç </strong></li><li><strong>æŠ½è±¡ä¸€å¥—åŸºç¡€åº“æˆ–æ¡†æ¶ï¼Œå‡å°‘é‡å¤å·¥ä½œ, æé«˜å·¥ä½œæ•ˆç‡</strong>. ä¸åŠ ç­å…ˆä»æé«˜å·¥ä½œæ•ˆç‡å¼€å§‹</li></ul><p><br></p><p><a href="#">â¬†ï¸å›åˆ°é¡¶éƒ¨</a></p><p><br></p><h2 id="12-åé¦ˆ"><a href="#12-åé¦ˆ" class="headerlink" title="12 åé¦ˆ"></a>12 åé¦ˆ</h2><p>å¤§å®¶æœ‰ä»€ä¹ˆè¦è¡¥å……æˆ–æ„è§å¯ä»¥åœ¨ä¸‹æ–¹è¯„è®º, ä¸€èµ·æ¥å®Œå–„è¿™ç¯‡æ–‡ç« , è°¢è°¢ï¼</p><p><img src="/images/sponsor.jpg" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;ä¸‡å­—é•¿æ–‡ï¼Œç»§ç»­åˆ·æ–°æˆ‘çš„æ–‡ç« é•¿åº¦è®°å½•ï¼Œæ¶‰åŠå‰ç«¯å¼€å‘çš„æ–¹æ–¹é¢é¢ã€‚æœ¬æ–‡å°†æŒç»­æ›´æ–°å’Œå®Œå–„, æ–‡ç« éƒ¨åˆ†è§‚ç‚¹å¯èƒ½æ¯”è¾ƒæ­¦æ–­æˆ–ä¸å®Œæ•´ï¼Œæ¬¢è¿è¯„è®ºå’Œè¡¥å……ï¼Œä¸€èµ·å®Œå–„è¯¥æ–‡ç« . è°¢è°¢&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;br&gt;&lt;/p&gt;
&lt;p&gt;ç¬”è€…é•¿æœŸå•æªåŒ¹é©¬åœ¨å‰ç«¯é¢†
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://bobi.ink/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>[é—®ç­”] ä¸ºä»€ä¹ˆè¦ç”¨vue-cli3?</title>
    <link href="https://bobi.ink/2019/07/18/why-vue-cli3/"/>
    <id>https://bobi.ink/2019/07/18/why-vue-cli3/</id>
    <published>2019-07-17T16:00:00.000Z</published>
    <updated>2019-07-18T04:20:32.211Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p><code>[é—®ç­”]</code>ç³»åˆ—ä¸»è¦æ•´ç†<a href="https://segmentfault.com/q/1010000019785471" target="_blank" rel="noopener">SegmentFault</a>ä¸Šé¢æ¯”è¾ƒæœ‰ä»·å€¼çš„é—®é¢˜ï¼Œä»¥åŠæˆ‘çš„å›ç­”</p></blockquote><h2 id="åŸé—®é¢˜"><a href="#åŸé—®é¢˜" class="headerlink" title="åŸé—®é¢˜"></a><a href="https://segmentfault.com/q/1010000019785471/a-1020000019793827" target="_blank" rel="noopener">åŸé—®é¢˜</a></h2><p>å…¶å®è¿™ä¸ªé—®é¢˜ä¸»è¦æ˜¯æƒ³äº†è§£vue-cli3ä¸vue-cli2ç›¸æ¯”æ˜¯å¦å­˜åœ¨ä¸€äº›ä¸å¾—ä¸å‡çº§çš„å¥½å¤„å’Œä¼˜ç‚¹ï¼Ÿ</p><p>äº§ç”Ÿè¿™ä¸ªé—®é¢˜çš„åŸå› æ˜¯åœ¨è¯•ç”¨å®Œvue-cli3ä¹‹åå¹¶æ²¡æœ‰è§‰å¾—å¥½ç”¨ï¼Œåè€Œè§‰å¾—æŸæ‰‹æŸè„šï¼Œæˆ‘cli2æ—¶ï¼Œwebpackæƒ³æ€ä¹ˆé…æ€ä¹ˆé…ä¸ºä»€ä¹ˆåˆ°äº†cli3æˆ‘è¦åœ¨vue.config.jsä¸­é…ç½®<br>ä¼—æ‰€å‘¨çŸ¥vue-cliçš„é€šç”¨é…ç½®å¹¶ä¸é€‚åˆæ¯ç§æƒ…å†µ, è€Œåœ¨vue.config.jsåªèƒ½åšå¢æ·»å’Œè¦†ç›–ï¼Œæ‰€ä»¥ä¸€ç›´æ²¡æœ‰ç”¨vue-cli3æ„å»ºé¡¹ç›®</p><p>æ‰€ä»¥æƒ³è¯·æ•™ä¸‹ è¿™ä¸ªç‰ˆæœ¬æœ‰æ²¡æœ‰å€¼å¾—å‡çº§çš„ä¼˜ç‚¹</p><p><br></p><h2 id="æˆ‘çš„å›ç­”"><a href="#æˆ‘çš„å›ç­”" class="headerlink" title="æˆ‘çš„å›ç­”"></a>æˆ‘çš„å›ç­”</h2><p>å¥½é—®é¢˜ï¼Œvue-cli3ç›¸å¯¹vue-cliæœ‰å¾ˆå¤šé‡è¦çš„æ›´æ–°ã€‚</p><p>é¦–å…ˆè¯´ä¸€äº›vue-cliè¿™äº›å·¥å…·çš„<strong>åˆè¡·</strong>å§: è¿™äº›å·¥å…·å°±æ˜¯ä¸ºäº†è®©å¼€å‘è€…èƒ½å¤Ÿ<strong>å¼€ç®±å³ç”¨</strong>å¿«é€Ÿåœ°è¿›è¡Œåº”ç”¨å¼€å‘è€Œå¼€å‘çš„ï¼Œ<strong>å®ƒä»¬ç§‰æ‰¿çš„æ˜¯â€œçº¦å®šå¤§äºé…ç½®â€æ€æƒ³ï¼Œç®€å•è¯´å°±æ˜¯â€èƒ½ä¸é…ç½®çš„å°±ä¸é…ç½®ï¼Œä½ å°±æŒ‰ç…§æˆ‘çš„æ–¹å¼æ¥ï¼Œä¹Ÿä¸è¦å»äº‰è®ºè¿™ä¸ªå¥½ä¸å¥½ï¼Œå¿«é€Ÿè¿›è¡Œä¸šåŠ¡å¼€å‘æ‰æ˜¯æ­£ç»äº‹â€. å®ƒä»¬ä¸å»ºè®®ä½ å»é…ç½®ï¼Œä½†ä¹Ÿä¸ä¼šæ‹¦ç€ä½ å»é…ç½®</strong>ã€‚</p><p>å¦å¤–Webpackå¯¹åˆå­¦è€…å¹¶ä¸æ˜¯ååˆ†å‹å¥½ï¼Œâ€˜åˆé•¿åˆè‡­â€™çš„é…ç½®ï¼Œæ™®é€šå¼€å‘è€…å¾ˆéš¾å†™å…¥å®šä¹‰è‰¯å¥½ï¼Œæ€§èƒ½ä¼˜åŒ–çš„é…ç½®ã€‚ä¸ç„¶å°±ä¸ä¼šå„ç§cliå·¥å…·å†’å‡ºæ¥äº†ï¼Œæ¯”å¦‚parcelï¼Œcreate-react-appã€‚è¿™äº›å·¥å…·éƒ½å®£ç§°é›¶é…ç½®ï¼Œç›®çš„å°±æ˜¯è®©å¼€å‘è€…èƒ½å¤Ÿæ„‰å¿«çš„è¿›è¡Œä»£ç å¼€å‘ã€‚</p><p><br></p><hr><p><br></p><p>ç°åœ¨æ¥çœ‹çœ‹Vue-cli v3çš„æ”¹è¿›ï¼Œä»¥åŠæ€è€ƒè¿™äº›æœ‰ä»€ä¹ˆæ„ä¹‰å‘¢ï¼Ÿ</p><p><br></p><p><strong>1. æŠ½ç¦»cli serviceå±‚</strong></p><p>Create-React-Appæ˜¯ç¬¬ä¸€ä¸ªåšè¿™ç§äº‹æƒ…çš„ã€‚vue-cli3åº“ç°åœ¨åŒ…å«ä»¥ä¸‹ä¸¤ä¸ªæ¨¡å—ï¼š</p><ul><li><p>CLI: å³vueå…¨å±€å‘½ä»¤ï¼Œä¸»è¦ç”¨äºé¡¹ç›®åˆ›å»ºå’Œç®¡ç†ï¼ŒåŒ…å«äº†<code>vue create</code>ã€<code>vue ui</code>è¿™äº›å‘½ä»¤ã€‚CLIå‘½ä»¤çš„åšçš„äº‹æƒ…æ¯”è¾ƒå°‘ï¼Œæ‰€ä»¥æ›´æ–°ä¸ä¼šå¤ªé¢‘ç¹(å¼€å‘è€…ä¹Ÿå¾ˆå°‘ä¼šå»æ›´æ–°è¿™äº›å‘½ä»¤)</p></li><li><p>Serviceå±‚: è´Ÿè´£é¡¹ç›®çš„å®é™…æ„å»ºï¼Œä¹Ÿå°±æ˜¯webpacké¡¹ç›®æ„å»ºã€‚è¿™ä¸€å—æ˜¯é¢‘ç¹æ›´æ–°çš„ï¼Œä¸€èˆ¬ä½œä¸ºé¡¹ç›®çš„å±€éƒ¨ä¾èµ–ã€‚</p></li></ul><p><br></p><p>OKï¼Œè¿™ä¹ˆåšæœ‰ä»€ä¹ˆæ„ä¹‰å‘¢ï¼Ÿè€ƒè™‘è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼Œè¿™ä¹Ÿæ˜¯ç­”ä¸»ä¹‹å‰é‡åˆ°çš„ä¸€ä¸ªç—›ç‚¹ï¼š</p><p><strong>vue-cli3ä¹‹å‰ä¸ç®—æ˜¯ä¸€ä¸ªæ„å»ºCLI, å®ƒé¡¶å¤šå°±æ˜¯ä¸€ä¸ªæ¨¡æ¿æ‹·è´å™¨, åšçš„äº‹æƒ…éå¸¸å°‘</strong>, æ‰€æœ‰webpacké…ç½®å’Œæ„å»ºå‘½ä»¤éƒ½æ˜¯è€¦åˆåœ¨å…·ä½“çš„é¡¹ç›®é‡Œé¢ï¼Œpackage.jsonä¼šåŒ…å«ä¸€å¤§å †å¼€å‘ä¾èµ–ã€‚</p><p>å¦‚æœå»è·Ÿè¿›webpackæˆ–ç›¸å…³å·¥å…·æ›´æ–°çš„æœ‹å‹ä¼šæœ‰è¿™ç§ä½“ä¼šï¼Œå‡çº§ä¸æ˜¯ä¸€ä»¶å®¹æ˜“çš„äº‹æƒ…ã€‚æ¯”å¦‚ä½ å‡çº§äº†babel-loader, å¯èƒ½è¦è¿å¸¦webpackéƒ½å‡çº§ï¼Œwebpackå‡çº§åå¯èƒ½å…¶ä»–å·¥å…·åˆä¸å…¼å®¹äº†ã€‚</p><p>å‡çº§æ–¹é¢çš„ç—›ç‚¹æ˜¯å…¶ä¸€ã€‚å¦‚æœä½ çš„å›¢é˜Ÿéœ€è¦ç»´æŠ¤å¾ˆå¤šé¡¹ç›®ï¼Œä½ æ€ä¹ˆå¯¹è¿™äº›é¡¹ç›®è¿›è¡Œç»´æŠ¤å‡çº§ï¼Ÿæ¯ä¸ªé¡¹ç›®éƒ½æ‹·è´ä¸€ä¸‹ï¼Ÿå¦‚æœæŸä¸ªé¡¹ç›®åšäº†ç‰¹æ®Šé…ç½®å‘¢ï¼Ÿ</p><p><strong>å¯¹äºå›¢é˜Ÿè€Œè¨€ï¼Œé¡¹ç›®æ„å»ºè¿™ä¸€å—æ˜¯åº”è¯¥å°½é‡åšåˆ°çš„ç»Ÿä¸€å’Œå‚»ç“œåŒ–çš„ï¼Œæ²¡æœ‰å¿…è¦åœ¨è¿™æ–¹é¢æŠ•å…¥å¤ªå¤šçš„ç²¾åŠ›ï¼Œåº”è¯¥æŠŠäº‹æƒ…å¤–åŒ…ç»™æ“…é•¿è¿™ç§äº‹æƒ…çš„äººå»åš</strong>ã€‚</p><p><strong>å¦å¤–ä¸è¦æ’æ–¥æ›´æ–°ï¼Œæ›´æ–°å¯ä»¥è·å¾—æ›´å¥½çš„å¼€å‘ä½“éªŒå’Œæ„å»ºé€Ÿåº¦ã€è¿è¡Œæ€§èƒ½, åˆ«äººåœ¨è¿™æ–¹é¢æ¯”ä½ äº†è§£çš„æ›´å¤š</strong>ã€‚</p><p><strong>åˆ†ç¦»äº†vue-cli-serviceä¹‹åï¼Œé¡¹ç›®æ„å»ºæ›´æ–°åªæ˜¯ä¸€ä¸ªå‘½ä»¤çš„äº‹æƒ…ï¼Œé™¤éåšäº†å¾ˆå¤šç‰¹æ®ŠåŒ–æ“ä½œ</strong>ã€‚<strong>ç‰¹æ®ŠåŒ–æ“ä½œåº”è¯¥å°è£…åˆ°vue-cliçš„æ’ä»¶ä¸­</strong>ã€‚è¿™å°±å¼•å‡ºäº†vue-cli3çš„å¦å¤–ä¸€ä¸ªç‰¹è‰²ï¼šæ’ä»¶</p><p><br></p><hr><p><br></p><p><strong>2. æ’ä»¶åŒ–</strong></p><p>ç›¸æ¯”create-react-app, vue-cliæ˜¯åœ¨å¤ªä»æ…ˆäº†ã€‚vue-cliçš„æ’ä»¶æœºåˆ¶å¾ˆçµæ´»ï¼Œé€šè¿‡<code>webpack-chain</code>å’Œ<code>webpack-merge</code>å¯ä»¥å®ç°webpackå®Œå…¨å®šåˆ¶åŒ–ã€‚</p><p>å¯ä»¥å¯¹æ¯”ä¸€ä¸‹å¸‚é¢ä¸Šæµè¡Œçš„cliå·¥å…·çš„å¯æ‰©å±•æ€§ï¼š</p><table><thead><tr><th></th><th>Vue CLI</th><th>create-react-app</th><th>parcel</th></tr></thead><tbody><tr><td>å¿«é€ŸåŸå‹å¼€å‘</td><td>æ”¯æŒ</td><td>-</td><td>æ”¯æŒ</td></tr><tr><td>å…¨å±€æ¨¡å¼</td><td>é›¶é…ç½®åŸå‹å¼€å‘å°±æ˜¯å…¨å±€çš„</td><td>-</td><td>æ”¯æŒ</td></tr><tr><td>æ’ä»¶</td><td>æ”¯æŒ</td><td>-</td><td>æ”¯æŒï¼Œæ‰©å±•æ–‡ä»¶ç±»å‹å’Œæ–‡ä»¶è¾“å‡º</td></tr><tr><td>æ‰©å±•æ€§</td><td>å¼ºï¼Œé€šè¿‡æ’ä»¶æ‰©å±• wepack é…ç½®</td><td>å¼±, å¼ºçº¦å®š, æ— æ³•é…ç½® webpackï¼Œå¯ä»¥ eject, ç„¶åæ‰‹å·¥é…ç½®ï¼›æ”¯æŒ babel-macro;(ä¸¥æ ¼è¯´å¯ä»¥é€šè¿‡<a href="https://github.com/timarney/react-app-rewired" target="_blank" rel="noopener">react-app-rewired</a>è¿›è¡Œæ‰©å±•)</td><td>ä¸­(å¯ä»¥é…ç½® babelï¼Œpostcssï¼ŒTypescript); æä¾›äº† Node API; æ”¯æŒæ’ä»¶æ‰©å±•æ–‡ä»¶ç±»å‹</td></tr><tr><td>å¤šé¡µé¢</td><td>æ”¯æŒ</td><td>-</td><td>æ”¯æŒ</td></tr><tr><td>é€‚ç”¨èŒƒå›´</td><td>Vue ç»„ä»¶çš„ç¬¬ä¸€å…¬æ°‘ã€‚é€šè¿‡æ‰©å±•å¯ä»¥æ”¯æŒä»»æ„å‰ç«¯æ¡†æ¶</td><td>é’ˆå¯¹ React å¼€å‘ï¼Œä¸æ”¯æŒå…¶ä»–æ¡†æ¶</td><td>parcel æ˜¯ä¸€ä¸ªé€šç”¨çš„æ‰“åŒ…å·¥å…·ï¼Œå®ƒçš„ç«äº‰å¯¹æ‰‹æ˜¯ webpack</td></tr><tr><td>ç¼–è¯‘é€Ÿåº¦</td><td>cache-loader,thread-loader æ¥åŠ é€Ÿ JS å’Œ TS ç¼–è¯‘</td><td>babel-loader å¼€å¯äº† cache</td><td>ç¼–è¯‘é€Ÿåº¦å·ç§°æ˜¯ webpack çš„ä¸¤å€</td></tr><tr><td>å¯å‡çº§æ€§</td><td>æ”¯æŒå‡çº§ cli-service, æ’ä»¶éœ€è¦å•ç‹¬å‡çº§, æ’ä»¶éœ€è¦éµå¾ªè¯­ä¹‰åŒ–ç‰ˆæœ¬. å¤ªå¤šæ’ä»¶å­˜åœ¨å‡çº§é£é™©</td><td>æ”¯æŒå‡çº§ react-script, å®˜æ–¹ç»´æŠ¤ï¼Œä¸”å¼ºçº¦å®šåŸºæœ¬å¯ä»¥ä¿éšœå‘ä¸‹å…¼å®¹</td><td>æ”¯æŒå‡çº§ parcel-bundler</td></tr><tr><td>UI</td><td>å›¾å½¢åŒ–ç®¡ç†æ˜¯ CLI çš„ç‰¹è‰²ä¹‹ä¸€</td><td>-</td><td>-</td></tr></tbody></table><p><br></p><p>å¯¹äºvue-cliçš„æ’ä»¶å®ç°æœºåˆ¶å¯ä»¥çœ‹è¿™ç¯‡<a href="https://juejin.im/post/5cedb26451882566477b7235" target="_blank" rel="noopener">æ–‡ç« </a>ã€‚</p><p>å› ä¸ºvue-cliçµæ´»çš„æ‰©å±•æ€§ï¼Œæ‰€ä»¥å®ƒä¸ä»…é™äºvueæœ¬èº«ï¼Œå¯ä»¥æ‰©å±•æ”¯æŒreactã€anythingâ€¦</p><p>æŒ‰ç…§ä¸Šæ–‡è¯´çš„ï¼Œ<strong>å¦‚æœä½ è¦åšæ·±åº¦çš„vue-cliå®šåˆ¶åŒ–ï¼Œä¸å»ºè®®ç›´æ¥å†™åœ¨vue.config.jsä¸­ï¼Œè€Œæ˜¯å°è£…åœ¨æ’ä»¶ä¸­ï¼Œç‹¬ç«‹çš„ç»´æŠ¤è¿™ä¸ªæ’ä»¶ï¼Œç„¶åé¡¹ç›®å†ä¾èµ–è¿™ä¸ªæ’ä»¶ã€‚è¿™æ ·å°±å¯ä»¥ç®€åŒ–å‡çº§çš„æˆæœ¬å’Œå¤æ‚åº¦</strong>ã€‚</p><p><br></p><hr><p><br></p><p><strong>3. GUIç•Œé¢</strong></p><p>è™½ç„¶å¤§éƒ¨åˆ†äººéƒ½è§‰å¾—ä½œç”¨ä¸å¤§ï¼Œå› ä¸ºç¡®å®å¯¹å¼€å‘æ•ˆç‡å¹¶å®é™…çš„æå‡æ•ˆæœã€‚å°±æ˜¯çœ‹ç€èˆ’æœç›´è§‚ï¼Œè¿™å°±å¤Ÿäº†ã€‚</p><p><br></p><hr><p><br></p><p><strong>4. å¿«é€ŸåŸå‹å¼€å‘</strong></p><p>vue-cli3ä¹Ÿæ”¯æŒç›´æ¥å°†ä¸€ä¸ªvueæ–‡ä»¶è·‘èµ·æ¥ï¼Œå¿«é€ŸåŸå‹å¼€å‘æˆ–éªŒè¯æŸäº›æƒ³æ³•æ—¶ï¼ŒæŒºä¸é”™ã€‚</p><p><br></p><hr><p><br></p><p><strong>5. <a href="https://cli.vuejs.org/guide/browser-compatibility.html#modern-mode" target="_blank" rel="noopener">ç°ä»£æ¨¡å¼</a></strong></p><p>ç»™å…ˆè¿›çš„æµè§ˆå™¨é…åˆå…ˆè¿›çš„ä»£ç (ES6ä¹‹å),åŒæ—¶å…¼å®¹æ—§ç‰ˆæœ¬çš„æµè§ˆå™¨ï¼Œå…ˆè¿›çš„ä»£ç ä¸ç®¡ä»æ–‡ä»¶ä½“ç§¯è¿˜æ˜¯è„šæœ¬è§£ææ•ˆç‡ã€è¿è¡Œæ•ˆç‡éƒ½æœ‰è¾ƒé«˜çš„æå‡ã€‚</p><p>ä½“ç§¯å¯¹æ¯”:</p><table><thead><tr><th>Version</th><th>Size (minified)</th><th>Size (minified + gzipped)</th></tr></thead><tbody><tr><td>ES2015+ (main.mjs)</td><td>80K</td><td>21K</td></tr><tr><td>ES5 (main.es5.js)</td><td>175K</td><td>43K</td></tr></tbody></table><p><br></p><p>è§£ææ•ˆç‡:</p><table><thead><tr><th>Version</th><th>Parse/eval time (individual runs)</th><th>Parse/eval time (avg)</th></tr></thead><tbody><tr><td>ES2015+ (main.mjs)</td><td>184ms, 164ms, 166ms</td><td>172ms</td></tr><tr><td>ES5 (main.es5.js)</td><td>389ms, 351ms, 360ms</td><td>367ms</td></tr></tbody></table><p><br></p><hr><p><br></p><p><strong>6. Standard Tooling for Vue.js Development</strong></p><p>è¿™æ˜¯vue-cliçš„å®˜æ–¹ä»‹ç»ï¼Œvueæ ‡å‡†å¼€å‘å·¥å…·. è·Ÿè¿›vue-cliå°±æ˜¯è·Ÿè¿›å®˜æ–¹çš„æœ€ä½³å®è·µå’Œå‰æ²¿æŠ€æœ¯ï¼Œvueå›¢é˜Ÿå·²ç»ä¸ºä½ è€ƒè™‘å¾ˆå¤šåº”ç”¨åœºæ™¯, why not?</p><p><br></p><hr><p><br></p><p><strong>æ€»ç»“ä¸€ä¸‹</strong>ï¼š</p><ul><li><p>å¦‚æœæˆ‘ä»¬å–œæ¬¢æŠ˜è…¾ï¼Œè‚¯å®šä¼šè§‰å¾—vue-cli3æŸæ‰‹æŸè„šï¼Œè¿™æ—¶å€™æˆ‘ä»¬ä¸æ˜¯vue-cli3çš„ç›®æ ‡ç”¨æˆ·ï¼›</p><p>å°±æ¯”å¦‚æˆ‘ä»¬å›¢é˜Ÿå°±è‡ªå·±æäº†ä¸€ä¸€ä¸ªCLIæ„å»ºå·¥å…·: <a href="https://github.com/GDJiaMi/jm-cli" target="_blank" rel="noopener">jm-cli</a>, æ ¹æ®è‡ªå·±çš„å›¢é˜Ÿéœ€æ±‚è¿›è¡Œæ·±åº¦å®šåˆ¶ï¼Œä¸è¿‡æˆ‘ä»¬è¿™ä¸ªå·¥å…·æ˜¯å¼ºçº¦å®šçš„ï¼ŒåŒ…æ‹¬ç›®å½•ç»“æ„ã€ç¼–ç è§„èŒƒç­‰ç­‰. å› ä¸ºæˆ‘ä»¬ä¸æ¨èå›¢é˜Ÿæˆå‘˜å»æç‰¹æ®ŠåŒ–å®šåˆ¶ï¼Œè€Œä¸”ä¸ºäº†æ–¹ä¾¿è¿›è¡Œæ›´æ–°ï¼Œæ‰€ä»¥å¹²è„†å°±ä¸è®©æ‰©å±•äº†ï¼Œ<strong>ç»Ÿä¸€å’Œè§„èŒƒå¯¹å›¢é˜Ÿæ¥è¯´æ‰æ˜¯æœ€é‡è¦çš„</strong>.</p><p><strong>å¦‚æœä½ æœ‰ç±»ä¼¼çš„å¼€å‘ç»éªŒï¼Œä½ ä¼šè§‰å¾—vue-cliå¯èƒ½æ˜¯æ‰€æœ‰æ„å»ºCLIçš„æœ€ç»ˆå½’å®¿æˆ–è€…å…¸èŒƒ</strong>ã€‚</p></li><li><p>å¦‚æœä¸æƒ³æŠ˜è…¾ï¼Œåªæƒ³å†™ä»£ç , è€Œä¸”æƒ³è·Ÿè¿›vueå®˜æ–¹æœ€æ–°å®è·µï¼Œé‚£å°±ç›´æ¥æ‹¿æ¥ç”¨å§ï¼›</p></li><li>å¦‚æœæƒ³æŠ˜è…¾ï¼Œåˆè¦è€ƒè™‘å›¢é˜Ÿåä½œå’Œæ„å»ºå·¥å…·é“¾çš„ç»´æŠ¤æˆæœ¬ï¼Œvue-cliæ˜¯å¾ˆé€‚åˆçš„ã€‚å½“ç„¶ä½ ä¹Ÿå¯ä»¥é€ è½®å­</li><li>å¦‚æœæƒ³å­¦webpackçš„æ„å»ºé¡¹ç›®ï¼Œä¹Ÿä¸æ¨èä½ ä½¿ç”¨vue-cli</li></ul><p><br></p><p>æœ€åç»™vueå›¢é˜Ÿç‚¹ä¸ªèµğŸ‘</p><p>æ¬¢è¿å…³æ³¨æˆ‘ï¼Œå’Œæˆ‘äº¤æµ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;[é—®ç­”]&lt;/code&gt;ç³»åˆ—ä¸»è¦æ•´ç†&lt;a href=&quot;https://segmentfault.com/q/1010000019785471&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;SegmentFault&lt;/a&gt;
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://bobi.ink/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>ç°ä»£è„šæœ¬çš„åŠ è½½</title>
    <link href="https://bobi.ink/2019/07/17/modern-module/"/>
    <id>https://bobi.ink/2019/07/17/modern-module/</id>
    <published>2019-07-16T16:00:00.000Z</published>
    <updated>2019-07-18T23:21:49.165Z</updated>
    
    <content type="html"><![CDATA[<p>åŸæ–‡åœ°å€: <a href="https://jasonformat.com/modern-script-loading/" target="_blank" rel="noopener">Modern Script Loading</a>, æ–‡ç« ä½œè€…æ˜¯Preactä½œè€…<a href="https://twitter.com/_developit" target="_blank" rel="noopener">Jason Miller</a></p><p><br></p><p><img src="/images/modern-module/modern-script-loading.jpg" alt></p><p><br></p><h2 id="èƒŒæ™¯çŸ¥è¯†"><a href="#èƒŒæ™¯çŸ¥è¯†" class="headerlink" title="èƒŒæ™¯çŸ¥è¯†"></a>èƒŒæ™¯çŸ¥è¯†</h2><p>å…ˆç®€å•ä»‹ç»ä¸€ä¸‹<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Modules" target="_blank" rel="noopener"><code>æ¨¡å—script(Module script)</code></a>, å®ƒæŒ‡çš„æ˜¯<strong>ç°ä»£æµè§ˆå™¨æ”¯æŒé€šè¿‡<code>&lt;script type=module src=main.js&gt;&lt;/script&gt;</code>æ¥åŠ è½½ç°ä»£çš„ES6æ¨¡å—</strong>. ç°ä»£æµè§ˆå™¨å¯¹ES6ç°ä»£è¯­æ³•æœ‰è‰¯å¥½çš„æ”¯æŒï¼Œè¿™æ„å‘³ç€<strong>æˆ‘ä»¬å¯ä»¥ç»™è¿™äº›ç°ä»£æµè§ˆå™¨æä¾›æ›´ç´§å‡‘çš„â€˜ç°ä»£ä»£ç â€™ï¼Œä¸€æ–¹é¢å¯ä»¥å‡å°æ‰“åŒ…çš„ä½“ç§¯ï¼Œå‡å°‘ç½‘ç»œä¼ è¾“çš„å¸¦å®½ï¼Œå¦å¤–è¿˜å¯ä»¥æé«˜è„šæœ¬è§£æçš„æ•ˆç‡å’Œè¿è¡Œæ•ˆç‡</strong>.</p><p>ä¸‹å›¾æ¥æºäº<a href="https://philipwalton.com/articles/deploying-es2015-code-in-production-today/" target="_blank" rel="noopener"><code>module/nomodule pattern</code></a>, å¯¹æ¯”äº†<strong>æ¨¡å—script</strong>å’Œ<strong>ä¼ ç»Ÿ(legacy) script</strong>çš„æ€§èƒ½:</p><p>ä½“ç§¯å¯¹æ¯”:</p><table><thead><tr><th>Version</th><th>Size (minified)</th><th>Size (minified + gzipped)</th></tr></thead><tbody><tr><td>ES2015+ (main.mjs)</td><td>80K</td><td>21K</td></tr><tr><td>ES5 (main.es5.js)</td><td>175K</td><td>43K</td></tr></tbody></table><p><br></p><p>è§£ææ•ˆç‡:</p><table><thead><tr><th>Version</th><th>Parse/eval time (individual runs)</th><th>Parse/eval time (avg)</th></tr></thead><tbody><tr><td>ES2015+ (main.mjs)</td><td>184ms, 164ms, 166ms</td><td>172ms</td></tr><tr><td>ES5 (main.es5.js)</td><td>389ms, 351ms, 360ms</td><td>367ms</td></tr></tbody></table><p><br></p><p>Okï¼Œä¸ºäº†å…¼å®¹æ—§æµè§ˆå™¨, <a href="https://philipwalton.com/articles/deploying-es2015-code-in-production-today/" target="_blank" rel="noopener">module/nomodule pattern</a>è¿™ç¯‡æ–‡ç« ä»‹ç»äº†ä¸€ç§<strong>module/nomodule æ¨¡å¼</strong>, ç®€å•è¯´å°±æ˜¯<strong>åŒæ—¶æä¾›ä¸¤ä¸ªscript, ç”±æµè§ˆå™¨æ¥å†³å®šåŠ è½½å“ªä¸ªæ–‡ä»¶</strong>ï¼š</p><p><br></p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- æ”¯æŒæ¨¡å—scriptçš„æµè§ˆå™¨ä¼šåŠ è½½è¿™ä¸ªæ–‡ä»¶ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"module"</span> <span class="attr">src</span>=<span class="string">"main.mjs"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- æ—§æµè§ˆå™¨ä¼šåŠ è½½è¿™ä¸ªæ–‡ä»¶ --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- å› ä¸ºåŠ äº†nomdule, æ‰€ä»¥ç°ä»£æµè§ˆå™¨ä¸ä¼šåŠ è½½è¯¥æ–‡ä»¶ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">nomodule</span> <span class="attr">src</span>=<span class="string">"main.es5.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p><br></p><p>çœ‹èµ·æ¥å¾ˆç¾å¥½æ˜¯å§? ç°å®æ˜¯ï¼š<strong>ä¸­é—´å­˜åœ¨ä¸€äº›æµè§ˆå™¨ï¼Œå®ƒä»¬å¯ä»¥è¯†åˆ«<code>æ¨¡å—script</code>ä½†æ˜¯ä¸è®¤è¯†<code>nomodule</code>å±æ€§, è¿™å°±å¯¼è‡´äº†è¿™äº›æµè§ˆå™¨ä¼šåŒæ—¶åŠ è½½è¿™ä¸¤ä¸ªæ–‡ä»¶(ä¸‹æ–‡ç»Ÿä¸€ç§°ä¸ºâ€˜åŒé‡åŠ è½½â€™(over-fetching))</strong>.</p><p><br><br><br></p><blockquote><p>OKï¼Œæ­£å¼è¿›å…¥æ­£æ–‡. ç»™æ­£ç¡®çš„æµè§ˆå™¨äº¤ä»˜æ­£ç¡®ä»£ç æ˜¯ä¸€ä»¶æ£˜æ‰‹çš„äº‹æƒ…ã€‚æœ¬æ–‡ä¼šä»‹ç»å‡ ç§æ–¹å¼, æ¥è§£å†³ä¸Šè¿°çš„é—®é¢˜:</p></blockquote><p>ç»™ç°ä»£æµè§ˆå™¨ä¼ºæœâ€™ç°ä»£çš„ä»£ç â€™å¯¹æ€§èƒ½æœ‰å¾ˆå¤§çš„å¸®åŠ©ã€‚æ‰€ä»¥ä½ åº”è¯¥é’ˆå¯¹ç°ä»£æµè§ˆå™¨æä¾›åŒ…å«æ›´ç´§å‡‘å’Œä¼˜åŒ–çš„ç°ä»£è¯­æ³•çš„JavascriptåŒ…ï¼ŒåŒæ—¶åˆå¯ä»¥ä¿æŒå¯¹æ—§æµè§ˆå™¨çš„æ”¯æŒ</p><p>ç°æœ‰çš„å·¥å…·é“¾çš„ç”Ÿæ€ç³»ç»ŸåŸºæœ¬éƒ½æ˜¯åœ¨<code>module/nomoduleæ¨¡å¼</code>ä¸Šæ•´åˆçš„ï¼Œå®ƒå£°æ˜å¼åŠ è½½ç°ä»£å’Œä¼ ç»Ÿä»£ç (legacy code)ï¼Œå³ç»™æµè§ˆå™¨æä¾›ä¸¤ä¸ªæºä»£ç ï¼Œè®©å®ƒæ¥è‡ªå·±æ¥å†³å®šç”¨å“ªä¸ª:</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"module"</span> <span class="attr">src</span>=<span class="string">"/modern.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">nomodule</span> <span class="attr">src</span>=<span class="string">"/legacy.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ç„¶è€Œç°å®æ€»æ˜¯ç»™ä½ å½“å¤´ä¸€æ£’ï¼Œå®ƒæ²¡æˆ‘ä»¬æœŸæœ›çš„é‚£ä¹ˆç®€å•ç›´æ¥ã€‚ä¸Šè¿°åŸºäºHTMLçš„åŠ è½½æ–¹å¼åœ¨<a href="https://gist.github.com/jakub-g/5fc11af85a061ca29cc84892f1059fec" target="_blank" rel="noopener"><strong>Edgeå’ŒSafariä¸­ä¼šè¢«åŒæ—¶åŠ è½½</strong></a>!</p><p><br></p><h2 id="æ€ä¹ˆåŠ"><a href="#æ€ä¹ˆåŠ" class="headerlink" title="æ€ä¹ˆåŠ?"></a>æ€ä¹ˆåŠ?</h2><p>æ€ä¹ˆåŠï¼Ÿæˆ‘ä»¬æƒ³ä¾èµ–æµè§ˆå™¨æ¥äº¤ä»˜ä¸åŒçš„ç¼–è¯‘ç›®æ ‡ï¼Œä½†æ˜¯ä¸€äº›æ—§æµè§ˆå™¨å¹¶ä¸èƒ½ä¼˜é›…åœ°æ”¯æŒè¿™ç§ç®€æ´çš„å†™æ³•ã€‚</p><p>é¦–å…ˆï¼ŒSafari åœ¨10.1å¼€å§‹æ”¯æŒJSæ¨¡å—, ä½†ä¸æ”¯æŒnomoduleå±æ€§ã€‚å€¼å¾—åº†å¹¸çš„æ˜¯ï¼ŒSamæ‰¾åˆ°äº†ä¸€ç§æ–¹æ³•ï¼Œå¯ä»¥é€šè¿‡Safari 10å’Œ11ä¸­éæ ‡å‡†çš„beforeloadäº‹ä»¶æ¥æ¨¡æ‹Ÿ nomodule, ä¹Ÿå°±æ˜¯å¯ä»¥è®¤ä¸ºSafari 10.1å¼€å§‹æ˜¯å¯ä»¥æ”¯æŒ<code>module/nomoduleæ¨¡å¼</code></p><p><br></p><h2 id="é€‰é¡¹1-åŠ¨æ€åŠ è½½"><a href="#é€‰é¡¹1-åŠ¨æ€åŠ è½½" class="headerlink" title="é€‰é¡¹1: åŠ¨æ€åŠ è½½"></a>é€‰é¡¹1: åŠ¨æ€åŠ è½½</h2><p>æˆ‘ä»¬å¯ä»¥å®ç°ä¸€ä¸ªå°å‹scriptåŠ è½½å™¨æ¥è§„é¿è¿™ä¸ªé—®é¢˜ï¼Œå·¥ä½œåŸç†ç±»ä¼¼äº<a href="https://github.com/filamentgroup/loadCSS" target="_blank" rel="noopener">LoadCSS</a>ã€‚åªä¸è¿‡è¿™é‡Œéœ€è¦ä¾é æµè§ˆå™¨çš„æ¥å®ç°ESæ¨¡å—å’Œnomoduleå±æ€§.</p><p>æˆ‘ä»¬é¦–å…ˆå°è¯•æ‰§è¡Œä¸€ä¸ªæ¨¡å—scriptè¿›è¡Œâ€™çŸ³è•Šè¯•éªŒâ€™(litmus test), ç„¶åç”±è¿™ä¸ªè¯•éªŒçš„ç»“æœæ¥å†³å®šåŠ è½½ç°ä»£ä»£ç è¿˜æ˜¯ä¼ ç»Ÿä»£ç :</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ä½¿ç”¨ä¸€ä¸ªæ¨¡å—scriptæ¥æ£€æµ‹æ˜¯å¦æ˜¯ç°ä»£æµè§ˆå™¨ --&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">module</span>&gt;</span><span class="undefined">  </span></span><br><span class="line"><span class="javascript">  self.modern = <span class="literal">true</span></span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- ç°åœ¨æ ¹æ®è¿™ä¸ªæ£€æµ‹ç»“æœæ¥å†³å®šåŠ è½½ç°ä»£ä»£ç è¿˜æ˜¯ä¼ ç»Ÿä»£ç : --&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">  </span></span><br><span class="line"><span class="javascript">  addEventListener(<span class="string">'load'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> s = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>)</span></span><br><span class="line"><span class="javascript">    <span class="keyword">if</span> (self.modern) &#123;</span></span><br><span class="line"><span class="javascript">      s.src = <span class="string">'/modern.js'</span></span></span><br><span class="line"><span class="javascript">      s.type = <span class="string">'module'</span></span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">      s.src = <span class="string">'/legacy.js'</span></span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">document</span>.head.appendChild(s)</span></span><br><span class="line"><span class="undefined">  &#125;)</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ç„¶è€Œï¼Œè¿™ä¸ªè§£å†³æ–¹æ¡ˆå¿…é¡»ç­‰å¾…è¿›è¡Œâ€˜çŸ³è•Šè¯•éªŒâ€™æ¨¡å—scriptæ‰§è¡Œå®Œæˆ, æ‰èƒ½å¼€å§‹æ³¨å…¥scriptã€‚è¿™æ˜¯å› ä¸º<code>&lt;script type=module&gt;</code>å§‹ç»ˆæ˜¯å¼‚æ­¥çš„ï¼Œæ‰€ä»¥åˆ«æ— å®ƒæ³•(å»¶è¿Ÿåˆ°loadäº‹ä»¶å)ã€‚</p><p>å¦ä¸€ç§å®ç°æ–¹å¼æ˜¯æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒ<code>nomodule</code>, è¿™æ˜¯æ–¹å¼å¯ä»¥é¿å…ä¸Šè¿°çš„å»¶è¿ŸåŠ è½½é—®é¢˜, åªä¸è¿‡è¿™æ„å‘³ç€åƒSafari 10.1è¿™äº›æ”¯æŒæ¨¡å—, å´ä¸æ”¯æŒnomoduleçš„æµè§ˆå™¨ä¹Ÿä¼šè¢«å½“åšä¼ ç»Ÿæµè§ˆå™¨ï¼Œè¿™ä¹Ÿè®¸<a href="https://github.com/web-padawan/polymer3-webpack-starter/issues/33#issuecomment-474993984" target="_blank" rel="noopener">å¯èƒ½</a>æ˜¯<a href="https://jasonformat.com/modern-script-loading/" target="_blank" rel="noopener">å¥½äº‹</a>(ç›¸å¯¹äºä¸¤ä¸ªè„šæœ¬éƒ½åŠ è½½ä»¥åŠæœ‰ä¸€äº›bug)ï¼Œä»£ç å¦‚ä¸‹:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> s = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>)  </span><br><span class="line"><span class="keyword">if</span> (<span class="string">'noModule'</span> <span class="keyword">in</span> s) &#123;  <span class="comment">// æ³¨æ„è¿™é‡Œçš„å¤§å°å†™</span></span><br><span class="line">  s.type = <span class="string">'module'</span></span><br><span class="line">  s.src = <span class="string">'/modern.js'</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>  </span><br><span class="line">  s.src = <span class="string">'/legacy.js'</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">document</span>.head.appendChild(s)</span><br></pre></td></tr></table></figure><p>ç°åœ¨æŠŠå®ƒä»¬å°è£…æˆå‡½æ•°ï¼Œå¹¶ç¡®ä¿ä¸¤ç§æ–¹å¼éƒ½ç»Ÿä¸€ä½¿ç”¨å¼‚æ­¥çš„æ–¹å¼åŠ è½½(ä¸Šæ–‡æåˆ°æ¨¡å—scriptæ˜¯å¼‚æ­¥çš„ï¼Œè€Œä¼ ç»Ÿscriptä¸æ˜¯):</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">  </span></span><br><span class="line"><span class="javascript">  $loadjs(<span class="string">"/modern.js"</span>,<span class="string">"/legacy.js"</span>)</span></span><br><span class="line"><span class="javascript">  <span class="function"><span class="keyword">function</span> <span class="title">$loadjs</span>(<span class="params">src,fallback,s</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">    s = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>)</span></span><br><span class="line"><span class="javascript">    <span class="keyword">if</span> (<span class="string">'noModule'</span> <span class="keyword">in</span> s) s.type = <span class="string">'module'</span>, s.src = src</span></span><br><span class="line"><span class="javascript">    <span class="keyword">else</span> s.async = <span class="literal">true</span>, s.src = fallback   <span class="comment">// ç»Ÿä¸€ä½¿ç”¨å¼‚æ­¥æ–¹å¼åŠ è½½</span></span></span><br><span class="line"><span class="javascript">    <span class="built_in">document</span>.head.appendChild(s)</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p><br></p><p>çœ‹èµ·æ¥å·²ç»å¾ˆå®Œç¾äº†ï¼Œè¿˜æœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ<strong>æˆ‘ä»¬è¿˜æ²¡è€ƒè™‘é¢„åŠ è½½(preloading)</strong></p><p>è¿™ä¸ªæœ‰ç‚¹è›‹ç–¼ï¼Œ å› ä¸ºä¸€èˆ¬æµè§ˆå™¨åªä¼šé™æ€åœ°æ‰«æHTMLï¼Œç„¶åæŸ¥æ‰¾å®ƒå¯ä»¥é¢„åŠ è½½çš„èµ„æºã€‚ æˆ‘ä»¬ä¸Šé¢ä»‹ç»çš„æ¨¡å—åŠ è½½å™¨æ˜¯å®Œå…¨åŠ¨æ€çš„ï¼Œæ‰€ä»¥æµè§ˆå™¨åœ¨æ²¡æœ‰è¿è¡Œæˆ‘ä»¬çš„ä»£ç ä¹‹å‰ï¼Œæ˜¯æ²¡åŠæ³•å‘ç°æˆ‘ä»¬è¦é¢„åŠ è½½ç°ä»£è¿˜æ˜¯ä¼ ç»Ÿçš„Javascriptèµ„æºçš„ã€‚</p><p>ä¸è¿‡æœ‰ä¸€ä¸ªè§£å†³åŠæ³•ï¼Œå°±æ˜¯ä¸å®Œç¾ï¼šå°±æ˜¯ä½¿ç”¨<code>&lt;link rel=modulepreload&gt;</code>æ¥é¢„åŠ è½½ç°ä»£ç‰ˆæœ¬çš„åŒ…, æ—§æµè§ˆå™¨ä¼šå¿½ç•¥è¿™æ¡è§„åˆ™ï¼Œç„¶è€Œç›®å‰<a href="https://developers.google.com/web/updates/2017/12/modulepreload" target="_blank" rel="noopener">åªæœ‰Chromeæ”¯æŒè¿™ä¹ˆåš</a>:</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"modulepreload"</span> <span class="attr">href</span>=<span class="string">"/modern.js"</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">module</span>&gt;</span><span class="undefined">self.modern=1</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>  </span><br><span class="line"><span class="comment">&lt;!-- etc --&gt;</span></span><br></pre></td></tr></table></figure><p><strong>å…¶å®é¢„åŠ è½½è¿™ç§æŠ€æœ¯æ˜¯å¦æœ‰æ•ˆï¼Œå–å†³äºåµŒå…¥ä½ çš„è„šæœ¬çš„HTMLæ–‡æ¡£çš„å¤§å°</strong>ã€‚</p><p>å¦‚æœä½ çš„HTMLè½½è·å¾ˆå°, æ¯”å¦‚åªæ˜¯ä¸€ä¸ªå¯åŠ¨å±æˆ–è€…åªæ˜¯ç®€å•å¯åŠ¨å®¢æˆ·ç«¯åº”ç”¨ï¼Œé‚£ä¹ˆæ”¾å¼ƒé¢„åŠ è½½æ‰«æå¯¹ä½ çš„åº”ç”¨æ€§èƒ½å½±å“å¾ˆå°ã€‚<br>å¦‚æœä½ çš„åº”ç”¨ä½¿ç”¨æœåŠ¡å™¨æ¸²æŸ“å¤§é‡æœ‰æ„ä¹‰çš„HTML, å¹¶ä»¥æµ(stream)çš„æ–¹å¼ä¼ è¾“ç»™æµè§ˆå™¨ï¼Œé‚£ä¹ˆé¢„åŠ è½½æ‰«æå°±æ˜¯ä½ çš„æœ‹å‹ï¼Œä½†è¿™ä¹Ÿæœªå¿…æ˜¯æœ€ä½³æ–¹æ³•ã€‚</p><blockquote><p>è¯‘æ³¨: ç°ä»£æµè§ˆå™¨éƒ½æ”¯æŒåˆ†å—ç¼–ç ä¼ è¾“ï¼Œç­‰æœåŠ¡ç«¯å®Œå…¨è¾“å‡ºhtmlå¯èƒ½æœ‰ä¸€æ®µç©ºé—²æ—¶é—´ï¼Œè¿™æ—¶å€™å¯ä»¥é€šè¿‡é¢„åŠ è½½æŠ€æœ¯ï¼Œè®©æµè§ˆå™¨é¢„å…ˆå»è¯·æ±‚èµ„æº</p></blockquote><p>å¤§æ¦‚ä»£ç å¦‚ä¸‹:</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"modulepreload"</span> <span class="attr">href</span>=<span class="string">"/modern.js"</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">module</span>&gt;</span><span class="undefined">self.modern=1</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">  </span></span><br><span class="line"><span class="javascript">  $loadjs(<span class="string">"/modern.js"</span>,<span class="string">"/legacy.js"</span>)</span></span><br><span class="line"><span class="javascript">  <span class="function"><span class="keyword">function</span> <span class="title">$loadjs</span>(<span class="params">e,d,c</span>)</span>&#123;c=<span class="built_in">document</span>.createElement(<span class="string">"script"</span>),self.modern?(c.src=e,c.type=<span class="string">"module"</span>):c.src=d,<span class="built_in">document</span>.head.appendChild(c)&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è¿˜è¦æŒ‡å‡ºçš„æ˜¯ï¼Œæ”¯æŒ<a href="https://caniuse.com/#feat=es6-module" target="_blank" rel="noopener">JSæ¨¡å—çš„æµè§ˆå™¨</a>ä¸€èˆ¬ä¹Ÿ<a href="https://caniuse.com/#feat=link-rel-preload" target="_blank" rel="noopener">æ”¯æŒ</a><code>&lt;link rel = preload&gt;</code>ã€‚å¯¹äºæŸäº›ç½‘ç«™ï¼Œç›¸æ¯”ä¾é <code>modulepreload</code>, ä½¿ç”¨<code>&lt;link rel=preload as=script crossorigin&gt;</code>å¯èƒ½æ›´æœ‰æ„ä¹‰ã€‚ä¸è¿‡æ€§èƒ½ä¸Šé¢å¯èƒ½æ¬ ç‚¹ï¼Œå› ä¸ºä¼ ç»Ÿçš„è„šæœ¬é¢„åŠ è½½ä¸ä¼šåƒ<code>modulepreload</code>ä¸€æ ·éšç€æ—¶é—´çš„æ¨ç§»è€Œå»å±•å¼€è§£æå·¥ä½œ(<code>rel=preload</code>åªæ˜¯ä¸‹è½½ï¼Œä¸ä¼šå°è¯•å»è§£æè„šæœ¬)ã€‚</p><p><br></p><h2 id="é€‰é¡¹2-ç”¨æˆ·ä»£ç†å—…æ¢"><a href="#é€‰é¡¹2-ç”¨æˆ·ä»£ç†å—…æ¢" class="headerlink" title="é€‰é¡¹2: ç”¨æˆ·ä»£ç†å—…æ¢"></a>é€‰é¡¹2: ç”¨æˆ·ä»£ç†å—…æ¢</h2><p>æˆ‘åŠæ³•æ‹¿å‡ºä¸€ä¸ªç®€æ´çš„ä»£ç ç¤ºä¾‹ï¼Œå› ä¸ºç”¨æˆ·ä»£ç†æ£€æµ‹ä¸åœ¨æœ¬æ–‡çš„èŒƒå›´ä¹‹å†…ï¼Œæ¨èé˜…è¯»è¿™ç¯‡<a href="https://www.smashingmagazine.com/2018/10/smart-bundling-legacy-code-browsers/" target="_blank" rel="noopener">Smashing Magazineæ–‡ç« </a></p><p>æœ¬è´¨ä¸Šï¼Œ<strong>è¿™ç§æŠ€æœ¯åœ¨æ¯ä¸ªæµè§ˆå™¨ä¸Šéƒ½ä½¿ç”¨<code>&lt;script src=bundle.js&gt;</code>æ¥åŠ è½½ä»£ç ï¼Œå½“<code>bundle.js</code>è¢«è¯·æ±‚æ—¶ï¼ŒæœåŠ¡å™¨ä¼šè§£ææµè§ˆå™¨çš„ç”¨æˆ·ä»£ç†ï¼Œå¹¶é€‰æ‹©è¿”å›ç°ä»£ä»£ç è¿˜æ˜¯ä¼ ç»Ÿä»£ç ï¼Œå–å†³äºæµè§ˆå™¨æ˜¯å¦èƒ½è¢«è¯†åˆ«ä¸ºç°ä»£æµè§ˆå™¨</strong>.</p><p>å°½ç®¡è¿™ç§æ–¹æ³•æ¯”è¾ƒé€šç”¨ï¼Œä½†å®ƒä¹Ÿæœ‰ä¸€äº›ä¸¥é‡çš„ç¼ºç‚¹ï¼š</p><ul><li>å› ä¸ºä¾èµ–äºæœåŠ¡ç«¯å®ç°ï¼Œæ‰€ä»¥å‰ç«¯èµ„æºä¸èƒ½è¢«é™æ€éƒ¨ç½²(ä¾‹å¦‚é™æ€ç½‘ç«™ç”Ÿæˆå™¨(å¦‚github page)ï¼ŒNetlifyç­‰ç­‰)</li><li>å¾ˆéš¾è¿›è¡Œæœ‰æ•ˆçš„ç¼“å­˜. ç°åœ¨è¿™äº›JavaScript URLçš„ç¼“å­˜ä¼šå› ç”¨æˆ·ä»£ç†è€Œå¼‚ï¼Œè¿™æ˜¯éå¸¸ä¸ç¨³å®šçš„, è€Œå¾ˆå¤šç¼“å­˜æœºåˆ¶åªæ˜¯å°†URLä½œä¸ºç¼“å­˜é”®ï¼Œç°åœ¨è¿™äº›ç¼“å­˜ä¸­é—´ä»¶å¯èƒ½å°±æ²¡åŠæ³•å·¥ä½œäº†ã€‚</li><li>UAæ£€æµ‹å¾ˆéš¾ï¼Œå®¹æ˜“å‡ºç°è¯¯æŠ¥</li><li>ç”¨æˆ·ä»£ç†å­—ç¬¦ä¸²å®¹æ˜“è¢«ç¯¡æ”¹ï¼Œè€Œä¸”æ¯å¤©éƒ½æœ‰æ–°çš„UAå‡ºç°</li></ul><p>è§£å†³è¿™äº›é™åˆ¶çš„ä¸€ç§æ–¹æ³•å°±æ˜¯<strong>å°†<code>module/nomoduleæ¨¡å¼</code>ä¸â€™ç”¨æˆ·ä»£ç†åŒºåˆ†â€™ç»“åˆèµ·æ¥</strong>ï¼Œé¦–å…ˆè¿™å¯ä»¥é¿å…å•çº¯çš„<code>module/nomoduleæ¨¡å¼</code>éœ€è¦å‘é€å¤šä¸ªè½¯ä»¶åŒ…é—®é¢˜ï¼Œå°½ç®¡è¿™ç§æ–¹æ³•ä»ç„¶ä¼šé™ä½é¡µé¢(è¿™æ—¶å€™æŒ‡HTMLï¼Œè€Œä¸æ˜¯JavascriptåŒ…)çš„å¯ç¼“å­˜æ€§ï¼Œä½†æ˜¯å®ƒå¯ä»¥æœ‰æ•ˆåœ°è§¦å‘é¢„åŠ è½½ï¼Œå› ä¸ºç”ŸæˆHTMLçš„æœåŠ¡å™¨æ ¹æ®ç”¨æˆ·ä»£ç†çŸ¥é“åº”è¯¥ä½¿ç”¨<code>modulepreload</code>è¿˜æ˜¯<code>preload</code>:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">renderPage</span>(<span class="params">request, response</span>) </span>&#123;  </span><br><span class="line">  <span class="keyword">let</span> html = <span class="string">`&lt;html&gt;&lt;head&gt;...`</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> agent = request.headers.userAgent;</span><br><span class="line">  <span class="keyword">const</span> isModern = userAgent.isModern(agent);</span><br><span class="line">  <span class="keyword">if</span> (isModern) &#123;</span><br><span class="line">    html += <span class="string">`</span></span><br><span class="line"><span class="string">      &lt;link rel=modulepreload href=modern.mjs&gt;</span></span><br><span class="line"><span class="string">      &lt;script type=module src=modern.mjs&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">    `</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    html += <span class="string">`</span></span><br><span class="line"><span class="string">      &lt;link rel=preload as=script href=legacy.js&gt;</span></span><br><span class="line"><span class="string">      &lt;script src=legacy.js&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">    `</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  response.end(html);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºé‚£äº›å·²ç»åœ¨ä½¿ç”¨æœåŠ¡ç«¯æ¸²æŸ“çš„ç½‘ç«™æ¥è¯´ï¼Œç”¨æˆ·ä»£ç†å—…æ¢æ˜¯ä¸€ä¸ªæ¯”è¾ƒæœ‰æ•ˆçš„è§£å†³æ–¹æ¡ˆ</p><p><br></p><h2 id="é€‰é¡¹-3-ä¸è€ƒè™‘æ—§ç‰ˆæœ¬æµè§ˆå™¨"><a href="#é€‰é¡¹-3-ä¸è€ƒè™‘æ—§ç‰ˆæœ¬æµè§ˆå™¨" class="headerlink" title="é€‰é¡¹ 3:ä¸è€ƒè™‘æ—§ç‰ˆæœ¬æµè§ˆå™¨"></a>é€‰é¡¹ 3:ä¸è€ƒè™‘æ—§ç‰ˆæœ¬æµè§ˆå™¨</h2><p><strong>æ³¨æ„è¿™é‡Œçš„â€˜æ—§ç‰ˆæœ¬æµè§ˆå™¨â€™ç‰¹æŒ‡é‚£äº›å‡ºç°åŒé‡åŠ è½½çš„æµè§ˆå™¨</strong>. å¯¹äº<code>module/nomoduleæ¨¡å¼</code>æ”¯æŒæ¯”è¾ƒå·®(å³åŒé‡åŠ è½½)çš„ä¸»è¦æ˜¯ä¸€äº›æ—§ç‰ˆæœ¬çš„Chromeã€Firefoxå’ŒSafari. å¹¸è¿çš„æ˜¯è¿™éƒ¨åˆ†æµè§ˆå™¨çš„å¸‚åœºèŒƒå›´é€šå¸¸æ˜¯æ¯”è¾ƒçª„ï¼Œå› ä¸ºç”¨æˆ·ä¼šè‡ªåŠ¨å‡çº§åˆ°æœ€æ–°çš„ç‰ˆæœ¬ã€‚Edge 16-18æ˜¯ä¾‹å¤–, ä½†è¿˜æœ‰å¸Œæœ›ï¼š æ–°ç‰ˆæœ¬çš„Edgeä¼šä½¿ç”¨åŸºäºChromiumçš„æ¸²æŸ“å™¨ï¼Œå¯ä»¥ä¸å—è¯¥é—®é¢˜çš„å½±å“.</p><p>å¯¹äºæŸäº›åº”ç”¨ç¨‹åºæ¥è¯´ï¼Œæ¥å—è¿™ä¸€ç‚¹å¦¥åæ˜¯å®Œå…¨åˆç†çš„ï¼šä½ å¯ä»¥ç»™90ï¼…çš„æµè§ˆå™¨ä¸­æä¾›ç°ä»£ä»£ç ï¼Œè®©ä»–ä»¬è·å¾—æ›´å¥½çš„ä½“éªŒï¼Œè€Œæå°‘æ•°æ—§æµè§ˆå™¨ä¸å¾—ä¸æŠ›å¼ƒå®ƒä»¬ï¼Œå®ƒä»¬åªæ˜¯ä»˜å‡ºçš„é¢å¤–å¸¦å®½(å³åŒé‡åŠ è½½)ï¼Œå¹¶ä¸å½±å“åŠŸèƒ½ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå æ®ç§»åŠ¨ç«¯ä¸»è¦å¸‚åœºä»½é¢çš„ç”¨æˆ·ä»£ç†ä¸ä¼šæœ‰åŒé‡åŠ è½½é—®é¢˜ï¼Œæ‰€ä»¥è¿™äº›æµé‡ä¸å¤ªå¯èƒ½æ¥è‡ªäºä½é€Ÿæˆ–è€…é«˜æ˜‚æµé‡è´¹çš„æ‰‹æœºã€‚</p><p>å¦‚æœä½ çš„ç½‘ç«™ç”¨æˆ·ä¸»è¦ä½¿ç”¨ç§»åŠ¨è®¾å¤‡æˆ–è¾ƒæ–°ç‰ˆæœ¬çš„æµè§ˆå™¨ï¼Œé‚£ä¹ˆæœ€ç®€å•çš„<code>module/nomodule</code>æ¨¡å¼å°†é€‚ç”¨äºä½ çš„ç»å¤§å¤šæ•°ç”¨æˆ·, å…¶ä»–ç”¨æˆ·å°±ä¸è€ƒè™‘äº†ï¼Œåæ­£ä¹Ÿæ˜¯å¯ä»¥è·‘èµ·æ¥çš„, ä¼˜å…ˆè€ƒè™‘å¤§å¤šæ•°ç”¨æˆ·çš„ä½“éªŒã€‚</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ä¿®å¤Safari 10.1 ä¸æ”¯æŒ `nomodule` é—®é¢˜: --&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">module</span>&gt;</span><span class="undefined">  </span></span><br><span class="line"><span class="javascript">!<span class="function"><span class="keyword">function</span>(<span class="params">e,t,n</span>)</span>&#123;!(<span class="string">"noModule"</span><span class="keyword">in</span>(t=e.createElement(<span class="string">"script"</span>)))&amp;&amp;<span class="string">"onbeforeload"</span><span class="keyword">in</span> t&amp;&amp;(n=!<span class="number">1</span>,e.addEventListener(<span class="string">"beforeload"</span>,<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;<span class="keyword">if</span>(e.target===t)n=!<span class="number">0</span>;<span class="keyword">else</span> <span class="keyword">if</span>(!e.target.hasAttribute(<span class="string">"nomodule"</span>)||!n)<span class="keyword">return</span>;e.preventDefault()&#125;,!<span class="number">0</span>),t.type=<span class="string">"module"</span>,t.src=<span class="string">"."</span>,e.head.appendChild(t),t.remove())&#125;(<span class="built_in">document</span>)</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- é€‚ç”¨äº90+% çš„æµè§ˆå™¨: --&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">modern.js</span> <span class="attr">type</span>=<span class="string">module</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- éƒ¨åˆ†æ”¯æŒmoduleä½†æ˜¯ä¸æ”¯æŒnomoduleçš„æµè§ˆå™¨ï¼Œä¹Ÿä¼šåŠ è½½ä¸‹é¢è„šæœ¬ï¼ŒèŒƒå›´å¯èƒ½å¾ˆå°ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©å¿½ç•¥å®ƒä»¬: --&gt;</span>  </span><br><span class="line"><span class="comment">&lt;!-- IE, Edge &lt;16, Safari &lt;10.1, old desktop: --&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">legacy.js</span> <span class="attr">nomodule</span> <span class="attr">async</span> <span class="attr">defer</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p><br></p><h2 id="é€‰é¡¹-4-ä½¿ç”¨æ¡ä»¶åŒ…"><a href="#é€‰é¡¹-4-ä½¿ç”¨æ¡ä»¶åŒ…" class="headerlink" title="é€‰é¡¹ 4: ä½¿ç”¨æ¡ä»¶åŒ…"></a>é€‰é¡¹ 4: ä½¿ç”¨æ¡ä»¶åŒ…</h2><p><strong><code>nomodule</code>å¯ä»¥å·§å¦™åœ°ç”¨æ¥<em>æ¡ä»¶åŠ è½½</em>é‚£äº›ç°ä»£æµè§ˆå™¨ä¸éœ€è¦çš„ä»£ç </strong>ï¼Œ ä¾‹å¦‚polyfillsã€‚é€šè¿‡è¿™ç§æ–¹æ³•ï¼Œæœ€åçš„æƒ…å†µå°±æ˜¯polyfillå’Œbundleéƒ½ä¼šè¢«åŠ è½½(ä¾‹å¦‚Safari 10.1)ï¼Œä½†è¿™æ¯•ç«Ÿæ˜¯å°‘æ•°ã€‚é‰´äºç›®å‰é€šè¡Œçš„åšæ³•å°±æ˜¯åœ¨æ‰€æœ‰æµè§ˆå™¨ä¸­ä¸€è‡´åŒä»åœ°åŠ è½½polyfillsï¼Œç›¸æ¯”è€Œè¨€, <em>æ¡ä»¶polyfills</em>å¯ä»¥è®©å¤§éƒ¨åˆ†ç°ä»£æµè§ˆå™¨ç”¨æˆ·é¿å…åŠ è½½polyfillä»£ç ã€‚</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- newer browsers won't load this bundle: --&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">nomodule</span> <span class="attr">src</span>=<span class="string">"polyfills.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- all browsers load this one: --&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/bundle.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Angular CLIæ”¯æŒé…ç½®è¿™ç§æ–¹å¼æ¥åŠ è½½polyfill, æŸ¥çœ‹<a href="https://blog.mgechev.com/2019/02/06/5-angular-cli-features/#conditional-polyfill-serving" target="_blank" rel="noopener">Minko Gechevçš„ä»£ç ç¤ºä¾‹</a>.<br>äº†è§£äº†è¿™ç§æ–¹å¼ä¹‹åï¼Œæˆ‘å†³å®šåœ¨preact-cliä¸­æ”¯æŒè‡ªåŠ¨polyfillæ³¨å…¥ï¼Œä½ å¯ä»¥æŸ¥çœ‹è¿™ä¸ª<a href="https://github.com/preactjs/preact-cli/pull/833/files" target="_blank" rel="noopener">PR</a></p><p>å¦‚æœä½ ä½¿ç”¨Webpackï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªhtml-webpack-plugin<a href="https://github.com/swimmadude66/webpack-nomodule-plugin" target="_blank" rel="noopener">æ’ä»¶</a>å¯ä»¥æ–¹ä¾¿åœ°ä¸ºpolyfillåŒ…æ·»åŠ <code>nomodule</code>å±æ€§.</p><p><br></p><h2 id="ä½ åº”è¯¥æ€ä¹ˆåš"><a href="#ä½ åº”è¯¥æ€ä¹ˆåš" class="headerlink" title="ä½ åº”è¯¥æ€ä¹ˆåš?"></a>ä½ åº”è¯¥æ€ä¹ˆåš?</h2><p>ç­”æ¡ˆå–å†³äºä½ çš„ä½¿ç”¨åœºæ™¯, é€‰æ‹©å’Œä½ ä»¬çš„æ¶æ„åŒ¹é…çš„é€‰é¡¹:<br>å¦‚æœä½ çš„åº”ç”¨åªæ˜¯å®¢æˆ·ç«¯æ¸²æŸ“, è€Œä¸”ä½ çš„HTMLä¸è¶…è¿‡ä¸€ä¸ª<code>&lt;script&gt;</code>ï¼Œé€‰é¡¹1æ¯”è¾ƒåˆé€‚ï¼›<br>å¦‚æœä½ çš„åº”ç”¨ä½¿ç”¨æœåŠ¡ç«¯æ¸²æŸ“ï¼Œè€Œä¸”å¯ä»¥æ¥å—ç¼“å­˜é—®é¢˜ï¼Œé‚£ä¹ˆå¯ä»¥é€‰æ‹©é€‰é¡¹2ï¼›<br>å¦‚æœä½ å¼€å‘çš„æ˜¯<a href="https://developers.google.com/web/updates/2019/02/rendering-on-the-web#rehydration" target="_blank" rel="noopener">åŒæ„åº”ç”¨</a>ï¼Œé¢„åŠ è½½çš„åŠŸèƒ½å¯èƒ½å¯¹ä½ å¾ˆé‡è¦ï¼Œè¿™æ—¶ä½ å¯ä»¥è€ƒè™‘é€‰é¡¹3å’Œ4.</p><p>å°±æˆ‘ä¸ªäººè€Œè¨€ï¼Œç›¸æ¯”è€ƒè™‘æ¡Œé¢ç«¯æµè§ˆå™¨èµ„æºä¸‹è½½æˆæœ¬ï¼Œæˆ‘æ›´å€¾å‘äºä¼˜åŒ–ç§»åŠ¨è®¾å¤‡è§£ææ—¶é—´. ç§»åŠ¨ç”¨æˆ·ä½“éªŒä¼šå—åˆ°æ•°æ®è§£æã€æµé‡è´¹ç”¨ï¼Œç”µæ± æ¶ˆè€—ç­‰å› ç´ çš„å½±å“ï¼Œè€Œæ¡Œé¢ç”¨æˆ·å¾€å¾€ä¸éœ€è¦è€ƒè™‘è¿™äº›å› ç´ ã€‚<br>å¦å¤–è¿™äº›ä¼˜åŒ–é€‚ç”¨äº90%çš„ç”¨æˆ·ï¼Œæ¯”å¦‚æˆ‘å·¥ä½œé¢å¯¹çš„å¤§éƒ¨åˆ†ç”¨æˆ·éƒ½æ˜¯ä½¿ç”¨ç°ä»£æˆ–ç§»åŠ¨æµè§ˆå™¨çš„ã€‚</p><p><br></p><h2 id="æ‰©å±•é˜…è¯»"><a href="#æ‰©å±•é˜…è¯»" class="headerlink" title="æ‰©å±•é˜…è¯»"></a>æ‰©å±•é˜…è¯»</h2><p>æœ‰å…´è¶£ç»§ç»­æ·±å…¥ï¼Ÿå¯ä»¥ä»ä¸‹é¢çš„æ–‡ç« å¼€å§‹æŒ–æ˜ï¼š</p><ul><li>Philçš„<a href="https://github.com/philipwalton/webpack-esnext-boilerplate/issues/1" target="_blank" rel="noopener">webpack-esnext-boilerplate</a>çš„ä¸€äº›é™„åŠ çš„èƒŒæ™¯.</li><li>Ralph<a href="https://github.com/zeit/next.js/pull/7704" target="_blank" rel="noopener">åœ¨Next.jsä¸­å®ç°äº†module/nomodule</a>, å¹¶åŠªåŠ›è§£å†³äº†ä¸Šé¢çš„é—®é¢˜.</li></ul><p>æ„Ÿè°¢<a href="https://twitter.com/philwalton" target="_blank" rel="noopener">Phil</a>, <a href="https://twitter.com/shubhie" target="_blank" rel="noopener">Shubhie</a>, <a href="https://twitter.com/atcastle" target="_blank" rel="noopener">Alex</a>, <a href="https://twitter.com/hdjirdeh" target="_blank" rel="noopener">Houssein</a>, <a href="https://twitter.com/Janicklas" target="_blank" rel="noopener">Ralph</a> ä»¥åŠ <a href="https://twitter.com/addyosmani" target="_blank" rel="noopener">Addy</a> çš„åé¦ˆ.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åŸæ–‡åœ°å€: &lt;a href=&quot;https://jasonformat.com/modern-script-loading/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Modern Script Loading&lt;/a&gt;, æ–‡ç« ä½œè€…æ˜¯Preactä½œè€…&lt;a 
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://bobi.ink/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>Javascriptç«Ÿç„¶æ²¡æœ‰æ ‡å‡†åº“?</title>
    <link href="https://bobi.ink/2019/07/16/js-stdlib/"/>
    <id>https://bobi.ink/2019/07/16/js-stdlib/</id>
    <published>2019-07-15T16:00:00.000Z</published>
    <updated>2019-08-12T04:27:48.955Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘åœ¨SegmentFaultçƒ­å¿ƒè§£é¢˜ï¼Œä¸€ä¸ªé—®é¢˜æ¯”è¾ƒè®©æˆ‘æ¯”è¾ƒå°è±¡æ·±åˆ»ï¼š<em>ä¸€ä¸ªåˆå­¦è€…è¯•å›¾åœ¨æµè§ˆå™¨ä¸­å¯¼å…¥Node.jsçš„netæ¨¡å—ã€‚ç»“æœåœ¨æ§åˆ¶å°æ‰“å°åæ˜¯ä¸€ä¸ªç©ºå¯¹è±¡</em>ã€‚</p><p>å¯¹äºæœ‰ç‚¹Javascriptç»éªŒçš„äººæ¥è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªâ€˜å¼±æ™ºâ€™é—®é¢˜ï¼Œæ€ä¹ˆå¯ä»¥åœ¨æµè§ˆå™¨ç«¯è¿è¡ŒNodeç¨‹åºå‘¢ï¼Ÿå› ä¸ºè¿™äº›Nodeæ¨¡å—ç»è¿‡<a href="http://webpack.docschina.org/configuration/node/#å…¶ä»–-node-js-æ ¸å¿ƒåº“-node-js-core-libraries-" target="_blank" rel="noopener">Webpackå¤„ç†</a>, æ‰€ä»¥å˜æˆäº†ä¸€ä¸ªç©ºå¯¹è±¡ï¼Œæ›´å¥½çš„å¤„ç†æ–¹å¼åº”è¯¥æ˜¯æŠ›å‡ºå¼‚å¸¸.</p><p><strong>ä»”ç»†åæ€ä¸€ä¸‹ï¼Œå¯¹äºè¿™äº›åˆšå…¥é—¨Javascriptçš„æˆ–è€…ä»å…¶ä»–è¯­è¨€åˆ‡æ¢è¿‡æ¥çš„å¼€å‘è€…ï¼Œä»–ä»¬å‹æ ¹å°±æ²¡æœ‰æ¦‚å¿µï¼Œæ¯”å¦‚Pythonã€Rubyã€Javaè¿™äº›è¯­è¨€éƒ½æœ‰å¼ºå¤§çš„æ ‡å‡†åº“ï¼Œå¯ä»¥æ»¡è¶³80%çš„å¼€å‘éœ€æ±‚ï¼Œä¸ç®¡å®ƒåœ¨ä»€ä¹ˆç¯å¢ƒã€ä»€ä¹ˆå¹³å°è¿è¡Œï¼ŒåŸºæœ¬ä¸Šéƒ½å¯ä»¥ç»Ÿä¸€ä½¿ç”¨è¿™å¥—æ ‡å‡†åº“ã€‚è€ŒJavascriptç›®å‰çš„ç°çŠ¶æ˜¯ï¼šä¸åŒçš„è¿è¡Œç¯å¢ƒï¼ŒAPIç»“æ„æ˜¯å‰²è£‚çš„</strong>ã€‚</p><p>Javascriptè¿™é—¨åå‡ å¤©å¼€å‘å‡ºæ¥çš„ã€ä¸“ä¾›æµè§ˆå™¨çš„è¯­è¨€ï¼Œå¯èƒ½å½“åˆè®¾è®¡æ˜¯æ ¹æœ¬å°±æ²¡æœ‰è€ƒè™‘æ ‡å‡†åº“è¿™äº›ç©æ„ï¼Œæ¯”å¦‚æ–‡ä»¶ç³»ç»Ÿï¼Œç½‘ç»œç­‰ç­‰ã€‚<strong>å› ä¸ºè¿™ä¸ªèƒŒæ™¯, Javascripté•¿æœŸä¸å…·å¤‡ç‹¬ç«‹æ€§ï¼Œå®ƒæ·±åº¦ä¾èµ–äºæµè§ˆå™¨è¿™ä¸ªè¿è¡Œç¯å¢ƒ, å¤„äºä¸€ç§ç»™æµè§ˆå™¨æ‰“è¾…åŠ©çš„è§’è‰²</strong>, æ‰€ä»¥Javascriptå¾ˆå¤šå¹´æ²¡æœ‰èµ°å‡ºæµè§ˆå™¨ç©å…·è¯­è¨€è¿™ä¸ªèŒƒå›´.</p><p>å½“ç„¶è¿™æ—¢æ˜¯åŠ£åŠ¿ï¼Œä¹Ÿæ˜¯ä¼˜åŠ¿, ç°åœ¨æ²¡ä»»ä½•è¯­è¨€èƒ½æ’¼åŠ¨Javascriptåœ¨æµè§ˆå™¨ä¸­çš„åœ°ä½ã€‚</p><p>æˆ‘æƒ³å¾ˆå¤šäººè·Ÿæˆ‘å½“åˆä¸€æ ·è®¤ä¸º<strong>æµè§ˆå™¨æä¾›çš„Web API === Javascriptçš„æ ‡å‡†åº“</strong>, æ¯”å¦‚<code>console.log</code>ã€<code>setTimeout</code>(ä¸‹æ–‡ä¼šä»‹ç»è¿™äº›åŠŸèƒ½éƒ½ä¸åœ¨Javascriptè§„èŒƒé‡Œé¢). æ­£å¦‚å½“å¹´é‚£äº›æŠŠJQueryå½“æˆâ€˜Javascriptâ€™çš„äºº.</p><p>ç›´åˆ°NodeJSçš„å‡ºç°ï¼ŒJavascriptæ‰æŒ£è„±æµè§ˆå™¨çº¦æŸï¼Œå»¶ä¼¸åˆ°æœåŠ¡å™¨é¢†åŸŸ, ä¸å†æ˜¯ä¸€ä¸ªâ€™æ²™ç›’è¯­è¨€â€™ã€‚NodeJSå®šä¹‰äº†å¾ˆå¤šæ¨¡å—æ¥æ”¯æ’‘æœåŠ¡ç«¯çš„å¼€å‘, å¦‚fsã€osã€Bufferã€netã€‚ä½†æ˜¯è¿™äº›APIä¸€æ ·ä¸æ˜¯Javascriptçš„æ ‡å‡†ã€ä¹Ÿå°±æ˜¯è¯´<strong>NodeJS !== Javascript</strong>.</p><p>å†åˆ°åæ¥ï¼Œå­¦ä¸åŠ¨äº†ï¼ŒNodeJSåŸä½œè€…åæ§½äº†ä¸€é€šNodeJSï¼Œåˆæå‡ºäº†ä¸€ä¸ª<a href="https://deno.land" target="_blank" rel="noopener">Deno</a>, å®ƒä¹Ÿä¼šæœ‰è‡ªå·±æ ‡å‡†åº“ï¼Œä¼šå®šä¹‰è‡ªå·±çš„æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œAPIã€‚ä»åå­—ä¸Šå°±æš—ç¤ºç€è¿™äº›APIä¸å¯èƒ½å’ŒNodeJSå…¼å®¹ã€‚Okï¼Œç°åœ¨å›åˆ°æ–‡ç« å¼€å§‹é‚£ä¸ªé—®é¢˜ï¼Œ<strong>å¦‚æœdenoå‘å±•èµ·æ¥ï¼Œè¯´ä¸å®šå“ªå¤©åˆæœ‰äººå°è¯•åœ¨æµè§ˆå™¨å¼•ç”¨Denoçš„æ¨¡å—</strong>ï¼Ÿ</p><p><br><br><br></p><h2 id="ç°æœ‰çš„javascript-apiç»“æ„"><a href="#ç°æœ‰çš„javascript-apiç»“æ„" class="headerlink" title="ç°æœ‰çš„Javascript APIç»“æ„"></a>ç°æœ‰çš„Javascript APIç»“æ„</h2><p><img src="/images/js-stdlib/outline.png" alt></p><p>å¦‚ä¸Šå›¾, Javascriptå…¶å®æ˜¯æœ‰ä¸€å±‚æ¯”è¾ƒè–„å…¨å±€çš„ã€é€šç”¨çš„ã€<strong>æ ‡å‡†çš„</strong>ã€æ ¸å¿ƒçš„APIå±‚ï¼Œå³<code>æ ‡å‡†å†…ç½®å¯¹è±¡</code>ï¼Œè¿™æ˜¯ä¸€äº›è¯­è¨€æ ¸å¿ƒçš„å†…ç½®å¯¹è±¡ï¼Œå¯ä»¥å…¨å±€è®¿é—®ã€‚å…³é”®çš„æ˜¯è¿™äº›æ˜¯æ ‡å‡†çš„ï¼Œå®ƒä»¬åœ¨<a href="https://tc39.es/ecma262/#sec-global-object" target="_blank" rel="noopener">ECMAScriptè§„èŒƒ</a>ä¸­è¢«å®šä¹‰. åœ¨è¿™ä¸ªåŸºç¡€ä¹‹ä¸Šï¼Œä¸åŒçš„è¿è¡Œç¯å¢ƒæ‹“å±•äº†è‡ªå·±çš„APIã€‚</p><p>ä»¥æµè§ˆå™¨ä¸ºä¾‹:</p><p><img src="/images/js-stdlib/brw.png" alt></p><p>æµè§ˆå™¨ç«¯çš„Web APIæ˜¯ä¸€ä¸ªéå¸¸å¤æ‚APIé›†åˆï¼Œä¸Šå›¾æ€»ç»“äº†ä¸€ä¸‹ï¼ŒåŸºæœ¬å°±åŒ…å«ä¸¤å—ä¸œè¥¿:</p><ul><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Document_Object_Model" target="_blank" rel="noopener">Core DOM</a>. DOMæ˜¯ä¸€ä¸ªé€šç”¨çš„æŠ€æœ¯ï¼Œä¸ä»…ä»…å±€é™äºæµè§ˆå™¨ï¼Œè¿™ä¸ªè§„èŒƒå®šä¹‰äº†ç»“æ„åŒ–(structured document)æ–‡æ¡£çš„è§£æå’Œæ“ä½œè§„èŒƒã€‚å®šä¹‰äº†åŸºæœ¬çš„èŠ‚ç‚¹ç±»å‹å’Œæ“ä½œæ–¹æ³•ã€‚ä¸å±€é™äºHTMLçš„æ“ä½œ</li><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/HTML_DOM" target="_blank" rel="noopener">HTML DOM</a>. å¯ä»¥è®¤ä¸ºæ˜¯Core DOMçš„æ‰©å±•ï¼Œè¿™é‡Œé¢å®šä¹‰äº†å„ç§HTMLå…ƒç´ å¯¹è±¡ç±»å‹ã€æ‰©å±•äº†å…ƒç´ çš„æ“ä½œæ–¹æ³•ï¼Œå¦å¤–è¿˜åŒ…å«äº†æµè§ˆå™¨ç›¸å…³çš„æ¥å£ï¼Œå¦‚XMLHttpRequestã€‚è¿™ä¸€å—é€šå¸¸ä¹Ÿè¢«ç»Ÿç§°ä¸ºBOM</li></ul><p>WebAPIåŸºæœ¬æ¦‚è§ˆ:</p><p><img src="/images/js-stdlib/webAPI.png" alt></p><p>å¦‚æœä½ æœ‰ç•™å¿ƒæŸ¥çœ‹MDNæ–‡æ¡£ä¸‹é¢çš„è§„èŒƒå¼•ç”¨ï¼Œä½ ä¼šå‘ç°æœ‰äº›è§„èŒƒå¼•ç”¨äº†<a href="https://www.w3.org/TR/" target="_blank" rel="noopener">W3C</a>, æœ‰äº›åˆ™å¼•ç”¨äº†<a href="https://html.spec.whatwg.org/multipage/" target="_blank" rel="noopener">WHATWG</a>. åˆ°åº•è°è¯´äº†ç®—?</p><p>å¦‚æœä½ æ€å¼€é”…ç›–ï¼Œå°±ä¼šå‘ç°è¿™æ˜¯ä¸€åœºé—¹å‰§. å¦‚æœå‰é˜µå­æœ‰å…³æ³¨æ–°é—»ï¼Œä¼šçœ‹åˆ°è¿™äº›æ ‡é¢˜â€˜<em>WHATWG å‡»è´¥ W3Cï¼Œèµ¢å¾— HTML å’Œ DOM çš„æ§åˆ¶æƒ</em>â€™ã€â€™<em>W3Cå°†ä¸WHATWGåˆä½œåˆ¶å®šæœ€æ–°HTMLå’ŒDOMè§„èŒƒæ ‡å‡†</em>â€˜. å¤§æ¦‚å¯ä»¥çŒœå‡ºè¿™ä¸¤ä¸ªç»„ç»‡ä¹‹é—´çš„å…³ç³». æœ¬æ–‡å°±ä¸æ‰¯è¿™äº›â€˜å…«å¦â€™äº†ï¼Œç›¸å…³èƒŒæ™¯å¯ä»¥çœ‹è¿™ç¯‡æ–‡ç« <a href="https://www.infoq.cn/article/bsvFxt96DOh-SBZphBwJ" target="_blank" rel="noopener">WHATWG å‡»è´¥ W3Cï¼Œèµ¢å¾— HTML å’Œ DOM çš„æ§åˆ¶æƒ</a></p><p>ç›¸å¯¹è€Œè¨€, è¯­è¨€å±‚åˆ™ç”±ECMAScriptè§„èŒƒå®šä¹‰çš„ï¼Œæ¯”è¾ƒç‹¬ç«‹, è¿‘äº›å¹´æˆæœä¹Ÿæ¯”è¾ƒæ˜¾è‘—.</p><p><br></p><h3 id="æ ‡å‡†å†…ç½®å¯¹è±¡å±‚ä¸»è¦åŒ…å«è¿™äº›ä¸œè¥¿"><a href="#æ ‡å‡†å†…ç½®å¯¹è±¡å±‚ä¸»è¦åŒ…å«è¿™äº›ä¸œè¥¿" class="headerlink" title="æ ‡å‡†å†…ç½®å¯¹è±¡å±‚ä¸»è¦åŒ…å«è¿™äº›ä¸œè¥¿"></a>æ ‡å‡†å†…ç½®å¯¹è±¡å±‚ä¸»è¦åŒ…å«è¿™äº›ä¸œè¥¿</h3><ul><li>ç‰¹æ®Šå€¼<ul><li>Infinity</li><li>NaN</li><li>undefined</li><li>null</li><li>globalThis</li></ul></li><li>å‡½æ•°<ul><li>eval()</li><li>uneval() </li><li>isFinite()</li><li>isNaN()</li><li>parseFloat()</li><li>parseInt()</li><li>decodeURI()</li><li>decodeURIComponent()</li><li>encodeURI()</li><li>encodeURIComponent()</li></ul></li><li>åŸºç¡€å¯¹è±¡<ul><li>Object</li><li>Function</li><li>Boolean</li><li>Symbol</li><li>Error</li><li>EvalError</li><li>InternalError </li><li>RangeError</li><li>ReferenceError</li><li>SyntaxError</li><li>TypeError</li><li>URIError</li></ul></li><li>æ•°å€¼å’Œæ—¶é—´<ul><li>Number</li><li>BigInt</li><li>Math</li><li>Date</li></ul></li><li>æ–‡æœ¬å¤„ç†<ul><li>String</li><li>RegExp</li></ul></li><li>ç´¢å¼•å®¹å™¨<ul><li>Array</li><li>â€˜TypedArrayâ€™</li></ul></li><li>é”®å€¼å®¹å™¨<ul><li>Map</li><li>Set</li><li>WeakMap</li><li>WeakSet</li></ul></li><li>ç»“æ„åŒ–æ•°æ®<ul><li>ArrayBuffer</li><li>SharedArrayBuffer </li><li>Atomics </li><li>DataView</li><li>JSON</li></ul></li><li>æ§åˆ¶æŠ½è±¡åŒ–å¯¹è±¡<ul><li>Promise</li><li>Generator</li><li>GeneratorFunction</li><li>AsyncFunction </li></ul></li><li>åå°„<ul><li>Reflect</li><li>Proxy</li></ul></li><li>å›½é™…åŒ–<ul><li>Intl</li></ul></li><li>WebAssembly</li><li>å…¶ä»–<ul><li>arguments</li></ul></li></ul><p><br></p><p>è¿™äº›å…¨å±€åŸºæœ¬å¯¹è±¡æ•°é‡å¾ˆå°‘, è¿™äº›å¯¹è±¡æ˜¯æ¯ä¸ªJavaScriptå¼€å‘è€…å¿…é¡»æŒæ¡çš„. </p><p>å¹³æ—¶æˆ‘ä»¬ä½¿ç”¨çš„éå¸¸é¢‘ç¹çš„Timerå’ŒConsoleéƒ½ä¸å†æ­¤åˆ—.</p><p>è¿™äº›å¯¹è±¡åªèƒ½æ»¡è¶³å¾ˆåŸºæœ¬å¼€å‘éœ€æ±‚, æ ¹æœ¬ä¸èƒ½å’Œå…¶ä»–è¯­è¨€çš„æ ‡å‡†åº“ç›¸æ¯”. <strong>å½“ç„¶è¿™å’Œè¯­è¨€çš„å®šä½ä¹Ÿæœ‰ä¸€å®šå…³ç³»</strong></p><p><br><br><br></p><h2 id="ä»€ä¹ˆæ˜¯æ ‡å‡†åº“"><a href="#ä»€ä¹ˆæ˜¯æ ‡å‡†åº“" class="headerlink" title="ä»€ä¹ˆæ˜¯æ ‡å‡†åº“?"></a>ä»€ä¹ˆæ˜¯æ ‡å‡†åº“?</h2><p>æ ‡å‡†åº“æ²¡æœ‰ä¸€ä¸ªä¸¥æ ¼çš„å®šä¹‰ï¼ŒæŒ‰ç…§Wikiçš„è¯´æ³•æ ‡å‡†åº“å°±æ˜¯<strong>è¯¥è¯­è¨€åœ¨ä¸åŒå®ç°ä¸­éƒ½æŒ‰ä¾‹æä¾›çš„åº“</strong>, æ¯”å¦‚Rubyå®˜æ–¹å®ç°cRubyå’ŒåŸºäºJVMçš„JRubyéƒ½æŒ‰ç…§å®˜æ–¹æ ‡å‡†åº“è§„èŒƒå®ç°äº†æ ‡å‡†åº“ã€‚ <strong>æ ‡å‡†åº“æ€ä¹ˆè®¾è®¡ï¼Œéœ€è¦åŒ…å«ä»€ä¹ˆå†…å®¹å–å†³äºè¯­è¨€å„è‡ªç§‰æŒçš„å“²å­¦å’Œå®šä½</strong>ã€‚ æˆ‘è®¤ä¸ºæ ‡å‡†åº“åº”è¯¥æœ‰ä»¥ä¸‹ç‰¹å¾:</p><ul><li>æ ‡å‡†åŒ–çš„. æœ‰è§„èŒƒæ˜ç¡®å®šä¹‰å®ƒçš„å†…å®¹å’Œè¡Œä¸º</li><li>å†…å®¹ç»è¿‡ä»”ç»†é›•ç¢å’ŒæŒ‘é€‰ï¼Œå¯ä»¥è¦†ç›–å¤§éƒ¨åˆ†ä½¿ç”¨åœºæ™¯æˆ–è€…ç¬¦åˆçš„è¯­è¨€å®šä½</li><li>å¯é€‰çš„ã€æŒ‰éœ€å¯¼å…¥. æ ‡å‡†åº“ä¸æ˜¯å…¨å±€çš„ï¼Œéœ€è¦é€šè¿‡æ¨¡å—å¯¼å…¥, éå¼ºåˆ¶æ€§ä½¿ç”¨</li></ul><p><br></p><p>è‡³äºæ ‡å‡†åº“éœ€è¦åŒ…å«ä»€ä¹ˆå†…å®¹ï¼Œå¯ä»¥å‚è€ƒå…¶ä»–è¯­è¨€çš„å®ç°ã€‚æ¯”å¦‚ï¼š</p><ul><li><a href="https://golang.org/pkg/" target="_blank" rel="noopener">go</a></li><li><a href="http://ruby-doc.org/stdlib-2.6.3/" target="_blank" rel="noopener">ruby</a></li><li><a href="https://docs.python.org/3/library/index.html" target="_blank" rel="noopener">python</a></li></ul><p><br></p><p>å¤§æ¦‚åˆ†æä¸€ä¸‹ï¼Œå®ƒä»¬æ ‡å‡†åº“å¤§è‡´éƒ½æœ‰è¿™äº›å†…å®¹ï¼š</p><ul><li>ç½‘ç»œåè®®</li><li>æ–‡ä»¶ç³»ç»Ÿ<ul><li>æ–‡ä»¶ç³»ç»Ÿ</li><li>æµ</li><li>æ ‡å‡†è¾“å…¥è¾“å‡º</li><li>äºŒè¿›åˆ¶å¤„ç†</li></ul></li><li>ç®—æ³•<ul><li>å¯†ç ç®—æ³•</li><li>ç¼–ç </li><li>å‹ç¼©ã€å½’æ¡£</li><li>æ’åº</li><li>æ•°å­¦</li><li>å­—ç¬¦ä¸²ã€æ–‡æœ¬</li></ul></li><li>æ•°æ®ç»“æ„, ä¾‹å¦‚æ ‘ã€å †ã€é˜Ÿåˆ—ç­‰ç­‰</li><li>æ•°æ®æŒä¹…åŒ–å’Œåºåˆ—åŒ–. æ¯”å¦‚JSONåºåˆ—åŒ–ï¼ŒäºŒè¿›åˆ¶åºåˆ—åŒ–ï¼Œæ•°æ®åº“æ“ä½œç­‰ç­‰</li><li>è°ƒè¯•/è¾…åŠ©</li><li>å•å…ƒæµ‹è¯•</li><li>æ–‡æ¡£å¤„ç†</li><li>è®¾è®¡æ¨¡å¼. æ ‡å‡†åº“ä¸­ç»å¸¸ä¼šæºå¸¦(æˆ–è¾…åŠ©è®¾è®¡)è¯¥è¯­è¨€çš„æœ€ä½³å®è·µå’Œè®¾è®¡æ¨¡å¼, ä¾‹å¦‚goä¸­çš„context, Rubyä¸­çš„singleton</li><li>å›½é™…åŒ–</li><li>æ—¶é—´ã€æ—¥æœŸ</li><li>æ“ä½œç³»ç»Ÿ<ul><li>å‘½ä»¤è¡Œ</li><li>ç¯å¢ƒå˜é‡</li><li>ç³»ç»Ÿèµ„æº</li></ul></li><li>å¹¶å‘<ul><li>è¿›ç¨‹</li><li>çº¿ç¨‹</li><li>åç¨‹</li></ul></li><li>è¯­è¨€æˆ–è¿è¡Œæ—¶çš„åº•å±‚æ¥å£</li></ul><p>å¤§éƒ¨åˆ†è¯­è¨€çš„æ ¸å¿ƒéƒ½å¾ˆå°(C++é™¤å¤–)ï¼Œæˆ‘ä»¬å­¦ä¸€é—¨è¯­è¨€ï¼Œå¤§éƒ¨åˆ†æ—¶é—´æ˜¯èŠ±åœ¨æ ‡å‡†åº“ä¸Šå’Œè¯­è¨€çš„ç”Ÿæ€ä¸Šé¢ï¼Œä½†æ˜¯ä½ ä¼šå‘ç°è¿™äº›æ ‡å‡†åº“ä¸€èˆ¬éƒ½æ˜¯å¤§åŒå°å¼‚ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæœ‰ç»éªŒçš„å¼€å‘è€…å¯ä»¥å¾ˆå¿«åœ°å…¥æ‰‹ä¸€é—¨è¯­è¨€.</p><p>æ˜¾ç„¶ä¸Šé¢è¿™äº›åŠŸèƒ½å¤§éƒ¨åˆ†åœ¨NodeJSä¸­å·²ç»å®ç°äº†ï¼Œ<strong>é‰´äºNodeJSè¿™ä¹ˆå¹¿æ³›çš„ä½¿ç”¨ç‡ï¼ŒNodeJSå¯ä»¥ç®—æ˜¯äº‹å®ä¸Šçš„æ ‡å‡†äº†</strong></p><p><br></p><h2 id="æˆ‘ä»¬éœ€è¦æ ‡å‡†åº“"><a href="#æˆ‘ä»¬éœ€è¦æ ‡å‡†åº“" class="headerlink" title="æˆ‘ä»¬éœ€è¦æ ‡å‡†åº“?"></a>æˆ‘ä»¬éœ€è¦æ ‡å‡†åº“?</h2><p><img src="/images/js-stdlib/dep.png" alt></p><p>æ˜¾ç„¶è¦ç»“åˆå½“å‰çš„èƒŒæ™¯æ¥è¾©è¯åœ°è€ƒè™‘ã€‚</p><p><strong>æœ‰æ ‡å‡†åº“æœ‰ä»€ä¹ˆå¥½å¤„?</strong></p><ul><li>æ ‡å‡†åº“æä¾›é€šç”¨ã€å®šä¹‰è‰¯å¥½ã€ä¼˜åŒ–çš„åŠŸèƒ½å’Œè¡Œä¸ºï¼Œå‡å°‘ç¬¬ä¸‰æ–¹æ¨¡å—ä¾èµ–, è€Œä¸”ç¬¬ä¸‰æ–¹åº“å¾ˆéš¾ä¿è¯è´¨é‡</li><li>é¿å…ç¤¾åŒºå‰²è£‚, æŠšå¹³ä¸åŒè¿è¡Œç¯å¢ƒçš„å·®å¼‚. ç°åœ¨æœ‰NodeJSã€åé¢æœ‰Denoï¼Œå¯èƒ½è¿˜ä¼šæœ‰Aenoã€Beno, å°½ç®¡å–ä»£NodeJSçš„å¯èƒ½æ€§å¾ˆä½ï¼Œæœ‰è§„èŒƒåŒ–çš„æ ‡å‡†åº“å¯ä»¥é¿å…é‡å¤é€ è½®å­ï¼Œä¸ç„¶çœŸä¼šå­¦ä¸åŠ¨</li><li>å®‰å…¨æ€§. <a href="https://mp.weixin.qq.com/s/UEPZwFuousrRVj17zZU80w" target="_blank" rel="noopener">è¿‘æœŸnpmå®‰å…¨äº‹ä»¶é¢‘å‘</a>ï¼ŒæŠ•æ¯’ã€åˆ åº“(left-padäº‹ä»¶)ã€npmå•†ä¸šè¿ä½œ, ç»™ç¤¾åŒºå¸¦äº†ä¸å°‘éº»çƒ¦ã€‚è€Œæ ‡å‡†åº“ç”±è¿è¡Œç¯å¢ƒå†…ç½®ï¼Œå¯ä»¥é¿å…å¼•ç”¨ç¬¬ä¸‰æ–¹åº“å¯¼è‡´çš„å®‰å…¨é—®é¢˜</li><li>ä»Šå¤©çš„Javascriptåº”ç”¨ä¼šæœ‰å¾ˆå¤šä¾èµ–(node_modules hell)ï¼Œæ‰“åŒ…å‡ºæ¥çš„ä½“ç§¯å¾ˆå¤§ï¼Œç½‘ç»œåŠ è½½å’Œè„šæœ¬è§£æéœ€è¦è€—è´¹ä¸€å®šçš„èµ„æºï¼Œè€Œä¸”è¿™äº›èµ„æºä¸èƒ½åœ¨å¤šä¸ªåº”ç”¨ä¹‹é—´è¢«ç¼“å­˜. ä¸€ä¸ªå¾ˆå¤§çš„åŸå› æ˜¯npmçš„ä¾èµ–è¿‡äºé›¶ç¢(æ¯”å¦‚å‡ è¡Œä»£ç çš„åŒ…)å’Œé‡å¤(ä¾èµ–ä¸åŒçš„ç‰ˆæœ¬ã€Dead Code)ï¼Œä½¿ç”¨æ ‡å‡†åº“å¯ä»¥å‡å°‘è¿™éƒ¨åˆ†ä¾èµ–</li><li>é€‰æ‹©å›°éš¾ç—‡. æ²¡æœ‰æ ‡å‡†åº“ï¼Œå¯ä»¥é€‰æ‹©npmä¸Šçš„ç¬¬ä¸‰æ–¹åº“ï¼Œåœ¨npmä¸ŠæŒ‘é€‰é è°±ã€é«˜è´¨é‡çš„åº“æ˜¯éœ€è¦ä¸€å®šçš„æ—¶é—´æˆæœ¬çš„. æœ‰æ—¶å€™æˆ‘ä»¬å°±æ˜¯æ‡’å¾—å»æ¯”è¾ƒå’Œé€‰æ‹©</li><li>ä¼˜é›…çš„æ ‡å‡†åº“ï¼Œæ˜¯å­¦ä¹ çš„æ¦œæ ·. ç½‘ä¸Šå¾ˆå¤šæ•™ç¨‹éƒ½æ˜¯é’»ç ”æ ‡å‡†åº“ç®—æ³•å’Œå®ç°çš„ï¼Œå¯¹è¯­è¨€çš„å¼€å‘è€…æ¥è¯´æ ‡å‡†åº“æ˜¯ä¸€å—å®è—</li><li>å­¦ä¹ æˆæœ¬ã€‚å…¶ä»–è¯­è¨€çš„å¼€å‘è€…ï¼Œå¯ä»¥è¾ƒå¿«å…¥æ‰‹</li></ul><p><br></p><p><strong>æ ‡å‡†åº“å¯èƒ½ä¼šæœ‰ä»€ä¹ˆé—®é¢˜?</strong></p><ul><li>æ ‡å‡†å¯èƒ½æ»åè·Ÿä¸ä¸Šç¤¾åŒºå‘å±•. Javascriptæ­£å¤„äºå¿«é€Ÿå‘å±•é˜¶æ®µï¼Œå¾ˆå¤šè§„èŒƒçš„å®šä¹‰æ˜¯ç”±ç¤¾åŒºé©±åŠ¨çš„ï¼Œæ¯”å¦‚Promiseã€async/await. è·Ÿä¸ä¸Šç¤¾åŒºçš„å‘å±•ç»“æœå¯èƒ½å°±æ˜¯æ²¡äººç”¨</li><li>æƒ³ä¸‹WebComponentç›®å‰çš„å¢ƒé‡</li><li>æ ‡å‡†åº“ä¸å¯èƒ½æ»¡è¶³æ‰€æœ‰äººçš„å£å‘³</li></ul><p><br></p><p><strong>å¦‚ä½•è®¾è®¡æ ‡å‡†åº“? æ ‡å‡†åº“æ¨è¿›è¿›ç¨‹å¯èƒ½ä¼šæœ‰ä»€ä¹ˆéšœç¢?</strong></p><ul><li>NodeJSå·²ç»æ˜¯äº‹å®ä¸Šçš„æ ‡å‡†, æ€ä¹ˆå…¼å®¹ç°æœ‰çš„ç”Ÿæ€?</li><li>æ ‡å‡†åº“åº”è¯¥åŒ…å«ä»€ä¹ˆå†…å®¹ï¼Œå¦‚ä½•ä¿æŒå’Œç¤¾åŒºåŒæ­¥?</li><li><p>å¦‚ä½•æŠŠæ§æ ‡å‡†åº“å†…å®¹çš„å°ºåº¦? </p><p>æœ€å°åŒ–çš„æ ‡å‡†åº“å®¹æ˜“è¢«ç»´æŠ¤å’Œå‡çº§ï¼Œä½†å¯èƒ½å‡ºç°â€™æ²¡ä»€ä¹ˆåµç”¨â€™çš„æƒ…å†µï¼›</p><p>æœ€å¤§åŒ–çš„æ ‡å‡†åº“ï¼Œä¾‹å¦‚Javaçš„æ ‡å‡†åº“ï¼Œå‡ ä¹åŒ…å«äº†æ‰€æœ‰çš„ä¸œè¥¿ï¼Œå¼€å‘è€…å¯ä»¥å¿«é€Ÿå¼€å‘ä¸€ä¸ªä¸œè¥¿, ä½†æ˜¯è¿‡äº†å‡ å¹´å¾ˆå¤šAPIå°±ä¼šå˜å¾—è¿‡æ—¶ï¼Œä¸€èˆ¬ä¸ºäº†ä¿æŒå‘ä¸‹å…¼å®¹ï¼Œè¿™äº›APIä¼šä¸€ç›´åƒä¸€æ ¹åˆºä¸€æ ·å¡åœ¨é‚£é‡Œ.<br>å¦ä¸€ä¸ªéå¸¸å…¸å‹çš„åä¾‹å°±æ˜¯PHPçš„æ ‡å‡†åº“ï¼Œè¿™é‡Œå¯ä»¥çœ‹åˆ°å„ç§é£æ ¼çš„API.</p><p>æ ‡å‡†åº“æ˜¯è·Ÿéšè¯­è¨€å‘å¸ƒçš„ï¼Œå¦‚æœä½ çš„é¡¹ç›®ä¸­ä½¿ç”¨äº†è¿‡æ—¶çš„APIï¼Œåˆæƒ³å‡çº§è¯­è¨€ç‰ˆæœ¬ï¼Œå°±éœ€è¦é‡æ„é¡¹ç›®ã€‚è€Œä½¿ç”¨ç¬¬ä¸‰æ–¹åº“åˆ™å¯èƒ½å¯ä»¥ä¿æŒä¸åŠ¨ã€‚</p></li><li><p>Javascriptçš„ä¸»è¦æˆ˜åœºè¿˜æ˜¯æµè§ˆå™¨, æ ‡å‡†åº“æ˜¯å¦åº”è¯¥æœ‰ä¸€ä¸ªâ€™åŸºæœ¬ç‰ˆâ€™(ç”¨äºæµè§ˆå™¨æˆ–è€…ä¸€äº›æŠ½è±¡æ“ä½œç³»ç»Ÿçš„è¿è¡Œç¯å¢ƒ), è¿˜æœ‰ä¸ªâ€™æ——èˆ°ç‰ˆâ€™(æœåŠ¡ç«¯), æˆ–è€…åªæä¾›ä¸€ä¸ªè·¨è¶Šæ‰€æœ‰å¹³å°çš„æ ‡å‡†åº“?</p></li><li>å¦‚ä½•å¤„ç†å…¼å®¹æ€§é—®é¢˜? è€æ—§æµè§ˆå™¨å¦‚ä½•Polyfill?</li><li>å¦‚ä½•ä¸ç°æœ‰çš„å…¨å±€å¯¹è±¡æˆ–ç”¨æˆ·æ¨¡å—åˆ†ç¦»ï¼Ÿ</li></ul><p><br></p><h2 id="è¿‘æœŸçš„ä¸€äº›å°è¯•"><a href="#è¿‘æœŸçš„ä¸€äº›å°è¯•" class="headerlink" title="è¿‘æœŸçš„ä¸€äº›å°è¯•"></a>è¿‘æœŸçš„ä¸€äº›å°è¯•</h2><ul><li><a href="https://github.com/tc39/proposal-javascript-standard-library" target="_blank" rel="noopener">proposal-javascript-standard-library</a> è¿™æ˜¯ä¸€ä¸ªéå¸¸æ—©æœŸçš„è¯­è¨€æè®®ï¼Œå®šä¹‰äº†å¦‚ä½•å¼•ç”¨æ ‡å‡†åº“(built-in modules)ï¼Œä½†æ˜¯æ²¡æœ‰å®šä¹‰æ ‡å‡†åº“çš„å†…å®¹</li><li><p><a href="https://developers.google.com/web/updates/2019/03/kv-storage" target="_blank" rel="noopener">KV Storage: the Webâ€™s First Built-in Module</a> Chromeåœ¨å¹´åˆæ¨å‡ºçš„å®éªŒæ€§åŠŸèƒ½ï¼Œå°è¯•å®ç°proposal-javascript-standard-libraryæè®®. å®ƒé€šè¿‡ä¸‹é¢æ–¹å¼æ¥å¼•ç”¨â€˜æ ‡å‡†åº“â€™æ¨¡å—:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;storage, StorageArea&#125; <span class="keyword">from</span> <span class="string">'std:kv-storage'</span>; <span class="comment">// std: å‰ç¼€ï¼Œå’Œæ™®é€šæ¨¡å—åŒºåˆ†å¼€æ¥</span></span><br></pre></td></tr></table></figure></li></ul><p><br></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ¬æ–‡ä»ä¸€ä¸ªSegmentFaultä¸Šçš„ä¸€ä¸ªé—®é¢˜å¼€å§‹ï¼Œå¯¹æ¯”å…¶ä»–è¯­è¨€ï¼Œæ­éœ²Javascriptæ²¡æœ‰æ ‡å‡†åº“çš„çª˜å¢ƒ. æ¥ç€ä»‹ç»ç°æœ‰Javascriptçš„APIç»“æ„ï¼Œä»‹ç»ä»€ä¹ˆæ˜¯æ ‡å‡†åº“ï¼Œè¾©è¯è€ƒè™‘æ ‡å‡†åº“çš„ä¼˜ç¼ºç‚¹ï¼Œä»¥åŠæ¨è¡Œä¸Šé¢å¯èƒ½ä¼šé‡åˆ°çš„é˜»ç¢.</p><p><br></p><h2 id="æ‰©å±•"><a href="#æ‰©å±•" class="headerlink" title="æ‰©å±•"></a>æ‰©å±•</h2><ul><li><a href="https://www.infoworld.com/article/3048833/brendan-eich-javascript-standard-library-will-stay-small.html" target="_blank" rel="noopener">Brendan Eich: JavaScript standard library will stay small</a></li><li><a href="https://medium.com/@thomasfuchs/what-if-we-had-a-great-standard-library-in-javascript-52692342ee3f" target="_blank" rel="noopener">What if we had a great standard library in JavaScript?</a></li><li><a href="https://www.i-programmer.info/news/167-javascript/12608-the-javascript-standard-library.html" target="_blank" rel="noopener">The JavaScript Standard Library</a></li><li><a href="https://www.w3.org/TR/" target="_blank" rel="noopener">W3C</a></li><li><a href="https://developer.mozilla.org/en-US/docs/Web/API" target="_blank" rel="noopener">Web API ç´¢å¼•</a></li><li><a href="https://dev.to/sloan/explain-like-im-five-whats-a-standard-library-4gi" target="_blank" rel="noopener">Explain Like Iâ€™m Five: Whatâ€™s a standard library?</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æœ€è¿‘åœ¨SegmentFaultçƒ­å¿ƒè§£é¢˜ï¼Œä¸€ä¸ªé—®é¢˜æ¯”è¾ƒè®©æˆ‘æ¯”è¾ƒå°è±¡æ·±åˆ»ï¼š&lt;em&gt;ä¸€ä¸ªåˆå­¦è€…è¯•å›¾åœ¨æµè§ˆå™¨ä¸­å¯¼å…¥Node.jsçš„netæ¨¡å—ã€‚ç»“æœåœ¨æ§åˆ¶å°æ‰“å°åæ˜¯ä¸€ä¸ªç©ºå¯¹è±¡&lt;/em&gt;ã€‚&lt;/p&gt;
&lt;p&gt;å¯¹äºæœ‰ç‚¹Javascriptç»éªŒçš„äººæ¥è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªâ€˜å¼±æ™ºâ€™é—®é¢˜ï¼Œæ€ä¹ˆå¯ä»¥åœ¨æµè§ˆå™¨ç«¯
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://bobi.ink/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
  </entry>
  
</feed>
